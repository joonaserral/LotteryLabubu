<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>å¥–æ± ç®¡ç† - Labubu å¹¸è¿æŠ½å¥– ğŸ§¸</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ§¸</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- VIPå®‰å…¨éªŒè¯ -->
    <script src="auth.js"></script>
    <script src="config.enc.js"></script>
    <!-- ç§»é™¤Google Fontsä»¥é¿å…å¾®ä¿¡ç¯å¢ƒä¸‹çš„åŠ è½½é—®é¢˜ -->
    <style>
        /* ä½¿ç”¨ç³»ç»Ÿå­—ä½“ä»£æ›¿Google Fontsï¼Œç¡®ä¿å¾®ä¿¡å…¼å®¹æ€§ */
        body,
        html,
        * {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji" !important;
        }
    </style>
    <style>
        :root {
            --labu: #6b5b95;
            --labu2: #ffcc00;
        }

        body {
            font-family: 'Zen Maru Gothic', system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans SC', 'PingFang SC', 'Microsoft Yahei', sans-serif;
        }

        .labu-gradient {
            background-image: linear-gradient(135deg, rgba(107, 91, 149, .12), rgba(255, 204, 0, .12));
        }

        /* è‡ªå®šä¹‰é¼ æ ‡æ ·å¼å’Œäº¤äº’æ•ˆæœ - å¢åŠ å¤‡ç”¨æ–¹æ¡ˆ */
        body.custom-cursor-enabled * {
            cursor: none !important;
        }

        body:not(.custom-cursor-enabled) * {
            cursor: auto;
        }

        /* æ¢å¤æ–‡æœ¬è¾“å…¥å…ƒç´ çš„å…‰æ ‡ */
        input,
        textarea,
        [contenteditable="true"],
        .text-input {
            cursor: text !important;
        }

        /* æ¢å¤å¯ç‚¹å‡»å…ƒç´ çš„å…‰æ ‡ */
        button,
        a,
        [role="button"],
        .cursor-pointer,
        select {
            cursor: pointer !important;
        }

        /* å…‰æ ‡å›é€€é€‰é¡¹ */
        body.cursor-fallback * {
            cursor: auto !important;
        }

        body.cursor-fallback input,
        body.cursor-fallback textarea,
        body.cursor-fallback [contenteditable="true"] {
            cursor: text !important;
        }

        body.cursor-fallback button,
        body.cursor-fallback a,
        body.cursor-fallback [role="button"],
        body.cursor-fallback select {
            cursor: pointer !important;
        }

        .custom-cursor {
            position: fixed;
            width: 20px;
            height: 20px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ff69b4"><path d="M8 2C8 2 8.5 3 10.5 3C12.5 3 13 2 13 2C14 2 15 3 15 4C15 5 14 6 13 6C12 6 11 7 11 8C11 9 12 10 13 10C14 10 15 9 15 8C15 7 16 6 17 6C18 6 19 7 19 8C19 9 18 10 17 10C16 10 15 11 15 12C15 13 16 14 17 14C18 14 19 13 19 12C19 11 20 10 21 10C22 10 23 11 23 12C23 13 22 14 21 14C20 14 19 15 19 16C19 17 18 18 17 18C16 18 15 17 15 16C15 15 14 14 13 14C12 14 11 15 11 16C11 17 10 18 9 18C8 18 7 17 7 16C7 15 8 14 9 14C10 14 11 13 11 12C11 11 10 10 9 10C8 10 7 11 7 12C7 13 6 14 5 14C4 14 3 13 3 12C3 11 4 10 5 10C6 10 7 9 7 8C7 7 6 6 5 6C4 6 3 7 3 8C3 9 2 10 1 10C0 10 -1 9 -1 8C-1 7 0 6 1 6C2 6 3 5 3 4C3 3 4 2 5 2C6 2 7 3 7 4C7 5 8 6 9 6C10 6 11 5 11 4C11 3 10 2 9 2C8.5 2 8 2 8 2Z"/></svg>') no-repeat center;
            background-size: contain;
            pointer-events: none;
            z-index: 9999;
            transition: transform 0.1s ease;
            transform: translate(-50%, -50%);
        }

        .custom-cursor.clicking {
            transform: translate(-50%, -50%) scale(1.2);
        }

        .cursor-trail {
            position: fixed;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, rgba(255, 105, 180, 0.8) 0%, rgba(255, 105, 180, 0) 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9998;
            animation: cursorTrailFade 0.5s ease-out forwards;
        }

        @keyframes cursorTrailFade {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            100% {
                opacity: 0;
                transform: scale(0.3);
            }
        }

        .enhanced-btn {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .enhanced-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .enhanced-btn:hover::before {
            left: 100%;
        }

        .enhanced-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(107, 91, 149, 0.3);
        }

        .enhanced-btn:active {
            transform: translateY(0);
        }

        .btn-ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            transform: scale(0);
            animation: rippleEffect 0.6s linear;
            pointer-events: none;
        }

        @keyframes rippleEffect {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900">
    <!-- è‡ªå®šä¹‰é¼ æ ‡å…‰æ ‡ -->
    <div class="custom-cursor"></div>

    <!-- å…‰æ ‡åˆ‡æ¢æŒ‰é’® -->
    <button id="cursorToggle"
        class="fixed bottom-4 left-4 z-50 w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full shadow-lg flex items-center justify-center text-white text-lg hover:scale-110 transition-transform duration-200"
        title="åˆ‡æ¢å…‰æ ‡æ¨¡å¼" onclick="if(window.toggleCursorMode) window.toggleCursorMode()">
        ğŸ–±ï¸
    </button>

    <!-- å…‰æ ‡ä¿®å¤è„šæœ¬ -->
    <script src="ä¿®å¤å…‰æ ‡è„šæœ¬.js"></script>

    <!-- ç™»å½•ç•Œé¢ -->
    <div id="loginOverlay" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="bg-white rounded-3xl shadow-2xl p-8 mx-4 w-full max-w-md">
            <div class="text-center mb-6">
                <div
                    class="w-16 h-16 rounded-2xl bg-[var(--labu)] grid place-content-center text-white text-2xl mx-auto mb-4">
                    ğŸ”’</div>
                <h2 class="text-2xl font-bold text-slate-900">ç®¡ç†å‘˜éªŒè¯</h2>
                <p class="text-slate-600 mt-2">è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ä»¥è®¿é—®ç³»ç»Ÿ</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="adminPassword" class="block text-sm font-medium text-slate-700 mb-2">ç®¡ç†å‘˜å¯†ç </label>
                    <input type="password" id="adminPassword"
                        class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:border-[var(--labu)] focus:ring-2 focus:ring-[var(--labu)]/20 focus:outline-none transition-colors"
                        placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                <button id="loginBtn"
                    class="enhanced-btn w-full px-4 py-3 rounded-xl bg-[var(--labu)] text-white font-medium transition-opacity">
                    è¿›å…¥ç®¡ç†ç³»ç»Ÿ
                </button>
                <div class="text-center">
                    <a href="index.html" class="text-sm text-slate-500 hover:text-slate-700">è¿”å›æŠ½å¥–é¡µé¢</a>
                </div>
            </div>
            <div id="loginError" class="mt-4 text-sm text-red-600 text-center hidden"></div>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢å†…å®¹ -->
    <div id="mainContent" class="hidden">
        <!-- é¡¶éƒ¨æ  -->
        <header class="sticky top-0 z-10 backdrop-blur bg-white/60 border-b border-slate-200">
            <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-xl bg-[var(--labu)] grid place-content-center text-white text-xl">ğŸ¦Š
                    </div>
                    <h1 class="font-bold text-lg">å¥–æ± ç®¡ç†ç³»ç»Ÿ</h1>
                </div>
                <nav class="text-sm flex items-center gap-3">
                    <a href="index.html" class="hover:underline">è¿”å›æŠ½å¥–</a>
                    <button id="logoutBtn" class="text-red-600 hover:underline">ç™»å‡º</button>
                </nav>
            </div>
        </header>

        <!-- Hero -->
        <section class="labu-gradient">
            <div class="max-w-5xl mx-auto px-4 py-10">
                <div class="text-center">
                    <h2 class="text-3xl md:text-4xl font-extrabold leading-tight">å¥–æ± é…ç½®ç®¡ç†</h2>
                    <p class="mt-3 text-slate-700">ç®¡ç†å‘˜ä¸“ç”¨ç•Œé¢ï¼Œç”¨äºé…ç½®å’Œç®¡ç†æŠ½å¥–å¥–æ± è®¾ç½®</p>
                </div>
            </div>
        </section>

        <!-- ä¸»è¦å†…å®¹ -->
        <main class="max-w-5xl mx-auto px-4 py-10">
            <div class="grid lg:grid-cols-2 gap-8">
                <!-- å¥–æ± è®¾ç½® -->
                <section>
                    <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
                        <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                            <h3 class="font-semibold">å¥–æ± é…ç½®ç¼–è¾‘</h3>
                            <div class="text-xs text-slate-500">é…ç½®å°†ä¿å­˜åˆ°æœ¬åœ°æµè§ˆå™¨</div>
                        </div>
                        <div class="p-5 grid gap-4">
                            <div class="text-sm text-slate-600">
                                <div class="mb-2">æ¯è¡Œä¸€ä¸ªå¥–å“ï¼Œå­—æ®µä½¿ç”¨é€—å·åˆ†éš”ï¼š<code>name,type,weight,quantity</code></div>
                                <ul class="text-xs space-y-1 text-slate-500">
                                    <li>â€¢ <b>name</b>: å¥–å“åç§°</li>
                                    <li>â€¢ <b>type</b>: å¥–å“ç±»å‹ï¼Œä»…æ”¯æŒï¼š<b>æŠµæ‰£åˆ¸</b>ï½œ<b>å®ä½“</b>ï½œ<b>æŠ˜æ‰£åˆ¸</b></li>
                                    <li>â€¢ <b>weight</b>: æƒé‡æ•°å€¼ï¼Œæ•°å€¼è¶Šå¤§è¶Šå®¹æ˜“æŠ½ä¸­</li>
                                    <li>â€¢ <b>quantity</b>: åº“å­˜æ•°é‡ï¼Œç•™ç©ºæˆ– -1 è¡¨ç¤ºä¸é™é‡</li>
                                </ul>
                            </div>
                            <textarea id="poolEditor" rows="12"
                                class="w-full rounded-xl border border-slate-300 p-3 font-mono text-xs"></textarea>
                            <div class="flex gap-3 flex-wrap">
                                <button id="savePoolBtn"
                                    class="px-4 py-2 rounded-xl bg-[var(--labu)] text-white font-medium hover:opacity-90">ä¿å­˜å¥–æ± </button>
                                <button id="reloadBtn"
                                    class="px-4 py-2 rounded-xl bg-slate-100 border border-slate-200 hover:bg-slate-200">é‡æ–°è½½å…¥</button>
                                <button id="restoreDefaultBtn"
                                    class="px-4 py-2 rounded-xl bg-orange-100 text-orange-700 border border-orange-200 hover:bg-orange-200">æ¢å¤é»˜è®¤</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- å½“å‰å¥–æ± é¢„è§ˆ -->
                <section>
                    <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
                        <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                            <h3 class="font-semibold">å½“å‰å¥–æ± é¢„è§ˆ</h3>
                            <button id="refreshPreviewBtn"
                                class="text-xs px-2 py-1 rounded-lg bg-slate-100 border border-slate-200">åˆ·æ–°é¢„è§ˆ</button>
                        </div>
                        <div class="p-5">
                            <ul id="poolList" class="text-sm grid gap-2"></ul>
                            <div id="poolStats" class="mt-4 p-3 rounded-lg bg-slate-50 text-xs text-slate-600"></div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- æŠ½å¥–æ§åˆ¶ -->
            <section class="mt-10">
                <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
                    <div class="p-5 border-b border-slate-100">
                        <h3 class="font-semibold">æŠ½å¥–æ§åˆ¶è®¾ç½®</h3>
                    </div>
                    <div class="p-5 grid md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-medium mb-3">æŠ½å¥–æ¬¡æ•°é™åˆ¶</h4>
                            <div class="space-y-3">
                                <div>
                                    <label for="drawLimitInput"
                                        class="block text-sm font-medium text-slate-700 mb-1">æ¯ç”¨æˆ·æœ€å¤§æŠ½å¥–æ¬¡æ•°</label>
                                    <input type="number" id="drawLimitInput" min="1" max="9999"
                                        class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:border-[var(--labu)] focus:ring-2 focus:ring-[var(--labu)]/20 focus:outline-none"
                                        placeholder="è¾“å…¥æ¬¡æ•°é™åˆ¶ï¼ˆ0è¡¨ç¤ºä¸é™åˆ¶ï¼‰">
                                </div>
                                <div class="flex gap-3">
                                    <button id="saveDrawLimitBtn"
                                        class="px-4 py-2 rounded-xl bg-[var(--labu)] text-white font-medium hover:opacity-90">ä¿å­˜è®¾ç½®</button>
                                    <button id="disableDrawLimitBtn"
                                        class="px-4 py-2 rounded-xl bg-slate-100 border border-slate-200 hover:bg-slate-200">å–æ¶ˆé™åˆ¶</button>
                                </div>
                                <div class="text-xs text-slate-500">
                                    å½“å‰é™åˆ¶ï¼š<span id="currentDrawLimit">æœªè®¾ç½®</span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-medium mb-3">ç”¨æˆ·æŠ½å¥–ç»Ÿè®¡</h4>
                            <div class="space-y-3">
                                <div class="p-3 rounded-lg bg-slate-50 text-sm">
                                    <div class="flex justify-between">
                                        <span>å½“å‰ç”¨æˆ·å·²æŠ½å¥–ï¼š</span>
                                        <span class="font-medium" id="userDrawCount">0 æ¬¡</span>
                                    </div>
                                </div>
                                <div class="p-3 rounded-lg bg-green-50 text-sm">
                                    <div class="flex justify-between">
                                        <span>ğŸŸ¢ å®æ—¶åŒæ­¥çŠ¶æ€ï¼š</span>
                                        <span class="font-medium text-green-600" id="syncStatus">å·²è¿æ¥</span>
                                    </div>
                                    <div class="text-xs text-slate-500 mt-1">ç®¡ç†å‘˜ä¿®æ”¹å°†å®æ—¶æ¨é€åˆ°æ‰€æœ‰ç”¨æˆ·</div>
                                </div>
                                <button id="resetUserDrawCountBtn"
                                    class="w-full px-4 py-2 rounded-xl bg-orange-100 text-orange-700 border border-orange-200 hover:bg-orange-200">é‡ç½®ç”¨æˆ·æŠ½å¥–æ¬¡æ•°</button>
                                <div class="text-xs text-slate-500">é‡ç½®åç”¨æˆ·å¯ä»¥é‡æ–°å¼€å§‹æŠ½å¥–</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- æ•°æ®ç®¡ç† -->
            <section class="mt-10">
                <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
                    <div class="p-5 border-b border-slate-100">
                        <h3 class="font-semibold">æ•°æ®ç®¡ç†</h3>
                    </div>
                    <div class="p-5 grid md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-medium mb-3">æŠ½å¥–è®°å½•ç®¡ç†</h4>
                            <div class="flex gap-3 flex-wrap">
                                <button id="exportHistoryBtn"
                                    class="px-4 py-2 rounded-xl bg-green-100 text-green-700 border border-green-200 hover:bg-green-200">å¯¼å‡ºæŠ½å¥–è®°å½•</button>
                                <button id="clearHistoryBtn"
                                    class="px-4 py-2 rounded-xl bg-red-100 text-red-700 border border-red-200 hover:bg-red-200">æ¸…ç©ºæŠ½å¥–è®°å½•</button>
                            </div>
                            <div class="mt-2 text-xs text-slate-500">å½“å‰è®°å½•æ•°ï¼š<span id="historyCount">0</span></div>
                        </div>
                        <div>
                            <h4 class="font-medium mb-3">ç³»ç»Ÿé‡ç½®</h4>
                            <div class="flex gap-3 flex-wrap">
                                <button id="resetAllBtn"
                                    class="px-4 py-2 rounded-xl bg-red-100 text-red-700 border border-red-200 hover:bg-red-200">å®Œå…¨é‡ç½®</button>
                            </div>
                            <div class="mt-2 text-xs text-slate-500">å°†æ¸…ç©ºæ‰€æœ‰æ•°æ®å¹¶æ¢å¤é»˜è®¤å¥–æ± </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- æˆå°±å‹‹ç« ç®¡ç† -->
            <section class="mt-10">
                <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
                    <div class="p-5 border-b border-slate-100">
                        <h3 class="font-semibold flex items-center gap-2">
                            ğŸ† æˆå°±å‹‹ç« ç®¡ç†
                        </h3>
                    </div>
                    <div class="p-5">
                        <!-- ç”¨æˆ·æœç´¢ -->
                        <div class="mb-6">
                            <h4 class="font-medium mb-3">ç”¨æˆ·ç®¡ç†</h4>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label for="userSearchInput"
                                        class="block text-sm font-medium text-slate-700 mb-1">æœç´¢ç”¨æˆ·</label>
                                    <div class="flex gap-2">
                                        <input type="text" id="userSearchInput"
                                            class="flex-1 px-3 py-2 rounded-lg border border-slate-300 focus:border-[var(--labu)] focus:ring-2 focus:ring-[var(--labu)]/20 focus:outline-none"
                                            placeholder="è¾“å…¥ç”¨æˆ·åæœç´¢...">
                                        <button id="searchUserBtn"
                                            class="px-4 py-2 rounded-lg bg-[var(--labu)] text-white hover:opacity-90">æœç´¢</button>
                                    </div>
                                </div>
                                <div>
                                    <label for="selectedUser"
                                        class="block text-sm font-medium text-slate-700 mb-1">é€‰æ‹©ç”¨æˆ·</label>
                                    <select id="selectedUser"
                                        class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:border-[var(--labu)] focus:ring-2 focus:ring-[var(--labu)]/20 focus:outline-none">
                                        <option value="">è¯·é€‰æ‹©ç”¨æˆ·...</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º -->
                        <div id="userInfoSection" class="mb-6 p-4 rounded-lg bg-slate-50 hidden">
                            <h4 class="font-medium mb-3">ç”¨æˆ·ä¿¡æ¯</h4>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <div class="flex items-center gap-3 mb-3">
                                        <div
                                            class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center text-xl">
                                            <span id="userInfoAvatar">ğŸ§¸</span>
                                        </div>
                                        <div>
                                            <h5 id="userInfoName" class="font-bold">ç”¨æˆ·å</h5>
                                            <p id="userInfoBio" class="text-sm text-slate-600">ä¸ªæ€§ç­¾å</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-sm">
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>æ€»æŠ½å¥–ï¼š<span id="userTotalDraws" class="font-medium">0</span></div>
                                        <div>ä¸­å¥–æ¬¡æ•°ï¼š<span id="userTotalWins" class="font-medium">0</span></div>
                                        <div>ç§¯åˆ†ï¼š<span id="userPoints" class="font-medium">0</span></div>
                                        <div>æˆå°±ï¼š<span id="userAchievements" class="font-medium">0/12</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- æˆå°±å‘æ”¾ -->
                        <div id="achievementGrantSection" class="hidden">
                            <h4 class="font-medium mb-3">å‘æ”¾æˆå°±å‹‹ç« </h4>
                            <div class="grid md:grid-cols-2 gap-6">
                                <!-- æˆå°±åˆ—è¡¨ -->
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">é€‰æ‹©æˆå°±</label>
                                    <div id="achievementsList" class="space-y-2 max-h-64 overflow-y-auto">
                                        <!-- æˆå°±é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                                    </div>
                                </div>

                                <!-- æ‰¹é‡æ“ä½œ -->
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">æ‰¹é‡æ“ä½œ</label>
                                    <div class="space-y-3">
                                        <button id="grantSelectedBtn"
                                            class="w-full px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                                            disabled>å‘æ”¾é€‰ä¸­æˆå°±</button>
                                        <button id="revokeSelectedBtn"
                                            class="w-full px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                                            disabled>æ’¤é”€é€‰ä¸­æˆå°±</button>
                                        <button id="grantAllBtn"
                                            class="w-full px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                                            disabled>å‘æ”¾å…¨éƒ¨æˆå°±</button>
                                        <button id="resetAllAchievementsBtn"
                                            class="w-full px-4 py-2 rounded-lg bg-orange-600 text-white hover:bg-orange-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                                            disabled>é‡ç½®å…¨éƒ¨æˆå°±</button>
                                    </div>

                                    <div class="mt-4 p-3 rounded-lg bg-yellow-50 border border-yellow-200">
                                        <p class="text-xs text-yellow-700">
                                            <strong>æ³¨æ„ï¼š</strong>ç®¡ç†å‘˜æ‰‹åŠ¨å‘æ”¾çš„æˆå°±ä¼šè¦†ç›–ç³»ç»Ÿè‡ªåŠ¨åˆ¤å®šï¼Œè¯·è°¨æ…æ“ä½œã€‚
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- å…¨å±€æˆå°±ç»Ÿè®¡ -->
                        <div class="mt-6 pt-6 border-t border-slate-200">
                            <h4 class="font-medium mb-3">å…¨å±€æˆå°±ç»Ÿè®¡</h4>
                            <div id="globalAchievementStats" class="grid md:grid-cols-4 gap-4 text-sm">
                                <!-- ç»Ÿè®¡æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="max-w-5xl mx-auto px-4 py-10 text-center text-xs text-slate-500">
            <div>Â© <span id="year"></span> Labubu æŠ½å¥–ç®¡ç†ç³»ç»Ÿ</div>
        </footer>
    </div> <!-- ä¸»ç•Œé¢å†…å®¹ç»“æŸ -->

    <!-- éŸ³ä¹æ’­æ”¾å™¨æµ®çª— -->
    <div id="musicPlayer"
        class="fixed bottom-4 right-4 z-40 music-player rounded-2xl shadow-lg border border-slate-200 p-4 w-80"
        style="backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.9);">
        <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
                <span class="text-lg">ğŸµ</span>
                <span class="font-medium text-sm">éŸ³ä¹æ’­æ”¾å™¨</span>
            </div>
            <button id="togglePlayer" class="text-slate-400 hover:text-slate-600">
                <span id="playerToggleIcon">ğŸ”½</span>
            </button>
        </div>

        <div id="playerContent" class="space-y-3">
            <!-- å½“å‰æ’­æ”¾ä¿¡æ¯ -->
            <div class="text-center">
                <div id="currentSong" class="font-medium text-sm text-slate-800">Ready to Play</div>
                <div id="currentArtist" class="text-xs text-slate-500">é€‰æ‹©ä¸€é¦–æ­Œå¼€å§‹æ’­æ”¾</div>
            </div>

            <!-- è¿›åº¦æ¡ -->
            <div class="space-y-2">
                <div class="flex justify-between text-xs text-slate-500">
                    <span id="currentTime">0:00</span>
                    <span id="totalTime">0:00</span>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-1">
                    <div id="progressBar" class="h-1 rounded-full w-0 transition-all"
                        style="background: linear-gradient(90deg, var(--labu) 0%, var(--labu2) 100%);"></div>
                </div>
            </div>

            <!-- æ§åˆ¶æŒ‰é’® -->
            <div class="flex items-center justify-center gap-4">
                <button id="prevBtn" class="text-xl hover:scale-110 transition-transform">â®ï¸</button>
                <button id="playPauseBtn" class="text-2xl hover:scale-110 transition-transform">â–¶ï¸</button>
                <button id="nextBtn" class="text-xl hover:scale-110 transition-transform">â­ï¸</button>
            </div>

            <!-- éŸ³é‡æ§åˆ¶å·²ç§»é™¤ï¼Œç®€åŒ–ç•Œé¢ -->

            <!-- æ’­æ”¾åˆ—è¡¨ -->
            <div class="max-h-32 overflow-y-auto space-y-1">
                <div class="text-xs text-slate-500 mb-2">æ’­æ”¾åˆ—è¡¨</div>
                <div id="playlist" class="space-y-1"></div>
            </div>
        </div>

        <!-- æœ€å°åŒ–çŠ¶æ€ -->
        <div id="playerMinimized" class="hidden">
            <div class="flex items-center gap-2">
                <button id="miniPlayPause" class="text-lg">â–¶ï¸</button>
                <div class="flex-1 text-sm truncate">
                    <div id="miniSongName" class="font-medium">æœªæ’­æ”¾</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // â€”â€” å®‰å…¨æ£€æŸ¥ â€”â€”
        if (!window._secureConfig || !window._secureConfig.validate()) {
            console.log('ğŸµ ç®¡ç†å‘˜ç³»ç»Ÿ');
        }

        // æ£€æŸ¥æ¡æ¬¾åŒæ„çŠ¶æ€
        function checkTermsAgreement() {
            const agreed = localStorage.getItem('terms_agreed');
            if (!agreed) {
                window.location.href = 'welcome.html';
                return false;
            }

            const agreeTime = parseInt(agreed);
            const now = Date.now();
            const dayInMs = 24 * 60 * 60 * 1000;

            // æ¡æ¬¾åŒæ„æœ‰æ•ˆæœŸ7å¤©
            if (now - agreeTime > 7 * dayInMs) {
                localStorage.removeItem('terms_agreed');
                window.location.href = 'welcome.html';
                return false;
            }

            return true;
        }

        // é¡µé¢åˆå§‹åŒ–å‰æ£€æŸ¥æ¡æ¬¾
        if (!checkTermsAgreement()) {
            // å¦‚æœæ¡æ¬¾æ£€æŸ¥å¤±è´¥ï¼Œåœæ­¢åç»­æ‰§è¡Œ
        } else {

            // â€”â€” åŠ å¯†é…ç½®å¸¸é‡ â€”â€”
            const _0x7c3f = window._secureConfig.decode(window._secureConfig._0x1a2b);
            const _0x8d4e = 'labubu_vip_admin_' + btoa('secure_session');

            const ADMIN_PASSWORD = _0x7c3f;
            const SESSION_KEY = _0x8d4e;

            // â€”â€” æœ¬åœ°å­˜å‚¨é”® â€”â€”
            const LS_KEYS = {
                HISTORY: 'labubu_lottery_history',
                POOL: 'labubu_lottery_pool',
                DRAW_LIMIT: 'labubu_draw_limit',
                USER_DRAW_COUNT: 'labubu_user_draw_count'
            };

            // â€”â€” æ•°æ®åŒæ­¥å¹¿æ’­ â€”â€”
            let dataChannel = null;
            let syncEnabled = false;

            // æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
            if ('BroadcastChannel' in window) {
                try {
                    dataChannel = new BroadcastChannel('labubu_data_sync');
                    syncEnabled = true;
                } catch (error) {
                    console.warn('BroadcastChannelåˆå§‹åŒ–å¤±è´¥:', error);
                    syncEnabled = false;
                }
            } else {
                console.warn('æµè§ˆå™¨ä¸æ”¯æŒBroadcastChannelï¼Œå®æ—¶åŒæ­¥åŠŸèƒ½å°†ä¸å¯ç”¨');
                syncEnabled = false;
            }

            function broadcastUpdate(type, data = null) {
                if (!syncEnabled || !dataChannel) {
                    console.warn('æ•°æ®åŒæ­¥ä¸å¯ç”¨ï¼Œè·³è¿‡å¹¿æ’­:', type);
                    return;
                }

                try {
                    const message = {
                        type: type,
                        data: data,
                        timestamp: Date.now(),
                        source: 'admin'
                    };
                    dataChannel.postMessage(message);
                    console.log('ğŸ“¡ å¹¿æ’­æ›´æ–°:', type);
                    showBroadcastNotification(type);
                } catch (error) {
                    console.error('å¹¿æ’­å¤±è´¥:', error);
                    showBroadcastNotification('SYNC_ERROR');
                }
            }

            function showBroadcastNotification(type) {
                const typeNames = {
                    'POOL_UPDATE': 'å¥–æ± é…ç½®',
                    'DRAW_LIMIT_UPDATE': 'æŠ½å¥–é™åˆ¶',
                    'USER_COUNT_RESET': 'ç”¨æˆ·è®¡æ•°é‡ç½®',
                    'SYSTEM_RESET': 'ç³»ç»Ÿé‡ç½®',
                    'HISTORY_CLEARED': 'è®°å½•æ¸…ç©º',
                    'SYNC_ERROR': 'åŒæ­¥å¤±è´¥'
                };

                const notification = document.createElement('div');
                const isError = type === 'SYNC_ERROR';
                const bgColor = isError ? 'bg-red-500' : 'bg-green-500';
                const icon = isError ? 'âŒ' : 'ğŸ“¡';
                const message = isError ? 'åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥' : `${typeNames[type] || type} å·²æ¨é€åˆ°æ‰€æœ‰ç”¨æˆ·`;

                notification.className = `fixed top-20 right-4 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm transition-all duration-300`;
                notification.innerHTML = `${icon} ${message}`;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (document.body.contains(notification)) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }, isError ? 5000 : 2000); // é”™è¯¯æ¶ˆæ¯æ˜¾ç¤ºæ›´é•¿æ—¶é—´
            }

            function updateSyncStatus() {
                const statusElement = $('#syncStatus');
                if (statusElement) {
                    if (syncEnabled) {
                        statusElement.textContent = 'å·²è¿æ¥';
                        statusElement.className = 'font-medium text-green-600';
                    } else {
                        statusElement.textContent = 'ä¸å¯ç”¨';
                        statusElement.className = 'font-medium text-red-600';
                    }
                }
            }

            // â€”â€” VIPä¸“äº«å¥–æ±  (å«è¶…ç¨€æœ‰ä¸Šè¿ªæŒ‚ä»¶) â€”â€”
            const DEFAULT_POOL = [
                // æ™®é€šå¥–å“
                { name: "å†æ¥å†å‰", type: 'æŠ˜æ‰£åˆ¸', weight: 30, quantity: 50, rarity: 'common', points: 10, emoji: "ğŸ’ª" },
                { name: "å¥¶èŒ¶ä¸€æ¯", type: 'å®ä½“', weight: 25, quantity: 30, rarity: 'common', points: 20, emoji: "ğŸ§‹" },
                { name: "çƒ¤è‚‰åˆ¸ï¼ˆæ¸…çœŸè®°å½•ï¼‰", type: 'å®ä½“', weight: 20, quantity: 25, rarity: 'common', points: 30, emoji: "ğŸ¥©" },
                { name: "çƒ¤è‚‰åˆ¸", type: 'å®ä½“', weight: 20, quantity: 20, rarity: 'common', points: 30, emoji: "ğŸ–" },
                { name: "ç²¾å“å¥¶èŒ¶åˆ¸", type: 'å®ä½“', weight: 15, quantity: 15, rarity: 'rare', points: 50, emoji: "ğŸ§ƒ" },
                { name: "1Uå¸", type: 'å®ä½“', weight: 25, quantity: 100, rarity: 'common', points: 1, emoji: "ğŸ’°" },
                { name: "3Uå¸", type: 'å®ä½“', weight: 15, quantity: 60, rarity: 'common', points: 3, emoji: "ğŸ’µ" },
                { name: "5Uå¸", type: 'å®ä½“', weight: 10, quantity: 40, rarity: 'rare', points: 5, emoji: "ğŸ’¸" },

                // Labubuç³»åˆ—æ”¶è—
                { name: "ç»å…¸Labubuå…¬ä»”", type: 'å®ä½“', weight: 8, quantity: 10, rarity: 'rare', points: 100, image: "images/prizes/labubu/classic.jpg", emoji: "ğŸ§¸" },
                { name: "å½©è™¹Labubué™å®š", type: 'å®ä½“', weight: 6, quantity: 8, rarity: 'epic', points: 150, image: "images/prizes/labubu/rainbow.jpg", emoji: "ğŸŒˆ" },
                { name: "ä¸‡åœ£èŠ‚Labubuç‰¹åˆ«ç‰ˆ", type: 'å®ä½“', weight: 4, quantity: 5, rarity: 'epic', points: 200, image: "images/prizes/labubu/halloween.jpg", emoji: "ğŸƒ" },
                { name: "é»„é‡‘Labubuæ”¶è—ç‰ˆ", type: 'å®ä½“', weight: 2, quantity: 3, rarity: 'legendary', points: 500, image: "images/prizes/labubu/gold.jpg", emoji: "ğŸ‘‘" },

                // Cookie Annè¿ªå£«å°¼ç³»åˆ—
                { name: "ç”œå¿ƒCookie Annå…¬ä»”", type: 'å®ä½“', weight: 7, quantity: 8, rarity: 'rare', points: 120, image: "images/prizes/cookie-ann/sweet.jpg", emoji: "ğŸª" },
                { name: "å…¬ä¸»Cookie Anné™å®š", type: 'å®ä½“', weight: 5, quantity: 6, rarity: 'epic', points: 180, image: "images/prizes/cookie-ann/princess.jpg", emoji: "ğŸ‘¸" },
                { name: "åœ£è¯Cookie Annç‰¹åˆ«ç‰ˆ", type: 'å®ä½“', weight: 3, quantity: 4, rarity: 'epic', points: 220, image: "images/prizes/cookie-ann/christmas.jpg", emoji: "ğŸ„" },
                { name: "çƒ˜ç„™å¤§å¸ˆCookie Ann", type: 'å®ä½“', weight: 1.5, quantity: 2, rarity: 'legendary', points: 600, image: "images/prizes/cookie-ann/baker.jpg", emoji: "ğŸ‘©â€ğŸ³" },

                // Pop Martæ½®ç©ç³»åˆ—
                { name: "Mollyç»å…¸æ¬¾", type: 'å®ä½“', weight: 6, quantity: 7, rarity: 'rare', points: 110, image: "images/prizes/popmart/molly-classic.jpg", emoji: "ğŸ‘§" },
                { name: "Dimooäº‘æœµç³»åˆ—", type: 'å®ä½“', weight: 4, quantity: 5, rarity: 'epic', points: 160, image: "images/prizes/popmart/dimoo-cloud.jpg", emoji: "â˜ï¸" },
                { name: "Skullpandaéª·é«…ç†ŠçŒ«", type: 'å®ä½“', weight: 2.5, quantity: 3, rarity: 'legendary', points: 450, image: "images/prizes/popmart/skullpanda.jpg", emoji: "ğŸ¼" },

                // è¶…ç¨€æœ‰ç‰¹åˆ«ç‰ˆæŒ‚ä»¶ - ä¸­å¥–ç‡æä½ (å‡ ä¹ä¸º0)
                { name: "é™å®šLabubuä¸‡åœ£èŠ‚æŒ‚ä»¶", type: 'å®ä½“', weight: 0.1, quantity: 1, rarity: 'mythic', points: 2000, image: "images/prizes/labubu/halloween-special.jpg", emoji: "ğŸƒ" },
                { name: "é™å®šCookie Annåœ£è¯æŒ‚ä»¶", type: 'å®ä½“', weight: 0.1, quantity: 1, rarity: 'mythic', points: 2000, image: "images/prizes/cookie-ann/christmas-special.jpg", emoji: "ğŸ„" },
                { name: "é™å®šMollyå¤æ—¥æµ·æ´‹æŒ‚ä»¶", type: 'å®ä½“', weight: 0.05, quantity: 1, rarity: 'mythic', points: 3000, image: "images/prizes/popmart/molly-ocean-special.jpg", emoji: "ğŸŒŠ" }
            ];

            // â€”â€” å·¥å…·å‡½æ•° â€”â€”
            const $ = (sel) => document.querySelector(sel);

            function loadHistory() {
                try { return JSON.parse(localStorage.getItem(LS_KEYS.HISTORY)) || []; } catch { return []; }
            }
            function saveHistory(arr) { localStorage.setItem(LS_KEYS.HISTORY, JSON.stringify(arr)); }
            function loadPool() {
                try {
                    const raw = localStorage.getItem(LS_KEYS.POOL);
                    return raw ? JSON.parse(raw) : structuredClone(DEFAULT_POOL);
                } catch { return structuredClone(DEFAULT_POOL); }
            }
            function savePool(pool) { localStorage.setItem(LS_KEYS.POOL, JSON.stringify(pool)); }

            function poolToText(pool) {
                return pool.map(p => [p.name, p.type, p.weight, (p.quantity ?? -1)].join(',')).join('\n');
            }
            function textToPool(txt) {
                const lines = txt.split(/\n+/).map(l => l.trim()).filter(Boolean);

                if (lines.length === 0) {
                    throw new Error('å¥–æ± ä¸èƒ½ä¸ºç©º');
                }

                if (lines.length > 100) {
                    throw new Error('å¥–æ± é¡¹ç›®ä¸èƒ½è¶…è¿‡100ä¸ª');
                }

                return lines.map((line, i) => {
                    const parts = line.split(',').map(s => s?.trim());

                    if (parts.length < 3 || parts.length > 4) {
                        throw new Error(`ç¬¬ ${i + 1} è¡Œæ ¼å¼ä¸æ­£ç¡®ï¼šåº”ä¸º name,type,weight[,quantity]`);
                    }

                    const [name, type, weightStr, qtyStr] = parts;

                    // åç§°éªŒè¯
                    if (!name || name.length > 50) {
                        throw new Error(`ç¬¬ ${i + 1} è¡Œï¼šå¥–å“åç§°ä¸èƒ½ä¸ºç©ºä¸”ä¸èƒ½è¶…è¿‡50å­—ç¬¦`);
                    }

                    // ç±»å‹éªŒè¯
                    if (!['æŠµæ‰£åˆ¸', 'å®ä½“', 'æŠ˜æ‰£åˆ¸'].includes(type)) {
                        throw new Error(`ç¬¬ ${i + 1} è¡Œï¼šå¥–å“ç±»å‹åªèƒ½æ˜¯ æŠµæ‰£åˆ¸/å®ä½“/æŠ˜æ‰£åˆ¸`);
                    }

                    // æƒé‡éªŒè¯
                    const weight = Number(weightStr);
                    if (!Number.isFinite(weight) || weight < 0 || weight > 10000) {
                        throw new Error(`ç¬¬ ${i + 1} è¡Œï¼šæƒé‡å¿…é¡»æ˜¯0-10000ä¹‹é—´çš„æ•°å­—`);
                    }

                    // æ•°é‡éªŒè¯
                    let quantity = -1;
                    if (qtyStr !== undefined && qtyStr !== '') {
                        quantity = Number(qtyStr);
                        if (!Number.isInteger(quantity) || quantity < -1 || quantity > 99999) {
                            throw new Error(`ç¬¬ ${i + 1} è¡Œï¼šæ•°é‡å¿…é¡»æ˜¯-1åˆ°99999ä¹‹é—´çš„æ•´æ•°`);
                        }
                    }

                    return { name, type, weight, quantity };
                });
            }

            function renderPoolList(pool) {
                const ul = $('#poolList');
                ul.innerHTML = '';
                const totalW = pool.reduce((s, p) => s + Math.max(0, p.weight || 0), 0) || 1;

                pool.forEach(p => {
                    const left = p.quantity === -1 ? 'âˆ' : p.quantity;
                    const w = p.weight || 0;
                    const pct = ((w / totalW) * 100).toFixed(1);
                    const color = p.type === 'å®ä½“' ? 'bg-emerald-50 text-emerald-700 border-emerald-200' :
                        (p.type === 'æŠµæ‰£åˆ¸' ? 'bg-indigo-50 text-indigo-700 border-indigo-200' : 'bg-amber-50 text-amber-700 border-amber-200');

                    const li = document.createElement('li');
                    li.className = `border rounded-xl p-3 ${color}`;
                    li.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="font-medium">${p.name}</div>
                        <span class="text-xs px-2 py-0.5 rounded-lg bg-white/60 border">${p.type}</span>
                    </div>
                    <div class="text-xs mt-1 flex justify-between">
                        <span>æƒé‡: ${w} (â‰ˆ${pct}%)</span>
                        <span>å‰©ä½™: <b>${left}</b></span>
                    </div>
                `;
                    ul.appendChild(li);
                });

                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                const stats = $('#poolStats');
                const totalItems = pool.length;
                const totalWeight = totalW;
                const physicalItems = pool.filter(p => p.type === 'å®ä½“').length;
                stats.innerHTML = `æ€»è®¡ ${totalItems} ç§å¥–å“ | æ€»æƒé‡: ${totalWeight} | å®ä½“å¥–å“: ${physicalItems} ç§`;
            }

            function refreshPoolEditor() {
                const pool = loadPool();
                $('#poolEditor').value = poolToText(pool);
            }

            function exportHistory() {
                const history = loadHistory();
                const data = JSON.stringify(history, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `labubu_lottery_history_${Date.now()}.json`;
                a.click();
            }

            function clearHistory() {
                if (confirm('ç¡®è®¤æ¸…ç©ºæ‰€æœ‰æŠ½å¥–è®°å½•ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                    saveHistory([]);
                    updateHistoryCount();
                    broadcastUpdate('HISTORY_CLEARED'); // å¹¿æ’­è®°å½•æ¸…ç©ºï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰
                    alert('æŠ½å¥–è®°å½•å·²æ¸…ç©º');
                }
            }

            function resetAll() {
                if (confirm('ç¡®è®¤å®Œå…¨é‡ç½®ç³»ç»Ÿï¼Ÿè¿™å°†æ¸…ç©ºæ‰€æœ‰æ•°æ®å¹¶æ¢å¤é»˜è®¤å¥–æ± ï¼')) {
                    localStorage.removeItem(LS_KEYS.HISTORY);
                    localStorage.removeItem(LS_KEYS.POOL);
                    localStorage.removeItem(LS_KEYS.DRAW_LIMIT);
                    localStorage.removeItem(LS_KEYS.USER_DRAW_COUNT);
                    refreshPoolEditor();
                    renderPoolList(loadPool());
                    updateHistoryCount();
                    updateDrawLimitDisplay();
                    broadcastUpdate('SYSTEM_RESET'); // å¹¿æ’­ç³»ç»Ÿé‡ç½®
                    alert('ç³»ç»Ÿå·²é‡ç½®åˆ°é»˜è®¤çŠ¶æ€ï¼Œæ‰€æœ‰ç”¨æˆ·ç•Œé¢å°†è‡ªåŠ¨åˆ·æ–°');
                }
            }

            function updateHistoryCount() {
                const count = loadHistory().length;
                $('#historyCount').textContent = count;
            }

            // â€”â€” æŠ½å¥–æ¬¡æ•°é™åˆ¶ç®¡ç† â€”â€”
            function loadDrawLimit() {
                try {
                    const limit = localStorage.getItem(LS_KEYS.DRAW_LIMIT);
                    return limit ? parseInt(limit) : 0; // 0è¡¨ç¤ºä¸é™åˆ¶
                } catch { return 0; }
            }

            function saveDrawLimit(limit) {
                localStorage.setItem(LS_KEYS.DRAW_LIMIT, limit.toString());
            }

            function loadUserDrawCount() {
                try {
                    const count = localStorage.getItem(LS_KEYS.USER_DRAW_COUNT);
                    return count ? parseInt(count) : 0;
                } catch { return 0; }
            }

            function saveUserDrawCount(count) {
                localStorage.setItem(LS_KEYS.USER_DRAW_COUNT, count.toString());
            }

            function updateDrawLimitDisplay() {
                const limit = loadDrawLimit();
                const currentLimitSpan = $('#currentDrawLimit');
                const drawLimitInput = $('#drawLimitInput');

                if (limit === 0) {
                    currentLimitSpan.textContent = 'ä¸é™åˆ¶';
                    drawLimitInput.value = '';
                } else {
                    currentLimitSpan.textContent = `${limit} æ¬¡`;
                    drawLimitInput.value = limit;
                }

                const userCount = loadUserDrawCount();
                $('#userDrawCount').textContent = `${userCount} æ¬¡`;
            }

            function setDrawLimit() {
                const input = $('#drawLimitInput');
                const limit = parseInt(input.value) || 0;

                if (limit < 0) {
                    alert('æŠ½å¥–æ¬¡æ•°ä¸èƒ½ä¸ºè´Ÿæ•°');
                    return;
                }

                if (limit > 9999) {
                    alert('æŠ½å¥–æ¬¡æ•°ä¸èƒ½è¶…è¿‡9999æ¬¡');
                    return;
                }

                saveDrawLimit(limit);
                updateDrawLimitDisplay();
                broadcastUpdate('DRAW_LIMIT_UPDATE', { limit }); // å¹¿æ’­é™åˆ¶æ›´æ–°

                if (limit === 0) {
                    alert('æŠ½å¥–æ¬¡æ•°é™åˆ¶å·²å–æ¶ˆå¹¶åŒæ­¥åˆ°æ‰€æœ‰ç”¨æˆ·');
                } else {
                    alert(`æŠ½å¥–æ¬¡æ•°é™åˆ¶å·²è®¾ç½®ä¸º ${limit} æ¬¡å¹¶åŒæ­¥åˆ°æ‰€æœ‰ç”¨æˆ·`);
                }
            }

            function disableDrawLimit() {
                if (confirm('ç¡®è®¤å–æ¶ˆæŠ½å¥–æ¬¡æ•°é™åˆ¶ï¼Ÿç”¨æˆ·å°†å¯ä»¥æ— é™åˆ¶æŠ½å¥–ã€‚')) {
                    saveDrawLimit(0);
                    updateDrawLimitDisplay();
                    broadcastUpdate('DRAW_LIMIT_UPDATE', { limit: 0 }); // å¹¿æ’­é™åˆ¶å–æ¶ˆ
                    alert('æŠ½å¥–æ¬¡æ•°é™åˆ¶å·²å–æ¶ˆå¹¶åŒæ­¥åˆ°æ‰€æœ‰ç”¨æˆ·');
                }
            }

            function resetUserDrawCount() {
                if (confirm('ç¡®è®¤é‡ç½®ç”¨æˆ·æŠ½å¥–æ¬¡æ•°ï¼Ÿé‡ç½®åç”¨æˆ·å¯ä»¥é‡æ–°å¼€å§‹æŠ½å¥–ã€‚')) {
                    saveUserDrawCount(0);
                    updateDrawLimitDisplay();
                    broadcastUpdate('USER_COUNT_RESET'); // å¹¿æ’­ç”¨æˆ·è®¡æ•°é‡ç½®
                    alert('ç”¨æˆ·æŠ½å¥–æ¬¡æ•°å·²é‡ç½®å¹¶åŒæ­¥åˆ°æ‰€æœ‰ç”¨æˆ·');
                }
            }

            // â€”â€” ç™»å½•éªŒè¯ç›¸å…³ â€”â€”
            function isLoggedIn() {
                return sessionStorage.getItem(SESSION_KEY) === 'authenticated';
            }

            function login(password) {
                if (password === ADMIN_PASSWORD) {
                    sessionStorage.setItem(SESSION_KEY, 'authenticated');
                    showMainContent();
                    return true;
                }
                return false;
            }

            function logout() {
                sessionStorage.removeItem(SESSION_KEY);
                showLoginOverlay();
            }

            function showLoginOverlay() {
                $('#loginOverlay').classList.remove('hidden');
                $('#mainContent').classList.add('hidden');
                $('#adminPassword').value = '';
                $('#loginError').classList.add('hidden');
                $('#adminPassword').focus();
            }

            function showMainContent() {
                $('#loginOverlay').classList.add('hidden');
                $('#mainContent').classList.remove('hidden');
            }

            // é˜²æš´åŠ›ç ´è§£è®¡æ•°å™¨
            let loginAttempts = 0;
            let lastFailedLogin = 0;
            const MAX_LOGIN_ATTEMPTS = 5;
            const LOCKOUT_TIME = 5 * 60 * 1000; // 5åˆ†é’Ÿ

            function handleLogin() {
                const password = $('#adminPassword').value;
                const errorDiv = $('#loginError');
                const now = Date.now();

                // æ£€æŸ¥æ˜¯å¦å¤„äºé”å®šçŠ¶æ€
                if (loginAttempts >= MAX_LOGIN_ATTEMPTS && (now - lastFailedLogin) < LOCKOUT_TIME) {
                    const remainingTime = Math.ceil((LOCKOUT_TIME - (now - lastFailedLogin)) / 1000 / 60);
                    errorDiv.textContent = `ç™»å½•å·²é”å®šï¼Œè¯·${remainingTime}åˆ†é’Ÿåé‡è¯•`;
                    errorDiv.classList.remove('hidden');
                    return;
                }

                // é‡ç½®é”å®šçŠ¶æ€
                if ((now - lastFailedLogin) >= LOCKOUT_TIME) {
                    loginAttempts = 0;
                }

                if (!password) {
                    errorDiv.textContent = 'è¯·è¾“å…¥å¯†ç ';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                if (login(password)) {
                    errorDiv.classList.add('hidden');
                    // ç™»å½•æˆåŠŸï¼Œé‡ç½®å¤±è´¥è®¡æ•°
                    loginAttempts = 0;
                    lastFailedLogin = 0;
                } else {
                    loginAttempts++;
                    lastFailedLogin = now;

                    if (loginAttempts >= MAX_LOGIN_ATTEMPTS) {
                        errorDiv.textContent = `å¯†ç é”™è¯¯æ¬¡æ•°è¿‡å¤šï¼Œå·²é”å®š5åˆ†é’Ÿ`;
                    } else {
                        errorDiv.textContent = `å¯†ç é”™è¯¯ï¼Œè¿˜å¯å°è¯•${MAX_LOGIN_ATTEMPTS - loginAttempts}æ¬¡`;
                    }
                    errorDiv.classList.remove('hidden');
                    $('#adminPassword').value = '';
                    $('#adminPassword').focus();
                }
            }

            // â€”â€” äº‹ä»¶ç»‘å®š â€”â€”
            function bind() {
                // ç™»å½•ç›¸å…³äº‹ä»¶
                $('#loginBtn').addEventListener('click', handleLogin);
                $('#logoutBtn').addEventListener('click', () => {
                    if (confirm('ç¡®è®¤é€€å‡ºç®¡ç†ç³»ç»Ÿï¼Ÿ')) {
                        logout();
                    }
                });
                $('#adminPassword').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        handleLogin();
                    }
                });

                // åŸæœ‰åŠŸèƒ½äº‹ä»¶
                $('#savePoolBtn').addEventListener('click', () => {
                    try {
                        const text = $('#poolEditor').value;
                        const pool = textToPool(text);
                        savePool(pool);
                        renderPoolList(pool);
                        broadcastUpdate('POOL_UPDATE', pool); // å¹¿æ’­å¥–æ± æ›´æ–°
                        alert('å¥–æ± é…ç½®å·²ä¿å­˜å¹¶åŒæ­¥åˆ°æ‰€æœ‰ç”¨æˆ·');
                    } catch (e) {
                        alert('ä¿å­˜å¤±è´¥ï¼š' + e.message);
                    }
                });

                $('#reloadBtn').addEventListener('click', () => {
                    refreshPoolEditor();
                    renderPoolList(loadPool());
                    alert('å·²é‡æ–°è½½å…¥å½“å‰é…ç½®');
                });

                $('#restoreDefaultBtn').addEventListener('click', () => {
                    if (confirm('ç¡®è®¤æ¢å¤é»˜è®¤å¥–æ± é…ç½®ï¼Ÿå½“å‰é…ç½®å°†è¢«è¦†ç›–ï¼')) {
                        const defaultPool = structuredClone(DEFAULT_POOL);
                        savePool(defaultPool);
                        refreshPoolEditor();
                        renderPoolList(loadPool());
                        broadcastUpdate('POOL_UPDATE', defaultPool); // å¹¿æ’­å¥–æ± æ›´æ–°
                        alert('å·²æ¢å¤é»˜è®¤å¥–æ± é…ç½®å¹¶åŒæ­¥åˆ°æ‰€æœ‰ç”¨æˆ·');
                    }
                });

                $('#refreshPreviewBtn').addEventListener('click', () => {
                    renderPoolList(loadPool());
                });

                $('#exportHistoryBtn').addEventListener('click', exportHistory);
                $('#clearHistoryBtn').addEventListener('click', clearHistory);
                $('#resetAllBtn').addEventListener('click', resetAll);

                // æŠ½å¥–æ¬¡æ•°é™åˆ¶ç›¸å…³äº‹ä»¶
                $('#saveDrawLimitBtn').addEventListener('click', setDrawLimit);
                $('#disableDrawLimitBtn').addEventListener('click', disableDrawLimit);
                $('#resetUserDrawCountBtn').addEventListener('click', resetUserDrawCount);
                $('#drawLimitInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        setDrawLimit();
                    }
                });

                // æˆå°±ç®¡ç†ç›¸å…³äº‹ä»¶
                $('#searchUserBtn').addEventListener('click', searchUsers);
                $('#userSearchInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        searchUsers();
                    }
                });
                $('#selectedUser').addEventListener('change', selectUser);
                $('#grantSelectedBtn').addEventListener('click', grantSelectedAchievements);
                $('#revokeSelectedBtn').addEventListener('click', revokeSelectedAchievements);
                $('#grantAllBtn').addEventListener('click', grantAllAchievements);
                $('#resetAllAchievementsBtn').addEventListener('click', resetAllAchievements);
            }

            function init() {
                $('#year').textContent = new Date().getFullYear();

                // æ£€æŸ¥ç™»å½•çŠ¶æ€
                if (isLoggedIn()) {
                    showMainContent();
                    // åˆå§‹åŒ–ä¸»ç•Œé¢å†…å®¹
                    refreshPoolEditor();
                    renderPoolList(loadPool());
                    updateHistoryCount();
                    updateDrawLimitDisplay();
                    updateSyncStatus(); // æ›´æ–°åŒæ­¥çŠ¶æ€æ˜¾ç¤º
                    initAchievementManagement(); // åˆå§‹åŒ–æˆå°±ç®¡ç†
                } else {
                    showLoginOverlay();
                }
            }

            // â€”â€” æˆå°±ç®¡ç†åŠŸèƒ½ â€”â€”
            const ACHIEVEMENTS = [
                {
                    id: 'first_draw',
                    name: 'åˆè¯•ç‰›åˆ€',
                    description: 'å®Œæˆç¬¬ä¸€æ¬¡æŠ½å¥–',
                    icon: 'ğŸ¯',
                    reward: 50,
                    category: 'basic'
                },
                {
                    id: 'draw_master',
                    name: 'æŠ½å¥–è¾¾äºº',
                    description: 'ç´¯è®¡æŠ½å¥–10æ¬¡',
                    icon: 'ğŸ®',
                    reward: 200,
                    category: 'basic'
                },
                {
                    id: 'lucky_star',
                    name: 'å¹¸è¿ä¹‹æ˜Ÿ',
                    description: 'é¦–æ¬¡ä¸­å¥–',
                    icon: 'â­',
                    reward: 100,
                    category: 'basic'
                },
                {
                    id: 'legendary_hunter',
                    name: 'ä¼ è¯´çŒäºº',
                    description: 'è·å¾—ä¼ è¯´çº§å¥–å“',
                    icon: 'ğŸ†',
                    reward: 500,
                    category: 'rare'
                },
                {
                    id: 'coin_collector',
                    name: 'è´§å¸æ”¶é›†è€…',
                    description: 'ç´¯è®¡è·å¾—100Uå¸',
                    icon: 'ğŸ’°',
                    reward: 300,
                    category: 'basic'
                },
                {
                    id: 'loyal_player',
                    name: 'å¿ å®ç©å®¶',
                    description: 'è¿ç»­7å¤©å‚ä¸æŠ½å¥–',
                    icon: 'ğŸ”¥',
                    reward: 400,
                    category: 'rare'
                },
                {
                    id: 'social_butterfly',
                    name: 'ç¤¾äº¤è¾¾äºº',
                    description: 'é‚€è¯·5ä½å¥½å‹',
                    icon: 'ğŸ‘¥',
                    reward: 600,
                    category: 'friend'
                },
                {
                    id: 'gift_giver',
                    name: 'ç¤¼ç‰©è¾¾äºº',
                    description: 'åˆ†äº«ç¤¼ç‰©10æ¬¡',
                    icon: 'ğŸ',
                    reward: 350,
                    category: 'friend'
                },
                {
                    id: 'comment_king',
                    name: 'ç•™è¨€ä¹‹ç‹',
                    description: 'å‘è¡¨20æ¡ç•™è¨€',
                    icon: 'ğŸ’¬',
                    reward: 250,
                    category: 'social'
                },
                {
                    id: 'perfectionist',
                    name: 'å®Œç¾ä¸»ä¹‰è€…',
                    description: 'æ”¶é›†æ‰€æœ‰ç¨€æœ‰ä»¥ä¸Šå¥–å“',
                    icon: 'ğŸ’',
                    reward: 1000,
                    category: 'rare'
                },
                {
                    id: 'vip_supporter',
                    name: 'VIPæ”¯æŒè€…',
                    description: 'ç´¯è®¡ç§¯åˆ†è¾¾åˆ°5000',
                    icon: 'ğŸ‘‘',
                    reward: 800,
                    category: 'rare'
                },
                {
                    id: 'ultimate_collector',
                    name: 'ç»ˆææ”¶è—å®¶',
                    description: 'è§£é”æ‰€æœ‰æˆå°±',
                    icon: 'ğŸŒŸ',
                    reward: 2000,
                    category: 'legendary'
                }
            ];

            let selectedUserId = null;
            let currentUserData = null;

            function initAchievementManagement() {
                loadAllUsers();
                renderAchievementsList();
                updateGlobalStats();
            }

            function loadAllUsers() {
                const userSelect = $('#selectedUser');
                const comments = JSON.parse(localStorage.getItem('comments') || '[]');
                const userData = JSON.parse(localStorage.getItem('userData_achievements') || '{}');

                // æ¸…ç©ºç°æœ‰é€‰é¡¹
                userSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ç”¨æˆ·...</option>';

                // è·å–æ‰€æœ‰æ›¾ç»ç•™è¨€çš„ç”¨æˆ·
                const userNames = new Set();
                comments.forEach(comment => {
                    if (comment.userName) {
                        userNames.add(comment.userName);
                    }
                });

                // æ·»åŠ é»˜è®¤VIPç”¨æˆ·
                if (userData.name) {
                    userNames.add(userData.name);
                } else {
                    userNames.add('VIPè‚¡ä¸œ');
                }

                // å¡«å……é€‰æ‹©æ¡†
                Array.from(userNames).sort().forEach(userName => {
                    const option = document.createElement('option');
                    option.value = userName;
                    option.textContent = userName;
                    userSelect.appendChild(option);
                });
            }

            function searchUsers() {
                const searchTerm = $('#userSearchInput').value.trim().toLowerCase();
                const userSelect = $('#selectedUser');

                if (!searchTerm) {
                    alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                    return;
                }

                // æœç´¢åŒ¹é…çš„ç”¨æˆ·
                Array.from(userSelect.options).forEach(option => {
                    if (option.value.toLowerCase().includes(searchTerm)) {
                        option.selected = true;
                        selectUser();
                        return;
                    }
                });
            }

            function selectUser() {
                const userName = $('#selectedUser').value;
                if (!userName) {
                    hideUserInfo();
                    return;
                }

                selectedUserId = userName;
                loadUserData(userName);
                showUserInfo();
            }

            function loadUserData(userName) {
                // åŠ è½½ç”¨æˆ·æ•°æ®
                const userData = JSON.parse(localStorage.getItem('userData_achievements') || '{}');
                const history = JSON.parse(localStorage.getItem('lotteryHistory') || '[]');

                if (userName === userData.name || userName === 'VIPè‚¡ä¸œ') {
                    currentUserData = {
                        name: userData.name || 'VIPè‚¡ä¸œ',
                        bio: userData.bio || 'ğŸ¯ æŠ½å¥–è¾¾äºº Â· ğŸ† æˆå°±æ”¶é›†è€…',
                        avatar: userData.avatar || 'ğŸ§¸',
                        achievements: userData.achievements || {},
                        stats: {
                            totalDraws: history.length,
                            totalWins: history.filter(item => item.prize !== 'å†æ¥å†å‰').length,
                            points: calculateUserPoints(history, userData.achievements || {})
                        }
                    };
                } else {
                    // ä¸ºå…¶ä»–ç”¨æˆ·åˆ›å»ºé»˜è®¤æ•°æ®
                    currentUserData = {
                        name: userName,
                        bio: 'æ™®é€šç”¨æˆ·',
                        avatar: 'ğŸ‘¤',
                        achievements: {},
                        stats: {
                            totalDraws: 0,
                            totalWins: 0,
                            points: 0
                        }
                    };
                }

                updateUserDisplay();
            }

            function calculateUserPoints(history, achievements) {
                let points = 0;

                // ä»æŠ½å¥–å†å²è®¡ç®—ç§¯åˆ†
                history.forEach(item => {
                    if (item.points) {
                        points += item.points;
                    }
                });

                // æ·»åŠ æˆå°±å¥–åŠ±ç§¯åˆ†
                Object.values(achievements).forEach(achievement => {
                    if (achievement.unlocked) {
                        const achievementData = ACHIEVEMENTS.find(a => a.id === achievement.id);
                        if (achievementData) points += achievementData.reward;
                    }
                });

                return points;
            }

            function updateUserDisplay() {
                if (!currentUserData) return;

                $('#userInfoName').textContent = currentUserData.name;
                $('#userInfoBio').textContent = currentUserData.bio;
                $('#userInfoAvatar').textContent = currentUserData.avatar;
                $('#userTotalDraws').textContent = currentUserData.stats.totalDraws;
                $('#userTotalWins').textContent = currentUserData.stats.totalWins;
                $('#userPoints').textContent = currentUserData.stats.points;

                const unlockedCount = Object.values(currentUserData.achievements).filter(a => a.unlocked).length;
                $('#userAchievements').textContent = `${unlockedCount}/${ACHIEVEMENTS.length}`;

                updateAchievementsDisplay();
                updateButtonStates();
            }

            function updateAchievementsDisplay() {
                const achievementsList = $('#achievementsList');
                achievementsList.innerHTML = '';

                ACHIEVEMENTS.forEach(achievement => {
                    const userAchievement = currentUserData.achievements[achievement.id];
                    const isUnlocked = userAchievement?.unlocked || false;

                    const achievementItem = document.createElement('div');
                    achievementItem.className = `p-3 rounded-lg border-2 cursor-pointer transition-all ${isUnlocked
                        ? 'border-green-300 bg-green-50'
                        : 'border-gray-200 bg-gray-50'
                        }`;

                    achievementItem.innerHTML = `
                    <div class="flex items-center gap-3">
                        <input type="checkbox" class="achievement-checkbox" 
                               data-achievement-id="${achievement.id}" 
                               ${isUnlocked ? 'checked' : ''}>
                        <div class="text-2xl">${achievement.icon}</div>
                        <div class="flex-1">
                            <h5 class="font-medium text-sm">${achievement.name}</h5>
                            <p class="text-xs text-gray-600">${achievement.description}</p>
                            <div class="text-xs text-green-600">+${achievement.reward}ç§¯åˆ†</div>
                        </div>
                        <div class="text-xs ${isUnlocked ? 'text-green-600' : 'text-gray-400'}">
                            ${isUnlocked ? 'âœ… å·²è§£é”' : 'ğŸ”’ æœªè§£é”'}
                        </div>
                    </div>
                `;

                    achievementItem.addEventListener('click', (e) => {
                        if (e.target.type !== 'checkbox') {
                            const checkbox = achievementItem.querySelector('.achievement-checkbox');
                            checkbox.checked = !checkbox.checked;
                            updateButtonStates();
                        }
                    });

                    const checkbox = achievementItem.querySelector('.achievement-checkbox');
                    checkbox.addEventListener('change', updateButtonStates);

                    achievementsList.appendChild(achievementItem);
                });
            }

            function updateButtonStates() {
                const selectedCheckboxes = $$('.achievement-checkbox:checked');
                const hasSelection = selectedCheckboxes.length > 0;
                const hasUser = selectedUserId !== null;

                $('#grantSelectedBtn').disabled = !hasSelection || !hasUser;
                $('#revokeSelectedBtn').disabled = !hasSelection || !hasUser;
                $('#grantAllBtn').disabled = !hasUser;
                $('#resetAllAchievementsBtn').disabled = !hasUser;
            }

            function grantSelectedAchievements() {
                const selectedCheckboxes = $$('.achievement-checkbox:checked');
                const achievementIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.achievementId);

                if (achievementIds.length === 0) {
                    alert('è¯·é€‰æ‹©è¦å‘æ”¾çš„æˆå°±');
                    return;
                }

                if (!confirm(`ç¡®è®¤ä¸ºç”¨æˆ·"${currentUserData.name}"å‘æ”¾${achievementIds.length}ä¸ªæˆå°±ï¼Ÿ`)) {
                    return;
                }

                grantAchievements(achievementIds);
            }

            function revokeSelectedAchievements() {
                const selectedCheckboxes = $$('.achievement-checkbox:checked');
                const achievementIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.achievementId);

                if (achievementIds.length === 0) {
                    alert('è¯·é€‰æ‹©è¦æ’¤é”€çš„æˆå°±');
                    return;
                }

                if (!confirm(`ç¡®è®¤æ’¤é”€ç”¨æˆ·"${currentUserData.name}"çš„${achievementIds.length}ä¸ªæˆå°±ï¼Ÿ`)) {
                    return;
                }

                revokeAchievements(achievementIds);
            }

            function grantAllAchievements() {
                if (!confirm(`ç¡®è®¤ä¸ºç”¨æˆ·"${currentUserData.name}"å‘æ”¾æ‰€æœ‰æˆå°±ï¼Ÿ`)) {
                    return;
                }

                const allAchievementIds = ACHIEVEMENTS.map(a => a.id);
                grantAchievements(allAchievementIds);
            }

            function resetAllAchievements() {
                if (!confirm(`ç¡®è®¤é‡ç½®ç”¨æˆ·"${currentUserData.name}"çš„æ‰€æœ‰æˆå°±ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                    return;
                }

                const allAchievementIds = ACHIEVEMENTS.map(a => a.id);
                revokeAchievements(allAchievementIds);
            }

            function grantAchievements(achievementIds) {
                if (selectedUserId === currentUserData.name || selectedUserId === 'VIPè‚¡ä¸œ') {
                    // æ›´æ–°ä¸»ç”¨æˆ·æ•°æ®
                    const userData = JSON.parse(localStorage.getItem('userData_achievements') || '{}');

                    achievementIds.forEach(id => {
                        if (!userData.achievements) userData.achievements = {};
                        userData.achievements[id] = {
                            id: id,
                            unlocked: true,
                            progress: ACHIEVEMENTS.find(a => a.id === id)?.condition?.value || 1,
                            unlockedAt: new Date().toISOString(),
                            adminGranted: true
                        };
                    });

                    localStorage.setItem('userData_achievements', JSON.stringify(userData));
                    currentUserData.achievements = userData.achievements;
                }

                updateUserDisplay();
                broadcastUpdate('ACHIEVEMENT_UPDATE', { userId: selectedUserId, achievements: currentUserData.achievements });
                alert('æˆå°±å‘æ”¾æˆåŠŸï¼');
            }

            function revokeAchievements(achievementIds) {
                if (selectedUserId === currentUserData.name || selectedUserId === 'VIPè‚¡ä¸œ') {
                    // æ›´æ–°ä¸»ç”¨æˆ·æ•°æ®
                    const userData = JSON.parse(localStorage.getItem('userData_achievements') || '{}');

                    achievementIds.forEach(id => {
                        if (userData.achievements && userData.achievements[id]) {
                            delete userData.achievements[id];
                        }
                    });

                    localStorage.setItem('userData_achievements', JSON.stringify(userData));
                    currentUserData.achievements = userData.achievements;
                }

                updateUserDisplay();
                broadcastUpdate('ACHIEVEMENT_UPDATE', { userId: selectedUserId, achievements: currentUserData.achievements });
                alert('æˆå°±æ’¤é”€æˆåŠŸï¼');
            }

            function renderAchievementsList() {
                // åˆå§‹æ¸²æŸ“ï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©
            }

            function showUserInfo() {
                $('#userInfoSection').classList.remove('hidden');
                $('#achievementGrantSection').classList.remove('hidden');
            }

            function hideUserInfo() {
                $('#userInfoSection').classList.add('hidden');
                $('#achievementGrantSection').classList.add('hidden');
                selectedUserId = null;
                currentUserData = null;
            }

            function updateGlobalStats() {
                const statsContainer = $('#globalAchievementStats');
                const userData = JSON.parse(localStorage.getItem('userData_achievements') || '{}');
                const achievements = userData.achievements || {};

                const totalUsers = 1; // ç®€åŒ–ç»Ÿè®¡ï¼Œä¸»è¦é’ˆå¯¹VIPç”¨æˆ·
                const totalAchievements = ACHIEVEMENTS.length;
                const unlockedAchievements = Object.values(achievements).filter(a => a.unlocked).length;
                const completionRate = totalAchievements > 0 ? Math.round((unlockedAchievements / totalAchievements) * 100) : 0;

                statsContainer.innerHTML = `
                <div class="text-center p-3 bg-blue-50 rounded-lg">
                    <div class="text-lg font-bold text-blue-600">${totalUsers}</div>
                    <div class="text-xs text-blue-700">æ€»ç”¨æˆ·æ•°</div>
                </div>
                <div class="text-center p-3 bg-green-50 rounded-lg">
                    <div class="text-lg font-bold text-green-600">${totalAchievements}</div>
                    <div class="text-xs text-green-700">æ€»æˆå°±æ•°</div>
                </div>
                <div class="text-center p-3 bg-yellow-50 rounded-lg">
                    <div class="text-lg font-bold text-yellow-600">${unlockedAchievements}</div>
                    <div class="text-xs text-yellow-700">å·²è§£é”æˆå°±</div>
                </div>
                <div class="text-center p-3 bg-purple-50 rounded-lg">
                    <div class="text-lg font-bold text-purple-600">${completionRate}%</div>
                    <div class="text-xs text-purple-700">å®Œæˆåº¦</div>
                </div>
            `;
            }

            // â€”â€” éŸ³ä¹æ’­æ”¾å™¨åŠŸèƒ½ â€”â€”
            let musicLibrary = [
                // é»˜è®¤éŸ³ä¹åº“ï¼Œå°†é€šè¿‡APIåŠ¨æ€åŠ è½½
            ];

            // Jamendo APIé…ç½®
            const JAMENDO_CLIENT_ID = '709fa152'; // å®˜æ–¹æµ‹è¯•ID
            const JAMENDO_API_BASE = 'https://api.jamendo.com/v3.0';

            // æ£€æµ‹å¾®ä¿¡ç¯å¢ƒ
            function isWeChatBrowser() {
                return /micromessenger/i.test(navigator.userAgent);
            }

            async function loadMusicFromAPI() {
                // å¾®ä¿¡ç¯å¢ƒç›´æ¥ä½¿ç”¨å¤‡ç”¨éŸ³ä¹åº“
                if (isWeChatBrowser()) {
                    console.log('ğŸµ ç®¡ç†å‘˜ç•Œé¢æ£€æµ‹åˆ°å¾®ä¿¡ç¯å¢ƒï¼Œä½¿ç”¨å†…ç½®éŸ³ä¹åº“');
                    musicLibrary = getBackupMusicLibrary();
                    return true;
                }

                try {
                    // æ·»åŠ è¶…æ—¶æ§åˆ¶
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 8000); // 8ç§’è¶…æ—¶

                    // è·å–æµè¡ŒéŸ³ä¹å’Œç”µå­éŸ³ä¹
                    const [popResponse, electroResponse, rockResponse] = await Promise.all([
                        fetch(`${JAMENDO_API_BASE}/tracks/?client_id=${JAMENDO_CLIENT_ID}&format=json&limit=5&tags=pop&include=musicinfo&audioformat=mp32`, {
                            signal: controller.signal,
                            mode: 'cors'
                        }),
                        fetch(`${JAMENDO_API_BASE}/tracks/?client_id=${JAMENDO_CLIENT_ID}&format=json&limit=3&tags=electronic&include=musicinfo&audioformat=mp32`, {
                            signal: controller.signal,
                            mode: 'cors'
                        }),
                        fetch(`${JAMENDO_API_BASE}/tracks/?client_id=${JAMENDO_CLIENT_ID}&format=json&limit=2&tags=rock&include=musicinfo&audioformat=mp32`, {
                            signal: controller.signal,
                            mode: 'cors'
                        })
                    ]);

                    clearTimeout(timeoutId);

                    if (!popResponse.ok || !electroResponse.ok || !rockResponse.ok) {
                        throw new Error('APIè¯·æ±‚å¤±è´¥');
                    }

                    const popData = await popResponse.json();
                    const electroData = await electroResponse.json();
                    const rockData = await rockResponse.json();

                    // åˆå¹¶æ‰€æœ‰éŸ³ä¹
                    const allTracks = [
                        ...(popData.results || []),
                        ...(electroData.results || []),
                        ...(rockData.results || [])
                    ];

                    if (allTracks.length === 0) {
                        throw new Error('æœªè·å–åˆ°éŸ³ä¹æ•°æ®');
                    }

                    // è½¬æ¢ä¸ºæˆ‘ä»¬çš„éŸ³ä¹åº“æ ¼å¼
                    musicLibrary = allTracks.map(track => ({
                        id: track.id,
                        title: track.name || 'Unknown Title',
                        artist: track.artist_name || 'Unknown Artist',
                        album: track.album_name || 'Unknown Album',
                        url: track.audio || track.audiodownload,
                        duration: formatDuration(track.duration),
                        image: track.album_image || track.image,
                        jamendoUrl: `https://www.jamendo.com/track/${track.id}`
                    }));

                    console.log('ğŸµ ç®¡ç†å‘˜ç•Œé¢å·²åŠ è½½', musicLibrary.length, 'é¦–å…è´¹éŸ³ä¹');
                    return true;
                } catch (error) {
                    console.error('âŒ ç®¡ç†å‘˜ç•Œé¢åŠ è½½éŸ³ä¹å¤±è´¥:', error);
                    // ä½¿ç”¨å¤‡ç”¨éŸ³ä¹åº“
                    musicLibrary = getBackupMusicLibrary();
                    return false;
                }
            }

            // å¤‡ç”¨éŸ³ä¹åº“ï¼ˆå¦‚æœAPIå¤±è´¥ï¼‰
            function getBackupMusicLibrary() {
                return [
                    {
                        title: "Admin Music 1",
                        artist: "System Sound",
                        album: "Background Tracks",
                        url: "",
                        duration: "3:24",
                        image: "",
                        jamendoUrl: "#"
                    },
                    {
                        title: "Admin Music 2",
                        artist: "System Sound",
                        album: "Background Tracks",
                        url: "",
                        duration: "4:12",
                        image: "",
                        jamendoUrl: "#"
                    }
                ];
            }

            // æ—¶é•¿æ ¼å¼åŒ–
            function formatDuration(seconds) {
                if (!seconds) return "0:00";
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            let currentSongIndex = 0;
            let isPlaying = false;
            let currentAudio = null;
            let isPlayerMinimized = true; // é»˜è®¤æœ€å°åŒ–

            async function initMusicPlayer() {
                try {
                    // å…ˆåŠ è½½éŸ³ä¹åº“
                    const loadSuccess = await loadMusicFromAPI();
                    if (loadSuccess) {
                        console.log('ğŸµ ç®¡ç†å‘˜ç•Œé¢æˆåŠŸåŠ è½½JamendoéŸ³ä¹åº“');
                    } else {
                        console.log('ğŸµ ç®¡ç†å‘˜ç•Œé¢ä½¿ç”¨å¤‡ç”¨éŸ³ä¹åº“');
                    }

                    renderPlaylist();
                    if (musicLibrary.length > 0) {
                        loadSong(0);
                    }

                    // ç¡®ä¿DOMå…ƒç´ å­˜åœ¨åå†åˆå§‹åŒ–
                    const content = $('#playerContent');
                    const minimized = $('#playerMinimized');
                    const icon = $('#playerToggleIcon');

                    if (content && minimized && icon) {
                        // åˆå§‹åŒ–ä¸ºæœ€å°åŒ–çŠ¶æ€
                        content.classList.add('hidden');
                        minimized.classList.remove('hidden');
                        icon.textContent = 'ğŸ”¼';
                    } else {
                        console.warn('ğŸµ ç®¡ç†å‘˜éŸ³ä¹æ’­æ”¾å™¨DOMå…ƒç´ æœªæ‰¾åˆ°');
                    }

                    // å®‰å…¨åœ°ç»‘å®šæ’­æ”¾å™¨æ§åˆ¶äº‹ä»¶
                    const togglePlayer = $('#togglePlayer');
                    const playPauseBtn = $('#playPauseBtn');
                    const miniPlayPause = $('#miniPlayPause');
                    const prevBtn = $('#prevBtn');
                    const nextBtn = $('#nextBtn');

                    if (togglePlayer) togglePlayer.addEventListener('click', togglePlayerSize);
                    if (playPauseBtn) playPauseBtn.addEventListener('click', togglePlayPause);
                    if (miniPlayPause) miniPlayPause.addEventListener('click', togglePlayPause);
                    if (prevBtn) prevBtn.addEventListener('click', previousSong);
                    if (nextBtn) nextBtn.addEventListener('click', nextSong);

                    console.log('ğŸµ ç®¡ç†å‘˜éŸ³ä¹æ’­æ”¾å™¨åˆå§‹åŒ–å®Œæˆ');
                } catch (error) {
                    console.error('ğŸµ ç®¡ç†å‘˜éŸ³ä¹æ’­æ”¾å™¨åˆå§‹åŒ–å¤±è´¥:', error);
                }
            }

            function renderPlaylist() {
                const playlist = $('#playlist');
                if (!playlist) return;

                playlist.innerHTML = '';

                if (musicLibrary.length === 0) {
                    playlist.innerHTML = '<div class="text-xs text-slate-500 p-2">ğŸµ æ­£åœ¨åŠ è½½éŸ³ä¹...</div>';
                    return;
                }

                musicLibrary.forEach((song, index) => {
                    const songItem = document.createElement('div');
                    songItem.className = `cursor-pointer p-2 rounded text-xs hover:bg-slate-100 transition-colors ${index === currentSongIndex ? 'bg-[var(--labu)] text-white' : ''}`;
                    songItem.innerHTML = `
                        <div class="font-medium truncate">${song.title}</div>
                        <div class="text-xs opacity-75 truncate">${song.artist}</div>
                        <div class="text-xs opacity-60 truncate">${song.duration || ''}</div>
                    `;
                    songItem.addEventListener('click', () => loadSong(index));
                    playlist.appendChild(songItem);
                });
            }

            // æ—§çš„loadSongå‡½æ•°å·²è¢«ä¸Šé¢çš„çœŸå®éŸ³é¢‘ç‰ˆæœ¬æ›¿ä»£

            function togglePlayerSize() {
                isPlayerMinimized = !isPlayerMinimized;
                const content = $('#playerContent');
                const minimized = $('#playerMinimized');
                const icon = $('#playerToggleIcon');

                if (isPlayerMinimized) {
                    content.classList.add('hidden');
                    minimized.classList.remove('hidden');
                    icon.textContent = 'ğŸ”¼';
                } else {
                    content.classList.remove('hidden');
                    minimized.classList.add('hidden');
                    icon.textContent = 'ğŸ”½';
                }
            }

            // æ—§çš„æ’­æ”¾æ§åˆ¶å‡½æ•°å·²è¢«ä¸Šé¢çš„çœŸå®éŸ³é¢‘ç‰ˆæœ¬æ›¿ä»£

            // çœŸå®éŸ³é¢‘æ’­æ”¾åŠŸèƒ½
            function loadSong(index) {
                if (!musicLibrary || musicLibrary.length === 0) return;

                currentSongIndex = index;
                const song = musicLibrary[index];

                // åœæ­¢å½“å‰æ’­æ”¾
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }

                // æ›´æ–°UI
                const currentSongEl = $('#currentSong');
                const currentArtistEl = $('#currentArtist');
                const miniSongNameEl = $('#miniSongName');
                const totalTimeEl = $('#totalTime');

                if (currentSongEl) currentSongEl.textContent = song.title;
                if (currentArtistEl) currentArtistEl.textContent = song.artist;
                if (miniSongNameEl) miniSongNameEl.textContent = `${song.title} - ${song.artist}`;
                if (totalTimeEl) totalTimeEl.textContent = song.duration || "0:00";

                // åˆ›å»ºæ–°çš„éŸ³é¢‘å¯¹è±¡
                if (song.url && song.url !== '') {
                    currentAudio = new Audio(song.url);
                    currentAudio.crossOrigin = "anonymous";

                    // éŸ³é¢‘åŠ è½½å®Œæˆ
                    currentAudio.addEventListener('loadeddata', () => {
                        console.log('ğŸµ ç®¡ç†å‘˜éŸ³é¢‘å·²åŠ è½½:', song.title);
                        if (totalTimeEl) {
                            totalTimeEl.textContent = formatDuration(currentAudio.duration);
                        }
                    });

                    // æ’­æ”¾æ—¶æ›´æ–°è¿›åº¦
                    currentAudio.addEventListener('timeupdate', updateProgress);

                    // æ’­æ”¾ç»“æŸè‡ªåŠ¨ä¸‹ä¸€é¦–
                    currentAudio.addEventListener('ended', () => {
                        nextSong();
                    });

                    // é”™è¯¯å¤„ç†
                    currentAudio.addEventListener('error', (e) => {
                        console.warn('ğŸµ ç®¡ç†å‘˜éŸ³é¢‘åŠ è½½å¤±è´¥:', song.title, e);
                        nextSong();
                    });
                } else {
                    console.warn('ğŸµ æ— æœ‰æ•ˆéŸ³é¢‘URL:', song.title);
                }

                renderPlaylist();
                isPlaying = false;
                updatePlayButtons();
            }

            function togglePlayPause() {
                if (!currentAudio) {
                    console.warn('ğŸµ æ²¡æœ‰å¯æ’­æ”¾çš„éŸ³é¢‘');
                    return;
                }

                if (isPlaying) {
                    currentAudio.pause();
                    isPlaying = false;
                } else {
                    const playPromise = currentAudio.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            isPlaying = true;
                        }).catch(error => {
                            console.error('ğŸµ æ’­æ”¾å¤±è´¥:', error);
                        });
                    }
                }

                updatePlayButtons();
            }

            function updatePlayButtons() {
                const playBtn = $('#playPauseBtn');
                const miniBtn = $('#miniPlayPause');

                if (playBtn) playBtn.textContent = isPlaying ? 'â¸ï¸' : 'â–¶ï¸';
                if (miniBtn) miniBtn.textContent = isPlaying ? 'â¸ï¸' : 'â–¶ï¸';
            }

            function previousSong() {
                if (musicLibrary.length === 0) return;
                currentSongIndex = (currentSongIndex - 1 + musicLibrary.length) % musicLibrary.length;
                loadSong(currentSongIndex);
                if (isPlaying && currentAudio) {
                    currentAudio.play().catch(console.error);
                }
            }

            function nextSong() {
                if (musicLibrary.length === 0) return;
                currentSongIndex = (currentSongIndex + 1) % musicLibrary.length;
                loadSong(currentSongIndex);
                if (isPlaying && currentAudio) {
                    currentAudio.play().catch(console.error);
                }
            }

            // æ›´æ–°æ’­æ”¾è¿›åº¦
            function updateProgress() {
                if (!currentAudio) return;

                const currentTime = currentAudio.currentTime;
                const duration = currentAudio.duration;

                if (duration) {
                    const progress = (currentTime / duration) * 100;
                    const progressBar = $('#progressBar');
                    const currentTimeEl = $('#currentTime');

                    if (progressBar) progressBar.style.width = progress + '%';
                    if (currentTimeEl) currentTimeEl.textContent = formatDuration(currentTime);
                }
            }

            let progressInterval;
            let currentTime = 0;

            function startProgressSimulation() {
                currentTime = 0;
                progressInterval = setInterval(() => {
                    currentTime += 1;
                    const minutes = Math.floor(currentTime / 60);
                    const seconds = currentTime % 60;
                    $('#currentTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

                    // æ¨¡æ‹Ÿè¿›åº¦æ¡ï¼ˆæ€»é•¿åº¦225ç§’ = 3åˆ†45ç§’ï¼‰
                    const progress = (currentTime / 225) * 100;
                    $('#progressBar').style.width = Math.min(progress, 100) + '%';

                    // æ­Œæ›²ç»“æŸè‡ªåŠ¨ä¸‹ä¸€é¦–
                    if (currentTime >= 225) {
                        nextSong();
                    }
                }, 1000);
            }

            function stopProgressSimulation() {
                if (progressInterval) {
                    clearInterval(progressInterval);
                }
            }

            // æ›´æ–°åˆå§‹åŒ–å‡½æ•°
            const originalAdminInit = init;

            function init() {
                $('#year').textContent = new Date().getFullYear();

                // æ£€æŸ¥ç™»å½•çŠ¶æ€
                if (isLoggedIn()) {
                    showMainContent();
                    // åˆå§‹åŒ–ä¸»ç•Œé¢å†…å®¹
                    refreshPoolEditor();
                    renderPoolList(loadPool());
                    updateHistoryCount();
                    updateDrawLimitDisplay();
                    updateSyncStatus(); // æ›´æ–°åŒæ­¥çŠ¶æ€æ˜¾ç¤º
                    // éŸ³ä¹æ’­æ”¾å™¨åˆå§‹åŒ–ç§»åˆ°ä¸‹é¢çš„ä¸»initå‡½æ•°ä¸­
                } else {
                    showLoginOverlay();
                }
            }

            // â€”â€” è‡ªå®šä¹‰é¼ æ ‡å’Œäº¤äº’æ•ˆæœ â€”â€”
            function initCustomCursor() {
                const cursor = $('.custom-cursor');
                let mouseX = 0, mouseY = 0;

                document.addEventListener('mousemove', (e) => {
                    mouseX = e.clientX;
                    mouseY = e.clientY;
                    cursor.style.left = mouseX + 'px';
                    cursor.style.top = mouseY + 'px';

                    createCursorTrail(mouseX, mouseY);
                });

                document.addEventListener('mousedown', () => {
                    cursor.classList.add('clicking');
                });

                document.addEventListener('mouseup', () => {
                    cursor.classList.remove('clicking');
                });
            }

            function createCursorTrail(x, y) {
                const trail = document.createElement('div');
                trail.className = 'cursor-trail';
                trail.style.left = (x - 4) + 'px';
                trail.style.top = (y - 4) + 'px';
                document.body.appendChild(trail);

                setTimeout(() => {
                    if (document.body.contains(trail)) {
                        document.body.removeChild(trail);
                    }
                }, 500);
            }

            function initButtonEffects() {
                document.querySelectorAll('.enhanced-btn').forEach(button => {
                    button.addEventListener('click', createRipple);
                });
            }

            function createRipple(event) {
                const button = event.currentTarget;
                const rect = button.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = event.clientX - rect.left - size / 2;
                const y = event.clientY - rect.top - size / 2;

                const ripple = document.createElement('div');
                ripple.className = 'btn-ripple';
                ripple.style.width = ripple.style.height = size + 'px';
                ripple.style.left = x + 'px';
                ripple.style.top = y + 'px';

                button.appendChild(ripple);

                setTimeout(() => {
                    if (button.contains(ripple)) {
                        button.removeChild(ripple);
                    }
                }, 600);
            }

            // æ›´æ–°adminåˆå§‹åŒ–å‡½æ•°
            const originalAdminInit2 = init;

            function init() {
                $('#year').textContent = new Date().getFullYear();

                // æ£€æŸ¥ç™»å½•çŠ¶æ€
                if (isLoggedIn()) {
                    showMainContent();
                    // åˆå§‹åŒ–ä¸»ç•Œé¢å†…å®¹
                    refreshPoolEditor();
                    renderPoolList(loadPool());
                    updateHistoryCount();
                    updateDrawLimitDisplay();
                    updateSyncStatus(); // æ›´æ–°åŒæ­¥çŠ¶æ€æ˜¾ç¤º
                    initMusicPlayer(); // åˆå§‹åŒ–éŸ³ä¹æ’­æ”¾å™¨

                    // åˆå§‹åŒ–äº¤äº’æ•ˆæœ
                    setTimeout(() => {
                        initCustomCursor();
                        initButtonEffects();
                    }, 100);
                } else {
                    showLoginOverlay();
                    // ä¸ºç™»å½•ç•Œé¢ä¹Ÿåˆå§‹åŒ–äº¤äº’æ•ˆæœ
                    setTimeout(() => {
                        initCustomCursor();
                        initButtonEffects();
                    }, 100);
                }
            }

            bind();
            init();
        } // å…³é—­æ¡æ¬¾æ£€æŸ¥çš„elseå—
    </script>
</body>

</html>