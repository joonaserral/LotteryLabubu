<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>奖池管理 - Labubu 幸运抽奖</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --labu: #6b5b95;
            --labu2: #ffcc00;
        }

        body {
            font-family: 'Zen Maru Gothic', system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans SC', 'PingFang SC', 'Microsoft Yahei', sans-serif;
        }

        .labu-gradient {
            background-image: linear-gradient(135deg, rgba(107, 91, 149, .12), rgba(255, 204, 0, .12));
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900">
    <!-- 顶部栏 -->
    <header class="sticky top-0 z-10 backdrop-blur bg-white/60 border-b border-slate-200">
        <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-xl bg-[var(--labu)] grid place-content-center text-white text-xl">🦊</div>
                <h1 class="font-bold text-lg">奖池管理系统</h1>
            </div>
            <nav class="text-sm flex items-center gap-3">
                <a href="index.html" class="hover:underline">返回抽奖</a>
            </nav>
        </div>
    </header>

    <!-- Hero -->
    <section class="labu-gradient">
        <div class="max-w-5xl mx-auto px-4 py-10">
            <div class="text-center">
                <h2 class="text-3xl md:text-4xl font-extrabold leading-tight">奖池配置管理</h2>
                <p class="mt-3 text-slate-700">管理员专用界面，用于配置和管理抽奖奖池设置</p>
            </div>
        </div>
    </section>

    <!-- 主要内容 -->
    <main class="max-w-5xl mx-auto px-4 py-10">
        <div class="grid lg:grid-cols-2 gap-8">
            <!-- 奖池设置 -->
            <section>
                <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
                    <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                        <h3 class="font-semibold">奖池配置编辑</h3>
                        <div class="text-xs text-slate-500">配置将保存到本地浏览器</div>
                    </div>
                    <div class="p-5 grid gap-4">
                        <div class="text-sm text-slate-600">
                            <div class="mb-2">每行一个奖品，字段使用逗号分隔：<code>name,type,weight,quantity</code></div>
                            <ul class="text-xs space-y-1 text-slate-500">
                                <li>• <b>name</b>: 奖品名称</li>
                                <li>• <b>type</b>: 奖品类型，仅支持：<b>抵扣券</b>｜<b>实体</b>｜<b>折扣券</b></li>
                                <li>• <b>weight</b>: 权重数值，数值越大越容易抽中</li>
                                <li>• <b>quantity</b>: 库存数量，留空或 -1 表示不限量</li>
                            </ul>
                        </div>
                        <textarea id="poolEditor" rows="12"
                            class="w-full rounded-xl border border-slate-300 p-3 font-mono text-xs"></textarea>
                        <div class="flex gap-3 flex-wrap">
                            <button id="savePoolBtn"
                                class="px-4 py-2 rounded-xl bg-[var(--labu)] text-white font-medium hover:opacity-90">保存奖池</button>
                            <button id="reloadBtn"
                                class="px-4 py-2 rounded-xl bg-slate-100 border border-slate-200 hover:bg-slate-200">重新载入</button>
                            <button id="restoreDefaultBtn"
                                class="px-4 py-2 rounded-xl bg-orange-100 text-orange-700 border border-orange-200 hover:bg-orange-200">恢复默认</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 当前奖池预览 -->
            <section>
                <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
                    <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                        <h3 class="font-semibold">当前奖池预览</h3>
                        <button id="refreshPreviewBtn"
                            class="text-xs px-2 py-1 rounded-lg bg-slate-100 border border-slate-200">刷新预览</button>
                    </div>
                    <div class="p-5">
                        <ul id="poolList" class="text-sm grid gap-2"></ul>
                        <div id="poolStats" class="mt-4 p-3 rounded-lg bg-slate-50 text-xs text-slate-600"></div>
                    </div>
                </div>
            </section>
        </div>

        <!-- 数据管理 -->
        <section class="mt-10">
            <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
                <div class="p-5 border-b border-slate-100">
                    <h3 class="font-semibold">数据管理</h3>
                </div>
                <div class="p-5 grid md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-medium mb-3">抽奖记录管理</h4>
                        <div class="flex gap-3 flex-wrap">
                            <button id="exportHistoryBtn"
                                class="px-4 py-2 rounded-xl bg-green-100 text-green-700 border border-green-200 hover:bg-green-200">导出抽奖记录</button>
                            <button id="clearHistoryBtn"
                                class="px-4 py-2 rounded-xl bg-red-100 text-red-700 border border-red-200 hover:bg-red-200">清空抽奖记录</button>
                        </div>
                        <div class="mt-2 text-xs text-slate-500">当前记录数：<span id="historyCount">0</span></div>
                    </div>
                    <div>
                        <h4 class="font-medium mb-3">系统重置</h4>
                        <div class="flex gap-3 flex-wrap">
                            <button id="resetAllBtn"
                                class="px-4 py-2 rounded-xl bg-red-100 text-red-700 border border-red-200 hover:bg-red-200">完全重置</button>
                        </div>
                        <div class="mt-2 text-xs text-slate-500">将清空所有数据并恢复默认奖池</div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="max-w-5xl mx-auto px-4 py-10 text-center text-xs text-slate-500">
        <div>© <span id="year"></span> Labubu 抽奖管理系统</div>
    </footer>

    <script>
        // —— 本地存储键 ——
        const LS_KEYS = {
            HISTORY: 'labubu_lottery_history',
            POOL: 'labubu_lottery_pool'
        };

        // —— 默认奖池（可编辑）——
        const DEFAULT_POOL = [
            { name: '¥20 抵扣券', type: '抵扣券', weight: 25, quantity: -1 },
            { name: '¥50 抵扣券', type: '抵扣券', weight: 15, quantity: -1 },
            { name: '9折优惠券', type: '折扣券', weight: 18, quantity: -1 },
            { name: '95折优惠券', type: '折扣券', weight: 22, quantity: -1 },
            { name: 'Labubu 限量手办（实体）', type: '实体', weight: 3, quantity: 5 },
            { name: 'Labubu 主题贴纸包（实体）', type: '实体', weight: 7, quantity: 50 },
            { name: '再接再厉', type: '折扣券', weight: 10, quantity: -1, note: '未中奖提示，可自定义' }
        ];

        // —— 工具函数 ——
        const $ = (sel) => document.querySelector(sel);

        function loadHistory() {
            try { return JSON.parse(localStorage.getItem(LS_KEYS.HISTORY)) || []; } catch { return []; }
        }
        function saveHistory(arr) { localStorage.setItem(LS_KEYS.HISTORY, JSON.stringify(arr)); }
        function loadPool() {
            try {
                const raw = localStorage.getItem(LS_KEYS.POOL);
                return raw ? JSON.parse(raw) : structuredClone(DEFAULT_POOL);
            } catch { return structuredClone(DEFAULT_POOL); }
        }
        function savePool(pool) { localStorage.setItem(LS_KEYS.POOL, JSON.stringify(pool)); }

        function poolToText(pool) {
            return pool.map(p => [p.name, p.type, p.weight, (p.quantity ?? -1)].join(',')).join('\n');
        }
        function textToPool(txt) {
            return txt.split(/\n+/).map(l => l.trim()).filter(Boolean).map((line, i) => {
                const [name, type, weightStr, qtyStr] = line.split(',').map(s => s?.trim());
                const weight = Number(weightStr);
                const quantity = (qtyStr === undefined || qtyStr === '') ? -1 : Number(qtyStr);
                if (!name || !['抵扣券', '实体', '折扣券'].includes(type) || !Number.isFinite(weight)) {
                    throw new Error(`第 ${i + 1} 行格式不正确：${line}`);
                }
                return { name, type, weight, quantity };
            });
        }

        function renderPoolList(pool) {
            const ul = $('#poolList');
            ul.innerHTML = '';
            const totalW = pool.reduce((s, p) => s + Math.max(0, p.weight || 0), 0) || 1;

            pool.forEach(p => {
                const left = p.quantity === -1 ? '∞' : p.quantity;
                const w = p.weight || 0;
                const pct = ((w / totalW) * 100).toFixed(1);
                const color = p.type === '实体' ? 'bg-emerald-50 text-emerald-700 border-emerald-200' :
                    (p.type === '抵扣券' ? 'bg-indigo-50 text-indigo-700 border-indigo-200' : 'bg-amber-50 text-amber-700 border-amber-200');

                const li = document.createElement('li');
                li.className = `border rounded-xl p-3 ${color}`;
                li.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="font-medium">${p.name}</div>
                        <span class="text-xs px-2 py-0.5 rounded-lg bg-white/60 border">${p.type}</span>
                    </div>
                    <div class="text-xs mt-1 flex justify-between">
                        <span>权重: ${w} (≈${pct}%)</span>
                        <span>剩余: <b>${left}</b></span>
                    </div>
                `;
                ul.appendChild(li);
            });

            // 更新统计信息
            const stats = $('#poolStats');
            const totalItems = pool.length;
            const totalWeight = totalW;
            const physicalItems = pool.filter(p => p.type === '实体').length;
            stats.innerHTML = `总计 ${totalItems} 种奖品 | 总权重: ${totalWeight} | 实体奖品: ${physicalItems} 种`;
        }

        function refreshPoolEditor() {
            const pool = loadPool();
            $('#poolEditor').value = poolToText(pool);
        }

        function exportHistory() {
            const history = loadHistory();
            const data = JSON.stringify(history, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `labubu_lottery_history_${Date.now()}.json`;
            a.click();
        }

        function clearHistory() {
            if (confirm('确认清空所有抽奖记录？此操作不可恢复！')) {
                saveHistory([]);
                updateHistoryCount();
                alert('抽奖记录已清空');
            }
        }

        function resetAll() {
            if (confirm('确认完全重置系统？这将清空所有数据并恢复默认奖池！')) {
                localStorage.removeItem(LS_KEYS.HISTORY);
                localStorage.removeItem(LS_KEYS.POOL);
                refreshPoolEditor();
                renderPoolList(loadPool());
                updateHistoryCount();
                alert('系统已重置到默认状态');
            }
        }

        function updateHistoryCount() {
            const count = loadHistory().length;
            $('#historyCount').textContent = count;
        }

        // —— 事件绑定 ——
        function bind() {
            $('#savePoolBtn').addEventListener('click', () => {
                try {
                    const text = $('#poolEditor').value;
                    const pool = textToPool(text);
                    savePool(pool);
                    renderPoolList(pool);
                    alert('奖池配置已保存到本地');
                } catch (e) {
                    alert('保存失败：' + e.message);
                }
            });

            $('#reloadBtn').addEventListener('click', () => {
                refreshPoolEditor();
                renderPoolList(loadPool());
                alert('已重新载入当前配置');
            });

            $('#restoreDefaultBtn').addEventListener('click', () => {
                if (confirm('确认恢复默认奖池配置？当前配置将被覆盖！')) {
                    savePool(structuredClone(DEFAULT_POOL));
                    refreshPoolEditor();
                    renderPoolList(loadPool());
                    alert('已恢复默认奖池配置');
                }
            });

            $('#refreshPreviewBtn').addEventListener('click', () => {
                renderPoolList(loadPool());
            });

            $('#exportHistoryBtn').addEventListener('click', exportHistory);
            $('#clearHistoryBtn').addEventListener('click', clearHistory);
            $('#resetAllBtn').addEventListener('click', resetAll);
        }

        function init() {
            $('#year').textContent = new Date().getFullYear();
            refreshPoolEditor();
            renderPoolList(loadPool());
            updateHistoryCount();
        }

        bind();
        init();
    </script>
</body>

</html>