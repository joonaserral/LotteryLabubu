<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>奖池管理 - Labubu 幸运抽奖 🧸</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🧸</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- VIP安全验证 -->
    <script src="auth.js"></script>
    <script src="config.enc.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --labu: #6b5b95;
            --labu2: #ffcc00;
        }

        body {
            font-family: 'Zen Maru Gothic', system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans SC', 'PingFang SC', 'Microsoft Yahei', sans-serif;
        }

        .labu-gradient {
            background-image: linear-gradient(135deg, rgba(107, 91, 149, .12), rgba(255, 204, 0, .12));
        }

        /* 自定义鼠标样式和交互效果 */
        * {
            cursor: none !important;
        }

        .custom-cursor {
            position: fixed;
            width: 20px;
            height: 20px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ff69b4"><path d="M8 2C8 2 8.5 3 10.5 3C12.5 3 13 2 13 2C14 2 15 3 15 4C15 5 14 6 13 6C12 6 11 7 11 8C11 9 12 10 13 10C14 10 15 9 15 8C15 7 16 6 17 6C18 6 19 7 19 8C19 9 18 10 17 10C16 10 15 11 15 12C15 13 16 14 17 14C18 14 19 13 19 12C19 11 20 10 21 10C22 10 23 11 23 12C23 13 22 14 21 14C20 14 19 15 19 16C19 17 18 18 17 18C16 18 15 17 15 16C15 15 14 14 13 14C12 14 11 15 11 16C11 17 10 18 9 18C8 18 7 17 7 16C7 15 8 14 9 14C10 14 11 13 11 12C11 11 10 10 9 10C8 10 7 11 7 12C7 13 6 14 5 14C4 14 3 13 3 12C3 11 4 10 5 10C6 10 7 9 7 8C7 7 6 6 5 6C4 6 3 7 3 8C3 9 2 10 1 10C0 10 -1 9 -1 8C-1 7 0 6 1 6C2 6 3 5 3 4C3 3 4 2 5 2C6 2 7 3 7 4C7 5 8 6 9 6C10 6 11 5 11 4C11 3 10 2 9 2C8.5 2 8 2 8 2Z"/></svg>') no-repeat center;
            background-size: contain;
            pointer-events: none;
            z-index: 9999;
            transition: transform 0.1s ease;
            transform: translate(-50%, -50%);
        }

        .custom-cursor.clicking {
            transform: translate(-50%, -50%) scale(1.2);
        }

        .cursor-trail {
            position: fixed;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, rgba(255, 105, 180, 0.8) 0%, rgba(255, 105, 180, 0) 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9998;
            animation: cursorTrailFade 0.5s ease-out forwards;
        }

        @keyframes cursorTrailFade {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            100% {
                opacity: 0;
                transform: scale(0.3);
            }
        }

        .enhanced-btn {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .enhanced-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .enhanced-btn:hover::before {
            left: 100%;
        }

        .enhanced-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(107, 91, 149, 0.3);
        }

        .enhanced-btn:active {
            transform: translateY(0);
        }

        .btn-ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            transform: scale(0);
            animation: rippleEffect 0.6s linear;
            pointer-events: none;
        }

        @keyframes rippleEffect {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900">
    <!-- 自定义鼠标光标 -->
    <div class="custom-cursor"></div>

    <!-- 登录界面 -->
    <div id="loginOverlay" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="bg-white rounded-3xl shadow-2xl p-8 mx-4 w-full max-w-md">
            <div class="text-center mb-6">
                <div
                    class="w-16 h-16 rounded-2xl bg-[var(--labu)] grid place-content-center text-white text-2xl mx-auto mb-4">
                    🔒</div>
                <h2 class="text-2xl font-bold text-slate-900">管理员验证</h2>
                <p class="text-slate-600 mt-2">请输入管理员密码以访问系统</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="adminPassword" class="block text-sm font-medium text-slate-700 mb-2">管理员密码</label>
                    <input type="password" id="adminPassword"
                        class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:border-[var(--labu)] focus:ring-2 focus:ring-[var(--labu)]/20 focus:outline-none transition-colors"
                        placeholder="请输入密码">
                </div>
                <button id="loginBtn"
                    class="enhanced-btn w-full px-4 py-3 rounded-xl bg-[var(--labu)] text-white font-medium transition-opacity">
                    进入管理系统
                </button>
                <div class="text-center">
                    <a href="index.html" class="text-sm text-slate-500 hover:text-slate-700">返回抽奖页面</a>
                </div>
            </div>
            <div id="loginError" class="mt-4 text-sm text-red-600 text-center hidden"></div>
        </div>
    </div>

    <!-- 主界面内容 -->
    <div id="mainContent" class="hidden">
        <!-- 顶部栏 -->
        <header class="sticky top-0 z-10 backdrop-blur bg-white/60 border-b border-slate-200">
            <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-xl bg-[var(--labu)] grid place-content-center text-white text-xl">🦊
                    </div>
                    <h1 class="font-bold text-lg">奖池管理系统</h1>
                </div>
                <nav class="text-sm flex items-center gap-3">
                    <a href="index.html" class="hover:underline">返回抽奖</a>
                    <button id="logoutBtn" class="text-red-600 hover:underline">登出</button>
                </nav>
            </div>
        </header>

        <!-- Hero -->
        <section class="labu-gradient">
            <div class="max-w-5xl mx-auto px-4 py-10">
                <div class="text-center">
                    <h2 class="text-3xl md:text-4xl font-extrabold leading-tight">奖池配置管理</h2>
                    <p class="mt-3 text-slate-700">管理员专用界面，用于配置和管理抽奖奖池设置</p>
                </div>
            </div>
        </section>

        <!-- 主要内容 -->
        <main class="max-w-5xl mx-auto px-4 py-10">
            <div class="grid lg:grid-cols-2 gap-8">
                <!-- 奖池设置 -->
                <section>
                    <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
                        <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                            <h3 class="font-semibold">奖池配置编辑</h3>
                            <div class="text-xs text-slate-500">配置将保存到本地浏览器</div>
                        </div>
                        <div class="p-5 grid gap-4">
                            <div class="text-sm text-slate-600">
                                <div class="mb-2">每行一个奖品，字段使用逗号分隔：<code>name,type,weight,quantity</code></div>
                                <ul class="text-xs space-y-1 text-slate-500">
                                    <li>• <b>name</b>: 奖品名称</li>
                                    <li>• <b>type</b>: 奖品类型，仅支持：<b>抵扣券</b>｜<b>实体</b>｜<b>折扣券</b></li>
                                    <li>• <b>weight</b>: 权重数值，数值越大越容易抽中</li>
                                    <li>• <b>quantity</b>: 库存数量，留空或 -1 表示不限量</li>
                                </ul>
                            </div>
                            <textarea id="poolEditor" rows="12"
                                class="w-full rounded-xl border border-slate-300 p-3 font-mono text-xs"></textarea>
                            <div class="flex gap-3 flex-wrap">
                                <button id="savePoolBtn"
                                    class="px-4 py-2 rounded-xl bg-[var(--labu)] text-white font-medium hover:opacity-90">保存奖池</button>
                                <button id="reloadBtn"
                                    class="px-4 py-2 rounded-xl bg-slate-100 border border-slate-200 hover:bg-slate-200">重新载入</button>
                                <button id="restoreDefaultBtn"
                                    class="px-4 py-2 rounded-xl bg-orange-100 text-orange-700 border border-orange-200 hover:bg-orange-200">恢复默认</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 当前奖池预览 -->
                <section>
                    <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
                        <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                            <h3 class="font-semibold">当前奖池预览</h3>
                            <button id="refreshPreviewBtn"
                                class="text-xs px-2 py-1 rounded-lg bg-slate-100 border border-slate-200">刷新预览</button>
                        </div>
                        <div class="p-5">
                            <ul id="poolList" class="text-sm grid gap-2"></ul>
                            <div id="poolStats" class="mt-4 p-3 rounded-lg bg-slate-50 text-xs text-slate-600"></div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- 抽奖控制 -->
            <section class="mt-10">
                <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
                    <div class="p-5 border-b border-slate-100">
                        <h3 class="font-semibold">抽奖控制设置</h3>
                    </div>
                    <div class="p-5 grid md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-medium mb-3">抽奖次数限制</h4>
                            <div class="space-y-3">
                                <div>
                                    <label for="drawLimitInput"
                                        class="block text-sm font-medium text-slate-700 mb-1">每用户最大抽奖次数</label>
                                    <input type="number" id="drawLimitInput" min="1" max="9999"
                                        class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:border-[var(--labu)] focus:ring-2 focus:ring-[var(--labu)]/20 focus:outline-none"
                                        placeholder="输入次数限制（0表示不限制）">
                                </div>
                                <div class="flex gap-3">
                                    <button id="saveDrawLimitBtn"
                                        class="px-4 py-2 rounded-xl bg-[var(--labu)] text-white font-medium hover:opacity-90">保存设置</button>
                                    <button id="disableDrawLimitBtn"
                                        class="px-4 py-2 rounded-xl bg-slate-100 border border-slate-200 hover:bg-slate-200">取消限制</button>
                                </div>
                                <div class="text-xs text-slate-500">
                                    当前限制：<span id="currentDrawLimit">未设置</span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-medium mb-3">用户抽奖统计</h4>
                            <div class="space-y-3">
                                <div class="p-3 rounded-lg bg-slate-50 text-sm">
                                    <div class="flex justify-between">
                                        <span>当前用户已抽奖：</span>
                                        <span class="font-medium" id="userDrawCount">0 次</span>
                                    </div>
                                </div>
                                <div class="p-3 rounded-lg bg-green-50 text-sm">
                                    <div class="flex justify-between">
                                        <span>🟢 实时同步状态：</span>
                                        <span class="font-medium text-green-600" id="syncStatus">已连接</span>
                                    </div>
                                    <div class="text-xs text-slate-500 mt-1">管理员修改将实时推送到所有用户</div>
                                </div>
                                <button id="resetUserDrawCountBtn"
                                    class="w-full px-4 py-2 rounded-xl bg-orange-100 text-orange-700 border border-orange-200 hover:bg-orange-200">重置用户抽奖次数</button>
                                <div class="text-xs text-slate-500">重置后用户可以重新开始抽奖</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 数据管理 -->
            <section class="mt-10">
                <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
                    <div class="p-5 border-b border-slate-100">
                        <h3 class="font-semibold">数据管理</h3>
                    </div>
                    <div class="p-5 grid md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-medium mb-3">抽奖记录管理</h4>
                            <div class="flex gap-3 flex-wrap">
                                <button id="exportHistoryBtn"
                                    class="px-4 py-2 rounded-xl bg-green-100 text-green-700 border border-green-200 hover:bg-green-200">导出抽奖记录</button>
                                <button id="clearHistoryBtn"
                                    class="px-4 py-2 rounded-xl bg-red-100 text-red-700 border border-red-200 hover:bg-red-200">清空抽奖记录</button>
                            </div>
                            <div class="mt-2 text-xs text-slate-500">当前记录数：<span id="historyCount">0</span></div>
                        </div>
                        <div>
                            <h4 class="font-medium mb-3">系统重置</h4>
                            <div class="flex gap-3 flex-wrap">
                                <button id="resetAllBtn"
                                    class="px-4 py-2 rounded-xl bg-red-100 text-red-700 border border-red-200 hover:bg-red-200">完全重置</button>
                            </div>
                            <div class="mt-2 text-xs text-slate-500">将清空所有数据并恢复默认奖池</div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="max-w-5xl mx-auto px-4 py-10 text-center text-xs text-slate-500">
            <div>© <span id="year"></span> Labubu 抽奖管理系统</div>
        </footer>
    </div> <!-- 主界面内容结束 -->

    <!-- 音乐播放器浮窗 -->
    <div id="musicPlayer"
        class="fixed bottom-4 right-4 z-40 music-player rounded-2xl shadow-lg border border-slate-200 p-4 w-80"
        style="backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.9);">
        <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
                <span class="text-lg">🎵</span>
                <span class="font-medium text-sm">音乐播放器</span>
            </div>
            <button id="togglePlayer" class="text-slate-400 hover:text-slate-600">
                <span id="playerToggleIcon">🔽</span>
            </button>
        </div>

        <div id="playerContent" class="space-y-3">
            <!-- 当前播放信息 -->
            <div class="text-center">
                <div id="currentSong" class="font-medium text-sm text-slate-800">Ready to Play</div>
                <div id="currentArtist" class="text-xs text-slate-500">选择一首歌开始播放</div>
            </div>

            <!-- 进度条 -->
            <div class="space-y-2">
                <div class="flex justify-between text-xs text-slate-500">
                    <span id="currentTime">0:00</span>
                    <span id="totalTime">0:00</span>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-1">
                    <div id="progressBar" class="h-1 rounded-full w-0 transition-all"
                        style="background: linear-gradient(90deg, var(--labu) 0%, var(--labu2) 100%);"></div>
                </div>
            </div>

            <!-- 控制按钮 -->
            <div class="flex items-center justify-center gap-4">
                <button id="prevBtn" class="text-xl hover:scale-110 transition-transform">⏮️</button>
                <button id="playPauseBtn" class="text-2xl hover:scale-110 transition-transform">▶️</button>
                <button id="nextBtn" class="text-xl hover:scale-110 transition-transform">⏭️</button>
            </div>

            <!-- 音量控制 -->
            <div class="flex items-center gap-2">
                <span class="text-sm">🔊</span>
                <input type="range" id="volumeSlider" min="0" max="100" value="50"
                    class="flex-1 h-1 rounded-lg appearance-none">
            </div>

            <!-- 播放列表 -->
            <div class="max-h-32 overflow-y-auto space-y-1">
                <div class="text-xs text-slate-500 mb-2">播放列表</div>
                <div id="playlist" class="space-y-1"></div>
            </div>
        </div>

        <!-- 最小化状态 -->
        <div id="playerMinimized" class="hidden">
            <div class="flex items-center gap-2">
                <button id="miniPlayPause" class="text-lg">▶️</button>
                <div class="flex-1 text-sm truncate">
                    <div id="miniSongName" class="font-medium">未播放</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // —— 安全检查 ——
        if (!window._secureConfig || !window._secureConfig.validate()) {
            window.location.href = 'https://www.labubu.com';
        }

        // —— 加密配置常量 ——
        const _0x7c3f = window._secureConfig.decode(window._secureConfig._0x1a2b);
        const _0x8d4e = 'labubu_vip_admin_' + btoa('secure_session');

        const ADMIN_PASSWORD = _0x7c3f;
        const SESSION_KEY = _0x8d4e;

        // —— 本地存储键 ——
        const LS_KEYS = {
            HISTORY: 'labubu_lottery_history',
            POOL: 'labubu_lottery_pool',
            DRAW_LIMIT: 'labubu_draw_limit',
            USER_DRAW_COUNT: 'labubu_user_draw_count'
        };

        // —— 数据同步广播 ——
        let dataChannel = null;
        let syncEnabled = false;

        // 检查浏览器兼容性
        if ('BroadcastChannel' in window) {
            try {
                dataChannel = new BroadcastChannel('labubu_data_sync');
                syncEnabled = true;
            } catch (error) {
                console.warn('BroadcastChannel初始化失败:', error);
                syncEnabled = false;
            }
        } else {
            console.warn('浏览器不支持BroadcastChannel，实时同步功能将不可用');
            syncEnabled = false;
        }

        function broadcastUpdate(type, data = null) {
            if (!syncEnabled || !dataChannel) {
                console.warn('数据同步不可用，跳过广播:', type);
                return;
            }

            try {
                const message = {
                    type: type,
                    data: data,
                    timestamp: Date.now(),
                    source: 'admin'
                };
                dataChannel.postMessage(message);
                console.log('📡 广播更新:', type);
                showBroadcastNotification(type);
            } catch (error) {
                console.error('广播失败:', error);
                showBroadcastNotification('SYNC_ERROR');
            }
        }

        function showBroadcastNotification(type) {
            const typeNames = {
                'POOL_UPDATE': '奖池配置',
                'DRAW_LIMIT_UPDATE': '抽奖限制',
                'USER_COUNT_RESET': '用户计数重置',
                'SYSTEM_RESET': '系统重置',
                'HISTORY_CLEARED': '记录清空',
                'SYNC_ERROR': '同步失败'
            };

            const notification = document.createElement('div');
            const isError = type === 'SYNC_ERROR';
            const bgColor = isError ? 'bg-red-500' : 'bg-green-500';
            const icon = isError ? '❌' : '📡';
            const message = isError ? '同步失败，请检查网络连接' : `${typeNames[type] || type} 已推送到所有用户`;

            notification.className = `fixed top-20 right-4 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm transition-all duration-300`;
            notification.innerHTML = `${icon} ${message}`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, isError ? 5000 : 2000); // 错误消息显示更长时间
        }

        function updateSyncStatus() {
            const statusElement = $('#syncStatus');
            if (statusElement) {
                if (syncEnabled) {
                    statusElement.textContent = '已连接';
                    statusElement.className = 'font-medium text-green-600';
                } else {
                    statusElement.textContent = '不可用';
                    statusElement.className = 'font-medium text-red-600';
                }
            }
        }

        // —— VIP专享奖池 (含超稀有上迪挂件) ——
        const DEFAULT_POOL = [
            // 普通奖品
            { name: "再接再厉", type: '折扣券', weight: 30, quantity: 50, rarity: 'common', points: 10 },
            { name: "奶茶一杯", type: '实体', weight: 25, quantity: 30, rarity: 'common', points: 20 },
            { name: "烤肉券（清真记录）", type: '实体', weight: 20, quantity: 25, rarity: 'common', points: 30 },
            { name: "烤肉券", type: '实体', weight: 20, quantity: 20, rarity: 'common', points: 30 },
            { name: "精品奶茶券", type: '实体', weight: 15, quantity: 15, rarity: 'rare', points: 50 },
            { name: "1U币", type: '实体', weight: 25, quantity: 100, rarity: 'common', points: 1 },
            { name: "3U币", type: '实体', weight: 15, quantity: 60, rarity: 'common', points: 3 },
            { name: "5U币", type: '实体', weight: 10, quantity: 40, rarity: 'rare', points: 5 },

            // 普通Labubu收藏
            { name: "经典Labubu公仔", type: '实体', weight: 8, quantity: 10, rarity: 'rare', points: 100 },
            { name: "彩虹Labubu限定", type: '实体', weight: 6, quantity: 8, rarity: 'epic', points: 150 },
            { name: "圣诞Labubu特别版", type: '实体', weight: 4, quantity: 5, rarity: 'epic', points: 200 },
            { name: "黄金Labubu收藏版", type: '实体', weight: 2, quantity: 3, rarity: 'legendary', points: 500 },

            // 超稀有上迪挂件 - 中奖率极低 (几乎为0)
            { name: "24上迪万圣节饼饼挂件", type: '实体', weight: 0.1, quantity: 1, rarity: 'mythic', points: 2000 },
            { name: "24上迪万圣节露露挂件", type: '实体', weight: 0.1, quantity: 1, rarity: 'mythic', points: 2000 },
            { name: "25上迪夏日海洋饼饼挂件", type: '实体', weight: 0.05, quantity: 1, rarity: 'mythic', points: 3000 }
        ];

        // —— 工具函数 ——
        const $ = (sel) => document.querySelector(sel);

        function loadHistory() {
            try { return JSON.parse(localStorage.getItem(LS_KEYS.HISTORY)) || []; } catch { return []; }
        }
        function saveHistory(arr) { localStorage.setItem(LS_KEYS.HISTORY, JSON.stringify(arr)); }
        function loadPool() {
            try {
                const raw = localStorage.getItem(LS_KEYS.POOL);
                return raw ? JSON.parse(raw) : structuredClone(DEFAULT_POOL);
            } catch { return structuredClone(DEFAULT_POOL); }
        }
        function savePool(pool) { localStorage.setItem(LS_KEYS.POOL, JSON.stringify(pool)); }

        function poolToText(pool) {
            return pool.map(p => [p.name, p.type, p.weight, (p.quantity ?? -1)].join(',')).join('\n');
        }
        function textToPool(txt) {
            const lines = txt.split(/\n+/).map(l => l.trim()).filter(Boolean);

            if (lines.length === 0) {
                throw new Error('奖池不能为空');
            }

            if (lines.length > 100) {
                throw new Error('奖池项目不能超过100个');
            }

            return lines.map((line, i) => {
                const parts = line.split(',').map(s => s?.trim());

                if (parts.length < 3 || parts.length > 4) {
                    throw new Error(`第 ${i + 1} 行格式不正确：应为 name,type,weight[,quantity]`);
                }

                const [name, type, weightStr, qtyStr] = parts;

                // 名称验证
                if (!name || name.length > 50) {
                    throw new Error(`第 ${i + 1} 行：奖品名称不能为空且不能超过50字符`);
                }

                // 类型验证
                if (!['抵扣券', '实体', '折扣券'].includes(type)) {
                    throw new Error(`第 ${i + 1} 行：奖品类型只能是 抵扣券/实体/折扣券`);
                }

                // 权重验证
                const weight = Number(weightStr);
                if (!Number.isFinite(weight) || weight < 0 || weight > 10000) {
                    throw new Error(`第 ${i + 1} 行：权重必须是0-10000之间的数字`);
                }

                // 数量验证
                let quantity = -1;
                if (qtyStr !== undefined && qtyStr !== '') {
                    quantity = Number(qtyStr);
                    if (!Number.isInteger(quantity) || quantity < -1 || quantity > 99999) {
                        throw new Error(`第 ${i + 1} 行：数量必须是-1到99999之间的整数`);
                    }
                }

                return { name, type, weight, quantity };
            });
        }

        function renderPoolList(pool) {
            const ul = $('#poolList');
            ul.innerHTML = '';
            const totalW = pool.reduce((s, p) => s + Math.max(0, p.weight || 0), 0) || 1;

            pool.forEach(p => {
                const left = p.quantity === -1 ? '∞' : p.quantity;
                const w = p.weight || 0;
                const pct = ((w / totalW) * 100).toFixed(1);
                const color = p.type === '实体' ? 'bg-emerald-50 text-emerald-700 border-emerald-200' :
                    (p.type === '抵扣券' ? 'bg-indigo-50 text-indigo-700 border-indigo-200' : 'bg-amber-50 text-amber-700 border-amber-200');

                const li = document.createElement('li');
                li.className = `border rounded-xl p-3 ${color}`;
                li.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="font-medium">${p.name}</div>
                        <span class="text-xs px-2 py-0.5 rounded-lg bg-white/60 border">${p.type}</span>
                    </div>
                    <div class="text-xs mt-1 flex justify-between">
                        <span>权重: ${w} (≈${pct}%)</span>
                        <span>剩余: <b>${left}</b></span>
                    </div>
                `;
                ul.appendChild(li);
            });

            // 更新统计信息
            const stats = $('#poolStats');
            const totalItems = pool.length;
            const totalWeight = totalW;
            const physicalItems = pool.filter(p => p.type === '实体').length;
            stats.innerHTML = `总计 ${totalItems} 种奖品 | 总权重: ${totalWeight} | 实体奖品: ${physicalItems} 种`;
        }

        function refreshPoolEditor() {
            const pool = loadPool();
            $('#poolEditor').value = poolToText(pool);
        }

        function exportHistory() {
            const history = loadHistory();
            const data = JSON.stringify(history, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `labubu_lottery_history_${Date.now()}.json`;
            a.click();
        }

        function clearHistory() {
            if (confirm('确认清空所有抽奖记录？此操作不可恢复！')) {
                saveHistory([]);
                updateHistoryCount();
                broadcastUpdate('HISTORY_CLEARED'); // 广播记录清空（如果需要的话）
                alert('抽奖记录已清空');
            }
        }

        function resetAll() {
            if (confirm('确认完全重置系统？这将清空所有数据并恢复默认奖池！')) {
                localStorage.removeItem(LS_KEYS.HISTORY);
                localStorage.removeItem(LS_KEYS.POOL);
                localStorage.removeItem(LS_KEYS.DRAW_LIMIT);
                localStorage.removeItem(LS_KEYS.USER_DRAW_COUNT);
                refreshPoolEditor();
                renderPoolList(loadPool());
                updateHistoryCount();
                updateDrawLimitDisplay();
                broadcastUpdate('SYSTEM_RESET'); // 广播系统重置
                alert('系统已重置到默认状态，所有用户界面将自动刷新');
            }
        }

        function updateHistoryCount() {
            const count = loadHistory().length;
            $('#historyCount').textContent = count;
        }

        // —— 抽奖次数限制管理 ——
        function loadDrawLimit() {
            try {
                const limit = localStorage.getItem(LS_KEYS.DRAW_LIMIT);
                return limit ? parseInt(limit) : 0; // 0表示不限制
            } catch { return 0; }
        }

        function saveDrawLimit(limit) {
            localStorage.setItem(LS_KEYS.DRAW_LIMIT, limit.toString());
        }

        function loadUserDrawCount() {
            try {
                const count = localStorage.getItem(LS_KEYS.USER_DRAW_COUNT);
                return count ? parseInt(count) : 0;
            } catch { return 0; }
        }

        function saveUserDrawCount(count) {
            localStorage.setItem(LS_KEYS.USER_DRAW_COUNT, count.toString());
        }

        function updateDrawLimitDisplay() {
            const limit = loadDrawLimit();
            const currentLimitSpan = $('#currentDrawLimit');
            const drawLimitInput = $('#drawLimitInput');

            if (limit === 0) {
                currentLimitSpan.textContent = '不限制';
                drawLimitInput.value = '';
            } else {
                currentLimitSpan.textContent = `${limit} 次`;
                drawLimitInput.value = limit;
            }

            const userCount = loadUserDrawCount();
            $('#userDrawCount').textContent = `${userCount} 次`;
        }

        function setDrawLimit() {
            const input = $('#drawLimitInput');
            const limit = parseInt(input.value) || 0;

            if (limit < 0) {
                alert('抽奖次数不能为负数');
                return;
            }

            if (limit > 9999) {
                alert('抽奖次数不能超过9999次');
                return;
            }

            saveDrawLimit(limit);
            updateDrawLimitDisplay();
            broadcastUpdate('DRAW_LIMIT_UPDATE', { limit }); // 广播限制更新

            if (limit === 0) {
                alert('抽奖次数限制已取消并同步到所有用户');
            } else {
                alert(`抽奖次数限制已设置为 ${limit} 次并同步到所有用户`);
            }
        }

        function disableDrawLimit() {
            if (confirm('确认取消抽奖次数限制？用户将可以无限制抽奖。')) {
                saveDrawLimit(0);
                updateDrawLimitDisplay();
                broadcastUpdate('DRAW_LIMIT_UPDATE', { limit: 0 }); // 广播限制取消
                alert('抽奖次数限制已取消并同步到所有用户');
            }
        }

        function resetUserDrawCount() {
            if (confirm('确认重置用户抽奖次数？重置后用户可以重新开始抽奖。')) {
                saveUserDrawCount(0);
                updateDrawLimitDisplay();
                broadcastUpdate('USER_COUNT_RESET'); // 广播用户计数重置
                alert('用户抽奖次数已重置并同步到所有用户');
            }
        }

        // —— 登录验证相关 ——
        function isLoggedIn() {
            return sessionStorage.getItem(SESSION_KEY) === 'authenticated';
        }

        function login(password) {
            if (password === ADMIN_PASSWORD) {
                sessionStorage.setItem(SESSION_KEY, 'authenticated');
                showMainContent();
                return true;
            }
            return false;
        }

        function logout() {
            sessionStorage.removeItem(SESSION_KEY);
            showLoginOverlay();
        }

        function showLoginOverlay() {
            $('#loginOverlay').classList.remove('hidden');
            $('#mainContent').classList.add('hidden');
            $('#adminPassword').value = '';
            $('#loginError').classList.add('hidden');
            $('#adminPassword').focus();
        }

        function showMainContent() {
            $('#loginOverlay').classList.add('hidden');
            $('#mainContent').classList.remove('hidden');
        }

        // 防暴力破解计数器
        let loginAttempts = 0;
        let lastFailedLogin = 0;
        const MAX_LOGIN_ATTEMPTS = 5;
        const LOCKOUT_TIME = 5 * 60 * 1000; // 5分钟

        function handleLogin() {
            const password = $('#adminPassword').value;
            const errorDiv = $('#loginError');
            const now = Date.now();

            // 检查是否处于锁定状态
            if (loginAttempts >= MAX_LOGIN_ATTEMPTS && (now - lastFailedLogin) < LOCKOUT_TIME) {
                const remainingTime = Math.ceil((LOCKOUT_TIME - (now - lastFailedLogin)) / 1000 / 60);
                errorDiv.textContent = `登录已锁定，请${remainingTime}分钟后重试`;
                errorDiv.classList.remove('hidden');
                return;
            }

            // 重置锁定状态
            if ((now - lastFailedLogin) >= LOCKOUT_TIME) {
                loginAttempts = 0;
            }

            if (!password) {
                errorDiv.textContent = '请输入密码';
                errorDiv.classList.remove('hidden');
                return;
            }

            if (login(password)) {
                errorDiv.classList.add('hidden');
                // 登录成功，重置失败计数
                loginAttempts = 0;
                lastFailedLogin = 0;
            } else {
                loginAttempts++;
                lastFailedLogin = now;

                if (loginAttempts >= MAX_LOGIN_ATTEMPTS) {
                    errorDiv.textContent = `密码错误次数过多，已锁定5分钟`;
                } else {
                    errorDiv.textContent = `密码错误，还可尝试${MAX_LOGIN_ATTEMPTS - loginAttempts}次`;
                }
                errorDiv.classList.remove('hidden');
                $('#adminPassword').value = '';
                $('#adminPassword').focus();
            }
        }

        // —— 事件绑定 ——
        function bind() {
            // 登录相关事件
            $('#loginBtn').addEventListener('click', handleLogin);
            $('#logoutBtn').addEventListener('click', () => {
                if (confirm('确认退出管理系统？')) {
                    logout();
                }
            });
            $('#adminPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });

            // 原有功能事件
            $('#savePoolBtn').addEventListener('click', () => {
                try {
                    const text = $('#poolEditor').value;
                    const pool = textToPool(text);
                    savePool(pool);
                    renderPoolList(pool);
                    broadcastUpdate('POOL_UPDATE', pool); // 广播奖池更新
                    alert('奖池配置已保存并同步到所有用户');
                } catch (e) {
                    alert('保存失败：' + e.message);
                }
            });

            $('#reloadBtn').addEventListener('click', () => {
                refreshPoolEditor();
                renderPoolList(loadPool());
                alert('已重新载入当前配置');
            });

            $('#restoreDefaultBtn').addEventListener('click', () => {
                if (confirm('确认恢复默认奖池配置？当前配置将被覆盖！')) {
                    const defaultPool = structuredClone(DEFAULT_POOL);
                    savePool(defaultPool);
                    refreshPoolEditor();
                    renderPoolList(loadPool());
                    broadcastUpdate('POOL_UPDATE', defaultPool); // 广播奖池更新
                    alert('已恢复默认奖池配置并同步到所有用户');
                }
            });

            $('#refreshPreviewBtn').addEventListener('click', () => {
                renderPoolList(loadPool());
            });

            $('#exportHistoryBtn').addEventListener('click', exportHistory);
            $('#clearHistoryBtn').addEventListener('click', clearHistory);
            $('#resetAllBtn').addEventListener('click', resetAll);

            // 抽奖次数限制相关事件
            $('#saveDrawLimitBtn').addEventListener('click', setDrawLimit);
            $('#disableDrawLimitBtn').addEventListener('click', disableDrawLimit);
            $('#resetUserDrawCountBtn').addEventListener('click', resetUserDrawCount);
            $('#drawLimitInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    setDrawLimit();
                }
            });
        }

        function init() {
            $('#year').textContent = new Date().getFullYear();

            // 检查登录状态
            if (isLoggedIn()) {
                showMainContent();
                // 初始化主界面内容
                refreshPoolEditor();
                renderPoolList(loadPool());
                updateHistoryCount();
                updateDrawLimitDisplay();
                updateSyncStatus(); // 更新同步状态显示
            } else {
                showLoginOverlay();
            }
        }

        // —— 音乐播放器功能 ——
        const musicLibrary = [
            { title: "Shape of You", artist: "Ed Sheeran", url: "" },
            { title: "Blinding Lights", artist: "The Weeknd", url: "" },
            { title: "Someone Like You", artist: "Adele", url: "" },
            { title: "Perfect", artist: "Ed Sheeran", url: "" },
            { title: "Bad Guy", artist: "Billie Eilish", url: "" },
            { title: "Watermelon Sugar", artist: "Harry Styles", url: "" },
            { title: "Don't Start Now", artist: "Dua Lipa", url: "" },
            { title: "Rolling in the Deep", artist: "Adele", url: "" },
            { title: "Uptown Funk", artist: "Bruno Mars", url: "" },
            { title: "Havana", artist: "Camila Cabello", url: "" }
        ];

        let currentSongIndex = 0;
        let isPlaying = false;
        let currentAudio = null;
        let isPlayerMinimized = false;

        function initMusicPlayer() {
            renderPlaylist();
            loadSong(0);

            // 播放器控制事件
            $('#togglePlayer').addEventListener('click', togglePlayerSize);
            $('#playPauseBtn').addEventListener('click', togglePlayPause);
            $('#miniPlayPause').addEventListener('click', togglePlayPause);
            $('#prevBtn').addEventListener('click', previousSong);
            $('#nextBtn').addEventListener('click', nextSong);
            $('#volumeSlider').addEventListener('input', changeVolume);
        }

        function renderPlaylist() {
            const playlist = $('#playlist');
            playlist.innerHTML = '';
            musicLibrary.forEach((song, index) => {
                const songItem = document.createElement('div');
                songItem.className = `cursor-pointer p-2 rounded text-xs hover:bg-slate-100 ${index === currentSongIndex ? 'bg-[var(--labu)] text-white' : ''}`;
                songItem.innerHTML = `
                    <div class="font-medium">${song.title}</div>
                    <div class="text-xs opacity-75">${song.artist}</div>
                `;
                songItem.addEventListener('click', () => loadSong(index));
                playlist.appendChild(songItem);
            });
        }

        function loadSong(index) {
            currentSongIndex = index;
            const song = musicLibrary[index];
            $('#currentSong').textContent = song.title;
            $('#currentArtist').textContent = song.artist;
            $('#miniSongName').textContent = `${song.title} - ${song.artist}`;
            renderPlaylist();

            // 模拟播放（实际项目中需要真实音频文件）
            $('#totalTime').textContent = "3:45";
        }

        function togglePlayerSize() {
            isPlayerMinimized = !isPlayerMinimized;
            const content = $('#playerContent');
            const minimized = $('#playerMinimized');
            const icon = $('#playerToggleIcon');

            if (isPlayerMinimized) {
                content.classList.add('hidden');
                minimized.classList.remove('hidden');
                icon.textContent = '🔼';
            } else {
                content.classList.remove('hidden');
                minimized.classList.add('hidden');
                icon.textContent = '🔽';
            }
        }

        function togglePlayPause() {
            isPlaying = !isPlaying;
            const playBtn = $('#playPauseBtn');
            const miniBtn = $('#miniPlayPause');

            if (isPlaying) {
                playBtn.textContent = '⏸️';
                miniBtn.textContent = '⏸️';
                startProgressSimulation();
            } else {
                playBtn.textContent = '▶️';
                miniBtn.textContent = '▶️';
                stopProgressSimulation();
            }
        }

        function previousSong() {
            currentSongIndex = (currentSongIndex - 1 + musicLibrary.length) % musicLibrary.length;
            loadSong(currentSongIndex);
            if (isPlaying) {
                startProgressSimulation();
            }
        }

        function nextSong() {
            currentSongIndex = (currentSongIndex + 1) % musicLibrary.length;
            loadSong(currentSongIndex);
            if (isPlaying) {
                startProgressSimulation();
            }
        }

        function changeVolume(event) {
            const volume = event.target.value;
            // 实际项目中会设置音频音量
            console.log('Volume set to:', volume);
        }

        let progressInterval;
        let currentTime = 0;

        function startProgressSimulation() {
            currentTime = 0;
            progressInterval = setInterval(() => {
                currentTime += 1;
                const minutes = Math.floor(currentTime / 60);
                const seconds = currentTime % 60;
                $('#currentTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

                // 模拟进度条（总长度225秒 = 3分45秒）
                const progress = (currentTime / 225) * 100;
                $('#progressBar').style.width = Math.min(progress, 100) + '%';

                // 歌曲结束自动下一首
                if (currentTime >= 225) {
                    nextSong();
                }
            }, 1000);
        }

        function stopProgressSimulation() {
            if (progressInterval) {
                clearInterval(progressInterval);
            }
        }

        // 更新初始化函数
        const originalAdminInit = init;

        function init() {
            $('#year').textContent = new Date().getFullYear();

            // 检查登录状态
            if (isLoggedIn()) {
                showMainContent();
                // 初始化主界面内容
                refreshPoolEditor();
                renderPoolList(loadPool());
                updateHistoryCount();
                updateDrawLimitDisplay();
                updateSyncStatus(); // 更新同步状态显示
                initMusicPlayer(); // 初始化音乐播放器
            } else {
                showLoginOverlay();
            }
        }

        // —— 自定义鼠标和交互效果 ——
        function initCustomCursor() {
            const cursor = $('.custom-cursor');
            let mouseX = 0, mouseY = 0;

            document.addEventListener('mousemove', (e) => {
                mouseX = e.clientX;
                mouseY = e.clientY;
                cursor.style.left = mouseX + 'px';
                cursor.style.top = mouseY + 'px';

                createCursorTrail(mouseX, mouseY);
            });

            document.addEventListener('mousedown', () => {
                cursor.classList.add('clicking');
            });

            document.addEventListener('mouseup', () => {
                cursor.classList.remove('clicking');
            });
        }

        function createCursorTrail(x, y) {
            const trail = document.createElement('div');
            trail.className = 'cursor-trail';
            trail.style.left = (x - 4) + 'px';
            trail.style.top = (y - 4) + 'px';
            document.body.appendChild(trail);

            setTimeout(() => {
                if (document.body.contains(trail)) {
                    document.body.removeChild(trail);
                }
            }, 500);
        }

        function initButtonEffects() {
            document.querySelectorAll('.enhanced-btn').forEach(button => {
                button.addEventListener('click', createRipple);
            });
        }

        function createRipple(event) {
            const button = event.currentTarget;
            const rect = button.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = event.clientX - rect.left - size / 2;
            const y = event.clientY - rect.top - size / 2;

            const ripple = document.createElement('div');
            ripple.className = 'btn-ripple';
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = x + 'px';
            ripple.style.top = y + 'px';

            button.appendChild(ripple);

            setTimeout(() => {
                if (button.contains(ripple)) {
                    button.removeChild(ripple);
                }
            }, 600);
        }

        // 更新admin初始化函数
        const originalAdminInit2 = init;

        function init() {
            $('#year').textContent = new Date().getFullYear();

            // 检查登录状态
            if (isLoggedIn()) {
                showMainContent();
                // 初始化主界面内容
                refreshPoolEditor();
                renderPoolList(loadPool());
                updateHistoryCount();
                updateDrawLimitDisplay();
                updateSyncStatus(); // 更新同步状态显示
                initMusicPlayer(); // 初始化音乐播放器

                // 初始化交互效果
                setTimeout(() => {
                    initCustomCursor();
                    initButtonEffects();
                }, 100);
            } else {
                showLoginOverlay();
                // 为登录界面也初始化交互效果
                setTimeout(() => {
                    initCustomCursor();
                    initButtonEffects();
                }, 100);
            }
        }

        bind();
        init();
    </script>
</body>

</html>