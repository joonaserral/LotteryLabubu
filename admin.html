<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>奖池管理 - Labubu 幸运抽奖 🧸</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🧸</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- VIP安全验证 -->
    <script src="auth.js"></script>
    <script src="config.enc.js"></script>
    <!-- 移除Google Fonts以避免微信环境下的加载问题 -->
    <style>
        /* 使用系统字体代替Google Fonts，确保微信兼容性 */
        body,
        html,
        * {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji" !important;
        }
    </style>
    <style>
        :root {
            --labu: #6b5b95;
            --labu2: #ffcc00;
        }

        body {
            font-family: 'Zen Maru Gothic', system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans SC', 'PingFang SC', 'Microsoft Yahei', sans-serif;
        }

        .labu-gradient {
            background-image: linear-gradient(135deg, rgba(107, 91, 149, .12), rgba(255, 204, 0, .12));
        }

        /* 自定义鼠标样式和交互效果 - 增加备用方案 */
        body.custom-cursor-enabled * {
            cursor: none !important;
        }

        body:not(.custom-cursor-enabled) * {
            cursor: auto;
        }

        /* 恢复文本输入元素的光标 */
        input,
        textarea,
        [contenteditable="true"],
        .text-input {
            cursor: text !important;
        }

        /* 恢复可点击元素的光标 */
        button,
        a,
        [role="button"],
        .cursor-pointer,
        select {
            cursor: pointer !important;
        }

        /* 光标回退选项 */
        body.cursor-fallback * {
            cursor: auto !important;
        }

        body.cursor-fallback input,
        body.cursor-fallback textarea,
        body.cursor-fallback [contenteditable="true"] {
            cursor: text !important;
        }

        body.cursor-fallback button,
        body.cursor-fallback a,
        body.cursor-fallback [role="button"],
        body.cursor-fallback select {
            cursor: pointer !important;
        }

        .custom-cursor {
            position: fixed;
            width: 20px;
            height: 20px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ff69b4"><path d="M8 2C8 2 8.5 3 10.5 3C12.5 3 13 2 13 2C14 2 15 3 15 4C15 5 14 6 13 6C12 6 11 7 11 8C11 9 12 10 13 10C14 10 15 9 15 8C15 7 16 6 17 6C18 6 19 7 19 8C19 9 18 10 17 10C16 10 15 11 15 12C15 13 16 14 17 14C18 14 19 13 19 12C19 11 20 10 21 10C22 10 23 11 23 12C23 13 22 14 21 14C20 14 19 15 19 16C19 17 18 18 17 18C16 18 15 17 15 16C15 15 14 14 13 14C12 14 11 15 11 16C11 17 10 18 9 18C8 18 7 17 7 16C7 15 8 14 9 14C10 14 11 13 11 12C11 11 10 10 9 10C8 10 7 11 7 12C7 13 6 14 5 14C4 14 3 13 3 12C3 11 4 10 5 10C6 10 7 9 7 8C7 7 6 6 5 6C4 6 3 7 3 8C3 9 2 10 1 10C0 10 -1 9 -1 8C-1 7 0 6 1 6C2 6 3 5 3 4C3 3 4 2 5 2C6 2 7 3 7 4C7 5 8 6 9 6C10 6 11 5 11 4C11 3 10 2 9 2C8.5 2 8 2 8 2Z"/></svg>') no-repeat center;
            background-size: contain;
            pointer-events: none;
            z-index: 9999;
            transition: transform 0.1s ease;
            transform: translate(-50%, -50%);
        }

        .custom-cursor.clicking {
            transform: translate(-50%, -50%) scale(1.2);
        }

        .cursor-trail {
            position: fixed;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, rgba(255, 105, 180, 0.8) 0%, rgba(255, 105, 180, 0) 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9998;
            animation: cursorTrailFade 0.5s ease-out forwards;
        }

        @keyframes cursorTrailFade {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            100% {
                opacity: 0;
                transform: scale(0.3);
            }
        }

        .enhanced-btn {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .enhanced-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .enhanced-btn:hover::before {
            left: 100%;
        }

        .enhanced-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(107, 91, 149, 0.3);
        }

        .enhanced-btn:active {
            transform: translateY(0);
        }

        .btn-ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            transform: scale(0);
            animation: rippleEffect 0.6s linear;
            pointer-events: none;
        }

        @keyframes rippleEffect {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900">
    <!-- 自定义鼠标光标 -->
    <div class="custom-cursor"></div>

    <!-- 光标切换按钮 -->
    <button id="cursorToggle"
        class="fixed bottom-4 left-4 z-50 w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full shadow-lg flex items-center justify-center text-white text-lg hover:scale-110 transition-transform duration-200"
        title="切换光标模式" onclick="if(window.toggleCursorMode) window.toggleCursorMode()">
        🖱️
    </button>

    <!-- 光标修复脚本 -->
    <script src="修复光标脚本.js"></script>

    <!-- 登录界面 -->
    <div id="loginOverlay" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="bg-white rounded-3xl shadow-2xl p-8 mx-4 w-full max-w-md">
            <div class="text-center mb-6">
                <div
                    class="w-16 h-16 rounded-2xl bg-[var(--labu)] grid place-content-center text-white text-2xl mx-auto mb-4">
                    🔒</div>
                <h2 class="text-2xl font-bold text-slate-900">管理员验证</h2>
                <p class="text-slate-600 mt-2">请输入管理员密码以访问系统</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="adminPassword" class="block text-sm font-medium text-slate-700 mb-2">管理员密码</label>
                    <input type="password" id="adminPassword"
                        class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:border-[var(--labu)] focus:ring-2 focus:ring-[var(--labu)]/20 focus:outline-none transition-colors"
                        placeholder="请输入密码">
                </div>
                <button id="loginBtn"
                    class="enhanced-btn w-full px-4 py-3 rounded-xl bg-[var(--labu)] text-white font-medium transition-opacity">
                    进入管理系统
                </button>
                <div class="text-center">
                    <a href="index.html" class="text-sm text-slate-500 hover:text-slate-700">返回抽奖页面</a>
                </div>
            </div>
            <div id="loginError" class="mt-4 text-sm text-red-600 text-center hidden"></div>
        </div>
    </div>

    <!-- 主界面内容 -->
    <div id="mainContent" class="hidden">
        <!-- 顶部栏 -->
        <header class="sticky top-0 z-10 backdrop-blur bg-white/60 border-b border-slate-200">
            <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-xl bg-[var(--labu)] grid place-content-center text-white text-xl">🦊
                    </div>
                    <h1 class="font-bold text-lg">奖池管理系统</h1>
                </div>
                <nav class="text-sm flex items-center gap-3">
                    <a href="index.html" class="hover:underline">返回抽奖</a>
                    <button id="logoutBtn" class="text-red-600 hover:underline">登出</button>
                </nav>
            </div>
        </header>

        <!-- Hero -->
        <section class="labu-gradient">
            <div class="max-w-5xl mx-auto px-4 py-10">
                <div class="text-center">
                    <h2 class="text-3xl md:text-4xl font-extrabold leading-tight">奖池配置管理</h2>
                    <p class="mt-3 text-slate-700">管理员专用界面，用于配置和管理抽奖奖池设置</p>
                </div>
            </div>
        </section>

        <!-- 主要内容 -->
        <main class="max-w-5xl mx-auto px-4 py-10">
            <div class="grid lg:grid-cols-2 gap-8">
                <!-- 奖池设置 -->
                <section>
                    <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
                        <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                            <h3 class="font-semibold">奖池配置编辑</h3>
                            <div class="text-xs text-slate-500">配置将保存到本地浏览器</div>
                        </div>
                        <div class="p-5 grid gap-4">
                            <div class="text-sm text-slate-600">
                                <div class="mb-2">每行一个奖品，字段使用逗号分隔：<code>name,type,weight,quantity</code></div>
                                <ul class="text-xs space-y-1 text-slate-500">
                                    <li>• <b>name</b>: 奖品名称</li>
                                    <li>• <b>type</b>: 奖品类型，仅支持：<b>抵扣券</b>｜<b>实体</b>｜<b>折扣券</b></li>
                                    <li>• <b>weight</b>: 权重数值，数值越大越容易抽中</li>
                                    <li>• <b>quantity</b>: 库存数量，留空或 -1 表示不限量</li>
                                </ul>
                            </div>
                            <textarea id="poolEditor" rows="12"
                                class="w-full rounded-xl border border-slate-300 p-3 font-mono text-xs"></textarea>
                            <div class="flex gap-3 flex-wrap">
                                <button id="savePoolBtn"
                                    class="px-4 py-2 rounded-xl bg-[var(--labu)] text-white font-medium hover:opacity-90">保存奖池</button>
                                <button id="reloadBtn"
                                    class="px-4 py-2 rounded-xl bg-slate-100 border border-slate-200 hover:bg-slate-200">重新载入</button>
                                <button id="restoreDefaultBtn"
                                    class="px-4 py-2 rounded-xl bg-orange-100 text-orange-700 border border-orange-200 hover:bg-orange-200">恢复默认</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 当前奖池预览 -->
                <section>
                    <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
                        <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                            <h3 class="font-semibold">当前奖池预览</h3>
                            <button id="refreshPreviewBtn"
                                class="text-xs px-2 py-1 rounded-lg bg-slate-100 border border-slate-200">刷新预览</button>
                        </div>
                        <div class="p-5">
                            <ul id="poolList" class="text-sm grid gap-2"></ul>
                            <div id="poolStats" class="mt-4 p-3 rounded-lg bg-slate-50 text-xs text-slate-600"></div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- 抽奖控制 -->
            <section class="mt-10">
                <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
                    <div class="p-5 border-b border-slate-100">
                        <h3 class="font-semibold">抽奖控制设置</h3>
                    </div>
                    <div class="p-5 grid md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-medium mb-3">抽奖次数限制</h4>
                            <div class="space-y-3">
                                <div>
                                    <label for="drawLimitInput"
                                        class="block text-sm font-medium text-slate-700 mb-1">每用户最大抽奖次数</label>
                                    <input type="number" id="drawLimitInput" min="1" max="9999"
                                        class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:border-[var(--labu)] focus:ring-2 focus:ring-[var(--labu)]/20 focus:outline-none"
                                        placeholder="输入次数限制（0表示不限制）">
                                </div>
                                <div class="flex gap-3">
                                    <button id="saveDrawLimitBtn"
                                        class="px-4 py-2 rounded-xl bg-[var(--labu)] text-white font-medium hover:opacity-90">保存设置</button>
                                    <button id="disableDrawLimitBtn"
                                        class="px-4 py-2 rounded-xl bg-slate-100 border border-slate-200 hover:bg-slate-200">取消限制</button>
                                </div>
                                <div class="text-xs text-slate-500">
                                    当前限制：<span id="currentDrawLimit">未设置</span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-medium mb-3">用户抽奖统计</h4>
                            <div class="space-y-3">
                                <div class="p-3 rounded-lg bg-slate-50 text-sm">
                                    <div class="flex justify-between">
                                        <span>当前用户已抽奖：</span>
                                        <span class="font-medium" id="userDrawCount">0 次</span>
                                    </div>
                                </div>
                                <div class="p-3 rounded-lg bg-green-50 text-sm">
                                    <div class="flex justify-between">
                                        <span>🟢 实时同步状态：</span>
                                        <span class="font-medium text-green-600" id="syncStatus">已连接</span>
                                    </div>
                                    <div class="text-xs text-slate-500 mt-1">管理员修改将实时推送到所有用户</div>
                                </div>
                                <button id="resetUserDrawCountBtn"
                                    class="w-full px-4 py-2 rounded-xl bg-orange-100 text-orange-700 border border-orange-200 hover:bg-orange-200">重置用户抽奖次数</button>
                                <div class="text-xs text-slate-500">重置后用户可以重新开始抽奖</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 数据管理 -->
            <section class="mt-10">
                <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
                    <div class="p-5 border-b border-slate-100">
                        <h3 class="font-semibold">数据管理</h3>
                    </div>
                    <div class="p-5 grid md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-medium mb-3">抽奖记录管理</h4>
                            <div class="flex gap-3 flex-wrap">
                                <button id="exportHistoryBtn"
                                    class="px-4 py-2 rounded-xl bg-green-100 text-green-700 border border-green-200 hover:bg-green-200">导出抽奖记录</button>
                                <button id="clearHistoryBtn"
                                    class="px-4 py-2 rounded-xl bg-red-100 text-red-700 border border-red-200 hover:bg-red-200">清空抽奖记录</button>
                            </div>
                            <div class="mt-2 text-xs text-slate-500">当前记录数：<span id="historyCount">0</span></div>
                        </div>
                        <div>
                            <h4 class="font-medium mb-3">系统重置</h4>
                            <div class="flex gap-3 flex-wrap">
                                <button id="resetAllBtn"
                                    class="px-4 py-2 rounded-xl bg-red-100 text-red-700 border border-red-200 hover:bg-red-200">完全重置</button>
                            </div>
                            <div class="mt-2 text-xs text-slate-500">将清空所有数据并恢复默认奖池</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 成就勋章管理 -->
            <section class="mt-10">
                <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
                    <div class="p-5 border-b border-slate-100">
                        <h3 class="font-semibold flex items-center gap-2">
                            🏆 成就勋章管理
                        </h3>
                    </div>
                    <div class="p-5">
                        <!-- 用户搜索 -->
                        <div class="mb-6">
                            <h4 class="font-medium mb-3">用户管理</h4>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label for="userSearchInput"
                                        class="block text-sm font-medium text-slate-700 mb-1">搜索用户</label>
                                    <div class="flex gap-2">
                                        <input type="text" id="userSearchInput"
                                            class="flex-1 px-3 py-2 rounded-lg border border-slate-300 focus:border-[var(--labu)] focus:ring-2 focus:ring-[var(--labu)]/20 focus:outline-none"
                                            placeholder="输入用户名搜索...">
                                        <button id="searchUserBtn"
                                            class="px-4 py-2 rounded-lg bg-[var(--labu)] text-white hover:opacity-90">搜索</button>
                                    </div>
                                </div>
                                <div>
                                    <label for="selectedUser"
                                        class="block text-sm font-medium text-slate-700 mb-1">选择用户</label>
                                    <select id="selectedUser"
                                        class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:border-[var(--labu)] focus:ring-2 focus:ring-[var(--labu)]/20 focus:outline-none">
                                        <option value="">请选择用户...</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- 用户信息显示 -->
                        <div id="userInfoSection" class="mb-6 p-4 rounded-lg bg-slate-50 hidden">
                            <h4 class="font-medium mb-3">用户信息</h4>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <div class="flex items-center gap-3 mb-3">
                                        <div
                                            class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center text-xl">
                                            <span id="userInfoAvatar">🧸</span>
                                        </div>
                                        <div>
                                            <h5 id="userInfoName" class="font-bold">用户名</h5>
                                            <p id="userInfoBio" class="text-sm text-slate-600">个性签名</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-sm">
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>总抽奖：<span id="userTotalDraws" class="font-medium">0</span></div>
                                        <div>中奖次数：<span id="userTotalWins" class="font-medium">0</span></div>
                                        <div>积分：<span id="userPoints" class="font-medium">0</span></div>
                                        <div>成就：<span id="userAchievements" class="font-medium">0/12</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 成就发放 -->
                        <div id="achievementGrantSection" class="hidden">
                            <h4 class="font-medium mb-3">发放成就勋章</h4>
                            <div class="grid md:grid-cols-2 gap-6">
                                <!-- 成就列表 -->
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">选择成就</label>
                                    <div id="achievementsList" class="space-y-2 max-h-64 overflow-y-auto">
                                        <!-- 成就项将通过JavaScript动态生成 -->
                                    </div>
                                </div>

                                <!-- 批量操作 -->
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">批量操作</label>
                                    <div class="space-y-3">
                                        <button id="grantSelectedBtn"
                                            class="w-full px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                                            disabled>发放选中成就</button>
                                        <button id="revokeSelectedBtn"
                                            class="w-full px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                                            disabled>撤销选中成就</button>
                                        <button id="grantAllBtn"
                                            class="w-full px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                                            disabled>发放全部成就</button>
                                        <button id="resetAllAchievementsBtn"
                                            class="w-full px-4 py-2 rounded-lg bg-orange-600 text-white hover:bg-orange-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                                            disabled>重置全部成就</button>
                                    </div>

                                    <div class="mt-4 p-3 rounded-lg bg-yellow-50 border border-yellow-200">
                                        <p class="text-xs text-yellow-700">
                                            <strong>注意：</strong>管理员手动发放的成就会覆盖系统自动判定，请谨慎操作。
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 全局成就统计 -->
                        <div class="mt-6 pt-6 border-t border-slate-200">
                            <h4 class="font-medium mb-3">全局成就统计</h4>
                            <div id="globalAchievementStats" class="grid md:grid-cols-4 gap-4 text-sm">
                                <!-- 统计数据将通过JavaScript动态生成 -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="max-w-5xl mx-auto px-4 py-10 text-center text-xs text-slate-500">
            <div>© <span id="year"></span> Labubu 抽奖管理系统</div>
        </footer>
    </div> <!-- 主界面内容结束 -->

    <!-- 音乐播放器浮窗 -->
    <div id="musicPlayer"
        class="fixed bottom-4 right-4 z-40 music-player rounded-2xl shadow-lg border border-slate-200 p-4 w-80"
        style="backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.9);">
        <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
                <span class="text-lg">🎵</span>
                <span class="font-medium text-sm">音乐播放器</span>
            </div>
            <button id="togglePlayer" class="text-slate-400 hover:text-slate-600">
                <span id="playerToggleIcon">🔽</span>
            </button>
        </div>

        <div id="playerContent" class="space-y-3">
            <!-- 当前播放信息 -->
            <div class="text-center">
                <div id="currentSong" class="font-medium text-sm text-slate-800">Ready to Play</div>
                <div id="currentArtist" class="text-xs text-slate-500">选择一首歌开始播放</div>
            </div>

            <!-- 进度条 -->
            <div class="space-y-2">
                <div class="flex justify-between text-xs text-slate-500">
                    <span id="currentTime">0:00</span>
                    <span id="totalTime">0:00</span>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-1">
                    <div id="progressBar" class="h-1 rounded-full w-0 transition-all"
                        style="background: linear-gradient(90deg, var(--labu) 0%, var(--labu2) 100%);"></div>
                </div>
            </div>

            <!-- 控制按钮 -->
            <div class="flex items-center justify-center gap-4">
                <button id="prevBtn" class="text-xl hover:scale-110 transition-transform">⏮️</button>
                <button id="playPauseBtn" class="text-2xl hover:scale-110 transition-transform">▶️</button>
                <button id="nextBtn" class="text-xl hover:scale-110 transition-transform">⏭️</button>
            </div>

            <!-- 音量控制已移除，简化界面 -->

            <!-- 播放列表 -->
            <div class="max-h-32 overflow-y-auto space-y-1">
                <div class="text-xs text-slate-500 mb-2">播放列表</div>
                <div id="playlist" class="space-y-1"></div>
            </div>
        </div>

        <!-- 最小化状态 -->
        <div id="playerMinimized" class="hidden">
            <div class="flex items-center gap-2">
                <button id="miniPlayPause" class="text-lg">▶️</button>
                <div class="flex-1 text-sm truncate">
                    <div id="miniSongName" class="font-medium">未播放</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // —— 安全检查 ——
        if (!window._secureConfig || !window._secureConfig.validate()) {
            console.log('🎵 管理员系统');
        }

        // 检查条款同意状态
        function checkTermsAgreement() {
            const agreed = localStorage.getItem('terms_agreed');
            if (!agreed) {
                window.location.href = 'welcome.html';
                return false;
            }

            const agreeTime = parseInt(agreed);
            const now = Date.now();
            const dayInMs = 24 * 60 * 60 * 1000;

            // 条款同意有效期7天
            if (now - agreeTime > 7 * dayInMs) {
                localStorage.removeItem('terms_agreed');
                window.location.href = 'welcome.html';
                return false;
            }

            return true;
        }

        // 页面初始化前检查条款
        if (!checkTermsAgreement()) {
            // 如果条款检查失败，停止后续执行
        } else {

            // —— 加密配置常量 ——
            const _0x7c3f = window._secureConfig.decode(window._secureConfig._0x1a2b);
            const _0x8d4e = 'labubu_vip_admin_' + btoa('secure_session');

            const ADMIN_PASSWORD = _0x7c3f;
            const SESSION_KEY = _0x8d4e;

            // —— 本地存储键 ——
            const LS_KEYS = {
                HISTORY: 'labubu_lottery_history',
                POOL: 'labubu_lottery_pool',
                DRAW_LIMIT: 'labubu_draw_limit',
                USER_DRAW_COUNT: 'labubu_user_draw_count'
            };

            // —— 数据同步广播 ——
            let dataChannel = null;
            let syncEnabled = false;

            // 检查浏览器兼容性
            if ('BroadcastChannel' in window) {
                try {
                    dataChannel = new BroadcastChannel('labubu_data_sync');
                    syncEnabled = true;
                } catch (error) {
                    console.warn('BroadcastChannel初始化失败:', error);
                    syncEnabled = false;
                }
            } else {
                console.warn('浏览器不支持BroadcastChannel，实时同步功能将不可用');
                syncEnabled = false;
            }

            function broadcastUpdate(type, data = null) {
                if (!syncEnabled || !dataChannel) {
                    console.warn('数据同步不可用，跳过广播:', type);
                    return;
                }

                try {
                    const message = {
                        type: type,
                        data: data,
                        timestamp: Date.now(),
                        source: 'admin'
                    };
                    dataChannel.postMessage(message);
                    console.log('📡 广播更新:', type);
                    showBroadcastNotification(type);
                } catch (error) {
                    console.error('广播失败:', error);
                    showBroadcastNotification('SYNC_ERROR');
                }
            }

            function showBroadcastNotification(type) {
                const typeNames = {
                    'POOL_UPDATE': '奖池配置',
                    'DRAW_LIMIT_UPDATE': '抽奖限制',
                    'USER_COUNT_RESET': '用户计数重置',
                    'SYSTEM_RESET': '系统重置',
                    'HISTORY_CLEARED': '记录清空',
                    'SYNC_ERROR': '同步失败'
                };

                const notification = document.createElement('div');
                const isError = type === 'SYNC_ERROR';
                const bgColor = isError ? 'bg-red-500' : 'bg-green-500';
                const icon = isError ? '❌' : '📡';
                const message = isError ? '同步失败，请检查网络连接' : `${typeNames[type] || type} 已推送到所有用户`;

                notification.className = `fixed top-20 right-4 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm transition-all duration-300`;
                notification.innerHTML = `${icon} ${message}`;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (document.body.contains(notification)) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }, isError ? 5000 : 2000); // 错误消息显示更长时间
            }

            function updateSyncStatus() {
                const statusElement = $('#syncStatus');
                if (statusElement) {
                    if (syncEnabled) {
                        statusElement.textContent = '已连接';
                        statusElement.className = 'font-medium text-green-600';
                    } else {
                        statusElement.textContent = '不可用';
                        statusElement.className = 'font-medium text-red-600';
                    }
                }
            }

            // —— VIP专享奖池 (含超稀有上迪挂件) ——
            const DEFAULT_POOL = [
                // 普通奖品
                { name: "再接再厉", type: '折扣券', weight: 30, quantity: 50, rarity: 'common', points: 10, emoji: "💪" },
                { name: "奶茶一杯", type: '实体', weight: 25, quantity: 30, rarity: 'common', points: 20, emoji: "🧋" },
                { name: "烤肉券（清真记录）", type: '实体', weight: 20, quantity: 25, rarity: 'common', points: 30, emoji: "🥩" },
                { name: "烤肉券", type: '实体', weight: 20, quantity: 20, rarity: 'common', points: 30, emoji: "🍖" },
                { name: "精品奶茶券", type: '实体', weight: 15, quantity: 15, rarity: 'rare', points: 50, emoji: "🧃" },
                { name: "1U币", type: '实体', weight: 25, quantity: 100, rarity: 'common', points: 1, emoji: "💰" },
                { name: "3U币", type: '实体', weight: 15, quantity: 60, rarity: 'common', points: 3, emoji: "💵" },
                { name: "5U币", type: '实体', weight: 10, quantity: 40, rarity: 'rare', points: 5, emoji: "💸" },

                // Labubu系列收藏
                { name: "经典Labubu公仔", type: '实体', weight: 8, quantity: 10, rarity: 'rare', points: 100, image: "images/prizes/labubu/classic.jpg", emoji: "🧸" },
                { name: "彩虹Labubu限定", type: '实体', weight: 6, quantity: 8, rarity: 'epic', points: 150, image: "images/prizes/labubu/rainbow.jpg", emoji: "🌈" },
                { name: "万圣节Labubu特别版", type: '实体', weight: 4, quantity: 5, rarity: 'epic', points: 200, image: "images/prizes/labubu/halloween.jpg", emoji: "🎃" },
                { name: "黄金Labubu收藏版", type: '实体', weight: 2, quantity: 3, rarity: 'legendary', points: 500, image: "images/prizes/labubu/gold.jpg", emoji: "👑" },

                // Cookie Ann迪士尼系列
                { name: "甜心Cookie Ann公仔", type: '实体', weight: 7, quantity: 8, rarity: 'rare', points: 120, image: "images/prizes/cookie-ann/sweet.jpg", emoji: "🍪" },
                { name: "公主Cookie Ann限定", type: '实体', weight: 5, quantity: 6, rarity: 'epic', points: 180, image: "images/prizes/cookie-ann/princess.jpg", emoji: "👸" },
                { name: "圣诞Cookie Ann特别版", type: '实体', weight: 3, quantity: 4, rarity: 'epic', points: 220, image: "images/prizes/cookie-ann/christmas.jpg", emoji: "🎄" },
                { name: "烘焙大师Cookie Ann", type: '实体', weight: 1.5, quantity: 2, rarity: 'legendary', points: 600, image: "images/prizes/cookie-ann/baker.jpg", emoji: "👩‍🍳" },

                // Pop Mart潮玩系列
                { name: "Molly经典款", type: '实体', weight: 6, quantity: 7, rarity: 'rare', points: 110, image: "images/prizes/popmart/molly-classic.jpg", emoji: "👧" },
                { name: "Dimoo云朵系列", type: '实体', weight: 4, quantity: 5, rarity: 'epic', points: 160, image: "images/prizes/popmart/dimoo-cloud.jpg", emoji: "☁️" },
                { name: "Skullpanda骷髅熊猫", type: '实体', weight: 2.5, quantity: 3, rarity: 'legendary', points: 450, image: "images/prizes/popmart/skullpanda.jpg", emoji: "🐼" },

                // 超稀有特别版挂件 - 中奖率极低 (几乎为0)
                { name: "限定Labubu万圣节挂件", type: '实体', weight: 0.1, quantity: 1, rarity: 'mythic', points: 2000, image: "images/prizes/labubu/halloween-special.jpg", emoji: "🎃" },
                { name: "限定Cookie Ann圣诞挂件", type: '实体', weight: 0.1, quantity: 1, rarity: 'mythic', points: 2000, image: "images/prizes/cookie-ann/christmas-special.jpg", emoji: "🎄" },
                { name: "限定Molly夏日海洋挂件", type: '实体', weight: 0.05, quantity: 1, rarity: 'mythic', points: 3000, image: "images/prizes/popmart/molly-ocean-special.jpg", emoji: "🌊" }
            ];

            // —— 工具函数 ——
            const $ = (sel) => document.querySelector(sel);

            function loadHistory() {
                try { return JSON.parse(localStorage.getItem(LS_KEYS.HISTORY)) || []; } catch { return []; }
            }
            function saveHistory(arr) { localStorage.setItem(LS_KEYS.HISTORY, JSON.stringify(arr)); }
            function loadPool() {
                try {
                    const raw = localStorage.getItem(LS_KEYS.POOL);
                    return raw ? JSON.parse(raw) : structuredClone(DEFAULT_POOL);
                } catch { return structuredClone(DEFAULT_POOL); }
            }
            function savePool(pool) { localStorage.setItem(LS_KEYS.POOL, JSON.stringify(pool)); }

            function poolToText(pool) {
                return pool.map(p => [p.name, p.type, p.weight, (p.quantity ?? -1)].join(',')).join('\n');
            }
            function textToPool(txt) {
                const lines = txt.split(/\n+/).map(l => l.trim()).filter(Boolean);

                if (lines.length === 0) {
                    throw new Error('奖池不能为空');
                }

                if (lines.length > 100) {
                    throw new Error('奖池项目不能超过100个');
                }

                return lines.map((line, i) => {
                    const parts = line.split(',').map(s => s?.trim());

                    if (parts.length < 3 || parts.length > 4) {
                        throw new Error(`第 ${i + 1} 行格式不正确：应为 name,type,weight[,quantity]`);
                    }

                    const [name, type, weightStr, qtyStr] = parts;

                    // 名称验证
                    if (!name || name.length > 50) {
                        throw new Error(`第 ${i + 1} 行：奖品名称不能为空且不能超过50字符`);
                    }

                    // 类型验证
                    if (!['抵扣券', '实体', '折扣券'].includes(type)) {
                        throw new Error(`第 ${i + 1} 行：奖品类型只能是 抵扣券/实体/折扣券`);
                    }

                    // 权重验证
                    const weight = Number(weightStr);
                    if (!Number.isFinite(weight) || weight < 0 || weight > 10000) {
                        throw new Error(`第 ${i + 1} 行：权重必须是0-10000之间的数字`);
                    }

                    // 数量验证
                    let quantity = -1;
                    if (qtyStr !== undefined && qtyStr !== '') {
                        quantity = Number(qtyStr);
                        if (!Number.isInteger(quantity) || quantity < -1 || quantity > 99999) {
                            throw new Error(`第 ${i + 1} 行：数量必须是-1到99999之间的整数`);
                        }
                    }

                    return { name, type, weight, quantity };
                });
            }

            function renderPoolList(pool) {
                const ul = $('#poolList');
                ul.innerHTML = '';
                const totalW = pool.reduce((s, p) => s + Math.max(0, p.weight || 0), 0) || 1;

                pool.forEach(p => {
                    const left = p.quantity === -1 ? '∞' : p.quantity;
                    const w = p.weight || 0;
                    const pct = ((w / totalW) * 100).toFixed(1);
                    const color = p.type === '实体' ? 'bg-emerald-50 text-emerald-700 border-emerald-200' :
                        (p.type === '抵扣券' ? 'bg-indigo-50 text-indigo-700 border-indigo-200' : 'bg-amber-50 text-amber-700 border-amber-200');

                    const li = document.createElement('li');
                    li.className = `border rounded-xl p-3 ${color}`;
                    li.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="font-medium">${p.name}</div>
                        <span class="text-xs px-2 py-0.5 rounded-lg bg-white/60 border">${p.type}</span>
                    </div>
                    <div class="text-xs mt-1 flex justify-between">
                        <span>权重: ${w} (≈${pct}%)</span>
                        <span>剩余: <b>${left}</b></span>
                    </div>
                `;
                    ul.appendChild(li);
                });

                // 更新统计信息
                const stats = $('#poolStats');
                const totalItems = pool.length;
                const totalWeight = totalW;
                const physicalItems = pool.filter(p => p.type === '实体').length;
                stats.innerHTML = `总计 ${totalItems} 种奖品 | 总权重: ${totalWeight} | 实体奖品: ${physicalItems} 种`;
            }

            function refreshPoolEditor() {
                const pool = loadPool();
                $('#poolEditor').value = poolToText(pool);
            }

            function exportHistory() {
                const history = loadHistory();
                const data = JSON.stringify(history, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `labubu_lottery_history_${Date.now()}.json`;
                a.click();
            }

            function clearHistory() {
                if (confirm('确认清空所有抽奖记录？此操作不可恢复！')) {
                    saveHistory([]);
                    updateHistoryCount();
                    broadcastUpdate('HISTORY_CLEARED'); // 广播记录清空（如果需要的话）
                    alert('抽奖记录已清空');
                }
            }

            function resetAll() {
                if (confirm('确认完全重置系统？这将清空所有数据并恢复默认奖池！')) {
                    localStorage.removeItem(LS_KEYS.HISTORY);
                    localStorage.removeItem(LS_KEYS.POOL);
                    localStorage.removeItem(LS_KEYS.DRAW_LIMIT);
                    localStorage.removeItem(LS_KEYS.USER_DRAW_COUNT);
                    refreshPoolEditor();
                    renderPoolList(loadPool());
                    updateHistoryCount();
                    updateDrawLimitDisplay();
                    broadcastUpdate('SYSTEM_RESET'); // 广播系统重置
                    alert('系统已重置到默认状态，所有用户界面将自动刷新');
                }
            }

            function updateHistoryCount() {
                const count = loadHistory().length;
                $('#historyCount').textContent = count;
            }

            // —— 抽奖次数限制管理 ——
            function loadDrawLimit() {
                try {
                    const limit = localStorage.getItem(LS_KEYS.DRAW_LIMIT);
                    return limit ? parseInt(limit) : 0; // 0表示不限制
                } catch { return 0; }
            }

            function saveDrawLimit(limit) {
                localStorage.setItem(LS_KEYS.DRAW_LIMIT, limit.toString());
            }

            function loadUserDrawCount() {
                try {
                    const count = localStorage.getItem(LS_KEYS.USER_DRAW_COUNT);
                    return count ? parseInt(count) : 0;
                } catch { return 0; }
            }

            function saveUserDrawCount(count) {
                localStorage.setItem(LS_KEYS.USER_DRAW_COUNT, count.toString());
            }

            function updateDrawLimitDisplay() {
                const limit = loadDrawLimit();
                const currentLimitSpan = $('#currentDrawLimit');
                const drawLimitInput = $('#drawLimitInput');

                if (limit === 0) {
                    currentLimitSpan.textContent = '不限制';
                    drawLimitInput.value = '';
                } else {
                    currentLimitSpan.textContent = `${limit} 次`;
                    drawLimitInput.value = limit;
                }

                const userCount = loadUserDrawCount();
                $('#userDrawCount').textContent = `${userCount} 次`;
            }

            function setDrawLimit() {
                const input = $('#drawLimitInput');
                const limit = parseInt(input.value) || 0;

                if (limit < 0) {
                    alert('抽奖次数不能为负数');
                    return;
                }

                if (limit > 9999) {
                    alert('抽奖次数不能超过9999次');
                    return;
                }

                saveDrawLimit(limit);
                updateDrawLimitDisplay();
                broadcastUpdate('DRAW_LIMIT_UPDATE', { limit }); // 广播限制更新

                if (limit === 0) {
                    alert('抽奖次数限制已取消并同步到所有用户');
                } else {
                    alert(`抽奖次数限制已设置为 ${limit} 次并同步到所有用户`);
                }
            }

            function disableDrawLimit() {
                if (confirm('确认取消抽奖次数限制？用户将可以无限制抽奖。')) {
                    saveDrawLimit(0);
                    updateDrawLimitDisplay();
                    broadcastUpdate('DRAW_LIMIT_UPDATE', { limit: 0 }); // 广播限制取消
                    alert('抽奖次数限制已取消并同步到所有用户');
                }
            }

            function resetUserDrawCount() {
                if (confirm('确认重置用户抽奖次数？重置后用户可以重新开始抽奖。')) {
                    saveUserDrawCount(0);
                    updateDrawLimitDisplay();
                    broadcastUpdate('USER_COUNT_RESET'); // 广播用户计数重置
                    alert('用户抽奖次数已重置并同步到所有用户');
                }
            }

            // —— 登录验证相关 ——
            function isLoggedIn() {
                return sessionStorage.getItem(SESSION_KEY) === 'authenticated';
            }

            function login(password) {
                if (password === ADMIN_PASSWORD) {
                    sessionStorage.setItem(SESSION_KEY, 'authenticated');
                    showMainContent();
                    return true;
                }
                return false;
            }

            function logout() {
                sessionStorage.removeItem(SESSION_KEY);
                showLoginOverlay();
            }

            function showLoginOverlay() {
                $('#loginOverlay').classList.remove('hidden');
                $('#mainContent').classList.add('hidden');
                $('#adminPassword').value = '';
                $('#loginError').classList.add('hidden');
                $('#adminPassword').focus();
            }

            function showMainContent() {
                $('#loginOverlay').classList.add('hidden');
                $('#mainContent').classList.remove('hidden');
            }

            // 防暴力破解计数器
            let loginAttempts = 0;
            let lastFailedLogin = 0;
            const MAX_LOGIN_ATTEMPTS = 5;
            const LOCKOUT_TIME = 5 * 60 * 1000; // 5分钟

            function handleLogin() {
                const password = $('#adminPassword').value;
                const errorDiv = $('#loginError');
                const now = Date.now();

                // 检查是否处于锁定状态
                if (loginAttempts >= MAX_LOGIN_ATTEMPTS && (now - lastFailedLogin) < LOCKOUT_TIME) {
                    const remainingTime = Math.ceil((LOCKOUT_TIME - (now - lastFailedLogin)) / 1000 / 60);
                    errorDiv.textContent = `登录已锁定，请${remainingTime}分钟后重试`;
                    errorDiv.classList.remove('hidden');
                    return;
                }

                // 重置锁定状态
                if ((now - lastFailedLogin) >= LOCKOUT_TIME) {
                    loginAttempts = 0;
                }

                if (!password) {
                    errorDiv.textContent = '请输入密码';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                if (login(password)) {
                    errorDiv.classList.add('hidden');
                    // 登录成功，重置失败计数
                    loginAttempts = 0;
                    lastFailedLogin = 0;
                } else {
                    loginAttempts++;
                    lastFailedLogin = now;

                    if (loginAttempts >= MAX_LOGIN_ATTEMPTS) {
                        errorDiv.textContent = `密码错误次数过多，已锁定5分钟`;
                    } else {
                        errorDiv.textContent = `密码错误，还可尝试${MAX_LOGIN_ATTEMPTS - loginAttempts}次`;
                    }
                    errorDiv.classList.remove('hidden');
                    $('#adminPassword').value = '';
                    $('#adminPassword').focus();
                }
            }

            // —— 事件绑定 ——
            function bind() {
                // 登录相关事件
                $('#loginBtn').addEventListener('click', handleLogin);
                $('#logoutBtn').addEventListener('click', () => {
                    if (confirm('确认退出管理系统？')) {
                        logout();
                    }
                });
                $('#adminPassword').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        handleLogin();
                    }
                });

                // 原有功能事件
                $('#savePoolBtn').addEventListener('click', () => {
                    try {
                        const text = $('#poolEditor').value;
                        const pool = textToPool(text);
                        savePool(pool);
                        renderPoolList(pool);
                        broadcastUpdate('POOL_UPDATE', pool); // 广播奖池更新
                        alert('奖池配置已保存并同步到所有用户');
                    } catch (e) {
                        alert('保存失败：' + e.message);
                    }
                });

                $('#reloadBtn').addEventListener('click', () => {
                    refreshPoolEditor();
                    renderPoolList(loadPool());
                    alert('已重新载入当前配置');
                });

                $('#restoreDefaultBtn').addEventListener('click', () => {
                    if (confirm('确认恢复默认奖池配置？当前配置将被覆盖！')) {
                        const defaultPool = structuredClone(DEFAULT_POOL);
                        savePool(defaultPool);
                        refreshPoolEditor();
                        renderPoolList(loadPool());
                        broadcastUpdate('POOL_UPDATE', defaultPool); // 广播奖池更新
                        alert('已恢复默认奖池配置并同步到所有用户');
                    }
                });

                $('#refreshPreviewBtn').addEventListener('click', () => {
                    renderPoolList(loadPool());
                });

                $('#exportHistoryBtn').addEventListener('click', exportHistory);
                $('#clearHistoryBtn').addEventListener('click', clearHistory);
                $('#resetAllBtn').addEventListener('click', resetAll);

                // 抽奖次数限制相关事件
                $('#saveDrawLimitBtn').addEventListener('click', setDrawLimit);
                $('#disableDrawLimitBtn').addEventListener('click', disableDrawLimit);
                $('#resetUserDrawCountBtn').addEventListener('click', resetUserDrawCount);
                $('#drawLimitInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        setDrawLimit();
                    }
                });

                // 成就管理相关事件
                $('#searchUserBtn').addEventListener('click', searchUsers);
                $('#userSearchInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        searchUsers();
                    }
                });
                $('#selectedUser').addEventListener('change', selectUser);
                $('#grantSelectedBtn').addEventListener('click', grantSelectedAchievements);
                $('#revokeSelectedBtn').addEventListener('click', revokeSelectedAchievements);
                $('#grantAllBtn').addEventListener('click', grantAllAchievements);
                $('#resetAllAchievementsBtn').addEventListener('click', resetAllAchievements);
            }

            function init() {
                $('#year').textContent = new Date().getFullYear();

                // 检查登录状态
                if (isLoggedIn()) {
                    showMainContent();
                    // 初始化主界面内容
                    refreshPoolEditor();
                    renderPoolList(loadPool());
                    updateHistoryCount();
                    updateDrawLimitDisplay();
                    updateSyncStatus(); // 更新同步状态显示
                    initAchievementManagement(); // 初始化成就管理
                } else {
                    showLoginOverlay();
                }
            }

            // —— 成就管理功能 ——
            const ACHIEVEMENTS = [
                {
                    id: 'first_draw',
                    name: '初试牛刀',
                    description: '完成第一次抽奖',
                    icon: '🎯',
                    reward: 50,
                    category: 'basic'
                },
                {
                    id: 'draw_master',
                    name: '抽奖达人',
                    description: '累计抽奖10次',
                    icon: '🎮',
                    reward: 200,
                    category: 'basic'
                },
                {
                    id: 'lucky_star',
                    name: '幸运之星',
                    description: '首次中奖',
                    icon: '⭐',
                    reward: 100,
                    category: 'basic'
                },
                {
                    id: 'legendary_hunter',
                    name: '传说猎人',
                    description: '获得传说级奖品',
                    icon: '🏆',
                    reward: 500,
                    category: 'rare'
                },
                {
                    id: 'coin_collector',
                    name: '货币收集者',
                    description: '累计获得100U币',
                    icon: '💰',
                    reward: 300,
                    category: 'basic'
                },
                {
                    id: 'loyal_player',
                    name: '忠实玩家',
                    description: '连续7天参与抽奖',
                    icon: '🔥',
                    reward: 400,
                    category: 'rare'
                },
                {
                    id: 'social_butterfly',
                    name: '社交达人',
                    description: '邀请5位好友',
                    icon: '👥',
                    reward: 600,
                    category: 'friend'
                },
                {
                    id: 'gift_giver',
                    name: '礼物达人',
                    description: '分享礼物10次',
                    icon: '🎁',
                    reward: 350,
                    category: 'friend'
                },
                {
                    id: 'comment_king',
                    name: '留言之王',
                    description: '发表20条留言',
                    icon: '💬',
                    reward: 250,
                    category: 'social'
                },
                {
                    id: 'perfectionist',
                    name: '完美主义者',
                    description: '收集所有稀有以上奖品',
                    icon: '💎',
                    reward: 1000,
                    category: 'rare'
                },
                {
                    id: 'vip_supporter',
                    name: 'VIP支持者',
                    description: '累计积分达到5000',
                    icon: '👑',
                    reward: 800,
                    category: 'rare'
                },
                {
                    id: 'ultimate_collector',
                    name: '终极收藏家',
                    description: '解锁所有成就',
                    icon: '🌟',
                    reward: 2000,
                    category: 'legendary'
                }
            ];

            let selectedUserId = null;
            let currentUserData = null;

            function initAchievementManagement() {
                loadAllUsers();
                renderAchievementsList();
                updateGlobalStats();
            }

            function loadAllUsers() {
                const userSelect = $('#selectedUser');
                const comments = JSON.parse(localStorage.getItem('comments') || '[]');
                const userData = JSON.parse(localStorage.getItem('userData_achievements') || '{}');

                // 清空现有选项
                userSelect.innerHTML = '<option value="">请选择用户...</option>';

                // 获取所有曾经留言的用户
                const userNames = new Set();
                comments.forEach(comment => {
                    if (comment.userName) {
                        userNames.add(comment.userName);
                    }
                });

                // 添加默认VIP用户
                if (userData.name) {
                    userNames.add(userData.name);
                } else {
                    userNames.add('VIP股东');
                }

                // 填充选择框
                Array.from(userNames).sort().forEach(userName => {
                    const option = document.createElement('option');
                    option.value = userName;
                    option.textContent = userName;
                    userSelect.appendChild(option);
                });
            }

            function searchUsers() {
                const searchTerm = $('#userSearchInput').value.trim().toLowerCase();
                const userSelect = $('#selectedUser');

                if (!searchTerm) {
                    alert('请输入搜索关键词');
                    return;
                }

                // 搜索匹配的用户
                Array.from(userSelect.options).forEach(option => {
                    if (option.value.toLowerCase().includes(searchTerm)) {
                        option.selected = true;
                        selectUser();
                        return;
                    }
                });
            }

            function selectUser() {
                const userName = $('#selectedUser').value;
                if (!userName) {
                    hideUserInfo();
                    return;
                }

                selectedUserId = userName;
                loadUserData(userName);
                showUserInfo();
            }

            function loadUserData(userName) {
                // 加载用户数据
                const userData = JSON.parse(localStorage.getItem('userData_achievements') || '{}');
                const history = JSON.parse(localStorage.getItem('lotteryHistory') || '[]');

                if (userName === userData.name || userName === 'VIP股东') {
                    currentUserData = {
                        name: userData.name || 'VIP股东',
                        bio: userData.bio || '🎯 抽奖达人 · 🏆 成就收集者',
                        avatar: userData.avatar || '🧸',
                        achievements: userData.achievements || {},
                        stats: {
                            totalDraws: history.length,
                            totalWins: history.filter(item => item.prize !== '再接再厉').length,
                            points: calculateUserPoints(history, userData.achievements || {})
                        }
                    };
                } else {
                    // 为其他用户创建默认数据
                    currentUserData = {
                        name: userName,
                        bio: '普通用户',
                        avatar: '👤',
                        achievements: {},
                        stats: {
                            totalDraws: 0,
                            totalWins: 0,
                            points: 0
                        }
                    };
                }

                updateUserDisplay();
            }

            function calculateUserPoints(history, achievements) {
                let points = 0;

                // 从抽奖历史计算积分
                history.forEach(item => {
                    if (item.points) {
                        points += item.points;
                    }
                });

                // 添加成就奖励积分
                Object.values(achievements).forEach(achievement => {
                    if (achievement.unlocked) {
                        const achievementData = ACHIEVEMENTS.find(a => a.id === achievement.id);
                        if (achievementData) points += achievementData.reward;
                    }
                });

                return points;
            }

            function updateUserDisplay() {
                if (!currentUserData) return;

                $('#userInfoName').textContent = currentUserData.name;
                $('#userInfoBio').textContent = currentUserData.bio;
                $('#userInfoAvatar').textContent = currentUserData.avatar;
                $('#userTotalDraws').textContent = currentUserData.stats.totalDraws;
                $('#userTotalWins').textContent = currentUserData.stats.totalWins;
                $('#userPoints').textContent = currentUserData.stats.points;

                const unlockedCount = Object.values(currentUserData.achievements).filter(a => a.unlocked).length;
                $('#userAchievements').textContent = `${unlockedCount}/${ACHIEVEMENTS.length}`;

                updateAchievementsDisplay();
                updateButtonStates();
            }

            function updateAchievementsDisplay() {
                const achievementsList = $('#achievementsList');
                achievementsList.innerHTML = '';

                ACHIEVEMENTS.forEach(achievement => {
                    const userAchievement = currentUserData.achievements[achievement.id];
                    const isUnlocked = userAchievement?.unlocked || false;

                    const achievementItem = document.createElement('div');
                    achievementItem.className = `p-3 rounded-lg border-2 cursor-pointer transition-all ${isUnlocked
                        ? 'border-green-300 bg-green-50'
                        : 'border-gray-200 bg-gray-50'
                        }`;

                    achievementItem.innerHTML = `
                    <div class="flex items-center gap-3">
                        <input type="checkbox" class="achievement-checkbox" 
                               data-achievement-id="${achievement.id}" 
                               ${isUnlocked ? 'checked' : ''}>
                        <div class="text-2xl">${achievement.icon}</div>
                        <div class="flex-1">
                            <h5 class="font-medium text-sm">${achievement.name}</h5>
                            <p class="text-xs text-gray-600">${achievement.description}</p>
                            <div class="text-xs text-green-600">+${achievement.reward}积分</div>
                        </div>
                        <div class="text-xs ${isUnlocked ? 'text-green-600' : 'text-gray-400'}">
                            ${isUnlocked ? '✅ 已解锁' : '🔒 未解锁'}
                        </div>
                    </div>
                `;

                    achievementItem.addEventListener('click', (e) => {
                        if (e.target.type !== 'checkbox') {
                            const checkbox = achievementItem.querySelector('.achievement-checkbox');
                            checkbox.checked = !checkbox.checked;
                            updateButtonStates();
                        }
                    });

                    const checkbox = achievementItem.querySelector('.achievement-checkbox');
                    checkbox.addEventListener('change', updateButtonStates);

                    achievementsList.appendChild(achievementItem);
                });
            }

            function updateButtonStates() {
                const selectedCheckboxes = $$('.achievement-checkbox:checked');
                const hasSelection = selectedCheckboxes.length > 0;
                const hasUser = selectedUserId !== null;

                $('#grantSelectedBtn').disabled = !hasSelection || !hasUser;
                $('#revokeSelectedBtn').disabled = !hasSelection || !hasUser;
                $('#grantAllBtn').disabled = !hasUser;
                $('#resetAllAchievementsBtn').disabled = !hasUser;
            }

            function grantSelectedAchievements() {
                const selectedCheckboxes = $$('.achievement-checkbox:checked');
                const achievementIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.achievementId);

                if (achievementIds.length === 0) {
                    alert('请选择要发放的成就');
                    return;
                }

                if (!confirm(`确认为用户"${currentUserData.name}"发放${achievementIds.length}个成就？`)) {
                    return;
                }

                grantAchievements(achievementIds);
            }

            function revokeSelectedAchievements() {
                const selectedCheckboxes = $$('.achievement-checkbox:checked');
                const achievementIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.achievementId);

                if (achievementIds.length === 0) {
                    alert('请选择要撤销的成就');
                    return;
                }

                if (!confirm(`确认撤销用户"${currentUserData.name}"的${achievementIds.length}个成就？`)) {
                    return;
                }

                revokeAchievements(achievementIds);
            }

            function grantAllAchievements() {
                if (!confirm(`确认为用户"${currentUserData.name}"发放所有成就？`)) {
                    return;
                }

                const allAchievementIds = ACHIEVEMENTS.map(a => a.id);
                grantAchievements(allAchievementIds);
            }

            function resetAllAchievements() {
                if (!confirm(`确认重置用户"${currentUserData.name}"的所有成就？此操作不可恢复！`)) {
                    return;
                }

                const allAchievementIds = ACHIEVEMENTS.map(a => a.id);
                revokeAchievements(allAchievementIds);
            }

            function grantAchievements(achievementIds) {
                if (selectedUserId === currentUserData.name || selectedUserId === 'VIP股东') {
                    // 更新主用户数据
                    const userData = JSON.parse(localStorage.getItem('userData_achievements') || '{}');

                    achievementIds.forEach(id => {
                        if (!userData.achievements) userData.achievements = {};
                        userData.achievements[id] = {
                            id: id,
                            unlocked: true,
                            progress: ACHIEVEMENTS.find(a => a.id === id)?.condition?.value || 1,
                            unlockedAt: new Date().toISOString(),
                            adminGranted: true
                        };
                    });

                    localStorage.setItem('userData_achievements', JSON.stringify(userData));
                    currentUserData.achievements = userData.achievements;
                }

                updateUserDisplay();
                broadcastUpdate('ACHIEVEMENT_UPDATE', { userId: selectedUserId, achievements: currentUserData.achievements });
                alert('成就发放成功！');
            }

            function revokeAchievements(achievementIds) {
                if (selectedUserId === currentUserData.name || selectedUserId === 'VIP股东') {
                    // 更新主用户数据
                    const userData = JSON.parse(localStorage.getItem('userData_achievements') || '{}');

                    achievementIds.forEach(id => {
                        if (userData.achievements && userData.achievements[id]) {
                            delete userData.achievements[id];
                        }
                    });

                    localStorage.setItem('userData_achievements', JSON.stringify(userData));
                    currentUserData.achievements = userData.achievements;
                }

                updateUserDisplay();
                broadcastUpdate('ACHIEVEMENT_UPDATE', { userId: selectedUserId, achievements: currentUserData.achievements });
                alert('成就撤销成功！');
            }

            function renderAchievementsList() {
                // 初始渲染，等待用户选择
            }

            function showUserInfo() {
                $('#userInfoSection').classList.remove('hidden');
                $('#achievementGrantSection').classList.remove('hidden');
            }

            function hideUserInfo() {
                $('#userInfoSection').classList.add('hidden');
                $('#achievementGrantSection').classList.add('hidden');
                selectedUserId = null;
                currentUserData = null;
            }

            function updateGlobalStats() {
                const statsContainer = $('#globalAchievementStats');
                const userData = JSON.parse(localStorage.getItem('userData_achievements') || '{}');
                const achievements = userData.achievements || {};

                const totalUsers = 1; // 简化统计，主要针对VIP用户
                const totalAchievements = ACHIEVEMENTS.length;
                const unlockedAchievements = Object.values(achievements).filter(a => a.unlocked).length;
                const completionRate = totalAchievements > 0 ? Math.round((unlockedAchievements / totalAchievements) * 100) : 0;

                statsContainer.innerHTML = `
                <div class="text-center p-3 bg-blue-50 rounded-lg">
                    <div class="text-lg font-bold text-blue-600">${totalUsers}</div>
                    <div class="text-xs text-blue-700">总用户数</div>
                </div>
                <div class="text-center p-3 bg-green-50 rounded-lg">
                    <div class="text-lg font-bold text-green-600">${totalAchievements}</div>
                    <div class="text-xs text-green-700">总成就数</div>
                </div>
                <div class="text-center p-3 bg-yellow-50 rounded-lg">
                    <div class="text-lg font-bold text-yellow-600">${unlockedAchievements}</div>
                    <div class="text-xs text-yellow-700">已解锁成就</div>
                </div>
                <div class="text-center p-3 bg-purple-50 rounded-lg">
                    <div class="text-lg font-bold text-purple-600">${completionRate}%</div>
                    <div class="text-xs text-purple-700">完成度</div>
                </div>
            `;
            }

            // —— 音乐播放器功能 ——
            let musicLibrary = [
                // 默认音乐库，将通过API动态加载
            ];

            // Jamendo API配置
            const JAMENDO_CLIENT_ID = '709fa152'; // 官方测试ID
            const JAMENDO_API_BASE = 'https://api.jamendo.com/v3.0';

            // 检测微信环境
            function isWeChatBrowser() {
                return /micromessenger/i.test(navigator.userAgent);
            }

            async function loadMusicFromAPI() {
                // 微信环境直接使用备用音乐库
                if (isWeChatBrowser()) {
                    console.log('🎵 管理员界面检测到微信环境，使用内置音乐库');
                    musicLibrary = getBackupMusicLibrary();
                    return true;
                }

                try {
                    // 添加超时控制
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 8000); // 8秒超时

                    // 获取流行音乐和电子音乐
                    const [popResponse, electroResponse, rockResponse] = await Promise.all([
                        fetch(`${JAMENDO_API_BASE}/tracks/?client_id=${JAMENDO_CLIENT_ID}&format=json&limit=5&tags=pop&include=musicinfo&audioformat=mp32`, {
                            signal: controller.signal,
                            mode: 'cors'
                        }),
                        fetch(`${JAMENDO_API_BASE}/tracks/?client_id=${JAMENDO_CLIENT_ID}&format=json&limit=3&tags=electronic&include=musicinfo&audioformat=mp32`, {
                            signal: controller.signal,
                            mode: 'cors'
                        }),
                        fetch(`${JAMENDO_API_BASE}/tracks/?client_id=${JAMENDO_CLIENT_ID}&format=json&limit=2&tags=rock&include=musicinfo&audioformat=mp32`, {
                            signal: controller.signal,
                            mode: 'cors'
                        })
                    ]);

                    clearTimeout(timeoutId);

                    if (!popResponse.ok || !electroResponse.ok || !rockResponse.ok) {
                        throw new Error('API请求失败');
                    }

                    const popData = await popResponse.json();
                    const electroData = await electroResponse.json();
                    const rockData = await rockResponse.json();

                    // 合并所有音乐
                    const allTracks = [
                        ...(popData.results || []),
                        ...(electroData.results || []),
                        ...(rockData.results || [])
                    ];

                    if (allTracks.length === 0) {
                        throw new Error('未获取到音乐数据');
                    }

                    // 转换为我们的音乐库格式
                    musicLibrary = allTracks.map(track => ({
                        id: track.id,
                        title: track.name || 'Unknown Title',
                        artist: track.artist_name || 'Unknown Artist',
                        album: track.album_name || 'Unknown Album',
                        url: track.audio || track.audiodownload,
                        duration: formatDuration(track.duration),
                        image: track.album_image || track.image,
                        jamendoUrl: `https://www.jamendo.com/track/${track.id}`
                    }));

                    console.log('🎵 管理员界面已加载', musicLibrary.length, '首免费音乐');
                    return true;
                } catch (error) {
                    console.error('❌ 管理员界面加载音乐失败:', error);
                    // 使用备用音乐库
                    musicLibrary = getBackupMusicLibrary();
                    return false;
                }
            }

            // 备用音乐库（如果API失败）
            function getBackupMusicLibrary() {
                return [
                    {
                        title: "Admin Music 1",
                        artist: "System Sound",
                        album: "Background Tracks",
                        url: "",
                        duration: "3:24",
                        image: "",
                        jamendoUrl: "#"
                    },
                    {
                        title: "Admin Music 2",
                        artist: "System Sound",
                        album: "Background Tracks",
                        url: "",
                        duration: "4:12",
                        image: "",
                        jamendoUrl: "#"
                    }
                ];
            }

            // 时长格式化
            function formatDuration(seconds) {
                if (!seconds) return "0:00";
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            let currentSongIndex = 0;
            let isPlaying = false;
            let currentAudio = null;
            let isPlayerMinimized = true; // 默认最小化

            async function initMusicPlayer() {
                try {
                    // 先加载音乐库
                    const loadSuccess = await loadMusicFromAPI();
                    if (loadSuccess) {
                        console.log('🎵 管理员界面成功加载Jamendo音乐库');
                    } else {
                        console.log('🎵 管理员界面使用备用音乐库');
                    }

                    renderPlaylist();
                    if (musicLibrary.length > 0) {
                        loadSong(0);
                    }

                    // 确保DOM元素存在后再初始化
                    const content = $('#playerContent');
                    const minimized = $('#playerMinimized');
                    const icon = $('#playerToggleIcon');

                    if (content && minimized && icon) {
                        // 初始化为最小化状态
                        content.classList.add('hidden');
                        minimized.classList.remove('hidden');
                        icon.textContent = '🔼';
                    } else {
                        console.warn('🎵 管理员音乐播放器DOM元素未找到');
                    }

                    // 安全地绑定播放器控制事件
                    const togglePlayer = $('#togglePlayer');
                    const playPauseBtn = $('#playPauseBtn');
                    const miniPlayPause = $('#miniPlayPause');
                    const prevBtn = $('#prevBtn');
                    const nextBtn = $('#nextBtn');

                    if (togglePlayer) togglePlayer.addEventListener('click', togglePlayerSize);
                    if (playPauseBtn) playPauseBtn.addEventListener('click', togglePlayPause);
                    if (miniPlayPause) miniPlayPause.addEventListener('click', togglePlayPause);
                    if (prevBtn) prevBtn.addEventListener('click', previousSong);
                    if (nextBtn) nextBtn.addEventListener('click', nextSong);

                    console.log('🎵 管理员音乐播放器初始化完成');
                } catch (error) {
                    console.error('🎵 管理员音乐播放器初始化失败:', error);
                }
            }

            function renderPlaylist() {
                const playlist = $('#playlist');
                if (!playlist) return;

                playlist.innerHTML = '';

                if (musicLibrary.length === 0) {
                    playlist.innerHTML = '<div class="text-xs text-slate-500 p-2">🎵 正在加载音乐...</div>';
                    return;
                }

                musicLibrary.forEach((song, index) => {
                    const songItem = document.createElement('div');
                    songItem.className = `cursor-pointer p-2 rounded text-xs hover:bg-slate-100 transition-colors ${index === currentSongIndex ? 'bg-[var(--labu)] text-white' : ''}`;
                    songItem.innerHTML = `
                        <div class="font-medium truncate">${song.title}</div>
                        <div class="text-xs opacity-75 truncate">${song.artist}</div>
                        <div class="text-xs opacity-60 truncate">${song.duration || ''}</div>
                    `;
                    songItem.addEventListener('click', () => loadSong(index));
                    playlist.appendChild(songItem);
                });
            }

            // 旧的loadSong函数已被上面的真实音频版本替代

            function togglePlayerSize() {
                isPlayerMinimized = !isPlayerMinimized;
                const content = $('#playerContent');
                const minimized = $('#playerMinimized');
                const icon = $('#playerToggleIcon');

                if (isPlayerMinimized) {
                    content.classList.add('hidden');
                    minimized.classList.remove('hidden');
                    icon.textContent = '🔼';
                } else {
                    content.classList.remove('hidden');
                    minimized.classList.add('hidden');
                    icon.textContent = '🔽';
                }
            }

            // 旧的播放控制函数已被上面的真实音频版本替代

            // 真实音频播放功能
            function loadSong(index) {
                if (!musicLibrary || musicLibrary.length === 0) return;

                currentSongIndex = index;
                const song = musicLibrary[index];

                // 停止当前播放
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }

                // 更新UI
                const currentSongEl = $('#currentSong');
                const currentArtistEl = $('#currentArtist');
                const miniSongNameEl = $('#miniSongName');
                const totalTimeEl = $('#totalTime');

                if (currentSongEl) currentSongEl.textContent = song.title;
                if (currentArtistEl) currentArtistEl.textContent = song.artist;
                if (miniSongNameEl) miniSongNameEl.textContent = `${song.title} - ${song.artist}`;
                if (totalTimeEl) totalTimeEl.textContent = song.duration || "0:00";

                // 创建新的音频对象
                if (song.url && song.url !== '') {
                    currentAudio = new Audio(song.url);
                    currentAudio.crossOrigin = "anonymous";

                    // 音频加载完成
                    currentAudio.addEventListener('loadeddata', () => {
                        console.log('🎵 管理员音频已加载:', song.title);
                        if (totalTimeEl) {
                            totalTimeEl.textContent = formatDuration(currentAudio.duration);
                        }
                    });

                    // 播放时更新进度
                    currentAudio.addEventListener('timeupdate', updateProgress);

                    // 播放结束自动下一首
                    currentAudio.addEventListener('ended', () => {
                        nextSong();
                    });

                    // 错误处理
                    currentAudio.addEventListener('error', (e) => {
                        console.warn('🎵 管理员音频加载失败:', song.title, e);
                        nextSong();
                    });
                } else {
                    console.warn('🎵 无有效音频URL:', song.title);
                }

                renderPlaylist();
                isPlaying = false;
                updatePlayButtons();
            }

            function togglePlayPause() {
                if (!currentAudio) {
                    console.warn('🎵 没有可播放的音频');
                    return;
                }

                if (isPlaying) {
                    currentAudio.pause();
                    isPlaying = false;
                } else {
                    const playPromise = currentAudio.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            isPlaying = true;
                        }).catch(error => {
                            console.error('🎵 播放失败:', error);
                        });
                    }
                }

                updatePlayButtons();
            }

            function updatePlayButtons() {
                const playBtn = $('#playPauseBtn');
                const miniBtn = $('#miniPlayPause');

                if (playBtn) playBtn.textContent = isPlaying ? '⏸️' : '▶️';
                if (miniBtn) miniBtn.textContent = isPlaying ? '⏸️' : '▶️';
            }

            function previousSong() {
                if (musicLibrary.length === 0) return;
                currentSongIndex = (currentSongIndex - 1 + musicLibrary.length) % musicLibrary.length;
                loadSong(currentSongIndex);
                if (isPlaying && currentAudio) {
                    currentAudio.play().catch(console.error);
                }
            }

            function nextSong() {
                if (musicLibrary.length === 0) return;
                currentSongIndex = (currentSongIndex + 1) % musicLibrary.length;
                loadSong(currentSongIndex);
                if (isPlaying && currentAudio) {
                    currentAudio.play().catch(console.error);
                }
            }

            // 更新播放进度
            function updateProgress() {
                if (!currentAudio) return;

                const currentTime = currentAudio.currentTime;
                const duration = currentAudio.duration;

                if (duration) {
                    const progress = (currentTime / duration) * 100;
                    const progressBar = $('#progressBar');
                    const currentTimeEl = $('#currentTime');

                    if (progressBar) progressBar.style.width = progress + '%';
                    if (currentTimeEl) currentTimeEl.textContent = formatDuration(currentTime);
                }
            }

            let progressInterval;
            let currentTime = 0;

            function startProgressSimulation() {
                currentTime = 0;
                progressInterval = setInterval(() => {
                    currentTime += 1;
                    const minutes = Math.floor(currentTime / 60);
                    const seconds = currentTime % 60;
                    $('#currentTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

                    // 模拟进度条（总长度225秒 = 3分45秒）
                    const progress = (currentTime / 225) * 100;
                    $('#progressBar').style.width = Math.min(progress, 100) + '%';

                    // 歌曲结束自动下一首
                    if (currentTime >= 225) {
                        nextSong();
                    }
                }, 1000);
            }

            function stopProgressSimulation() {
                if (progressInterval) {
                    clearInterval(progressInterval);
                }
            }

            // 更新初始化函数
            const originalAdminInit = init;

            function init() {
                $('#year').textContent = new Date().getFullYear();

                // 检查登录状态
                if (isLoggedIn()) {
                    showMainContent();
                    // 初始化主界面内容
                    refreshPoolEditor();
                    renderPoolList(loadPool());
                    updateHistoryCount();
                    updateDrawLimitDisplay();
                    updateSyncStatus(); // 更新同步状态显示
                    // 音乐播放器初始化移到下面的主init函数中
                } else {
                    showLoginOverlay();
                }
            }

            // —— 自定义鼠标和交互效果 ——
            function initCustomCursor() {
                const cursor = $('.custom-cursor');
                let mouseX = 0, mouseY = 0;

                document.addEventListener('mousemove', (e) => {
                    mouseX = e.clientX;
                    mouseY = e.clientY;
                    cursor.style.left = mouseX + 'px';
                    cursor.style.top = mouseY + 'px';

                    createCursorTrail(mouseX, mouseY);
                });

                document.addEventListener('mousedown', () => {
                    cursor.classList.add('clicking');
                });

                document.addEventListener('mouseup', () => {
                    cursor.classList.remove('clicking');
                });
            }

            function createCursorTrail(x, y) {
                const trail = document.createElement('div');
                trail.className = 'cursor-trail';
                trail.style.left = (x - 4) + 'px';
                trail.style.top = (y - 4) + 'px';
                document.body.appendChild(trail);

                setTimeout(() => {
                    if (document.body.contains(trail)) {
                        document.body.removeChild(trail);
                    }
                }, 500);
            }

            function initButtonEffects() {
                document.querySelectorAll('.enhanced-btn').forEach(button => {
                    button.addEventListener('click', createRipple);
                });
            }

            function createRipple(event) {
                const button = event.currentTarget;
                const rect = button.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = event.clientX - rect.left - size / 2;
                const y = event.clientY - rect.top - size / 2;

                const ripple = document.createElement('div');
                ripple.className = 'btn-ripple';
                ripple.style.width = ripple.style.height = size + 'px';
                ripple.style.left = x + 'px';
                ripple.style.top = y + 'px';

                button.appendChild(ripple);

                setTimeout(() => {
                    if (button.contains(ripple)) {
                        button.removeChild(ripple);
                    }
                }, 600);
            }

            // 更新admin初始化函数
            const originalAdminInit2 = init;

            function init() {
                $('#year').textContent = new Date().getFullYear();

                // 检查登录状态
                if (isLoggedIn()) {
                    showMainContent();
                    // 初始化主界面内容
                    refreshPoolEditor();
                    renderPoolList(loadPool());
                    updateHistoryCount();
                    updateDrawLimitDisplay();
                    updateSyncStatus(); // 更新同步状态显示
                    initMusicPlayer(); // 初始化音乐播放器

                    // 初始化交互效果
                    setTimeout(() => {
                        initCustomCursor();
                        initButtonEffects();
                    }, 100);
                } else {
                    showLoginOverlay();
                    // 为登录界面也初始化交互效果
                    setTimeout(() => {
                        initCustomCursor();
                        initButtonEffects();
                    }, 100);
                }
            }

            bind();
            init();
        } // 关闭条款检查的else块
    </script>
</body>

</html>