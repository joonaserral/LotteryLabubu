<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>å¥–æ± ç®¡ç† - Labubu å¹¸è¿æŠ½å¥–</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --labu: #6b5b95;
            --labu2: #ffcc00;
        }

        body {
            font-family: 'Zen Maru Gothic', system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans SC', 'PingFang SC', 'Microsoft Yahei', sans-serif;
        }

        .labu-gradient {
            background-image: linear-gradient(135deg, rgba(107, 91, 149, .12), rgba(255, 204, 0, .12));
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900">
    <!-- ç™»å½•ç•Œé¢ -->
    <div id="loginOverlay" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="bg-white rounded-3xl shadow-2xl p-8 mx-4 w-full max-w-md">
            <div class="text-center mb-6">
                <div
                    class="w-16 h-16 rounded-2xl bg-[var(--labu)] grid place-content-center text-white text-2xl mx-auto mb-4">
                    ğŸ”’</div>
                <h2 class="text-2xl font-bold text-slate-900">ç®¡ç†å‘˜éªŒè¯</h2>
                <p class="text-slate-600 mt-2">è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ä»¥è®¿é—®ç³»ç»Ÿ</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="adminPassword" class="block text-sm font-medium text-slate-700 mb-2">ç®¡ç†å‘˜å¯†ç </label>
                    <input type="password" id="adminPassword"
                        class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:border-[var(--labu)] focus:ring-2 focus:ring-[var(--labu)]/20 focus:outline-none transition-colors"
                        placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                <button id="loginBtn"
                    class="w-full px-4 py-3 rounded-xl bg-[var(--labu)] text-white font-medium hover:opacity-90 transition-opacity">
                    è¿›å…¥ç®¡ç†ç³»ç»Ÿ
                </button>
                <div class="text-center">
                    <a href="index.html" class="text-sm text-slate-500 hover:text-slate-700">è¿”å›æŠ½å¥–é¡µé¢</a>
                </div>
            </div>
            <div id="loginError" class="mt-4 text-sm text-red-600 text-center hidden"></div>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢å†…å®¹ -->
    <div id="mainContent" class="hidden">
        <!-- é¡¶éƒ¨æ  -->
        <header class="sticky top-0 z-10 backdrop-blur bg-white/60 border-b border-slate-200">
            <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-xl bg-[var(--labu)] grid place-content-center text-white text-xl">ğŸ¦Š
                    </div>
                    <h1 class="font-bold text-lg">å¥–æ± ç®¡ç†ç³»ç»Ÿ</h1>
                </div>
                <nav class="text-sm flex items-center gap-3">
                    <a href="index.html" class="hover:underline">è¿”å›æŠ½å¥–</a>
                    <button id="logoutBtn" class="text-red-600 hover:underline">ç™»å‡º</button>
                </nav>
            </div>
        </header>

        <!-- Hero -->
        <section class="labu-gradient">
            <div class="max-w-5xl mx-auto px-4 py-10">
                <div class="text-center">
                    <h2 class="text-3xl md:text-4xl font-extrabold leading-tight">å¥–æ± é…ç½®ç®¡ç†</h2>
                    <p class="mt-3 text-slate-700">ç®¡ç†å‘˜ä¸“ç”¨ç•Œé¢ï¼Œç”¨äºé…ç½®å’Œç®¡ç†æŠ½å¥–å¥–æ± è®¾ç½®</p>
                </div>
            </div>
        </section>

        <!-- ä¸»è¦å†…å®¹ -->
        <main class="max-w-5xl mx-auto px-4 py-10">
            <div class="grid lg:grid-cols-2 gap-8">
                <!-- å¥–æ± è®¾ç½® -->
                <section>
                    <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
                        <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                            <h3 class="font-semibold">å¥–æ± é…ç½®ç¼–è¾‘</h3>
                            <div class="text-xs text-slate-500">é…ç½®å°†ä¿å­˜åˆ°æœ¬åœ°æµè§ˆå™¨</div>
                        </div>
                        <div class="p-5 grid gap-4">
                            <div class="text-sm text-slate-600">
                                <div class="mb-2">æ¯è¡Œä¸€ä¸ªå¥–å“ï¼Œå­—æ®µä½¿ç”¨é€—å·åˆ†éš”ï¼š<code>name,type,weight,quantity</code></div>
                                <ul class="text-xs space-y-1 text-slate-500">
                                    <li>â€¢ <b>name</b>: å¥–å“åç§°</li>
                                    <li>â€¢ <b>type</b>: å¥–å“ç±»å‹ï¼Œä»…æ”¯æŒï¼š<b>æŠµæ‰£åˆ¸</b>ï½œ<b>å®ä½“</b>ï½œ<b>æŠ˜æ‰£åˆ¸</b></li>
                                    <li>â€¢ <b>weight</b>: æƒé‡æ•°å€¼ï¼Œæ•°å€¼è¶Šå¤§è¶Šå®¹æ˜“æŠ½ä¸­</li>
                                    <li>â€¢ <b>quantity</b>: åº“å­˜æ•°é‡ï¼Œç•™ç©ºæˆ– -1 è¡¨ç¤ºä¸é™é‡</li>
                                </ul>
                            </div>
                            <textarea id="poolEditor" rows="12"
                                class="w-full rounded-xl border border-slate-300 p-3 font-mono text-xs"></textarea>
                            <div class="flex gap-3 flex-wrap">
                                <button id="savePoolBtn"
                                    class="px-4 py-2 rounded-xl bg-[var(--labu)] text-white font-medium hover:opacity-90">ä¿å­˜å¥–æ± </button>
                                <button id="reloadBtn"
                                    class="px-4 py-2 rounded-xl bg-slate-100 border border-slate-200 hover:bg-slate-200">é‡æ–°è½½å…¥</button>
                                <button id="restoreDefaultBtn"
                                    class="px-4 py-2 rounded-xl bg-orange-100 text-orange-700 border border-orange-200 hover:bg-orange-200">æ¢å¤é»˜è®¤</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- å½“å‰å¥–æ± é¢„è§ˆ -->
                <section>
                    <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
                        <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                            <h3 class="font-semibold">å½“å‰å¥–æ± é¢„è§ˆ</h3>
                            <button id="refreshPreviewBtn"
                                class="text-xs px-2 py-1 rounded-lg bg-slate-100 border border-slate-200">åˆ·æ–°é¢„è§ˆ</button>
                        </div>
                        <div class="p-5">
                            <ul id="poolList" class="text-sm grid gap-2"></ul>
                            <div id="poolStats" class="mt-4 p-3 rounded-lg bg-slate-50 text-xs text-slate-600"></div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- æŠ½å¥–æ§åˆ¶ -->
            <section class="mt-10">
                <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
                    <div class="p-5 border-b border-slate-100">
                        <h3 class="font-semibold">æŠ½å¥–æ§åˆ¶è®¾ç½®</h3>
                    </div>
                    <div class="p-5 grid md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-medium mb-3">æŠ½å¥–æ¬¡æ•°é™åˆ¶</h4>
                            <div class="space-y-3">
                                <div>
                                    <label for="drawLimitInput"
                                        class="block text-sm font-medium text-slate-700 mb-1">æ¯ç”¨æˆ·æœ€å¤§æŠ½å¥–æ¬¡æ•°</label>
                                    <input type="number" id="drawLimitInput" min="1" max="9999"
                                        class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:border-[var(--labu)] focus:ring-2 focus:ring-[var(--labu)]/20 focus:outline-none"
                                        placeholder="è¾“å…¥æ¬¡æ•°é™åˆ¶ï¼ˆ0è¡¨ç¤ºä¸é™åˆ¶ï¼‰">
                                </div>
                                <div class="flex gap-3">
                                    <button id="saveDrawLimitBtn"
                                        class="px-4 py-2 rounded-xl bg-[var(--labu)] text-white font-medium hover:opacity-90">ä¿å­˜è®¾ç½®</button>
                                    <button id="disableDrawLimitBtn"
                                        class="px-4 py-2 rounded-xl bg-slate-100 border border-slate-200 hover:bg-slate-200">å–æ¶ˆé™åˆ¶</button>
                                </div>
                                <div class="text-xs text-slate-500">
                                    å½“å‰é™åˆ¶ï¼š<span id="currentDrawLimit">æœªè®¾ç½®</span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-medium mb-3">ç”¨æˆ·æŠ½å¥–ç»Ÿè®¡</h4>
                            <div class="space-y-3">
                                <div class="p-3 rounded-lg bg-slate-50 text-sm">
                                    <div class="flex justify-between">
                                        <span>å½“å‰ç”¨æˆ·å·²æŠ½å¥–ï¼š</span>
                                        <span class="font-medium" id="userDrawCount">0 æ¬¡</span>
                                    </div>
                                </div>
                                <div class="p-3 rounded-lg bg-green-50 text-sm">
                                    <div class="flex justify-between">
                                        <span>ğŸŸ¢ å®æ—¶åŒæ­¥çŠ¶æ€ï¼š</span>
                                        <span class="font-medium text-green-600" id="syncStatus">å·²è¿æ¥</span>
                                    </div>
                                    <div class="text-xs text-slate-500 mt-1">ç®¡ç†å‘˜ä¿®æ”¹å°†å®æ—¶æ¨é€åˆ°æ‰€æœ‰ç”¨æˆ·</div>
                                </div>
                                <button id="resetUserDrawCountBtn"
                                    class="w-full px-4 py-2 rounded-xl bg-orange-100 text-orange-700 border border-orange-200 hover:bg-orange-200">é‡ç½®ç”¨æˆ·æŠ½å¥–æ¬¡æ•°</button>
                                <div class="text-xs text-slate-500">é‡ç½®åç”¨æˆ·å¯ä»¥é‡æ–°å¼€å§‹æŠ½å¥–</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- æ•°æ®ç®¡ç† -->
            <section class="mt-10">
                <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
                    <div class="p-5 border-b border-slate-100">
                        <h3 class="font-semibold">æ•°æ®ç®¡ç†</h3>
                    </div>
                    <div class="p-5 grid md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-medium mb-3">æŠ½å¥–è®°å½•ç®¡ç†</h4>
                            <div class="flex gap-3 flex-wrap">
                                <button id="exportHistoryBtn"
                                    class="px-4 py-2 rounded-xl bg-green-100 text-green-700 border border-green-200 hover:bg-green-200">å¯¼å‡ºæŠ½å¥–è®°å½•</button>
                                <button id="clearHistoryBtn"
                                    class="px-4 py-2 rounded-xl bg-red-100 text-red-700 border border-red-200 hover:bg-red-200">æ¸…ç©ºæŠ½å¥–è®°å½•</button>
                            </div>
                            <div class="mt-2 text-xs text-slate-500">å½“å‰è®°å½•æ•°ï¼š<span id="historyCount">0</span></div>
                        </div>
                        <div>
                            <h4 class="font-medium mb-3">ç³»ç»Ÿé‡ç½®</h4>
                            <div class="flex gap-3 flex-wrap">
                                <button id="resetAllBtn"
                                    class="px-4 py-2 rounded-xl bg-red-100 text-red-700 border border-red-200 hover:bg-red-200">å®Œå…¨é‡ç½®</button>
                            </div>
                            <div class="mt-2 text-xs text-slate-500">å°†æ¸…ç©ºæ‰€æœ‰æ•°æ®å¹¶æ¢å¤é»˜è®¤å¥–æ± </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="max-w-5xl mx-auto px-4 py-10 text-center text-xs text-slate-500">
            <div>Â© <span id="year"></span> Labubu æŠ½å¥–ç®¡ç†ç³»ç»Ÿ</div>
        </footer>
    </div> <!-- ä¸»ç•Œé¢å†…å®¹ç»“æŸ -->

    <script>
        // â€”â€” é…ç½®å¸¸é‡ â€”â€”
        const ADMIN_PASSWORD = '123';
        const SESSION_KEY = 'labubu_admin_session';

        // â€”â€” æœ¬åœ°å­˜å‚¨é”® â€”â€”
        const LS_KEYS = {
            HISTORY: 'labubu_lottery_history',
            POOL: 'labubu_lottery_pool',
            DRAW_LIMIT: 'labubu_draw_limit',
            USER_DRAW_COUNT: 'labubu_user_draw_count'
        };

        // â€”â€” æ•°æ®åŒæ­¥å¹¿æ’­ â€”â€”
        const dataChannel = new BroadcastChannel('labubu_data_sync');

        function broadcastUpdate(type, data = null) {
            const message = {
                type: type,
                data: data,
                timestamp: Date.now(),
                source: 'admin'
            };
            dataChannel.postMessage(message);
            console.log('ğŸ“¡ å¹¿æ’­æ›´æ–°:', type);
            showBroadcastNotification(type);
        }

        function showBroadcastNotification(type) {
            const typeNames = {
                'POOL_UPDATE': 'å¥–æ± é…ç½®',
                'DRAW_LIMIT_UPDATE': 'æŠ½å¥–é™åˆ¶',
                'USER_COUNT_RESET': 'ç”¨æˆ·è®¡æ•°é‡ç½®',
                'SYSTEM_RESET': 'ç³»ç»Ÿé‡ç½®',
                'HISTORY_CLEARED': 'è®°å½•æ¸…ç©º'
            };

            const notification = document.createElement('div');
            notification.className = 'fixed top-20 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm transition-all duration-300';
            notification.innerHTML = `ğŸ“¡ ${typeNames[type] || type} å·²æ¨é€åˆ°æ‰€æœ‰ç”¨æˆ·`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 2000);
        }

        // â€”â€” é»˜è®¤å¥–æ± ï¼ˆå¯ç¼–è¾‘ï¼‰â€”â€”
        const DEFAULT_POOL = [
            { name: 'Â¥20 æŠµæ‰£åˆ¸', type: 'æŠµæ‰£åˆ¸', weight: 25, quantity: -1 },
            { name: 'Â¥50 æŠµæ‰£åˆ¸', type: 'æŠµæ‰£åˆ¸', weight: 15, quantity: -1 },
            { name: '9æŠ˜ä¼˜æƒ åˆ¸', type: 'æŠ˜æ‰£åˆ¸', weight: 18, quantity: -1 },
            { name: '95æŠ˜ä¼˜æƒ åˆ¸', type: 'æŠ˜æ‰£åˆ¸', weight: 22, quantity: -1 },
            { name: 'Labubu é™é‡æ‰‹åŠï¼ˆå®ä½“ï¼‰', type: 'å®ä½“', weight: 3, quantity: 5 },
            { name: 'Labubu ä¸»é¢˜è´´çº¸åŒ…ï¼ˆå®ä½“ï¼‰', type: 'å®ä½“', weight: 7, quantity: 50 },
            { name: 'å¥¶èŒ¶ä¸€æ¯ï¼ˆå®ä½“ï¼‰', type: 'å®ä½“', weight: 12, quantity: 30 },
            { name: 'çƒ¤è‚‰åˆ¸ï¼ˆå®ä½“ï¼‰', type: 'å®ä½“', weight: 8, quantity: 20 },
            { name: 'ç²¾å“å¥¶èŒ¶åˆ¸ï¼ˆå®ä½“ï¼‰', type: 'å®ä½“', weight: 5, quantity: 15 },
            { name: 'å†æ¥å†å‰', type: 'æŠ˜æ‰£åˆ¸', weight: 10, quantity: -1, note: 'æœªä¸­å¥–æç¤ºï¼Œå¯è‡ªå®šä¹‰' }
        ];

        // â€”â€” å·¥å…·å‡½æ•° â€”â€”
        const $ = (sel) => document.querySelector(sel);

        function loadHistory() {
            try { return JSON.parse(localStorage.getItem(LS_KEYS.HISTORY)) || []; } catch { return []; }
        }
        function saveHistory(arr) { localStorage.setItem(LS_KEYS.HISTORY, JSON.stringify(arr)); }
        function loadPool() {
            try {
                const raw = localStorage.getItem(LS_KEYS.POOL);
                return raw ? JSON.parse(raw) : structuredClone(DEFAULT_POOL);
            } catch { return structuredClone(DEFAULT_POOL); }
        }
        function savePool(pool) { localStorage.setItem(LS_KEYS.POOL, JSON.stringify(pool)); }

        function poolToText(pool) {
            return pool.map(p => [p.name, p.type, p.weight, (p.quantity ?? -1)].join(',')).join('\n');
        }
        function textToPool(txt) {
            return txt.split(/\n+/).map(l => l.trim()).filter(Boolean).map((line, i) => {
                const [name, type, weightStr, qtyStr] = line.split(',').map(s => s?.trim());
                const weight = Number(weightStr);
                const quantity = (qtyStr === undefined || qtyStr === '') ? -1 : Number(qtyStr);
                if (!name || !['æŠµæ‰£åˆ¸', 'å®ä½“', 'æŠ˜æ‰£åˆ¸'].includes(type) || !Number.isFinite(weight)) {
                    throw new Error(`ç¬¬ ${i + 1} è¡Œæ ¼å¼ä¸æ­£ç¡®ï¼š${line}`);
                }
                return { name, type, weight, quantity };
            });
        }

        function renderPoolList(pool) {
            const ul = $('#poolList');
            ul.innerHTML = '';
            const totalW = pool.reduce((s, p) => s + Math.max(0, p.weight || 0), 0) || 1;

            pool.forEach(p => {
                const left = p.quantity === -1 ? 'âˆ' : p.quantity;
                const w = p.weight || 0;
                const pct = ((w / totalW) * 100).toFixed(1);
                const color = p.type === 'å®ä½“' ? 'bg-emerald-50 text-emerald-700 border-emerald-200' :
                    (p.type === 'æŠµæ‰£åˆ¸' ? 'bg-indigo-50 text-indigo-700 border-indigo-200' : 'bg-amber-50 text-amber-700 border-amber-200');

                const li = document.createElement('li');
                li.className = `border rounded-xl p-3 ${color}`;
                li.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="font-medium">${p.name}</div>
                        <span class="text-xs px-2 py-0.5 rounded-lg bg-white/60 border">${p.type}</span>
                    </div>
                    <div class="text-xs mt-1 flex justify-between">
                        <span>æƒé‡: ${w} (â‰ˆ${pct}%)</span>
                        <span>å‰©ä½™: <b>${left}</b></span>
                    </div>
                `;
                ul.appendChild(li);
            });

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            const stats = $('#poolStats');
            const totalItems = pool.length;
            const totalWeight = totalW;
            const physicalItems = pool.filter(p => p.type === 'å®ä½“').length;
            stats.innerHTML = `æ€»è®¡ ${totalItems} ç§å¥–å“ | æ€»æƒé‡: ${totalWeight} | å®ä½“å¥–å“: ${physicalItems} ç§`;
        }

        function refreshPoolEditor() {
            const pool = loadPool();
            $('#poolEditor').value = poolToText(pool);
        }

        function exportHistory() {
            const history = loadHistory();
            const data = JSON.stringify(history, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `labubu_lottery_history_${Date.now()}.json`;
            a.click();
        }

        function clearHistory() {
            if (confirm('ç¡®è®¤æ¸…ç©ºæ‰€æœ‰æŠ½å¥–è®°å½•ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                saveHistory([]);
                updateHistoryCount();
                broadcastUpdate('HISTORY_CLEARED'); // å¹¿æ’­è®°å½•æ¸…ç©ºï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰
                alert('æŠ½å¥–è®°å½•å·²æ¸…ç©º');
            }
        }

        function resetAll() {
            if (confirm('ç¡®è®¤å®Œå…¨é‡ç½®ç³»ç»Ÿï¼Ÿè¿™å°†æ¸…ç©ºæ‰€æœ‰æ•°æ®å¹¶æ¢å¤é»˜è®¤å¥–æ± ï¼')) {
                localStorage.removeItem(LS_KEYS.HISTORY);
                localStorage.removeItem(LS_KEYS.POOL);
                localStorage.removeItem(LS_KEYS.DRAW_LIMIT);
                localStorage.removeItem(LS_KEYS.USER_DRAW_COUNT);
                refreshPoolEditor();
                renderPoolList(loadPool());
                updateHistoryCount();
                updateDrawLimitDisplay();
                broadcastUpdate('SYSTEM_RESET'); // å¹¿æ’­ç³»ç»Ÿé‡ç½®
                alert('ç³»ç»Ÿå·²é‡ç½®åˆ°é»˜è®¤çŠ¶æ€ï¼Œæ‰€æœ‰ç”¨æˆ·ç•Œé¢å°†è‡ªåŠ¨åˆ·æ–°');
            }
        }

        function updateHistoryCount() {
            const count = loadHistory().length;
            $('#historyCount').textContent = count;
        }

        // â€”â€” æŠ½å¥–æ¬¡æ•°é™åˆ¶ç®¡ç† â€”â€”
        function loadDrawLimit() {
            try {
                const limit = localStorage.getItem(LS_KEYS.DRAW_LIMIT);
                return limit ? parseInt(limit) : 0; // 0è¡¨ç¤ºä¸é™åˆ¶
            } catch { return 0; }
        }

        function saveDrawLimit(limit) {
            localStorage.setItem(LS_KEYS.DRAW_LIMIT, limit.toString());
        }

        function loadUserDrawCount() {
            try {
                const count = localStorage.getItem(LS_KEYS.USER_DRAW_COUNT);
                return count ? parseInt(count) : 0;
            } catch { return 0; }
        }

        function saveUserDrawCount(count) {
            localStorage.setItem(LS_KEYS.USER_DRAW_COUNT, count.toString());
        }

        function updateDrawLimitDisplay() {
            const limit = loadDrawLimit();
            const currentLimitSpan = $('#currentDrawLimit');
            const drawLimitInput = $('#drawLimitInput');

            if (limit === 0) {
                currentLimitSpan.textContent = 'ä¸é™åˆ¶';
                drawLimitInput.value = '';
            } else {
                currentLimitSpan.textContent = `${limit} æ¬¡`;
                drawLimitInput.value = limit;
            }

            const userCount = loadUserDrawCount();
            $('#userDrawCount').textContent = `${userCount} æ¬¡`;
        }

        function setDrawLimit() {
            const input = $('#drawLimitInput');
            const limit = parseInt(input.value) || 0;

            if (limit < 0) {
                alert('æŠ½å¥–æ¬¡æ•°ä¸èƒ½ä¸ºè´Ÿæ•°');
                return;
            }

            if (limit > 9999) {
                alert('æŠ½å¥–æ¬¡æ•°ä¸èƒ½è¶…è¿‡9999æ¬¡');
                return;
            }

            saveDrawLimit(limit);
            updateDrawLimitDisplay();
            broadcastUpdate('DRAW_LIMIT_UPDATE', { limit }); // å¹¿æ’­é™åˆ¶æ›´æ–°

            if (limit === 0) {
                alert('æŠ½å¥–æ¬¡æ•°é™åˆ¶å·²å–æ¶ˆå¹¶åŒæ­¥åˆ°æ‰€æœ‰ç”¨æˆ·');
            } else {
                alert(`æŠ½å¥–æ¬¡æ•°é™åˆ¶å·²è®¾ç½®ä¸º ${limit} æ¬¡å¹¶åŒæ­¥åˆ°æ‰€æœ‰ç”¨æˆ·`);
            }
        }

        function disableDrawLimit() {
            if (confirm('ç¡®è®¤å–æ¶ˆæŠ½å¥–æ¬¡æ•°é™åˆ¶ï¼Ÿç”¨æˆ·å°†å¯ä»¥æ— é™åˆ¶æŠ½å¥–ã€‚')) {
                saveDrawLimit(0);
                updateDrawLimitDisplay();
                broadcastUpdate('DRAW_LIMIT_UPDATE', { limit: 0 }); // å¹¿æ’­é™åˆ¶å–æ¶ˆ
                alert('æŠ½å¥–æ¬¡æ•°é™åˆ¶å·²å–æ¶ˆå¹¶åŒæ­¥åˆ°æ‰€æœ‰ç”¨æˆ·');
            }
        }

        function resetUserDrawCount() {
            if (confirm('ç¡®è®¤é‡ç½®ç”¨æˆ·æŠ½å¥–æ¬¡æ•°ï¼Ÿé‡ç½®åç”¨æˆ·å¯ä»¥é‡æ–°å¼€å§‹æŠ½å¥–ã€‚')) {
                saveUserDrawCount(0);
                updateDrawLimitDisplay();
                broadcastUpdate('USER_COUNT_RESET'); // å¹¿æ’­ç”¨æˆ·è®¡æ•°é‡ç½®
                alert('ç”¨æˆ·æŠ½å¥–æ¬¡æ•°å·²é‡ç½®å¹¶åŒæ­¥åˆ°æ‰€æœ‰ç”¨æˆ·');
            }
        }

        // â€”â€” ç™»å½•éªŒè¯ç›¸å…³ â€”â€”
        function isLoggedIn() {
            return sessionStorage.getItem(SESSION_KEY) === 'authenticated';
        }

        function login(password) {
            if (password === ADMIN_PASSWORD) {
                sessionStorage.setItem(SESSION_KEY, 'authenticated');
                showMainContent();
                return true;
            }
            return false;
        }

        function logout() {
            sessionStorage.removeItem(SESSION_KEY);
            showLoginOverlay();
        }

        function showLoginOverlay() {
            $('#loginOverlay').classList.remove('hidden');
            $('#mainContent').classList.add('hidden');
            $('#adminPassword').value = '';
            $('#loginError').classList.add('hidden');
            $('#adminPassword').focus();
        }

        function showMainContent() {
            $('#loginOverlay').classList.add('hidden');
            $('#mainContent').classList.remove('hidden');
        }

        function handleLogin() {
            const password = $('#adminPassword').value;
            const errorDiv = $('#loginError');

            if (!password) {
                errorDiv.textContent = 'è¯·è¾“å…¥å¯†ç ';
                errorDiv.classList.remove('hidden');
                return;
            }

            if (login(password)) {
                errorDiv.classList.add('hidden');
            } else {
                errorDiv.textContent = 'å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•';
                errorDiv.classList.remove('hidden');
                $('#adminPassword').value = '';
                $('#adminPassword').focus();
            }
        }

        // â€”â€” äº‹ä»¶ç»‘å®š â€”â€”
        function bind() {
            // ç™»å½•ç›¸å…³äº‹ä»¶
            $('#loginBtn').addEventListener('click', handleLogin);
            $('#logoutBtn').addEventListener('click', () => {
                if (confirm('ç¡®è®¤é€€å‡ºç®¡ç†ç³»ç»Ÿï¼Ÿ')) {
                    logout();
                }
            });
            $('#adminPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });

            // åŸæœ‰åŠŸèƒ½äº‹ä»¶
            $('#savePoolBtn').addEventListener('click', () => {
                try {
                    const text = $('#poolEditor').value;
                    const pool = textToPool(text);
                    savePool(pool);
                    renderPoolList(pool);
                    broadcastUpdate('POOL_UPDATE', pool); // å¹¿æ’­å¥–æ± æ›´æ–°
                    alert('å¥–æ± é…ç½®å·²ä¿å­˜å¹¶åŒæ­¥åˆ°æ‰€æœ‰ç”¨æˆ·');
                } catch (e) {
                    alert('ä¿å­˜å¤±è´¥ï¼š' + e.message);
                }
            });

            $('#reloadBtn').addEventListener('click', () => {
                refreshPoolEditor();
                renderPoolList(loadPool());
                alert('å·²é‡æ–°è½½å…¥å½“å‰é…ç½®');
            });

            $('#restoreDefaultBtn').addEventListener('click', () => {
                if (confirm('ç¡®è®¤æ¢å¤é»˜è®¤å¥–æ± é…ç½®ï¼Ÿå½“å‰é…ç½®å°†è¢«è¦†ç›–ï¼')) {
                    const defaultPool = structuredClone(DEFAULT_POOL);
                    savePool(defaultPool);
                    refreshPoolEditor();
                    renderPoolList(loadPool());
                    broadcastUpdate('POOL_UPDATE', defaultPool); // å¹¿æ’­å¥–æ± æ›´æ–°
                    alert('å·²æ¢å¤é»˜è®¤å¥–æ± é…ç½®å¹¶åŒæ­¥åˆ°æ‰€æœ‰ç”¨æˆ·');
                }
            });

            $('#refreshPreviewBtn').addEventListener('click', () => {
                renderPoolList(loadPool());
            });

            $('#exportHistoryBtn').addEventListener('click', exportHistory);
            $('#clearHistoryBtn').addEventListener('click', clearHistory);
            $('#resetAllBtn').addEventListener('click', resetAll);

            // æŠ½å¥–æ¬¡æ•°é™åˆ¶ç›¸å…³äº‹ä»¶
            $('#saveDrawLimitBtn').addEventListener('click', setDrawLimit);
            $('#disableDrawLimitBtn').addEventListener('click', disableDrawLimit);
            $('#resetUserDrawCountBtn').addEventListener('click', resetUserDrawCount);
            $('#drawLimitInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    setDrawLimit();
                }
            });
        }

        function init() {
            $('#year').textContent = new Date().getFullYear();

            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            if (isLoggedIn()) {
                showMainContent();
                // åˆå§‹åŒ–ä¸»ç•Œé¢å†…å®¹
                refreshPoolEditor();
                renderPoolList(loadPool());
                updateHistoryCount();
                updateDrawLimitDisplay();
            } else {
                showLoginOverlay();
            }
        }

        bind();
        init();
    </script>
</body>

</html>