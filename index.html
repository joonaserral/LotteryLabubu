<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Labubu 幸运抽奖 🧸</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🧸</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 简单易用的免费数据存储 - 无需Firebase -->

    <!-- VIP安全验证 -->
    <script src="auth.js"></script>
    <script src="config.enc.js"></script>
    <script src="music/music-config.js"></script>
    <!-- 移除Google Fonts以避免微信环境下的加载问题 -->
    <style>
        /* 使用系统字体代替Google Fonts，确保微信兼容性 */
        body,
        html,
        * {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji" !important;
        }
    </style>
    <style>
        :root {
            --labu: #6b5b95;
            --labu2: #ffcc00;
        }

        body {
            font-family: 'Zen Maru Gothic', system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans SC', 'PingFang SC', 'Microsoft Yahei', sans-serif;
        }

        .labu-gradient {
            background-image: linear-gradient(135deg, rgba(107, 91, 149, .12), rgba(255, 204, 0, .12));
            position: relative;
            overflow: hidden;
        }

        .labu-gradient::before {
            content: "🧸✨🎀💫🌟";
            position: absolute;
            top: 10%;
            left: -100%;
            font-size: 2rem;
            opacity: 0.3;
            animation: float-emojis 20s linear infinite;
        }

        .labu-gradient::after {
            content: "🎁🍭🎪🎨🎯";
            position: absolute;
            bottom: 10%;
            right: -100%;
            font-size: 1.5rem;
            opacity: 0.2;
            animation: float-emojis-reverse 25s linear infinite;
        }

        @keyframes float-emojis {
            from {
                left: -100%;
            }

            to {
                left: 100%;
            }
        }

        @keyframes float-emojis-reverse {
            from {
                right: -100%;
            }

            to {
                right: 100%;
            }
        }

        .spin {
            animation: spin 1.5s cubic-bezier(.2, .7, .2, 1) 1;
        }

        .spin-legendary {
            animation: spin-legendary 2s cubic-bezier(.2, .7, .2, 1) 1;
        }

        .spin-rare {
            animation: spin-rare 1.8s cubic-bezier(.2, .7, .2, 1) 1;
        }

        .spin-common {
            animation: spin-common 1.2s cubic-bezier(.2, .7, .2, 1) 1;
        }

        @keyframes spin {
            0% {
                transform: rotate(-6deg) scale(.98);
            }

            25% {
                transform: rotate(3deg) scale(1.01);
            }

            50% {
                transform: rotate(6deg) scale(1.02);
            }

            75% {
                transform: rotate(-3deg) scale(1.01);
            }

            100% {
                transform: rotate(0) scale(1);
            }
        }

        @keyframes spin-legendary {
            0% {
                transform: rotate(-12deg) scale(.95);
                box-shadow: 0 0 0 rgba(255, 215, 0, 0.5);
            }

            25% {
                transform: rotate(8deg) scale(1.05);
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            }

            50% {
                transform: rotate(12deg) scale(1.08);
                box-shadow: 0 0 30px rgba(255, 215, 0, 1);
            }

            75% {
                transform: rotate(-8deg) scale(1.05);
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            }

            100% {
                transform: rotate(0) scale(1);
                box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
            }
        }

        @keyframes spin-rare {
            0% {
                transform: rotate(-10deg) scale(.96);
                box-shadow: 0 0 0 rgba(138, 43, 226, 0.5);
            }

            25% {
                transform: rotate(6deg) scale(1.03);
                box-shadow: 0 0 15px rgba(138, 43, 226, 0.7);
            }

            50% {
                transform: rotate(10deg) scale(1.06);
                box-shadow: 0 0 25px rgba(138, 43, 226, 0.9);
            }

            75% {
                transform: rotate(-6deg) scale(1.03);
                box-shadow: 0 0 15px rgba(138, 43, 226, 0.7);
            }

            100% {
                transform: rotate(0) scale(1);
                box-shadow: 0 0 8px rgba(138, 43, 226, 0.2);
            }
        }

        @keyframes spin-common {
            0% {
                transform: rotate(-4deg) scale(.98);
            }

            50% {
                transform: rotate(4deg) scale(1.02);
            }

            100% {
                transform: rotate(0) scale(1);
            }
        }

        .sparkle {
            animation: sparkle 1s ease-in-out infinite;
        }

        @keyframes sparkle {

            0%,
            100% {
                opacity: 0.3;
                transform: scale(1);
            }

            50% {
                opacity: 1;
                transform: scale(1.1);
            }
        }

        .bounce-in {
            animation: bounce-in 0.6s ease-out;
        }

        @keyframes bounce-in {
            0% {
                transform: scale(0.3);
                opacity: 0;
            }

            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }

            70% {
                transform: scale(0.9);
                opacity: 0.9;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .floating {
            animation: floating 3s ease-in-out infinite;
        }

        @keyframes floating {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        /* 音乐播放器样式 */
        .music-player {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
        }

        .music-player:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-2px);
        }

        .music-progress {
            background: linear-gradient(90deg, var(--labu) 0%, var(--labu2) 100%);
        }

        .volume-slider {
            background: linear-gradient(90deg, #ddd 0%, var(--labu) 100%);
        }

        /* 留言系统样式 */
        .comment-bubble {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.9));
            backdrop-filter: blur(5px);
            transform: translateY(10px);
            opacity: 0;
            animation: slideIn 0.3s ease-out forwards;
        }

        @keyframes slideIn {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .comment-reply {
            border-left: 3px solid var(--labu);
            background: rgba(107, 91, 149, 0.05);
        }

        /* 自定义鼠标样式 - 增加备用方案 */
        body.custom-cursor-enabled * {
            cursor: none !important;
        }

        /* 默认保留系统光标，直到自定义光标成功加载 */
        body:not(.custom-cursor-enabled) * {
            cursor: auto;
        }

        /* 恢复文本输入元素的光标 */
        input,
        textarea,
        [contenteditable="true"],
        .text-input {
            cursor: text !important;
        }

        /* 恢复可点击元素的光标 */
        button,
        a,
        [role="button"],
        .cursor-pointer,
        select {
            cursor: pointer !important;
        }

        /* 光标回退选项 */
        body.cursor-fallback * {
            cursor: auto !important;
        }

        body.cursor-fallback input,
        body.cursor-fallback textarea,
        body.cursor-fallback [contenteditable="true"] {
            cursor: text !important;
        }

        body.cursor-fallback button,
        body.cursor-fallback a,
        body.cursor-fallback [role="button"],
        body.cursor-fallback select {
            cursor: pointer !important;
        }

        .custom-cursor {
            position: fixed;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #ff69b4 30%, transparent 70%);
            border: 2px solid #ff69b4;
            border-radius: 50%;
            pointer-events: none;
            z-index: 99999 !important;
            transition: transform 0.1s ease;
            transform: translate(-50%, -50%);
            opacity: 1 !important;
            display: block !important;
            visibility: visible !important;
            box-shadow: 0 0 10px rgba(255, 105, 180, 0.5), 0 0 20px rgba(255, 105, 180, 0.3);
        }

        .custom-cursor.clicking {
            transform: translate(-50%, -50%) scale(1.2);
        }

        .cursor-trail {
            position: fixed;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, rgba(255, 105, 180, 0.8) 0%, rgba(255, 105, 180, 0) 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9998;
            animation: cursorTrailFade 0.5s ease-out forwards;
        }

        @keyframes cursorTrailFade {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            100% {
                opacity: 0;
                transform: scale(0.3);
            }
        }

        /* 侧边互动区域 */
        .side-interactive {
            position: fixed;
            top: 0;
            width: 100px;
            height: 100vh;
            z-index: 1;
            pointer-events: none;
        }

        .side-interactive.left {
            left: 0;
            background: linear-gradient(90deg, rgba(107, 91, 149, 0.03) 0%, transparent 100%);
        }

        .side-interactive.right {
            right: 0;
            background: linear-gradient(270deg, rgba(255, 204, 0, 0.03) 0%, transparent 100%);
        }

        .side-particle {
            position: absolute;
            width: 20px;
            height: 20px;
            font-size: 16px;
            opacity: 0;
            pointer-events: none;
            animation: sideParticleFloat 3s ease-out forwards;
        }

        @keyframes sideParticleFloat {
            0% {
                opacity: 0;
                transform: translateY(20px) scale(0.5);
            }

            20% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }

            100% {
                opacity: 0;
                transform: translateY(-100px) scale(0.8) rotate(180deg);
            }
        }

        /* 按钮增强效果 */
        .enhanced-btn {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .enhanced-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .enhanced-btn:hover::before {
            left: 100%;
        }

        .enhanced-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(107, 91, 149, 0.3);
        }

        .enhanced-btn:active {
            transform: translateY(0);
        }

        .btn-ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            transform: scale(0);
            animation: rippleEffect 0.6s linear;
            pointer-events: none;
        }

        @keyframes rippleEffect {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* 滚动角色动画 */
        .scroll-character {
            position: fixed;
            font-size: 48px;
            z-index: 10;
            pointer-events: none;
            opacity: 0;
            animation: characterFloat 4s ease-out forwards;
        }

        @keyframes characterFloat {
            0% {
                opacity: 0;
                transform: translateX(-100px) rotate(-10deg);
            }

            20% {
                opacity: 1;
                transform: translateX(0) rotate(0deg);
            }

            80% {
                opacity: 1;
                transform: translateX(20px) rotate(5deg);
            }

            100% {
                opacity: 0;
                transform: translateX(100px) rotate(10deg);
            }
        }

        /* 魔法粒子效果 */
        .magic-particle {
            position: fixed;
            width: 4px;
            height: 4px;
            background: radial-gradient(circle, #ffd700 0%, #ff69b4 50%, transparent 100%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9997;
            animation: magicParticle 2s ease-out forwards;
        }

        @keyframes magicParticle {
            0% {
                opacity: 1;
                transform: scale(0) rotate(0deg);
            }

            50% {
                opacity: 1;
                transform: scale(1) rotate(180deg);
            }

            100% {
                opacity: 0;
                transform: scale(0.2) rotate(360deg) translateY(-50px);
            }
        }

        /* 页面优化样式 */
        .content-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .compact-section {
            padding: 60px 0;
        }

        .hero-compact {
            padding: 80px 0;
        }

        /* 响应式间距优化 */
        @media (max-width: 768px) {
            .compact-section {
                padding: 30px 0;
            }

            .hero-compact {
                padding: 40px 0;
            }

            /* 移动端导航优化 */
            header .max-w-5xl {
                padding: 0 15px;
            }

            header h1 {
                font-size: 16px;
            }

            nav {
                font-size: 12px;
                gap: 8px;
            }

            nav a {
                padding: 8px 4px;
            }

            /* 移动端英雄区优化 */
            .content-container {
                padding: 0 15px;
            }

            .hero-compact h2 {
                font-size: 24px;
                line-height: 1.3;
            }

            .hero-compact p {
                font-size: 14px;
                line-height: 1.5;
            }

            /* 移动端音乐播放器优化 */
            #musicPlayer {
                bottom: 10px;
                right: 10px;
                width: 280px;
                font-size: 14px;
            }

            .music-player {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            }

            /* 移动端按钮优化 */
            .enhanced-btn {
                min-height: 44px;
                /* iOS推荐触摸目标大小 */
                font-size: 14px;
            }

            /* 移动端表单优化 */
            input,
            textarea,
            select {
                min-height: 44px;
                font-size: 16px;
                /* 防止iOS缩放 */
            }

            /* 移动端卡片优化 */
            .rounded-3xl {
                border-radius: 16px;
            }

            /* 移动端间距调整 */
            .gap-8 {
                gap: 20px;
            }

            .gap-6 {
                gap: 15px;
            }

            .gap-4 {
                gap: 10px;
            }

            /* 移动端文字大小调整 */
            .text-3xl {
                font-size: 20px;
            }

            .text-2xl {
                font-size: 18px;
            }

            .text-xl {
                font-size: 16px;
            }

            /* 移动端图标调整 */
            .text-7xl {
                font-size: 48px;
            }

            .text-8xl {
                font-size: 56px;
            }
        }

        /* 小屏幕设备优化 */
        @media (max-width: 480px) {
            header h1 {
                font-size: 14px;
            }

            nav {
                font-size: 11px;
                gap: 6px;
            }

            .hero-compact h2 {
                font-size: 20px;
            }

            #musicPlayer {
                width: 250px;
                bottom: 5px;
                right: 5px;
            }

            .enhanced-btn {
                font-size: 13px;
                padding: 12px 16px;
            }
        }

        /* 页面过渡动画 */
        .page-transition-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(107, 91, 149, 0.9), rgba(255, 204, 0, 0.9));
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .page-transition-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .page-transition-content {
            text-align: center;
            color: white;
            transform: translateY(20px);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .page-transition-overlay.active .page-transition-content {
            transform: translateY(0);
        }

        .transition-loader {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .smooth-link {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .smooth-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .smooth-link:hover::before {
            left: 100%;
        }

        .smooth-link:hover {
            transform: translateY(-1px);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900">
    <!-- 页面过渡动画覆盖层 -->
    <div id="pageTransitionOverlay" class="page-transition-overlay">
        <div class="page-transition-content">
            <div class="transition-loader"></div>
            <h3 class="text-2xl font-bold mb-2">🧸 正在跳转...</h3>
            <p class="text-lg opacity-90">请稍候，即将为您加载精彩内容</p>
        </div>
    </div>

    <!-- 自定义鼠标光标 -->
    <div class="custom-cursor"></div>

    <!-- 光标切换按钮 -->
    <button id="cursorToggle"
        class="fixed bottom-4 left-4 z-50 w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full shadow-lg flex items-center justify-center text-white text-lg hover:scale-110 transition-transform duration-200"
        title="切换光标模式" onclick="toggleCursorMode()">
        🖱️
    </button>

    <!-- 音乐播放器调试按钮 -->
    <button id="musicDebugBtn"
        class="fixed bottom-20 left-4 z-50 w-12 h-12 bg-gradient-to-br from-green-500 to-blue-500 rounded-full shadow-lg flex items-center justify-center text-white text-lg hover:scale-110 transition-transform duration-200"
        title="音乐播放器调试"
        onclick="if(window.testMusicPlayer) window.testMusicPlayer(); if(window.showFullPlayer) window.showFullPlayer(); document.getElementById('emergencyMusicPanel').classList.remove('hidden');">
        🎵
    </button>

    <!-- 紧急音乐控制面板 -->
    <div id="emergencyMusicPanel"
        class="fixed top-4 right-4 z-50 bg-white/90 backdrop-blur rounded-lg shadow-lg p-3 hidden">
        <div class="text-sm font-medium mb-2">🎵 紧急音乐控制</div>
        <div class="flex gap-2">
            <button onclick="if(window.showFullPlayer) window.showFullPlayer()"
                class="px-3 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">
                展开
            </button>
            <button onclick="if(window.showMiniPlayer) window.showMiniPlayer()"
                class="px-3 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600">
                收起
            </button>
            <button onclick="if(window.togglePlayPause) window.togglePlayPause()"
                class="px-3 py-1 bg-purple-500 text-white rounded text-xs hover:bg-purple-600">
                播放
            </button>
            <button onclick="document.getElementById('emergencyMusicPanel').classList.add('hidden')"
                class="px-3 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600">
                关闭
            </button>
        </div>
    </div>

    <!-- 手机验证码登录模态窗口 -->
    <div id="phoneLoginModal"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm z-60 flex items-center justify-center hidden">
        <div class="bg-white rounded-3xl p-8 mx-4 max-w-md w-full shadow-2xl">
            <!-- 标题 -->
            <div class="text-center mb-6">
                <div class="text-4xl mb-2">📱</div>
                <h2 class="text-xl font-bold text-slate-800">手机验证码登录</h2>
                <p class="text-sm text-slate-500 mt-2">验证身份，同步您的抽奖数据到云端</p>
            </div>

            <!-- 手机号输入 -->
            <div id="phoneInputStep" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">手机号码</label>
                    <div class="flex">
                        <select id="countryCode"
                            class="px-3 py-2 border border-slate-300 rounded-l-lg text-sm focus:border-[var(--labu)] focus:outline-none">
                            <option value="+86">🇨🇳 +86</option>
                            <option value="+1">🇺🇸 +1</option>
                            <option value="+44">🇬🇧 +44</option>
                            <option value="+81">🇯🇵 +81</option>
                            <option value="+82">🇰🇷 +82</option>
                        </select>
                        <input type="tel" id="phoneNumber" placeholder="请输入手机号"
                            class="flex-1 px-3 py-2 border border-l-0 border-slate-300 rounded-r-lg text-sm focus:border-[var(--labu)] focus:outline-none">
                    </div>
                    <div id="phoneError" class="text-red-500 text-xs mt-1 hidden"></div>
                </div>

                <!-- 简单验证 -->
                <div class="text-xs text-slate-500 bg-blue-50 p-2 rounded">
                    💡 为了简化流程，我们使用演示验证码：<strong>123456</strong>
                </div>

                <button id="sendCodeBtn" onclick="sendVerificationCode()"
                    class="w-full bg-[var(--labu)] text-white py-3 rounded-lg font-medium hover:bg-[var(--labu)]/90 transition-colors">
                    📤 发送验证码
                </button>
            </div>

            <!-- 验证码输入 -->
            <div id="codeInputStep" class="space-y-4 hidden">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">验证码</label>
                    <input type="text" id="verificationCode" placeholder="请输入6位验证码" maxlength="6"
                        class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm text-center font-mono text-lg tracking-wider focus:border-[var(--labu)] focus:outline-none">
                    <div id="codeError" class="text-red-500 text-xs mt-1 hidden"></div>
                </div>

                <div class="flex justify-between items-center text-sm">
                    <span class="text-slate-500">验证码已发送至 <span id="sentPhoneNumber"></span></span>
                    <button id="resendCodeBtn" onclick="resendVerificationCode()"
                        class="text-[var(--labu)] hover:underline" disabled>
                        重新发送 (<span id="countdown">60</span>s)
                    </button>
                </div>

                <button id="verifyCodeBtn" onclick="verifyCode()"
                    class="w-full bg-[var(--labu)] text-white py-3 rounded-lg font-medium hover:bg-[var(--labu)]/90 transition-colors">
                    ✅ 验证登录
                </button>

                <button onclick="backToPhoneInput()"
                    class="w-full bg-slate-200 text-slate-700 py-2 rounded-lg font-medium hover:bg-slate-300 transition-colors">
                    ← 返回修改手机号
                </button>
            </div>

            <!-- 关闭按钮 -->
            <button onclick="closePhoneLoginModal()"
                class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center text-slate-400 hover:text-slate-600 text-xl">
                ✕
            </button>

            <!-- 登录状态指示 -->
            <div id="loginLoading" class="text-center py-4 hidden">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-[var(--labu)]"></div>
                <p class="mt-2 text-sm text-slate-600">正在验证中...</p>
            </div>
        </div>
    </div>

    <!-- 用户状态面板 -->
    <div id="userStatusPanel" class="fixed top-4 left-16 z-50 bg-white/90 backdrop-blur rounded-lg shadow-lg p-3">
        <div class="flex items-center gap-3">
            <div id="userAvatar"
                class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white text-sm">
                👤
            </div>
            <div>
                <div id="userPhone" class="text-sm font-medium">未登录</div>
                <div id="userStatus" class="text-xs text-slate-500">点击登录同步数据</div>
            </div>
            <button id="userMenuBtn" onclick="toggleUserMenu()" class="text-slate-400 hover:text-slate-600">
                ⚙️
            </button>
        </div>

        <!-- 用户菜单 -->
        <div id="userMenu" class="mt-3 pt-3 border-t border-slate-200 space-y-2 hidden">
            <button onclick="showPhoneLoginModal()" id="loginBtn"
                class="w-full text-left px-2 py-1 text-sm text-[var(--labu)] hover:bg-slate-100 rounded">
                📱 手机登录
            </button>
            <button onclick="syncUserData()" id="syncBtn"
                class="w-full text-left px-2 py-1 text-sm text-green-600 hover:bg-slate-100 rounded hidden">
                ☁️ 同步数据
            </button>
            <button onclick="logoutUser()" id="logoutBtn"
                class="w-full text-left px-2 py-1 text-sm text-red-600 hover:bg-slate-100 rounded hidden">
                🚪 退出登录
            </button>
        </div>
    </div>

    <!-- 侧边互动区域 -->
    <div class="side-interactive left"></div>
    <div class="side-interactive right"></div>

    <!-- 顶部栏 -->
    <header class="sticky top-0 z-10 backdrop-blur bg-white/60 border-b border-slate-200">
        <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-xl bg-[var(--labu)] grid place-content-center text-white text-xl sparkle">🧸
                </div>
                <h1 class="font-bold text-lg">Labubuの基金会~ · VIP股东专享福利</h1>
                <div class="hidden sm:flex gap-1">
                    <span class="floating">✨</span>
                    <span class="floating" style="animation-delay: 0.2s;">🎀</span>
                    <span class="floating" style="animation-delay: 0.4s;">💫</span>
                </div>
            </div>
            <nav class="text-sm flex items-center gap-4">
                <a href="#draw" class="hover:underline flex items-center gap-1 smooth-link">🎯 娱乐抽奖</a>
                <a href="#history" class="hover:underline flex items-center gap-1 smooth-link">📊 中奖记录</a>
                <a href="#exchange" class="hover:underline flex items-center gap-1 smooth-link">🔄 积分兑换</a>
                <a href="games.html" class="hover:underline flex items-center gap-1 smooth-link page-link">🎮 游戏中心</a>
                <a href="achievements.html" class="hover:underline flex items-center gap-1 smooth-link page-link">🏆
                    个人成就</a>
                <a href="user-center.html" class="hover:underline flex items-center gap-1 smooth-link page-link">👤
                    用户中心</a>
                <a href="#comments" class="hover:underline flex items-center gap-1 smooth-link">💬 用户交流</a>
            </nav>
        </div>
    </header>

    <!-- Hero -->
    <section class="labu-gradient hero-compact">
        <div class="content-container px-4 grid md:grid-cols-2 gap-8 items-center">
            <div>
                <h2 class="text-3xl md:text-4xl font-extrabold leading-tight">
                    Labubu主题娱乐抽奖平台
                    <span class="sparkle">💎</span>
                </h2>
                <p class="mt-3 text-slate-700">
                    🎯 <strong>最新中奖动态</strong>：本月已有236位用户中奖，史诗级奖品88件 <br />
                    💰 <strong>奖励类型</strong>：U币货币、限量公仔、消费券等多样化奖品 <br />
                    🎁 <strong>中奖提醒</strong>：请理性参与，适度娱乐，切勿过度投入 <br />
                    ⚠️ <strong>官方提醒</strong>：本平台仅供娱乐，请有节制地进行抽奖活动
                </p>
                <div class="mt-5 flex flex-wrap gap-3">
                    <a href="#draw"
                        class="enhanced-btn px-6 py-3 rounded-xl bg-[var(--labu)] text-white font-medium shadow flex items-center gap-2">
                        🎯 开始抽奖
                    </a>
                    <button id="exportCsvBtn"
                        class="enhanced-btn px-6 py-3 rounded-xl bg-gradient-to-r from-yellow-600 to-yellow-500 text-white font-medium shadow flex items-center gap-2">
                        📊 导出中奖记录
                    </button>
                </div>
                <div class="mt-4 text-sm text-slate-600">
                    <div class="flex flex-wrap gap-3">

                        <span class="flex items-center gap-1 px-3 py-1 bg-purple-100 rounded-full">🌟 史诗级</span>
                        <span class="flex items-center gap-1 px-3 py-1 bg-blue-100 rounded-full">💎 稀有级</span>
                        <span class="flex items-center gap-1 px-3 py-1 bg-gray-100 rounded-full">🎀 普通级</span>
                    </div>
                </div>
            </div>
            <div class="relative">
                <div
                    class="aspect-square rounded-3xl bg-white shadow-lg p-6 border border-slate-200 overflow-hidden relative">
                    <div class="h-full w-full grid place-content-center relative z-10">
                        <div class="text-7xl md:text-8xl select-none bounce-in">🧸</div>
                        <div class="text-center mt-4 text-sm text-slate-600 flex items-center justify-center gap-2">
                            <span>Labubu 主题抽奖</span>
                            <span class="sparkle">✨</span>
                        </div>
                    </div>
                    <!-- 装饰元素 -->
                    <div class="absolute top-4 left-4 text-2xl opacity-60 floating">🎀</div>
                    <div class="absolute top-4 right-4 text-2xl opacity-60 floating" style="animation-delay: 0.5s;">💫
                    </div>
                    <div class="absolute bottom-4 left-4 text-2xl opacity-60 floating" style="animation-delay: 1s;">🌟
                    </div>
                    <div class="absolute bottom-4 right-4 text-2xl opacity-60 floating" style="animation-delay: 1.5s;">
                        🎁</div>
                    <div class="absolute top-1/2 left-4 text-xl opacity-40 floating" style="animation-delay: 0.8s;">🎨
                    </div>
                    <div class="absolute top-1/2 right-4 text-xl opacity-40 floating" style="animation-delay: 1.2s;">🎪
                    </div>
                </div>
                <div class="absolute -z-10 inset-0 blur-3xl opacity-30"
                    style="background: radial-gradient(600px 200px at 20% 30%, var(--labu), transparent), radial-gradient(500px 200px at 80% 70%, var(--labu2), transparent);">
                </div>
                <!-- 周围装饰 -->
                <div class="absolute -top-8 -left-8 text-4xl opacity-20 floating">🧸</div>
                <div class="absolute -top-8 -right-8 text-3xl opacity-25 floating" style="animation-delay: 0.3s;">🎈
                </div>
                <div class="absolute -bottom-8 -left-8 text-3xl opacity-20 floating" style="animation-delay: 0.7s;">🍭
                </div>
                <div class="absolute -bottom-8 -right-8 text-4xl opacity-25 floating" style="animation-delay: 1.1s;">🎯
                </div>
            </div>
        </div>
    </section>

    <!-- 抽奖卡片 -->
    <main id="draw" class="content-container px-4 compact-section">
        <div class="grid md:grid-cols-5 gap-6 items-start">
            <section class="md:col-span-3">
                <div class="rounded-3xl bg-white border border-slate-200 shadow">
                    <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                        <h3 class="font-semibold">抽奖面板</h3>
                        <div class="text-xs text-slate-500">
                            <div>本地时间：<span id="now"></span></div>
                            <div id="drawLimitInfo" class="mt-1">剩余抽奖次数：<span id="remainingDraws">—</span></div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="grid gap-4">
                            <div class="rounded-2xl border border-dashed border-slate-300 p-6 text-center">
                                <div class="text-sm text-slate-600">
                                    <span id="drawModeIndicator">点击按钮开始抽奖</span>
                                </div>
                                <div id="resultDisplay" class="text-3xl font-extrabold mt-2">—</div>
                                <div id="resultMeta" class="text-xs text-slate-500 mt-1">—</div>
                                <div id="trialNotice" class="text-xs text-orange-600 mt-2 hidden">
                                    🎯 这是试抽结果，不会消耗库存或计入记录
                                </div>
                            </div>
                            <div class="flex gap-3 flex-wrap">
                                <button id="drawBtn"
                                    class="enhanced-btn px-5 py-3 rounded-2xl bg-[var(--labu)] text-white font-semibold shadow">正式抽奖</button>
                                <button id="trialDrawBtn"
                                    class="enhanced-btn px-5 py-3 rounded-2xl bg-slate-100 text-slate-800 font-medium border border-slate-200">试抽体验</button>
                            </div>
                            <div class="text-xs text-slate-500">
                                <div>说明：正式抽奖会根据奖池权重与库存进行，实体礼品会扣减库存；券码会自动生成并显示。</div>
                                <div class="mt-1">试抽体验：仅供体验概率分布，不消耗库存、不计入记录、不影响抽奖次数。</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 迪士尼饼饼 & Labubu 图片合集 -->
            <aside class="md:col-span-2">
                <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
                    <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                        <h3 class="font-semibold">🧸 饼饼 & Labubu 合集</h3>
                        <span class="text-xs text-slate-500">精选图片</span>
                    </div>
                    <div class="p-5">
                        <!-- 九宫格图片展示 -->
                        <div class="grid grid-cols-3 gap-3" id="imageGallery">
                            <!-- 第一行：迪士尼饼饼系列 -->
                            <div class="aspect-square rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow cursor-pointer gallery-item"
                                data-title="甜心饼饼">
                                <div
                                    class="w-full h-full bg-gradient-to-br from-pink-200 to-pink-300 flex items-center justify-center text-4xl relative overflow-hidden">
                                    🍪
                                    <div class="absolute inset-0 bg-gradient-to-br from-white/20 to-transparent"></div>
                                </div>
                            </div>
                            <div class="aspect-square rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow cursor-pointer gallery-item"
                                data-title="仙女饼饼">
                                <div
                                    class="w-full h-full bg-gradient-to-br from-blue-200 to-blue-300 flex items-center justify-center text-4xl relative overflow-hidden">
                                    🧚‍♀️
                                    <div class="absolute inset-0 bg-gradient-to-br from-white/20 to-transparent"></div>
                                </div>
                            </div>
                            <div class="aspect-square rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow cursor-pointer gallery-item"
                                data-title="公主饼饼">
                                <div
                                    class="w-full h-full bg-gradient-to-br from-purple-200 to-purple-300 flex items-center justify-center text-4xl relative overflow-hidden">
                                    👸
                                    <div class="absolute inset-0 bg-gradient-to-br from-white/20 to-transparent"></div>
                                </div>
                            </div>

                            <!-- 第二行：Labubu系列 -->
                            <div class="aspect-square rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow cursor-pointer gallery-item"
                                data-title="经典Labubu">
                                <div
                                    class="w-full h-full bg-gradient-to-br from-green-200 to-green-300 flex items-center justify-center text-4xl relative overflow-hidden">
                                    🧸
                                    <div class="absolute inset-0 bg-gradient-to-br from-white/20 to-transparent"></div>
                                </div>
                            </div>
                            <div class="aspect-square rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow cursor-pointer gallery-item"
                                data-title="马戏团Labubu">
                                <div
                                    class="w-full h-full bg-gradient-to-br from-yellow-200 to-orange-300 flex items-center justify-center text-4xl relative overflow-hidden">
                                    🎪
                                    <div class="absolute inset-0 bg-gradient-to-br from-white/20 to-transparent"></div>
                                </div>
                            </div>
                            <div
                                class="aspect-square rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow cursor-pointer">
                                <div
                                    class="w-full h-full bg-gradient-to-br from-red-200 to-pink-300 flex items-center justify-center text-4xl">
                                    🎭
                                </div>
                            </div>

                            <!-- 第三行：合作款 -->
                            <div
                                class="aspect-square rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow cursor-pointer">
                                <div
                                    class="w-full h-full bg-gradient-to-br from-indigo-200 to-purple-300 flex items-center justify-center text-4xl">
                                    🌈
                                </div>
                            </div>
                            <div
                                class="aspect-square rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow cursor-pointer">
                                <div
                                    class="w-full h-full bg-gradient-to-br from-teal-200 to-cyan-300 flex items-center justify-center text-4xl">
                                    ✨
                                </div>
                            </div>
                            <div
                                class="aspect-square rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow cursor-pointer">
                                <div
                                    class="w-full h-full bg-gradient-to-br from-rose-200 to-pink-300 flex items-center justify-center text-4xl">
                                    💖
                                </div>
                            </div>
                        </div>

                        <!-- 图片说明 -->
                        <div class="mt-6 text-xs text-slate-500 text-center">
                            <p class="font-medium text-slate-600">迪士尼饼饼 × Labubu 联名系列精选合集</p>
                            <p class="mt-2 text-slate-400">点击图片查看角色详情 ✨</p>
                            <div class="mt-3 flex justify-center gap-4 text-[10px]">
                                <span class="flex items-center gap-1">
                                    <div class="w-2 h-2 rounded-full bg-pink-300"></div>
                                    迪士尼饼饼
                                </span>
                                <span class="flex items-center gap-1">
                                    <div class="w-2 h-2 rounded-full bg-green-300"></div>
                                    经典Labubu
                                </span>
                                <span class="flex items-center gap-1">
                                    <div class="w-2 h-2 rounded-full bg-purple-300"></div>
                                    联名款式
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
        </div>

        <!-- 历史记录 -->
        <section id="history" class="mt-10">
            <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
                <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                    <h3 class="font-semibold">抽奖结果（自动标记时间）</h3>
                    <div class="flex gap-2">
                        <button id="exportJsonBtn"
                            class="text-xs px-2 py-1 rounded-lg bg-slate-100 border border-slate-200">导出 JSON</button>
                    </div>
                </div>
                <div class="p-5 overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="text-left text-slate-500">
                            <tr>
                                <th class="py-2 pr-4">时间</th>
                                <th class="py-2 pr-4">奖品</th>
                                <th class="py-2 pr-4">类型</th>
                                <th class="py-2 pr-4">券码/备注</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody" class="align-top"></tbody>
                    </table>
                </div>
            </div>
        </section>


    </main>

    <!-- 积分兑换系统 -->
    <section id="exchange" class="content-container px-4 compact-section">
        <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
            <div class="p-5 border-b border-slate-100">
                <h3 class="font-semibold flex items-center gap-2 mb-2">
                    🔄 积分兑换中心
                    <span class="text-xs text-slate-500">（多种奖品可供兑换）</span>
                </h3>
                <div class="flex items-center justify-between text-sm">
                    <div class="flex items-center gap-4">
                        <span class="text-slate-600">当前积分: <span id="userPoints"
                                class="font-bold text-[var(--labu)]">0</span></span>
                        <span class="text-slate-600">可兑换: <span id="exchangeableItems"
                                class="font-bold text-green-600">0</span> 件</span>
                    </div>
                    <button id="calculatePointsBtn"
                        class="enhanced-btn px-4 py-2 bg-[var(--labu)] text-white rounded-lg text-sm">
                        📊 计算持有积分
                    </button>
                </div>
            </div>

            <div class="p-5">
                <!-- 兑换商品展示 -->
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6" id="exchangeItems">
                    <!-- 兑换商品将通过JavaScript生成 -->
                </div>

                <!-- 我的收藏 -->
                <div class="border-t pt-5">
                    <h4 class="font-medium mb-3 flex items-center gap-2">
                        🧸 我的Labubu收藏
                        <span class="text-xs text-slate-500">（可用于兑换积分）</span>
                    </h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3" id="myCollection">
                        <!-- 收藏将通过JavaScript生成 -->
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 留言系统 -->
    <section id="comments" class="content-container px-4 compact-section">
        <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
            <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                <h3 class="font-semibold flex items-center gap-2">
                    💬 留言板
                    <span class="text-xs text-slate-500">（多用户实时共享）</span>
                </h3>
                <div class="text-xs text-slate-500">实时同步中 <span class="sparkle">✨</span></div>
            </div>
            <div class="p-5">
                <!-- 发表留言 -->
                <div class="mb-6">
                    <!-- 登录状态显示 -->
                    <div id="commentLoginStatus" class="mb-3 p-3 bg-slate-50 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <div id="commentUserAvatar"
                                    class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white text-sm">
                                    👤</div>
                                <div>
                                    <div id="commentUserName" class="text-sm font-medium">未登录</div>
                                    <div id="commentUserStatus" class="text-xs text-slate-500">请登录后发表留言</div>
                                </div>
                            </div>
                            <button id="commentLoginBtn" onclick="showPhoneLoginModal()"
                                class="px-3 py-1 bg-[var(--labu)] text-white text-xs rounded-lg">
                                📱 登录
                            </button>
                        </div>
                    </div>

                    <textarea id="commentInput" rows="3" placeholder="说点什么吧... 🎯"
                        class="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm focus:border-[var(--labu)] focus:outline-none resize-none"
                        disabled></textarea>
                    <div class="flex justify-between items-center mt-3">
                        <div class="text-xs text-slate-500">
                            <span id="commentCount">0</span> 条留言
                        </div>
                        <button id="submitComment"
                            class="enhanced-btn px-4 py-2 rounded-lg bg-[var(--labu)] text-white text-sm font-medium"
                            disabled>
                            💬 发表留言
                        </button>
                    </div>
                </div>

                <!-- 留言列表 -->
                <div id="commentsList" class="space-y-4">
                    <div class="text-center text-slate-400 py-8">
                        <div class="text-4xl mb-2">💭</div>
                        <div>暂无留言，快来说点什么吧！</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 音乐播放器 -->
    <div id="musicPlayer" class="fixed bottom-6 right-6 z-40 music-player transition-all duration-300 ease-in-out">
        <!-- 小按钮状态（默认显示） -->
        <div id="musicPlayerMini"
            class="w-14 h-14 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full shadow-lg cursor-pointer flex items-center justify-center hover:scale-110 transition-transform duration-200">
            <div class="text-white text-xl animate-pulse" id="miniMusicIcon">🎵</div>
        </div>

        <!-- 完整播放器（默认隐藏） -->
        <div id="musicPlayerFull"
            class="hidden w-80 bg-white/95 backdrop-blur-md rounded-2xl shadow-xl border border-white/20 p-4">
            <!-- 标题栏 -->
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                    <span class="text-lg">🎵</span>
                    <span class="font-medium text-sm">音乐播放器</span>
                </div>
                <button id="closePlayer" class="text-slate-400 hover:text-slate-600 text-xl">✕</button>
            </div>

            <!-- 当前播放信息 -->
            <div class="text-center mb-4">
                <div id="currentSong" class="font-medium text-sm text-slate-800 truncate">准备播放音乐</div>
                <div id="currentArtist" class="text-xs text-slate-500 truncate">选择一首歌开始播放</div>
            </div>

            <!-- 进度条 -->
            <div class="space-y-2 mb-4">
                <div class="flex justify-between text-xs text-slate-500">
                    <span id="currentTime">0:00</span>
                    <span id="totalTime">0:00</span>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-1.5 cursor-pointer" id="progressContainer">
                    <div id="progressBar" class="music-progress h-1.5 rounded-full w-0 transition-all"></div>
                </div>
            </div>

            <!-- 控制按钮 -->
            <div class="flex items-center justify-center gap-6 mb-4">
                <button id="prevBtn" class="text-2xl hover:scale-110 transition-transform duration-200">⏮️</button>
                <button id="playPauseBtn"
                    class="text-2xl hover:scale-110 transition-transform duration-200 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg">▶️</button>
                <button id="nextBtn" class="text-2xl hover:scale-110 transition-transform duration-200">⏭️</button>
            </div>

            <!-- 音量控制 -->
            <div class="flex items-center gap-3 mb-4">
                <span class="text-sm">🔊</span>
                <input type="range" id="volumeSlider" min="0" max="100" value="50"
                    class="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
            </div>

            <!-- 播放列表 -->
            <div class="max-h-32 overflow-y-auto">
                <div class="text-xs text-slate-500 mb-2 font-medium">播放列表</div>
                <div id="playlist" class="space-y-1"></div>
            </div>
        </div>
    </div>

    <footer class="max-w-5xl mx-auto px-4 py-10 text-center text-xs text-slate-500">
        <div>© <span id="year"></span> Labubu基金会抽奖（最终解释权归本基金会所有）</div>
        <div class="mt-2">
            <a href="admin.html" class="text-slate-400 hover:text-slate-600 hover:underline transition-colors">系统管理</a>
        </div>
    </footer>

    <script>
        // —— 本地存储键 ——
        const LS_KEYS = {
            HISTORY: 'labubu_lottery_history',
            POOL: 'labubu_lottery_pool',
            DRAW_LIMIT: 'labubu_draw_limit',
            USER_DRAW_COUNT: 'labubu_user_draw_count'
        };

        // —— 数据同步通道 ——
        let dataChannel = null;
        let lastPoolUpdate = Date.now();
        let lastLimitUpdate = Date.now();
        let syncEnabled = false;

        // 检查浏览器兼容性
        if ('BroadcastChannel' in window) {
            try {
                dataChannel = new BroadcastChannel('labubu_data_sync');
                syncEnabled = true;
            } catch (error) {
                console.warn('BroadcastChannel初始化失败:', error);
                syncEnabled = false;
            }
        } else {
            console.warn('浏览器不支持BroadcastChannel，实时同步功能将不可用');
            syncEnabled = false;
        }

        // —— Labubu主题奖品池 ——
        const DEFAULT_POOL = [
            // 普通奖品
            { name: "再接再厉", type: '折扣券', weight: 85, quantity: 100, rarity: 'common', points: 10, emoji: "💪" },
            { name: "奶茶一杯", type: '实体', weight: 25, quantity: 30, rarity: 'common', points: 20, emoji: "🧋" },
            { name: "烤肉券（清真记录）", type: '实体', weight: 20, quantity: 25, rarity: 'common', points: 30, emoji: "🥩" },
            { name: "烤肉券", type: '实体', weight: 20, quantity: 20, rarity: 'common', points: 30, emoji: "🍖" },
            { name: "精品奶茶券", type: '实体', weight: 15, quantity: 15, rarity: 'rare', points: 50, emoji: "🧃" },
            { name: "1U币", type: '实体', weight: 25, quantity: 100, rarity: 'common', points: 1, emoji: "💰" },
            { name: "3U币", type: '实体', weight: 15, quantity: 60, rarity: 'common', points: 3, emoji: "💵" },
            { name: "5U币", type: '实体', weight: 10, quantity: 40, rarity: 'rare', points: 5, emoji: "💸" },

            // Labubu系列收藏
            { name: "经典Labubu公仔", type: '实体', weight: 8, quantity: 10, rarity: 'rare', points: 100, image: "images/prizes/labubu/classic.jpg", emoji: "🧸" },
            { name: "彩虹Labubu限定", type: '实体', weight: 6, quantity: 8, rarity: 'epic', points: 150, image: "images/prizes/labubu/rainbow.jpg", emoji: "🌈" },
            { name: "万圣节Labubu特别版", type: '实体', weight: 4, quantity: 5, rarity: 'epic', points: 200, image: "images/prizes/labubu/halloween.jpg", emoji: "🎃" },
            { name: "黄金Labubu收藏版", type: '实体', weight: 3, quantity: 5, rarity: 'epic', points: 300, image: "images/prizes/labubu/gold.jpg", emoji: "👑" },

            // Cookie Ann迪士尼系列
            { name: "甜心Cookie Ann公仔", type: '实体', weight: 7, quantity: 8, rarity: 'rare', points: 120, image: "images/prizes/cookie-ann/sweet.jpg", emoji: "🍪" },
            { name: "公主Cookie Ann限定", type: '实体', weight: 5, quantity: 6, rarity: 'epic', points: 180, image: "images/prizes/cookie-ann/princess.jpg", emoji: "👸" },
            { name: "圣诞Cookie Ann特别版", type: '实体', weight: 3, quantity: 4, rarity: 'epic', points: 220, image: "images/prizes/cookie-ann/christmas.jpg", emoji: "🎄" },
            { name: "烘焙大师Cookie Ann", type: '实体', weight: 2.5, quantity: 4, rarity: 'epic', points: 350, image: "images/prizes/cookie-ann/baker.jpg", emoji: "👩‍🍳" },

            // Pop Mart潮玩系列
            { name: "Molly经典款", type: '实体', weight: 6, quantity: 7, rarity: 'rare', points: 110, image: "images/prizes/popmart/molly-classic.jpg", emoji: "👧" },
            { name: "Dimoo云朵系列", type: '实体', weight: 4, quantity: 5, rarity: 'epic', points: 160, image: "images/prizes/popmart/dimoo-cloud.jpg", emoji: "☁️" },
            { name: "Skullpanda骷髅熊猫", type: '实体', weight: 3.5, quantity: 5, rarity: 'epic', points: 280, image: "images/prizes/popmart/skullpanda.jpg", emoji: "🐼" },

            // 注：本平台仅供娱乐，请理性参与

        ];

        // —— 工具函数 ——
        const $ = (sel) => document.querySelector(sel);
        const $$ = (sel) => Array.from(document.querySelectorAll(sel));
        const nowStr = () => new Date().toLocaleString();
        const uid = (n = 8) => Math.random().toString(36).slice(2, 2 + n).toUpperCase();

        // —— 页面过渡动画功能 ——
        function initPageTransitions() {
            // 为所有页面链接添加过渡效果
            $$('.page-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const href = link.getAttribute('href');
                    showPageTransition(() => {
                        window.location.href = href;
                    });
                });
            });

            // 为其他外部链接也添加过渡效果
            $$('a[href$=".html"]').forEach(link => {
                if (!link.classList.contains('page-link')) {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const href = link.getAttribute('href');
                        showPageTransition(() => {
                            window.location.href = href;
                        });
                    });
                }
            });
        }

        function showPageTransition(callback) {
            const overlay = $('#pageTransitionOverlay');
            overlay.classList.add('active');

            // 随机显示不同的加载文案
            const loadingTexts = [
                { title: '🧸 正在跳转...', subtitle: '请稍候，即将为您加载精彩内容' },
                { title: '✨ 加载中...', subtitle: '正在为用户准备精彩内容' },
                { title: '🎯 即将到达...', subtitle: '您的娱乐功能正在加载' },
                { title: '💎 稍等片刻...', subtitle: '正在展开您的个人成就殿堂' }
            ];

            const randomText = loadingTexts[Math.floor(Math.random() * loadingTexts.length)];
            overlay.querySelector('h3').textContent = randomText.title;
            overlay.querySelector('p').textContent = randomText.subtitle;

            // 延迟执行跳转，让用户看到过渡动画
            setTimeout(() => {
                if (callback) callback();
            }, 800);
        }

        function hidePageTransition() {
            const overlay = $('#pageTransitionOverlay');
            overlay.classList.remove('active');
        }

        // 页面加载时隐藏过渡层
        window.addEventListener('load', () => {
            setTimeout(hidePageTransition, 300);
        });

        // —— 稀有度配置 ——
        function getPrizeRarity(prizeName, weight) {
            // 传说级（权重 ≤ 2，或特定奖品）
            if (weight <= 2 || prizeName.includes('限量') || prizeName.includes('5U币')) {
                return 'legendary';
            }
            // 稀有级（权重 ≤ 6）
            if (weight <= 6 || prizeName.includes('3U币') || prizeName.includes('精品')) {
                return 'rare';
            }
            // 普通级
            return 'common';
        }

        function getRarityConfig(rarity) {
            const configs = {
                legendary: {
                    animation: 'spin-rare',
                    duration: 1800,
                    bgColor: 'from-purple-400 to-indigo-500',
                    textColor: 'text-purple-100',
                    icon: '🌟',
                    message: '获得史诗级奖品！',
                    particles: '🌟✨💫⭐',
                    sound: 'epic'
                },
                epic: {
                    animation: 'spin-rare',
                    duration: 1800,
                    bgColor: 'from-purple-400 to-indigo-500',
                    textColor: 'text-purple-100',
                    icon: '🌟',
                    message: '获得史诗级奖品！',
                    particles: '🌟✨💫⭐',
                    sound: 'epic'
                },
                rare: {
                    animation: 'spin-rare',
                    duration: 1800,
                    bgColor: 'from-purple-400 to-pink-500',
                    textColor: 'text-purple-100',
                    icon: '💎',
                    message: '获得稀有奖品！',
                    particles: '💜💫🔮✨🎀',
                    sound: 'rare'
                },
                common: {
                    animation: 'spin-common',
                    duration: 1200,
                    bgColor: 'from-blue-400 to-green-500',
                    textColor: 'text-blue-100',
                    icon: '🎁',
                    message: '获得奖品！',
                    particles: '🎀💙💚✨🎁',
                    sound: 'common'
                }
            };
            return configs[rarity] || configs.common;
        }

        function showRarityEffect(rarity, config) {
            // 创建全屏稀有度提示
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 z-50 flex items-center justify-center pointer-events-none';
            overlay.style.background = `linear-gradient(135deg, rgba(0,0,0,0.4), rgba(0,0,0,0.6))`;

            const effectContainer = document.createElement('div');
            effectContainer.className = `text-center bounce-in`;
            effectContainer.innerHTML = `
                <div class="text-6xl mb-4 sparkle">${config.icon}</div>
                <div class="text-2xl font-bold text-white mb-2">${config.message}</div>
                <div class="text-lg text-gray-200">获得了特殊奖品！</div>
            `;

            overlay.appendChild(effectContainer);
            document.body.appendChild(overlay);

            // 创建粒子效果
            createParticleEffect(config.particles);

            // 2秒后移除效果
            setTimeout(() => {
                overlay.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(overlay)) {
                        document.body.removeChild(overlay);
                    }
                }, 300);
            }, 2000);
        }

        function createParticleEffect(particles) {
            const particleArray = particles.split('');
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.textContent = particleArray[Math.floor(Math.random() * particleArray.length)];
                    particle.className = 'fixed text-2xl pointer-events-none z-40';
                    particle.style.left = Math.random() * window.innerWidth + 'px';
                    particle.style.top = Math.random() * window.innerHeight + 'px';
                    particle.style.animation = 'sparkle 2s ease-out forwards';

                    document.body.appendChild(particle);

                    setTimeout(() => {
                        if (document.body.contains(particle)) {
                            document.body.removeChild(particle);
                        }
                    }, 2000);
                }, i * 100);
            }
        }

        function loadHistory() {
            try { return JSON.parse(localStorage.getItem(LS_KEYS.HISTORY)) || []; } catch { return []; }
        }
        function saveHistory(arr) { localStorage.setItem(LS_KEYS.HISTORY, JSON.stringify(arr)); }
        function loadPool() {
            try {
                const raw = localStorage.getItem(LS_KEYS.POOL);
                return raw ? JSON.parse(raw) : structuredClone(DEFAULT_POOL);
            } catch { return structuredClone(DEFAULT_POOL); }
        }
        function savePool(pool) { localStorage.setItem(LS_KEYS.POOL, JSON.stringify(pool)); }

        function poolToText(pool) {
            return pool.map(p => [p.name, p.type, p.weight, (p.quantity ?? -1)].join(',')).join('\n');
        }
        function textToPool(txt) {
            const lines = txt.split(/\n+/).map(l => l.trim()).filter(Boolean);

            if (lines.length === 0) {
                throw new Error('奖池不能为空');
            }

            if (lines.length > 100) {
                throw new Error('奖池项目不能超过100个');
            }

            return lines.map((line, i) => {
                const parts = line.split(',').map(s => s?.trim());

                if (parts.length < 3 || parts.length > 4) {
                    throw new Error(`第 ${i + 1} 行格式不正确：应为 name,type,weight[,quantity]`);
                }

                const [name, type, weightStr, qtyStr] = parts;

                // 名称验证
                if (!name || name.length > 50) {
                    throw new Error(`第 ${i + 1} 行：奖品名称不能为空且不能超过50字符`);
                }

                // 类型验证
                if (!['抵扣券', '实体', '折扣券'].includes(type)) {
                    throw new Error(`第 ${i + 1} 行：奖品类型只能是 抵扣券/实体/折扣券`);
                }

                // 权重验证
                const weight = Number(weightStr);
                if (!Number.isFinite(weight) || weight < 0 || weight > 10000) {
                    throw new Error(`第 ${i + 1} 行：权重必须是0-10000之间的数字`);
                }

                // 数量验证
                let quantity = -1;
                if (qtyStr !== undefined && qtyStr !== '') {
                    quantity = Number(qtyStr);
                    if (!Number.isInteger(quantity) || quantity < -1 || quantity > 99999) {
                        throw new Error(`第 ${i + 1} 行：数量必须是-1到99999之间的整数`);
                    }
                }

                return { name, type, weight, quantity };
            });
        }

        function renderPoolList(pool) {
            const ul = $('#poolList');
            ul.innerHTML = '';
            const totalW = pool.reduce((s, p) => s + Math.max(0, p.weight || 0), 0) || 1;
            pool.forEach(p => {
                const left = p.quantity === -1 ? '∞' : p.quantity;
                const w = p.weight || 0;
                const pct = ((w / totalW) * 100).toFixed(1);
                const color = p.type === '实体' ? 'bg-emerald-50 text-emerald-700 border-emerald-200' : (p.type === '抵扣券' ? 'bg-indigo-50 text-indigo-700 border-indigo-200' : 'bg-amber-50 text-amber-700 border-amber-200');
                const li = document.createElement('li');
                li.className = `border rounded-xl p-3 flex items-center justify-between ${color}`;
                li.innerHTML = `<div class="font-medium">${p.name} <span class="ml-2 text-xs px-2 py-0.5 rounded-lg bg-white/60 border">${p.type}</span></div>
                        <div class="text-xs">权重 ${w}（≈${pct}%） · 剩余 <b>${left}</b></div>`;
                ul.appendChild(li);
            });
        }

        function renderHistory() {
            const tb = $('#historyBody');
            tb.innerHTML = '';
            const hist = loadHistory();
            if (hist.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="py-3 text-slate-400" colspan="4">暂无记录</td>`;
                tb.appendChild(tr);
                return;
            }
            hist.slice().reverse().forEach(r => {
                const tr = document.createElement('tr');
                tr.className = 'border-t';
                tr.innerHTML = `<td class="py-3 pr-4 whitespace-nowrap">${r.time}</td>
                        <td class="py-3 pr-4">${r.prize}</td>
                        <td class="py-3 pr-4">${r.type}</td>
                        <td class="py-3 pr-4 text-slate-600 break-all">${r.code || r.note || ''}</td>`;
                tb.appendChild(tr);
            });
        }

        function weightedPick(pool) {
            const candidates = pool.filter(p => (p.quantity === -1 || p.quantity > 0) && (p.weight || 0) > 0);
            const sum = candidates.reduce((s, p) => s + p.weight, 0);
            if (sum <= 0 || candidates.length === 0) return null;
            let r = Math.random() * sum;
            for (const item of candidates) {
                if ((r -= item.weight) <= 0) return item;
            }
            return candidates[candidates.length - 1];
        }

        function onDraw() {
            uiSounds.playClickSound();
            performDraw(false); // 正式抽奖
        }

        function onTrialDraw() {
            uiSounds.playClickSound();
            performDraw(true); // 试抽体验
        }

        function performDraw(isTrial = false) {
            const btn = isTrial ? $('#trialDrawBtn') : $('#drawBtn');
            const drawModeIndicator = $('#drawModeIndicator');
            const trialNotice = $('#trialNotice');

            // 播放抽奖音效
            uiSounds.playDrawSound();

            btn.disabled = true; btn.classList.add('opacity-60');

            // 更新模式指示器
            if (isTrial) {
                drawModeIndicator.textContent = '试抽体验模式';
                trialNotice.classList.remove('hidden');
            } else {
                drawModeIndicator.textContent = '正式抽奖模式';
                trialNotice.classList.add('hidden');

                // 只有正式抽奖才检查次数限制
                if (!canDraw()) {
                    const display = $('#resultDisplay');
                    const meta = $('#resultMeta');
                    display.textContent = '抽奖次数已用完';
                    meta.textContent = '今日抽奖次数已达上限，请明日再来';
                    btn.disabled = false; btn.classList.remove('opacity-60');
                    return;
                }
            }

            const pool = loadPool();
            const picked = weightedPick(pool);
            const display = $('#resultDisplay');
            const meta = $('#resultMeta');

            if (!picked) {
                display.textContent = '奖池为空或库存不足';
                meta.textContent = isTrial ? '试抽无法进行，请联系管理员' : '请联系管理员检查奖池设置';
                btn.disabled = false; btn.classList.remove('opacity-60');
                return;
            }

            // 获取稀有度并应用对应动效
            const rarity = getPrizeRarity(picked.name, picked.weight);
            const rarityConfig = getRarityConfig(rarity);

            // 移除所有可能的动画类
            display.parentElement.classList.remove('spin', 'spin-legendary', 'spin-rare', 'spin-common');

            // 应用对应稀有度的动画
            display.parentElement.classList.add(rarityConfig.animation);

            // 创建稀有度提示效果
            if (!isTrial) {
                showRarityEffect(rarity, rarityConfig);
            }

            setTimeout(() => {
                display.parentElement.classList.remove(rarityConfig.animation);
            }, rarityConfig.duration);

            // 生成券码（仅券类，试抽时显示模拟券码）
            let code = '';
            if (picked.type === '抵扣券' || picked.type === '折扣券') {
                if (isTrial) {
                    code = `${picked.type === '抵扣券' ? 'DK' : 'ZK'}-DEMO-${uid(4)}`; // 试抽显示DEMO券码
                } else {
                    code = `${picked.type === '抵扣券' ? 'DK' : 'ZK'}-${uid(4)}-${uid(4)}`;
                }
            }

            // 只有正式抽奖才扣减库存
            if (!isTrial && picked.quantity > 0) {
                picked.quantity -= 1;
                savePool(pool);
                renderPoolList(pool);
            }

            const record = {
                time: nowStr(),
                prize: picked.name,
                type: picked.type,
                code: code || undefined,
                note: picked.note || ''
            };

            // 只有正式抽奖才保存记录和增加计数
            if (!isTrial) {
                const hist = loadHistory();
                hist.push(record);
                saveHistory(hist);

                // 增加用户抽奖次数计数
                const userCount = loadUserDrawCount();
                saveUserDrawCount(userCount + 1);
                updateDrawLimitDisplay();
                renderHistory();

                // 🎯 触发成就检查系统（延迟执行避免阻塞UI）
                setTimeout(() => {
                    if (typeof checkAchievements === 'function') {
                        checkAchievements(record, picked, rarity);
                    }
                }, 1500);

                // 🏆 根据稀有度给予积分奖励
                const pointsReward = {
                    'common': 10,
                    'rare': 25,
                    'epic': 50,
                    'legendary': 100,

                };

                if (pointsReward[rarity]) {
                    updateUserPoints(pointsReward[rarity]);
                    setTimeout(() => {
                        showMusicNotification(`🎉 获得 ${pointsReward[rarity]} 积分奖励！`, 'success');
                    }, 2000);
                }

                // 如果用户已登录，自动同步数据
                if (isAuthenticated && currentUser) {
                    setTimeout(() => {
                        autoSyncUserData();
                    }, 3000);
                }
            }

            // 播放中奖音效
            setTimeout(() => {
                uiSounds.playWinSound();
            }, 1000);

            // 显示奖品 - 优先显示图片，否则显示emoji
            if (picked.image) {
                display.innerHTML = `<div class="flex flex-col items-center gap-2">
                    <img src="${picked.image}" alt="${picked.name}" class="w-20 h-20 object-cover rounded-lg shadow-md">
                    <span class="text-lg font-bold">${picked.name}</span>
                </div>`;
            } else {
                display.innerHTML = `<div class="flex flex-col items-center gap-2">
                    <span class="text-4xl">${picked.emoji || '🧸'}</span>
                    <span class="text-lg font-bold">${picked.name}</span>
                </div>`;
            }

            let metaText = `${record.type}${record.code ? ' · 券码：' + record.code : ''}`;
            if (isTrial && code) {
                metaText += ' (模拟券码)';
            }
            meta.textContent = metaText;

            setTimeout(() => {
                btn.disabled = false;
                btn.classList.remove('opacity-60');
                // 恢复默认显示
                drawModeIndicator.textContent = '点击按钮开始抽奖';
            }, 400);
        }

        function refreshNow() { $('#now').textContent = nowStr(); }

        // —— 抽奖次数限制相关 ——
        function loadDrawLimit() {
            try {
                const limit = localStorage.getItem(LS_KEYS.DRAW_LIMIT);
                return limit ? parseInt(limit) : 0; // 0表示不限制
            } catch { return 0; }
        }

        function loadUserDrawCount() {
            try {
                const count = localStorage.getItem(LS_KEYS.USER_DRAW_COUNT);
                return count ? parseInt(count) : 0;
            } catch { return 0; }
        }

        function saveUserDrawCount(count) {
            localStorage.setItem(LS_KEYS.USER_DRAW_COUNT, count.toString());
        }

        function updateDrawLimitDisplay() {
            const limit = loadDrawLimit();
            const userCount = loadUserDrawCount();
            const remainingSpan = $('#remainingDraws');
            const drawLimitInfo = $('#drawLimitInfo');

            if (limit === 0) {
                drawLimitInfo.style.display = 'none'; // 不限制时隐藏
            } else {
                drawLimitInfo.style.display = 'block';
                const remaining = Math.max(0, limit - userCount);
                remainingSpan.textContent = `${remaining}`;

                // 根据剩余次数设置颜色
                if (remaining === 0) {
                    remainingSpan.className = 'text-red-600 font-medium';
                } else if (remaining <= 3) {
                    remainingSpan.className = 'text-orange-600 font-medium';
                } else {
                    remainingSpan.className = 'text-green-600 font-medium';
                }
            }
        }

        function canDraw() {
            const limit = loadDrawLimit();
            if (limit === 0) return true; // 不限制

            const userCount = loadUserDrawCount();
            return userCount < limit;
        }



        function exportJSON() {
            const data = JSON.stringify(loadHistory(), null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `labubu_lottery_${Date.now()}.json`;
            a.click();
        }

        function exportCSV() {
            const rows = [['time', 'prize', 'type', 'code_or_note']].concat(
                loadHistory().map(r => [r.time, r.prize, r.type, r.code || r.note || ''])
            );
            const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')).join('\n');
            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `labubu_lottery_${Date.now()}.csv`;
            a.click();
        }



        // —— 事件绑定 ——
        function bind() {
            $('#drawBtn').addEventListener('click', onDraw);
            $('#trialDrawBtn').addEventListener('click', onTrialDraw);
            $('#exportJsonBtn').addEventListener('click', exportJSON);
            $('#exportCsvBtn').addEventListener('click', exportCSV);
        }

        // —— 数据同步监听 ——
        function setupDataSync() {
            // 监听管理员的数据更新广播
            if (syncEnabled && dataChannel) {
                try {
                    dataChannel.addEventListener('message', (event) => {
                        const { type, data, timestamp } = event.data;

                        switch (type) {
                            case 'POOL_UPDATE':
                                if (timestamp > lastPoolUpdate) {
                                    lastPoolUpdate = timestamp;
                                    renderPoolList(loadPool());
                                    showUpdateNotification('奖池配置已更新');
                                }
                                break;
                            case 'DRAW_LIMIT_UPDATE':
                                if (timestamp > lastLimitUpdate) {
                                    lastLimitUpdate = timestamp;
                                    updateDrawLimitDisplay();
                                    showUpdateNotification('抽奖次数限制已更新');
                                }
                                break;
                            case 'USER_COUNT_RESET':
                                updateDrawLimitDisplay();
                                showUpdateNotification('抽奖次数已重置');
                                break;
                            case 'SYSTEM_RESET':
                                location.reload(); // 系统重置时完全刷新页面
                                break;
                        }
                    });
                } catch (error) {
                    console.error('设置消息监听失败:', error);
                    syncEnabled = false;
                }
            }

            // 监听localStorage变化（跨标签页同步）
            window.addEventListener('storage', (event) => {
                if (event.key === LS_KEYS.POOL) {
                    renderPoolList(loadPool());
                    showUpdateNotification('奖池配置已同步');
                } else if (event.key === LS_KEYS.DRAW_LIMIT || event.key === LS_KEYS.USER_DRAW_COUNT) {
                    updateDrawLimitDisplay();
                    showUpdateNotification('抽奖限制已同步');
                }
            });

            // 定期检查数据更新（备用机制）
            setInterval(() => {
                const pool = loadPool();
                renderPoolList(pool);
                updateDrawLimitDisplay();
            }, 30000); // 每30秒检查一次
        }

        function showUpdateNotification(message) {
            // 创建临时通知
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 right-4 bg-[var(--labu)] text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm transition-all duration-300';
            notification.textContent = `📡 ${message}`;
            document.body.appendChild(notification);

            // 3秒后自动消失
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        function init() {
            $('#year').textContent = new Date().getFullYear();
            refreshNow(); setInterval(refreshNow, 1000);
            const pool = loadPool();
            renderPoolList(pool);
            renderHistory();
            updateDrawLimitDisplay();
            setupDataSync(); // 启动数据同步
        }

        // —— 音乐播放器功能 ——
        let musicLibrary = [
            // 默认音乐库，将通过API动态加载
        ];

        // Jamendo API配置
        const JAMENDO_CLIENT_ID = '709fa152'; // 官方测试ID
        const JAMENDO_API_BASE = 'https://api.jamendo.com/v3.0';

        // 检测微信环境
        function isWeChatBrowser() {
            return /micromessenger/i.test(navigator.userAgent);
        }

        // 获取欧美流行音乐（增加微信兼容性）
        async function loadMusicFromAPI() {
            // 微信环境直接使用本地音乐库
            if (isWeChatBrowser()) {
                console.log('🎵 检测到微信环境，使用本地音乐库');
                musicLibrary = loadLocalMusicConfig();
                return true;
            }

            try {
                // 添加超时控制
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10秒超时

                // 获取流行音乐和电子音乐
                const [popResponse, electroResponse, rockResponse] = await Promise.all([
                    fetch(`${JAMENDO_API_BASE}/tracks/?client_id=${JAMENDO_CLIENT_ID}&format=json&limit=5&tags=pop&include=musicinfo&audioformat=mp32`, {
                        signal: controller.signal,
                        mode: 'cors'
                    }),
                    fetch(`${JAMENDO_API_BASE}/tracks/?client_id=${JAMENDO_CLIENT_ID}&format=json&limit=3&tags=electronic&include=musicinfo&audioformat=mp32`, {
                        signal: controller.signal,
                        mode: 'cors'
                    }),
                    fetch(`${JAMENDO_API_BASE}/tracks/?client_id=${JAMENDO_CLIENT_ID}&format=json&limit=2&tags=rock&include=musicinfo&audioformat=mp32`, {
                        signal: controller.signal,
                        mode: 'cors'
                    })
                ]);

                clearTimeout(timeoutId);

                if (!popResponse.ok || !electroResponse.ok || !rockResponse.ok) {
                    throw new Error('API请求失败');
                }

                const popData = await popResponse.json();
                const electroData = await electroResponse.json();
                const rockData = await rockResponse.json();

                // 合并所有音乐
                const allTracks = [
                    ...(popData.results || []),
                    ...(electroData.results || []),
                    ...(rockData.results || [])
                ];

                if (allTracks.length === 0) {
                    throw new Error('未获取到音乐数据');
                }

                // 转换为我们的音乐库格式
                musicLibrary = allTracks.map(track => ({
                    id: track.id,
                    title: track.name || 'Unknown Title',
                    artist: track.artist_name || 'Unknown Artist',
                    album: track.album_name || 'Unknown Album',
                    url: track.audio || track.audiodownload,
                    duration: formatDuration(track.duration),
                    image: track.album_image || track.image,
                    jamendoUrl: `https://www.jamendo.com/track/${track.id}`
                }));

                console.log('🎵 已加载', musicLibrary.length, '首免费音乐');
                return true;
            } catch (error) {
                console.error('❌ 加载音乐失败:', error);
                // 优先使用本地音乐配置
                musicLibrary = loadLocalMusicConfig();
                console.log('🎵 使用本地音乐库:', musicLibrary.length, '首');
                return false;
            }
        }

        // 加载本地音乐配置
        function loadLocalMusicConfig() {
            if (window.LOCAL_MUSIC_LIBRARY) {
                return window.LOCAL_MUSIC_LIBRARY;
            }

            // 如果外部配置不可用，使用内置配置
            return [
                {
                    id: 'local-1',
                    title: 'Happy Melody',
                    artist: 'Labubu Band',
                    album: 'Fun Collection',
                    url: 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEcCT2J0O/kjzQMKm3A9OOeSxALUJzk77hhEgxAi/nIaz4eNk9s',
                    duration: '2:30',
                    image: 'https://picsum.photos/400/400?random=6',
                    genre: '轻音乐'
                },
                {
                    id: 'local-2',
                    title: 'Chill Vibes',
                    artist: 'Cookie Ann Crew',
                    album: 'Sweet Sounds',
                    url: 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEcCT2J0O/kjzQMKm3A9OOeSxALUJzk77hhEgxAi/nIaz4eNk9s',
                    duration: '3:15',
                    image: 'https://picsum.photos/400/400?random=7',
                    genre: '环境音乐'
                }
            ];
        }

        // 内置音乐库（包含免费可播放的音频）
        function getWeChatMusicLibrary() {
            return [
                {
                    title: "🎵 Labubu幸运之歌",
                    artist: "基金会音乐团",
                    album: "背景音乐合集",
                    url: "https://www.w3schools.com/html/horse.mp3",
                    duration: "0:30",
                    image: "",
                    jamendoUrl: "#"
                },
                {
                    title: "🎶 抽奖进行曲",
                    artist: "系统音乐",
                    album: "专享音乐",
                    url: "https://www.learningcontainer.com/wp-content/uploads/2020/02/Kalimba.mp3",
                    duration: "5:30",
                    image: "",
                    jamendoUrl: "#"
                },
                {
                    title: "🏆 胜利庆典",
                    artist: "庆祝音乐",
                    album: "获奖音效",
                    url: "https://archive.org/download/testmp3testfile/mpthreetest.mp3",
                    duration: "0:30",
                    image: "",
                    jamendoUrl: "#"
                },
                {
                    title: "🌸 温馨背景",
                    artist: "环境音乐",
                    album: "氛围音乐",
                    url: "https://www.w3schools.com/html/horse.mp3",
                    duration: "0:30",
                    image: "",
                    jamendoUrl: "#"
                },
                {
                    title: "🎠 欢乐时光",
                    artist: "Labubu乐团",
                    album: "快乐合集",
                    url: "https://www.learningcontainer.com/wp-content/uploads/2020/02/Kalimba.mp3",
                    duration: "5:30",
                    image: "",
                    jamendoUrl: "#"
                },
                {
                    title: "🚀 梦想起航",
                    artist: "励志音乐",
                    album: "正能量",
                    url: "https://www.w3schools.com/html/horse.mp3",
                    duration: "0:30",
                    image: "",
                    jamendoUrl: "#"
                },
                {
                    title: "☀️ 午后阳光",
                    artist: "轻音乐",
                    album: "放松时光",
                    url: "https://www.learningcontainer.com/wp-content/uploads/2020/02/Kalimba.mp3",
                    duration: "5:30",
                    image: "",
                    jamendoUrl: "#"
                },
                {
                    title: "⭐ 星空下的梦",
                    artist: "夜曲精选",
                    album: "安静旋律",
                    url: "https://www.w3schools.com/html/horse.mp3",
                    duration: "0:30",
                    image: "",
                    jamendoUrl: "#"
                },
                {
                    title: "🎀 甜美旋律",
                    artist: "可爱音乐",
                    album: "Labubu专属",
                    url: "https://www.learningcontainer.com/wp-content/uploads/2020/02/Kalimba.mp3",
                    duration: "5:30",
                    image: "",
                    jamendoUrl: "#"
                },
                {
                    title: "💫 奇幻之旅",
                    artist: "魔法音乐",
                    album: "幻想世界",
                    url: "https://www.w3schools.com/html/horse.mp3",
                    duration: "0:30",
                    image: "",
                    jamendoUrl: "#"
                }
            ];
        }

        // 时长格式化
        function formatDuration(seconds) {
            if (!seconds) return "0:00";
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        let currentSongIndex = 0;
        let isPlaying = false;
        let currentAudio = null;
        let isPlayerMinimized = true; // 默认最小化

        // 简单的UI音效系统
        class UISoundManager {
            constructor() {
                this.enabled = localStorage.getItem('ui_sound_enabled') !== 'false';
                this.audioContext = null;
                this.initAudioContext();
            }

            initAudioContext() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('音效不支持');
                }
            }

            createBeep(frequency, duration, type = 'sine') {
                if (!this.audioContext || !this.enabled) return;

                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                oscillator.frequency.value = frequency;
                oscillator.type = type;

                gainNode.gain.setValueAtTime(0.05, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);

                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            }

            playDrawSound() {
                this.createBeep(440, 0.1);
                setTimeout(() => this.createBeep(554.37, 0.1), 100);
                setTimeout(() => this.createBeep(659.25, 0.2), 200);
            }

            playWinSound() {
                this.createBeep(523.25, 0.15);
                setTimeout(() => this.createBeep(659.25, 0.15), 150);
                setTimeout(() => this.createBeep(783.99, 0.3), 300);
            }

            playClickSound() {
                this.createBeep(800, 0.1, 'square');
            }

            playNotificationSound() {
                this.createBeep(880, 0.15);
            }

            toggle() {
                this.enabled = !this.enabled;
                localStorage.setItem('ui_sound_enabled', this.enabled.toString());
                return this.enabled;
            }
        }

        const uiSounds = new UISoundManager();

        // 自动播放功能
        function startAutoPlay() {
            try {
                console.log('🎵 尝试自动播放音乐...');

                // 检查是否有音频对象
                if (currentAudio) {
                    // 先设置较低的音量，避免突然的大声音乐
                    currentAudio.volume = 0.4;

                    // 添加音频加载监听器
                    currentAudio.addEventListener('canplaythrough', () => {
                        console.log('🎵 音频文件加载完成，准备播放');
                    });

                    currentAudio.addEventListener('error', (e) => {
                        console.error('🎵 音频加载错误:', e);
                        // 如果当前音频失败，尝试下一首
                        tryNextSong();
                    });

                    const playPromise = currentAudio.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            isPlaying = true;
                            updatePlayButtons();
                            showMusicNotification('🎵 欢迎！背景音乐已自动开始', 'success');
                            console.log('🎵 自动播放成功');
                        }).catch(error => {
                            console.log('🎵 自动播放被浏览器阻止，需要用户交互后才能播放');

                            // 如果自动播放被阻止，显示提示并启用用户点击播放
                            showMusicNotification('🎵 点击任意位置启用音乐播放', 'info');
                            enableUserInteractionPlay();
                        });
                    }
                } else {
                    // 如果没有音频对象，尝试重新加载第一首歌
                    console.log('🎵 currentAudio为空，尝试重新加载音乐...');
                    if (musicLibrary && musicLibrary.length > 0) {
                        loadSong(0);
                        // 等待音频加载完成后再次尝试播放
                        setTimeout(() => {
                            if (currentAudio) {
                                console.log('🎵 重新加载后尝试自动播放...');
                                currentAudio.volume = 0.3;
                                const playPromise = currentAudio.play();
                                if (playPromise !== undefined) {
                                    playPromise.then(() => {
                                        isPlaying = true;
                                        updatePlayButtons();
                                        showMusicNotification('🎵 音乐已重新加载并开始播放', 'success');
                                        console.log('🎵 重新加载后自动播放成功');
                                    }).catch(error => {
                                        console.log('🎵 重新加载后自动播放仍被阻止');
                                        showMusicNotification('🎵 点击任意位置启用音乐播放', 'info');
                                        enableUserInteractionPlay();
                                    });
                                }
                            } else {
                                // 如果仍然没有音频对象，启动模拟播放
                                console.log('🎵 重新加载失败，启动模拟播放模式');
                                isPlaying = true;
                                updatePlayButtons();
                                simulatePlayback();
                                showMusicNotification('🎵 音乐播放器已启动（模拟模式）', 'info');
                            }
                        }, 1500); // 给音频加载更多时间
                    } else {
                        console.log('🎵 音乐库为空，启动模拟播放模式');
                        isPlaying = true;
                        updatePlayButtons();
                        simulatePlayback();
                        showMusicNotification('🎵 音乐播放器已启动（模拟模式）', 'info');
                    }
                }
            } catch (error) {
                console.error('🎵 自动播放失败:', error);
                showMusicNotification('🎵 音乐播放器启动失败', 'error');
            }
        }

        // 启用用户交互播放（当自动播放被阻止时）
        function enableUserInteractionPlay() {
            const enableMusic = () => {
                if (!isPlaying && currentAudio) {
                    currentAudio.volume = 0.3;
                    const playPromise = currentAudio.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            isPlaying = true;
                            updatePlayButtons();
                            showMusicNotification('🎵 音乐播放已启用', 'success');

                            // 移除事件监听器
                            document.removeEventListener('click', enableMusic);
                            document.removeEventListener('touchstart', enableMusic);
                            document.removeEventListener('keydown', enableMusic);
                        }).catch(error => {
                            console.log('🎵 播放失败:', error);
                        });
                    }
                }
            };

            // 添加多种用户交互事件监听器
            document.addEventListener('click', enableMusic, { once: true });
            document.addEventListener('touchstart', enableMusic, { once: true });
            document.addEventListener('keydown', enableMusic, { once: true });

            // 特别监听抽奖相关按钮
            setTimeout(() => {
                const drawBtns = document.querySelectorAll('#drawBtn, #trialDrawBtn, .enhanced-btn, [onclick*="onDraw"], [onclick*="performDraw"]');
                drawBtns.forEach(btn => {
                    if (btn) {
                        btn.addEventListener('click', enableMusic, { once: true });
                        console.log('🎵 已绑定抽奖按钮音乐触发器');
                    }
                });
            }, 1000);
        }

        async function initMusicPlayer() {
            try {
                // 显示环境信息
                if (isWeChatBrowser()) {
                    showMusicNotification('🎵 微信环境已优化，音乐功能正常', 'success');
                }

                // 先加载音乐库
                const loadSuccess = await loadMusicFromAPI();
                if (loadSuccess) {
                    if (isWeChatBrowser()) {
                        console.log('🎵 微信环境使用内置音乐库');
                    } else {
                        console.log('🎵 成功加载Jamendo音乐库');
                    }
                } else {
                    console.log('🎵 使用备用音乐库');
                }

                renderPlaylist();
                if (musicLibrary.length > 0) {
                    // 随机选择一首歌开始播放
                    const randomIndex = Math.floor(Math.random() * musicLibrary.length);
                    loadSong(randomIndex);

                    // 立即尝试自动播放
                    startAutoPlay();

                    // 备用启动机制1 - 1秒后检查播放状态
                    setTimeout(() => {
                        if (!isPlaying && currentAudio) {
                            console.log('🎵 第一次自动播放失败，启用用户交互模式');
                            enableUserInteractionPlay();
                        }
                    }, 1000);

                    // 备用启动机制2 - 如果3秒后仍然没有播放，尝试重新加载
                    setTimeout(() => {
                        if (!isPlaying && musicLibrary.length > 0) {
                            console.log('🎵 备用启动：重新尝试加载和播放音乐');
                            // 再次随机选择歌曲
                            const backupRandomIndex = Math.floor(Math.random() * musicLibrary.length);
                            loadSong(backupRandomIndex);
                            setTimeout(() => {
                                startAutoPlay();
                                enableUserInteractionPlay();
                            }, 500);
                        }
                    }, 3000);
                }

                // 确保DOM元素存在后再初始化
                const miniPlayer = $('#musicPlayerMini');
                const fullPlayer = $('#musicPlayerFull');
                const closeBtn = $('#closePlayer');

                console.log('🎵 DOM元素检查:', {
                    miniPlayer: !!miniPlayer,
                    fullPlayer: !!fullPlayer,
                    closeBtn: !!closeBtn
                });

                if (miniPlayer && fullPlayer) {
                    // 初始化为小按钮状态
                    miniPlayer.classList.remove('hidden');
                    fullPlayer.classList.add('hidden');
                    console.log('🎵 播放器初始状态设置完成');
                } else {
                    console.warn('🎵 音乐播放器DOM元素未找到');
                    console.warn('miniPlayer:', miniPlayer);
                    console.warn('fullPlayer:', fullPlayer);
                }

                // 绑定播放器控制事件
                const playPauseBtn = $('#playPauseBtn');
                const prevBtn = $('#prevBtn');
                const nextBtn = $('#nextBtn');
                const volumeSlider = $('#volumeSlider');
                const progressContainer = $('#progressContainer');

                console.log('🎵 控制元素检查:', {
                    playPauseBtn: !!playPauseBtn,
                    prevBtn: !!prevBtn,
                    nextBtn: !!nextBtn,
                    volumeSlider: !!volumeSlider,
                    progressContainer: !!progressContainer
                });

                // 小按钮和完整播放器切换
                if (miniPlayer) {
                    miniPlayer.addEventListener('click', () => {
                        console.log('🎵 小按钮被点击');
                        showFullPlayer();
                    });
                    console.log('🎵 小按钮点击事件已绑定');
                } else {
                    console.error('🎵 小按钮元素未找到，无法绑定点击事件');
                }

                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        console.log('🎵 关闭按钮被点击');
                        showMiniPlayer();
                    });
                    console.log('🎵 关闭按钮点击事件已绑定');
                } else {
                    console.error('🎵 关闭按钮元素未找到');
                }

                // 播放控制
                if (playPauseBtn) {
                    playPauseBtn.addEventListener('click', () => {
                        console.log('🎵 播放/暂停按钮被点击');
                        togglePlayPause();
                    });
                }
                if (prevBtn) prevBtn.addEventListener('click', previousSong);
                if (nextBtn) nextBtn.addEventListener('click', nextSong);

                // 音量控制
                if (volumeSlider) volumeSlider.addEventListener('input', adjustVolume);

                // 进度条点击跳转
                if (progressContainer) progressContainer.addEventListener('click', seekToPosition);

                console.log('🎵 音乐播放器初始化完成');
            } catch (error) {
                console.error('🎵 音乐播放器初始化失败:', error);
                showMusicNotification('音乐播放器初始化失败', 'error');
            }
        }

        function renderPlaylist() {
            const playlist = $('#playlist');
            if (!playlist) return;

            playlist.innerHTML = '';

            if (musicLibrary.length === 0) {
                playlist.innerHTML = '<div class="text-xs text-slate-500 p-2">🎵 正在加载音乐...</div>';
                return;
            }

            musicLibrary.forEach((song, index) => {
                const songItem = document.createElement('div');
                songItem.className = `cursor-pointer p-2 rounded text-xs hover:bg-slate-100 transition-colors ${index === currentSongIndex ? 'bg-[var(--labu)] text-white' : ''}`;
                songItem.innerHTML = `
                    <div class="font-medium truncate">${song.title}</div>
                    <div class="text-xs opacity-75 truncate">${song.artist}</div>
                    <div class="text-xs opacity-60 truncate">${song.duration || ''}</div>
                `;
                songItem.addEventListener('click', () => loadSong(index));
                playlist.appendChild(songItem);
            });
        }

        function loadSong(index) {
            if (!musicLibrary || musicLibrary.length === 0) return;

            currentSongIndex = index;
            const song = musicLibrary[index];

            // 停止当前播放
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
            }

            // 更新UI
            const currentSongEl = $('#currentSong');
            const currentArtistEl = $('#currentArtist');
            const miniSongNameEl = $('#miniSongName');
            const totalTimeEl = $('#totalTime');

            if (currentSongEl) currentSongEl.textContent = `${song.title} - ${song.artist}`;

            console.log('🎵 正在加载歌曲:', song.title, 'URL:', song.url);
            if (currentArtistEl) currentArtistEl.textContent = song.artist;
            if (miniSongNameEl) miniSongNameEl.textContent = `${song.title} - ${song.artist}`;
            if (totalTimeEl) totalTimeEl.textContent = song.duration || "0:00";

            // 创建新的音频对象
            if (song.url && song.url !== '') {
                try {
                    currentAudio = new Audio(song.url);
                    currentAudio.preload = 'auto';
                    currentAudio.volume = 0.4;

                    // 对于本地文件，不需要CORS设置
                    if (!song.url.startsWith('music/')) {
                        currentAudio.crossOrigin = "anonymous";
                    }

                    // 音频加载完成
                    currentAudio.addEventListener('loadeddata', () => {
                        console.log('🎵 音频已加载:', song.title);
                        if (totalTimeEl) {
                            totalTimeEl.textContent = formatDuration(currentAudio.duration);
                        }
                    });

                    // 播放时更新进度
                    currentAudio.addEventListener('timeupdate', updateProgress);

                    // 播放结束自动下一首
                    currentAudio.addEventListener('ended', () => {
                        nextSong();
                    });

                    // 错误处理
                    currentAudio.addEventListener('error', (e) => {
                        console.warn('🎵 音频加载失败:', song.title, e);
                        showMusicNotification('音频加载失败，已跳到下一首', 'error');
                        nextSong();
                    });
                } catch (error) {
                    console.warn('🎵 音频创建失败:', error);
                }
            } else {
                console.warn('🎵 无效的音频URL或文件路径:', song.url);
            }

            renderPlaylist();
            isPlaying = false;
            updatePlayButtons();
        }

        // 显示完整播放器
        function showFullPlayer() {
            console.log('🎵 showFullPlayer 函数被调用');
            const miniPlayer = $('#musicPlayerMini');
            const fullPlayer = $('#musicPlayerFull');

            console.log('🎵 元素检查 - showFullPlayer:', {
                miniPlayer: !!miniPlayer,
                fullPlayer: !!fullPlayer,
                miniPlayerClasses: miniPlayer ? miniPlayer.className : 'null',
                fullPlayerClasses: fullPlayer ? fullPlayer.className : 'null'
            });

            if (miniPlayer && fullPlayer) {
                miniPlayer.classList.add('hidden');
                fullPlayer.classList.remove('hidden');
                console.log('🎵 完整播放器已显示');

                // 显示用户通知
                if (typeof showMusicNotification === 'function') {
                    showMusicNotification('🎵 音乐播放器已展开', 'success');
                }
            } else {
                console.error('🎵 showFullPlayer: DOM元素未找到');
                if (!miniPlayer) console.error('miniPlayer 元素未找到');
                if (!fullPlayer) console.error('fullPlayer 元素未找到');
            }
        }

        // 显示小按钮播放器
        function showMiniPlayer() {
            console.log('🎵 showMiniPlayer 函数被调用');
            const miniPlayer = $('#musicPlayerMini');
            const fullPlayer = $('#musicPlayerFull');

            console.log('🎵 元素检查 - showMiniPlayer:', {
                miniPlayer: !!miniPlayer,
                fullPlayer: !!fullPlayer,
                miniPlayerClasses: miniPlayer ? miniPlayer.className : 'null',
                fullPlayerClasses: fullPlayer ? fullPlayer.className : 'null'
            });

            if (miniPlayer && fullPlayer) {
                fullPlayer.classList.add('hidden');
                miniPlayer.classList.remove('hidden');
                console.log('🎵 小按钮播放器已显示');

                // 显示用户通知
                if (typeof showMusicNotification === 'function') {
                    showMusicNotification('🎵 音乐播放器已收起', 'info');
                }
            } else {
                console.error('🎵 showMiniPlayer: DOM元素未找到');
                if (!miniPlayer) console.error('miniPlayer 元素未找到');
                if (!fullPlayer) console.error('fullPlayer 元素未找到');
            }
        }

        // 音量控制
        function adjustVolume(event) {
            const volume = event.target.value / 100;
            if (currentAudio) {
                currentAudio.volume = volume;
                console.log('🎵 音量调节至:', Math.round(volume * 100) + '%');
            }
        }

        // 进度条点击跳转
        function seekToPosition(event) {
            if (!currentAudio || !currentAudio.duration) return;

            const progressContainer = event.currentTarget;
            const rect = progressContainer.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const percentage = clickX / rect.width;
            const newTime = percentage * currentAudio.duration;

            currentAudio.currentTime = newTime;
            console.log('🎵 跳转到:', formatDuration(newTime));
        }

        function togglePlayPause() {
            if (!currentAudio) {
                // 如果没有音频，尝试重新加载当前歌曲
                if (musicLibrary.length > 0) {
                    loadSong(currentSongIndex);
                    setTimeout(() => {
                        if (currentAudio) {
                            togglePlayPause();
                        } else {
                            showMusicNotification('🎵 模拟播放模式', 'info');
                            isPlaying = !isPlaying;
                            updatePlayButtons();
                            if (isPlaying) {
                                simulatePlayback();
                            }
                        }
                    }, 500);
                } else {
                    showMusicNotification('🎵 模拟播放模式', 'info');
                    isPlaying = !isPlaying;
                    updatePlayButtons();
                    if (isPlaying) {
                        simulatePlayback();
                    }
                }
                return;
            }

            if (isPlaying) {
                currentAudio.pause();
                isPlaying = false;
                showMusicNotification('⏸️ 暂停播放', 'info');
            } else {
                const playPromise = currentAudio.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        isPlaying = true;
                        showMusicNotification('▶️ 开始播放', 'success');
                    }).catch(error => {
                        console.error('🎵 播放失败:', error);
                        showMusicNotification('🎵 模拟播放模式', 'info');
                        isPlaying = true;
                        simulatePlayback();
                    });
                }
            }

            updatePlayButtons();
        }

        // 模拟播放功能（当没有真实音频时）
        let simulationInterval;
        function simulatePlayback() {
            if (simulationInterval) clearInterval(simulationInterval);

            let simTime = 0;
            const maxTime = 180; // 3分钟

            simulationInterval = setInterval(() => {
                if (!isPlaying) {
                    clearInterval(simulationInterval);
                    return;
                }

                simTime += 1;
                const progress = (simTime / maxTime) * 100;
                const progressBar = $('#progressBar');
                const currentTimeEl = $('#currentTime');

                if (progressBar) progressBar.style.width = Math.min(progress, 100) + '%';
                if (currentTimeEl) currentTimeEl.textContent = formatDuration(simTime);

                // 模拟播放完成
                if (simTime >= maxTime) {
                    clearInterval(simulationInterval);
                    nextSong();
                }
            }, 1000);
        }

        function updatePlayButtons() {
            const playBtn = $('#playPauseBtn');
            const miniMusicIcon = $('#miniMusicIcon');

            if (playBtn) playBtn.textContent = isPlaying ? '⏸️' : '▶️';

            // 更新小按钮的状态
            if (miniMusicIcon) {
                if (isPlaying) {
                    miniMusicIcon.textContent = '🎵';
                    miniMusicIcon.classList.add('animate-pulse');
                } else {
                    miniMusicIcon.textContent = '⏸️';
                    miniMusicIcon.classList.remove('animate-pulse');
                }
            }
        }

        function previousSong() {
            if (musicLibrary.length === 0) return;
            currentSongIndex = (currentSongIndex - 1 + musicLibrary.length) % musicLibrary.length;
            loadSong(currentSongIndex);
            if (isPlaying && currentAudio) {
                currentAudio.play().catch(console.error);
            }
        }

        function nextSong() {
            if (musicLibrary.length === 0) return;
            currentSongIndex = (currentSongIndex + 1) % musicLibrary.length;
            loadSong(currentSongIndex);
            if (isPlaying && currentAudio) {
                currentAudio.play().catch(console.error);
            }
        }

        // 更新播放进度（使用真实音频）
        function updateProgress() {
            if (!currentAudio) return;

            const currentTime = currentAudio.currentTime;
            const duration = currentAudio.duration;

            if (duration) {
                const progress = (currentTime / duration) * 100;
                const progressBar = $('#progressBar');
                const currentTimeEl = $('#currentTime');

                if (progressBar) progressBar.style.width = progress + '%';
                if (currentTimeEl) currentTimeEl.textContent = formatDuration(currentTime);
            }
        }

        // 音乐通知
        function showMusicNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' : 'bg-blue-500';

            notification.className = `fixed top-20 left-4 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm transition-all duration-300 transform -translate-x-full`;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);

            setTimeout(() => {
                notification.style.transform = 'translateX(-100%)';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        // —— 留言系统功能 ——
        const COMMENTS_API_URL = 'https://api.jsonbin.io/v3/b/67565e7bad19ca34f8cd4c52';
        const API_KEY = '$2a$10$VjQj.Gc8Q7q8q4k4K4k4Ou'; // 免费API密钥示例

        let comments = [];
        let currentCommentUser = '';

        function initCommentSystem() {
            loadComments();
            updateCommentLoginStatus(); // 更新登录状态显示

            $('#submitComment').addEventListener('click', submitComment);
            $('#commentInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && e.ctrlKey) {
                    submitComment();
                }
            });

            // 每30秒自动刷新留言
            setInterval(loadComments, 30000);

            // 每5秒检查登录状态
            setInterval(updateCommentLoginStatus, 5000);
        }

        // 更新留言区登录状态显示
        function updateCommentLoginStatus() {
            const avatarEl = $('#commentUserAvatar');
            const nameEl = $('#commentUserName');
            const statusEl = $('#commentUserStatus');
            const loginBtn = $('#commentLoginBtn');
            const commentInput = $('#commentInput');
            const submitBtn = $('#submitComment');

            try {
                const savedAuth = localStorage.getItem('labubu_user_auth');
                if (savedAuth) {
                    const currentUser = JSON.parse(savedAuth);
                    if (currentUser.phoneNumber) {
                        // 已登录状态
                        const maskedPhone = currentUser.phoneNumber.replace(/(\+\d{1,3})(\d{3})(\d{4})(\d{4})/, '$1 $2****$4');

                        avatarEl.className = 'w-8 h-8 bg-gradient-to-br from-green-500 to-blue-500 rounded-full flex items-center justify-center text-white text-sm';
                        avatarEl.textContent = '✅';
                        nameEl.textContent = maskedPhone;
                        statusEl.textContent = '已登录 · 可以发表留言';
                        loginBtn.style.display = 'none';

                        // 启用留言功能
                        commentInput.disabled = false;
                        submitBtn.disabled = false;
                        commentInput.placeholder = '说点什么吧... 🎯';
                        return;
                    }
                }

                // 未登录状态
                avatarEl.className = 'w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white text-sm';
                avatarEl.textContent = '👤';
                nameEl.textContent = '未登录';
                statusEl.textContent = '请登录后发表留言';
                loginBtn.style.display = 'block';

                // 禁用留言功能
                commentInput.disabled = true;
                submitBtn.disabled = true;
                commentInput.placeholder = '请先登录后再发表留言';

            } catch (error) {
                console.error('更新留言登录状态失败:', error);
            }
        }

        function submitComment() {
            const content = $('#commentInput').value.trim();

            if (!content) {
                alert('请输入留言内容');
                return;
            }

            // 获取当前登录用户信息
            let userName = '匿名用户';
            try {
                const savedAuth = localStorage.getItem('labubu_user_auth');
                if (savedAuth) {
                    const currentUser = JSON.parse(savedAuth);
                    if (currentUser.phoneNumber) {
                        // 使用掩码手机号作为用户名
                        userName = currentUser.phoneNumber.replace(/(\+\d{1,3})(\d{3})(\d{4})(\d{4})/, '$1 $2****$4');
                    }
                } else {
                    // 未登录不能发表留言
                    alert('请先登录后再发表留言');
                    return;
                }
            } catch (error) {
                console.error('获取用户信息失败:', error);
                alert('请先登录后再发表留言');
                return;
            }

            const comment = {
                id: Date.now().toString(),
                user: userName,
                content: content,
                timestamp: new Date().toLocaleString(),
                replies: []
            };

            comments.unshift(comment);
            saveComments();
            $('#commentInput').value = '';
            renderComments();

            showMusicNotification('留言发表成功！', 'success');
        }

        function replyToComment(commentId) {
            const replyContent = prompt('回复内容：');
            if (!replyContent) return;

            // 获取当前登录用户信息
            let userName = '匿名用户';
            try {
                const savedAuth = localStorage.getItem('labubu_user_auth');
                if (savedAuth) {
                    const currentUser = JSON.parse(savedAuth);
                    if (currentUser.phoneNumber) {
                        userName = currentUser.phoneNumber.replace(/(\+\d{1,3})(\d{3})(\d{4})(\d{4})/, '$1 $2****$4');
                    }
                } else {
                    alert('请先登录后再回复');
                    return;
                }
            } catch (error) {
                console.error('获取用户信息失败:', error);
                alert('请先登录后再回复');
                return;
            }

            const reply = {
                id: Date.now().toString(),
                user: userName,
                content: replyContent,
                timestamp: new Date().toLocaleString()
            };

            const comment = comments.find(c => c.id === commentId);
            if (comment) {
                comment.replies = comment.replies || [];
                comment.replies.push(reply);
                saveComments();
                renderComments();
                showMusicNotification('回复发表成功！', 'success');
            }
        }

        function deleteComment(commentId) {
            // 只有管理员可以删除（这里简化检查）
            if (!confirm('确认删除此留言？（仅管理员可操作）')) return;

            comments = comments.filter(c => c.id !== commentId);
            saveComments();
            renderComments();
        }

        function renderComments() {
            const container = $('#commentsList');

            if (comments.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-slate-400 py-8">
                        <div class="text-4xl mb-2">💭</div>
                        <div>暂无留言，快来说点什么吧！</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            comments.forEach(comment => {
                const commentElement = document.createElement('div');
                commentElement.className = 'comment-bubble p-4 rounded-lg border border-slate-200';

                commentElement.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <span class="font-medium text-sm">${comment.user}</span>
                            <span class="text-xs text-slate-500">${comment.timestamp}</span>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="replyToComment('${comment.id}')" class="text-xs text-blue-600 hover:underline">回复</button>
                            <button onclick="deleteComment('${comment.id}')" class="text-xs text-red-600 hover:underline">删除</button>
                        </div>
                    </div>
                    <div class="text-sm text-slate-700 mb-2">${comment.content}</div>
                    ${comment.replies && comment.replies.length > 0 ? `
                        <div class="space-y-2 mt-3">
                            ${comment.replies.map(reply => `
                                <div class="comment-reply p-2 rounded text-xs">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="font-medium">${reply.user}</span>
                                        <span class="text-slate-500">${reply.timestamp}</span>
                                    </div>
                                    <div class="text-slate-700">${reply.content}</div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                `;

                container.appendChild(commentElement);
            });

            $('#commentCount').textContent = comments.length;
        }

        function loadComments() {
            // 模拟从API加载数据（实际项目中需要真实API）
            const savedComments = localStorage.getItem('labubu_comments');
            if (savedComments) {
                comments = JSON.parse(savedComments);
                renderComments();
            }
        }

        function saveComments() {
            // 模拟保存到API（实际项目中需要真实API）
            localStorage.setItem('labubu_comments', JSON.stringify(comments));
        }

        // 更新导航链接
        function updateNavigation() {
            const nav = $('nav');
            const commentsLink = document.createElement('a');
            commentsLink.href = '#comments';
            commentsLink.className = 'hover:underline flex items-center gap-1';
            commentsLink.innerHTML = '💬 留言';
            nav.appendChild(commentsLink);
        }

        // 音乐播放器和留言系统初始化完成
        // 这个init函数已经合并到下面的主init函数中

        // —— 自定义鼠标和交互效果 ——
        let cursorInitialized = false; // 防止重复初始化
        let customCursorEnabled = false;
        let cursorFallbackTimer = null;

        function initCustomCursor() {
            // 如果已经初始化过，直接返回
            if (cursorInitialized) {
                console.log('🖱️ 自定义光标已初始化，跳过重复初始化');
                return;
            }

            try {
                const cursor = $('.custom-cursor');
                if (!cursor) {
                    console.warn('🖱️ 自定义光标元素未找到，使用系统光标');
                    enableCursorFallback();
                    return;
                }

                let mouseX = 0, mouseY = 0;

                // 初始化光标位置
                cursor.style.left = '0px';
                cursor.style.top = '0px';
                cursor.style.display = 'block';
                cursor.style.opacity = '1';

                // 设置一个定时器，如果3秒后用户没有移动鼠标，则启用备用光标
                cursorFallbackTimer = setTimeout(() => {
                    if (!customCursorEnabled) {
                        console.log('🖱️ 自定义光标可能有问题，启用备用方案');
                        enableCursorFallback();
                    }
                }, 3000);

                // 鼠标移动跟踪
                document.addEventListener('mousemove', (e) => {
                    mouseX = e.clientX;
                    mouseY = e.clientY;
                    cursor.style.left = mouseX + 'px';
                    cursor.style.top = mouseY + 'px';

                    // 第一次移动时标记为已启用
                    if (!customCursorEnabled) {
                        customCursorEnabled = true;
                        document.body.classList.add('custom-cursor-enabled');
                        if (cursorFallbackTimer) {
                            clearTimeout(cursorFallbackTimer);
                            cursorFallbackTimer = null;
                        }
                        console.log('🖱️ 自定义光标成功启用');
                    }

                    // 创建尾随光效
                    createCursorTrail(mouseX, mouseY);

                    // 侧边互动检测
                    if (mouseX < 100) {
                        createSideParticle('left', mouseY);
                    } else if (mouseX > window.innerWidth - 100) {
                        createSideParticle('right', mouseY);
                    }
                });

                // 点击效果
                document.addEventListener('mousedown', () => {
                    cursor.classList.add('clicking');
                    createMagicParticles(mouseX, mouseY);
                });

                document.addEventListener('mouseup', () => {
                    cursor.classList.remove('clicking');
                });

                cursorInitialized = true;
                console.log('🖱️ 自定义光标初始化完成');

                // 显示光标状态通知
                setTimeout(() => {
                    if (customCursorEnabled) {
                        showMusicNotification('🖱️ 自定义光标已启用', 'success');
                    }
                }, 1000);

            } catch (error) {
                console.error('🖱️ 自定义光标初始化失败:', error);
                enableCursorFallback();
            }
        }

        // 启用备用光标方案
        function enableCursorFallback() {
            document.body.classList.remove('custom-cursor-enabled');
            document.body.classList.add('cursor-fallback');
            console.log('🖱️ 已启用系统光标备用方案');

            // 隐藏自定义光标元素
            const cursor = $('.custom-cursor');
            if (cursor) {
                cursor.style.display = 'none';
            }

            showMusicNotification('🖱️ 使用系统光标', 'info');
        }

        // 切换光标模式的函数（可以在控制台调用）
        function toggleCursorMode() {
            if (document.body.classList.contains('cursor-fallback')) {
                // 尝试重新启用自定义光标
                document.body.classList.remove('cursor-fallback');
                customCursorEnabled = false;
                cursorInitialized = false;
                const cursor = $('.custom-cursor');
                if (cursor) {
                    cursor.style.display = 'block';
                }
                initCustomCursor();
                showMusicNotification('🖱️ 尝试重新启用自定义光标', 'info');
            } else {
                // 切换到系统光标
                enableCursorFallback();
            }
        }

        // 将切换函数暴露到全局，方便调试
        window.toggleCursorMode = toggleCursorMode;

        // 暴露音乐播放器函数到全局，方便调试
        window.showFullPlayer = showFullPlayer;
        window.showMiniPlayer = showMiniPlayer;
        window.togglePlayPause = togglePlayPause;

        // 🌐 简单免费数据存储配置
        const DATA_STORAGE_CONFIG = {
            // JSONBin.io - 免费JSON数据存储
            jsonbin: {
                baseUrl: 'https://api.jsonbin.io/v3',
                apiKey: '$2a$10$5Ht9Y4s.N25zjQb6I6QWb.yRqPjZdPrLs5zKkGgI8/XGo7H8bHSpe', // 免费API密钥
                binId: null // 将动态创建
            },

            // 免费短信验证API (示例)
            sms: {
                enabled: false, // 可选：集成免费短信API
                provider: 'mock' // 暂时使用模拟验证码
            }
        };

        // 用户认证状态
        let currentUser = null;
        let userDataBinId = null;
        let isAuthenticated = false;

        // 初始化简单存储服务
        console.log('🌐 初始化简单数据存储服务...');
        console.log('📦 使用JSONBin.io作为免费数据存储');
        console.log('✅ 无需Firebase，更简单易用！');



        // 音乐播放器测试函数
        window.testMusicPlayer = function () {
            console.log('🎵 开始测试音乐播放器...');

            // 检查DOM元素
            const miniPlayer = $('#musicPlayerMini');
            const fullPlayer = $('#musicPlayerFull');
            const musicPlayer = $('#musicPlayer');

            console.log('🎵 DOM元素状态:', {
                musicPlayer: !!musicPlayer,
                miniPlayer: !!miniPlayer,
                fullPlayer: !!fullPlayer,
                musicPlayerClasses: musicPlayer ? musicPlayer.className : 'null',
                miniPlayerClasses: miniPlayer ? miniPlayer.className : 'null',
                fullPlayerClasses: fullPlayer ? fullPlayer.className : 'null'
            });

            if (musicPlayer) {
                console.log('🎵 音乐播放器容器位置:', {
                    offsetTop: musicPlayer.offsetTop,
                    offsetLeft: musicPlayer.offsetLeft,
                    offsetWidth: musicPlayer.offsetWidth,
                    offsetHeight: musicPlayer.offsetHeight,
                    display: window.getComputedStyle(musicPlayer).display,
                    visibility: window.getComputedStyle(musicPlayer).visibility
                });
            }

            // 测试显示完整播放器
            console.log('🎵 测试显示完整播放器...');
            showFullPlayer();

            setTimeout(() => {
                console.log('🎵 测试显示小播放器...');
                showMiniPlayer();
            }, 2000);

            return '测试完成，请查看控制台输出';
        };

        // 页面加载完成后的自动检查
        window.addEventListener('load', () => {
            setTimeout(() => {
                console.log('🎵 页面加载完成，进行音乐播放器自动检查...');
                const miniPlayer = $('#musicPlayerMini');
                const fullPlayer = $('#musicPlayerFull');

                if (miniPlayer) {
                    console.log('🎵 小播放器元素找到，尝试触发点击事件...');

                    // 添加一个临时的点击监听器来测试
                    const testClick = () => {
                        console.log('🎵 测试点击事件被触发！');
                        showMusicNotification('🎵 点击测试成功！', 'success');
                    };

                    miniPlayer.addEventListener('click', testClick);

                    // 5秒后移除测试监听器
                    setTimeout(() => {
                        miniPlayer.removeEventListener('click', testClick);
                        console.log('🎵 测试点击监听器已移除');
                    }, 5000);

                } else {
                    console.error('🎵 页面加载完成但小播放器元素仍未找到');
                }
            }, 2000);
        });

        // 📱 简单手机验证码登录系统

        let pendingPhoneNumber = null;

        // 显示登录模态窗口
        function showPhoneLoginModal() {
            const modal = $('#phoneLoginModal');
            if (modal) {
                modal.classList.remove('hidden');
                console.log('📱 打开简单登录窗口');
            }
        }

        // 关闭登录模态窗口
        function closePhoneLoginModal() {
            const modal = $('#phoneLoginModal');
            if (modal) {
                modal.classList.add('hidden');
                resetLoginForm();
            }
        }

        // 重置登录表单
        function resetLoginForm() {
            // 重置到手机号输入步骤
            $('#phoneInputStep').classList.remove('hidden');
            $('#codeInputStep').classList.add('hidden');
            $('#loginLoading').classList.add('hidden');

            // 清空输入
            $('#phoneNumber').value = '';
            $('#verificationCode').value = '';

            // 清空错误信息
            $('#phoneError').classList.add('hidden');
            $('#codeError').classList.add('hidden');

            // 重置按钮状态
            $('#sendCodeBtn').disabled = false;
            $('#verifyCodeBtn').disabled = false;

            pendingPhoneNumber = null;
        }

        // 发送验证码（简化版本）
        async function sendVerificationCode() {
            const phoneNumber = $('#phoneNumber').value.trim();
            const countryCode = $('#countryCode').value;
            const fullPhoneNumber = countryCode + phoneNumber;

            // 验证手机号格式
            if (!validatePhoneNumber(phoneNumber, countryCode)) {
                return;
            }

            try {
                $('#sendCodeBtn').disabled = true;
                $('#sendCodeBtn').textContent = '正在发送...';

                // 模拟发送验证码的过程
                await new Promise(resolve => setTimeout(resolve, 1000));

                // 保存待验证的手机号
                pendingPhoneNumber = fullPhoneNumber;

                console.log('📱 演示验证码已"发送"至:', fullPhoneNumber);
                showMusicNotification('验证码已发送！请输入：123456', 'success');

                // 切换到验证码输入界面
                $('#phoneInputStep').classList.add('hidden');
                $('#codeInputStep').classList.remove('hidden');
                $('#sentPhoneNumber').textContent = fullPhoneNumber;

                // 开始倒计时
                startCountdown();

            } catch (error) {
                console.error('📱 发送验证码失败:', error);
                showMusicNotification('发送验证码失败，请重试', 'error');
                $('#sendCodeBtn').disabled = false;
                $('#sendCodeBtn').textContent = '📤 发送验证码';
            }
        }

        // 验证手机号格式
        function validatePhoneNumber(phoneNumber, countryCode) {
            $('#phoneError').classList.add('hidden');

            if (!phoneNumber) {
                showPhoneError('请输入手机号');
                return false;
            }

            // 基本格式验证
            const phoneRegex = /^[0-9]{7,15}$/;
            if (!phoneRegex.test(phoneNumber)) {
                showPhoneError('手机号格式不正确');
                return false;
            }

            // 针对不同国家的特殊验证
            if (countryCode === '+86') {
                if (!/^1[3-9]\d{9}$/.test(phoneNumber)) {
                    showPhoneError('请输入正确的中国大陆手机号');
                    return false;
                }
            }

            return true;
        }

        // 显示手机号错误
        function showPhoneError(message) {
            const errorEl = $('#phoneError');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }

        // 开始倒计时
        function startCountdown() {
            let countdown = 60;
            const btn = $('#resendCodeBtn');
            const countdownEl = $('#countdown');

            btn.disabled = true;

            const timer = setInterval(() => {
                countdown--;
                countdownEl.textContent = countdown;

                if (countdown <= 0) {
                    clearInterval(timer);
                    btn.disabled = false;
                    btn.innerHTML = '重新发送';
                }
            }, 1000);
        }

        // 重新发送验证码
        function resendVerificationCode() {
            // 重置reCAPTCHA
            if (appVerifier) {
                appVerifier.clear();
                initRecaptcha();
            }

            // 返回手机号输入界面
            backToPhoneInput();
        }

        // 返回手机号输入
        function backToPhoneInput() {
            $('#codeInputStep').classList.add('hidden');
            $('#phoneInputStep').classList.remove('hidden');
        }

        // 验证登录码（简化版本）
        async function verifyCode() {
            const code = $('#verificationCode').value.trim();

            if (!code) {
                showCodeError('请输入验证码');
                return;
            }

            if (code.length !== 6) {
                showCodeError('验证码应为6位数字');
                return;
            }

            if (!pendingPhoneNumber) {
                showCodeError('验证码已失效，请重新获取');
                return;
            }

            try {
                $('#verifyCodeBtn').disabled = true;
                $('#verifyCodeBtn').textContent = '正在验证...';
                $('#loginLoading').classList.remove('hidden');

                // 模拟验证过程
                await new Promise(resolve => setTimeout(resolve, 1000));

                // 简单的验证码检查（演示用）
                if (code === '123456') {
                    // 创建用户对象
                    currentUser = {
                        phoneNumber: pendingPhoneNumber,
                        uid: 'user_' + Date.now(),
                        loginTime: new Date().toISOString()
                    };

                    isAuthenticated = true;

                    // 保存登录状态
                    localStorage.setItem('labubu_user_auth', JSON.stringify(currentUser));

                    console.log('✅ 登录成功:', currentUser.phoneNumber);
                    showMusicNotification('登录成功！正在同步数据...', 'success');

                    // 更新用户状态显示
                    updateUserStatus(currentUser);

                    // 关闭登录窗口
                    closePhoneLoginModal();

                    // 播放成功音效
                    if (uiSounds) {
                        uiSounds.playSuccess();
                    }

                    // 自动同步数据
                    setTimeout(() => {
                        autoSyncUserData();

                        // 更新留言板登录状态
                        if (typeof updateCommentLoginStatus === 'function') {
                            updateCommentLoginStatus();
                        }
                    }, 1000);

                } else {
                    throw new Error('验证码错误');
                }

            } catch (error) {
                console.error('❌ 验证失败:', error);
                let errorMessage = '验证码错误，请输入：123456';

                showCodeError(errorMessage);
                $('#verifyCodeBtn').disabled = false;
                $('#verifyCodeBtn').textContent = '✅ 验证登录';
                $('#loginLoading').classList.add('hidden');
            }
        }

        // 显示验证码错误
        function showCodeError(message) {
            const errorEl = $('#codeError');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }

        // 更新用户状态显示
        function updateUserStatus(user) {
            const phoneEl = $('#userPhone');
            const statusEl = $('#userStatus');
            const avatarEl = $('#userAvatar');
            const loginBtn = $('#loginBtn');
            const syncBtn = $('#syncBtn');
            const logoutBtn = $('#logoutBtn');

            if (user && user.phoneNumber) {
                // 已登录状态
                const maskedPhone = user.phoneNumber.replace(/(\+\d{1,3})(\d{3})(\d{4})(\d{4})/, '$1 $2****$4');
                phoneEl.textContent = maskedPhone;
                statusEl.textContent = '已登录 · 数据已同步';
                avatarEl.textContent = '✅';
                avatarEl.className = 'w-8 h-8 bg-gradient-to-br from-green-500 to-blue-500 rounded-full flex items-center justify-center text-white text-sm';

                // 切换按钮显示
                loginBtn.classList.add('hidden');
                syncBtn.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
            } else {
                // 未登录状态
                phoneEl.textContent = '未登录';
                statusEl.textContent = '点击登录同步数据';
                avatarEl.textContent = '👤';
                avatarEl.className = 'w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white text-sm';

                // 切换按钮显示
                loginBtn.classList.remove('hidden');
                syncBtn.classList.add('hidden');
                logoutBtn.classList.add('hidden');
            }
        }

        // 切换用户菜单
        function toggleUserMenu() {
            const menu = $('#userMenu');
            if (menu) {
                menu.classList.toggle('hidden');
            }
        }

        // 用户登出
        async function logoutUser() {
            try {
                // 清除登录状态
                currentUser = null;
                isAuthenticated = false;
                userDataBinId = null;

                // 清除本地存储的登录信息
                localStorage.removeItem('labubu_user_auth');
                localStorage.removeItem('labubu_user_bin_id');

                // 更新用户状态显示
                updateUserStatus(null);

                // 更新留言板登录状态
                if (typeof updateCommentLoginStatus === 'function') {
                    updateCommentLoginStatus();
                }

                showMusicNotification('已安全退出登录', 'info');
                console.log('🚪 用户已退出登录');
            } catch (error) {
                console.error('🚪 退出登录失败:', error);
                showMusicNotification('退出登录失败', 'error');
            }
        }

        // 页面加载时检查登录状态
        function checkLoginStatus() {
            try {
                const savedAuth = localStorage.getItem('labubu_user_auth');
                if (savedAuth) {
                    currentUser = JSON.parse(savedAuth);
                    isAuthenticated = true;
                    userDataBinId = localStorage.getItem('labubu_user_bin_id');

                    console.log('📱 发现已保存的登录状态:', currentUser.phoneNumber);
                    updateUserStatus(currentUser);

                    // 更新留言板登录状态
                    if (typeof updateCommentLoginStatus === 'function') {
                        updateCommentLoginStatus();
                    }

                    // 自动同步数据
                    setTimeout(() => {
                        autoSyncUserData();
                    }, 2000);
                }
            } catch (error) {
                console.error('📱 检查登录状态失败:', error);
                // 清除损坏的数据
                localStorage.removeItem('labubu_user_auth');
                localStorage.removeItem('labubu_user_bin_id');
            }
        }

        // ☁️ 统一用户数据同步系统

        // 收集完整用户数据
        function collectAllUserData() {
            return {
                // 用户基本信息
                user: {
                    phoneNumber: currentUser?.phoneNumber || null,
                    uid: currentUser?.uid || null,
                    loginTime: currentUser?.loginTime || null
                },

                // 用户详细数据
                userData: {
                    uid: currentUser?.uid || null,
                    name: '手机用户',
                    avatar: null,
                    bio: '',
                    signature: 'Labubu收集家 🧸',
                    birthday: null,
                    level: calculateUserLevel(),
                    exp: calculateUserExp(),
                    maxExp: calculateMaxExp(),
                    joinDays: calculateJoinDays(),
                    totalDraws: loadUserDrawCount(),
                    totalPrizes: calculateTotalPrizes(),
                    rarityScore: calculateRarityScore(),
                    streakDays: calculateStreakDays(),
                    luckyRate: calculateLuckyRate(),
                    points: getUserPoints(),
                    createdAt: currentUser?.loginTime || new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                },

                // 抽奖相关数据
                lottery: {
                    history: loadHistory(),
                    drawCount: loadUserDrawCount(),
                    drawLimit: parseInt(localStorage.getItem('labubu_draw_limit') || '0'),
                    vipDraws: parseInt(localStorage.getItem('labubu_vip_draws') || '0')
                },

                // 收藏和兑换数据
                collection: {
                    myCollection: JSON.parse(localStorage.getItem('labubu_my_collection') || '{}'),
                    exchanges: JSON.parse(localStorage.getItem('labubu_exchanges') || '[]'),
                    wishlist: JSON.parse(localStorage.getItem('labubu_wishlist') || '[]')
                },

                // 签到数据
                checkin: {
                    history: JSON.parse(localStorage.getItem('checkinHistory') || '{}'),
                    lastCheckin: localStorage.getItem('lastCheckin') || null,
                    streakDays: calculateStreakDays()
                },

                // 成就数据
                achievements: {
                    data: JSON.parse(localStorage.getItem('userData_achievements') || '{}'),
                    unlocked: JSON.parse(localStorage.getItem('labubu_achievements') || '{}'),
                    progress: JSON.parse(localStorage.getItem('labubu_achievement_progress') || '{}')
                },

                // 任务数据
                tasks: {
                    daily: JSON.parse(localStorage.getItem('labubu_daily_tasks') || '{}'),
                    weekly: JSON.parse(localStorage.getItem('labubu_weekly_tasks') || '{}'),
                    special: JSON.parse(localStorage.getItem('labubu_special_tasks') || '{}'),
                    completed: JSON.parse(localStorage.getItem('labubu_completed_tasks') || '[]')
                },

                // 游戏数据
                games: {
                    scores: JSON.parse(localStorage.getItem('labubu_game_scores') || '{}'),
                    stats: JSON.parse(localStorage.getItem('labubu_game_stats') || '{}'),
                    achievements: JSON.parse(localStorage.getItem('labubu_game_achievements') || '{}')
                },

                // 商城数据
                shop: {
                    cart: JSON.parse(localStorage.getItem('labubu_shopping_cart') || '[]'),
                    orders: JSON.parse(localStorage.getItem('labubu_orders') || '[]'),
                    favorites: JSON.parse(localStorage.getItem('labubu_shop_favorites') || '[]')
                },

                // 用户设置
                settings: {
                    soundEnabled: localStorage.getItem('labubu_ui_sound_enabled') !== 'false',
                    musicVolume: localStorage.getItem('labubu_music_volume') || '50',
                    notifications: localStorage.getItem('labubu_notifications') !== 'false',
                    theme: localStorage.getItem('labubu_theme') || 'light',
                    language: localStorage.getItem('labubu_language') || 'zh-CN'
                },

                // 社交数据
                social: {
                    friends: JSON.parse(localStorage.getItem('labubu_friends') || '[]'),
                    messages: JSON.parse(localStorage.getItem('labubu_messages') || '[]'),
                    likes: JSON.parse(localStorage.getItem('labubu_likes') || '{}')
                },

                // 系统数据
                system: {
                    lastSync: new Date().toISOString(),
                    version: '3.0',
                    clientInfo: {
                        userAgent: navigator.userAgent,
                        platform: navigator.platform,
                        language: navigator.language,
                        timestamp: Date.now()
                    }
                }
            };
        }

        // 同步用户数据到云端
        async function syncUserData() {
            if (!currentUser) {
                showMusicNotification('未登录，无法同步数据', 'error');
                return false;
            }

            try {
                showMusicNotification('正在同步数据到云端...', 'info');

                // 收集完整用户数据
                const allUserData = collectAllUserData();

                // 上传到JSONBin.io
                const success = await uploadToJsonBin(allUserData);

                if (success) {
                    console.log('☁️ 完整用户数据已同步到云端');
                    showMusicNotification('数据同步成功！', 'success');

                    // 更新本地同步时间戳
                    localStorage.setItem('labubu_last_sync', new Date().toISOString());

                    // 播放成功音效
                    if (uiSounds) {
                        uiSounds.playSuccess();
                    }
                    return true;
                } else {
                    throw new Error('上传失败');
                }

            } catch (error) {
                console.error('☁️ 数据同步失败:', error);
                showMusicNotification('数据同步失败，但本地数据已保存', 'error');
                return false;
            }
        }

        // 从云端恢复所有用户数据
        async function restoreAllUserData(cloudData) {
            try {
                console.log('📥 开始恢复完整用户数据');

                // 恢复抽奖数据
                if (cloudData.lottery) {
                    if (cloudData.lottery.history) {
                        localStorage.setItem('labubu_lottery_history', JSON.stringify(cloudData.lottery.history));
                    }
                    if (cloudData.lottery.drawCount !== undefined) {
                        localStorage.setItem('labubu_user_draw_count', cloudData.lottery.drawCount.toString());
                    }
                    if (cloudData.lottery.drawLimit !== undefined) {
                        localStorage.setItem('labubu_draw_limit', cloudData.lottery.drawLimit.toString());
                    }
                }

                // 恢复收藏数据
                if (cloudData.collection) {
                    if (cloudData.collection.myCollection) {
                        localStorage.setItem('labubu_my_collection', JSON.stringify(cloudData.collection.myCollection));
                    }
                    if (cloudData.collection.exchanges) {
                        localStorage.setItem('labubu_exchanges', JSON.stringify(cloudData.collection.exchanges));
                    }
                    if (cloudData.collection.wishlist) {
                        localStorage.setItem('labubu_wishlist', JSON.stringify(cloudData.collection.wishlist));
                    }
                }

                // 恢复签到数据
                if (cloudData.checkin) {
                    if (cloudData.checkin.history) {
                        localStorage.setItem('checkinHistory', JSON.stringify(cloudData.checkin.history));
                    }
                    if (cloudData.checkin.lastCheckin) {
                        localStorage.setItem('lastCheckin', cloudData.checkin.lastCheckin);
                    }
                }

                // 恢复成就数据
                if (cloudData.achievements) {
                    if (cloudData.achievements.data) {
                        localStorage.setItem('userData_achievements', JSON.stringify(cloudData.achievements.data));
                    }
                    if (cloudData.achievements.unlocked) {
                        localStorage.setItem('labubu_achievements', JSON.stringify(cloudData.achievements.unlocked));
                    }
                    if (cloudData.achievements.progress) {
                        localStorage.setItem('labubu_achievement_progress', JSON.stringify(cloudData.achievements.progress));
                    }
                }

                // 恢复任务数据
                if (cloudData.tasks) {
                    if (cloudData.tasks.daily) {
                        localStorage.setItem('labubu_daily_tasks', JSON.stringify(cloudData.tasks.daily));
                    }
                    if (cloudData.tasks.weekly) {
                        localStorage.setItem('labubu_weekly_tasks', JSON.stringify(cloudData.tasks.weekly));
                    }
                    if (cloudData.tasks.special) {
                        localStorage.setItem('labubu_special_tasks', JSON.stringify(cloudData.tasks.special));
                    }
                    if (cloudData.tasks.completed) {
                        localStorage.setItem('labubu_completed_tasks', JSON.stringify(cloudData.tasks.completed));
                    }
                }

                // 恢复游戏数据
                if (cloudData.games) {
                    if (cloudData.games.scores) {
                        localStorage.setItem('labubu_game_scores', JSON.stringify(cloudData.games.scores));
                    }
                    if (cloudData.games.stats) {
                        localStorage.setItem('labubu_game_stats', JSON.stringify(cloudData.games.stats));
                    }
                    if (cloudData.games.achievements) {
                        localStorage.setItem('labubu_game_achievements', JSON.stringify(cloudData.games.achievements));
                    }
                }

                // 恢复商城数据
                if (cloudData.shop) {
                    if (cloudData.shop.cart) {
                        localStorage.setItem('labubu_shopping_cart', JSON.stringify(cloudData.shop.cart));
                    }
                    if (cloudData.shop.orders) {
                        localStorage.setItem('labubu_orders', JSON.stringify(cloudData.shop.orders));
                    }
                    if (cloudData.shop.favorites) {
                        localStorage.setItem('labubu_shop_favorites', JSON.stringify(cloudData.shop.favorites));
                    }
                }

                // 恢复用户设置
                if (cloudData.settings) {
                    if (cloudData.settings.soundEnabled !== undefined) {
                        localStorage.setItem('labubu_ui_sound_enabled', cloudData.settings.soundEnabled.toString());
                    }
                    if (cloudData.settings.musicVolume) {
                        localStorage.setItem('labubu_music_volume', cloudData.settings.musicVolume);
                    }
                    if (cloudData.settings.notifications !== undefined) {
                        localStorage.setItem('labubu_notifications', cloudData.settings.notifications.toString());
                    }
                    if (cloudData.settings.theme) {
                        localStorage.setItem('labubu_theme', cloudData.settings.theme);
                    }
                    if (cloudData.settings.language) {
                        localStorage.setItem('labubu_language', cloudData.settings.language);
                    }
                }

                // 恢复社交数据
                if (cloudData.social) {
                    if (cloudData.social.friends) {
                        localStorage.setItem('labubu_friends', JSON.stringify(cloudData.social.friends));
                    }
                    if (cloudData.social.messages) {
                        localStorage.setItem('labubu_messages', JSON.stringify(cloudData.social.messages));
                    }
                    if (cloudData.social.likes) {
                        localStorage.setItem('labubu_likes', JSON.stringify(cloudData.social.likes));
                    }
                }

                // 恢复用户详细数据（包括积分）
                if (cloudData.userData) {
                    localStorage.setItem('userData', JSON.stringify(cloudData.userData));
                    if (cloudData.userData.points !== undefined) {
                        localStorage.setItem('labubu_user_points', cloudData.userData.points.toString());
                    }
                }

                console.log('✅ 完整用户数据恢复成功');
                return true;

            } catch (error) {
                console.error('❌ 用户数据恢复失败:', error);
                return false;
            }
        }

        // 计算用户等级
        function calculateUserLevel() {
            const points = getUserPoints();
            if (points < 100) return 1;
            if (points < 300) return 2;
            if (points < 600) return 3;
            if (points < 1000) return 4;
            if (points < 1500) return 5;
            return Math.floor(points / 300) + 1;
        }

        // 计算用户经验
        function calculateUserExp() {
            const points = getUserPoints();
            const level = calculateUserLevel();
            const levelPoints = [0, 100, 300, 600, 1000, 1500];
            const basePoints = levelPoints[level - 1] || (level - 1) * 300;
            return points - basePoints;
        }

        // 计算最大经验
        function calculateMaxExp() {
            const level = calculateUserLevel();
            if (level <= 5) {
                const maxExpValues = [100, 200, 300, 400, 500];
                return maxExpValues[level - 1] || 500;
            }
            return 300;
        }

        // 计算加入天数
        function calculateJoinDays() {
            try {
                const loginTime = currentUser.loginTime;
                if (loginTime) {
                    const loginDate = new Date(loginTime);
                    const now = new Date();
                    const diffTime = Math.abs(now - loginDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    return Math.max(1, diffDays);
                }
            } catch (error) {
                console.error('计算加入天数失败:', error);
            }
            return 1;
        }

        // 计算总奖品数
        function calculateTotalPrizes() {
            const history = loadHistory();
            return history.filter(h => h.type !== 'empty').length;
        }

        // 计算稀有度分数
        function calculateRarityScore() {
            const history = loadHistory();
            return history.reduce((score, h) => {
                const rarityPoints = {
                    'common': 1,
                    'rare': 5,
                    'epic': 15,
                    'legendary': 50,

                };
                return score + (rarityPoints[h.rarity] || 0);
            }, 0);
        }

        // 计算连续签到天数
        function calculateStreakDays() {
            const checkinHistory = JSON.parse(localStorage.getItem('checkinHistory') || '{}');
            return Object.keys(checkinHistory).length;
        }

        // 计算幸运率
        function calculateLuckyRate() {
            const history = loadHistory();
            if (history.length === 0) return 50;
            const winRate = (history.filter(h => h.type !== 'empty').length / history.length) * 100;
            return Math.round(winRate);
        }

        // 上传数据到JSONBin.io
        async function uploadToJsonBin(data) {
            try {
                const config = DATA_STORAGE_CONFIG.jsonbin;
                let url = `${config.baseUrl}/b`;
                let method = 'POST';

                // 如果已有binId，使用PUT更新
                if (userDataBinId) {
                    url = `${config.baseUrl}/b/${userDataBinId}`;
                    method = 'PUT';
                }

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': config.apiKey,
                        'X-Bin-Name': `labubu_user_${currentUser.uid}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();

                    // 保存binId以便后续更新
                    if (result.metadata && result.metadata.id) {
                        userDataBinId = result.metadata.id;
                        localStorage.setItem('labubu_user_bin_id', userDataBinId);
                    }

                    console.log('📤 数据已上传到JSONBin:', result);
                    return true;
                } else {
                    console.error('📤 上传失败:', response.status, response.statusText);
                    return false;
                }

            } catch (error) {
                console.error('📤 上传过程出错:', error);
                return false;
            }
        }

        // 从云端下载用户数据
        async function downloadUserData() {
            if (!currentUser) {
                console.log('☁️ 未登录，跳过数据下载');
                return;
            }

            try {
                showMusicNotification('正在从云端下载数据...', 'info');

                // 从JSONBin.io获取数据
                const cloudData = await downloadFromJsonBin();

                if (cloudData) {
                    console.log('☁️ 从云端获取到完整用户数据');

                    // 恢复所有用户数据
                    const restored = await restoreAllUserData(cloudData);

                    if (restored) {
                        showMusicNotification('云端数据下载完成！', 'success');

                        // 更新页面显示（如果相关函数存在）
                        if (typeof updateUserPointsDisplay === 'function') {
                            updateUserPointsDisplay();
                        }
                        if (typeof renderHistory === 'function') {
                            renderHistory();
                        }
                        if (typeof initializeUserPoints === 'function') {
                            initializeUserPoints();
                        }
                    } else {
                        throw new Error('数据恢复失败');
                    }
                } else {
                    console.log('☁️ 云端暂无用户数据，使用本地数据');
                    showMusicNotification('首次登录，正在创建云端数据...', 'info');

                    // 首次登录，上传本地数据到云端
                    setTimeout(() => {
                        syncUserData();
                    }, 1000);
                }

            } catch (error) {
                console.error('☁️ 数据下载失败:', error);
                showMusicNotification('数据下载失败，将使用本地数据', 'error');
            }
        }

        // 从JSONBin.io下载数据
        async function downloadFromJsonBin() {
            try {
                if (!userDataBinId) {
                    console.log('📥 没有保存的数据ID，可能是首次登录');
                    return null;
                }

                const config = DATA_STORAGE_CONFIG.jsonbin;
                const url = `${config.baseUrl}/b/${userDataBinId}/latest`;

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': config.apiKey
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('📥 数据已从JSONBin下载:', result);
                    return result.record || result; // JSONBin.io的响应格式
                } else if (response.status === 404) {
                    console.log('📥 云端数据不存在');
                    return null;
                } else {
                    console.error('📥 下载失败:', response.status, response.statusText);
                    return null;
                }

            } catch (error) {
                console.error('📥 下载过程出错:', error);
                return null;
            }
        }

        // 合并云端数据到本地
        async function mergeCloudDataToLocal(cloudData) {
            try {
                // 比较时间戳，选择更新的数据
                const localLastModified = parseInt(localStorage.getItem('labubu_last_modified') || '0');
                const cloudLastModified = cloudData.lastUpdated ? new Date(cloudData.lastUpdated).getTime() : 0;

                console.log('📊 数据时间戳比较:', {
                    local: new Date(localLastModified).toLocaleString(),
                    cloud: new Date(cloudLastModified).toLocaleString()
                });

                // 合并抽奖历史（去重）
                if (cloudData.history && Array.isArray(cloudData.history)) {
                    const localHistory = loadHistory();
                    const mergedHistory = mergeArrays(localHistory, cloudData.history, 'id');
                    saveHistory(mergedHistory);
                    console.log('📊 抽奖历史已合并:', mergedHistory.length, '条记录');
                }

                // 更新积分（取较大值）
                if (cloudData.points !== undefined) {
                    const localPoints = getUserPoints();
                    const maxPoints = Math.max(localPoints, cloudData.points);
                    localStorage.setItem('labubu_user_points', maxPoints.toString());
                    console.log('💰 积分已更新:', maxPoints);
                }

                // 更新抽奖次数（取较大值）
                if (cloudData.drawCount !== undefined) {
                    const localDrawCount = loadUserDrawCount();
                    const maxDrawCount = Math.max(localDrawCount, cloudData.drawCount);
                    saveUserDrawCount(maxDrawCount);
                    console.log('🎯 抽奖次数已更新:', maxDrawCount);
                }

                // 合并收藏数据
                if (cloudData.collection) {
                    const localCollection = JSON.parse(localStorage.getItem('labubu_my_collection') || '{}');
                    const mergedCollection = mergeObjects(localCollection, cloudData.collection);
                    localStorage.setItem('labubu_my_collection', JSON.stringify(mergedCollection));
                    console.log('🎁 收藏数据已合并');
                }

                // 合并兑换记录
                if (cloudData.exchanges && Array.isArray(cloudData.exchanges)) {
                    const localExchanges = JSON.parse(localStorage.getItem('labubu_exchanges') || '[]');
                    const mergedExchanges = mergeArrays(localExchanges, cloudData.exchanges, 'id');
                    localStorage.setItem('labubu_exchanges', JSON.stringify(mergedExchanges));
                    console.log('🛒 兑换记录已合并:', mergedExchanges.length, '条记录');
                }

                // 更新用户设置
                if (cloudData.settings) {
                    if (cloudData.settings.soundEnabled !== undefined) {
                        localStorage.setItem('labubu_ui_sound_enabled', cloudData.settings.soundEnabled.toString());
                    }
                    if (cloudData.settings.musicVolume !== undefined) {
                        localStorage.setItem('labubu_music_volume', cloudData.settings.musicVolume);
                    }
                    console.log('⚙️ 用户设置已更新');
                }

                // 更新时间戳
                localStorage.setItem('labubu_last_modified', Date.now().toString());

                // 刷新页面显示
                refreshPageData();

                console.log('✅ 云端数据合并完成');

            } catch (error) {
                console.error('❌ 数据合并失败:', error);
                throw error;
            }
        }

        // 合并数组（去重）
        function mergeArrays(localArray, cloudArray, keyField = 'id') {
            const merged = [...localArray];
            const existingKeys = new Set(localArray.map(item => item[keyField] || item.time || JSON.stringify(item)));

            cloudArray.forEach(cloudItem => {
                const key = cloudItem[keyField] || cloudItem.time || JSON.stringify(cloudItem);
                if (!existingKeys.has(key)) {
                    merged.push(cloudItem);
                    existingKeys.add(key);
                }
            });

            // 按时间排序
            return merged.sort((a, b) => {
                const timeA = new Date(a.time || a.timestamp || 0).getTime();
                const timeB = new Date(b.time || b.timestamp || 0).getTime();
                return timeB - timeA; // 新的在前
            });
        }

        // 合并对象（相加数值）
        function mergeObjects(localObj, cloudObj) {
            const merged = { ...localObj };

            Object.keys(cloudObj).forEach(key => {
                if (merged[key] !== undefined) {
                    // 如果本地也有这个键，取较大值或相加
                    merged[key] = Math.max(merged[key], cloudObj[key]);
                } else {
                    // 如果本地没有，直接使用云端值
                    merged[key] = cloudObj[key];
                }
            });

            return merged;
        }

        // 刷新页面数据显示
        function refreshPageData() {
            try {
                // 刷新历史记录
                if (typeof renderHistory === 'function') {
                    renderHistory();
                }

                // 刷新我的收藏
                if (typeof renderMyCollection === 'function') {
                    renderMyCollection();
                }

                // 刷新积分显示
                if (typeof initializeUserPoints === 'function') {
                    initializeUserPoints();
                }

                // 刷新抽奖限制显示
                if (typeof updateDrawLimitDisplay === 'function') {
                    updateDrawLimitDisplay();
                }

                // 刷新兑换商品显示
                if (typeof renderExchangeItems === 'function') {
                    renderExchangeItems();
                }

                console.log('🔄 页面数据显示已刷新');

            } catch (error) {
                console.error('🔄 刷新页面数据失败:', error);
            }
        }



        // 简化的自动同步函数
        async function autoSyncUserData() {
            if (!currentUser) return;

            try {
                console.log('🔄 开始自动数据同步...');

                // 先下载云端数据
                await downloadUserData();

                // 等待1秒后上传最新数据
                setTimeout(async () => {
                    await syncUserData();
                }, 2000);

            } catch (error) {
                console.error('☁️ 自动同步失败:', error);
            }
        }

        function createCursorTrail(x, y) {
            const trail = document.createElement('div');
            trail.className = 'cursor-trail';
            trail.style.left = (x - 4) + 'px';
            trail.style.top = (y - 4) + 'px';
            document.body.appendChild(trail);

            setTimeout(() => {
                if (document.body.contains(trail)) {
                    document.body.removeChild(trail);
                }
            }, 500);
        }

        function createSideParticle(side, y) {
            if (Math.random() > 0.95) { // 5% 概率触发
                const particle = document.createElement('div');
                particle.className = 'side-particle';
                particle.textContent = ['🧸', '✨', '🎀', '💫', '🌟', '🎁'][Math.floor(Math.random() * 6)];
                particle.style.top = (y - 50 + Math.random() * 100) + 'px';

                if (side === 'left') {
                    particle.style.left = '20px';
                    $('.side-interactive.left').appendChild(particle);
                } else {
                    particle.style.right = '20px';
                    $('.side-interactive.right').appendChild(particle);
                }

                setTimeout(() => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                }, 3000);
            }
        }

        function createMagicParticles(x, y) {
            for (let i = 0; i < 8; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'magic-particle';
                    particle.style.left = (x + Math.random() * 40 - 20) + 'px';
                    particle.style.top = (y + Math.random() * 40 - 20) + 'px';
                    document.body.appendChild(particle);

                    setTimeout(() => {
                        if (document.body.contains(particle)) {
                            document.body.removeChild(particle);
                        }
                    }, 2000);
                }, i * 50);
            }
        }

        // —— 按钮波纹效果 ——
        function initButtonEffects() {
            document.querySelectorAll('.enhanced-btn').forEach(button => {
                button.addEventListener('click', createRipple);
            });
        }

        function createRipple(event) {
            const button = event.currentTarget;
            const rect = button.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = event.clientX - rect.left - size / 2;
            const y = event.clientY - rect.top - size / 2;

            const ripple = document.createElement('div');
            ripple.className = 'btn-ripple';
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = x + 'px';
            ripple.style.top = y + 'px';

            button.appendChild(ripple);

            setTimeout(() => {
                if (button.contains(ripple)) {
                    button.removeChild(ripple);
                }
            }, 600);
        }

        // —— 滚动角色动画 ——
        function initScrollCharacters() {
            let lastScrollY = window.scrollY;
            let scrollDirection = 'down';

            window.addEventListener('scroll', () => {
                const currentScrollY = window.scrollY;
                scrollDirection = currentScrollY > lastScrollY ? 'down' : 'up';
                lastScrollY = currentScrollY;

                // 随机触发角色动画
                if (Math.random() > 0.98) { // 2% 概率
                    createScrollCharacter(scrollDirection);
                }
            });
        }

        function createScrollCharacter(direction) {
            const characters = ['🐭', '🐰', '🦄', '🐯', '🦁', '🐻', '🐼', '🐨', '🐸', '🐷'];
            const character = document.createElement('div');
            character.className = 'scroll-character';
            character.textContent = characters[Math.floor(Math.random() * characters.length)];

            const startY = Math.random() * (window.innerHeight - 100) + 50;
            character.style.top = startY + 'px';

            if (direction === 'down') {
                character.style.left = '-100px';
            } else {
                character.style.right = '-100px';
                character.style.transform = 'scaleX(-1)';
            }

            document.body.appendChild(character);

            setTimeout(() => {
                if (document.body.contains(character)) {
                    document.body.removeChild(character);
                }
            }, 4000);
        }

        // —— 页面加载动画优化 ——
        function initPageAnimations() {
            // 为所有section添加进入动画
            const sections = document.querySelectorAll('section, main');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.animation = 'slideIn 0.6s ease-out forwards';
                    }
                });
            }, {
                threshold: 0.1,
                rootMargin: '50px'
            });

            sections.forEach(section => {
                observer.observe(section);
            });
        }

        // —— 音乐播放器位置优化 ——
        function optimizeMusicPlayer() {
            const player = $('#musicPlayer');
            if (player) {
                // 检测屏幕尺寸，移动端时调整位置
                if (window.innerWidth < 768) {
                    player.style.width = '280px';
                    player.style.bottom = '20px';
                    player.style.right = '20px';
                }
            }
        }

        // 安全初始化函数 (防篡改)
        const _0x9f2e = function () {
            // 用户权限验证 - 只在首次访问时验证
            if (!window.checkVIPAccess || !window.checkVIPAccess()) {
                return false;
            }

            // 显示用户标识（只显示一次）
            if (window.showVIPBadge) {
                window.showVIPBadge();
            }

            // 域名验证
            if (!window._secureConfig.validate()) {
                console.log('🎵 欢迎访问Labubu主题娱乐平台');
                return false;
            }

            return true;
        };

        function init() {
            // 安全检查
            if (!_0x9f2e()) return;

            $('#year').textContent = new Date().getFullYear();
            renderHistory();
            updateDrawLimitDisplay();
            setupDataSync();

            // 初始化交互效果
            setTimeout(() => {
                initCustomCursor();
                initButtonEffects();
                initScrollCharacters();
                initPageAnimations();
                optimizeMusicPlayer();
            }, 100);
        }

        // —— 积分兑换系统 ——
        const EXCHANGE_ITEMS = [
            {
                id: 1,
                name: "限定Labubu万圣节挂件",
                emoji: "🎃",
                image: "images/prizes/labubu/halloween-special.jpg",
                description: "超稀有万圣节限定挂件",
                cost: 6000,
                rarity: 'legendary',
                available: 1,
                requirements: "需要3个史诗级角色 + 1000积分"
            },
            {
                id: 2,
                name: "限定Cookie Ann圣诞挂件",
                emoji: "🎄",
                image: "images/prizes/cookie-ann/christmas-special.jpg",
                description: "迪士尼圣诞限定挂件",
                cost: 6000,
                rarity: 'legendary',
                available: 1,
                requirements: "需要3个史诗级角色 + 1000积分"
            },
            {
                id: 3,
                name: "限定Molly夏日海洋挂件",
                emoji: "🌊",
                image: "images/prizes/popmart/molly-ocean-special.jpg",
                description: "2025夏日海洋限定挂件",
                cost: 8000,
                rarity: 'legendary',
                available: 1,
                requirements: "需要4个史诗级角色 + 2000积分"
            },
            {
                id: 4,
                name: "白金Labubu至尊版",
                emoji: "💎",
                image: "images/prizes/labubu/platinum.jpg",
                description: "终极收藏版Labubu",
                cost: 4000,
                rarity: 'legendary',
                available: 3,
                requirements: "需要4个史诗级角色"
            },
            {
                id: 5,
                name: "Cookie Ann公主礼盒",
                emoji: "👸",
                image: "images/prizes/cookie-ann/royal-set.jpg",
                description: "迪士尼公主主题限定套装",
                cost: 3500,
                rarity: 'legendary',
                available: 2,
                requirements: "需要3个史诗级角色"
            },
            {
                id: 6,
                name: "Pop Mart联名礼包",
                emoji: "🎁",
                description: "包含Molly+Dimoo限定周边",
                cost: 2000,
                rarity: 'epic',
                available: 5,
                requirements: "需要3个稀有级角色"
            }
        ];

        let userInventory = JSON.parse(localStorage.getItem('labubu_inventory') || '[]');
        let userPoints = 0;

        // 计算用户积分
        function calculateUserPoints() {
            const history = loadHistory();
            userPoints = 0;

            history.forEach(record => {
                const pool = loadPool();
                const prize = pool.find(p => p.name === record.prize);
                if (prize && prize.points) {
                    userPoints += prize.points;
                }
            });

            // 更新显示
            $('#userPoints').textContent = userPoints;
            updateExchangeableItems();
            return userPoints;
        }

        // 更新可兑换物品数量
        function updateExchangeableItems() {
            const canExchange = EXCHANGE_ITEMS.filter(item => userPoints >= item.cost).length;
            $('#exchangeableItems').textContent = canExchange;
        }

        // 渲染兑换商品
        function renderExchangeItems() {
            const container = $('#exchangeItems');

            container.innerHTML = EXCHANGE_ITEMS.map(item => {
                const canAfford = userPoints >= item.cost;
                const rarityConfig = getRarityConfig(item.rarity);

                return `
                    <div class="border border-slate-200 rounded-2xl p-4 ${canAfford ? 'bg-white' : 'bg-gray-50 opacity-60'}">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="text-3xl">${item.emoji}</div>
                            <div class="flex-1">
                                <h4 class="font-medium text-sm">${item.name}</h4>
                                <div class="text-xs" style="color: ${rarityConfig.color}">
                                    ${rarityConfig.emoji} ${rarityConfig.name}级
                                </div>
                            </div>
                        </div>
                        
                        <p class="text-xs text-slate-600 mb-3">${item.description}</p>
                        
                        <div class="text-xs text-slate-500 mb-3">
                            ${item.requirements}
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div class="text-sm">
                                <span class="font-bold text-[var(--labu)]">${item.cost}</span> 积分
                            </div>
                            <button onclick="exchangeItem(${item.id})" 
                                    class="enhanced-btn px-3 py-1 text-xs rounded-lg ${canAfford ? 'bg-[var(--labu)] text-white' : 'bg-gray-200 text-gray-500'}"
                                    ${!canAfford ? 'disabled' : ''}>
                                ${canAfford ? '🔄 兑换' : '❌ 积分不足'}
                            </button>
                        </div>
                        
                        <div class="text-xs text-slate-400 mt-2">
                            剩余: ${item.available} 件
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 渲染我的收藏
        function renderMyCollection() {
            const container = $('#myCollection');
            const history = loadHistory();
            const pool = loadPool();

            // 统计收藏
            const collection = {};
            history.forEach(record => {
                const prize = pool.find(p => p.name === record.prize);
                if (prize && prize.rarity && prize.rarity !== 'common') {
                    collection[record.prize] = (collection[record.prize] || 0) + 1;
                }
            });

            if (Object.keys(collection).length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-8 text-slate-400">
                        <div class="text-3xl mb-2">🧸</div>
                        <div class="text-sm">暂无收藏，快去抽奖获得Labubu吧！</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = Object.entries(collection).map(([name, count]) => {
                const prize = pool.find(p => p.name === name);
                const rarityConfig = getRarityConfig(prize.rarity);

                return `
                    <div class="bg-white border border-slate-200 rounded-xl p-3 text-center">
                        <div class="text-2xl mb-1">${getLabubuEmoji(name)}</div>
                        <div class="text-xs font-medium mb-1">${name}</div>
                        <div class="text-xs mb-2" style="color: ${rarityConfig.color}">
                            ${rarityConfig.emoji} ${rarityConfig.name}
                        </div>
                        <div class="text-xs font-bold">数量: ${count}</div>
                        <div class="text-xs text-slate-500">价值: ${(prize.points || 0) * count}分</div>
                    </div>
                `;
            }).join('');
        }

        // 获取Labubu表情
        function getLabubuEmoji(name) {
            const emojiMap = {
                '经典Labubu公仔': '🧸',
                '彩虹Labubu限定': '🌈',
                '圣诞Labubu特别版': '🎄',
                '黄金Labubu收藏版': '👑',
                '24上迪万圣节饼饼挂件': '🎃',
                '24上迪万圣节露露挂件': '👻',
                '25上迪夏日海洋饼饼挂件': '🌊'
            };
            return emojiMap[name] || '🧸';
        }

        // 🏆 积分管理系统
        function getUserPoints() {
            return parseInt(localStorage.getItem('labubu_user_points') || '100');
        }

        function updateUserPoints(change) {
            const currentPoints = getUserPoints();
            const newPoints = Math.max(0, currentPoints + change);
            localStorage.setItem('labubu_user_points', newPoints.toString());

            // 更新所有积分显示元素
            const pointsElements = document.querySelectorAll('.user-points, #userPoints');
            pointsElements.forEach(el => {
                if (el) el.textContent = newPoints;
            });

            console.log(`🏆 积分${change >= 0 ? '增加' : '减少'}：${Math.abs(change)}，当前积分：${newPoints}`);
            return newPoints;
        }

        function initializeUserPoints() {
            const currentPoints = getUserPoints();
            const pointsElements = document.querySelectorAll('.user-points, #userPoints');
            pointsElements.forEach(el => {
                if (el) el.textContent = currentPoints;
            });
            console.log(`🏆 积分系统初始化，当前积分：${currentPoints}`);
        }

        // 🎯 成就检查系统（简化版本）
        function checkAchievements(record, picked, rarity) {
            console.log('🎯 检查成就触发...', {
                prize: record.prize,
                type: record.type,
                rarity: rarity
            });

            // 获取用户统计数据
            const history = loadHistory();
            const totalDraws = history.filter(r => r.type !== '试抽').length;
            const legendaryCount = history.filter(r =>
                (r.prize && r.prize.includes('限定')) ||
                (picked && picked.rarity === 'legendary')
            ).length;

            // 检查各种成就
            const achievements = [];

            // 抽奖次数成就
            if (totalDraws === 1) {
                achievements.push('🎉 新手幸运儿 - 完成第一次抽奖！');
            } else if (totalDraws === 10) {
                achievements.push('🎯 抽奖达人 - 完成10次抽奖！');
            } else if (totalDraws === 50) {
                achievements.push('🏆 抽奖大师 - 完成50次抽奖！');
            }

            // 稀有度成就
            if (rarity === 'legendary') {
                achievements.push('⭐ 史诗收集者 - 获得史诗级奖品！');


            }

            // 特殊奖品成就
            if (record.prize && record.prize.includes('限定')) {
                achievements.push('💎 限定收藏家 - 获得限定版奖品！');
            }

            // 显示成就通知
            achievements.forEach((achievement, index) => {
                setTimeout(() => {
                    showMusicNotification(achievement, 'success');
                    if (uiSounds) uiSounds.playSuccess();

                    // 给予成就积分奖励
                    updateUserPoints(50);
                    setTimeout(() => {
                        showMusicNotification('🎁 成就奖励：+50 积分！', 'info');
                    }, 1000);
                }, index * 2000);
            });

            return achievements.length > 0;
        }

        // 兑换物品
        function exchangeItem(itemId) {
            const item = EXCHANGE_ITEMS.find(i => i.id === itemId);
            const currentPoints = getUserPoints();

            if (!item) {
                showMusicNotification('商品不存在', 'error');
                return;
            }

            if (currentPoints < item.cost) {
                showMusicNotification(`积分不足！需要 ${item.cost} 积分，当前只有 ${currentPoints} 积分`, 'error');
                return;
            }

            if (item.available <= 0) {
                showMusicNotification('商品库存不足', 'error');
                return;
            }

            if (confirm(`确认兑换 ${item.name}？\n消耗 ${item.cost} 积分`)) {
                // 扣除积分
                updateUserPoints(-item.cost);
                item.available--;

                // 添加到历史记录
                const history = loadHistory();
                const exchangeRecord = {
                    id: Date.now(),
                    prize: item.name,
                    code: generateCode(),
                    time: new Date().toLocaleString(),
                    type: 'exchange'
                };
                history.unshift(exchangeRecord);
                saveHistory(history);

                // 更新显示
                renderExchangeItems();
                renderMyCollection();
                renderHistory();

                // 显示兑换成功
                showExchangeSuccess(item.name, exchangeRecord.code);
                showMusicNotification(`🎉 成功兑换 ${item.name}！`, 'success');

                // 创建庆祝效果
                createCelebrationEffect();

                // 播放成功音效
                if (uiSounds) {
                    uiSounds.playSuccess();
                }
            }
        }

        // 显示兑换成功
        function showExchangeSuccess(itemName, code) {
            const popup = document.createElement('div');
            popup.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center';
            popup.innerHTML = `
                <div class="bg-white rounded-3xl p-8 mx-4 max-w-md w-full text-center">
                    <div class="text-6xl mb-4">🎉</div>
                    <h3 class="text-xl font-bold mb-2">兑换成功！</h3>
                    <p class="text-slate-600 mb-4">恭喜获得：${itemName}</p>
                    <div class="bg-gray-100 rounded-lg p-3 mb-4">
                        <div class="text-xs text-slate-500 mb-1">兑换码</div>
                        <div class="font-mono text-lg font-bold">${code}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            class="enhanced-btn px-6 py-2 bg-[var(--labu)] text-white rounded-xl font-medium">
                        确定
                    </button>
                </div>
            `;
            document.body.appendChild(popup);
        }

        // 初始化积分兑换系统
        function initExchangeSystem() {
            calculateUserPoints();
            renderExchangeItems();
            renderMyCollection();

            // 绑定事件
            $('#calculatePointsBtn').addEventListener('click', () => {
                calculateUserPoints();
                showNotification('✅ 积分已重新计算');
            });
        }

        // 显示通知
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg z-50';
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 3000);
        }

        // 创建庆祝效果
        function createCelebrationEffect() {
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'magic-particle';
                    particle.style.left = (window.innerWidth / 2 + Math.random() * 200 - 100) + 'px';
                    particle.style.top = (window.innerHeight / 2 + Math.random() * 200 - 100) + 'px';
                    document.body.appendChild(particle);

                    setTimeout(() => {
                        if (document.body.contains(particle)) {
                            document.body.removeChild(particle);
                        }
                    }, 2000);
                }, i * 100);
            }
        }

        // 检查条款同意状态
        function checkTermsAgreement() {
            const agreed = localStorage.getItem('terms_agreed');
            if (!agreed) {
                window.location.href = 'welcome.html';
                return false;
            }

            const agreeTime = parseInt(agreed);
            const now = Date.now();
            const dayInMs = 24 * 60 * 60 * 1000;

            // 条款同意有效期7天
            if (now - agreeTime > 7 * dayInMs) {
                localStorage.removeItem('terms_agreed');
                window.location.href = 'welcome.html';
                return false;
            }

            return true;
        }

        // 更新主要的init函数 
        function init() {
            if (!_0x9f2e()) return;
            if (!checkTermsAgreement()) return;

            loadData();
            renderHistory();
            updateDrawLimitDisplay();
            setupDataSync();
            initExchangeSystem(); // 初始化兑换系统

            // 初始化音乐播放器
            initMusicPlayer();
            initCommentSystem();
            updateNavigation();

            // 初始化图片画廊
            setTimeout(() => {
                initImageGallery();
            }, 100);

            // 初始化积分系统
            initializeUserPoints();

            // 检查用户登录状态
            checkLoginStatus();

            setTimeout(() => {
                // initCustomCursor(); // 已在bind()函数中初始化，避免重复
                initButtonEffects();
                initScrollCharacters();
                initPageAnimations();
                initPageTransitions(); // 初始化页面过渡
                optimizeMusicPlayer();
            }, 100);
        }

        // 九宫格图片点击交互
        function initImageGallery() {
            const galleryItems = document.querySelectorAll('.gallery-item');
            galleryItems.forEach(item => {
                item.addEventListener('click', function () {
                    const title = this.getAttribute('data-title');
                    showImageModal(title, this);
                });
            });
        }

        function showImageModal(title, element) {
            // 创建模态框
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl max-w-md w-full p-6 text-center">
                    <div class="text-6xl mb-4">${element.querySelector('div').textContent}</div>
                    <h3 class="text-xl font-bold mb-2">${title}</h3>
                    <p class="text-slate-600 text-sm mb-4">迪士尼饼饼 × Labubu 联名系列</p>
                    <div class="text-xs text-slate-500 mb-6">
                        这是${title}的精美设计，融合了迪士尼的经典元素和Labubu的可爱风格，每一个细节都充满了童趣和创意。
                    </div>
                    <button onclick="this.closest('.fixed').remove()" 
                            class="px-6 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors">
                        关闭
                    </button>
                </div>
            `;

            document.body.appendChild(modal);

            // 点击外部关闭
            modal.addEventListener('click', function (e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // 绑定新功能
        window.replyToComment = replyToComment;
        window.deleteComment = deleteComment;
        window.exchangeItem = exchangeItem;

        bind();
        init();
    </script>
</body>

</html>