<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Labubu å¹¸è¿æŠ½å¥–</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --labu: #6b5b95;
            --labu2: #ffcc00;
        }

        body {
            font-family: 'Zen Maru Gothic', system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans SC', 'PingFang SC', 'Microsoft Yahei', sans-serif;
        }

        .labu-gradient {
            background-image: linear-gradient(135deg, rgba(107, 91, 149, .12), rgba(255, 204, 0, .12));
        }

        .spin {
            animation: spin 1.2s cubic-bezier(.2, .7, .2, 1) 1;
        }

        @keyframes spin {
            from {
                transform: rotate(-6deg) scale(.98);
            }

            50% {
                transform: rotate(6deg) scale(1.02);
            }

            to {
                transform: rotate(0) scale(1);
            }
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900">
    <!-- é¡¶éƒ¨æ  -->
    <header class="sticky top-0 z-10 backdrop-blur bg-white/60 border-b border-slate-200">
        <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-xl bg-[var(--labu)] grid place-content-center text-white text-xl">ğŸ¦Š</div>
                <h1 class="font-bold text-lg">Labubu å¹¸è¿æŠ½å¥–</h1>
            </div>
            <nav class="text-sm flex items-center gap-3">
                <a href="#draw" class="hover:underline">æŠ½å¥–</a>
                <a href="#history" class="hover:underline">è®°å½•</a>
                <a href="#settings" class="hover:underline">è®¾ç½®</a>
            </nav>
        </div>
    </header>

    <!-- Hero -->
    <section class="labu-gradient">
        <div class="max-w-5xl mx-auto px-4 py-10 md:py-16 grid md:grid-cols-2 gap-8 items-center">
            <div>
                <h2 class="text-3xl md:text-4xl font-extrabold leading-tight">æŠ½ä¸€æŠ½ï¼ŒLabubu é™ªä½ æ¬§ï¼</h2>
                <p class="mt-3 text-slate-700">å†…ç½®æŠµæ‰£åˆ¸ã€å®ä½“ç¤¼å“ã€æŠ˜æ‰£åˆ¸ä¸‰ç±»å¥–é¡¹ã€‚æ”¯æŒåº“å­˜ä¸æƒé‡ï¼Œè‡ªåŠ¨ç”Ÿæˆå…‘æ¢ç ï¼›æ‰€æœ‰ç»“æœå°†ä¿å­˜åœ¨æœ¬åœ°å¹¶æŒ‰æ—¶é—´æ ‡è®°ã€‚</p>
                <div class="mt-5 flex flex-wrap gap-3">
                    <a href="#draw"
                        class="px-4 py-2 rounded-xl bg-[var(--labu)] text-white font-medium shadow hover:opacity-90">å¼€å§‹æŠ½å¥–</a>
                    <button id="exportCsvBtn"
                        class="px-4 py-2 rounded-xl bg-slate-900 text-white font-medium shadow hover:opacity-90">å¯¼å‡ºCSV</button>
                </div>
            </div>
            <div class="relative">
                <div class="aspect-square rounded-3xl bg-white shadow-lg p-6 border border-slate-200">
                    <div class="h-full w-full grid place-content-center">
                        <div class="text-7xl md:text-8xl select-none">ğŸ§¸</div>
                        <div class="text-center mt-4 text-sm text-slate-600">Labubu ä¸»é¢˜ï¼ˆç¤ºæ„ï¼‰</div>
                    </div>
                </div>
                <div class="absolute -z-10 inset-0 blur-3xl opacity-30"
                    style="background: radial-gradient(600px 200px at 20% 30%, var(--labu), transparent), radial-gradient(500px 200px at 80% 70%, var(--labu2), transparent);">
                </div>
            </div>
        </div>
    </section>

    <!-- æŠ½å¥–å¡ç‰‡ -->
    <main id="draw" class="max-w-5xl mx-auto px-4 py-10">
        <div class="grid md:grid-cols-5 gap-6 items-start">
            <section class="md:col-span-3">
                <div class="rounded-3xl bg-white border border-slate-200 shadow">
                    <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                        <h3 class="font-semibold">æŠ½å¥–é¢æ¿</h3>
                        <div class="text-xs text-slate-500">æœ¬åœ°æ—¶é—´ï¼š<span id="now"></span></div>
                    </div>
                    <div class="p-6">
                        <div class="grid gap-4">
                            <div class="rounded-2xl border border-dashed border-slate-300 p-6 text-center">
                                <div class="text-sm text-slate-600">ç‚¹å‡»æŒ‰é’®å¼€å§‹æŠ½å¥–</div>
                                <div id="resultDisplay" class="text-3xl font-extrabold mt-2">â€”</div>
                                <div id="resultMeta" class="text-xs text-slate-500 mt-1">â€”</div>
                            </div>
                            <div class="flex gap-3 flex-wrap">
                                <button id="drawBtn"
                                    class="px-5 py-3 rounded-2xl bg-[var(--labu)] text-white font-semibold shadow active:scale-[.98]">å¼€å§‹æŠ½å¥–</button>
                                <button id="resetBtn"
                                    class="px-5 py-3 rounded-2xl bg-slate-100 text-slate-800 font-medium border border-slate-200">é‡ç½®ï¼ˆæ¸…ç©ºè®°å½•ï¼‰</button>
                            </div>
                            <div class="text-xs text-slate-500">è¯´æ˜ï¼šæŠ½å¥–ä¼šæ ¹æ® <a href="#settings" class="underline">è®¾ç½®</a>
                                çš„å¥–æ± æƒé‡ä¸åº“å­˜è¿›è¡Œã€‚å®ä½“ç¤¼å“ä¼šæ‰£å‡åº“å­˜ï¼›åˆ¸ç ä¼šè‡ªåŠ¨ç”Ÿæˆå¹¶æ˜¾ç¤ºã€‚</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- å¥–æ± æ¦‚è§ˆ -->
            <aside class="md:col-span-2">
                <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
                    <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                        <h3 class="font-semibold">å½“å‰å¥–æ± </h3>
                        <button id="restoreDefaultBtn"
                            class="text-xs px-2 py-1 rounded-lg bg-slate-100 border border-slate-200">æ¢å¤é»˜è®¤</button>
                    </div>
                    <div class="p-5">
                        <ul id="poolList" class="text-sm grid gap-2"></ul>
                    </div>
                </div>
            </aside>
        </div>

        <!-- å†å²è®°å½• -->
        <section id="history" class="mt-10">
            <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
                <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                    <h3 class="font-semibold">æŠ½å¥–ç»“æœï¼ˆè‡ªåŠ¨æ ‡è®°æ—¶é—´ï¼‰</h3>
                    <div class="flex gap-2">
                        <button id="exportJsonBtn"
                            class="text-xs px-2 py-1 rounded-lg bg-slate-100 border border-slate-200">å¯¼å‡º JSON</button>
                        <button id="clearHistoryBtn"
                            class="text-xs px-2 py-1 rounded-lg bg-slate-100 border border-slate-200">ä»…æ¸…ç©ºè®°å½•</button>
                    </div>
                </div>
                <div class="p-5 overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="text-left text-slate-500">
                            <tr>
                                <th class="py-2 pr-4">æ—¶é—´</th>
                                <th class="py-2 pr-4">å¥–å“</th>
                                <th class="py-2 pr-4">ç±»å‹</th>
                                <th class="py-2 pr-4">åˆ¸ç /å¤‡æ³¨</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody" class="align-top"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- è®¾ç½® -->
        <section id="settings" class="mt-10">
            <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
                <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                    <h3 class="font-semibold">å¥–æ± è®¾ç½®</h3>
                    <div class="text-xs text-slate-500">æ”¯æŒç¼–è¾‘å¹¶ä¿å­˜åˆ°æœ¬åœ°æµè§ˆå™¨</div>
                </div>
                <div class="p-5 grid gap-4">
                    <div class="text-sm text-slate-600">æ¯è¡Œä¸€ä¸ªå¥–å“ï¼Œå­—æ®µä½¿ç”¨é€—å·åˆ†éš”ï¼š<code>name,type,weight,quantity</code><br />type
                        ä»…æ”¯æŒï¼š<b>æŠµæ‰£åˆ¸</b>ï½œ<b>å®ä½“</b>ï½œ<b>æŠ˜æ‰£åˆ¸</b>ï¼›quantity ç•™ç©ºæˆ– -1 è¡¨ç¤ºä¸é™é‡ã€‚</div>
                    <textarea id="poolEditor" rows="8"
                        class="w-full rounded-xl border border-slate-300 p-3 font-mono text-xs"></textarea>
                    <div class="flex gap-3">
                        <button id="savePoolBtn"
                            class="px-4 py-2 rounded-xl bg-[var(--labu)] text-white font-medium">ä¿å­˜å¥–æ± </button>
                        <button id="recalcBtn"
                            class="px-4 py-2 rounded-xl bg-slate-100 border border-slate-200">é‡æ–°è½½å…¥</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="max-w-5xl mx-auto px-4 py-10 text-center text-xs text-slate-500">
        <div>Â© <span id="year"></span> Labubu æŠ½å¥–æ¼”ç¤º Â· çº¯å‰ç«¯é™æ€é¡µé¢ï¼ˆé€‚é… GitHub Pagesï¼‰</div>
    </footer>

    <script>
        // â€”â€” æœ¬åœ°å­˜å‚¨é”® â€”â€”
        const LS_KEYS = {
            HISTORY: 'labubu_lottery_history',
            POOL: 'labubu_lottery_pool'
        };

        // â€”â€” é»˜è®¤å¥–æ± ï¼ˆå¯ç¼–è¾‘ï¼‰â€”â€”
        const DEFAULT_POOL = [
            { name: 'Â¥20 æŠµæ‰£åˆ¸', type: 'æŠµæ‰£åˆ¸', weight: 25, quantity: -1 },
            { name: 'Â¥50 æŠµæ‰£åˆ¸', type: 'æŠµæ‰£åˆ¸', weight: 15, quantity: -1 },
            { name: '9æŠ˜ä¼˜æƒ åˆ¸', type: 'æŠ˜æ‰£åˆ¸', weight: 18, quantity: -1 },
            { name: '95æŠ˜ä¼˜æƒ åˆ¸', type: 'æŠ˜æ‰£åˆ¸', weight: 22, quantity: -1 },
            { name: 'Labubu é™é‡æ‰‹åŠï¼ˆå®ä½“ï¼‰', type: 'å®ä½“', weight: 3, quantity: 5 },
            { name: 'Labubu ä¸»é¢˜è´´çº¸åŒ…ï¼ˆå®ä½“ï¼‰', type: 'å®ä½“', weight: 7, quantity: 50 },
            { name: 'å†æ¥å†å‰', type: 'æŠ˜æ‰£åˆ¸', weight: 10, quantity: -1, note: 'æœªä¸­å¥–æç¤ºï¼Œå¯è‡ªå®šä¹‰' }
        ];

        // â€”â€” å·¥å…·å‡½æ•° â€”â€”
        const $ = (sel) => document.querySelector(sel);
        const $$ = (sel) => Array.from(document.querySelectorAll(sel));
        const nowStr = () => new Date().toLocaleString();
        const uid = (n = 8) => Math.random().toString(36).slice(2, 2 + n).toUpperCase();

        function loadHistory() {
            try { return JSON.parse(localStorage.getItem(LS_KEYS.HISTORY)) || []; } catch { return []; }
        }
        function saveHistory(arr) { localStorage.setItem(LS_KEYS.HISTORY, JSON.stringify(arr)); }
        function loadPool() {
            try {
                const raw = localStorage.getItem(LS_KEYS.POOL);
                return raw ? JSON.parse(raw) : structuredClone(DEFAULT_POOL);
            } catch { return structuredClone(DEFAULT_POOL); }
        }
        function savePool(pool) { localStorage.setItem(LS_KEYS.POOL, JSON.stringify(pool)); }

        function poolToText(pool) {
            return pool.map(p => [p.name, p.type, p.weight, (p.quantity ?? -1)].join(',')).join('\n');
        }
        function textToPool(txt) {
            return txt.split(/\n+/).map(l => l.trim()).filter(Boolean).map((line, i) => {
                const [name, type, weightStr, qtyStr] = line.split(',').map(s => s?.trim());
                const weight = Number(weightStr);
                const quantity = (qtyStr === undefined || qtyStr === '') ? -1 : Number(qtyStr);
                if (!name || !['æŠµæ‰£åˆ¸', 'å®ä½“', 'æŠ˜æ‰£åˆ¸'].includes(type) || !Number.isFinite(weight)) {
                    throw new Error(`ç¬¬ ${i + 1} è¡Œæ ¼å¼ä¸æ­£ç¡®`);
                }
                return { name, type, weight, quantity };
            });
        }

        function renderPoolList(pool) {
            const ul = $('#poolList');
            ul.innerHTML = '';
            const totalW = pool.reduce((s, p) => s + Math.max(0, p.weight || 0), 0) || 1;
            pool.forEach(p => {
                const left = p.quantity === -1 ? 'âˆ' : p.quantity;
                const w = p.weight || 0;
                const pct = ((w / totalW) * 100).toFixed(1);
                const color = p.type === 'å®ä½“' ? 'bg-emerald-50 text-emerald-700 border-emerald-200' : (p.type === 'æŠµæ‰£åˆ¸' ? 'bg-indigo-50 text-indigo-700 border-indigo-200' : 'bg-amber-50 text-amber-700 border-amber-200');
                const li = document.createElement('li');
                li.className = `border rounded-xl p-3 flex items-center justify-between ${color}`;
                li.innerHTML = `<div class="font-medium">${p.name} <span class="ml-2 text-xs px-2 py-0.5 rounded-lg bg-white/60 border">${p.type}</span></div>
                        <div class="text-xs">æƒé‡ ${w}ï¼ˆâ‰ˆ${pct}%ï¼‰ Â· å‰©ä½™ <b>${left}</b></div>`;
                ul.appendChild(li);
            });
        }

        function renderHistory() {
            const tb = $('#historyBody');
            tb.innerHTML = '';
            const hist = loadHistory();
            if (hist.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="py-3 text-slate-400" colspan="4">æš‚æ— è®°å½•</td>`;
                tb.appendChild(tr);
                return;
            }
            hist.slice().reverse().forEach(r => {
                const tr = document.createElement('tr');
                tr.className = 'border-t';
                tr.innerHTML = `<td class="py-3 pr-4 whitespace-nowrap">${r.time}</td>
                        <td class="py-3 pr-4">${r.prize}</td>
                        <td class="py-3 pr-4">${r.type}</td>
                        <td class="py-3 pr-4 text-slate-600 break-all">${r.code || r.note || ''}</td>`;
                tb.appendChild(tr);
            });
        }

        function weightedPick(pool) {
            const candidates = pool.filter(p => (p.quantity === -1 || p.quantity > 0) && (p.weight || 0) > 0);
            const sum = candidates.reduce((s, p) => s + p.weight, 0);
            if (sum <= 0 || candidates.length === 0) return null;
            let r = Math.random() * sum;
            for (const item of candidates) {
                if ((r -= item.weight) <= 0) return item;
            }
            return candidates[candidates.length - 1];
        }

        function onDraw() {
            const btn = $('#drawBtn');
            btn.disabled = true; btn.classList.add('opacity-60');
            const pool = loadPool();
            const picked = weightedPick(pool);
            const display = $('#resultDisplay');
            const meta = $('#resultMeta');

            if (!picked) {
                display.textContent = 'å¥–æ± ä¸ºç©ºæˆ–åº“å­˜ä¸è¶³';
                meta.textContent = 'è¯·åœ¨â€œå¥–æ± è®¾ç½®â€ä¸­æ·»åŠ å¥–å“';
                btn.disabled = false; btn.classList.remove('opacity-60');
                return;
            }

            // åŠ¨æ•ˆ
            display.parentElement.classList.add('spin');
            setTimeout(() => display.parentElement.classList.remove('spin'), 900);

            // ç”Ÿæˆåˆ¸ç ï¼ˆä»…åˆ¸ç±»ï¼‰
            let code = '';
            if (picked.type === 'æŠµæ‰£åˆ¸' || picked.type === 'æŠ˜æ‰£åˆ¸') {
                code = `${picked.type === 'æŠµæ‰£åˆ¸' ? 'DK' : 'ZK'}-${uid(4)}-${uid(4)}`;
            }

            // æ‰£å‡åº“å­˜ï¼ˆå®ä½“/æœ‰é™é‡ï¼‰
            if (picked.quantity > 0) { picked.quantity -= 1; savePool(pool); refreshPoolEditor(); renderPoolList(pool); }

            const record = {
                time: nowStr(),
                prize: picked.name,
                type: picked.type,
                code: code || undefined,
                note: picked.note || ''
            };

            const hist = loadHistory();
            hist.push(record); saveHistory(hist);

            display.textContent = picked.name;
            meta.textContent = `${record.type}${record.code ? ' Â· åˆ¸ç ï¼š' + record.code : ''}`;
            renderHistory();
            setTimeout(() => { btn.disabled = false; btn.classList.remove('opacity-60'); }, 400);
        }

        function refreshNow() { $('#now').textContent = nowStr(); }

        function refreshPoolEditor() {
            const pool = loadPool();
            $('#poolEditor').value = poolToText(pool);
        }

        function exportJSON() {
            const data = JSON.stringify(loadHistory(), null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `labubu_lottery_${Date.now()}.json`;
            a.click();
        }

        function exportCSV() {
            const rows = [['time', 'prize', 'type', 'code_or_note']].concat(
                loadHistory().map(r => [r.time, r.prize, r.type, r.code || r.note || ''])
            );
            const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')).join('\n');
            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `labubu_lottery_${Date.now()}.csv`;
            a.click();
        }

        function clearHistory() { saveHistory([]); renderHistory(); }

        function resetAll() {
            if (!confirm('ç¡®è®¤æ¸…ç©ºè®°å½•å¹¶æ¢å¤é»˜è®¤å¥–æ± ï¼Ÿ')) return;
            localStorage.removeItem(LS_KEYS.HISTORY);
            localStorage.removeItem(LS_KEYS.POOL);
            $('#resultDisplay').textContent = 'â€”';
            $('#resultMeta').textContent = 'â€”';
            init();
        }

        // â€”â€” äº‹ä»¶ç»‘å®š â€”â€”
        function bind() {
            $('#drawBtn').addEventListener('click', onDraw);
            $('#resetBtn').addEventListener('click', resetAll);
            $('#clearHistoryBtn').addEventListener('click', clearHistory);
            $('#exportJsonBtn').addEventListener('click', exportJSON);
            $('#exportCsvBtn').addEventListener('click', exportCSV);
            $('#savePoolBtn').addEventListener('click', () => {
                try {
                    const next = textToPool($('#poolEditor').value);
                    savePool(next);
                    renderPoolList(next);
                    alert('å·²ä¿å­˜åˆ°æœ¬åœ°ï¼ˆæµè§ˆå™¨ LocalStorageï¼‰');
                } catch (e) { alert(e.message); }
            });
            $('#recalcBtn').addEventListener('click', refreshPoolEditor);
            $('#restoreDefaultBtn').addEventListener('click', () => {
                if (confirm('æ¢å¤é»˜è®¤å¥–æ± ï¼Ÿå½“å‰è®¾ç½®å°†è¢«è¦†ç›–ã€‚')) {
                    savePool(structuredClone(DEFAULT_POOL));
                    refreshPoolEditor();
                    renderPoolList(loadPool());
                }
            });
        }

        function init() {
            $('#year').textContent = new Date().getFullYear();
            refreshNow(); setInterval(refreshNow, 1000);
            const pool = loadPool();
            renderPoolList(pool);
            renderHistory();
            refreshPoolEditor();
        }

        bind();
        init();
    </script>
</body>

</html>