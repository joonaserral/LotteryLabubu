<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Labubu å¹¸è¿æŠ½å¥– ğŸ§¸</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ§¸</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- ç®€å•æ˜“ç”¨çš„å…è´¹æ•°æ®å­˜å‚¨ - æ— éœ€Firebase -->

    <!-- VIPå®‰å…¨éªŒè¯ -->
    <script src="auth.js"></script>
    <script src="config.enc.js"></script>
    <script src="music/music-config.js"></script>
    <!-- ç§»é™¤Google Fontsä»¥é¿å…å¾®ä¿¡ç¯å¢ƒä¸‹çš„åŠ è½½é—®é¢˜ -->
    <style>
        /* ä½¿ç”¨ç³»ç»Ÿå­—ä½“ä»£æ›¿Google Fontsï¼Œç¡®ä¿å¾®ä¿¡å…¼å®¹æ€§ */
        body,
        html,
        * {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji" !important;
        }
    </style>
    <style>
        :root {
            --labu: #6b5b95;
            --labu2: #ffcc00;
        }

        body {
            font-family: 'Zen Maru Gothic', system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans SC', 'PingFang SC', 'Microsoft Yahei', sans-serif;
        }

        .labu-gradient {
            background-image: linear-gradient(135deg, rgba(107, 91, 149, .12), rgba(255, 204, 0, .12));
            position: relative;
            overflow: hidden;
        }

        .labu-gradient::before {
            content: "ğŸ§¸âœ¨ğŸ€ğŸ’«ğŸŒŸ";
            position: absolute;
            top: 10%;
            left: -100%;
            font-size: 2rem;
            opacity: 0.3;
            animation: float-emojis 20s linear infinite;
        }

        .labu-gradient::after {
            content: "ğŸğŸ­ğŸªğŸ¨ğŸ¯";
            position: absolute;
            bottom: 10%;
            right: -100%;
            font-size: 1.5rem;
            opacity: 0.2;
            animation: float-emojis-reverse 25s linear infinite;
        }

        @keyframes float-emojis {
            from {
                left: -100%;
            }

            to {
                left: 100%;
            }
        }

        @keyframes float-emojis-reverse {
            from {
                right: -100%;
            }

            to {
                right: 100%;
            }
        }

        .spin {
            animation: spin 1.5s cubic-bezier(.2, .7, .2, 1) 1;
        }

        .spin-legendary {
            animation: spin-legendary 2s cubic-bezier(.2, .7, .2, 1) 1;
        }

        .spin-rare {
            animation: spin-rare 1.8s cubic-bezier(.2, .7, .2, 1) 1;
        }

        .spin-common {
            animation: spin-common 1.2s cubic-bezier(.2, .7, .2, 1) 1;
        }

        @keyframes spin {
            0% {
                transform: rotate(-6deg) scale(.98);
            }

            25% {
                transform: rotate(3deg) scale(1.01);
            }

            50% {
                transform: rotate(6deg) scale(1.02);
            }

            75% {
                transform: rotate(-3deg) scale(1.01);
            }

            100% {
                transform: rotate(0) scale(1);
            }
        }

        @keyframes spin-legendary {
            0% {
                transform: rotate(-12deg) scale(.95);
                box-shadow: 0 0 0 rgba(255, 215, 0, 0.5);
            }

            25% {
                transform: rotate(8deg) scale(1.05);
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            }

            50% {
                transform: rotate(12deg) scale(1.08);
                box-shadow: 0 0 30px rgba(255, 215, 0, 1);
            }

            75% {
                transform: rotate(-8deg) scale(1.05);
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            }

            100% {
                transform: rotate(0) scale(1);
                box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
            }
        }

        @keyframes spin-rare {
            0% {
                transform: rotate(-10deg) scale(.96);
                box-shadow: 0 0 0 rgba(138, 43, 226, 0.5);
            }

            25% {
                transform: rotate(6deg) scale(1.03);
                box-shadow: 0 0 15px rgba(138, 43, 226, 0.7);
            }

            50% {
                transform: rotate(10deg) scale(1.06);
                box-shadow: 0 0 25px rgba(138, 43, 226, 0.9);
            }

            75% {
                transform: rotate(-6deg) scale(1.03);
                box-shadow: 0 0 15px rgba(138, 43, 226, 0.7);
            }

            100% {
                transform: rotate(0) scale(1);
                box-shadow: 0 0 8px rgba(138, 43, 226, 0.2);
            }
        }

        @keyframes spin-common {
            0% {
                transform: rotate(-4deg) scale(.98);
            }

            50% {
                transform: rotate(4deg) scale(1.02);
            }

            100% {
                transform: rotate(0) scale(1);
            }
        }

        .sparkle {
            animation: sparkle 1s ease-in-out infinite;
        }

        @keyframes sparkle {

            0%,
            100% {
                opacity: 0.3;
                transform: scale(1);
            }

            50% {
                opacity: 1;
                transform: scale(1.1);
            }
        }

        .bounce-in {
            animation: bounce-in 0.6s ease-out;
        }

        @keyframes bounce-in {
            0% {
                transform: scale(0.3);
                opacity: 0;
            }

            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }

            70% {
                transform: scale(0.9);
                opacity: 0.9;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .floating {
            animation: floating 3s ease-in-out infinite;
        }

        @keyframes floating {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        /* éŸ³ä¹æ’­æ”¾å™¨æ ·å¼ */
        .music-player {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
        }

        .music-player:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-2px);
        }

        .music-progress {
            background: linear-gradient(90deg, var(--labu) 0%, var(--labu2) 100%);
        }

        .volume-slider {
            background: linear-gradient(90deg, #ddd 0%, var(--labu) 100%);
        }

        /* ç•™è¨€ç³»ç»Ÿæ ·å¼ */
        .comment-bubble {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.9));
            backdrop-filter: blur(5px);
            transform: translateY(10px);
            opacity: 0;
            animation: slideIn 0.3s ease-out forwards;
        }

        @keyframes slideIn {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .comment-reply {
            border-left: 3px solid var(--labu);
            background: rgba(107, 91, 149, 0.05);
        }

        /* è‡ªå®šä¹‰é¼ æ ‡æ ·å¼ - å¢åŠ å¤‡ç”¨æ–¹æ¡ˆ */
        body.custom-cursor-enabled * {
            cursor: none !important;
        }

        /* é»˜è®¤ä¿ç•™ç³»ç»Ÿå…‰æ ‡ï¼Œç›´åˆ°è‡ªå®šä¹‰å…‰æ ‡æˆåŠŸåŠ è½½ */
        body:not(.custom-cursor-enabled) * {
            cursor: auto;
        }

        /* æ¢å¤æ–‡æœ¬è¾“å…¥å…ƒç´ çš„å…‰æ ‡ */
        input,
        textarea,
        [contenteditable="true"],
        .text-input {
            cursor: text !important;
        }

        /* æ¢å¤å¯ç‚¹å‡»å…ƒç´ çš„å…‰æ ‡ */
        button,
        a,
        [role="button"],
        .cursor-pointer,
        select {
            cursor: pointer !important;
        }

        /* å…‰æ ‡å›é€€é€‰é¡¹ */
        body.cursor-fallback * {
            cursor: auto !important;
        }

        body.cursor-fallback input,
        body.cursor-fallback textarea,
        body.cursor-fallback [contenteditable="true"] {
            cursor: text !important;
        }

        body.cursor-fallback button,
        body.cursor-fallback a,
        body.cursor-fallback [role="button"],
        body.cursor-fallback select {
            cursor: pointer !important;
        }

        .custom-cursor {
            position: fixed;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #ff69b4 30%, transparent 70%);
            border: 2px solid #ff69b4;
            border-radius: 50%;
            pointer-events: none;
            z-index: 99999 !important;
            transition: transform 0.1s ease;
            transform: translate(-50%, -50%);
            opacity: 1 !important;
            display: block !important;
            visibility: visible !important;
            box-shadow: 0 0 10px rgba(255, 105, 180, 0.5), 0 0 20px rgba(255, 105, 180, 0.3);
        }

        .custom-cursor.clicking {
            transform: translate(-50%, -50%) scale(1.2);
        }

        .cursor-trail {
            position: fixed;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, rgba(255, 105, 180, 0.8) 0%, rgba(255, 105, 180, 0) 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9998;
            animation: cursorTrailFade 0.5s ease-out forwards;
        }

        @keyframes cursorTrailFade {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            100% {
                opacity: 0;
                transform: scale(0.3);
            }
        }

        /* ä¾§è¾¹äº’åŠ¨åŒºåŸŸ */
        .side-interactive {
            position: fixed;
            top: 0;
            width: 100px;
            height: 100vh;
            z-index: 1;
            pointer-events: none;
        }

        .side-interactive.left {
            left: 0;
            background: linear-gradient(90deg, rgba(107, 91, 149, 0.03) 0%, transparent 100%);
        }

        .side-interactive.right {
            right: 0;
            background: linear-gradient(270deg, rgba(255, 204, 0, 0.03) 0%, transparent 100%);
        }

        .side-particle {
            position: absolute;
            width: 20px;
            height: 20px;
            font-size: 16px;
            opacity: 0;
            pointer-events: none;
            animation: sideParticleFloat 3s ease-out forwards;
        }

        @keyframes sideParticleFloat {
            0% {
                opacity: 0;
                transform: translateY(20px) scale(0.5);
            }

            20% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }

            100% {
                opacity: 0;
                transform: translateY(-100px) scale(0.8) rotate(180deg);
            }
        }

        /* æŒ‰é’®å¢å¼ºæ•ˆæœ */
        .enhanced-btn {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .enhanced-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .enhanced-btn:hover::before {
            left: 100%;
        }

        .enhanced-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(107, 91, 149, 0.3);
        }

        .enhanced-btn:active {
            transform: translateY(0);
        }

        .btn-ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            transform: scale(0);
            animation: rippleEffect 0.6s linear;
            pointer-events: none;
        }

        @keyframes rippleEffect {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* æ»šåŠ¨è§’è‰²åŠ¨ç”» */
        .scroll-character {
            position: fixed;
            font-size: 48px;
            z-index: 10;
            pointer-events: none;
            opacity: 0;
            animation: characterFloat 4s ease-out forwards;
        }

        @keyframes characterFloat {
            0% {
                opacity: 0;
                transform: translateX(-100px) rotate(-10deg);
            }

            20% {
                opacity: 1;
                transform: translateX(0) rotate(0deg);
            }

            80% {
                opacity: 1;
                transform: translateX(20px) rotate(5deg);
            }

            100% {
                opacity: 0;
                transform: translateX(100px) rotate(10deg);
            }
        }

        /* é­”æ³•ç²’å­æ•ˆæœ */
        .magic-particle {
            position: fixed;
            width: 4px;
            height: 4px;
            background: radial-gradient(circle, #ffd700 0%, #ff69b4 50%, transparent 100%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9997;
            animation: magicParticle 2s ease-out forwards;
        }

        @keyframes magicParticle {
            0% {
                opacity: 1;
                transform: scale(0) rotate(0deg);
            }

            50% {
                opacity: 1;
                transform: scale(1) rotate(180deg);
            }

            100% {
                opacity: 0;
                transform: scale(0.2) rotate(360deg) translateY(-50px);
            }
        }

        /* é¡µé¢ä¼˜åŒ–æ ·å¼ */
        .content-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .compact-section {
            padding: 60px 0;
        }

        .hero-compact {
            padding: 80px 0;
        }

        /* å“åº”å¼é—´è·ä¼˜åŒ– */
        @media (max-width: 768px) {
            .compact-section {
                padding: 30px 0;
            }

            .hero-compact {
                padding: 40px 0;
            }

            /* ç§»åŠ¨ç«¯å¯¼èˆªä¼˜åŒ– */
            header .max-w-5xl {
                padding: 0 15px;
            }

            header h1 {
                font-size: 16px;
            }

            nav {
                font-size: 12px;
                gap: 8px;
            }

            nav a {
                padding: 8px 4px;
            }

            /* ç§»åŠ¨ç«¯è‹±é›„åŒºä¼˜åŒ– */
            .content-container {
                padding: 0 15px;
            }

            .hero-compact h2 {
                font-size: 24px;
                line-height: 1.3;
            }

            .hero-compact p {
                font-size: 14px;
                line-height: 1.5;
            }

            /* ç§»åŠ¨ç«¯éŸ³ä¹æ’­æ”¾å™¨ä¼˜åŒ– */
            #musicPlayer {
                bottom: 10px;
                right: 10px;
                width: 280px;
                font-size: 14px;
            }

            .music-player {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            }

            /* ç§»åŠ¨ç«¯æŒ‰é’®ä¼˜åŒ– */
            .enhanced-btn {
                min-height: 44px;
                /* iOSæ¨èè§¦æ‘¸ç›®æ ‡å¤§å° */
                font-size: 14px;
            }

            /* ç§»åŠ¨ç«¯è¡¨å•ä¼˜åŒ– */
            input,
            textarea,
            select {
                min-height: 44px;
                font-size: 16px;
                /* é˜²æ­¢iOSç¼©æ”¾ */
            }

            /* ç§»åŠ¨ç«¯å¡ç‰‡ä¼˜åŒ– */
            .rounded-3xl {
                border-radius: 16px;
            }

            /* ç§»åŠ¨ç«¯é—´è·è°ƒæ•´ */
            .gap-8 {
                gap: 20px;
            }

            .gap-6 {
                gap: 15px;
            }

            .gap-4 {
                gap: 10px;
            }

            /* ç§»åŠ¨ç«¯æ–‡å­—å¤§å°è°ƒæ•´ */
            .text-3xl {
                font-size: 20px;
            }

            .text-2xl {
                font-size: 18px;
            }

            .text-xl {
                font-size: 16px;
            }

            /* ç§»åŠ¨ç«¯å›¾æ ‡è°ƒæ•´ */
            .text-7xl {
                font-size: 48px;
            }

            .text-8xl {
                font-size: 56px;
            }
        }

        /* å°å±å¹•è®¾å¤‡ä¼˜åŒ– */
        @media (max-width: 480px) {
            header h1 {
                font-size: 14px;
            }

            nav {
                font-size: 11px;
                gap: 6px;
            }

            .hero-compact h2 {
                font-size: 20px;
            }

            #musicPlayer {
                width: 250px;
                bottom: 5px;
                right: 5px;
            }

            .enhanced-btn {
                font-size: 13px;
                padding: 12px 16px;
            }
        }

        /* é¡µé¢è¿‡æ¸¡åŠ¨ç”» */
        .page-transition-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(107, 91, 149, 0.9), rgba(255, 204, 0, 0.9));
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .page-transition-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .page-transition-content {
            text-align: center;
            color: white;
            transform: translateY(20px);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .page-transition-overlay.active .page-transition-content {
            transform: translateY(0);
        }

        .transition-loader {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .smooth-link {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .smooth-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .smooth-link:hover::before {
            left: 100%;
        }

        .smooth-link:hover {
            transform: translateY(-1px);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900">
    <!-- é¡µé¢è¿‡æ¸¡åŠ¨ç”»è¦†ç›–å±‚ -->
    <div id="pageTransitionOverlay" class="page-transition-overlay">
        <div class="page-transition-content">
            <div class="transition-loader"></div>
            <h3 class="text-2xl font-bold mb-2">ğŸ§¸ æ­£åœ¨è·³è½¬...</h3>
            <p class="text-lg opacity-90">è¯·ç¨å€™ï¼Œå³å°†ä¸ºæ‚¨åŠ è½½ç²¾å½©å†…å®¹</p>
        </div>
    </div>

    <!-- è‡ªå®šä¹‰é¼ æ ‡å…‰æ ‡ -->
    <div class="custom-cursor"></div>

    <!-- å…‰æ ‡åˆ‡æ¢æŒ‰é’® -->
    <button id="cursorToggle"
        class="fixed bottom-4 left-4 z-50 w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full shadow-lg flex items-center justify-center text-white text-lg hover:scale-110 transition-transform duration-200"
        title="åˆ‡æ¢å…‰æ ‡æ¨¡å¼" onclick="toggleCursorMode()">
        ğŸ–±ï¸
    </button>

    <!-- éŸ³ä¹æ’­æ”¾å™¨è°ƒè¯•æŒ‰é’® -->
    <button id="musicDebugBtn"
        class="fixed bottom-20 left-4 z-50 w-12 h-12 bg-gradient-to-br from-green-500 to-blue-500 rounded-full shadow-lg flex items-center justify-center text-white text-lg hover:scale-110 transition-transform duration-200"
        title="éŸ³ä¹æ’­æ”¾å™¨è°ƒè¯•"
        onclick="if(window.testMusicPlayer) window.testMusicPlayer(); if(window.showFullPlayer) window.showFullPlayer(); document.getElementById('emergencyMusicPanel').classList.remove('hidden');">
        ğŸµ
    </button>

    <!-- ç´§æ€¥éŸ³ä¹æ§åˆ¶é¢æ¿ -->
    <div id="emergencyMusicPanel"
        class="fixed top-4 right-4 z-50 bg-white/90 backdrop-blur rounded-lg shadow-lg p-3 hidden">
        <div class="text-sm font-medium mb-2">ğŸµ ç´§æ€¥éŸ³ä¹æ§åˆ¶</div>
        <div class="flex gap-2">
            <button onclick="if(window.showFullPlayer) window.showFullPlayer()"
                class="px-3 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">
                å±•å¼€
            </button>
            <button onclick="if(window.showMiniPlayer) window.showMiniPlayer()"
                class="px-3 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600">
                æ”¶èµ·
            </button>
            <button onclick="if(window.togglePlayPause) window.togglePlayPause()"
                class="px-3 py-1 bg-purple-500 text-white rounded text-xs hover:bg-purple-600">
                æ’­æ”¾
            </button>
            <button onclick="document.getElementById('emergencyMusicPanel').classList.add('hidden')"
                class="px-3 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600">
                å…³é—­
            </button>
        </div>
    </div>

    <!-- æ‰‹æœºéªŒè¯ç ç™»å½•æ¨¡æ€çª—å£ -->
    <div id="phoneLoginModal"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm z-60 flex items-center justify-center hidden">
        <div class="bg-white rounded-3xl p-8 mx-4 max-w-md w-full shadow-2xl">
            <!-- æ ‡é¢˜ -->
            <div class="text-center mb-6">
                <div class="text-4xl mb-2">ğŸ“±</div>
                <h2 class="text-xl font-bold text-slate-800">æ‰‹æœºéªŒè¯ç ç™»å½•</h2>
                <p class="text-sm text-slate-500 mt-2">éªŒè¯èº«ä»½ï¼ŒåŒæ­¥æ‚¨çš„æŠ½å¥–æ•°æ®åˆ°äº‘ç«¯</p>
            </div>

            <!-- æ‰‹æœºå·è¾“å…¥ -->
            <div id="phoneInputStep" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">æ‰‹æœºå·ç </label>
                    <div class="flex">
                        <select id="countryCode"
                            class="px-3 py-2 border border-slate-300 rounded-l-lg text-sm focus:border-[var(--labu)] focus:outline-none">
                            <option value="+86">ğŸ‡¨ğŸ‡³ +86</option>
                            <option value="+1">ğŸ‡ºğŸ‡¸ +1</option>
                            <option value="+44">ğŸ‡¬ğŸ‡§ +44</option>
                            <option value="+81">ğŸ‡¯ğŸ‡µ +81</option>
                            <option value="+82">ğŸ‡°ğŸ‡· +82</option>
                        </select>
                        <input type="tel" id="phoneNumber" placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
                            class="flex-1 px-3 py-2 border border-l-0 border-slate-300 rounded-r-lg text-sm focus:border-[var(--labu)] focus:outline-none">
                    </div>
                    <div id="phoneError" class="text-red-500 text-xs mt-1 hidden"></div>
                </div>

                <!-- ç®€å•éªŒè¯ -->
                <div class="text-xs text-slate-500 bg-blue-50 p-2 rounded">
                    ğŸ’¡ ä¸ºäº†ç®€åŒ–æµç¨‹ï¼Œæˆ‘ä»¬ä½¿ç”¨æ¼”ç¤ºéªŒè¯ç ï¼š<strong>123456</strong>
                </div>

                <button id="sendCodeBtn" onclick="sendVerificationCode()"
                    class="w-full bg-[var(--labu)] text-white py-3 rounded-lg font-medium hover:bg-[var(--labu)]/90 transition-colors">
                    ğŸ“¤ å‘é€éªŒè¯ç 
                </button>
            </div>

            <!-- éªŒè¯ç è¾“å…¥ -->
            <div id="codeInputStep" class="space-y-4 hidden">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">éªŒè¯ç </label>
                    <input type="text" id="verificationCode" placeholder="è¯·è¾“å…¥6ä½éªŒè¯ç " maxlength="6"
                        class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm text-center font-mono text-lg tracking-wider focus:border-[var(--labu)] focus:outline-none">
                    <div id="codeError" class="text-red-500 text-xs mt-1 hidden"></div>
                </div>

                <div class="flex justify-between items-center text-sm">
                    <span class="text-slate-500">éªŒè¯ç å·²å‘é€è‡³ <span id="sentPhoneNumber"></span></span>
                    <button id="resendCodeBtn" onclick="resendVerificationCode()"
                        class="text-[var(--labu)] hover:underline" disabled>
                        é‡æ–°å‘é€ (<span id="countdown">60</span>s)
                    </button>
                </div>

                <button id="verifyCodeBtn" onclick="verifyCode()"
                    class="w-full bg-[var(--labu)] text-white py-3 rounded-lg font-medium hover:bg-[var(--labu)]/90 transition-colors">
                    âœ… éªŒè¯ç™»å½•
                </button>

                <button onclick="backToPhoneInput()"
                    class="w-full bg-slate-200 text-slate-700 py-2 rounded-lg font-medium hover:bg-slate-300 transition-colors">
                    â† è¿”å›ä¿®æ”¹æ‰‹æœºå·
                </button>
            </div>

            <!-- å…³é—­æŒ‰é’® -->
            <button onclick="closePhoneLoginModal()"
                class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center text-slate-400 hover:text-slate-600 text-xl">
                âœ•
            </button>

            <!-- ç™»å½•çŠ¶æ€æŒ‡ç¤º -->
            <div id="loginLoading" class="text-center py-4 hidden">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-[var(--labu)]"></div>
                <p class="mt-2 text-sm text-slate-600">æ­£åœ¨éªŒè¯ä¸­...</p>
            </div>
        </div>
    </div>

    <!-- ç”¨æˆ·çŠ¶æ€é¢æ¿ -->
    <div id="userStatusPanel" class="fixed top-4 left-16 z-50 bg-white/90 backdrop-blur rounded-lg shadow-lg p-3">
        <div class="flex items-center gap-3">
            <div id="userAvatar"
                class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white text-sm">
                ğŸ‘¤
            </div>
            <div>
                <div id="userPhone" class="text-sm font-medium">æœªç™»å½•</div>
                <div id="userStatus" class="text-xs text-slate-500">ç‚¹å‡»ç™»å½•åŒæ­¥æ•°æ®</div>
            </div>
            <button id="userMenuBtn" onclick="toggleUserMenu()" class="text-slate-400 hover:text-slate-600">
                âš™ï¸
            </button>
        </div>

        <!-- ç”¨æˆ·èœå• -->
        <div id="userMenu" class="mt-3 pt-3 border-t border-slate-200 space-y-2 hidden">
            <button onclick="showPhoneLoginModal()" id="loginBtn"
                class="w-full text-left px-2 py-1 text-sm text-[var(--labu)] hover:bg-slate-100 rounded">
                ğŸ“± æ‰‹æœºç™»å½•
            </button>
            <button onclick="syncUserData()" id="syncBtn"
                class="w-full text-left px-2 py-1 text-sm text-green-600 hover:bg-slate-100 rounded hidden">
                â˜ï¸ åŒæ­¥æ•°æ®
            </button>
            <button onclick="logoutUser()" id="logoutBtn"
                class="w-full text-left px-2 py-1 text-sm text-red-600 hover:bg-slate-100 rounded hidden">
                ğŸšª é€€å‡ºç™»å½•
            </button>
        </div>
    </div>

    <!-- ä¾§è¾¹äº’åŠ¨åŒºåŸŸ -->
    <div class="side-interactive left"></div>
    <div class="side-interactive right"></div>

    <!-- é¡¶éƒ¨æ  -->
    <header class="sticky top-0 z-10 backdrop-blur bg-white/60 border-b border-slate-200">
        <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-xl bg-[var(--labu)] grid place-content-center text-white text-xl sparkle">ğŸ§¸
                </div>
                <h1 class="font-bold text-lg">Labubuã®åŸºé‡‘ä¼š~ Â· VIPè‚¡ä¸œä¸“äº«ç¦åˆ©</h1>
                <div class="hidden sm:flex gap-1">
                    <span class="floating">âœ¨</span>
                    <span class="floating" style="animation-delay: 0.2s;">ğŸ€</span>
                    <span class="floating" style="animation-delay: 0.4s;">ğŸ’«</span>
                </div>
            </div>
            <nav class="text-sm flex items-center gap-4">
                <a href="#draw" class="hover:underline flex items-center gap-1 smooth-link">ğŸ¯ å¨±ä¹æŠ½å¥–</a>
                <a href="#history" class="hover:underline flex items-center gap-1 smooth-link">ğŸ“Š ä¸­å¥–è®°å½•</a>
                <a href="#exchange" class="hover:underline flex items-center gap-1 smooth-link">ğŸ”„ ç§¯åˆ†å…‘æ¢</a>
                <a href="games.html" class="hover:underline flex items-center gap-1 smooth-link page-link">ğŸ® æ¸¸æˆä¸­å¿ƒ</a>
                <a href="achievements.html" class="hover:underline flex items-center gap-1 smooth-link page-link">ğŸ†
                    ä¸ªäººæˆå°±</a>
                <a href="user-center.html" class="hover:underline flex items-center gap-1 smooth-link page-link">ğŸ‘¤
                    ç”¨æˆ·ä¸­å¿ƒ</a>
                <a href="#comments" class="hover:underline flex items-center gap-1 smooth-link">ğŸ’¬ ç”¨æˆ·äº¤æµ</a>
            </nav>
        </div>
    </header>

    <!-- Hero -->
    <section class="labu-gradient hero-compact">
        <div class="content-container px-4 grid md:grid-cols-2 gap-8 items-center">
            <div>
                <h2 class="text-3xl md:text-4xl font-extrabold leading-tight">
                    Labubuä¸»é¢˜å¨±ä¹æŠ½å¥–å¹³å°
                    <span class="sparkle">ğŸ’</span>
                </h2>
                <p class="mt-3 text-slate-700">
                    ğŸ¯ <strong>æœ€æ–°ä¸­å¥–åŠ¨æ€</strong>ï¼šæœ¬æœˆå·²æœ‰236ä½ç”¨æˆ·ä¸­å¥–ï¼Œå²è¯—çº§å¥–å“88ä»¶ <br />
                    ğŸ’° <strong>å¥–åŠ±ç±»å‹</strong>ï¼šUå¸è´§å¸ã€é™é‡å…¬ä»”ã€æ¶ˆè´¹åˆ¸ç­‰å¤šæ ·åŒ–å¥–å“ <br />
                    ğŸ <strong>ä¸­å¥–æé†’</strong>ï¼šè¯·ç†æ€§å‚ä¸ï¼Œé€‚åº¦å¨±ä¹ï¼Œåˆ‡å‹¿è¿‡åº¦æŠ•å…¥ <br />
                    âš ï¸ <strong>å®˜æ–¹æé†’</strong>ï¼šæœ¬å¹³å°ä»…ä¾›å¨±ä¹ï¼Œè¯·æœ‰èŠ‚åˆ¶åœ°è¿›è¡ŒæŠ½å¥–æ´»åŠ¨
                </p>
                <div class="mt-5 flex flex-wrap gap-3">
                    <a href="#draw"
                        class="enhanced-btn px-6 py-3 rounded-xl bg-[var(--labu)] text-white font-medium shadow flex items-center gap-2">
                        ğŸ¯ å¼€å§‹æŠ½å¥–
                    </a>
                    <button id="exportCsvBtn"
                        class="enhanced-btn px-6 py-3 rounded-xl bg-gradient-to-r from-yellow-600 to-yellow-500 text-white font-medium shadow flex items-center gap-2">
                        ğŸ“Š å¯¼å‡ºä¸­å¥–è®°å½•
                    </button>
                </div>
                <div class="mt-4 text-sm text-slate-600">
                    <div class="flex flex-wrap gap-3">

                        <span class="flex items-center gap-1 px-3 py-1 bg-purple-100 rounded-full">ğŸŒŸ å²è¯—çº§</span>
                        <span class="flex items-center gap-1 px-3 py-1 bg-blue-100 rounded-full">ğŸ’ ç¨€æœ‰çº§</span>
                        <span class="flex items-center gap-1 px-3 py-1 bg-gray-100 rounded-full">ğŸ€ æ™®é€šçº§</span>
                    </div>
                </div>
            </div>
            <div class="relative">
                <div
                    class="aspect-square rounded-3xl bg-white shadow-lg p-6 border border-slate-200 overflow-hidden relative">
                    <div class="h-full w-full grid place-content-center relative z-10">
                        <div class="text-7xl md:text-8xl select-none bounce-in">ğŸ§¸</div>
                        <div class="text-center mt-4 text-sm text-slate-600 flex items-center justify-center gap-2">
                            <span>Labubu ä¸»é¢˜æŠ½å¥–</span>
                            <span class="sparkle">âœ¨</span>
                        </div>
                    </div>
                    <!-- è£…é¥°å…ƒç´  -->
                    <div class="absolute top-4 left-4 text-2xl opacity-60 floating">ğŸ€</div>
                    <div class="absolute top-4 right-4 text-2xl opacity-60 floating" style="animation-delay: 0.5s;">ğŸ’«
                    </div>
                    <div class="absolute bottom-4 left-4 text-2xl opacity-60 floating" style="animation-delay: 1s;">ğŸŒŸ
                    </div>
                    <div class="absolute bottom-4 right-4 text-2xl opacity-60 floating" style="animation-delay: 1.5s;">
                        ğŸ</div>
                    <div class="absolute top-1/2 left-4 text-xl opacity-40 floating" style="animation-delay: 0.8s;">ğŸ¨
                    </div>
                    <div class="absolute top-1/2 right-4 text-xl opacity-40 floating" style="animation-delay: 1.2s;">ğŸª
                    </div>
                </div>
                <div class="absolute -z-10 inset-0 blur-3xl opacity-30"
                    style="background: radial-gradient(600px 200px at 20% 30%, var(--labu), transparent), radial-gradient(500px 200px at 80% 70%, var(--labu2), transparent);">
                </div>
                <!-- å‘¨å›´è£…é¥° -->
                <div class="absolute -top-8 -left-8 text-4xl opacity-20 floating">ğŸ§¸</div>
                <div class="absolute -top-8 -right-8 text-3xl opacity-25 floating" style="animation-delay: 0.3s;">ğŸˆ
                </div>
                <div class="absolute -bottom-8 -left-8 text-3xl opacity-20 floating" style="animation-delay: 0.7s;">ğŸ­
                </div>
                <div class="absolute -bottom-8 -right-8 text-4xl opacity-25 floating" style="animation-delay: 1.1s;">ğŸ¯
                </div>
            </div>
        </div>
    </section>

    <!-- æŠ½å¥–å¡ç‰‡ -->
    <main id="draw" class="content-container px-4 compact-section">
        <div class="grid md:grid-cols-5 gap-6 items-start">
            <section class="md:col-span-3">
                <div class="rounded-3xl bg-white border border-slate-200 shadow">
                    <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                        <h3 class="font-semibold">æŠ½å¥–é¢æ¿</h3>
                        <div class="text-xs text-slate-500">
                            <div>æœ¬åœ°æ—¶é—´ï¼š<span id="now"></span></div>
                            <div id="drawLimitInfo" class="mt-1">å‰©ä½™æŠ½å¥–æ¬¡æ•°ï¼š<span id="remainingDraws">â€”</span></div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="grid gap-4">
                            <div class="rounded-2xl border border-dashed border-slate-300 p-6 text-center">
                                <div class="text-sm text-slate-600">
                                    <span id="drawModeIndicator">ç‚¹å‡»æŒ‰é’®å¼€å§‹æŠ½å¥–</span>
                                </div>
                                <div id="resultDisplay" class="text-3xl font-extrabold mt-2">â€”</div>
                                <div id="resultMeta" class="text-xs text-slate-500 mt-1">â€”</div>
                                <div id="trialNotice" class="text-xs text-orange-600 mt-2 hidden">
                                    ğŸ¯ è¿™æ˜¯è¯•æŠ½ç»“æœï¼Œä¸ä¼šæ¶ˆè€—åº“å­˜æˆ–è®¡å…¥è®°å½•
                                </div>
                            </div>
                            <div class="flex gap-3 flex-wrap">
                                <button id="drawBtn"
                                    class="enhanced-btn px-5 py-3 rounded-2xl bg-[var(--labu)] text-white font-semibold shadow">æ­£å¼æŠ½å¥–</button>
                                <button id="trialDrawBtn"
                                    class="enhanced-btn px-5 py-3 rounded-2xl bg-slate-100 text-slate-800 font-medium border border-slate-200">è¯•æŠ½ä½“éªŒ</button>
                            </div>
                            <div class="text-xs text-slate-500">
                                <div>è¯´æ˜ï¼šæ­£å¼æŠ½å¥–ä¼šæ ¹æ®å¥–æ± æƒé‡ä¸åº“å­˜è¿›è¡Œï¼Œå®ä½“ç¤¼å“ä¼šæ‰£å‡åº“å­˜ï¼›åˆ¸ç ä¼šè‡ªåŠ¨ç”Ÿæˆå¹¶æ˜¾ç¤ºã€‚</div>
                                <div class="mt-1">è¯•æŠ½ä½“éªŒï¼šä»…ä¾›ä½“éªŒæ¦‚ç‡åˆ†å¸ƒï¼Œä¸æ¶ˆè€—åº“å­˜ã€ä¸è®¡å…¥è®°å½•ã€ä¸å½±å“æŠ½å¥–æ¬¡æ•°ã€‚</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- è¿ªå£«å°¼é¥¼é¥¼ & Labubu å›¾ç‰‡åˆé›† -->
            <aside class="md:col-span-2">
                <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
                    <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                        <h3 class="font-semibold">ğŸ§¸ é¥¼é¥¼ & Labubu åˆé›†</h3>
                        <span class="text-xs text-slate-500">ç²¾é€‰å›¾ç‰‡</span>
                    </div>
                    <div class="p-5">
                        <!-- ä¹å®«æ ¼å›¾ç‰‡å±•ç¤º -->
                        <div class="grid grid-cols-3 gap-3" id="imageGallery">
                            <!-- ç¬¬ä¸€è¡Œï¼šè¿ªå£«å°¼é¥¼é¥¼ç³»åˆ— -->
                            <div class="aspect-square rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow cursor-pointer gallery-item"
                                data-title="ç”œå¿ƒé¥¼é¥¼">
                                <div
                                    class="w-full h-full bg-gradient-to-br from-pink-200 to-pink-300 flex items-center justify-center text-4xl relative overflow-hidden">
                                    ğŸª
                                    <div class="absolute inset-0 bg-gradient-to-br from-white/20 to-transparent"></div>
                                </div>
                            </div>
                            <div class="aspect-square rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow cursor-pointer gallery-item"
                                data-title="ä»™å¥³é¥¼é¥¼">
                                <div
                                    class="w-full h-full bg-gradient-to-br from-blue-200 to-blue-300 flex items-center justify-center text-4xl relative overflow-hidden">
                                    ğŸ§šâ€â™€ï¸
                                    <div class="absolute inset-0 bg-gradient-to-br from-white/20 to-transparent"></div>
                                </div>
                            </div>
                            <div class="aspect-square rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow cursor-pointer gallery-item"
                                data-title="å…¬ä¸»é¥¼é¥¼">
                                <div
                                    class="w-full h-full bg-gradient-to-br from-purple-200 to-purple-300 flex items-center justify-center text-4xl relative overflow-hidden">
                                    ğŸ‘¸
                                    <div class="absolute inset-0 bg-gradient-to-br from-white/20 to-transparent"></div>
                                </div>
                            </div>

                            <!-- ç¬¬äºŒè¡Œï¼šLabubuç³»åˆ— -->
                            <div class="aspect-square rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow cursor-pointer gallery-item"
                                data-title="ç»å…¸Labubu">
                                <div
                                    class="w-full h-full bg-gradient-to-br from-green-200 to-green-300 flex items-center justify-center text-4xl relative overflow-hidden">
                                    ğŸ§¸
                                    <div class="absolute inset-0 bg-gradient-to-br from-white/20 to-transparent"></div>
                                </div>
                            </div>
                            <div class="aspect-square rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow cursor-pointer gallery-item"
                                data-title="é©¬æˆå›¢Labubu">
                                <div
                                    class="w-full h-full bg-gradient-to-br from-yellow-200 to-orange-300 flex items-center justify-center text-4xl relative overflow-hidden">
                                    ğŸª
                                    <div class="absolute inset-0 bg-gradient-to-br from-white/20 to-transparent"></div>
                                </div>
                            </div>
                            <div
                                class="aspect-square rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow cursor-pointer">
                                <div
                                    class="w-full h-full bg-gradient-to-br from-red-200 to-pink-300 flex items-center justify-center text-4xl">
                                    ğŸ­
                                </div>
                            </div>

                            <!-- ç¬¬ä¸‰è¡Œï¼šåˆä½œæ¬¾ -->
                            <div
                                class="aspect-square rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow cursor-pointer">
                                <div
                                    class="w-full h-full bg-gradient-to-br from-indigo-200 to-purple-300 flex items-center justify-center text-4xl">
                                    ğŸŒˆ
                                </div>
                            </div>
                            <div
                                class="aspect-square rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow cursor-pointer">
                                <div
                                    class="w-full h-full bg-gradient-to-br from-teal-200 to-cyan-300 flex items-center justify-center text-4xl">
                                    âœ¨
                                </div>
                            </div>
                            <div
                                class="aspect-square rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow cursor-pointer">
                                <div
                                    class="w-full h-full bg-gradient-to-br from-rose-200 to-pink-300 flex items-center justify-center text-4xl">
                                    ğŸ’–
                                </div>
                            </div>
                        </div>

                        <!-- å›¾ç‰‡è¯´æ˜ -->
                        <div class="mt-6 text-xs text-slate-500 text-center">
                            <p class="font-medium text-slate-600">è¿ªå£«å°¼é¥¼é¥¼ Ã— Labubu è”åç³»åˆ—ç²¾é€‰åˆé›†</p>
                            <p class="mt-2 text-slate-400">ç‚¹å‡»å›¾ç‰‡æŸ¥çœ‹è§’è‰²è¯¦æƒ… âœ¨</p>
                            <div class="mt-3 flex justify-center gap-4 text-[10px]">
                                <span class="flex items-center gap-1">
                                    <div class="w-2 h-2 rounded-full bg-pink-300"></div>
                                    è¿ªå£«å°¼é¥¼é¥¼
                                </span>
                                <span class="flex items-center gap-1">
                                    <div class="w-2 h-2 rounded-full bg-green-300"></div>
                                    ç»å…¸Labubu
                                </span>
                                <span class="flex items-center gap-1">
                                    <div class="w-2 h-2 rounded-full bg-purple-300"></div>
                                    è”åæ¬¾å¼
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
        </div>

        <!-- å†å²è®°å½• -->
        <section id="history" class="mt-10">
            <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
                <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                    <h3 class="font-semibold">æŠ½å¥–ç»“æœï¼ˆè‡ªåŠ¨æ ‡è®°æ—¶é—´ï¼‰</h3>
                    <div class="flex gap-2">
                        <button id="exportJsonBtn"
                            class="text-xs px-2 py-1 rounded-lg bg-slate-100 border border-slate-200">å¯¼å‡º JSON</button>
                    </div>
                </div>
                <div class="p-5 overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="text-left text-slate-500">
                            <tr>
                                <th class="py-2 pr-4">æ—¶é—´</th>
                                <th class="py-2 pr-4">å¥–å“</th>
                                <th class="py-2 pr-4">ç±»å‹</th>
                                <th class="py-2 pr-4">åˆ¸ç /å¤‡æ³¨</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody" class="align-top"></tbody>
                    </table>
                </div>
            </div>
        </section>


    </main>

    <!-- ç§¯åˆ†å…‘æ¢ç³»ç»Ÿ -->
    <section id="exchange" class="content-container px-4 compact-section">
        <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
            <div class="p-5 border-b border-slate-100">
                <h3 class="font-semibold flex items-center gap-2 mb-2">
                    ğŸ”„ ç§¯åˆ†å…‘æ¢ä¸­å¿ƒ
                    <span class="text-xs text-slate-500">ï¼ˆå¤šç§å¥–å“å¯ä¾›å…‘æ¢ï¼‰</span>
                </h3>
                <div class="flex items-center justify-between text-sm">
                    <div class="flex items-center gap-4">
                        <span class="text-slate-600">å½“å‰ç§¯åˆ†: <span id="userPoints"
                                class="font-bold text-[var(--labu)]">0</span></span>
                        <span class="text-slate-600">å¯å…‘æ¢: <span id="exchangeableItems"
                                class="font-bold text-green-600">0</span> ä»¶</span>
                    </div>
                    <button id="calculatePointsBtn"
                        class="enhanced-btn px-4 py-2 bg-[var(--labu)] text-white rounded-lg text-sm">
                        ğŸ“Š è®¡ç®—æŒæœ‰ç§¯åˆ†
                    </button>
                </div>
            </div>

            <div class="p-5">
                <!-- å…‘æ¢å•†å“å±•ç¤º -->
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6" id="exchangeItems">
                    <!-- å…‘æ¢å•†å“å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                </div>

                <!-- æˆ‘çš„æ”¶è— -->
                <div class="border-t pt-5">
                    <h4 class="font-medium mb-3 flex items-center gap-2">
                        ğŸ§¸ æˆ‘çš„Labubuæ”¶è—
                        <span class="text-xs text-slate-500">ï¼ˆå¯ç”¨äºå…‘æ¢ç§¯åˆ†ï¼‰</span>
                    </h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3" id="myCollection">
                        <!-- æ”¶è—å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ç•™è¨€ç³»ç»Ÿ -->
    <section id="comments" class="content-container px-4 compact-section">
        <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
            <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                <h3 class="font-semibold flex items-center gap-2">
                    ğŸ’¬ ç•™è¨€æ¿
                    <span class="text-xs text-slate-500">ï¼ˆå¤šç”¨æˆ·å®æ—¶å…±äº«ï¼‰</span>
                </h3>
                <div class="text-xs text-slate-500">å®æ—¶åŒæ­¥ä¸­ <span class="sparkle">âœ¨</span></div>
            </div>
            <div class="p-5">
                <!-- å‘è¡¨ç•™è¨€ -->
                <div class="mb-6">
                    <!-- ç™»å½•çŠ¶æ€æ˜¾ç¤º -->
                    <div id="commentLoginStatus" class="mb-3 p-3 bg-slate-50 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <div id="commentUserAvatar"
                                    class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white text-sm">
                                    ğŸ‘¤</div>
                                <div>
                                    <div id="commentUserName" class="text-sm font-medium">æœªç™»å½•</div>
                                    <div id="commentUserStatus" class="text-xs text-slate-500">è¯·ç™»å½•åå‘è¡¨ç•™è¨€</div>
                                </div>
                            </div>
                            <button id="commentLoginBtn" onclick="showPhoneLoginModal()"
                                class="px-3 py-1 bg-[var(--labu)] text-white text-xs rounded-lg">
                                ğŸ“± ç™»å½•
                            </button>
                        </div>
                    </div>

                    <textarea id="commentInput" rows="3" placeholder="è¯´ç‚¹ä»€ä¹ˆå§... ğŸ¯"
                        class="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm focus:border-[var(--labu)] focus:outline-none resize-none"
                        disabled></textarea>
                    <div class="flex justify-between items-center mt-3">
                        <div class="text-xs text-slate-500">
                            <span id="commentCount">0</span> æ¡ç•™è¨€
                        </div>
                        <button id="submitComment"
                            class="enhanced-btn px-4 py-2 rounded-lg bg-[var(--labu)] text-white text-sm font-medium"
                            disabled>
                            ğŸ’¬ å‘è¡¨ç•™è¨€
                        </button>
                    </div>
                </div>

                <!-- ç•™è¨€åˆ—è¡¨ -->
                <div id="commentsList" class="space-y-4">
                    <div class="text-center text-slate-400 py-8">
                        <div class="text-4xl mb-2">ğŸ’­</div>
                        <div>æš‚æ— ç•™è¨€ï¼Œå¿«æ¥è¯´ç‚¹ä»€ä¹ˆå§ï¼</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- éŸ³ä¹æ’­æ”¾å™¨ -->
    <div id="musicPlayer" class="fixed bottom-6 right-6 z-40 music-player transition-all duration-300 ease-in-out">
        <!-- å°æŒ‰é’®çŠ¶æ€ï¼ˆé»˜è®¤æ˜¾ç¤ºï¼‰ -->
        <div id="musicPlayerMini"
            class="w-14 h-14 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full shadow-lg cursor-pointer flex items-center justify-center hover:scale-110 transition-transform duration-200">
            <div class="text-white text-xl animate-pulse" id="miniMusicIcon">ğŸµ</div>
        </div>

        <!-- å®Œæ•´æ’­æ”¾å™¨ï¼ˆé»˜è®¤éšè—ï¼‰ -->
        <div id="musicPlayerFull"
            class="hidden w-80 bg-white/95 backdrop-blur-md rounded-2xl shadow-xl border border-white/20 p-4">
            <!-- æ ‡é¢˜æ  -->
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                    <span class="text-lg">ğŸµ</span>
                    <span class="font-medium text-sm">éŸ³ä¹æ’­æ”¾å™¨</span>
                </div>
                <button id="closePlayer" class="text-slate-400 hover:text-slate-600 text-xl">âœ•</button>
            </div>

            <!-- å½“å‰æ’­æ”¾ä¿¡æ¯ -->
            <div class="text-center mb-4">
                <div id="currentSong" class="font-medium text-sm text-slate-800 truncate">å‡†å¤‡æ’­æ”¾éŸ³ä¹</div>
                <div id="currentArtist" class="text-xs text-slate-500 truncate">é€‰æ‹©ä¸€é¦–æ­Œå¼€å§‹æ’­æ”¾</div>
            </div>

            <!-- è¿›åº¦æ¡ -->
            <div class="space-y-2 mb-4">
                <div class="flex justify-between text-xs text-slate-500">
                    <span id="currentTime">0:00</span>
                    <span id="totalTime">0:00</span>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-1.5 cursor-pointer" id="progressContainer">
                    <div id="progressBar" class="music-progress h-1.5 rounded-full w-0 transition-all"></div>
                </div>
            </div>

            <!-- æ§åˆ¶æŒ‰é’® -->
            <div class="flex items-center justify-center gap-6 mb-4">
                <button id="prevBtn" class="text-2xl hover:scale-110 transition-transform duration-200">â®ï¸</button>
                <button id="playPauseBtn"
                    class="text-2xl hover:scale-110 transition-transform duration-200 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg">â–¶ï¸</button>
                <button id="nextBtn" class="text-2xl hover:scale-110 transition-transform duration-200">â­ï¸</button>
            </div>

            <!-- éŸ³é‡æ§åˆ¶ -->
            <div class="flex items-center gap-3 mb-4">
                <span class="text-sm">ğŸ”Š</span>
                <input type="range" id="volumeSlider" min="0" max="100" value="50"
                    class="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
            </div>

            <!-- æ’­æ”¾åˆ—è¡¨ -->
            <div class="max-h-32 overflow-y-auto">
                <div class="text-xs text-slate-500 mb-2 font-medium">æ’­æ”¾åˆ—è¡¨</div>
                <div id="playlist" class="space-y-1"></div>
            </div>
        </div>
    </div>

    <footer class="max-w-5xl mx-auto px-4 py-10 text-center text-xs text-slate-500">
        <div>Â© <span id="year"></span> LabubuåŸºé‡‘ä¼šæŠ½å¥–ï¼ˆæœ€ç»ˆè§£é‡Šæƒå½’æœ¬åŸºé‡‘ä¼šæ‰€æœ‰ï¼‰</div>
        <div class="mt-2">
            <a href="admin.html" class="text-slate-400 hover:text-slate-600 hover:underline transition-colors">ç³»ç»Ÿç®¡ç†</a>
        </div>
    </footer>

    <script>
        // â€”â€” æœ¬åœ°å­˜å‚¨é”® â€”â€”
        const LS_KEYS = {
            HISTORY: 'labubu_lottery_history',
            POOL: 'labubu_lottery_pool',
            DRAW_LIMIT: 'labubu_draw_limit',
            USER_DRAW_COUNT: 'labubu_user_draw_count'
        };

        // â€”â€” æ•°æ®åŒæ­¥é€šé“ â€”â€”
        let dataChannel = null;
        let lastPoolUpdate = Date.now();
        let lastLimitUpdate = Date.now();
        let syncEnabled = false;

        // æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
        if ('BroadcastChannel' in window) {
            try {
                dataChannel = new BroadcastChannel('labubu_data_sync');
                syncEnabled = true;
            } catch (error) {
                console.warn('BroadcastChannelåˆå§‹åŒ–å¤±è´¥:', error);
                syncEnabled = false;
            }
        } else {
            console.warn('æµè§ˆå™¨ä¸æ”¯æŒBroadcastChannelï¼Œå®æ—¶åŒæ­¥åŠŸèƒ½å°†ä¸å¯ç”¨');
            syncEnabled = false;
        }

        // â€”â€” Labubuä¸»é¢˜å¥–å“æ±  â€”â€”
        const DEFAULT_POOL = [
            // æ™®é€šå¥–å“
            { name: "å†æ¥å†å‰", type: 'æŠ˜æ‰£åˆ¸', weight: 85, quantity: 100, rarity: 'common', points: 10, emoji: "ğŸ’ª" },
            { name: "å¥¶èŒ¶ä¸€æ¯", type: 'å®ä½“', weight: 25, quantity: 30, rarity: 'common', points: 20, emoji: "ğŸ§‹" },
            { name: "çƒ¤è‚‰åˆ¸ï¼ˆæ¸…çœŸè®°å½•ï¼‰", type: 'å®ä½“', weight: 20, quantity: 25, rarity: 'common', points: 30, emoji: "ğŸ¥©" },
            { name: "çƒ¤è‚‰åˆ¸", type: 'å®ä½“', weight: 20, quantity: 20, rarity: 'common', points: 30, emoji: "ğŸ–" },
            { name: "ç²¾å“å¥¶èŒ¶åˆ¸", type: 'å®ä½“', weight: 15, quantity: 15, rarity: 'rare', points: 50, emoji: "ğŸ§ƒ" },
            { name: "1Uå¸", type: 'å®ä½“', weight: 25, quantity: 100, rarity: 'common', points: 1, emoji: "ğŸ’°" },
            { name: "3Uå¸", type: 'å®ä½“', weight: 15, quantity: 60, rarity: 'common', points: 3, emoji: "ğŸ’µ" },
            { name: "5Uå¸", type: 'å®ä½“', weight: 10, quantity: 40, rarity: 'rare', points: 5, emoji: "ğŸ’¸" },

            // Labubuç³»åˆ—æ”¶è—
            { name: "ç»å…¸Labubuå…¬ä»”", type: 'å®ä½“', weight: 8, quantity: 10, rarity: 'rare', points: 100, image: "images/prizes/labubu/classic.jpg", emoji: "ğŸ§¸" },
            { name: "å½©è™¹Labubué™å®š", type: 'å®ä½“', weight: 6, quantity: 8, rarity: 'epic', points: 150, image: "images/prizes/labubu/rainbow.jpg", emoji: "ğŸŒˆ" },
            { name: "ä¸‡åœ£èŠ‚Labubuç‰¹åˆ«ç‰ˆ", type: 'å®ä½“', weight: 4, quantity: 5, rarity: 'epic', points: 200, image: "images/prizes/labubu/halloween.jpg", emoji: "ğŸƒ" },
            { name: "é»„é‡‘Labubuæ”¶è—ç‰ˆ", type: 'å®ä½“', weight: 3, quantity: 5, rarity: 'epic', points: 300, image: "images/prizes/labubu/gold.jpg", emoji: "ğŸ‘‘" },

            // Cookie Annè¿ªå£«å°¼ç³»åˆ—
            { name: "ç”œå¿ƒCookie Annå…¬ä»”", type: 'å®ä½“', weight: 7, quantity: 8, rarity: 'rare', points: 120, image: "images/prizes/cookie-ann/sweet.jpg", emoji: "ğŸª" },
            { name: "å…¬ä¸»Cookie Anné™å®š", type: 'å®ä½“', weight: 5, quantity: 6, rarity: 'epic', points: 180, image: "images/prizes/cookie-ann/princess.jpg", emoji: "ğŸ‘¸" },
            { name: "åœ£è¯Cookie Annç‰¹åˆ«ç‰ˆ", type: 'å®ä½“', weight: 3, quantity: 4, rarity: 'epic', points: 220, image: "images/prizes/cookie-ann/christmas.jpg", emoji: "ğŸ„" },
            { name: "çƒ˜ç„™å¤§å¸ˆCookie Ann", type: 'å®ä½“', weight: 2.5, quantity: 4, rarity: 'epic', points: 350, image: "images/prizes/cookie-ann/baker.jpg", emoji: "ğŸ‘©â€ğŸ³" },

            // Pop Martæ½®ç©ç³»åˆ—
            { name: "Mollyç»å…¸æ¬¾", type: 'å®ä½“', weight: 6, quantity: 7, rarity: 'rare', points: 110, image: "images/prizes/popmart/molly-classic.jpg", emoji: "ğŸ‘§" },
            { name: "Dimooäº‘æœµç³»åˆ—", type: 'å®ä½“', weight: 4, quantity: 5, rarity: 'epic', points: 160, image: "images/prizes/popmart/dimoo-cloud.jpg", emoji: "â˜ï¸" },
            { name: "Skullpandaéª·é«…ç†ŠçŒ«", type: 'å®ä½“', weight: 3.5, quantity: 5, rarity: 'epic', points: 280, image: "images/prizes/popmart/skullpanda.jpg", emoji: "ğŸ¼" },

            // æ³¨ï¼šæœ¬å¹³å°ä»…ä¾›å¨±ä¹ï¼Œè¯·ç†æ€§å‚ä¸

        ];

        // â€”â€” å·¥å…·å‡½æ•° â€”â€”
        const $ = (sel) => document.querySelector(sel);
        const $$ = (sel) => Array.from(document.querySelectorAll(sel));
        const nowStr = () => new Date().toLocaleString();
        const uid = (n = 8) => Math.random().toString(36).slice(2, 2 + n).toUpperCase();

        // â€”â€” é¡µé¢è¿‡æ¸¡åŠ¨ç”»åŠŸèƒ½ â€”â€”
        function initPageTransitions() {
            // ä¸ºæ‰€æœ‰é¡µé¢é“¾æ¥æ·»åŠ è¿‡æ¸¡æ•ˆæœ
            $$('.page-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const href = link.getAttribute('href');
                    showPageTransition(() => {
                        window.location.href = href;
                    });
                });
            });

            // ä¸ºå…¶ä»–å¤–éƒ¨é“¾æ¥ä¹Ÿæ·»åŠ è¿‡æ¸¡æ•ˆæœ
            $$('a[href$=".html"]').forEach(link => {
                if (!link.classList.contains('page-link')) {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const href = link.getAttribute('href');
                        showPageTransition(() => {
                            window.location.href = href;
                        });
                    });
                }
            });
        }

        function showPageTransition(callback) {
            const overlay = $('#pageTransitionOverlay');
            overlay.classList.add('active');

            // éšæœºæ˜¾ç¤ºä¸åŒçš„åŠ è½½æ–‡æ¡ˆ
            const loadingTexts = [
                { title: 'ğŸ§¸ æ­£åœ¨è·³è½¬...', subtitle: 'è¯·ç¨å€™ï¼Œå³å°†ä¸ºæ‚¨åŠ è½½ç²¾å½©å†…å®¹' },
                { title: 'âœ¨ åŠ è½½ä¸­...', subtitle: 'æ­£åœ¨ä¸ºç”¨æˆ·å‡†å¤‡ç²¾å½©å†…å®¹' },
                { title: 'ğŸ¯ å³å°†åˆ°è¾¾...', subtitle: 'æ‚¨çš„å¨±ä¹åŠŸèƒ½æ­£åœ¨åŠ è½½' },
                { title: 'ğŸ’ ç¨ç­‰ç‰‡åˆ»...', subtitle: 'æ­£åœ¨å±•å¼€æ‚¨çš„ä¸ªäººæˆå°±æ®¿å ‚' }
            ];

            const randomText = loadingTexts[Math.floor(Math.random() * loadingTexts.length)];
            overlay.querySelector('h3').textContent = randomText.title;
            overlay.querySelector('p').textContent = randomText.subtitle;

            // å»¶è¿Ÿæ‰§è¡Œè·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°è¿‡æ¸¡åŠ¨ç”»
            setTimeout(() => {
                if (callback) callback();
            }, 800);
        }

        function hidePageTransition() {
            const overlay = $('#pageTransitionOverlay');
            overlay.classList.remove('active');
        }

        // é¡µé¢åŠ è½½æ—¶éšè—è¿‡æ¸¡å±‚
        window.addEventListener('load', () => {
            setTimeout(hidePageTransition, 300);
        });

        // â€”â€” ç¨€æœ‰åº¦é…ç½® â€”â€”
        function getPrizeRarity(prizeName, weight) {
            // ä¼ è¯´çº§ï¼ˆæƒé‡ â‰¤ 2ï¼Œæˆ–ç‰¹å®šå¥–å“ï¼‰
            if (weight <= 2 || prizeName.includes('é™é‡') || prizeName.includes('5Uå¸')) {
                return 'legendary';
            }
            // ç¨€æœ‰çº§ï¼ˆæƒé‡ â‰¤ 6ï¼‰
            if (weight <= 6 || prizeName.includes('3Uå¸') || prizeName.includes('ç²¾å“')) {
                return 'rare';
            }
            // æ™®é€šçº§
            return 'common';
        }

        function getRarityConfig(rarity) {
            const configs = {
                legendary: {
                    animation: 'spin-rare',
                    duration: 1800,
                    bgColor: 'from-purple-400 to-indigo-500',
                    textColor: 'text-purple-100',
                    icon: 'ğŸŒŸ',
                    message: 'è·å¾—å²è¯—çº§å¥–å“ï¼',
                    particles: 'ğŸŒŸâœ¨ğŸ’«â­',
                    sound: 'epic'
                },
                epic: {
                    animation: 'spin-rare',
                    duration: 1800,
                    bgColor: 'from-purple-400 to-indigo-500',
                    textColor: 'text-purple-100',
                    icon: 'ğŸŒŸ',
                    message: 'è·å¾—å²è¯—çº§å¥–å“ï¼',
                    particles: 'ğŸŒŸâœ¨ğŸ’«â­',
                    sound: 'epic'
                },
                rare: {
                    animation: 'spin-rare',
                    duration: 1800,
                    bgColor: 'from-purple-400 to-pink-500',
                    textColor: 'text-purple-100',
                    icon: 'ğŸ’',
                    message: 'è·å¾—ç¨€æœ‰å¥–å“ï¼',
                    particles: 'ğŸ’œğŸ’«ğŸ”®âœ¨ğŸ€',
                    sound: 'rare'
                },
                common: {
                    animation: 'spin-common',
                    duration: 1200,
                    bgColor: 'from-blue-400 to-green-500',
                    textColor: 'text-blue-100',
                    icon: 'ğŸ',
                    message: 'è·å¾—å¥–å“ï¼',
                    particles: 'ğŸ€ğŸ’™ğŸ’šâœ¨ğŸ',
                    sound: 'common'
                }
            };
            return configs[rarity] || configs.common;
        }

        function showRarityEffect(rarity, config) {
            // åˆ›å»ºå…¨å±ç¨€æœ‰åº¦æç¤º
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 z-50 flex items-center justify-center pointer-events-none';
            overlay.style.background = `linear-gradient(135deg, rgba(0,0,0,0.4), rgba(0,0,0,0.6))`;

            const effectContainer = document.createElement('div');
            effectContainer.className = `text-center bounce-in`;
            effectContainer.innerHTML = `
                <div class="text-6xl mb-4 sparkle">${config.icon}</div>
                <div class="text-2xl font-bold text-white mb-2">${config.message}</div>
                <div class="text-lg text-gray-200">è·å¾—äº†ç‰¹æ®Šå¥–å“ï¼</div>
            `;

            overlay.appendChild(effectContainer);
            document.body.appendChild(overlay);

            // åˆ›å»ºç²’å­æ•ˆæœ
            createParticleEffect(config.particles);

            // 2ç§’åç§»é™¤æ•ˆæœ
            setTimeout(() => {
                overlay.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(overlay)) {
                        document.body.removeChild(overlay);
                    }
                }, 300);
            }, 2000);
        }

        function createParticleEffect(particles) {
            const particleArray = particles.split('');
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.textContent = particleArray[Math.floor(Math.random() * particleArray.length)];
                    particle.className = 'fixed text-2xl pointer-events-none z-40';
                    particle.style.left = Math.random() * window.innerWidth + 'px';
                    particle.style.top = Math.random() * window.innerHeight + 'px';
                    particle.style.animation = 'sparkle 2s ease-out forwards';

                    document.body.appendChild(particle);

                    setTimeout(() => {
                        if (document.body.contains(particle)) {
                            document.body.removeChild(particle);
                        }
                    }, 2000);
                }, i * 100);
            }
        }

        function loadHistory() {
            try { return JSON.parse(localStorage.getItem(LS_KEYS.HISTORY)) || []; } catch { return []; }
        }
        function saveHistory(arr) { localStorage.setItem(LS_KEYS.HISTORY, JSON.stringify(arr)); }
        function loadPool() {
            try {
                const raw = localStorage.getItem(LS_KEYS.POOL);
                return raw ? JSON.parse(raw) : structuredClone(DEFAULT_POOL);
            } catch { return structuredClone(DEFAULT_POOL); }
        }
        function savePool(pool) { localStorage.setItem(LS_KEYS.POOL, JSON.stringify(pool)); }

        function poolToText(pool) {
            return pool.map(p => [p.name, p.type, p.weight, (p.quantity ?? -1)].join(',')).join('\n');
        }
        function textToPool(txt) {
            const lines = txt.split(/\n+/).map(l => l.trim()).filter(Boolean);

            if (lines.length === 0) {
                throw new Error('å¥–æ± ä¸èƒ½ä¸ºç©º');
            }

            if (lines.length > 100) {
                throw new Error('å¥–æ± é¡¹ç›®ä¸èƒ½è¶…è¿‡100ä¸ª');
            }

            return lines.map((line, i) => {
                const parts = line.split(',').map(s => s?.trim());

                if (parts.length < 3 || parts.length > 4) {
                    throw new Error(`ç¬¬ ${i + 1} è¡Œæ ¼å¼ä¸æ­£ç¡®ï¼šåº”ä¸º name,type,weight[,quantity]`);
                }

                const [name, type, weightStr, qtyStr] = parts;

                // åç§°éªŒè¯
                if (!name || name.length > 50) {
                    throw new Error(`ç¬¬ ${i + 1} è¡Œï¼šå¥–å“åç§°ä¸èƒ½ä¸ºç©ºä¸”ä¸èƒ½è¶…è¿‡50å­—ç¬¦`);
                }

                // ç±»å‹éªŒè¯
                if (!['æŠµæ‰£åˆ¸', 'å®ä½“', 'æŠ˜æ‰£åˆ¸'].includes(type)) {
                    throw new Error(`ç¬¬ ${i + 1} è¡Œï¼šå¥–å“ç±»å‹åªèƒ½æ˜¯ æŠµæ‰£åˆ¸/å®ä½“/æŠ˜æ‰£åˆ¸`);
                }

                // æƒé‡éªŒè¯
                const weight = Number(weightStr);
                if (!Number.isFinite(weight) || weight < 0 || weight > 10000) {
                    throw new Error(`ç¬¬ ${i + 1} è¡Œï¼šæƒé‡å¿…é¡»æ˜¯0-10000ä¹‹é—´çš„æ•°å­—`);
                }

                // æ•°é‡éªŒè¯
                let quantity = -1;
                if (qtyStr !== undefined && qtyStr !== '') {
                    quantity = Number(qtyStr);
                    if (!Number.isInteger(quantity) || quantity < -1 || quantity > 99999) {
                        throw new Error(`ç¬¬ ${i + 1} è¡Œï¼šæ•°é‡å¿…é¡»æ˜¯-1åˆ°99999ä¹‹é—´çš„æ•´æ•°`);
                    }
                }

                return { name, type, weight, quantity };
            });
        }

        function renderPoolList(pool) {
            const ul = $('#poolList');
            ul.innerHTML = '';
            const totalW = pool.reduce((s, p) => s + Math.max(0, p.weight || 0), 0) || 1;
            pool.forEach(p => {
                const left = p.quantity === -1 ? 'âˆ' : p.quantity;
                const w = p.weight || 0;
                const pct = ((w / totalW) * 100).toFixed(1);
                const color = p.type === 'å®ä½“' ? 'bg-emerald-50 text-emerald-700 border-emerald-200' : (p.type === 'æŠµæ‰£åˆ¸' ? 'bg-indigo-50 text-indigo-700 border-indigo-200' : 'bg-amber-50 text-amber-700 border-amber-200');
                const li = document.createElement('li');
                li.className = `border rounded-xl p-3 flex items-center justify-between ${color}`;
                li.innerHTML = `<div class="font-medium">${p.name} <span class="ml-2 text-xs px-2 py-0.5 rounded-lg bg-white/60 border">${p.type}</span></div>
                        <div class="text-xs">æƒé‡ ${w}ï¼ˆâ‰ˆ${pct}%ï¼‰ Â· å‰©ä½™ <b>${left}</b></div>`;
                ul.appendChild(li);
            });
        }

        function renderHistory() {
            const tb = $('#historyBody');
            tb.innerHTML = '';
            const hist = loadHistory();
            if (hist.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="py-3 text-slate-400" colspan="4">æš‚æ— è®°å½•</td>`;
                tb.appendChild(tr);
                return;
            }
            hist.slice().reverse().forEach(r => {
                const tr = document.createElement('tr');
                tr.className = 'border-t';
                tr.innerHTML = `<td class="py-3 pr-4 whitespace-nowrap">${r.time}</td>
                        <td class="py-3 pr-4">${r.prize}</td>
                        <td class="py-3 pr-4">${r.type}</td>
                        <td class="py-3 pr-4 text-slate-600 break-all">${r.code || r.note || ''}</td>`;
                tb.appendChild(tr);
            });
        }

        function weightedPick(pool) {
            const candidates = pool.filter(p => (p.quantity === -1 || p.quantity > 0) && (p.weight || 0) > 0);
            const sum = candidates.reduce((s, p) => s + p.weight, 0);
            if (sum <= 0 || candidates.length === 0) return null;
            let r = Math.random() * sum;
            for (const item of candidates) {
                if ((r -= item.weight) <= 0) return item;
            }
            return candidates[candidates.length - 1];
        }

        function onDraw() {
            uiSounds.playClickSound();
            performDraw(false); // æ­£å¼æŠ½å¥–
        }

        function onTrialDraw() {
            uiSounds.playClickSound();
            performDraw(true); // è¯•æŠ½ä½“éªŒ
        }

        function performDraw(isTrial = false) {
            const btn = isTrial ? $('#trialDrawBtn') : $('#drawBtn');
            const drawModeIndicator = $('#drawModeIndicator');
            const trialNotice = $('#trialNotice');

            // æ’­æ”¾æŠ½å¥–éŸ³æ•ˆ
            uiSounds.playDrawSound();

            btn.disabled = true; btn.classList.add('opacity-60');

            // æ›´æ–°æ¨¡å¼æŒ‡ç¤ºå™¨
            if (isTrial) {
                drawModeIndicator.textContent = 'è¯•æŠ½ä½“éªŒæ¨¡å¼';
                trialNotice.classList.remove('hidden');
            } else {
                drawModeIndicator.textContent = 'æ­£å¼æŠ½å¥–æ¨¡å¼';
                trialNotice.classList.add('hidden');

                // åªæœ‰æ­£å¼æŠ½å¥–æ‰æ£€æŸ¥æ¬¡æ•°é™åˆ¶
                if (!canDraw()) {
                    const display = $('#resultDisplay');
                    const meta = $('#resultMeta');
                    display.textContent = 'æŠ½å¥–æ¬¡æ•°å·²ç”¨å®Œ';
                    meta.textContent = 'ä»Šæ—¥æŠ½å¥–æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼Œè¯·æ˜æ—¥å†æ¥';
                    btn.disabled = false; btn.classList.remove('opacity-60');
                    return;
                }
            }

            const pool = loadPool();
            const picked = weightedPick(pool);
            const display = $('#resultDisplay');
            const meta = $('#resultMeta');

            if (!picked) {
                display.textContent = 'å¥–æ± ä¸ºç©ºæˆ–åº“å­˜ä¸è¶³';
                meta.textContent = isTrial ? 'è¯•æŠ½æ— æ³•è¿›è¡Œï¼Œè¯·è”ç³»ç®¡ç†å‘˜' : 'è¯·è”ç³»ç®¡ç†å‘˜æ£€æŸ¥å¥–æ± è®¾ç½®';
                btn.disabled = false; btn.classList.remove('opacity-60');
                return;
            }

            // è·å–ç¨€æœ‰åº¦å¹¶åº”ç”¨å¯¹åº”åŠ¨æ•ˆ
            const rarity = getPrizeRarity(picked.name, picked.weight);
            const rarityConfig = getRarityConfig(rarity);

            // ç§»é™¤æ‰€æœ‰å¯èƒ½çš„åŠ¨ç”»ç±»
            display.parentElement.classList.remove('spin', 'spin-legendary', 'spin-rare', 'spin-common');

            // åº”ç”¨å¯¹åº”ç¨€æœ‰åº¦çš„åŠ¨ç”»
            display.parentElement.classList.add(rarityConfig.animation);

            // åˆ›å»ºç¨€æœ‰åº¦æç¤ºæ•ˆæœ
            if (!isTrial) {
                showRarityEffect(rarity, rarityConfig);
            }

            setTimeout(() => {
                display.parentElement.classList.remove(rarityConfig.animation);
            }, rarityConfig.duration);

            // ç”Ÿæˆåˆ¸ç ï¼ˆä»…åˆ¸ç±»ï¼Œè¯•æŠ½æ—¶æ˜¾ç¤ºæ¨¡æ‹Ÿåˆ¸ç ï¼‰
            let code = '';
            if (picked.type === 'æŠµæ‰£åˆ¸' || picked.type === 'æŠ˜æ‰£åˆ¸') {
                if (isTrial) {
                    code = `${picked.type === 'æŠµæ‰£åˆ¸' ? 'DK' : 'ZK'}-DEMO-${uid(4)}`; // è¯•æŠ½æ˜¾ç¤ºDEMOåˆ¸ç 
                } else {
                    code = `${picked.type === 'æŠµæ‰£åˆ¸' ? 'DK' : 'ZK'}-${uid(4)}-${uid(4)}`;
                }
            }

            // åªæœ‰æ­£å¼æŠ½å¥–æ‰æ‰£å‡åº“å­˜
            if (!isTrial && picked.quantity > 0) {
                picked.quantity -= 1;
                savePool(pool);
                renderPoolList(pool);
            }

            const record = {
                time: nowStr(),
                prize: picked.name,
                type: picked.type,
                code: code || undefined,
                note: picked.note || ''
            };

            // åªæœ‰æ­£å¼æŠ½å¥–æ‰ä¿å­˜è®°å½•å’Œå¢åŠ è®¡æ•°
            if (!isTrial) {
                const hist = loadHistory();
                hist.push(record);
                saveHistory(hist);

                // å¢åŠ ç”¨æˆ·æŠ½å¥–æ¬¡æ•°è®¡æ•°
                const userCount = loadUserDrawCount();
                saveUserDrawCount(userCount + 1);
                updateDrawLimitDisplay();
                renderHistory();

                // ğŸ¯ è§¦å‘æˆå°±æ£€æŸ¥ç³»ç»Ÿï¼ˆå»¶è¿Ÿæ‰§è¡Œé¿å…é˜»å¡UIï¼‰
                setTimeout(() => {
                    if (typeof checkAchievements === 'function') {
                        checkAchievements(record, picked, rarity);
                    }
                }, 1500);

                // ğŸ† æ ¹æ®ç¨€æœ‰åº¦ç»™äºˆç§¯åˆ†å¥–åŠ±
                const pointsReward = {
                    'common': 10,
                    'rare': 25,
                    'epic': 50,
                    'legendary': 100,

                };

                if (pointsReward[rarity]) {
                    updateUserPoints(pointsReward[rarity]);
                    setTimeout(() => {
                        showMusicNotification(`ğŸ‰ è·å¾— ${pointsReward[rarity]} ç§¯åˆ†å¥–åŠ±ï¼`, 'success');
                    }, 2000);
                }

                // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œè‡ªåŠ¨åŒæ­¥æ•°æ®
                if (isAuthenticated && currentUser) {
                    setTimeout(() => {
                        autoSyncUserData();
                    }, 3000);
                }
            }

            // æ’­æ”¾ä¸­å¥–éŸ³æ•ˆ
            setTimeout(() => {
                uiSounds.playWinSound();
            }, 1000);

            // æ˜¾ç¤ºå¥–å“ - ä¼˜å…ˆæ˜¾ç¤ºå›¾ç‰‡ï¼Œå¦åˆ™æ˜¾ç¤ºemoji
            if (picked.image) {
                display.innerHTML = `<div class="flex flex-col items-center gap-2">
                    <img src="${picked.image}" alt="${picked.name}" class="w-20 h-20 object-cover rounded-lg shadow-md">
                    <span class="text-lg font-bold">${picked.name}</span>
                </div>`;
            } else {
                display.innerHTML = `<div class="flex flex-col items-center gap-2">
                    <span class="text-4xl">${picked.emoji || 'ğŸ§¸'}</span>
                    <span class="text-lg font-bold">${picked.name}</span>
                </div>`;
            }

            let metaText = `${record.type}${record.code ? ' Â· åˆ¸ç ï¼š' + record.code : ''}`;
            if (isTrial && code) {
                metaText += ' (æ¨¡æ‹Ÿåˆ¸ç )';
            }
            meta.textContent = metaText;

            setTimeout(() => {
                btn.disabled = false;
                btn.classList.remove('opacity-60');
                // æ¢å¤é»˜è®¤æ˜¾ç¤º
                drawModeIndicator.textContent = 'ç‚¹å‡»æŒ‰é’®å¼€å§‹æŠ½å¥–';
            }, 400);
        }

        function refreshNow() { $('#now').textContent = nowStr(); }

        // â€”â€” æŠ½å¥–æ¬¡æ•°é™åˆ¶ç›¸å…³ â€”â€”
        function loadDrawLimit() {
            try {
                const limit = localStorage.getItem(LS_KEYS.DRAW_LIMIT);
                return limit ? parseInt(limit) : 0; // 0è¡¨ç¤ºä¸é™åˆ¶
            } catch { return 0; }
        }

        function loadUserDrawCount() {
            try {
                const count = localStorage.getItem(LS_KEYS.USER_DRAW_COUNT);
                return count ? parseInt(count) : 0;
            } catch { return 0; }
        }

        function saveUserDrawCount(count) {
            localStorage.setItem(LS_KEYS.USER_DRAW_COUNT, count.toString());
        }

        function updateDrawLimitDisplay() {
            const limit = loadDrawLimit();
            const userCount = loadUserDrawCount();
            const remainingSpan = $('#remainingDraws');
            const drawLimitInfo = $('#drawLimitInfo');

            if (limit === 0) {
                drawLimitInfo.style.display = 'none'; // ä¸é™åˆ¶æ—¶éšè—
            } else {
                drawLimitInfo.style.display = 'block';
                const remaining = Math.max(0, limit - userCount);
                remainingSpan.textContent = `${remaining}`;

                // æ ¹æ®å‰©ä½™æ¬¡æ•°è®¾ç½®é¢œè‰²
                if (remaining === 0) {
                    remainingSpan.className = 'text-red-600 font-medium';
                } else if (remaining <= 3) {
                    remainingSpan.className = 'text-orange-600 font-medium';
                } else {
                    remainingSpan.className = 'text-green-600 font-medium';
                }
            }
        }

        function canDraw() {
            const limit = loadDrawLimit();
            if (limit === 0) return true; // ä¸é™åˆ¶

            const userCount = loadUserDrawCount();
            return userCount < limit;
        }



        function exportJSON() {
            const data = JSON.stringify(loadHistory(), null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `labubu_lottery_${Date.now()}.json`;
            a.click();
        }

        function exportCSV() {
            const rows = [['time', 'prize', 'type', 'code_or_note']].concat(
                loadHistory().map(r => [r.time, r.prize, r.type, r.code || r.note || ''])
            );
            const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')).join('\n');
            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `labubu_lottery_${Date.now()}.csv`;
            a.click();
        }



        // â€”â€” äº‹ä»¶ç»‘å®š â€”â€”
        function bind() {
            $('#drawBtn').addEventListener('click', onDraw);
            $('#trialDrawBtn').addEventListener('click', onTrialDraw);
            $('#exportJsonBtn').addEventListener('click', exportJSON);
            $('#exportCsvBtn').addEventListener('click', exportCSV);
        }

        // â€”â€” æ•°æ®åŒæ­¥ç›‘å¬ â€”â€”
        function setupDataSync() {
            // ç›‘å¬ç®¡ç†å‘˜çš„æ•°æ®æ›´æ–°å¹¿æ’­
            if (syncEnabled && dataChannel) {
                try {
                    dataChannel.addEventListener('message', (event) => {
                        const { type, data, timestamp } = event.data;

                        switch (type) {
                            case 'POOL_UPDATE':
                                if (timestamp > lastPoolUpdate) {
                                    lastPoolUpdate = timestamp;
                                    renderPoolList(loadPool());
                                    showUpdateNotification('å¥–æ± é…ç½®å·²æ›´æ–°');
                                }
                                break;
                            case 'DRAW_LIMIT_UPDATE':
                                if (timestamp > lastLimitUpdate) {
                                    lastLimitUpdate = timestamp;
                                    updateDrawLimitDisplay();
                                    showUpdateNotification('æŠ½å¥–æ¬¡æ•°é™åˆ¶å·²æ›´æ–°');
                                }
                                break;
                            case 'USER_COUNT_RESET':
                                updateDrawLimitDisplay();
                                showUpdateNotification('æŠ½å¥–æ¬¡æ•°å·²é‡ç½®');
                                break;
                            case 'SYSTEM_RESET':
                                location.reload(); // ç³»ç»Ÿé‡ç½®æ—¶å®Œå…¨åˆ·æ–°é¡µé¢
                                break;
                        }
                    });
                } catch (error) {
                    console.error('è®¾ç½®æ¶ˆæ¯ç›‘å¬å¤±è´¥:', error);
                    syncEnabled = false;
                }
            }

            // ç›‘å¬localStorageå˜åŒ–ï¼ˆè·¨æ ‡ç­¾é¡µåŒæ­¥ï¼‰
            window.addEventListener('storage', (event) => {
                if (event.key === LS_KEYS.POOL) {
                    renderPoolList(loadPool());
                    showUpdateNotification('å¥–æ± é…ç½®å·²åŒæ­¥');
                } else if (event.key === LS_KEYS.DRAW_LIMIT || event.key === LS_KEYS.USER_DRAW_COUNT) {
                    updateDrawLimitDisplay();
                    showUpdateNotification('æŠ½å¥–é™åˆ¶å·²åŒæ­¥');
                }
            });

            // å®šæœŸæ£€æŸ¥æ•°æ®æ›´æ–°ï¼ˆå¤‡ç”¨æœºåˆ¶ï¼‰
            setInterval(() => {
                const pool = loadPool();
                renderPoolList(pool);
                updateDrawLimitDisplay();
            }, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
        }

        function showUpdateNotification(message) {
            // åˆ›å»ºä¸´æ—¶é€šçŸ¥
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 right-4 bg-[var(--labu)] text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm transition-all duration-300';
            notification.textContent = `ğŸ“¡ ${message}`;
            document.body.appendChild(notification);

            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        function init() {
            $('#year').textContent = new Date().getFullYear();
            refreshNow(); setInterval(refreshNow, 1000);
            const pool = loadPool();
            renderPoolList(pool);
            renderHistory();
            updateDrawLimitDisplay();
            setupDataSync(); // å¯åŠ¨æ•°æ®åŒæ­¥
        }

        // â€”â€” éŸ³ä¹æ’­æ”¾å™¨åŠŸèƒ½ â€”â€”
        let musicLibrary = [
            // é»˜è®¤éŸ³ä¹åº“ï¼Œå°†é€šè¿‡APIåŠ¨æ€åŠ è½½
        ];

        // Jamendo APIé…ç½®
        const JAMENDO_CLIENT_ID = '709fa152'; // å®˜æ–¹æµ‹è¯•ID
        const JAMENDO_API_BASE = 'https://api.jamendo.com/v3.0';

        // æ£€æµ‹å¾®ä¿¡ç¯å¢ƒ
        function isWeChatBrowser() {
            return /micromessenger/i.test(navigator.userAgent);
        }

        // è·å–æ¬§ç¾æµè¡ŒéŸ³ä¹ï¼ˆå¢åŠ å¾®ä¿¡å…¼å®¹æ€§ï¼‰
        async function loadMusicFromAPI() {
            // å¾®ä¿¡ç¯å¢ƒç›´æ¥ä½¿ç”¨æœ¬åœ°éŸ³ä¹åº“
            if (isWeChatBrowser()) {
                console.log('ğŸµ æ£€æµ‹åˆ°å¾®ä¿¡ç¯å¢ƒï¼Œä½¿ç”¨æœ¬åœ°éŸ³ä¹åº“');
                musicLibrary = loadLocalMusicConfig();
                return true;
            }

            try {
                // æ·»åŠ è¶…æ—¶æ§åˆ¶
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ç§’è¶…æ—¶

                // è·å–æµè¡ŒéŸ³ä¹å’Œç”µå­éŸ³ä¹
                const [popResponse, electroResponse, rockResponse] = await Promise.all([
                    fetch(`${JAMENDO_API_BASE}/tracks/?client_id=${JAMENDO_CLIENT_ID}&format=json&limit=5&tags=pop&include=musicinfo&audioformat=mp32`, {
                        signal: controller.signal,
                        mode: 'cors'
                    }),
                    fetch(`${JAMENDO_API_BASE}/tracks/?client_id=${JAMENDO_CLIENT_ID}&format=json&limit=3&tags=electronic&include=musicinfo&audioformat=mp32`, {
                        signal: controller.signal,
                        mode: 'cors'
                    }),
                    fetch(`${JAMENDO_API_BASE}/tracks/?client_id=${JAMENDO_CLIENT_ID}&format=json&limit=2&tags=rock&include=musicinfo&audioformat=mp32`, {
                        signal: controller.signal,
                        mode: 'cors'
                    })
                ]);

                clearTimeout(timeoutId);

                if (!popResponse.ok || !electroResponse.ok || !rockResponse.ok) {
                    throw new Error('APIè¯·æ±‚å¤±è´¥');
                }

                const popData = await popResponse.json();
                const electroData = await electroResponse.json();
                const rockData = await rockResponse.json();

                // åˆå¹¶æ‰€æœ‰éŸ³ä¹
                const allTracks = [
                    ...(popData.results || []),
                    ...(electroData.results || []),
                    ...(rockData.results || [])
                ];

                if (allTracks.length === 0) {
                    throw new Error('æœªè·å–åˆ°éŸ³ä¹æ•°æ®');
                }

                // è½¬æ¢ä¸ºæˆ‘ä»¬çš„éŸ³ä¹åº“æ ¼å¼
                musicLibrary = allTracks.map(track => ({
                    id: track.id,
                    title: track.name || 'Unknown Title',
                    artist: track.artist_name || 'Unknown Artist',
                    album: track.album_name || 'Unknown Album',
                    url: track.audio || track.audiodownload,
                    duration: formatDuration(track.duration),
                    image: track.album_image || track.image,
                    jamendoUrl: `https://www.jamendo.com/track/${track.id}`
                }));

                console.log('ğŸµ å·²åŠ è½½', musicLibrary.length, 'é¦–å…è´¹éŸ³ä¹');
                return true;
            } catch (error) {
                console.error('âŒ åŠ è½½éŸ³ä¹å¤±è´¥:', error);
                // ä¼˜å…ˆä½¿ç”¨æœ¬åœ°éŸ³ä¹é…ç½®
                musicLibrary = loadLocalMusicConfig();
                console.log('ğŸµ ä½¿ç”¨æœ¬åœ°éŸ³ä¹åº“:', musicLibrary.length, 'é¦–');
                return false;
            }
        }

        // åŠ è½½æœ¬åœ°éŸ³ä¹é…ç½®
        function loadLocalMusicConfig() {
            if (window.LOCAL_MUSIC_LIBRARY) {
                return window.LOCAL_MUSIC_LIBRARY;
            }

            // å¦‚æœå¤–éƒ¨é…ç½®ä¸å¯ç”¨ï¼Œä½¿ç”¨å†…ç½®é…ç½®
            return [
                {
                    id: 'local-1',
                    title: 'Happy Melody',
                    artist: 'Labubu Band',
                    album: 'Fun Collection',
                    url: 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEcCT2J0O/kjzQMKm3A9OOeSxALUJzk77hhEgxAi/nIaz4eNk9s',
                    duration: '2:30',
                    image: 'https://picsum.photos/400/400?random=6',
                    genre: 'è½»éŸ³ä¹'
                },
                {
                    id: 'local-2',
                    title: 'Chill Vibes',
                    artist: 'Cookie Ann Crew',
                    album: 'Sweet Sounds',
                    url: 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEcCT2J0O/kjzQMKm3A9OOeSxALUJzk77hhEgxAi/nIaz4eNk9s',
                    duration: '3:15',
                    image: 'https://picsum.photos/400/400?random=7',
                    genre: 'ç¯å¢ƒéŸ³ä¹'
                }
            ];
        }

        // å†…ç½®éŸ³ä¹åº“ï¼ˆåŒ…å«å…è´¹å¯æ’­æ”¾çš„éŸ³é¢‘ï¼‰
        function getWeChatMusicLibrary() {
            return [
                {
                    title: "ğŸµ Labubuå¹¸è¿ä¹‹æ­Œ",
                    artist: "åŸºé‡‘ä¼šéŸ³ä¹å›¢",
                    album: "èƒŒæ™¯éŸ³ä¹åˆé›†",
                    url: "https://www.w3schools.com/html/horse.mp3",
                    duration: "0:30",
                    image: "",
                    jamendoUrl: "#"
                },
                {
                    title: "ğŸ¶ æŠ½å¥–è¿›è¡Œæ›²",
                    artist: "ç³»ç»ŸéŸ³ä¹",
                    album: "ä¸“äº«éŸ³ä¹",
                    url: "https://www.learningcontainer.com/wp-content/uploads/2020/02/Kalimba.mp3",
                    duration: "5:30",
                    image: "",
                    jamendoUrl: "#"
                },
                {
                    title: "ğŸ† èƒœåˆ©åº†å…¸",
                    artist: "åº†ç¥éŸ³ä¹",
                    album: "è·å¥–éŸ³æ•ˆ",
                    url: "https://archive.org/download/testmp3testfile/mpthreetest.mp3",
                    duration: "0:30",
                    image: "",
                    jamendoUrl: "#"
                },
                {
                    title: "ğŸŒ¸ æ¸©é¦¨èƒŒæ™¯",
                    artist: "ç¯å¢ƒéŸ³ä¹",
                    album: "æ°›å›´éŸ³ä¹",
                    url: "https://www.w3schools.com/html/horse.mp3",
                    duration: "0:30",
                    image: "",
                    jamendoUrl: "#"
                },
                {
                    title: "ğŸ  æ¬¢ä¹æ—¶å…‰",
                    artist: "Labubuä¹å›¢",
                    album: "å¿«ä¹åˆé›†",
                    url: "https://www.learningcontainer.com/wp-content/uploads/2020/02/Kalimba.mp3",
                    duration: "5:30",
                    image: "",
                    jamendoUrl: "#"
                },
                {
                    title: "ğŸš€ æ¢¦æƒ³èµ·èˆª",
                    artist: "åŠ±å¿—éŸ³ä¹",
                    album: "æ­£èƒ½é‡",
                    url: "https://www.w3schools.com/html/horse.mp3",
                    duration: "0:30",
                    image: "",
                    jamendoUrl: "#"
                },
                {
                    title: "â˜€ï¸ åˆåé˜³å…‰",
                    artist: "è½»éŸ³ä¹",
                    album: "æ”¾æ¾æ—¶å…‰",
                    url: "https://www.learningcontainer.com/wp-content/uploads/2020/02/Kalimba.mp3",
                    duration: "5:30",
                    image: "",
                    jamendoUrl: "#"
                },
                {
                    title: "â­ æ˜Ÿç©ºä¸‹çš„æ¢¦",
                    artist: "å¤œæ›²ç²¾é€‰",
                    album: "å®‰é™æ—‹å¾‹",
                    url: "https://www.w3schools.com/html/horse.mp3",
                    duration: "0:30",
                    image: "",
                    jamendoUrl: "#"
                },
                {
                    title: "ğŸ€ ç”œç¾æ—‹å¾‹",
                    artist: "å¯çˆ±éŸ³ä¹",
                    album: "Labubuä¸“å±",
                    url: "https://www.learningcontainer.com/wp-content/uploads/2020/02/Kalimba.mp3",
                    duration: "5:30",
                    image: "",
                    jamendoUrl: "#"
                },
                {
                    title: "ğŸ’« å¥‡å¹»ä¹‹æ—…",
                    artist: "é­”æ³•éŸ³ä¹",
                    album: "å¹»æƒ³ä¸–ç•Œ",
                    url: "https://www.w3schools.com/html/horse.mp3",
                    duration: "0:30",
                    image: "",
                    jamendoUrl: "#"
                }
            ];
        }

        // æ—¶é•¿æ ¼å¼åŒ–
        function formatDuration(seconds) {
            if (!seconds) return "0:00";
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        let currentSongIndex = 0;
        let isPlaying = false;
        let currentAudio = null;
        let isPlayerMinimized = true; // é»˜è®¤æœ€å°åŒ–

        // ç®€å•çš„UIéŸ³æ•ˆç³»ç»Ÿ
        class UISoundManager {
            constructor() {
                this.enabled = localStorage.getItem('ui_sound_enabled') !== 'false';
                this.audioContext = null;
                this.initAudioContext();
            }

            initAudioContext() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('éŸ³æ•ˆä¸æ”¯æŒ');
                }
            }

            createBeep(frequency, duration, type = 'sine') {
                if (!this.audioContext || !this.enabled) return;

                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                oscillator.frequency.value = frequency;
                oscillator.type = type;

                gainNode.gain.setValueAtTime(0.05, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);

                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            }

            playDrawSound() {
                this.createBeep(440, 0.1);
                setTimeout(() => this.createBeep(554.37, 0.1), 100);
                setTimeout(() => this.createBeep(659.25, 0.2), 200);
            }

            playWinSound() {
                this.createBeep(523.25, 0.15);
                setTimeout(() => this.createBeep(659.25, 0.15), 150);
                setTimeout(() => this.createBeep(783.99, 0.3), 300);
            }

            playClickSound() {
                this.createBeep(800, 0.1, 'square');
            }

            playNotificationSound() {
                this.createBeep(880, 0.15);
            }

            toggle() {
                this.enabled = !this.enabled;
                localStorage.setItem('ui_sound_enabled', this.enabled.toString());
                return this.enabled;
            }
        }

        const uiSounds = new UISoundManager();

        // è‡ªåŠ¨æ’­æ”¾åŠŸèƒ½
        function startAutoPlay() {
            try {
                console.log('ğŸµ å°è¯•è‡ªåŠ¨æ’­æ”¾éŸ³ä¹...');

                // æ£€æŸ¥æ˜¯å¦æœ‰éŸ³é¢‘å¯¹è±¡
                if (currentAudio) {
                    // å…ˆè®¾ç½®è¾ƒä½çš„éŸ³é‡ï¼Œé¿å…çªç„¶çš„å¤§å£°éŸ³ä¹
                    currentAudio.volume = 0.4;

                    // æ·»åŠ éŸ³é¢‘åŠ è½½ç›‘å¬å™¨
                    currentAudio.addEventListener('canplaythrough', () => {
                        console.log('ğŸµ éŸ³é¢‘æ–‡ä»¶åŠ è½½å®Œæˆï¼Œå‡†å¤‡æ’­æ”¾');
                    });

                    currentAudio.addEventListener('error', (e) => {
                        console.error('ğŸµ éŸ³é¢‘åŠ è½½é”™è¯¯:', e);
                        // å¦‚æœå½“å‰éŸ³é¢‘å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€é¦–
                        tryNextSong();
                    });

                    const playPromise = currentAudio.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            isPlaying = true;
                            updatePlayButtons();
                            showMusicNotification('ğŸµ æ¬¢è¿ï¼èƒŒæ™¯éŸ³ä¹å·²è‡ªåŠ¨å¼€å§‹', 'success');
                            console.log('ğŸµ è‡ªåŠ¨æ’­æ”¾æˆåŠŸ');
                        }).catch(error => {
                            console.log('ğŸµ è‡ªåŠ¨æ’­æ”¾è¢«æµè§ˆå™¨é˜»æ­¢ï¼Œéœ€è¦ç”¨æˆ·äº¤äº’åæ‰èƒ½æ’­æ”¾');

                            // å¦‚æœè‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢ï¼Œæ˜¾ç¤ºæç¤ºå¹¶å¯ç”¨ç”¨æˆ·ç‚¹å‡»æ’­æ”¾
                            showMusicNotification('ğŸµ ç‚¹å‡»ä»»æ„ä½ç½®å¯ç”¨éŸ³ä¹æ’­æ”¾', 'info');
                            enableUserInteractionPlay();
                        });
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰éŸ³é¢‘å¯¹è±¡ï¼Œå°è¯•é‡æ–°åŠ è½½ç¬¬ä¸€é¦–æ­Œ
                    console.log('ğŸµ currentAudioä¸ºç©ºï¼Œå°è¯•é‡æ–°åŠ è½½éŸ³ä¹...');
                    if (musicLibrary && musicLibrary.length > 0) {
                        loadSong(0);
                        // ç­‰å¾…éŸ³é¢‘åŠ è½½å®Œæˆåå†æ¬¡å°è¯•æ’­æ”¾
                        setTimeout(() => {
                            if (currentAudio) {
                                console.log('ğŸµ é‡æ–°åŠ è½½åå°è¯•è‡ªåŠ¨æ’­æ”¾...');
                                currentAudio.volume = 0.3;
                                const playPromise = currentAudio.play();
                                if (playPromise !== undefined) {
                                    playPromise.then(() => {
                                        isPlaying = true;
                                        updatePlayButtons();
                                        showMusicNotification('ğŸµ éŸ³ä¹å·²é‡æ–°åŠ è½½å¹¶å¼€å§‹æ’­æ”¾', 'success');
                                        console.log('ğŸµ é‡æ–°åŠ è½½åè‡ªåŠ¨æ’­æ”¾æˆåŠŸ');
                                    }).catch(error => {
                                        console.log('ğŸµ é‡æ–°åŠ è½½åè‡ªåŠ¨æ’­æ”¾ä»è¢«é˜»æ­¢');
                                        showMusicNotification('ğŸµ ç‚¹å‡»ä»»æ„ä½ç½®å¯ç”¨éŸ³ä¹æ’­æ”¾', 'info');
                                        enableUserInteractionPlay();
                                    });
                                }
                            } else {
                                // å¦‚æœä»ç„¶æ²¡æœ‰éŸ³é¢‘å¯¹è±¡ï¼Œå¯åŠ¨æ¨¡æ‹Ÿæ’­æ”¾
                                console.log('ğŸµ é‡æ–°åŠ è½½å¤±è´¥ï¼Œå¯åŠ¨æ¨¡æ‹Ÿæ’­æ”¾æ¨¡å¼');
                                isPlaying = true;
                                updatePlayButtons();
                                simulatePlayback();
                                showMusicNotification('ğŸµ éŸ³ä¹æ’­æ”¾å™¨å·²å¯åŠ¨ï¼ˆæ¨¡æ‹Ÿæ¨¡å¼ï¼‰', 'info');
                            }
                        }, 1500); // ç»™éŸ³é¢‘åŠ è½½æ›´å¤šæ—¶é—´
                    } else {
                        console.log('ğŸµ éŸ³ä¹åº“ä¸ºç©ºï¼Œå¯åŠ¨æ¨¡æ‹Ÿæ’­æ”¾æ¨¡å¼');
                        isPlaying = true;
                        updatePlayButtons();
                        simulatePlayback();
                        showMusicNotification('ğŸµ éŸ³ä¹æ’­æ”¾å™¨å·²å¯åŠ¨ï¼ˆæ¨¡æ‹Ÿæ¨¡å¼ï¼‰', 'info');
                    }
                }
            } catch (error) {
                console.error('ğŸµ è‡ªåŠ¨æ’­æ”¾å¤±è´¥:', error);
                showMusicNotification('ğŸµ éŸ³ä¹æ’­æ”¾å™¨å¯åŠ¨å¤±è´¥', 'error');
            }
        }

        // å¯ç”¨ç”¨æˆ·äº¤äº’æ’­æ”¾ï¼ˆå½“è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢æ—¶ï¼‰
        function enableUserInteractionPlay() {
            const enableMusic = () => {
                if (!isPlaying && currentAudio) {
                    currentAudio.volume = 0.3;
                    const playPromise = currentAudio.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            isPlaying = true;
                            updatePlayButtons();
                            showMusicNotification('ğŸµ éŸ³ä¹æ’­æ”¾å·²å¯ç”¨', 'success');

                            // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
                            document.removeEventListener('click', enableMusic);
                            document.removeEventListener('touchstart', enableMusic);
                            document.removeEventListener('keydown', enableMusic);
                        }).catch(error => {
                            console.log('ğŸµ æ’­æ”¾å¤±è´¥:', error);
                        });
                    }
                }
            };

            // æ·»åŠ å¤šç§ç”¨æˆ·äº¤äº’äº‹ä»¶ç›‘å¬å™¨
            document.addEventListener('click', enableMusic, { once: true });
            document.addEventListener('touchstart', enableMusic, { once: true });
            document.addEventListener('keydown', enableMusic, { once: true });

            // ç‰¹åˆ«ç›‘å¬æŠ½å¥–ç›¸å…³æŒ‰é’®
            setTimeout(() => {
                const drawBtns = document.querySelectorAll('#drawBtn, #trialDrawBtn, .enhanced-btn, [onclick*="onDraw"], [onclick*="performDraw"]');
                drawBtns.forEach(btn => {
                    if (btn) {
                        btn.addEventListener('click', enableMusic, { once: true });
                        console.log('ğŸµ å·²ç»‘å®šæŠ½å¥–æŒ‰é’®éŸ³ä¹è§¦å‘å™¨');
                    }
                });
            }, 1000);
        }

        async function initMusicPlayer() {
            try {
                // æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
                if (isWeChatBrowser()) {
                    showMusicNotification('ğŸµ å¾®ä¿¡ç¯å¢ƒå·²ä¼˜åŒ–ï¼ŒéŸ³ä¹åŠŸèƒ½æ­£å¸¸', 'success');
                }

                // å…ˆåŠ è½½éŸ³ä¹åº“
                const loadSuccess = await loadMusicFromAPI();
                if (loadSuccess) {
                    if (isWeChatBrowser()) {
                        console.log('ğŸµ å¾®ä¿¡ç¯å¢ƒä½¿ç”¨å†…ç½®éŸ³ä¹åº“');
                    } else {
                        console.log('ğŸµ æˆåŠŸåŠ è½½JamendoéŸ³ä¹åº“');
                    }
                } else {
                    console.log('ğŸµ ä½¿ç”¨å¤‡ç”¨éŸ³ä¹åº“');
                }

                renderPlaylist();
                if (musicLibrary.length > 0) {
                    // éšæœºé€‰æ‹©ä¸€é¦–æ­Œå¼€å§‹æ’­æ”¾
                    const randomIndex = Math.floor(Math.random() * musicLibrary.length);
                    loadSong(randomIndex);

                    // ç«‹å³å°è¯•è‡ªåŠ¨æ’­æ”¾
                    startAutoPlay();

                    // å¤‡ç”¨å¯åŠ¨æœºåˆ¶1 - 1ç§’åæ£€æŸ¥æ’­æ”¾çŠ¶æ€
                    setTimeout(() => {
                        if (!isPlaying && currentAudio) {
                            console.log('ğŸµ ç¬¬ä¸€æ¬¡è‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œå¯ç”¨ç”¨æˆ·äº¤äº’æ¨¡å¼');
                            enableUserInteractionPlay();
                        }
                    }, 1000);

                    // å¤‡ç”¨å¯åŠ¨æœºåˆ¶2 - å¦‚æœ3ç§’åä»ç„¶æ²¡æœ‰æ’­æ”¾ï¼Œå°è¯•é‡æ–°åŠ è½½
                    setTimeout(() => {
                        if (!isPlaying && musicLibrary.length > 0) {
                            console.log('ğŸµ å¤‡ç”¨å¯åŠ¨ï¼šé‡æ–°å°è¯•åŠ è½½å’Œæ’­æ”¾éŸ³ä¹');
                            // å†æ¬¡éšæœºé€‰æ‹©æ­Œæ›²
                            const backupRandomIndex = Math.floor(Math.random() * musicLibrary.length);
                            loadSong(backupRandomIndex);
                            setTimeout(() => {
                                startAutoPlay();
                                enableUserInteractionPlay();
                            }, 500);
                        }
                    }, 3000);
                }

                // ç¡®ä¿DOMå…ƒç´ å­˜åœ¨åå†åˆå§‹åŒ–
                const miniPlayer = $('#musicPlayerMini');
                const fullPlayer = $('#musicPlayerFull');
                const closeBtn = $('#closePlayer');

                console.log('ğŸµ DOMå…ƒç´ æ£€æŸ¥:', {
                    miniPlayer: !!miniPlayer,
                    fullPlayer: !!fullPlayer,
                    closeBtn: !!closeBtn
                });

                if (miniPlayer && fullPlayer) {
                    // åˆå§‹åŒ–ä¸ºå°æŒ‰é’®çŠ¶æ€
                    miniPlayer.classList.remove('hidden');
                    fullPlayer.classList.add('hidden');
                    console.log('ğŸµ æ’­æ”¾å™¨åˆå§‹çŠ¶æ€è®¾ç½®å®Œæˆ');
                } else {
                    console.warn('ğŸµ éŸ³ä¹æ’­æ”¾å™¨DOMå…ƒç´ æœªæ‰¾åˆ°');
                    console.warn('miniPlayer:', miniPlayer);
                    console.warn('fullPlayer:', fullPlayer);
                }

                // ç»‘å®šæ’­æ”¾å™¨æ§åˆ¶äº‹ä»¶
                const playPauseBtn = $('#playPauseBtn');
                const prevBtn = $('#prevBtn');
                const nextBtn = $('#nextBtn');
                const volumeSlider = $('#volumeSlider');
                const progressContainer = $('#progressContainer');

                console.log('ğŸµ æ§åˆ¶å…ƒç´ æ£€æŸ¥:', {
                    playPauseBtn: !!playPauseBtn,
                    prevBtn: !!prevBtn,
                    nextBtn: !!nextBtn,
                    volumeSlider: !!volumeSlider,
                    progressContainer: !!progressContainer
                });

                // å°æŒ‰é’®å’Œå®Œæ•´æ’­æ”¾å™¨åˆ‡æ¢
                if (miniPlayer) {
                    miniPlayer.addEventListener('click', () => {
                        console.log('ğŸµ å°æŒ‰é’®è¢«ç‚¹å‡»');
                        showFullPlayer();
                    });
                    console.log('ğŸµ å°æŒ‰é’®ç‚¹å‡»äº‹ä»¶å·²ç»‘å®š');
                } else {
                    console.error('ğŸµ å°æŒ‰é’®å…ƒç´ æœªæ‰¾åˆ°ï¼Œæ— æ³•ç»‘å®šç‚¹å‡»äº‹ä»¶');
                }

                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        console.log('ğŸµ å…³é—­æŒ‰é’®è¢«ç‚¹å‡»');
                        showMiniPlayer();
                    });
                    console.log('ğŸµ å…³é—­æŒ‰é’®ç‚¹å‡»äº‹ä»¶å·²ç»‘å®š');
                } else {
                    console.error('ğŸµ å…³é—­æŒ‰é’®å…ƒç´ æœªæ‰¾åˆ°');
                }

                // æ’­æ”¾æ§åˆ¶
                if (playPauseBtn) {
                    playPauseBtn.addEventListener('click', () => {
                        console.log('ğŸµ æ’­æ”¾/æš‚åœæŒ‰é’®è¢«ç‚¹å‡»');
                        togglePlayPause();
                    });
                }
                if (prevBtn) prevBtn.addEventListener('click', previousSong);
                if (nextBtn) nextBtn.addEventListener('click', nextSong);

                // éŸ³é‡æ§åˆ¶
                if (volumeSlider) volumeSlider.addEventListener('input', adjustVolume);

                // è¿›åº¦æ¡ç‚¹å‡»è·³è½¬
                if (progressContainer) progressContainer.addEventListener('click', seekToPosition);

                console.log('ğŸµ éŸ³ä¹æ’­æ”¾å™¨åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('ğŸµ éŸ³ä¹æ’­æ”¾å™¨åˆå§‹åŒ–å¤±è´¥:', error);
                showMusicNotification('éŸ³ä¹æ’­æ”¾å™¨åˆå§‹åŒ–å¤±è´¥', 'error');
            }
        }

        function renderPlaylist() {
            const playlist = $('#playlist');
            if (!playlist) return;

            playlist.innerHTML = '';

            if (musicLibrary.length === 0) {
                playlist.innerHTML = '<div class="text-xs text-slate-500 p-2">ğŸµ æ­£åœ¨åŠ è½½éŸ³ä¹...</div>';
                return;
            }

            musicLibrary.forEach((song, index) => {
                const songItem = document.createElement('div');
                songItem.className = `cursor-pointer p-2 rounded text-xs hover:bg-slate-100 transition-colors ${index === currentSongIndex ? 'bg-[var(--labu)] text-white' : ''}`;
                songItem.innerHTML = `
                    <div class="font-medium truncate">${song.title}</div>
                    <div class="text-xs opacity-75 truncate">${song.artist}</div>
                    <div class="text-xs opacity-60 truncate">${song.duration || ''}</div>
                `;
                songItem.addEventListener('click', () => loadSong(index));
                playlist.appendChild(songItem);
            });
        }

        function loadSong(index) {
            if (!musicLibrary || musicLibrary.length === 0) return;

            currentSongIndex = index;
            const song = musicLibrary[index];

            // åœæ­¢å½“å‰æ’­æ”¾
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
            }

            // æ›´æ–°UI
            const currentSongEl = $('#currentSong');
            const currentArtistEl = $('#currentArtist');
            const miniSongNameEl = $('#miniSongName');
            const totalTimeEl = $('#totalTime');

            if (currentSongEl) currentSongEl.textContent = `${song.title} - ${song.artist}`;

            console.log('ğŸµ æ­£åœ¨åŠ è½½æ­Œæ›²:', song.title, 'URL:', song.url);
            if (currentArtistEl) currentArtistEl.textContent = song.artist;
            if (miniSongNameEl) miniSongNameEl.textContent = `${song.title} - ${song.artist}`;
            if (totalTimeEl) totalTimeEl.textContent = song.duration || "0:00";

            // åˆ›å»ºæ–°çš„éŸ³é¢‘å¯¹è±¡
            if (song.url && song.url !== '') {
                try {
                    currentAudio = new Audio(song.url);
                    currentAudio.preload = 'auto';
                    currentAudio.volume = 0.4;

                    // å¯¹äºæœ¬åœ°æ–‡ä»¶ï¼Œä¸éœ€è¦CORSè®¾ç½®
                    if (!song.url.startsWith('music/')) {
                        currentAudio.crossOrigin = "anonymous";
                    }

                    // éŸ³é¢‘åŠ è½½å®Œæˆ
                    currentAudio.addEventListener('loadeddata', () => {
                        console.log('ğŸµ éŸ³é¢‘å·²åŠ è½½:', song.title);
                        if (totalTimeEl) {
                            totalTimeEl.textContent = formatDuration(currentAudio.duration);
                        }
                    });

                    // æ’­æ”¾æ—¶æ›´æ–°è¿›åº¦
                    currentAudio.addEventListener('timeupdate', updateProgress);

                    // æ’­æ”¾ç»“æŸè‡ªåŠ¨ä¸‹ä¸€é¦–
                    currentAudio.addEventListener('ended', () => {
                        nextSong();
                    });

                    // é”™è¯¯å¤„ç†
                    currentAudio.addEventListener('error', (e) => {
                        console.warn('ğŸµ éŸ³é¢‘åŠ è½½å¤±è´¥:', song.title, e);
                        showMusicNotification('éŸ³é¢‘åŠ è½½å¤±è´¥ï¼Œå·²è·³åˆ°ä¸‹ä¸€é¦–', 'error');
                        nextSong();
                    });
                } catch (error) {
                    console.warn('ğŸµ éŸ³é¢‘åˆ›å»ºå¤±è´¥:', error);
                }
            } else {
                console.warn('ğŸµ æ— æ•ˆçš„éŸ³é¢‘URLæˆ–æ–‡ä»¶è·¯å¾„:', song.url);
            }

            renderPlaylist();
            isPlaying = false;
            updatePlayButtons();
        }

        // æ˜¾ç¤ºå®Œæ•´æ’­æ”¾å™¨
        function showFullPlayer() {
            console.log('ğŸµ showFullPlayer å‡½æ•°è¢«è°ƒç”¨');
            const miniPlayer = $('#musicPlayerMini');
            const fullPlayer = $('#musicPlayerFull');

            console.log('ğŸµ å…ƒç´ æ£€æŸ¥ - showFullPlayer:', {
                miniPlayer: !!miniPlayer,
                fullPlayer: !!fullPlayer,
                miniPlayerClasses: miniPlayer ? miniPlayer.className : 'null',
                fullPlayerClasses: fullPlayer ? fullPlayer.className : 'null'
            });

            if (miniPlayer && fullPlayer) {
                miniPlayer.classList.add('hidden');
                fullPlayer.classList.remove('hidden');
                console.log('ğŸµ å®Œæ•´æ’­æ”¾å™¨å·²æ˜¾ç¤º');

                // æ˜¾ç¤ºç”¨æˆ·é€šçŸ¥
                if (typeof showMusicNotification === 'function') {
                    showMusicNotification('ğŸµ éŸ³ä¹æ’­æ”¾å™¨å·²å±•å¼€', 'success');
                }
            } else {
                console.error('ğŸµ showFullPlayer: DOMå…ƒç´ æœªæ‰¾åˆ°');
                if (!miniPlayer) console.error('miniPlayer å…ƒç´ æœªæ‰¾åˆ°');
                if (!fullPlayer) console.error('fullPlayer å…ƒç´ æœªæ‰¾åˆ°');
            }
        }

        // æ˜¾ç¤ºå°æŒ‰é’®æ’­æ”¾å™¨
        function showMiniPlayer() {
            console.log('ğŸµ showMiniPlayer å‡½æ•°è¢«è°ƒç”¨');
            const miniPlayer = $('#musicPlayerMini');
            const fullPlayer = $('#musicPlayerFull');

            console.log('ğŸµ å…ƒç´ æ£€æŸ¥ - showMiniPlayer:', {
                miniPlayer: !!miniPlayer,
                fullPlayer: !!fullPlayer,
                miniPlayerClasses: miniPlayer ? miniPlayer.className : 'null',
                fullPlayerClasses: fullPlayer ? fullPlayer.className : 'null'
            });

            if (miniPlayer && fullPlayer) {
                fullPlayer.classList.add('hidden');
                miniPlayer.classList.remove('hidden');
                console.log('ğŸµ å°æŒ‰é’®æ’­æ”¾å™¨å·²æ˜¾ç¤º');

                // æ˜¾ç¤ºç”¨æˆ·é€šçŸ¥
                if (typeof showMusicNotification === 'function') {
                    showMusicNotification('ğŸµ éŸ³ä¹æ’­æ”¾å™¨å·²æ”¶èµ·', 'info');
                }
            } else {
                console.error('ğŸµ showMiniPlayer: DOMå…ƒç´ æœªæ‰¾åˆ°');
                if (!miniPlayer) console.error('miniPlayer å…ƒç´ æœªæ‰¾åˆ°');
                if (!fullPlayer) console.error('fullPlayer å…ƒç´ æœªæ‰¾åˆ°');
            }
        }

        // éŸ³é‡æ§åˆ¶
        function adjustVolume(event) {
            const volume = event.target.value / 100;
            if (currentAudio) {
                currentAudio.volume = volume;
                console.log('ğŸµ éŸ³é‡è°ƒèŠ‚è‡³:', Math.round(volume * 100) + '%');
            }
        }

        // è¿›åº¦æ¡ç‚¹å‡»è·³è½¬
        function seekToPosition(event) {
            if (!currentAudio || !currentAudio.duration) return;

            const progressContainer = event.currentTarget;
            const rect = progressContainer.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const percentage = clickX / rect.width;
            const newTime = percentage * currentAudio.duration;

            currentAudio.currentTime = newTime;
            console.log('ğŸµ è·³è½¬åˆ°:', formatDuration(newTime));
        }

        function togglePlayPause() {
            if (!currentAudio) {
                // å¦‚æœæ²¡æœ‰éŸ³é¢‘ï¼Œå°è¯•é‡æ–°åŠ è½½å½“å‰æ­Œæ›²
                if (musicLibrary.length > 0) {
                    loadSong(currentSongIndex);
                    setTimeout(() => {
                        if (currentAudio) {
                            togglePlayPause();
                        } else {
                            showMusicNotification('ğŸµ æ¨¡æ‹Ÿæ’­æ”¾æ¨¡å¼', 'info');
                            isPlaying = !isPlaying;
                            updatePlayButtons();
                            if (isPlaying) {
                                simulatePlayback();
                            }
                        }
                    }, 500);
                } else {
                    showMusicNotification('ğŸµ æ¨¡æ‹Ÿæ’­æ”¾æ¨¡å¼', 'info');
                    isPlaying = !isPlaying;
                    updatePlayButtons();
                    if (isPlaying) {
                        simulatePlayback();
                    }
                }
                return;
            }

            if (isPlaying) {
                currentAudio.pause();
                isPlaying = false;
                showMusicNotification('â¸ï¸ æš‚åœæ’­æ”¾', 'info');
            } else {
                const playPromise = currentAudio.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        isPlaying = true;
                        showMusicNotification('â–¶ï¸ å¼€å§‹æ’­æ”¾', 'success');
                    }).catch(error => {
                        console.error('ğŸµ æ’­æ”¾å¤±è´¥:', error);
                        showMusicNotification('ğŸµ æ¨¡æ‹Ÿæ’­æ”¾æ¨¡å¼', 'info');
                        isPlaying = true;
                        simulatePlayback();
                    });
                }
            }

            updatePlayButtons();
        }

        // æ¨¡æ‹Ÿæ’­æ”¾åŠŸèƒ½ï¼ˆå½“æ²¡æœ‰çœŸå®éŸ³é¢‘æ—¶ï¼‰
        let simulationInterval;
        function simulatePlayback() {
            if (simulationInterval) clearInterval(simulationInterval);

            let simTime = 0;
            const maxTime = 180; // 3åˆ†é’Ÿ

            simulationInterval = setInterval(() => {
                if (!isPlaying) {
                    clearInterval(simulationInterval);
                    return;
                }

                simTime += 1;
                const progress = (simTime / maxTime) * 100;
                const progressBar = $('#progressBar');
                const currentTimeEl = $('#currentTime');

                if (progressBar) progressBar.style.width = Math.min(progress, 100) + '%';
                if (currentTimeEl) currentTimeEl.textContent = formatDuration(simTime);

                // æ¨¡æ‹Ÿæ’­æ”¾å®Œæˆ
                if (simTime >= maxTime) {
                    clearInterval(simulationInterval);
                    nextSong();
                }
            }, 1000);
        }

        function updatePlayButtons() {
            const playBtn = $('#playPauseBtn');
            const miniMusicIcon = $('#miniMusicIcon');

            if (playBtn) playBtn.textContent = isPlaying ? 'â¸ï¸' : 'â–¶ï¸';

            // æ›´æ–°å°æŒ‰é’®çš„çŠ¶æ€
            if (miniMusicIcon) {
                if (isPlaying) {
                    miniMusicIcon.textContent = 'ğŸµ';
                    miniMusicIcon.classList.add('animate-pulse');
                } else {
                    miniMusicIcon.textContent = 'â¸ï¸';
                    miniMusicIcon.classList.remove('animate-pulse');
                }
            }
        }

        function previousSong() {
            if (musicLibrary.length === 0) return;
            currentSongIndex = (currentSongIndex - 1 + musicLibrary.length) % musicLibrary.length;
            loadSong(currentSongIndex);
            if (isPlaying && currentAudio) {
                currentAudio.play().catch(console.error);
            }
        }

        function nextSong() {
            if (musicLibrary.length === 0) return;
            currentSongIndex = (currentSongIndex + 1) % musicLibrary.length;
            loadSong(currentSongIndex);
            if (isPlaying && currentAudio) {
                currentAudio.play().catch(console.error);
            }
        }

        // æ›´æ–°æ’­æ”¾è¿›åº¦ï¼ˆä½¿ç”¨çœŸå®éŸ³é¢‘ï¼‰
        function updateProgress() {
            if (!currentAudio) return;

            const currentTime = currentAudio.currentTime;
            const duration = currentAudio.duration;

            if (duration) {
                const progress = (currentTime / duration) * 100;
                const progressBar = $('#progressBar');
                const currentTimeEl = $('#currentTime');

                if (progressBar) progressBar.style.width = progress + '%';
                if (currentTimeEl) currentTimeEl.textContent = formatDuration(currentTime);
            }
        }

        // éŸ³ä¹é€šçŸ¥
        function showMusicNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' : 'bg-blue-500';

            notification.className = `fixed top-20 left-4 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm transition-all duration-300 transform -translate-x-full`;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);

            setTimeout(() => {
                notification.style.transform = 'translateX(-100%)';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        // â€”â€” ç•™è¨€ç³»ç»ŸåŠŸèƒ½ â€”â€”
        const COMMENTS_API_URL = 'https://api.jsonbin.io/v3/b/67565e7bad19ca34f8cd4c52';
        const API_KEY = '$2a$10$VjQj.Gc8Q7q8q4k4K4k4Ou'; // å…è´¹APIå¯†é’¥ç¤ºä¾‹

        let comments = [];
        let currentCommentUser = '';

        function initCommentSystem() {
            loadComments();
            updateCommentLoginStatus(); // æ›´æ–°ç™»å½•çŠ¶æ€æ˜¾ç¤º

            $('#submitComment').addEventListener('click', submitComment);
            $('#commentInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && e.ctrlKey) {
                    submitComment();
                }
            });

            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°ç•™è¨€
            setInterval(loadComments, 30000);

            // æ¯5ç§’æ£€æŸ¥ç™»å½•çŠ¶æ€
            setInterval(updateCommentLoginStatus, 5000);
        }

        // æ›´æ–°ç•™è¨€åŒºç™»å½•çŠ¶æ€æ˜¾ç¤º
        function updateCommentLoginStatus() {
            const avatarEl = $('#commentUserAvatar');
            const nameEl = $('#commentUserName');
            const statusEl = $('#commentUserStatus');
            const loginBtn = $('#commentLoginBtn');
            const commentInput = $('#commentInput');
            const submitBtn = $('#submitComment');

            try {
                const savedAuth = localStorage.getItem('labubu_user_auth');
                if (savedAuth) {
                    const currentUser = JSON.parse(savedAuth);
                    if (currentUser.phoneNumber) {
                        // å·²ç™»å½•çŠ¶æ€
                        const maskedPhone = currentUser.phoneNumber.replace(/(\+\d{1,3})(\d{3})(\d{4})(\d{4})/, '$1 $2****$4');

                        avatarEl.className = 'w-8 h-8 bg-gradient-to-br from-green-500 to-blue-500 rounded-full flex items-center justify-center text-white text-sm';
                        avatarEl.textContent = 'âœ…';
                        nameEl.textContent = maskedPhone;
                        statusEl.textContent = 'å·²ç™»å½• Â· å¯ä»¥å‘è¡¨ç•™è¨€';
                        loginBtn.style.display = 'none';

                        // å¯ç”¨ç•™è¨€åŠŸèƒ½
                        commentInput.disabled = false;
                        submitBtn.disabled = false;
                        commentInput.placeholder = 'è¯´ç‚¹ä»€ä¹ˆå§... ğŸ¯';
                        return;
                    }
                }

                // æœªç™»å½•çŠ¶æ€
                avatarEl.className = 'w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white text-sm';
                avatarEl.textContent = 'ğŸ‘¤';
                nameEl.textContent = 'æœªç™»å½•';
                statusEl.textContent = 'è¯·ç™»å½•åå‘è¡¨ç•™è¨€';
                loginBtn.style.display = 'block';

                // ç¦ç”¨ç•™è¨€åŠŸèƒ½
                commentInput.disabled = true;
                submitBtn.disabled = true;
                commentInput.placeholder = 'è¯·å…ˆç™»å½•åå†å‘è¡¨ç•™è¨€';

            } catch (error) {
                console.error('æ›´æ–°ç•™è¨€ç™»å½•çŠ¶æ€å¤±è´¥:', error);
            }
        }

        function submitComment() {
            const content = $('#commentInput').value.trim();

            if (!content) {
                alert('è¯·è¾“å…¥ç•™è¨€å†…å®¹');
                return;
            }

            // è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
            let userName = 'åŒ¿åç”¨æˆ·';
            try {
                const savedAuth = localStorage.getItem('labubu_user_auth');
                if (savedAuth) {
                    const currentUser = JSON.parse(savedAuth);
                    if (currentUser.phoneNumber) {
                        // ä½¿ç”¨æ©ç æ‰‹æœºå·ä½œä¸ºç”¨æˆ·å
                        userName = currentUser.phoneNumber.replace(/(\+\d{1,3})(\d{3})(\d{4})(\d{4})/, '$1 $2****$4');
                    }
                } else {
                    // æœªç™»å½•ä¸èƒ½å‘è¡¨ç•™è¨€
                    alert('è¯·å…ˆç™»å½•åå†å‘è¡¨ç•™è¨€');
                    return;
                }
            } catch (error) {
                console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                alert('è¯·å…ˆç™»å½•åå†å‘è¡¨ç•™è¨€');
                return;
            }

            const comment = {
                id: Date.now().toString(),
                user: userName,
                content: content,
                timestamp: new Date().toLocaleString(),
                replies: []
            };

            comments.unshift(comment);
            saveComments();
            $('#commentInput').value = '';
            renderComments();

            showMusicNotification('ç•™è¨€å‘è¡¨æˆåŠŸï¼', 'success');
        }

        function replyToComment(commentId) {
            const replyContent = prompt('å›å¤å†…å®¹ï¼š');
            if (!replyContent) return;

            // è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
            let userName = 'åŒ¿åç”¨æˆ·';
            try {
                const savedAuth = localStorage.getItem('labubu_user_auth');
                if (savedAuth) {
                    const currentUser = JSON.parse(savedAuth);
                    if (currentUser.phoneNumber) {
                        userName = currentUser.phoneNumber.replace(/(\+\d{1,3})(\d{3})(\d{4})(\d{4})/, '$1 $2****$4');
                    }
                } else {
                    alert('è¯·å…ˆç™»å½•åå†å›å¤');
                    return;
                }
            } catch (error) {
                console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                alert('è¯·å…ˆç™»å½•åå†å›å¤');
                return;
            }

            const reply = {
                id: Date.now().toString(),
                user: userName,
                content: replyContent,
                timestamp: new Date().toLocaleString()
            };

            const comment = comments.find(c => c.id === commentId);
            if (comment) {
                comment.replies = comment.replies || [];
                comment.replies.push(reply);
                saveComments();
                renderComments();
                showMusicNotification('å›å¤å‘è¡¨æˆåŠŸï¼', 'success');
            }
        }

        function deleteComment(commentId) {
            // åªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ é™¤ï¼ˆè¿™é‡Œç®€åŒ–æ£€æŸ¥ï¼‰
            if (!confirm('ç¡®è®¤åˆ é™¤æ­¤ç•™è¨€ï¼Ÿï¼ˆä»…ç®¡ç†å‘˜å¯æ“ä½œï¼‰')) return;

            comments = comments.filter(c => c.id !== commentId);
            saveComments();
            renderComments();
        }

        function renderComments() {
            const container = $('#commentsList');

            if (comments.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-slate-400 py-8">
                        <div class="text-4xl mb-2">ğŸ’­</div>
                        <div>æš‚æ— ç•™è¨€ï¼Œå¿«æ¥è¯´ç‚¹ä»€ä¹ˆå§ï¼</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            comments.forEach(comment => {
                const commentElement = document.createElement('div');
                commentElement.className = 'comment-bubble p-4 rounded-lg border border-slate-200';

                commentElement.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <span class="font-medium text-sm">${comment.user}</span>
                            <span class="text-xs text-slate-500">${comment.timestamp}</span>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="replyToComment('${comment.id}')" class="text-xs text-blue-600 hover:underline">å›å¤</button>
                            <button onclick="deleteComment('${comment.id}')" class="text-xs text-red-600 hover:underline">åˆ é™¤</button>
                        </div>
                    </div>
                    <div class="text-sm text-slate-700 mb-2">${comment.content}</div>
                    ${comment.replies && comment.replies.length > 0 ? `
                        <div class="space-y-2 mt-3">
                            ${comment.replies.map(reply => `
                                <div class="comment-reply p-2 rounded text-xs">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="font-medium">${reply.user}</span>
                                        <span class="text-slate-500">${reply.timestamp}</span>
                                    </div>
                                    <div class="text-slate-700">${reply.content}</div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                `;

                container.appendChild(commentElement);
            });

            $('#commentCount').textContent = comments.length;
        }

        function loadComments() {
            // æ¨¡æ‹Ÿä»APIåŠ è½½æ•°æ®ï¼ˆå®é™…é¡¹ç›®ä¸­éœ€è¦çœŸå®APIï¼‰
            const savedComments = localStorage.getItem('labubu_comments');
            if (savedComments) {
                comments = JSON.parse(savedComments);
                renderComments();
            }
        }

        function saveComments() {
            // æ¨¡æ‹Ÿä¿å­˜åˆ°APIï¼ˆå®é™…é¡¹ç›®ä¸­éœ€è¦çœŸå®APIï¼‰
            localStorage.setItem('labubu_comments', JSON.stringify(comments));
        }

        // æ›´æ–°å¯¼èˆªé“¾æ¥
        function updateNavigation() {
            const nav = $('nav');
            const commentsLink = document.createElement('a');
            commentsLink.href = '#comments';
            commentsLink.className = 'hover:underline flex items-center gap-1';
            commentsLink.innerHTML = 'ğŸ’¬ ç•™è¨€';
            nav.appendChild(commentsLink);
        }

        // éŸ³ä¹æ’­æ”¾å™¨å’Œç•™è¨€ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ
        // è¿™ä¸ªinitå‡½æ•°å·²ç»åˆå¹¶åˆ°ä¸‹é¢çš„ä¸»initå‡½æ•°ä¸­

        // â€”â€” è‡ªå®šä¹‰é¼ æ ‡å’Œäº¤äº’æ•ˆæœ â€”â€”
        let cursorInitialized = false; // é˜²æ­¢é‡å¤åˆå§‹åŒ–
        let customCursorEnabled = false;
        let cursorFallbackTimer = null;

        function initCustomCursor() {
            // å¦‚æœå·²ç»åˆå§‹åŒ–è¿‡ï¼Œç›´æ¥è¿”å›
            if (cursorInitialized) {
                console.log('ğŸ–±ï¸ è‡ªå®šä¹‰å…‰æ ‡å·²åˆå§‹åŒ–ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–');
                return;
            }

            try {
                const cursor = $('.custom-cursor');
                if (!cursor) {
                    console.warn('ğŸ–±ï¸ è‡ªå®šä¹‰å…‰æ ‡å…ƒç´ æœªæ‰¾åˆ°ï¼Œä½¿ç”¨ç³»ç»Ÿå…‰æ ‡');
                    enableCursorFallback();
                    return;
                }

                let mouseX = 0, mouseY = 0;

                // åˆå§‹åŒ–å…‰æ ‡ä½ç½®
                cursor.style.left = '0px';
                cursor.style.top = '0px';
                cursor.style.display = 'block';
                cursor.style.opacity = '1';

                // è®¾ç½®ä¸€ä¸ªå®šæ—¶å™¨ï¼Œå¦‚æœ3ç§’åç”¨æˆ·æ²¡æœ‰ç§»åŠ¨é¼ æ ‡ï¼Œåˆ™å¯ç”¨å¤‡ç”¨å…‰æ ‡
                cursorFallbackTimer = setTimeout(() => {
                    if (!customCursorEnabled) {
                        console.log('ğŸ–±ï¸ è‡ªå®šä¹‰å…‰æ ‡å¯èƒ½æœ‰é—®é¢˜ï¼Œå¯ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
                        enableCursorFallback();
                    }
                }, 3000);

                // é¼ æ ‡ç§»åŠ¨è·Ÿè¸ª
                document.addEventListener('mousemove', (e) => {
                    mouseX = e.clientX;
                    mouseY = e.clientY;
                    cursor.style.left = mouseX + 'px';
                    cursor.style.top = mouseY + 'px';

                    // ç¬¬ä¸€æ¬¡ç§»åŠ¨æ—¶æ ‡è®°ä¸ºå·²å¯ç”¨
                    if (!customCursorEnabled) {
                        customCursorEnabled = true;
                        document.body.classList.add('custom-cursor-enabled');
                        if (cursorFallbackTimer) {
                            clearTimeout(cursorFallbackTimer);
                            cursorFallbackTimer = null;
                        }
                        console.log('ğŸ–±ï¸ è‡ªå®šä¹‰å…‰æ ‡æˆåŠŸå¯ç”¨');
                    }

                    // åˆ›å»ºå°¾éšå…‰æ•ˆ
                    createCursorTrail(mouseX, mouseY);

                    // ä¾§è¾¹äº’åŠ¨æ£€æµ‹
                    if (mouseX < 100) {
                        createSideParticle('left', mouseY);
                    } else if (mouseX > window.innerWidth - 100) {
                        createSideParticle('right', mouseY);
                    }
                });

                // ç‚¹å‡»æ•ˆæœ
                document.addEventListener('mousedown', () => {
                    cursor.classList.add('clicking');
                    createMagicParticles(mouseX, mouseY);
                });

                document.addEventListener('mouseup', () => {
                    cursor.classList.remove('clicking');
                });

                cursorInitialized = true;
                console.log('ğŸ–±ï¸ è‡ªå®šä¹‰å…‰æ ‡åˆå§‹åŒ–å®Œæˆ');

                // æ˜¾ç¤ºå…‰æ ‡çŠ¶æ€é€šçŸ¥
                setTimeout(() => {
                    if (customCursorEnabled) {
                        showMusicNotification('ğŸ–±ï¸ è‡ªå®šä¹‰å…‰æ ‡å·²å¯ç”¨', 'success');
                    }
                }, 1000);

            } catch (error) {
                console.error('ğŸ–±ï¸ è‡ªå®šä¹‰å…‰æ ‡åˆå§‹åŒ–å¤±è´¥:', error);
                enableCursorFallback();
            }
        }

        // å¯ç”¨å¤‡ç”¨å…‰æ ‡æ–¹æ¡ˆ
        function enableCursorFallback() {
            document.body.classList.remove('custom-cursor-enabled');
            document.body.classList.add('cursor-fallback');
            console.log('ğŸ–±ï¸ å·²å¯ç”¨ç³»ç»Ÿå…‰æ ‡å¤‡ç”¨æ–¹æ¡ˆ');

            // éšè—è‡ªå®šä¹‰å…‰æ ‡å…ƒç´ 
            const cursor = $('.custom-cursor');
            if (cursor) {
                cursor.style.display = 'none';
            }

            showMusicNotification('ğŸ–±ï¸ ä½¿ç”¨ç³»ç»Ÿå…‰æ ‡', 'info');
        }

        // åˆ‡æ¢å…‰æ ‡æ¨¡å¼çš„å‡½æ•°ï¼ˆå¯ä»¥åœ¨æ§åˆ¶å°è°ƒç”¨ï¼‰
        function toggleCursorMode() {
            if (document.body.classList.contains('cursor-fallback')) {
                // å°è¯•é‡æ–°å¯ç”¨è‡ªå®šä¹‰å…‰æ ‡
                document.body.classList.remove('cursor-fallback');
                customCursorEnabled = false;
                cursorInitialized = false;
                const cursor = $('.custom-cursor');
                if (cursor) {
                    cursor.style.display = 'block';
                }
                initCustomCursor();
                showMusicNotification('ğŸ–±ï¸ å°è¯•é‡æ–°å¯ç”¨è‡ªå®šä¹‰å…‰æ ‡', 'info');
            } else {
                // åˆ‡æ¢åˆ°ç³»ç»Ÿå…‰æ ‡
                enableCursorFallback();
            }
        }

        // å°†åˆ‡æ¢å‡½æ•°æš´éœ²åˆ°å…¨å±€ï¼Œæ–¹ä¾¿è°ƒè¯•
        window.toggleCursorMode = toggleCursorMode;

        // æš´éœ²éŸ³ä¹æ’­æ”¾å™¨å‡½æ•°åˆ°å…¨å±€ï¼Œæ–¹ä¾¿è°ƒè¯•
        window.showFullPlayer = showFullPlayer;
        window.showMiniPlayer = showMiniPlayer;
        window.togglePlayPause = togglePlayPause;

        // ğŸŒ ç®€å•å…è´¹æ•°æ®å­˜å‚¨é…ç½®
        const DATA_STORAGE_CONFIG = {
            // JSONBin.io - å…è´¹JSONæ•°æ®å­˜å‚¨
            jsonbin: {
                baseUrl: 'https://api.jsonbin.io/v3',
                apiKey: '$2a$10$5Ht9Y4s.N25zjQb6I6QWb.yRqPjZdPrLs5zKkGgI8/XGo7H8bHSpe', // å…è´¹APIå¯†é’¥
                binId: null // å°†åŠ¨æ€åˆ›å»º
            },

            // å…è´¹çŸ­ä¿¡éªŒè¯API (ç¤ºä¾‹)
            sms: {
                enabled: false, // å¯é€‰ï¼šé›†æˆå…è´¹çŸ­ä¿¡API
                provider: 'mock' // æš‚æ—¶ä½¿ç”¨æ¨¡æ‹ŸéªŒè¯ç 
            }
        };

        // ç”¨æˆ·è®¤è¯çŠ¶æ€
        let currentUser = null;
        let userDataBinId = null;
        let isAuthenticated = false;

        // åˆå§‹åŒ–ç®€å•å­˜å‚¨æœåŠ¡
        console.log('ğŸŒ åˆå§‹åŒ–ç®€å•æ•°æ®å­˜å‚¨æœåŠ¡...');
        console.log('ğŸ“¦ ä½¿ç”¨JSONBin.ioä½œä¸ºå…è´¹æ•°æ®å­˜å‚¨');
        console.log('âœ… æ— éœ€Firebaseï¼Œæ›´ç®€å•æ˜“ç”¨ï¼');



        // éŸ³ä¹æ’­æ”¾å™¨æµ‹è¯•å‡½æ•°
        window.testMusicPlayer = function () {
            console.log('ğŸµ å¼€å§‹æµ‹è¯•éŸ³ä¹æ’­æ”¾å™¨...');

            // æ£€æŸ¥DOMå…ƒç´ 
            const miniPlayer = $('#musicPlayerMini');
            const fullPlayer = $('#musicPlayerFull');
            const musicPlayer = $('#musicPlayer');

            console.log('ğŸµ DOMå…ƒç´ çŠ¶æ€:', {
                musicPlayer: !!musicPlayer,
                miniPlayer: !!miniPlayer,
                fullPlayer: !!fullPlayer,
                musicPlayerClasses: musicPlayer ? musicPlayer.className : 'null',
                miniPlayerClasses: miniPlayer ? miniPlayer.className : 'null',
                fullPlayerClasses: fullPlayer ? fullPlayer.className : 'null'
            });

            if (musicPlayer) {
                console.log('ğŸµ éŸ³ä¹æ’­æ”¾å™¨å®¹å™¨ä½ç½®:', {
                    offsetTop: musicPlayer.offsetTop,
                    offsetLeft: musicPlayer.offsetLeft,
                    offsetWidth: musicPlayer.offsetWidth,
                    offsetHeight: musicPlayer.offsetHeight,
                    display: window.getComputedStyle(musicPlayer).display,
                    visibility: window.getComputedStyle(musicPlayer).visibility
                });
            }

            // æµ‹è¯•æ˜¾ç¤ºå®Œæ•´æ’­æ”¾å™¨
            console.log('ğŸµ æµ‹è¯•æ˜¾ç¤ºå®Œæ•´æ’­æ”¾å™¨...');
            showFullPlayer();

            setTimeout(() => {
                console.log('ğŸµ æµ‹è¯•æ˜¾ç¤ºå°æ’­æ”¾å™¨...');
                showMiniPlayer();
            }, 2000);

            return 'æµ‹è¯•å®Œæˆï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º';
        };

        // é¡µé¢åŠ è½½å®Œæˆåçš„è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', () => {
            setTimeout(() => {
                console.log('ğŸµ é¡µé¢åŠ è½½å®Œæˆï¼Œè¿›è¡ŒéŸ³ä¹æ’­æ”¾å™¨è‡ªåŠ¨æ£€æŸ¥...');
                const miniPlayer = $('#musicPlayerMini');
                const fullPlayer = $('#musicPlayerFull');

                if (miniPlayer) {
                    console.log('ğŸµ å°æ’­æ”¾å™¨å…ƒç´ æ‰¾åˆ°ï¼Œå°è¯•è§¦å‘ç‚¹å‡»äº‹ä»¶...');

                    // æ·»åŠ ä¸€ä¸ªä¸´æ—¶çš„ç‚¹å‡»ç›‘å¬å™¨æ¥æµ‹è¯•
                    const testClick = () => {
                        console.log('ğŸµ æµ‹è¯•ç‚¹å‡»äº‹ä»¶è¢«è§¦å‘ï¼');
                        showMusicNotification('ğŸµ ç‚¹å‡»æµ‹è¯•æˆåŠŸï¼', 'success');
                    };

                    miniPlayer.addEventListener('click', testClick);

                    // 5ç§’åç§»é™¤æµ‹è¯•ç›‘å¬å™¨
                    setTimeout(() => {
                        miniPlayer.removeEventListener('click', testClick);
                        console.log('ğŸµ æµ‹è¯•ç‚¹å‡»ç›‘å¬å™¨å·²ç§»é™¤');
                    }, 5000);

                } else {
                    console.error('ğŸµ é¡µé¢åŠ è½½å®Œæˆä½†å°æ’­æ”¾å™¨å…ƒç´ ä»æœªæ‰¾åˆ°');
                }
            }, 2000);
        });

        // ğŸ“± ç®€å•æ‰‹æœºéªŒè¯ç ç™»å½•ç³»ç»Ÿ

        let pendingPhoneNumber = null;

        // æ˜¾ç¤ºç™»å½•æ¨¡æ€çª—å£
        function showPhoneLoginModal() {
            const modal = $('#phoneLoginModal');
            if (modal) {
                modal.classList.remove('hidden');
                console.log('ğŸ“± æ‰“å¼€ç®€å•ç™»å½•çª—å£');
            }
        }

        // å…³é—­ç™»å½•æ¨¡æ€çª—å£
        function closePhoneLoginModal() {
            const modal = $('#phoneLoginModal');
            if (modal) {
                modal.classList.add('hidden');
                resetLoginForm();
            }
        }

        // é‡ç½®ç™»å½•è¡¨å•
        function resetLoginForm() {
            // é‡ç½®åˆ°æ‰‹æœºå·è¾“å…¥æ­¥éª¤
            $('#phoneInputStep').classList.remove('hidden');
            $('#codeInputStep').classList.add('hidden');
            $('#loginLoading').classList.add('hidden');

            // æ¸…ç©ºè¾“å…¥
            $('#phoneNumber').value = '';
            $('#verificationCode').value = '';

            // æ¸…ç©ºé”™è¯¯ä¿¡æ¯
            $('#phoneError').classList.add('hidden');
            $('#codeError').classList.add('hidden');

            // é‡ç½®æŒ‰é’®çŠ¶æ€
            $('#sendCodeBtn').disabled = false;
            $('#verifyCodeBtn').disabled = false;

            pendingPhoneNumber = null;
        }

        // å‘é€éªŒè¯ç ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
        async function sendVerificationCode() {
            const phoneNumber = $('#phoneNumber').value.trim();
            const countryCode = $('#countryCode').value;
            const fullPhoneNumber = countryCode + phoneNumber;

            // éªŒè¯æ‰‹æœºå·æ ¼å¼
            if (!validatePhoneNumber(phoneNumber, countryCode)) {
                return;
            }

            try {
                $('#sendCodeBtn').disabled = true;
                $('#sendCodeBtn').textContent = 'æ­£åœ¨å‘é€...';

                // æ¨¡æ‹Ÿå‘é€éªŒè¯ç çš„è¿‡ç¨‹
                await new Promise(resolve => setTimeout(resolve, 1000));

                // ä¿å­˜å¾…éªŒè¯çš„æ‰‹æœºå·
                pendingPhoneNumber = fullPhoneNumber;

                console.log('ğŸ“± æ¼”ç¤ºéªŒè¯ç å·²"å‘é€"è‡³:', fullPhoneNumber);
                showMusicNotification('éªŒè¯ç å·²å‘é€ï¼è¯·è¾“å…¥ï¼š123456', 'success');

                // åˆ‡æ¢åˆ°éªŒè¯ç è¾“å…¥ç•Œé¢
                $('#phoneInputStep').classList.add('hidden');
                $('#codeInputStep').classList.remove('hidden');
                $('#sentPhoneNumber').textContent = fullPhoneNumber;

                // å¼€å§‹å€’è®¡æ—¶
                startCountdown();

            } catch (error) {
                console.error('ğŸ“± å‘é€éªŒè¯ç å¤±è´¥:', error);
                showMusicNotification('å‘é€éªŒè¯ç å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                $('#sendCodeBtn').disabled = false;
                $('#sendCodeBtn').textContent = 'ğŸ“¤ å‘é€éªŒè¯ç ';
            }
        }

        // éªŒè¯æ‰‹æœºå·æ ¼å¼
        function validatePhoneNumber(phoneNumber, countryCode) {
            $('#phoneError').classList.add('hidden');

            if (!phoneNumber) {
                showPhoneError('è¯·è¾“å…¥æ‰‹æœºå·');
                return false;
            }

            // åŸºæœ¬æ ¼å¼éªŒè¯
            const phoneRegex = /^[0-9]{7,15}$/;
            if (!phoneRegex.test(phoneNumber)) {
                showPhoneError('æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®');
                return false;
            }

            // é’ˆå¯¹ä¸åŒå›½å®¶çš„ç‰¹æ®ŠéªŒè¯
            if (countryCode === '+86') {
                if (!/^1[3-9]\d{9}$/.test(phoneNumber)) {
                    showPhoneError('è¯·è¾“å…¥æ­£ç¡®çš„ä¸­å›½å¤§é™†æ‰‹æœºå·');
                    return false;
                }
            }

            return true;
        }

        // æ˜¾ç¤ºæ‰‹æœºå·é”™è¯¯
        function showPhoneError(message) {
            const errorEl = $('#phoneError');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }

        // å¼€å§‹å€’è®¡æ—¶
        function startCountdown() {
            let countdown = 60;
            const btn = $('#resendCodeBtn');
            const countdownEl = $('#countdown');

            btn.disabled = true;

            const timer = setInterval(() => {
                countdown--;
                countdownEl.textContent = countdown;

                if (countdown <= 0) {
                    clearInterval(timer);
                    btn.disabled = false;
                    btn.innerHTML = 'é‡æ–°å‘é€';
                }
            }, 1000);
        }

        // é‡æ–°å‘é€éªŒè¯ç 
        function resendVerificationCode() {
            // é‡ç½®reCAPTCHA
            if (appVerifier) {
                appVerifier.clear();
                initRecaptcha();
            }

            // è¿”å›æ‰‹æœºå·è¾“å…¥ç•Œé¢
            backToPhoneInput();
        }

        // è¿”å›æ‰‹æœºå·è¾“å…¥
        function backToPhoneInput() {
            $('#codeInputStep').classList.add('hidden');
            $('#phoneInputStep').classList.remove('hidden');
        }

        // éªŒè¯ç™»å½•ç ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
        async function verifyCode() {
            const code = $('#verificationCode').value.trim();

            if (!code) {
                showCodeError('è¯·è¾“å…¥éªŒè¯ç ');
                return;
            }

            if (code.length !== 6) {
                showCodeError('éªŒè¯ç åº”ä¸º6ä½æ•°å­—');
                return;
            }

            if (!pendingPhoneNumber) {
                showCodeError('éªŒè¯ç å·²å¤±æ•ˆï¼Œè¯·é‡æ–°è·å–');
                return;
            }

            try {
                $('#verifyCodeBtn').disabled = true;
                $('#verifyCodeBtn').textContent = 'æ­£åœ¨éªŒè¯...';
                $('#loginLoading').classList.remove('hidden');

                // æ¨¡æ‹ŸéªŒè¯è¿‡ç¨‹
                await new Promise(resolve => setTimeout(resolve, 1000));

                // ç®€å•çš„éªŒè¯ç æ£€æŸ¥ï¼ˆæ¼”ç¤ºç”¨ï¼‰
                if (code === '123456') {
                    // åˆ›å»ºç”¨æˆ·å¯¹è±¡
                    currentUser = {
                        phoneNumber: pendingPhoneNumber,
                        uid: 'user_' + Date.now(),
                        loginTime: new Date().toISOString()
                    };

                    isAuthenticated = true;

                    // ä¿å­˜ç™»å½•çŠ¶æ€
                    localStorage.setItem('labubu_user_auth', JSON.stringify(currentUser));

                    console.log('âœ… ç™»å½•æˆåŠŸ:', currentUser.phoneNumber);
                    showMusicNotification('ç™»å½•æˆåŠŸï¼æ­£åœ¨åŒæ­¥æ•°æ®...', 'success');

                    // æ›´æ–°ç”¨æˆ·çŠ¶æ€æ˜¾ç¤º
                    updateUserStatus(currentUser);

                    // å…³é—­ç™»å½•çª—å£
                    closePhoneLoginModal();

                    // æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
                    if (uiSounds) {
                        uiSounds.playSuccess();
                    }

                    // è‡ªåŠ¨åŒæ­¥æ•°æ®
                    setTimeout(() => {
                        autoSyncUserData();

                        // æ›´æ–°ç•™è¨€æ¿ç™»å½•çŠ¶æ€
                        if (typeof updateCommentLoginStatus === 'function') {
                            updateCommentLoginStatus();
                        }
                    }, 1000);

                } else {
                    throw new Error('éªŒè¯ç é”™è¯¯');
                }

            } catch (error) {
                console.error('âŒ éªŒè¯å¤±è´¥:', error);
                let errorMessage = 'éªŒè¯ç é”™è¯¯ï¼Œè¯·è¾“å…¥ï¼š123456';

                showCodeError(errorMessage);
                $('#verifyCodeBtn').disabled = false;
                $('#verifyCodeBtn').textContent = 'âœ… éªŒè¯ç™»å½•';
                $('#loginLoading').classList.add('hidden');
            }
        }

        // æ˜¾ç¤ºéªŒè¯ç é”™è¯¯
        function showCodeError(message) {
            const errorEl = $('#codeError');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }

        // æ›´æ–°ç”¨æˆ·çŠ¶æ€æ˜¾ç¤º
        function updateUserStatus(user) {
            const phoneEl = $('#userPhone');
            const statusEl = $('#userStatus');
            const avatarEl = $('#userAvatar');
            const loginBtn = $('#loginBtn');
            const syncBtn = $('#syncBtn');
            const logoutBtn = $('#logoutBtn');

            if (user && user.phoneNumber) {
                // å·²ç™»å½•çŠ¶æ€
                const maskedPhone = user.phoneNumber.replace(/(\+\d{1,3})(\d{3})(\d{4})(\d{4})/, '$1 $2****$4');
                phoneEl.textContent = maskedPhone;
                statusEl.textContent = 'å·²ç™»å½• Â· æ•°æ®å·²åŒæ­¥';
                avatarEl.textContent = 'âœ…';
                avatarEl.className = 'w-8 h-8 bg-gradient-to-br from-green-500 to-blue-500 rounded-full flex items-center justify-center text-white text-sm';

                // åˆ‡æ¢æŒ‰é’®æ˜¾ç¤º
                loginBtn.classList.add('hidden');
                syncBtn.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
            } else {
                // æœªç™»å½•çŠ¶æ€
                phoneEl.textContent = 'æœªç™»å½•';
                statusEl.textContent = 'ç‚¹å‡»ç™»å½•åŒæ­¥æ•°æ®';
                avatarEl.textContent = 'ğŸ‘¤';
                avatarEl.className = 'w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white text-sm';

                // åˆ‡æ¢æŒ‰é’®æ˜¾ç¤º
                loginBtn.classList.remove('hidden');
                syncBtn.classList.add('hidden');
                logoutBtn.classList.add('hidden');
            }
        }

        // åˆ‡æ¢ç”¨æˆ·èœå•
        function toggleUserMenu() {
            const menu = $('#userMenu');
            if (menu) {
                menu.classList.toggle('hidden');
            }
        }

        // ç”¨æˆ·ç™»å‡º
        async function logoutUser() {
            try {
                // æ¸…é™¤ç™»å½•çŠ¶æ€
                currentUser = null;
                isAuthenticated = false;
                userDataBinId = null;

                // æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„ç™»å½•ä¿¡æ¯
                localStorage.removeItem('labubu_user_auth');
                localStorage.removeItem('labubu_user_bin_id');

                // æ›´æ–°ç”¨æˆ·çŠ¶æ€æ˜¾ç¤º
                updateUserStatus(null);

                // æ›´æ–°ç•™è¨€æ¿ç™»å½•çŠ¶æ€
                if (typeof updateCommentLoginStatus === 'function') {
                    updateCommentLoginStatus();
                }

                showMusicNotification('å·²å®‰å…¨é€€å‡ºç™»å½•', 'info');
                console.log('ğŸšª ç”¨æˆ·å·²é€€å‡ºç™»å½•');
            } catch (error) {
                console.error('ğŸšª é€€å‡ºç™»å½•å¤±è´¥:', error);
                showMusicNotification('é€€å‡ºç™»å½•å¤±è´¥', 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLoginStatus() {
            try {
                const savedAuth = localStorage.getItem('labubu_user_auth');
                if (savedAuth) {
                    currentUser = JSON.parse(savedAuth);
                    isAuthenticated = true;
                    userDataBinId = localStorage.getItem('labubu_user_bin_id');

                    console.log('ğŸ“± å‘ç°å·²ä¿å­˜çš„ç™»å½•çŠ¶æ€:', currentUser.phoneNumber);
                    updateUserStatus(currentUser);

                    // æ›´æ–°ç•™è¨€æ¿ç™»å½•çŠ¶æ€
                    if (typeof updateCommentLoginStatus === 'function') {
                        updateCommentLoginStatus();
                    }

                    // è‡ªåŠ¨åŒæ­¥æ•°æ®
                    setTimeout(() => {
                        autoSyncUserData();
                    }, 2000);
                }
            } catch (error) {
                console.error('ğŸ“± æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                // æ¸…é™¤æŸåçš„æ•°æ®
                localStorage.removeItem('labubu_user_auth');
                localStorage.removeItem('labubu_user_bin_id');
            }
        }

        // â˜ï¸ ç»Ÿä¸€ç”¨æˆ·æ•°æ®åŒæ­¥ç³»ç»Ÿ

        // æ”¶é›†å®Œæ•´ç”¨æˆ·æ•°æ®
        function collectAllUserData() {
            return {
                // ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
                user: {
                    phoneNumber: currentUser?.phoneNumber || null,
                    uid: currentUser?.uid || null,
                    loginTime: currentUser?.loginTime || null
                },

                // ç”¨æˆ·è¯¦ç»†æ•°æ®
                userData: {
                    uid: currentUser?.uid || null,
                    name: 'æ‰‹æœºç”¨æˆ·',
                    avatar: null,
                    bio: '',
                    signature: 'Labubuæ”¶é›†å®¶ ğŸ§¸',
                    birthday: null,
                    level: calculateUserLevel(),
                    exp: calculateUserExp(),
                    maxExp: calculateMaxExp(),
                    joinDays: calculateJoinDays(),
                    totalDraws: loadUserDrawCount(),
                    totalPrizes: calculateTotalPrizes(),
                    rarityScore: calculateRarityScore(),
                    streakDays: calculateStreakDays(),
                    luckyRate: calculateLuckyRate(),
                    points: getUserPoints(),
                    createdAt: currentUser?.loginTime || new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                },

                // æŠ½å¥–ç›¸å…³æ•°æ®
                lottery: {
                    history: loadHistory(),
                    drawCount: loadUserDrawCount(),
                    drawLimit: parseInt(localStorage.getItem('labubu_draw_limit') || '0'),
                    vipDraws: parseInt(localStorage.getItem('labubu_vip_draws') || '0')
                },

                // æ”¶è—å’Œå…‘æ¢æ•°æ®
                collection: {
                    myCollection: JSON.parse(localStorage.getItem('labubu_my_collection') || '{}'),
                    exchanges: JSON.parse(localStorage.getItem('labubu_exchanges') || '[]'),
                    wishlist: JSON.parse(localStorage.getItem('labubu_wishlist') || '[]')
                },

                // ç­¾åˆ°æ•°æ®
                checkin: {
                    history: JSON.parse(localStorage.getItem('checkinHistory') || '{}'),
                    lastCheckin: localStorage.getItem('lastCheckin') || null,
                    streakDays: calculateStreakDays()
                },

                // æˆå°±æ•°æ®
                achievements: {
                    data: JSON.parse(localStorage.getItem('userData_achievements') || '{}'),
                    unlocked: JSON.parse(localStorage.getItem('labubu_achievements') || '{}'),
                    progress: JSON.parse(localStorage.getItem('labubu_achievement_progress') || '{}')
                },

                // ä»»åŠ¡æ•°æ®
                tasks: {
                    daily: JSON.parse(localStorage.getItem('labubu_daily_tasks') || '{}'),
                    weekly: JSON.parse(localStorage.getItem('labubu_weekly_tasks') || '{}'),
                    special: JSON.parse(localStorage.getItem('labubu_special_tasks') || '{}'),
                    completed: JSON.parse(localStorage.getItem('labubu_completed_tasks') || '[]')
                },

                // æ¸¸æˆæ•°æ®
                games: {
                    scores: JSON.parse(localStorage.getItem('labubu_game_scores') || '{}'),
                    stats: JSON.parse(localStorage.getItem('labubu_game_stats') || '{}'),
                    achievements: JSON.parse(localStorage.getItem('labubu_game_achievements') || '{}')
                },

                // å•†åŸæ•°æ®
                shop: {
                    cart: JSON.parse(localStorage.getItem('labubu_shopping_cart') || '[]'),
                    orders: JSON.parse(localStorage.getItem('labubu_orders') || '[]'),
                    favorites: JSON.parse(localStorage.getItem('labubu_shop_favorites') || '[]')
                },

                // ç”¨æˆ·è®¾ç½®
                settings: {
                    soundEnabled: localStorage.getItem('labubu_ui_sound_enabled') !== 'false',
                    musicVolume: localStorage.getItem('labubu_music_volume') || '50',
                    notifications: localStorage.getItem('labubu_notifications') !== 'false',
                    theme: localStorage.getItem('labubu_theme') || 'light',
                    language: localStorage.getItem('labubu_language') || 'zh-CN'
                },

                // ç¤¾äº¤æ•°æ®
                social: {
                    friends: JSON.parse(localStorage.getItem('labubu_friends') || '[]'),
                    messages: JSON.parse(localStorage.getItem('labubu_messages') || '[]'),
                    likes: JSON.parse(localStorage.getItem('labubu_likes') || '{}')
                },

                // ç³»ç»Ÿæ•°æ®
                system: {
                    lastSync: new Date().toISOString(),
                    version: '3.0',
                    clientInfo: {
                        userAgent: navigator.userAgent,
                        platform: navigator.platform,
                        language: navigator.language,
                        timestamp: Date.now()
                    }
                }
            };
        }

        // åŒæ­¥ç”¨æˆ·æ•°æ®åˆ°äº‘ç«¯
        async function syncUserData() {
            if (!currentUser) {
                showMusicNotification('æœªç™»å½•ï¼Œæ— æ³•åŒæ­¥æ•°æ®', 'error');
                return false;
            }

            try {
                showMusicNotification('æ­£åœ¨åŒæ­¥æ•°æ®åˆ°äº‘ç«¯...', 'info');

                // æ”¶é›†å®Œæ•´ç”¨æˆ·æ•°æ®
                const allUserData = collectAllUserData();

                // ä¸Šä¼ åˆ°JSONBin.io
                const success = await uploadToJsonBin(allUserData);

                if (success) {
                    console.log('â˜ï¸ å®Œæ•´ç”¨æˆ·æ•°æ®å·²åŒæ­¥åˆ°äº‘ç«¯');
                    showMusicNotification('æ•°æ®åŒæ­¥æˆåŠŸï¼', 'success');

                    // æ›´æ–°æœ¬åœ°åŒæ­¥æ—¶é—´æˆ³
                    localStorage.setItem('labubu_last_sync', new Date().toISOString());

                    // æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
                    if (uiSounds) {
                        uiSounds.playSuccess();
                    }
                    return true;
                } else {
                    throw new Error('ä¸Šä¼ å¤±è´¥');
                }

            } catch (error) {
                console.error('â˜ï¸ æ•°æ®åŒæ­¥å¤±è´¥:', error);
                showMusicNotification('æ•°æ®åŒæ­¥å¤±è´¥ï¼Œä½†æœ¬åœ°æ•°æ®å·²ä¿å­˜', 'error');
                return false;
            }
        }

        // ä»äº‘ç«¯æ¢å¤æ‰€æœ‰ç”¨æˆ·æ•°æ®
        async function restoreAllUserData(cloudData) {
            try {
                console.log('ğŸ“¥ å¼€å§‹æ¢å¤å®Œæ•´ç”¨æˆ·æ•°æ®');

                // æ¢å¤æŠ½å¥–æ•°æ®
                if (cloudData.lottery) {
                    if (cloudData.lottery.history) {
                        localStorage.setItem('labubu_lottery_history', JSON.stringify(cloudData.lottery.history));
                    }
                    if (cloudData.lottery.drawCount !== undefined) {
                        localStorage.setItem('labubu_user_draw_count', cloudData.lottery.drawCount.toString());
                    }
                    if (cloudData.lottery.drawLimit !== undefined) {
                        localStorage.setItem('labubu_draw_limit', cloudData.lottery.drawLimit.toString());
                    }
                }

                // æ¢å¤æ”¶è—æ•°æ®
                if (cloudData.collection) {
                    if (cloudData.collection.myCollection) {
                        localStorage.setItem('labubu_my_collection', JSON.stringify(cloudData.collection.myCollection));
                    }
                    if (cloudData.collection.exchanges) {
                        localStorage.setItem('labubu_exchanges', JSON.stringify(cloudData.collection.exchanges));
                    }
                    if (cloudData.collection.wishlist) {
                        localStorage.setItem('labubu_wishlist', JSON.stringify(cloudData.collection.wishlist));
                    }
                }

                // æ¢å¤ç­¾åˆ°æ•°æ®
                if (cloudData.checkin) {
                    if (cloudData.checkin.history) {
                        localStorage.setItem('checkinHistory', JSON.stringify(cloudData.checkin.history));
                    }
                    if (cloudData.checkin.lastCheckin) {
                        localStorage.setItem('lastCheckin', cloudData.checkin.lastCheckin);
                    }
                }

                // æ¢å¤æˆå°±æ•°æ®
                if (cloudData.achievements) {
                    if (cloudData.achievements.data) {
                        localStorage.setItem('userData_achievements', JSON.stringify(cloudData.achievements.data));
                    }
                    if (cloudData.achievements.unlocked) {
                        localStorage.setItem('labubu_achievements', JSON.stringify(cloudData.achievements.unlocked));
                    }
                    if (cloudData.achievements.progress) {
                        localStorage.setItem('labubu_achievement_progress', JSON.stringify(cloudData.achievements.progress));
                    }
                }

                // æ¢å¤ä»»åŠ¡æ•°æ®
                if (cloudData.tasks) {
                    if (cloudData.tasks.daily) {
                        localStorage.setItem('labubu_daily_tasks', JSON.stringify(cloudData.tasks.daily));
                    }
                    if (cloudData.tasks.weekly) {
                        localStorage.setItem('labubu_weekly_tasks', JSON.stringify(cloudData.tasks.weekly));
                    }
                    if (cloudData.tasks.special) {
                        localStorage.setItem('labubu_special_tasks', JSON.stringify(cloudData.tasks.special));
                    }
                    if (cloudData.tasks.completed) {
                        localStorage.setItem('labubu_completed_tasks', JSON.stringify(cloudData.tasks.completed));
                    }
                }

                // æ¢å¤æ¸¸æˆæ•°æ®
                if (cloudData.games) {
                    if (cloudData.games.scores) {
                        localStorage.setItem('labubu_game_scores', JSON.stringify(cloudData.games.scores));
                    }
                    if (cloudData.games.stats) {
                        localStorage.setItem('labubu_game_stats', JSON.stringify(cloudData.games.stats));
                    }
                    if (cloudData.games.achievements) {
                        localStorage.setItem('labubu_game_achievements', JSON.stringify(cloudData.games.achievements));
                    }
                }

                // æ¢å¤å•†åŸæ•°æ®
                if (cloudData.shop) {
                    if (cloudData.shop.cart) {
                        localStorage.setItem('labubu_shopping_cart', JSON.stringify(cloudData.shop.cart));
                    }
                    if (cloudData.shop.orders) {
                        localStorage.setItem('labubu_orders', JSON.stringify(cloudData.shop.orders));
                    }
                    if (cloudData.shop.favorites) {
                        localStorage.setItem('labubu_shop_favorites', JSON.stringify(cloudData.shop.favorites));
                    }
                }

                // æ¢å¤ç”¨æˆ·è®¾ç½®
                if (cloudData.settings) {
                    if (cloudData.settings.soundEnabled !== undefined) {
                        localStorage.setItem('labubu_ui_sound_enabled', cloudData.settings.soundEnabled.toString());
                    }
                    if (cloudData.settings.musicVolume) {
                        localStorage.setItem('labubu_music_volume', cloudData.settings.musicVolume);
                    }
                    if (cloudData.settings.notifications !== undefined) {
                        localStorage.setItem('labubu_notifications', cloudData.settings.notifications.toString());
                    }
                    if (cloudData.settings.theme) {
                        localStorage.setItem('labubu_theme', cloudData.settings.theme);
                    }
                    if (cloudData.settings.language) {
                        localStorage.setItem('labubu_language', cloudData.settings.language);
                    }
                }

                // æ¢å¤ç¤¾äº¤æ•°æ®
                if (cloudData.social) {
                    if (cloudData.social.friends) {
                        localStorage.setItem('labubu_friends', JSON.stringify(cloudData.social.friends));
                    }
                    if (cloudData.social.messages) {
                        localStorage.setItem('labubu_messages', JSON.stringify(cloudData.social.messages));
                    }
                    if (cloudData.social.likes) {
                        localStorage.setItem('labubu_likes', JSON.stringify(cloudData.social.likes));
                    }
                }

                // æ¢å¤ç”¨æˆ·è¯¦ç»†æ•°æ®ï¼ˆåŒ…æ‹¬ç§¯åˆ†ï¼‰
                if (cloudData.userData) {
                    localStorage.setItem('userData', JSON.stringify(cloudData.userData));
                    if (cloudData.userData.points !== undefined) {
                        localStorage.setItem('labubu_user_points', cloudData.userData.points.toString());
                    }
                }

                console.log('âœ… å®Œæ•´ç”¨æˆ·æ•°æ®æ¢å¤æˆåŠŸ');
                return true;

            } catch (error) {
                console.error('âŒ ç”¨æˆ·æ•°æ®æ¢å¤å¤±è´¥:', error);
                return false;
            }
        }

        // è®¡ç®—ç”¨æˆ·ç­‰çº§
        function calculateUserLevel() {
            const points = getUserPoints();
            if (points < 100) return 1;
            if (points < 300) return 2;
            if (points < 600) return 3;
            if (points < 1000) return 4;
            if (points < 1500) return 5;
            return Math.floor(points / 300) + 1;
        }

        // è®¡ç®—ç”¨æˆ·ç»éªŒ
        function calculateUserExp() {
            const points = getUserPoints();
            const level = calculateUserLevel();
            const levelPoints = [0, 100, 300, 600, 1000, 1500];
            const basePoints = levelPoints[level - 1] || (level - 1) * 300;
            return points - basePoints;
        }

        // è®¡ç®—æœ€å¤§ç»éªŒ
        function calculateMaxExp() {
            const level = calculateUserLevel();
            if (level <= 5) {
                const maxExpValues = [100, 200, 300, 400, 500];
                return maxExpValues[level - 1] || 500;
            }
            return 300;
        }

        // è®¡ç®—åŠ å…¥å¤©æ•°
        function calculateJoinDays() {
            try {
                const loginTime = currentUser.loginTime;
                if (loginTime) {
                    const loginDate = new Date(loginTime);
                    const now = new Date();
                    const diffTime = Math.abs(now - loginDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    return Math.max(1, diffDays);
                }
            } catch (error) {
                console.error('è®¡ç®—åŠ å…¥å¤©æ•°å¤±è´¥:', error);
            }
            return 1;
        }

        // è®¡ç®—æ€»å¥–å“æ•°
        function calculateTotalPrizes() {
            const history = loadHistory();
            return history.filter(h => h.type !== 'empty').length;
        }

        // è®¡ç®—ç¨€æœ‰åº¦åˆ†æ•°
        function calculateRarityScore() {
            const history = loadHistory();
            return history.reduce((score, h) => {
                const rarityPoints = {
                    'common': 1,
                    'rare': 5,
                    'epic': 15,
                    'legendary': 50,

                };
                return score + (rarityPoints[h.rarity] || 0);
            }, 0);
        }

        // è®¡ç®—è¿ç»­ç­¾åˆ°å¤©æ•°
        function calculateStreakDays() {
            const checkinHistory = JSON.parse(localStorage.getItem('checkinHistory') || '{}');
            return Object.keys(checkinHistory).length;
        }

        // è®¡ç®—å¹¸è¿ç‡
        function calculateLuckyRate() {
            const history = loadHistory();
            if (history.length === 0) return 50;
            const winRate = (history.filter(h => h.type !== 'empty').length / history.length) * 100;
            return Math.round(winRate);
        }

        // ä¸Šä¼ æ•°æ®åˆ°JSONBin.io
        async function uploadToJsonBin(data) {
            try {
                const config = DATA_STORAGE_CONFIG.jsonbin;
                let url = `${config.baseUrl}/b`;
                let method = 'POST';

                // å¦‚æœå·²æœ‰binIdï¼Œä½¿ç”¨PUTæ›´æ–°
                if (userDataBinId) {
                    url = `${config.baseUrl}/b/${userDataBinId}`;
                    method = 'PUT';
                }

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': config.apiKey,
                        'X-Bin-Name': `labubu_user_${currentUser.uid}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();

                    // ä¿å­˜binIdä»¥ä¾¿åç»­æ›´æ–°
                    if (result.metadata && result.metadata.id) {
                        userDataBinId = result.metadata.id;
                        localStorage.setItem('labubu_user_bin_id', userDataBinId);
                    }

                    console.log('ğŸ“¤ æ•°æ®å·²ä¸Šä¼ åˆ°JSONBin:', result);
                    return true;
                } else {
                    console.error('ğŸ“¤ ä¸Šä¼ å¤±è´¥:', response.status, response.statusText);
                    return false;
                }

            } catch (error) {
                console.error('ğŸ“¤ ä¸Šä¼ è¿‡ç¨‹å‡ºé”™:', error);
                return false;
            }
        }

        // ä»äº‘ç«¯ä¸‹è½½ç”¨æˆ·æ•°æ®
        async function downloadUserData() {
            if (!currentUser) {
                console.log('â˜ï¸ æœªç™»å½•ï¼Œè·³è¿‡æ•°æ®ä¸‹è½½');
                return;
            }

            try {
                showMusicNotification('æ­£åœ¨ä»äº‘ç«¯ä¸‹è½½æ•°æ®...', 'info');

                // ä»JSONBin.ioè·å–æ•°æ®
                const cloudData = await downloadFromJsonBin();

                if (cloudData) {
                    console.log('â˜ï¸ ä»äº‘ç«¯è·å–åˆ°å®Œæ•´ç”¨æˆ·æ•°æ®');

                    // æ¢å¤æ‰€æœ‰ç”¨æˆ·æ•°æ®
                    const restored = await restoreAllUserData(cloudData);

                    if (restored) {
                        showMusicNotification('äº‘ç«¯æ•°æ®ä¸‹è½½å®Œæˆï¼', 'success');

                        // æ›´æ–°é¡µé¢æ˜¾ç¤ºï¼ˆå¦‚æœç›¸å…³å‡½æ•°å­˜åœ¨ï¼‰
                        if (typeof updateUserPointsDisplay === 'function') {
                            updateUserPointsDisplay();
                        }
                        if (typeof renderHistory === 'function') {
                            renderHistory();
                        }
                        if (typeof initializeUserPoints === 'function') {
                            initializeUserPoints();
                        }
                    } else {
                        throw new Error('æ•°æ®æ¢å¤å¤±è´¥');
                    }
                } else {
                    console.log('â˜ï¸ äº‘ç«¯æš‚æ— ç”¨æˆ·æ•°æ®ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®');
                    showMusicNotification('é¦–æ¬¡ç™»å½•ï¼Œæ­£åœ¨åˆ›å»ºäº‘ç«¯æ•°æ®...', 'info');

                    // é¦–æ¬¡ç™»å½•ï¼Œä¸Šä¼ æœ¬åœ°æ•°æ®åˆ°äº‘ç«¯
                    setTimeout(() => {
                        syncUserData();
                    }, 1000);
                }

            } catch (error) {
                console.error('â˜ï¸ æ•°æ®ä¸‹è½½å¤±è´¥:', error);
                showMusicNotification('æ•°æ®ä¸‹è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨æœ¬åœ°æ•°æ®', 'error');
            }
        }

        // ä»JSONBin.ioä¸‹è½½æ•°æ®
        async function downloadFromJsonBin() {
            try {
                if (!userDataBinId) {
                    console.log('ğŸ“¥ æ²¡æœ‰ä¿å­˜çš„æ•°æ®IDï¼Œå¯èƒ½æ˜¯é¦–æ¬¡ç™»å½•');
                    return null;
                }

                const config = DATA_STORAGE_CONFIG.jsonbin;
                const url = `${config.baseUrl}/b/${userDataBinId}/latest`;

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': config.apiKey
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('ğŸ“¥ æ•°æ®å·²ä»JSONBinä¸‹è½½:', result);
                    return result.record || result; // JSONBin.ioçš„å“åº”æ ¼å¼
                } else if (response.status === 404) {
                    console.log('ğŸ“¥ äº‘ç«¯æ•°æ®ä¸å­˜åœ¨');
                    return null;
                } else {
                    console.error('ğŸ“¥ ä¸‹è½½å¤±è´¥:', response.status, response.statusText);
                    return null;
                }

            } catch (error) {
                console.error('ğŸ“¥ ä¸‹è½½è¿‡ç¨‹å‡ºé”™:', error);
                return null;
            }
        }

        // åˆå¹¶äº‘ç«¯æ•°æ®åˆ°æœ¬åœ°
        async function mergeCloudDataToLocal(cloudData) {
            try {
                // æ¯”è¾ƒæ—¶é—´æˆ³ï¼Œé€‰æ‹©æ›´æ–°çš„æ•°æ®
                const localLastModified = parseInt(localStorage.getItem('labubu_last_modified') || '0');
                const cloudLastModified = cloudData.lastUpdated ? new Date(cloudData.lastUpdated).getTime() : 0;

                console.log('ğŸ“Š æ•°æ®æ—¶é—´æˆ³æ¯”è¾ƒ:', {
                    local: new Date(localLastModified).toLocaleString(),
                    cloud: new Date(cloudLastModified).toLocaleString()
                });

                // åˆå¹¶æŠ½å¥–å†å²ï¼ˆå»é‡ï¼‰
                if (cloudData.history && Array.isArray(cloudData.history)) {
                    const localHistory = loadHistory();
                    const mergedHistory = mergeArrays(localHistory, cloudData.history, 'id');
                    saveHistory(mergedHistory);
                    console.log('ğŸ“Š æŠ½å¥–å†å²å·²åˆå¹¶:', mergedHistory.length, 'æ¡è®°å½•');
                }

                // æ›´æ–°ç§¯åˆ†ï¼ˆå–è¾ƒå¤§å€¼ï¼‰
                if (cloudData.points !== undefined) {
                    const localPoints = getUserPoints();
                    const maxPoints = Math.max(localPoints, cloudData.points);
                    localStorage.setItem('labubu_user_points', maxPoints.toString());
                    console.log('ğŸ’° ç§¯åˆ†å·²æ›´æ–°:', maxPoints);
                }

                // æ›´æ–°æŠ½å¥–æ¬¡æ•°ï¼ˆå–è¾ƒå¤§å€¼ï¼‰
                if (cloudData.drawCount !== undefined) {
                    const localDrawCount = loadUserDrawCount();
                    const maxDrawCount = Math.max(localDrawCount, cloudData.drawCount);
                    saveUserDrawCount(maxDrawCount);
                    console.log('ğŸ¯ æŠ½å¥–æ¬¡æ•°å·²æ›´æ–°:', maxDrawCount);
                }

                // åˆå¹¶æ”¶è—æ•°æ®
                if (cloudData.collection) {
                    const localCollection = JSON.parse(localStorage.getItem('labubu_my_collection') || '{}');
                    const mergedCollection = mergeObjects(localCollection, cloudData.collection);
                    localStorage.setItem('labubu_my_collection', JSON.stringify(mergedCollection));
                    console.log('ğŸ æ”¶è—æ•°æ®å·²åˆå¹¶');
                }

                // åˆå¹¶å…‘æ¢è®°å½•
                if (cloudData.exchanges && Array.isArray(cloudData.exchanges)) {
                    const localExchanges = JSON.parse(localStorage.getItem('labubu_exchanges') || '[]');
                    const mergedExchanges = mergeArrays(localExchanges, cloudData.exchanges, 'id');
                    localStorage.setItem('labubu_exchanges', JSON.stringify(mergedExchanges));
                    console.log('ğŸ›’ å…‘æ¢è®°å½•å·²åˆå¹¶:', mergedExchanges.length, 'æ¡è®°å½•');
                }

                // æ›´æ–°ç”¨æˆ·è®¾ç½®
                if (cloudData.settings) {
                    if (cloudData.settings.soundEnabled !== undefined) {
                        localStorage.setItem('labubu_ui_sound_enabled', cloudData.settings.soundEnabled.toString());
                    }
                    if (cloudData.settings.musicVolume !== undefined) {
                        localStorage.setItem('labubu_music_volume', cloudData.settings.musicVolume);
                    }
                    console.log('âš™ï¸ ç”¨æˆ·è®¾ç½®å·²æ›´æ–°');
                }

                // æ›´æ–°æ—¶é—´æˆ³
                localStorage.setItem('labubu_last_modified', Date.now().toString());

                // åˆ·æ–°é¡µé¢æ˜¾ç¤º
                refreshPageData();

                console.log('âœ… äº‘ç«¯æ•°æ®åˆå¹¶å®Œæˆ');

            } catch (error) {
                console.error('âŒ æ•°æ®åˆå¹¶å¤±è´¥:', error);
                throw error;
            }
        }

        // åˆå¹¶æ•°ç»„ï¼ˆå»é‡ï¼‰
        function mergeArrays(localArray, cloudArray, keyField = 'id') {
            const merged = [...localArray];
            const existingKeys = new Set(localArray.map(item => item[keyField] || item.time || JSON.stringify(item)));

            cloudArray.forEach(cloudItem => {
                const key = cloudItem[keyField] || cloudItem.time || JSON.stringify(cloudItem);
                if (!existingKeys.has(key)) {
                    merged.push(cloudItem);
                    existingKeys.add(key);
                }
            });

            // æŒ‰æ—¶é—´æ’åº
            return merged.sort((a, b) => {
                const timeA = new Date(a.time || a.timestamp || 0).getTime();
                const timeB = new Date(b.time || b.timestamp || 0).getTime();
                return timeB - timeA; // æ–°çš„åœ¨å‰
            });
        }

        // åˆå¹¶å¯¹è±¡ï¼ˆç›¸åŠ æ•°å€¼ï¼‰
        function mergeObjects(localObj, cloudObj) {
            const merged = { ...localObj };

            Object.keys(cloudObj).forEach(key => {
                if (merged[key] !== undefined) {
                    // å¦‚æœæœ¬åœ°ä¹Ÿæœ‰è¿™ä¸ªé”®ï¼Œå–è¾ƒå¤§å€¼æˆ–ç›¸åŠ 
                    merged[key] = Math.max(merged[key], cloudObj[key]);
                } else {
                    // å¦‚æœæœ¬åœ°æ²¡æœ‰ï¼Œç›´æ¥ä½¿ç”¨äº‘ç«¯å€¼
                    merged[key] = cloudObj[key];
                }
            });

            return merged;
        }

        // åˆ·æ–°é¡µé¢æ•°æ®æ˜¾ç¤º
        function refreshPageData() {
            try {
                // åˆ·æ–°å†å²è®°å½•
                if (typeof renderHistory === 'function') {
                    renderHistory();
                }

                // åˆ·æ–°æˆ‘çš„æ”¶è—
                if (typeof renderMyCollection === 'function') {
                    renderMyCollection();
                }

                // åˆ·æ–°ç§¯åˆ†æ˜¾ç¤º
                if (typeof initializeUserPoints === 'function') {
                    initializeUserPoints();
                }

                // åˆ·æ–°æŠ½å¥–é™åˆ¶æ˜¾ç¤º
                if (typeof updateDrawLimitDisplay === 'function') {
                    updateDrawLimitDisplay();
                }

                // åˆ·æ–°å…‘æ¢å•†å“æ˜¾ç¤º
                if (typeof renderExchangeItems === 'function') {
                    renderExchangeItems();
                }

                console.log('ğŸ”„ é¡µé¢æ•°æ®æ˜¾ç¤ºå·²åˆ·æ–°');

            } catch (error) {
                console.error('ğŸ”„ åˆ·æ–°é¡µé¢æ•°æ®å¤±è´¥:', error);
            }
        }



        // ç®€åŒ–çš„è‡ªåŠ¨åŒæ­¥å‡½æ•°
        async function autoSyncUserData() {
            if (!currentUser) return;

            try {
                console.log('ğŸ”„ å¼€å§‹è‡ªåŠ¨æ•°æ®åŒæ­¥...');

                // å…ˆä¸‹è½½äº‘ç«¯æ•°æ®
                await downloadUserData();

                // ç­‰å¾…1ç§’åä¸Šä¼ æœ€æ–°æ•°æ®
                setTimeout(async () => {
                    await syncUserData();
                }, 2000);

            } catch (error) {
                console.error('â˜ï¸ è‡ªåŠ¨åŒæ­¥å¤±è´¥:', error);
            }
        }

        function createCursorTrail(x, y) {
            const trail = document.createElement('div');
            trail.className = 'cursor-trail';
            trail.style.left = (x - 4) + 'px';
            trail.style.top = (y - 4) + 'px';
            document.body.appendChild(trail);

            setTimeout(() => {
                if (document.body.contains(trail)) {
                    document.body.removeChild(trail);
                }
            }, 500);
        }

        function createSideParticle(side, y) {
            if (Math.random() > 0.95) { // 5% æ¦‚ç‡è§¦å‘
                const particle = document.createElement('div');
                particle.className = 'side-particle';
                particle.textContent = ['ğŸ§¸', 'âœ¨', 'ğŸ€', 'ğŸ’«', 'ğŸŒŸ', 'ğŸ'][Math.floor(Math.random() * 6)];
                particle.style.top = (y - 50 + Math.random() * 100) + 'px';

                if (side === 'left') {
                    particle.style.left = '20px';
                    $('.side-interactive.left').appendChild(particle);
                } else {
                    particle.style.right = '20px';
                    $('.side-interactive.right').appendChild(particle);
                }

                setTimeout(() => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                }, 3000);
            }
        }

        function createMagicParticles(x, y) {
            for (let i = 0; i < 8; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'magic-particle';
                    particle.style.left = (x + Math.random() * 40 - 20) + 'px';
                    particle.style.top = (y + Math.random() * 40 - 20) + 'px';
                    document.body.appendChild(particle);

                    setTimeout(() => {
                        if (document.body.contains(particle)) {
                            document.body.removeChild(particle);
                        }
                    }, 2000);
                }, i * 50);
            }
        }

        // â€”â€” æŒ‰é’®æ³¢çº¹æ•ˆæœ â€”â€”
        function initButtonEffects() {
            document.querySelectorAll('.enhanced-btn').forEach(button => {
                button.addEventListener('click', createRipple);
            });
        }

        function createRipple(event) {
            const button = event.currentTarget;
            const rect = button.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = event.clientX - rect.left - size / 2;
            const y = event.clientY - rect.top - size / 2;

            const ripple = document.createElement('div');
            ripple.className = 'btn-ripple';
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = x + 'px';
            ripple.style.top = y + 'px';

            button.appendChild(ripple);

            setTimeout(() => {
                if (button.contains(ripple)) {
                    button.removeChild(ripple);
                }
            }, 600);
        }

        // â€”â€” æ»šåŠ¨è§’è‰²åŠ¨ç”» â€”â€”
        function initScrollCharacters() {
            let lastScrollY = window.scrollY;
            let scrollDirection = 'down';

            window.addEventListener('scroll', () => {
                const currentScrollY = window.scrollY;
                scrollDirection = currentScrollY > lastScrollY ? 'down' : 'up';
                lastScrollY = currentScrollY;

                // éšæœºè§¦å‘è§’è‰²åŠ¨ç”»
                if (Math.random() > 0.98) { // 2% æ¦‚ç‡
                    createScrollCharacter(scrollDirection);
                }
            });
        }

        function createScrollCharacter(direction) {
            const characters = ['ğŸ­', 'ğŸ°', 'ğŸ¦„', 'ğŸ¯', 'ğŸ¦', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¸', 'ğŸ·'];
            const character = document.createElement('div');
            character.className = 'scroll-character';
            character.textContent = characters[Math.floor(Math.random() * characters.length)];

            const startY = Math.random() * (window.innerHeight - 100) + 50;
            character.style.top = startY + 'px';

            if (direction === 'down') {
                character.style.left = '-100px';
            } else {
                character.style.right = '-100px';
                character.style.transform = 'scaleX(-1)';
            }

            document.body.appendChild(character);

            setTimeout(() => {
                if (document.body.contains(character)) {
                    document.body.removeChild(character);
                }
            }, 4000);
        }

        // â€”â€” é¡µé¢åŠ è½½åŠ¨ç”»ä¼˜åŒ– â€”â€”
        function initPageAnimations() {
            // ä¸ºæ‰€æœ‰sectionæ·»åŠ è¿›å…¥åŠ¨ç”»
            const sections = document.querySelectorAll('section, main');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.animation = 'slideIn 0.6s ease-out forwards';
                    }
                });
            }, {
                threshold: 0.1,
                rootMargin: '50px'
            });

            sections.forEach(section => {
                observer.observe(section);
            });
        }

        // â€”â€” éŸ³ä¹æ’­æ”¾å™¨ä½ç½®ä¼˜åŒ– â€”â€”
        function optimizeMusicPlayer() {
            const player = $('#musicPlayer');
            if (player) {
                // æ£€æµ‹å±å¹•å°ºå¯¸ï¼Œç§»åŠ¨ç«¯æ—¶è°ƒæ•´ä½ç½®
                if (window.innerWidth < 768) {
                    player.style.width = '280px';
                    player.style.bottom = '20px';
                    player.style.right = '20px';
                }
            }
        }

        // å®‰å…¨åˆå§‹åŒ–å‡½æ•° (é˜²ç¯¡æ”¹)
        const _0x9f2e = function () {
            // ç”¨æˆ·æƒé™éªŒè¯ - åªåœ¨é¦–æ¬¡è®¿é—®æ—¶éªŒè¯
            if (!window.checkVIPAccess || !window.checkVIPAccess()) {
                return false;
            }

            // æ˜¾ç¤ºç”¨æˆ·æ ‡è¯†ï¼ˆåªæ˜¾ç¤ºä¸€æ¬¡ï¼‰
            if (window.showVIPBadge) {
                window.showVIPBadge();
            }

            // åŸŸåéªŒè¯
            if (!window._secureConfig.validate()) {
                console.log('ğŸµ æ¬¢è¿è®¿é—®Labubuä¸»é¢˜å¨±ä¹å¹³å°');
                return false;
            }

            return true;
        };

        function init() {
            // å®‰å…¨æ£€æŸ¥
            if (!_0x9f2e()) return;

            $('#year').textContent = new Date().getFullYear();
            renderHistory();
            updateDrawLimitDisplay();
            setupDataSync();

            // åˆå§‹åŒ–äº¤äº’æ•ˆæœ
            setTimeout(() => {
                initCustomCursor();
                initButtonEffects();
                initScrollCharacters();
                initPageAnimations();
                optimizeMusicPlayer();
            }, 100);
        }

        // â€”â€” ç§¯åˆ†å…‘æ¢ç³»ç»Ÿ â€”â€”
        const EXCHANGE_ITEMS = [
            {
                id: 1,
                name: "é™å®šLabubuä¸‡åœ£èŠ‚æŒ‚ä»¶",
                emoji: "ğŸƒ",
                image: "images/prizes/labubu/halloween-special.jpg",
                description: "è¶…ç¨€æœ‰ä¸‡åœ£èŠ‚é™å®šæŒ‚ä»¶",
                cost: 6000,
                rarity: 'legendary',
                available: 1,
                requirements: "éœ€è¦3ä¸ªå²è¯—çº§è§’è‰² + 1000ç§¯åˆ†"
            },
            {
                id: 2,
                name: "é™å®šCookie Annåœ£è¯æŒ‚ä»¶",
                emoji: "ğŸ„",
                image: "images/prizes/cookie-ann/christmas-special.jpg",
                description: "è¿ªå£«å°¼åœ£è¯é™å®šæŒ‚ä»¶",
                cost: 6000,
                rarity: 'legendary',
                available: 1,
                requirements: "éœ€è¦3ä¸ªå²è¯—çº§è§’è‰² + 1000ç§¯åˆ†"
            },
            {
                id: 3,
                name: "é™å®šMollyå¤æ—¥æµ·æ´‹æŒ‚ä»¶",
                emoji: "ğŸŒŠ",
                image: "images/prizes/popmart/molly-ocean-special.jpg",
                description: "2025å¤æ—¥æµ·æ´‹é™å®šæŒ‚ä»¶",
                cost: 8000,
                rarity: 'legendary',
                available: 1,
                requirements: "éœ€è¦4ä¸ªå²è¯—çº§è§’è‰² + 2000ç§¯åˆ†"
            },
            {
                id: 4,
                name: "ç™½é‡‘Labubuè‡³å°Šç‰ˆ",
                emoji: "ğŸ’",
                image: "images/prizes/labubu/platinum.jpg",
                description: "ç»ˆææ”¶è—ç‰ˆLabubu",
                cost: 4000,
                rarity: 'legendary',
                available: 3,
                requirements: "éœ€è¦4ä¸ªå²è¯—çº§è§’è‰²"
            },
            {
                id: 5,
                name: "Cookie Annå…¬ä¸»ç¤¼ç›’",
                emoji: "ğŸ‘¸",
                image: "images/prizes/cookie-ann/royal-set.jpg",
                description: "è¿ªå£«å°¼å…¬ä¸»ä¸»é¢˜é™å®šå¥—è£…",
                cost: 3500,
                rarity: 'legendary',
                available: 2,
                requirements: "éœ€è¦3ä¸ªå²è¯—çº§è§’è‰²"
            },
            {
                id: 6,
                name: "Pop Martè”åç¤¼åŒ…",
                emoji: "ğŸ",
                description: "åŒ…å«Molly+Dimooé™å®šå‘¨è¾¹",
                cost: 2000,
                rarity: 'epic',
                available: 5,
                requirements: "éœ€è¦3ä¸ªç¨€æœ‰çº§è§’è‰²"
            }
        ];

        let userInventory = JSON.parse(localStorage.getItem('labubu_inventory') || '[]');
        let userPoints = 0;

        // è®¡ç®—ç”¨æˆ·ç§¯åˆ†
        function calculateUserPoints() {
            const history = loadHistory();
            userPoints = 0;

            history.forEach(record => {
                const pool = loadPool();
                const prize = pool.find(p => p.name === record.prize);
                if (prize && prize.points) {
                    userPoints += prize.points;
                }
            });

            // æ›´æ–°æ˜¾ç¤º
            $('#userPoints').textContent = userPoints;
            updateExchangeableItems();
            return userPoints;
        }

        // æ›´æ–°å¯å…‘æ¢ç‰©å“æ•°é‡
        function updateExchangeableItems() {
            const canExchange = EXCHANGE_ITEMS.filter(item => userPoints >= item.cost).length;
            $('#exchangeableItems').textContent = canExchange;
        }

        // æ¸²æŸ“å…‘æ¢å•†å“
        function renderExchangeItems() {
            const container = $('#exchangeItems');

            container.innerHTML = EXCHANGE_ITEMS.map(item => {
                const canAfford = userPoints >= item.cost;
                const rarityConfig = getRarityConfig(item.rarity);

                return `
                    <div class="border border-slate-200 rounded-2xl p-4 ${canAfford ? 'bg-white' : 'bg-gray-50 opacity-60'}">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="text-3xl">${item.emoji}</div>
                            <div class="flex-1">
                                <h4 class="font-medium text-sm">${item.name}</h4>
                                <div class="text-xs" style="color: ${rarityConfig.color}">
                                    ${rarityConfig.emoji} ${rarityConfig.name}çº§
                                </div>
                            </div>
                        </div>
                        
                        <p class="text-xs text-slate-600 mb-3">${item.description}</p>
                        
                        <div class="text-xs text-slate-500 mb-3">
                            ${item.requirements}
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div class="text-sm">
                                <span class="font-bold text-[var(--labu)]">${item.cost}</span> ç§¯åˆ†
                            </div>
                            <button onclick="exchangeItem(${item.id})" 
                                    class="enhanced-btn px-3 py-1 text-xs rounded-lg ${canAfford ? 'bg-[var(--labu)] text-white' : 'bg-gray-200 text-gray-500'}"
                                    ${!canAfford ? 'disabled' : ''}>
                                ${canAfford ? 'ğŸ”„ å…‘æ¢' : 'âŒ ç§¯åˆ†ä¸è¶³'}
                            </button>
                        </div>
                        
                        <div class="text-xs text-slate-400 mt-2">
                            å‰©ä½™: ${item.available} ä»¶
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ¸²æŸ“æˆ‘çš„æ”¶è—
        function renderMyCollection() {
            const container = $('#myCollection');
            const history = loadHistory();
            const pool = loadPool();

            // ç»Ÿè®¡æ”¶è—
            const collection = {};
            history.forEach(record => {
                const prize = pool.find(p => p.name === record.prize);
                if (prize && prize.rarity && prize.rarity !== 'common') {
                    collection[record.prize] = (collection[record.prize] || 0) + 1;
                }
            });

            if (Object.keys(collection).length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-8 text-slate-400">
                        <div class="text-3xl mb-2">ğŸ§¸</div>
                        <div class="text-sm">æš‚æ— æ”¶è—ï¼Œå¿«å»æŠ½å¥–è·å¾—Labubuå§ï¼</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = Object.entries(collection).map(([name, count]) => {
                const prize = pool.find(p => p.name === name);
                const rarityConfig = getRarityConfig(prize.rarity);

                return `
                    <div class="bg-white border border-slate-200 rounded-xl p-3 text-center">
                        <div class="text-2xl mb-1">${getLabubuEmoji(name)}</div>
                        <div class="text-xs font-medium mb-1">${name}</div>
                        <div class="text-xs mb-2" style="color: ${rarityConfig.color}">
                            ${rarityConfig.emoji} ${rarityConfig.name}
                        </div>
                        <div class="text-xs font-bold">æ•°é‡: ${count}</div>
                        <div class="text-xs text-slate-500">ä»·å€¼: ${(prize.points || 0) * count}åˆ†</div>
                    </div>
                `;
            }).join('');
        }

        // è·å–Labubuè¡¨æƒ…
        function getLabubuEmoji(name) {
            const emojiMap = {
                'ç»å…¸Labubuå…¬ä»”': 'ğŸ§¸',
                'å½©è™¹Labubué™å®š': 'ğŸŒˆ',
                'åœ£è¯Labubuç‰¹åˆ«ç‰ˆ': 'ğŸ„',
                'é»„é‡‘Labubuæ”¶è—ç‰ˆ': 'ğŸ‘‘',
                '24ä¸Šè¿ªä¸‡åœ£èŠ‚é¥¼é¥¼æŒ‚ä»¶': 'ğŸƒ',
                '24ä¸Šè¿ªä¸‡åœ£èŠ‚éœ²éœ²æŒ‚ä»¶': 'ğŸ‘»',
                '25ä¸Šè¿ªå¤æ—¥æµ·æ´‹é¥¼é¥¼æŒ‚ä»¶': 'ğŸŒŠ'
            };
            return emojiMap[name] || 'ğŸ§¸';
        }

        // ğŸ† ç§¯åˆ†ç®¡ç†ç³»ç»Ÿ
        function getUserPoints() {
            return parseInt(localStorage.getItem('labubu_user_points') || '100');
        }

        function updateUserPoints(change) {
            const currentPoints = getUserPoints();
            const newPoints = Math.max(0, currentPoints + change);
            localStorage.setItem('labubu_user_points', newPoints.toString());

            // æ›´æ–°æ‰€æœ‰ç§¯åˆ†æ˜¾ç¤ºå…ƒç´ 
            const pointsElements = document.querySelectorAll('.user-points, #userPoints');
            pointsElements.forEach(el => {
                if (el) el.textContent = newPoints;
            });

            console.log(`ğŸ† ç§¯åˆ†${change >= 0 ? 'å¢åŠ ' : 'å‡å°‘'}ï¼š${Math.abs(change)}ï¼Œå½“å‰ç§¯åˆ†ï¼š${newPoints}`);
            return newPoints;
        }

        function initializeUserPoints() {
            const currentPoints = getUserPoints();
            const pointsElements = document.querySelectorAll('.user-points, #userPoints');
            pointsElements.forEach(el => {
                if (el) el.textContent = currentPoints;
            });
            console.log(`ğŸ† ç§¯åˆ†ç³»ç»Ÿåˆå§‹åŒ–ï¼Œå½“å‰ç§¯åˆ†ï¼š${currentPoints}`);
        }

        // ğŸ¯ æˆå°±æ£€æŸ¥ç³»ç»Ÿï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
        function checkAchievements(record, picked, rarity) {
            console.log('ğŸ¯ æ£€æŸ¥æˆå°±è§¦å‘...', {
                prize: record.prize,
                type: record.type,
                rarity: rarity
            });

            // è·å–ç”¨æˆ·ç»Ÿè®¡æ•°æ®
            const history = loadHistory();
            const totalDraws = history.filter(r => r.type !== 'è¯•æŠ½').length;
            const legendaryCount = history.filter(r =>
                (r.prize && r.prize.includes('é™å®š')) ||
                (picked && picked.rarity === 'legendary')
            ).length;

            // æ£€æŸ¥å„ç§æˆå°±
            const achievements = [];

            // æŠ½å¥–æ¬¡æ•°æˆå°±
            if (totalDraws === 1) {
                achievements.push('ğŸ‰ æ–°æ‰‹å¹¸è¿å„¿ - å®Œæˆç¬¬ä¸€æ¬¡æŠ½å¥–ï¼');
            } else if (totalDraws === 10) {
                achievements.push('ğŸ¯ æŠ½å¥–è¾¾äºº - å®Œæˆ10æ¬¡æŠ½å¥–ï¼');
            } else if (totalDraws === 50) {
                achievements.push('ğŸ† æŠ½å¥–å¤§å¸ˆ - å®Œæˆ50æ¬¡æŠ½å¥–ï¼');
            }

            // ç¨€æœ‰åº¦æˆå°±
            if (rarity === 'legendary') {
                achievements.push('â­ å²è¯—æ”¶é›†è€… - è·å¾—å²è¯—çº§å¥–å“ï¼');


            }

            // ç‰¹æ®Šå¥–å“æˆå°±
            if (record.prize && record.prize.includes('é™å®š')) {
                achievements.push('ğŸ’ é™å®šæ”¶è—å®¶ - è·å¾—é™å®šç‰ˆå¥–å“ï¼');
            }

            // æ˜¾ç¤ºæˆå°±é€šçŸ¥
            achievements.forEach((achievement, index) => {
                setTimeout(() => {
                    showMusicNotification(achievement, 'success');
                    if (uiSounds) uiSounds.playSuccess();

                    // ç»™äºˆæˆå°±ç§¯åˆ†å¥–åŠ±
                    updateUserPoints(50);
                    setTimeout(() => {
                        showMusicNotification('ğŸ æˆå°±å¥–åŠ±ï¼š+50 ç§¯åˆ†ï¼', 'info');
                    }, 1000);
                }, index * 2000);
            });

            return achievements.length > 0;
        }

        // å…‘æ¢ç‰©å“
        function exchangeItem(itemId) {
            const item = EXCHANGE_ITEMS.find(i => i.id === itemId);
            const currentPoints = getUserPoints();

            if (!item) {
                showMusicNotification('å•†å“ä¸å­˜åœ¨', 'error');
                return;
            }

            if (currentPoints < item.cost) {
                showMusicNotification(`ç§¯åˆ†ä¸è¶³ï¼éœ€è¦ ${item.cost} ç§¯åˆ†ï¼Œå½“å‰åªæœ‰ ${currentPoints} ç§¯åˆ†`, 'error');
                return;
            }

            if (item.available <= 0) {
                showMusicNotification('å•†å“åº“å­˜ä¸è¶³', 'error');
                return;
            }

            if (confirm(`ç¡®è®¤å…‘æ¢ ${item.name}ï¼Ÿ\næ¶ˆè€— ${item.cost} ç§¯åˆ†`)) {
                // æ‰£é™¤ç§¯åˆ†
                updateUserPoints(-item.cost);
                item.available--;

                // æ·»åŠ åˆ°å†å²è®°å½•
                const history = loadHistory();
                const exchangeRecord = {
                    id: Date.now(),
                    prize: item.name,
                    code: generateCode(),
                    time: new Date().toLocaleString(),
                    type: 'exchange'
                };
                history.unshift(exchangeRecord);
                saveHistory(history);

                // æ›´æ–°æ˜¾ç¤º
                renderExchangeItems();
                renderMyCollection();
                renderHistory();

                // æ˜¾ç¤ºå…‘æ¢æˆåŠŸ
                showExchangeSuccess(item.name, exchangeRecord.code);
                showMusicNotification(`ğŸ‰ æˆåŠŸå…‘æ¢ ${item.name}ï¼`, 'success');

                // åˆ›å»ºåº†ç¥æ•ˆæœ
                createCelebrationEffect();

                // æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
                if (uiSounds) {
                    uiSounds.playSuccess();
                }
            }
        }

        // æ˜¾ç¤ºå…‘æ¢æˆåŠŸ
        function showExchangeSuccess(itemName, code) {
            const popup = document.createElement('div');
            popup.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center';
            popup.innerHTML = `
                <div class="bg-white rounded-3xl p-8 mx-4 max-w-md w-full text-center">
                    <div class="text-6xl mb-4">ğŸ‰</div>
                    <h3 class="text-xl font-bold mb-2">å…‘æ¢æˆåŠŸï¼</h3>
                    <p class="text-slate-600 mb-4">æ­å–œè·å¾—ï¼š${itemName}</p>
                    <div class="bg-gray-100 rounded-lg p-3 mb-4">
                        <div class="text-xs text-slate-500 mb-1">å…‘æ¢ç </div>
                        <div class="font-mono text-lg font-bold">${code}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            class="enhanced-btn px-6 py-2 bg-[var(--labu)] text-white rounded-xl font-medium">
                        ç¡®å®š
                    </button>
                </div>
            `;
            document.body.appendChild(popup);
        }

        // åˆå§‹åŒ–ç§¯åˆ†å…‘æ¢ç³»ç»Ÿ
        function initExchangeSystem() {
            calculateUserPoints();
            renderExchangeItems();
            renderMyCollection();

            // ç»‘å®šäº‹ä»¶
            $('#calculatePointsBtn').addEventListener('click', () => {
                calculateUserPoints();
                showNotification('âœ… ç§¯åˆ†å·²é‡æ–°è®¡ç®—');
            });
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg z-50';
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 3000);
        }

        // åˆ›å»ºåº†ç¥æ•ˆæœ
        function createCelebrationEffect() {
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'magic-particle';
                    particle.style.left = (window.innerWidth / 2 + Math.random() * 200 - 100) + 'px';
                    particle.style.top = (window.innerHeight / 2 + Math.random() * 200 - 100) + 'px';
                    document.body.appendChild(particle);

                    setTimeout(() => {
                        if (document.body.contains(particle)) {
                            document.body.removeChild(particle);
                        }
                    }, 2000);
                }, i * 100);
            }
        }

        // æ£€æŸ¥æ¡æ¬¾åŒæ„çŠ¶æ€
        function checkTermsAgreement() {
            const agreed = localStorage.getItem('terms_agreed');
            if (!agreed) {
                window.location.href = 'welcome.html';
                return false;
            }

            const agreeTime = parseInt(agreed);
            const now = Date.now();
            const dayInMs = 24 * 60 * 60 * 1000;

            // æ¡æ¬¾åŒæ„æœ‰æ•ˆæœŸ7å¤©
            if (now - agreeTime > 7 * dayInMs) {
                localStorage.removeItem('terms_agreed');
                window.location.href = 'welcome.html';
                return false;
            }

            return true;
        }

        // æ›´æ–°ä¸»è¦çš„initå‡½æ•° 
        function init() {
            if (!_0x9f2e()) return;
            if (!checkTermsAgreement()) return;

            loadData();
            renderHistory();
            updateDrawLimitDisplay();
            setupDataSync();
            initExchangeSystem(); // åˆå§‹åŒ–å…‘æ¢ç³»ç»Ÿ

            // åˆå§‹åŒ–éŸ³ä¹æ’­æ”¾å™¨
            initMusicPlayer();
            initCommentSystem();
            updateNavigation();

            // åˆå§‹åŒ–å›¾ç‰‡ç”»å»Š
            setTimeout(() => {
                initImageGallery();
            }, 100);

            // åˆå§‹åŒ–ç§¯åˆ†ç³»ç»Ÿ
            initializeUserPoints();

            // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
            checkLoginStatus();

            setTimeout(() => {
                // initCustomCursor(); // å·²åœ¨bind()å‡½æ•°ä¸­åˆå§‹åŒ–ï¼Œé¿å…é‡å¤
                initButtonEffects();
                initScrollCharacters();
                initPageAnimations();
                initPageTransitions(); // åˆå§‹åŒ–é¡µé¢è¿‡æ¸¡
                optimizeMusicPlayer();
            }, 100);
        }

        // ä¹å®«æ ¼å›¾ç‰‡ç‚¹å‡»äº¤äº’
        function initImageGallery() {
            const galleryItems = document.querySelectorAll('.gallery-item');
            galleryItems.forEach(item => {
                item.addEventListener('click', function () {
                    const title = this.getAttribute('data-title');
                    showImageModal(title, this);
                });
            });
        }

        function showImageModal(title, element) {
            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl max-w-md w-full p-6 text-center">
                    <div class="text-6xl mb-4">${element.querySelector('div').textContent}</div>
                    <h3 class="text-xl font-bold mb-2">${title}</h3>
                    <p class="text-slate-600 text-sm mb-4">è¿ªå£«å°¼é¥¼é¥¼ Ã— Labubu è”åç³»åˆ—</p>
                    <div class="text-xs text-slate-500 mb-6">
                        è¿™æ˜¯${title}çš„ç²¾ç¾è®¾è®¡ï¼Œèåˆäº†è¿ªå£«å°¼çš„ç»å…¸å…ƒç´ å’ŒLabubuçš„å¯çˆ±é£æ ¼ï¼Œæ¯ä¸€ä¸ªç»†èŠ‚éƒ½å……æ»¡äº†ç«¥è¶£å’Œåˆ›æ„ã€‚
                    </div>
                    <button onclick="this.closest('.fixed').remove()" 
                            class="px-6 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors">
                        å…³é—­
                    </button>
                </div>
            `;

            document.body.appendChild(modal);

            // ç‚¹å‡»å¤–éƒ¨å…³é—­
            modal.addEventListener('click', function (e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // ç»‘å®šæ–°åŠŸèƒ½
        window.replyToComment = replyToComment;
        window.deleteComment = deleteComment;
        window.exchangeItem = exchangeItem;

        bind();
        init();
    </script>
</body>

</html>