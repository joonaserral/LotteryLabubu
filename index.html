<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Labubu å¹¸è¿æŠ½å¥– ğŸ§¸</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ§¸</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- VIPå®‰å…¨éªŒè¯ -->
    <script src="auth.js"></script>
    <script src="config.enc.js"></script>
    <!-- ç§»é™¤Google Fontsä»¥é¿å…å¾®ä¿¡ç¯å¢ƒä¸‹çš„åŠ è½½é—®é¢˜ -->
    <style>
        /* ä½¿ç”¨ç³»ç»Ÿå­—ä½“ä»£æ›¿Google Fontsï¼Œç¡®ä¿å¾®ä¿¡å…¼å®¹æ€§ */
        body,
        html,
        * {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji" !important;
        }
    </style>
    <style>
        :root {
            --labu: #6b5b95;
            --labu2: #ffcc00;
        }

        body {
            font-family: 'Zen Maru Gothic', system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans SC', 'PingFang SC', 'Microsoft Yahei', sans-serif;
        }

        .labu-gradient {
            background-image: linear-gradient(135deg, rgba(107, 91, 149, .12), rgba(255, 204, 0, .12));
            position: relative;
            overflow: hidden;
        }

        .labu-gradient::before {
            content: "ğŸ§¸âœ¨ğŸ€ğŸ’«ğŸŒŸ";
            position: absolute;
            top: 10%;
            left: -100%;
            font-size: 2rem;
            opacity: 0.3;
            animation: float-emojis 20s linear infinite;
        }

        .labu-gradient::after {
            content: "ğŸğŸ­ğŸªğŸ¨ğŸ¯";
            position: absolute;
            bottom: 10%;
            right: -100%;
            font-size: 1.5rem;
            opacity: 0.2;
            animation: float-emojis-reverse 25s linear infinite;
        }

        @keyframes float-emojis {
            from {
                left: -100%;
            }

            to {
                left: 100%;
            }
        }

        @keyframes float-emojis-reverse {
            from {
                right: -100%;
            }

            to {
                right: 100%;
            }
        }

        .spin {
            animation: spin 1.5s cubic-bezier(.2, .7, .2, 1) 1;
        }

        .spin-legendary {
            animation: spin-legendary 2s cubic-bezier(.2, .7, .2, 1) 1;
        }

        .spin-rare {
            animation: spin-rare 1.8s cubic-bezier(.2, .7, .2, 1) 1;
        }

        .spin-common {
            animation: spin-common 1.2s cubic-bezier(.2, .7, .2, 1) 1;
        }

        @keyframes spin {
            0% {
                transform: rotate(-6deg) scale(.98);
            }

            25% {
                transform: rotate(3deg) scale(1.01);
            }

            50% {
                transform: rotate(6deg) scale(1.02);
            }

            75% {
                transform: rotate(-3deg) scale(1.01);
            }

            100% {
                transform: rotate(0) scale(1);
            }
        }

        @keyframes spin-legendary {
            0% {
                transform: rotate(-12deg) scale(.95);
                box-shadow: 0 0 0 rgba(255, 215, 0, 0.5);
            }

            25% {
                transform: rotate(8deg) scale(1.05);
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            }

            50% {
                transform: rotate(12deg) scale(1.08);
                box-shadow: 0 0 30px rgba(255, 215, 0, 1);
            }

            75% {
                transform: rotate(-8deg) scale(1.05);
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            }

            100% {
                transform: rotate(0) scale(1);
                box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
            }
        }

        @keyframes spin-rare {
            0% {
                transform: rotate(-10deg) scale(.96);
                box-shadow: 0 0 0 rgba(138, 43, 226, 0.5);
            }

            25% {
                transform: rotate(6deg) scale(1.03);
                box-shadow: 0 0 15px rgba(138, 43, 226, 0.7);
            }

            50% {
                transform: rotate(10deg) scale(1.06);
                box-shadow: 0 0 25px rgba(138, 43, 226, 0.9);
            }

            75% {
                transform: rotate(-6deg) scale(1.03);
                box-shadow: 0 0 15px rgba(138, 43, 226, 0.7);
            }

            100% {
                transform: rotate(0) scale(1);
                box-shadow: 0 0 8px rgba(138, 43, 226, 0.2);
            }
        }

        @keyframes spin-common {
            0% {
                transform: rotate(-4deg) scale(.98);
            }

            50% {
                transform: rotate(4deg) scale(1.02);
            }

            100% {
                transform: rotate(0) scale(1);
            }
        }

        .sparkle {
            animation: sparkle 1s ease-in-out infinite;
        }

        @keyframes sparkle {

            0%,
            100% {
                opacity: 0.3;
                transform: scale(1);
            }

            50% {
                opacity: 1;
                transform: scale(1.1);
            }
        }

        .bounce-in {
            animation: bounce-in 0.6s ease-out;
        }

        @keyframes bounce-in {
            0% {
                transform: scale(0.3);
                opacity: 0;
            }

            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }

            70% {
                transform: scale(0.9);
                opacity: 0.9;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .floating {
            animation: floating 3s ease-in-out infinite;
        }

        @keyframes floating {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        /* éŸ³ä¹æ’­æ”¾å™¨æ ·å¼ */
        .music-player {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
        }

        .music-player:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-2px);
        }

        .music-progress {
            background: linear-gradient(90deg, var(--labu) 0%, var(--labu2) 100%);
        }

        .volume-slider {
            background: linear-gradient(90deg, #ddd 0%, var(--labu) 100%);
        }

        /* ç•™è¨€ç³»ç»Ÿæ ·å¼ */
        .comment-bubble {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.9));
            backdrop-filter: blur(5px);
            transform: translateY(10px);
            opacity: 0;
            animation: slideIn 0.3s ease-out forwards;
        }

        @keyframes slideIn {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .comment-reply {
            border-left: 3px solid var(--labu);
            background: rgba(107, 91, 149, 0.05);
        }

        /* è‡ªå®šä¹‰é¼ æ ‡æ ·å¼ */
        * {
            cursor: none !important;
        }

        .custom-cursor {
            position: fixed;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #ff69b4 30%, transparent 70%);
            border: 2px solid #ff69b4;
            border-radius: 50%;
            pointer-events: none;
            z-index: 99999 !important;
            transition: transform 0.1s ease;
            transform: translate(-50%, -50%);
            opacity: 1 !important;
            display: block !important;
            visibility: visible !important;
            box-shadow: 0 0 10px rgba(255, 105, 180, 0.5), 0 0 20px rgba(255, 105, 180, 0.3);
        }

        .custom-cursor.clicking {
            transform: translate(-50%, -50%) scale(1.2);
        }

        .cursor-trail {
            position: fixed;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, rgba(255, 105, 180, 0.8) 0%, rgba(255, 105, 180, 0) 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9998;
            animation: cursorTrailFade 0.5s ease-out forwards;
        }

        @keyframes cursorTrailFade {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            100% {
                opacity: 0;
                transform: scale(0.3);
            }
        }

        /* ä¾§è¾¹äº’åŠ¨åŒºåŸŸ */
        .side-interactive {
            position: fixed;
            top: 0;
            width: 100px;
            height: 100vh;
            z-index: 1;
            pointer-events: none;
        }

        .side-interactive.left {
            left: 0;
            background: linear-gradient(90deg, rgba(107, 91, 149, 0.03) 0%, transparent 100%);
        }

        .side-interactive.right {
            right: 0;
            background: linear-gradient(270deg, rgba(255, 204, 0, 0.03) 0%, transparent 100%);
        }

        .side-particle {
            position: absolute;
            width: 20px;
            height: 20px;
            font-size: 16px;
            opacity: 0;
            pointer-events: none;
            animation: sideParticleFloat 3s ease-out forwards;
        }

        @keyframes sideParticleFloat {
            0% {
                opacity: 0;
                transform: translateY(20px) scale(0.5);
            }

            20% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }

            100% {
                opacity: 0;
                transform: translateY(-100px) scale(0.8) rotate(180deg);
            }
        }

        /* æŒ‰é’®å¢å¼ºæ•ˆæœ */
        .enhanced-btn {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .enhanced-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .enhanced-btn:hover::before {
            left: 100%;
        }

        .enhanced-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(107, 91, 149, 0.3);
        }

        .enhanced-btn:active {
            transform: translateY(0);
        }

        .btn-ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            transform: scale(0);
            animation: rippleEffect 0.6s linear;
            pointer-events: none;
        }

        @keyframes rippleEffect {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* æ»šåŠ¨è§’è‰²åŠ¨ç”» */
        .scroll-character {
            position: fixed;
            font-size: 48px;
            z-index: 10;
            pointer-events: none;
            opacity: 0;
            animation: characterFloat 4s ease-out forwards;
        }

        @keyframes characterFloat {
            0% {
                opacity: 0;
                transform: translateX(-100px) rotate(-10deg);
            }

            20% {
                opacity: 1;
                transform: translateX(0) rotate(0deg);
            }

            80% {
                opacity: 1;
                transform: translateX(20px) rotate(5deg);
            }

            100% {
                opacity: 0;
                transform: translateX(100px) rotate(10deg);
            }
        }

        /* é­”æ³•ç²’å­æ•ˆæœ */
        .magic-particle {
            position: fixed;
            width: 4px;
            height: 4px;
            background: radial-gradient(circle, #ffd700 0%, #ff69b4 50%, transparent 100%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9997;
            animation: magicParticle 2s ease-out forwards;
        }

        @keyframes magicParticle {
            0% {
                opacity: 1;
                transform: scale(0) rotate(0deg);
            }

            50% {
                opacity: 1;
                transform: scale(1) rotate(180deg);
            }

            100% {
                opacity: 0;
                transform: scale(0.2) rotate(360deg) translateY(-50px);
            }
        }

        /* é¡µé¢ä¼˜åŒ–æ ·å¼ */
        .content-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .compact-section {
            padding: 60px 0;
        }

        .hero-compact {
            padding: 80px 0;
        }

        /* å“åº”å¼é—´è·ä¼˜åŒ– */
        @media (max-width: 768px) {
            .compact-section {
                padding: 30px 0;
            }

            .hero-compact {
                padding: 40px 0;
            }

            /* ç§»åŠ¨ç«¯å¯¼èˆªä¼˜åŒ– */
            header .max-w-5xl {
                padding: 0 15px;
            }

            header h1 {
                font-size: 16px;
            }

            nav {
                font-size: 12px;
                gap: 8px;
            }

            nav a {
                padding: 8px 4px;
            }

            /* ç§»åŠ¨ç«¯è‹±é›„åŒºä¼˜åŒ– */
            .content-container {
                padding: 0 15px;
            }

            .hero-compact h2 {
                font-size: 24px;
                line-height: 1.3;
            }

            .hero-compact p {
                font-size: 14px;
                line-height: 1.5;
            }

            /* ç§»åŠ¨ç«¯éŸ³ä¹æ’­æ”¾å™¨ä¼˜åŒ– */
            #musicPlayer {
                bottom: 10px;
                right: 10px;
                width: 280px;
                font-size: 14px;
            }

            .music-player {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            }

            /* ç§»åŠ¨ç«¯æŒ‰é’®ä¼˜åŒ– */
            .enhanced-btn {
                min-height: 44px;
                /* iOSæ¨èè§¦æ‘¸ç›®æ ‡å¤§å° */
                font-size: 14px;
            }

            /* ç§»åŠ¨ç«¯è¡¨å•ä¼˜åŒ– */
            input,
            textarea,
            select {
                min-height: 44px;
                font-size: 16px;
                /* é˜²æ­¢iOSç¼©æ”¾ */
            }

            /* ç§»åŠ¨ç«¯å¡ç‰‡ä¼˜åŒ– */
            .rounded-3xl {
                border-radius: 16px;
            }

            /* ç§»åŠ¨ç«¯é—´è·è°ƒæ•´ */
            .gap-8 {
                gap: 20px;
            }

            .gap-6 {
                gap: 15px;
            }

            .gap-4 {
                gap: 10px;
            }

            /* ç§»åŠ¨ç«¯æ–‡å­—å¤§å°è°ƒæ•´ */
            .text-3xl {
                font-size: 20px;
            }

            .text-2xl {
                font-size: 18px;
            }

            .text-xl {
                font-size: 16px;
            }

            /* ç§»åŠ¨ç«¯å›¾æ ‡è°ƒæ•´ */
            .text-7xl {
                font-size: 48px;
            }

            .text-8xl {
                font-size: 56px;
            }
        }

        /* å°å±å¹•è®¾å¤‡ä¼˜åŒ– */
        @media (max-width: 480px) {
            header h1 {
                font-size: 14px;
            }

            nav {
                font-size: 11px;
                gap: 6px;
            }

            .hero-compact h2 {
                font-size: 20px;
            }

            #musicPlayer {
                width: 250px;
                bottom: 5px;
                right: 5px;
            }

            .enhanced-btn {
                font-size: 13px;
                padding: 12px 16px;
            }
        }

        /* é¡µé¢è¿‡æ¸¡åŠ¨ç”» */
        .page-transition-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(107, 91, 149, 0.9), rgba(255, 204, 0, 0.9));
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .page-transition-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .page-transition-content {
            text-align: center;
            color: white;
            transform: translateY(20px);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .page-transition-overlay.active .page-transition-content {
            transform: translateY(0);
        }

        .transition-loader {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .smooth-link {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .smooth-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .smooth-link:hover::before {
            left: 100%;
        }

        .smooth-link:hover {
            transform: translateY(-1px);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900">
    <!-- é¡µé¢è¿‡æ¸¡åŠ¨ç”»è¦†ç›–å±‚ -->
    <div id="pageTransitionOverlay" class="page-transition-overlay">
        <div class="page-transition-content">
            <div class="transition-loader"></div>
            <h3 class="text-2xl font-bold mb-2">ğŸ§¸ æ­£åœ¨è·³è½¬...</h3>
            <p class="text-lg opacity-90">è¯·ç¨å€™ï¼Œå³å°†ä¸ºæ‚¨åŠ è½½ç²¾å½©å†…å®¹</p>
        </div>
    </div>

    <!-- è‡ªå®šä¹‰é¼ æ ‡å…‰æ ‡ -->
    <div class="custom-cursor"></div>

    <!-- ä¾§è¾¹äº’åŠ¨åŒºåŸŸ -->
    <div class="side-interactive left"></div>
    <div class="side-interactive right"></div>

    <!-- é¡¶éƒ¨æ  -->
    <header class="sticky top-0 z-10 backdrop-blur bg-white/60 border-b border-slate-200">
        <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-xl bg-[var(--labu)] grid place-content-center text-white text-xl sparkle">ğŸ§¸
                </div>
                <h1 class="font-bold text-lg">Labubu_åŸºé‡‘ä¼š Â· VIPè‚¡ä¸œä¸“äº«ç¦åˆ©</h1>
                <div class="hidden sm:flex gap-1">
                    <span class="floating">âœ¨</span>
                    <span class="floating" style="animation-delay: 0.2s;">ğŸ€</span>
                    <span class="floating" style="animation-delay: 0.4s;">ğŸ’«</span>
                </div>
            </div>
            <nav class="text-sm flex items-center gap-4">
                <a href="#draw" class="hover:underline flex items-center gap-1 smooth-link">ğŸ¯ ä¸“äº«æŠ½å¥–</a>
                <a href="#history" class="hover:underline flex items-center gap-1 smooth-link">ğŸ“Š ä¸­å¥–è®°å½•</a>
                <a href="#exchange" class="hover:underline flex items-center gap-1 smooth-link">ğŸ”„ ç§¯åˆ†å…‘æ¢</a>
                <a href="games.html" class="hover:underline flex items-center gap-1 smooth-link page-link">ğŸ® æ¸¸æˆä¸­å¿ƒ</a>
                <a href="achievements.html" class="hover:underline flex items-center gap-1 smooth-link page-link">ğŸ†
                    ä¸ªäººæˆå°±</a>
                <a href="#comments" class="hover:underline flex items-center gap-1 smooth-link">ğŸ’¬ è‚¡ä¸œäº¤æµ</a>
            </nav>
        </div>
    </header>

    <!-- Hero -->
    <section class="labu-gradient hero-compact">
        <div class="content-container px-4 grid md:grid-cols-2 gap-8 items-center">
            <div>
                <h2 class="text-3xl md:text-4xl font-extrabold leading-tight">
                    VIPè‚¡ä¸œä¸“äº«ç¦åˆ©æŠ½å¥–
                    <span class="sparkle">ğŸ’</span>
                </h2>
                <p class="mt-3 text-slate-700">
                    ğŸŒŸ <strong>è‚¡ä¸œä¸“å±æƒç›Š</strong>ï¼šé«˜çº§å¥–å“æ± ï¼Œä¸­å¥–ç‡ç¿»å€ <br />
                    ğŸ’° <strong>è´§å¸å¥–åŠ±</strong>ï¼š1Uå¸ã€3Uå¸ã€5Uå¸ï¼Œç›´æ¥åˆ°è´¦ <br />
                    ğŸ <strong>å®ç‰©ç¦åˆ©</strong>ï¼šé™é‡Labubuã€å¥¶èŒ¶åˆ¸ã€çƒ¤è‚‰åˆ¸ç­‰ <br />
                    âœ¨ <strong>VIPç‰¹æƒ</strong>ï¼šæ¯æ—¥é¢å¤–æŠ½å¥–æœºä¼šï¼Œä¸“äº«å®¢æœæ”¯æŒ
                </p>
                <div class="mt-5 flex flex-wrap gap-3">
                    <a href="#draw"
                        class="enhanced-btn px-6 py-3 rounded-xl bg-[var(--labu)] text-white font-medium shadow flex items-center gap-2">
                        ğŸ’ VIPä¸“äº«æŠ½å¥–
                    </a>
                    <button id="exportCsvBtn"
                        class="enhanced-btn px-6 py-3 rounded-xl bg-gradient-to-r from-yellow-600 to-yellow-500 text-white font-medium shadow flex items-center gap-2">
                        ğŸ“Š å¯¼å‡ºä¸­å¥–è®°å½•
                    </button>
                </div>
                <div class="mt-4 text-sm text-slate-600">
                    <div class="flex flex-wrap gap-3">
                        <span class="flex items-center gap-1 px-3 py-1 bg-yellow-100 rounded-full">ğŸ”® ç¥è¯çº§</span>
                        <span class="flex items-center gap-1 px-3 py-1 bg-red-100 rounded-full">ğŸ† ä¼ è¯´çº§</span>
                        <span class="flex items-center gap-1 px-3 py-1 bg-purple-100 rounded-full">ğŸŒŸ å²è¯—çº§</span>
                        <span class="flex items-center gap-1 px-3 py-1 bg-blue-100 rounded-full">ğŸ’ ç¨€æœ‰çº§</span>
                        <span class="flex items-center gap-1 px-3 py-1 bg-gray-100 rounded-full">ğŸ€ æ™®é€šçº§</span>
                    </div>
                </div>
            </div>
            <div class="relative">
                <div
                    class="aspect-square rounded-3xl bg-white shadow-lg p-6 border border-slate-200 overflow-hidden relative">
                    <div class="h-full w-full grid place-content-center relative z-10">
                        <div class="text-7xl md:text-8xl select-none bounce-in">ğŸ§¸</div>
                        <div class="text-center mt-4 text-sm text-slate-600 flex items-center justify-center gap-2">
                            <span>Labubu ä¸»é¢˜æŠ½å¥–</span>
                            <span class="sparkle">âœ¨</span>
                        </div>
                    </div>
                    <!-- è£…é¥°å…ƒç´  -->
                    <div class="absolute top-4 left-4 text-2xl opacity-60 floating">ğŸ€</div>
                    <div class="absolute top-4 right-4 text-2xl opacity-60 floating" style="animation-delay: 0.5s;">ğŸ’«
                    </div>
                    <div class="absolute bottom-4 left-4 text-2xl opacity-60 floating" style="animation-delay: 1s;">ğŸŒŸ
                    </div>
                    <div class="absolute bottom-4 right-4 text-2xl opacity-60 floating" style="animation-delay: 1.5s;">
                        ğŸ</div>
                    <div class="absolute top-1/2 left-4 text-xl opacity-40 floating" style="animation-delay: 0.8s;">ğŸ¨
                    </div>
                    <div class="absolute top-1/2 right-4 text-xl opacity-40 floating" style="animation-delay: 1.2s;">ğŸª
                    </div>
                </div>
                <div class="absolute -z-10 inset-0 blur-3xl opacity-30"
                    style="background: radial-gradient(600px 200px at 20% 30%, var(--labu), transparent), radial-gradient(500px 200px at 80% 70%, var(--labu2), transparent);">
                </div>
                <!-- å‘¨å›´è£…é¥° -->
                <div class="absolute -top-8 -left-8 text-4xl opacity-20 floating">ğŸ§¸</div>
                <div class="absolute -top-8 -right-8 text-3xl opacity-25 floating" style="animation-delay: 0.3s;">ğŸˆ
                </div>
                <div class="absolute -bottom-8 -left-8 text-3xl opacity-20 floating" style="animation-delay: 0.7s;">ğŸ­
                </div>
                <div class="absolute -bottom-8 -right-8 text-4xl opacity-25 floating" style="animation-delay: 1.1s;">ğŸ¯
                </div>
            </div>
        </div>
    </section>

    <!-- æŠ½å¥–å¡ç‰‡ -->
    <main id="draw" class="content-container px-4 compact-section">
        <div class="grid md:grid-cols-5 gap-6 items-start">
            <section class="md:col-span-3">
                <div class="rounded-3xl bg-white border border-slate-200 shadow">
                    <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                        <h3 class="font-semibold">æŠ½å¥–é¢æ¿</h3>
                        <div class="text-xs text-slate-500">
                            <div>æœ¬åœ°æ—¶é—´ï¼š<span id="now"></span></div>
                            <div id="drawLimitInfo" class="mt-1">å‰©ä½™æŠ½å¥–æ¬¡æ•°ï¼š<span id="remainingDraws">â€”</span></div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="grid gap-4">
                            <div class="rounded-2xl border border-dashed border-slate-300 p-6 text-center">
                                <div class="text-sm text-slate-600">
                                    <span id="drawModeIndicator">ç‚¹å‡»æŒ‰é’®å¼€å§‹æŠ½å¥–</span>
                                </div>
                                <div id="resultDisplay" class="text-3xl font-extrabold mt-2">â€”</div>
                                <div id="resultMeta" class="text-xs text-slate-500 mt-1">â€”</div>
                                <div id="trialNotice" class="text-xs text-orange-600 mt-2 hidden">
                                    ğŸ¯ è¿™æ˜¯è¯•æŠ½ç»“æœï¼Œä¸ä¼šæ¶ˆè€—åº“å­˜æˆ–è®¡å…¥è®°å½•
                                </div>
                            </div>
                            <div class="flex gap-3 flex-wrap">
                                <button id="drawBtn"
                                    class="enhanced-btn px-5 py-3 rounded-2xl bg-[var(--labu)] text-white font-semibold shadow">æ­£å¼æŠ½å¥–</button>
                                <button id="trialDrawBtn"
                                    class="enhanced-btn px-5 py-3 rounded-2xl bg-slate-100 text-slate-800 font-medium border border-slate-200">è¯•æŠ½ä½“éªŒ</button>
                            </div>
                            <div class="text-xs text-slate-500">
                                <div>è¯´æ˜ï¼šæ­£å¼æŠ½å¥–ä¼šæ ¹æ®å¥–æ± æƒé‡ä¸åº“å­˜è¿›è¡Œï¼Œå®ä½“ç¤¼å“ä¼šæ‰£å‡åº“å­˜ï¼›åˆ¸ç ä¼šè‡ªåŠ¨ç”Ÿæˆå¹¶æ˜¾ç¤ºã€‚</div>
                                <div class="mt-1">è¯•æŠ½ä½“éªŒï¼šä»…ä¾›ä½“éªŒæ¦‚ç‡åˆ†å¸ƒï¼Œä¸æ¶ˆè€—åº“å­˜ã€ä¸è®¡å…¥è®°å½•ã€ä¸å½±å“æŠ½å¥–æ¬¡æ•°ã€‚</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- å¥–æ± æ¦‚è§ˆ -->
            <aside class="md:col-span-2">
                <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
                    <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                        <h3 class="font-semibold">å½“å‰å¥–æ± </h3>
                    </div>
                    <div class="p-5">
                        <ul id="poolList" class="text-sm grid gap-2"></ul>
                    </div>
                </div>
            </aside>
        </div>

        <!-- å†å²è®°å½• -->
        <section id="history" class="mt-10">
            <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
                <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                    <h3 class="font-semibold">æŠ½å¥–ç»“æœï¼ˆè‡ªåŠ¨æ ‡è®°æ—¶é—´ï¼‰</h3>
                    <div class="flex gap-2">
                        <button id="exportJsonBtn"
                            class="text-xs px-2 py-1 rounded-lg bg-slate-100 border border-slate-200">å¯¼å‡º JSON</button>
                    </div>
                </div>
                <div class="p-5 overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="text-left text-slate-500">
                            <tr>
                                <th class="py-2 pr-4">æ—¶é—´</th>
                                <th class="py-2 pr-4">å¥–å“</th>
                                <th class="py-2 pr-4">ç±»å‹</th>
                                <th class="py-2 pr-4">åˆ¸ç /å¤‡æ³¨</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody" class="align-top"></tbody>
                    </table>
                </div>
            </div>
        </section>


    </main>

    <!-- ç§¯åˆ†å…‘æ¢ç³»ç»Ÿ -->
    <section id="exchange" class="content-container px-4 compact-section">
        <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
            <div class="p-5 border-b border-slate-100">
                <h3 class="font-semibold flex items-center gap-2 mb-2">
                    ğŸ”„ VIPç§¯åˆ†å…‘æ¢ä¸­å¿ƒ
                    <span class="text-xs text-slate-500">ï¼ˆå¤šåªLabubuå…‘æ¢ç¥è¯å¤§å¥–ï¼‰</span>
                </h3>
                <div class="flex items-center justify-between text-sm">
                    <div class="flex items-center gap-4">
                        <span class="text-slate-600">å½“å‰ç§¯åˆ†: <span id="userPoints"
                                class="font-bold text-[var(--labu)]">0</span></span>
                        <span class="text-slate-600">å¯å…‘æ¢: <span id="exchangeableItems"
                                class="font-bold text-green-600">0</span> ä»¶</span>
                    </div>
                    <button id="calculatePointsBtn"
                        class="enhanced-btn px-4 py-2 bg-[var(--labu)] text-white rounded-lg text-sm">
                        ğŸ“Š è®¡ç®—æŒæœ‰ç§¯åˆ†
                    </button>
                </div>
            </div>

            <div class="p-5">
                <!-- å…‘æ¢å•†å“å±•ç¤º -->
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6" id="exchangeItems">
                    <!-- å…‘æ¢å•†å“å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                </div>

                <!-- æˆ‘çš„æ”¶è— -->
                <div class="border-t pt-5">
                    <h4 class="font-medium mb-3 flex items-center gap-2">
                        ğŸ§¸ æˆ‘çš„Labubuæ”¶è—
                        <span class="text-xs text-slate-500">ï¼ˆå¯ç”¨äºå…‘æ¢ç§¯åˆ†ï¼‰</span>
                    </h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3" id="myCollection">
                        <!-- æ”¶è—å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ç•™è¨€ç³»ç»Ÿ -->
    <section id="comments" class="content-container px-4 compact-section">
        <div class="rounded-3xl bg-white border border-slate-200 shadow overflow-hidden">
            <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                <h3 class="font-semibold flex items-center gap-2">
                    ğŸ’¬ ç•™è¨€æ¿
                    <span class="text-xs text-slate-500">ï¼ˆå¤šç”¨æˆ·å®æ—¶å…±äº«ï¼‰</span>
                </h3>
                <div class="text-xs text-slate-500">å®æ—¶åŒæ­¥ä¸­ <span class="sparkle">âœ¨</span></div>
            </div>
            <div class="p-5">
                <!-- å‘è¡¨ç•™è¨€ -->
                <div class="mb-6">
                    <div class="flex gap-3 mb-3">
                        <input type="text" id="userName" placeholder="æ‚¨çš„æ˜µç§°"
                            class="px-3 py-2 rounded-lg border border-slate-300 text-sm focus:border-[var(--labu)] focus:outline-none">
                        <div class="flex-1"></div>
                    </div>
                    <textarea id="commentInput" rows="3" placeholder="è¯´ç‚¹ä»€ä¹ˆå§... ğŸ¯"
                        class="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm focus:border-[var(--labu)] focus:outline-none resize-none"></textarea>
                    <div class="flex justify-between items-center mt-3">
                        <div class="text-xs text-slate-500">
                            <span id="commentCount">0</span> æ¡ç•™è¨€
                        </div>
                        <button id="submitComment"
                            class="enhanced-btn px-4 py-2 rounded-lg bg-[var(--labu)] text-white text-sm font-medium">
                            ğŸ’¬ å‘è¡¨ç•™è¨€
                        </button>
                    </div>
                </div>

                <!-- ç•™è¨€åˆ—è¡¨ -->
                <div id="commentsList" class="space-y-4">
                    <div class="text-center text-slate-400 py-8">
                        <div class="text-4xl mb-2">ğŸ’­</div>
                        <div>æš‚æ— ç•™è¨€ï¼Œå¿«æ¥è¯´ç‚¹ä»€ä¹ˆå§ï¼</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- éŸ³ä¹æ’­æ”¾å™¨ -->
    <div id="musicPlayer" class="fixed bottom-6 right-6 z-40 music-player transition-all duration-300 ease-in-out">
        <!-- å°æŒ‰é’®çŠ¶æ€ï¼ˆé»˜è®¤æ˜¾ç¤ºï¼‰ -->
        <div id="musicPlayerMini"
            class="w-14 h-14 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full shadow-lg cursor-pointer flex items-center justify-center hover:scale-110 transition-transform duration-200">
            <div class="text-white text-xl animate-pulse" id="miniMusicIcon">ğŸµ</div>
        </div>

        <!-- å®Œæ•´æ’­æ”¾å™¨ï¼ˆé»˜è®¤éšè—ï¼‰ -->
        <div id="musicPlayerFull"
            class="hidden w-80 bg-white/95 backdrop-blur-md rounded-2xl shadow-xl border border-white/20 p-4">
            <!-- æ ‡é¢˜æ  -->
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                    <span class="text-lg">ğŸµ</span>
                    <span class="font-medium text-sm">éŸ³ä¹æ’­æ”¾å™¨</span>
                </div>
                <button id="closePlayer" class="text-slate-400 hover:text-slate-600 text-xl">âœ•</button>
            </div>

            <!-- å½“å‰æ’­æ”¾ä¿¡æ¯ -->
            <div class="text-center mb-4">
                <div id="currentSong" class="font-medium text-sm text-slate-800 truncate">å‡†å¤‡æ’­æ”¾éŸ³ä¹</div>
                <div id="currentArtist" class="text-xs text-slate-500 truncate">é€‰æ‹©ä¸€é¦–æ­Œå¼€å§‹æ’­æ”¾</div>
            </div>

            <!-- è¿›åº¦æ¡ -->
            <div class="space-y-2 mb-4">
                <div class="flex justify-between text-xs text-slate-500">
                    <span id="currentTime">0:00</span>
                    <span id="totalTime">0:00</span>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-1.5 cursor-pointer" id="progressContainer">
                    <div id="progressBar" class="music-progress h-1.5 rounded-full w-0 transition-all"></div>
                </div>
            </div>

            <!-- æ§åˆ¶æŒ‰é’® -->
            <div class="flex items-center justify-center gap-6 mb-4">
                <button id="prevBtn" class="text-2xl hover:scale-110 transition-transform duration-200">â®ï¸</button>
                <button id="playPauseBtn"
                    class="text-2xl hover:scale-110 transition-transform duration-200 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg">â–¶ï¸</button>
                <button id="nextBtn" class="text-2xl hover:scale-110 transition-transform duration-200">â­ï¸</button>
            </div>

            <!-- éŸ³é‡æ§åˆ¶ -->
            <div class="flex items-center gap-3 mb-4">
                <span class="text-sm">ğŸ”Š</span>
                <input type="range" id="volumeSlider" min="0" max="100" value="50"
                    class="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
            </div>

            <!-- æ’­æ”¾åˆ—è¡¨ -->
            <div class="max-h-32 overflow-y-auto">
                <div class="text-xs text-slate-500 mb-2 font-medium">æ’­æ”¾åˆ—è¡¨</div>
                <div id="playlist" class="space-y-1"></div>
            </div>
        </div>
    </div>

    <footer class="max-w-5xl mx-auto px-4 py-10 text-center text-xs text-slate-500">
        <div>Â© <span id="year"></span> LabubuåŸºé‡‘ä¼šæŠ½å¥–ï¼ˆæœ€ç»ˆè§£é‡Šæƒå½’æœ¬åŸºé‡‘ä¼šæ‰€æœ‰ï¼‰</div>
        <div class="mt-2">
            <a href="admin.html" class="text-slate-400 hover:text-slate-600 hover:underline transition-colors">ç³»ç»Ÿç®¡ç†</a>
        </div>
    </footer>

    <script>
        // â€”â€” æœ¬åœ°å­˜å‚¨é”® â€”â€”
        const LS_KEYS = {
            HISTORY: 'labubu_lottery_history',
            POOL: 'labubu_lottery_pool',
            DRAW_LIMIT: 'labubu_draw_limit',
            USER_DRAW_COUNT: 'labubu_user_draw_count'
        };

        // â€”â€” æ•°æ®åŒæ­¥é€šé“ â€”â€”
        let dataChannel = null;
        let lastPoolUpdate = Date.now();
        let lastLimitUpdate = Date.now();
        let syncEnabled = false;

        // æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
        if ('BroadcastChannel' in window) {
            try {
                dataChannel = new BroadcastChannel('labubu_data_sync');
                syncEnabled = true;
            } catch (error) {
                console.warn('BroadcastChannelåˆå§‹åŒ–å¤±è´¥:', error);
                syncEnabled = false;
            }
        } else {
            console.warn('æµè§ˆå™¨ä¸æ”¯æŒBroadcastChannelï¼Œå®æ—¶åŒæ­¥åŠŸèƒ½å°†ä¸å¯ç”¨');
            syncEnabled = false;
        }

        // â€”â€” VIPä¸“äº«å¥–æ±  (å«è¶…ç¨€æœ‰ä¸Šè¿ªæŒ‚ä»¶) â€”â€”
        const DEFAULT_POOL = [
            // æ™®é€šå¥–å“
            { name: "å†æ¥å†å‰", type: 'æŠ˜æ‰£åˆ¸', weight: 30, quantity: 50, rarity: 'common', points: 10, emoji: "ğŸ’ª" },
            { name: "å¥¶èŒ¶ä¸€æ¯", type: 'å®ä½“', weight: 25, quantity: 30, rarity: 'common', points: 20, emoji: "ğŸ§‹" },
            { name: "çƒ¤è‚‰åˆ¸ï¼ˆæ¸…çœŸè®°å½•ï¼‰", type: 'å®ä½“', weight: 20, quantity: 25, rarity: 'common', points: 30, emoji: "ğŸ¥©" },
            { name: "çƒ¤è‚‰åˆ¸", type: 'å®ä½“', weight: 20, quantity: 20, rarity: 'common', points: 30, emoji: "ğŸ–" },
            { name: "ç²¾å“å¥¶èŒ¶åˆ¸", type: 'å®ä½“', weight: 15, quantity: 15, rarity: 'rare', points: 50, emoji: "ğŸ§ƒ" },
            { name: "1Uå¸", type: 'å®ä½“', weight: 25, quantity: 100, rarity: 'common', points: 1, emoji: "ğŸ’°" },
            { name: "3Uå¸", type: 'å®ä½“', weight: 15, quantity: 60, rarity: 'common', points: 3, emoji: "ğŸ’µ" },
            { name: "5Uå¸", type: 'å®ä½“', weight: 10, quantity: 40, rarity: 'rare', points: 5, emoji: "ğŸ’¸" },

            // Labubuç³»åˆ—æ”¶è—
            { name: "ç»å…¸Labubuå…¬ä»”", type: 'å®ä½“', weight: 8, quantity: 10, rarity: 'rare', points: 100, image: "images/prizes/labubu/classic.jpg", emoji: "ğŸ§¸" },
            { name: "å½©è™¹Labubué™å®š", type: 'å®ä½“', weight: 6, quantity: 8, rarity: 'epic', points: 150, image: "images/prizes/labubu/rainbow.jpg", emoji: "ğŸŒˆ" },
            { name: "ä¸‡åœ£èŠ‚Labubuç‰¹åˆ«ç‰ˆ", type: 'å®ä½“', weight: 4, quantity: 5, rarity: 'epic', points: 200, image: "images/prizes/labubu/halloween.jpg", emoji: "ğŸƒ" },
            { name: "é»„é‡‘Labubuæ”¶è—ç‰ˆ", type: 'å®ä½“', weight: 2, quantity: 3, rarity: 'legendary', points: 500, image: "images/prizes/labubu/gold.jpg", emoji: "ğŸ‘‘" },

            // Cookie Annè¿ªå£«å°¼ç³»åˆ—
            { name: "ç”œå¿ƒCookie Annå…¬ä»”", type: 'å®ä½“', weight: 7, quantity: 8, rarity: 'rare', points: 120, image: "images/prizes/cookie-ann/sweet.jpg", emoji: "ğŸª" },
            { name: "å…¬ä¸»Cookie Anné™å®š", type: 'å®ä½“', weight: 5, quantity: 6, rarity: 'epic', points: 180, image: "images/prizes/cookie-ann/princess.jpg", emoji: "ğŸ‘¸" },
            { name: "åœ£è¯Cookie Annç‰¹åˆ«ç‰ˆ", type: 'å®ä½“', weight: 3, quantity: 4, rarity: 'epic', points: 220, image: "images/prizes/cookie-ann/christmas.jpg", emoji: "ğŸ„" },
            { name: "çƒ˜ç„™å¤§å¸ˆCookie Ann", type: 'å®ä½“', weight: 1.5, quantity: 2, rarity: 'legendary', points: 600, image: "images/prizes/cookie-ann/baker.jpg", emoji: "ğŸ‘©â€ğŸ³" },

            // Pop Martæ½®ç©ç³»åˆ—
            { name: "Mollyç»å…¸æ¬¾", type: 'å®ä½“', weight: 6, quantity: 7, rarity: 'rare', points: 110, image: "images/prizes/popmart/molly-classic.jpg", emoji: "ğŸ‘§" },
            { name: "Dimooäº‘æœµç³»åˆ—", type: 'å®ä½“', weight: 4, quantity: 5, rarity: 'epic', points: 160, image: "images/prizes/popmart/dimoo-cloud.jpg", emoji: "â˜ï¸" },
            { name: "Skullpandaéª·é«…ç†ŠçŒ«", type: 'å®ä½“', weight: 2.5, quantity: 3, rarity: 'legendary', points: 450, image: "images/prizes/popmart/skullpanda.jpg", emoji: "ğŸ¼" },

            // è¶…ç¨€æœ‰ç‰¹åˆ«ç‰ˆæŒ‚ä»¶ - ä¸­å¥–ç‡æä½ (å‡ ä¹ä¸º0)
            { name: "é™å®šLabubuä¸‡åœ£èŠ‚æŒ‚ä»¶", type: 'å®ä½“', weight: 0.1, quantity: 1, rarity: 'mythic', points: 2000, image: "images/prizes/labubu/halloween-special.jpg", emoji: "ğŸƒ" },
            { name: "é™å®šCookie Annåœ£è¯æŒ‚ä»¶", type: 'å®ä½“', weight: 0.1, quantity: 1, rarity: 'mythic', points: 2000, image: "images/prizes/cookie-ann/christmas-special.jpg", emoji: "ğŸ„" },
            { name: "é™å®šMollyå¤æ—¥æµ·æ´‹æŒ‚ä»¶", type: 'å®ä½“', weight: 0.05, quantity: 1, rarity: 'mythic', points: 3000, image: "images/prizes/popmart/molly-ocean-special.jpg", emoji: "ğŸŒŠ" }
        ];

        // â€”â€” å·¥å…·å‡½æ•° â€”â€”
        const $ = (sel) => document.querySelector(sel);
        const $$ = (sel) => Array.from(document.querySelectorAll(sel));
        const nowStr = () => new Date().toLocaleString();
        const uid = (n = 8) => Math.random().toString(36).slice(2, 2 + n).toUpperCase();

        // â€”â€” é¡µé¢è¿‡æ¸¡åŠ¨ç”»åŠŸèƒ½ â€”â€”
        function initPageTransitions() {
            // ä¸ºæ‰€æœ‰é¡µé¢é“¾æ¥æ·»åŠ è¿‡æ¸¡æ•ˆæœ
            $$('.page-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const href = link.getAttribute('href');
                    showPageTransition(() => {
                        window.location.href = href;
                    });
                });
            });

            // ä¸ºå…¶ä»–å¤–éƒ¨é“¾æ¥ä¹Ÿæ·»åŠ è¿‡æ¸¡æ•ˆæœ
            $$('a[href$=".html"]').forEach(link => {
                if (!link.classList.contains('page-link')) {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const href = link.getAttribute('href');
                        showPageTransition(() => {
                            window.location.href = href;
                        });
                    });
                }
            });
        }

        function showPageTransition(callback) {
            const overlay = $('#pageTransitionOverlay');
            overlay.classList.add('active');

            // éšæœºæ˜¾ç¤ºä¸åŒçš„åŠ è½½æ–‡æ¡ˆ
            const loadingTexts = [
                { title: 'ğŸ§¸ æ­£åœ¨è·³è½¬...', subtitle: 'è¯·ç¨å€™ï¼Œå³å°†ä¸ºæ‚¨åŠ è½½ç²¾å½©å†…å®¹' },
                { title: 'âœ¨ åŠ è½½ä¸­...', subtitle: 'æ­£åœ¨ä¸ºVIPè‚¡ä¸œå‡†å¤‡ä¸“å±ä½“éªŒ' },
                { title: 'ğŸ¯ å³å°†åˆ°è¾¾...', subtitle: 'æ‚¨çš„ä¸“äº«åŠŸèƒ½æ­£åœ¨è·¯ä¸Š' },
                { title: 'ğŸ’ ç¨ç­‰ç‰‡åˆ»...', subtitle: 'æ­£åœ¨å±•å¼€æ‚¨çš„ä¸ªäººæˆå°±æ®¿å ‚' }
            ];

            const randomText = loadingTexts[Math.floor(Math.random() * loadingTexts.length)];
            overlay.querySelector('h3').textContent = randomText.title;
            overlay.querySelector('p').textContent = randomText.subtitle;

            // å»¶è¿Ÿæ‰§è¡Œè·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°è¿‡æ¸¡åŠ¨ç”»
            setTimeout(() => {
                if (callback) callback();
            }, 800);
        }

        function hidePageTransition() {
            const overlay = $('#pageTransitionOverlay');
            overlay.classList.remove('active');
        }

        // é¡µé¢åŠ è½½æ—¶éšè—è¿‡æ¸¡å±‚
        window.addEventListener('load', () => {
            setTimeout(hidePageTransition, 300);
        });

        // â€”â€” ç¨€æœ‰åº¦é…ç½® â€”â€”
        function getPrizeRarity(prizeName, weight) {
            // ä¼ è¯´çº§ï¼ˆæƒé‡ â‰¤ 2ï¼Œæˆ–ç‰¹å®šå¥–å“ï¼‰
            if (weight <= 2 || prizeName.includes('é™é‡') || prizeName.includes('5Uå¸')) {
                return 'legendary';
            }
            // ç¨€æœ‰çº§ï¼ˆæƒé‡ â‰¤ 6ï¼‰
            if (weight <= 6 || prizeName.includes('3Uå¸') || prizeName.includes('ç²¾å“')) {
                return 'rare';
            }
            // æ™®é€šçº§
            return 'common';
        }

        function getRarityConfig(rarity) {
            const configs = {
                legendary: {
                    animation: 'spin-legendary',
                    duration: 2000,
                    bgColor: 'from-yellow-400 to-orange-500',
                    textColor: 'text-yellow-100',
                    icon: 'ğŸ†',
                    message: 'æ­å–œè·å¾—ä¼ è¯´çº§å¥–å“ï¼',
                    particles: 'âœ¨ğŸ’«â­ğŸŒŸğŸ’',
                    sound: 'legendary'
                },
                rare: {
                    animation: 'spin-rare',
                    duration: 1800,
                    bgColor: 'from-purple-400 to-pink-500',
                    textColor: 'text-purple-100',
                    icon: 'ğŸ’',
                    message: 'è·å¾—ç¨€æœ‰å¥–å“ï¼',
                    particles: 'ğŸ’œğŸ’«ğŸ”®âœ¨ğŸ€',
                    sound: 'rare'
                },
                common: {
                    animation: 'spin-common',
                    duration: 1200,
                    bgColor: 'from-blue-400 to-green-500',
                    textColor: 'text-blue-100',
                    icon: 'ğŸ',
                    message: 'è·å¾—å¥–å“ï¼',
                    particles: 'ğŸ€ğŸ’™ğŸ’šâœ¨ğŸ',
                    sound: 'common'
                }
            };
            return configs[rarity] || configs.common;
        }

        function showRarityEffect(rarity, config) {
            // åˆ›å»ºå…¨å±ç¨€æœ‰åº¦æç¤º
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 z-50 flex items-center justify-center pointer-events-none';
            overlay.style.background = `linear-gradient(135deg, rgba(0,0,0,0.4), rgba(0,0,0,0.6))`;

            const effectContainer = document.createElement('div');
            effectContainer.className = `text-center bounce-in`;
            effectContainer.innerHTML = `
                <div class="text-6xl mb-4 sparkle">${config.icon}</div>
                <div class="text-2xl font-bold text-white mb-2">${config.message}</div>
                <div class="text-lg text-gray-200">è·å¾—äº†ç‰¹æ®Šå¥–å“ï¼</div>
            `;

            overlay.appendChild(effectContainer);
            document.body.appendChild(overlay);

            // åˆ›å»ºç²’å­æ•ˆæœ
            createParticleEffect(config.particles);

            // 2ç§’åç§»é™¤æ•ˆæœ
            setTimeout(() => {
                overlay.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(overlay)) {
                        document.body.removeChild(overlay);
                    }
                }, 300);
            }, 2000);
        }

        function createParticleEffect(particles) {
            const particleArray = particles.split('');
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.textContent = particleArray[Math.floor(Math.random() * particleArray.length)];
                    particle.className = 'fixed text-2xl pointer-events-none z-40';
                    particle.style.left = Math.random() * window.innerWidth + 'px';
                    particle.style.top = Math.random() * window.innerHeight + 'px';
                    particle.style.animation = 'sparkle 2s ease-out forwards';

                    document.body.appendChild(particle);

                    setTimeout(() => {
                        if (document.body.contains(particle)) {
                            document.body.removeChild(particle);
                        }
                    }, 2000);
                }, i * 100);
            }
        }

        function loadHistory() {
            try { return JSON.parse(localStorage.getItem(LS_KEYS.HISTORY)) || []; } catch { return []; }
        }
        function saveHistory(arr) { localStorage.setItem(LS_KEYS.HISTORY, JSON.stringify(arr)); }
        function loadPool() {
            try {
                const raw = localStorage.getItem(LS_KEYS.POOL);
                return raw ? JSON.parse(raw) : structuredClone(DEFAULT_POOL);
            } catch { return structuredClone(DEFAULT_POOL); }
        }
        function savePool(pool) { localStorage.setItem(LS_KEYS.POOL, JSON.stringify(pool)); }

        function poolToText(pool) {
            return pool.map(p => [p.name, p.type, p.weight, (p.quantity ?? -1)].join(',')).join('\n');
        }
        function textToPool(txt) {
            const lines = txt.split(/\n+/).map(l => l.trim()).filter(Boolean);

            if (lines.length === 0) {
                throw new Error('å¥–æ± ä¸èƒ½ä¸ºç©º');
            }

            if (lines.length > 100) {
                throw new Error('å¥–æ± é¡¹ç›®ä¸èƒ½è¶…è¿‡100ä¸ª');
            }

            return lines.map((line, i) => {
                const parts = line.split(',').map(s => s?.trim());

                if (parts.length < 3 || parts.length > 4) {
                    throw new Error(`ç¬¬ ${i + 1} è¡Œæ ¼å¼ä¸æ­£ç¡®ï¼šåº”ä¸º name,type,weight[,quantity]`);
                }

                const [name, type, weightStr, qtyStr] = parts;

                // åç§°éªŒè¯
                if (!name || name.length > 50) {
                    throw new Error(`ç¬¬ ${i + 1} è¡Œï¼šå¥–å“åç§°ä¸èƒ½ä¸ºç©ºä¸”ä¸èƒ½è¶…è¿‡50å­—ç¬¦`);
                }

                // ç±»å‹éªŒè¯
                if (!['æŠµæ‰£åˆ¸', 'å®ä½“', 'æŠ˜æ‰£åˆ¸'].includes(type)) {
                    throw new Error(`ç¬¬ ${i + 1} è¡Œï¼šå¥–å“ç±»å‹åªèƒ½æ˜¯ æŠµæ‰£åˆ¸/å®ä½“/æŠ˜æ‰£åˆ¸`);
                }

                // æƒé‡éªŒè¯
                const weight = Number(weightStr);
                if (!Number.isFinite(weight) || weight < 0 || weight > 10000) {
                    throw new Error(`ç¬¬ ${i + 1} è¡Œï¼šæƒé‡å¿…é¡»æ˜¯0-10000ä¹‹é—´çš„æ•°å­—`);
                }

                // æ•°é‡éªŒè¯
                let quantity = -1;
                if (qtyStr !== undefined && qtyStr !== '') {
                    quantity = Number(qtyStr);
                    if (!Number.isInteger(quantity) || quantity < -1 || quantity > 99999) {
                        throw new Error(`ç¬¬ ${i + 1} è¡Œï¼šæ•°é‡å¿…é¡»æ˜¯-1åˆ°99999ä¹‹é—´çš„æ•´æ•°`);
                    }
                }

                return { name, type, weight, quantity };
            });
        }

        function renderPoolList(pool) {
            const ul = $('#poolList');
            ul.innerHTML = '';
            const totalW = pool.reduce((s, p) => s + Math.max(0, p.weight || 0), 0) || 1;
            pool.forEach(p => {
                const left = p.quantity === -1 ? 'âˆ' : p.quantity;
                const w = p.weight || 0;
                const pct = ((w / totalW) * 100).toFixed(1);
                const color = p.type === 'å®ä½“' ? 'bg-emerald-50 text-emerald-700 border-emerald-200' : (p.type === 'æŠµæ‰£åˆ¸' ? 'bg-indigo-50 text-indigo-700 border-indigo-200' : 'bg-amber-50 text-amber-700 border-amber-200');
                const li = document.createElement('li');
                li.className = `border rounded-xl p-3 flex items-center justify-between ${color}`;
                li.innerHTML = `<div class="font-medium">${p.name} <span class="ml-2 text-xs px-2 py-0.5 rounded-lg bg-white/60 border">${p.type}</span></div>
                        <div class="text-xs">æƒé‡ ${w}ï¼ˆâ‰ˆ${pct}%ï¼‰ Â· å‰©ä½™ <b>${left}</b></div>`;
                ul.appendChild(li);
            });
        }

        function renderHistory() {
            const tb = $('#historyBody');
            tb.innerHTML = '';
            const hist = loadHistory();
            if (hist.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="py-3 text-slate-400" colspan="4">æš‚æ— è®°å½•</td>`;
                tb.appendChild(tr);
                return;
            }
            hist.slice().reverse().forEach(r => {
                const tr = document.createElement('tr');
                tr.className = 'border-t';
                tr.innerHTML = `<td class="py-3 pr-4 whitespace-nowrap">${r.time}</td>
                        <td class="py-3 pr-4">${r.prize}</td>
                        <td class="py-3 pr-4">${r.type}</td>
                        <td class="py-3 pr-4 text-slate-600 break-all">${r.code || r.note || ''}</td>`;
                tb.appendChild(tr);
            });
        }

        function weightedPick(pool) {
            const candidates = pool.filter(p => (p.quantity === -1 || p.quantity > 0) && (p.weight || 0) > 0);
            const sum = candidates.reduce((s, p) => s + p.weight, 0);
            if (sum <= 0 || candidates.length === 0) return null;
            let r = Math.random() * sum;
            for (const item of candidates) {
                if ((r -= item.weight) <= 0) return item;
            }
            return candidates[candidates.length - 1];
        }

        function onDraw() {
            uiSounds.playClickSound();
            performDraw(false); // æ­£å¼æŠ½å¥–
        }

        function onTrialDraw() {
            uiSounds.playClickSound();
            performDraw(true); // è¯•æŠ½ä½“éªŒ
        }

        function performDraw(isTrial = false) {
            const btn = isTrial ? $('#trialDrawBtn') : $('#drawBtn');
            const drawModeIndicator = $('#drawModeIndicator');
            const trialNotice = $('#trialNotice');

            // æ’­æ”¾æŠ½å¥–éŸ³æ•ˆ
            uiSounds.playDrawSound();

            btn.disabled = true; btn.classList.add('opacity-60');

            // æ›´æ–°æ¨¡å¼æŒ‡ç¤ºå™¨
            if (isTrial) {
                drawModeIndicator.textContent = 'è¯•æŠ½ä½“éªŒæ¨¡å¼';
                trialNotice.classList.remove('hidden');
            } else {
                drawModeIndicator.textContent = 'æ­£å¼æŠ½å¥–æ¨¡å¼';
                trialNotice.classList.add('hidden');

                // åªæœ‰æ­£å¼æŠ½å¥–æ‰æ£€æŸ¥æ¬¡æ•°é™åˆ¶
                if (!canDraw()) {
                    const display = $('#resultDisplay');
                    const meta = $('#resultMeta');
                    display.textContent = 'æŠ½å¥–æ¬¡æ•°å·²ç”¨å®Œ';
                    meta.textContent = 'ä»Šæ—¥æŠ½å¥–æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼Œè¯·æ˜æ—¥å†æ¥';
                    btn.disabled = false; btn.classList.remove('opacity-60');
                    return;
                }
            }

            const pool = loadPool();
            const picked = weightedPick(pool);
            const display = $('#resultDisplay');
            const meta = $('#resultMeta');

            if (!picked) {
                display.textContent = 'å¥–æ± ä¸ºç©ºæˆ–åº“å­˜ä¸è¶³';
                meta.textContent = isTrial ? 'è¯•æŠ½æ— æ³•è¿›è¡Œï¼Œè¯·è”ç³»ç®¡ç†å‘˜' : 'è¯·è”ç³»ç®¡ç†å‘˜æ£€æŸ¥å¥–æ± è®¾ç½®';
                btn.disabled = false; btn.classList.remove('opacity-60');
                return;
            }

            // è·å–ç¨€æœ‰åº¦å¹¶åº”ç”¨å¯¹åº”åŠ¨æ•ˆ
            const rarity = getPrizeRarity(picked.name, picked.weight);
            const rarityConfig = getRarityConfig(rarity);

            // ç§»é™¤æ‰€æœ‰å¯èƒ½çš„åŠ¨ç”»ç±»
            display.parentElement.classList.remove('spin', 'spin-legendary', 'spin-rare', 'spin-common');

            // åº”ç”¨å¯¹åº”ç¨€æœ‰åº¦çš„åŠ¨ç”»
            display.parentElement.classList.add(rarityConfig.animation);

            // åˆ›å»ºç¨€æœ‰åº¦æç¤ºæ•ˆæœ
            if (!isTrial) {
                showRarityEffect(rarity, rarityConfig);
            }

            setTimeout(() => {
                display.parentElement.classList.remove(rarityConfig.animation);
            }, rarityConfig.duration);

            // ç”Ÿæˆåˆ¸ç ï¼ˆä»…åˆ¸ç±»ï¼Œè¯•æŠ½æ—¶æ˜¾ç¤ºæ¨¡æ‹Ÿåˆ¸ç ï¼‰
            let code = '';
            if (picked.type === 'æŠµæ‰£åˆ¸' || picked.type === 'æŠ˜æ‰£åˆ¸') {
                if (isTrial) {
                    code = `${picked.type === 'æŠµæ‰£åˆ¸' ? 'DK' : 'ZK'}-DEMO-${uid(4)}`; // è¯•æŠ½æ˜¾ç¤ºDEMOåˆ¸ç 
                } else {
                    code = `${picked.type === 'æŠµæ‰£åˆ¸' ? 'DK' : 'ZK'}-${uid(4)}-${uid(4)}`;
                }
            }

            // åªæœ‰æ­£å¼æŠ½å¥–æ‰æ‰£å‡åº“å­˜
            if (!isTrial && picked.quantity > 0) {
                picked.quantity -= 1;
                savePool(pool);
                renderPoolList(pool);
            }

            const record = {
                time: nowStr(),
                prize: picked.name,
                type: picked.type,
                code: code || undefined,
                note: picked.note || ''
            };

            // åªæœ‰æ­£å¼æŠ½å¥–æ‰ä¿å­˜è®°å½•å’Œå¢åŠ è®¡æ•°
            if (!isTrial) {
                const hist = loadHistory();
                hist.push(record);
                saveHistory(hist);

                // å¢åŠ ç”¨æˆ·æŠ½å¥–æ¬¡æ•°è®¡æ•°
                const userCount = loadUserDrawCount();
                saveUserDrawCount(userCount + 1);
                updateDrawLimitDisplay();
                renderHistory();
            }

            // æ’­æ”¾ä¸­å¥–éŸ³æ•ˆ
            setTimeout(() => {
                uiSounds.playWinSound();
            }, 1000);

            // æ˜¾ç¤ºå¥–å“ - ä¼˜å…ˆæ˜¾ç¤ºå›¾ç‰‡ï¼Œå¦åˆ™æ˜¾ç¤ºemoji
            if (picked.image) {
                display.innerHTML = `<div class="flex flex-col items-center gap-2">
                    <img src="${picked.image}" alt="${picked.name}" class="w-20 h-20 object-cover rounded-lg shadow-md">
                    <span class="text-lg font-bold">${picked.name}</span>
                </div>`;
            } else {
                display.innerHTML = `<div class="flex flex-col items-center gap-2">
                    <span class="text-4xl">${picked.emoji || 'ğŸ§¸'}</span>
                    <span class="text-lg font-bold">${picked.name}</span>
                </div>`;
            }

            let metaText = `${record.type}${record.code ? ' Â· åˆ¸ç ï¼š' + record.code : ''}`;
            if (isTrial && code) {
                metaText += ' (æ¨¡æ‹Ÿåˆ¸ç )';
            }
            meta.textContent = metaText;

            setTimeout(() => {
                btn.disabled = false;
                btn.classList.remove('opacity-60');
                // æ¢å¤é»˜è®¤æ˜¾ç¤º
                drawModeIndicator.textContent = 'ç‚¹å‡»æŒ‰é’®å¼€å§‹æŠ½å¥–';
            }, 400);
        }

        function refreshNow() { $('#now').textContent = nowStr(); }

        // â€”â€” æŠ½å¥–æ¬¡æ•°é™åˆ¶ç›¸å…³ â€”â€”
        function loadDrawLimit() {
            try {
                const limit = localStorage.getItem(LS_KEYS.DRAW_LIMIT);
                return limit ? parseInt(limit) : 0; // 0è¡¨ç¤ºä¸é™åˆ¶
            } catch { return 0; }
        }

        function loadUserDrawCount() {
            try {
                const count = localStorage.getItem(LS_KEYS.USER_DRAW_COUNT);
                return count ? parseInt(count) : 0;
            } catch { return 0; }
        }

        function saveUserDrawCount(count) {
            localStorage.setItem(LS_KEYS.USER_DRAW_COUNT, count.toString());
        }

        function updateDrawLimitDisplay() {
            const limit = loadDrawLimit();
            const userCount = loadUserDrawCount();
            const remainingSpan = $('#remainingDraws');
            const drawLimitInfo = $('#drawLimitInfo');

            if (limit === 0) {
                drawLimitInfo.style.display = 'none'; // ä¸é™åˆ¶æ—¶éšè—
            } else {
                drawLimitInfo.style.display = 'block';
                const remaining = Math.max(0, limit - userCount);
                remainingSpan.textContent = `${remaining}`;

                // æ ¹æ®å‰©ä½™æ¬¡æ•°è®¾ç½®é¢œè‰²
                if (remaining === 0) {
                    remainingSpan.className = 'text-red-600 font-medium';
                } else if (remaining <= 3) {
                    remainingSpan.className = 'text-orange-600 font-medium';
                } else {
                    remainingSpan.className = 'text-green-600 font-medium';
                }
            }
        }

        function canDraw() {
            const limit = loadDrawLimit();
            if (limit === 0) return true; // ä¸é™åˆ¶

            const userCount = loadUserDrawCount();
            return userCount < limit;
        }



        function exportJSON() {
            const data = JSON.stringify(loadHistory(), null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `labubu_lottery_${Date.now()}.json`;
            a.click();
        }

        function exportCSV() {
            const rows = [['time', 'prize', 'type', 'code_or_note']].concat(
                loadHistory().map(r => [r.time, r.prize, r.type, r.code || r.note || ''])
            );
            const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')).join('\n');
            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `labubu_lottery_${Date.now()}.csv`;
            a.click();
        }



        // â€”â€” äº‹ä»¶ç»‘å®š â€”â€”
        function bind() {
            $('#drawBtn').addEventListener('click', onDraw);
            $('#trialDrawBtn').addEventListener('click', onTrialDraw);
            $('#exportJsonBtn').addEventListener('click', exportJSON);
            $('#exportCsvBtn').addEventListener('click', exportCSV);
        }

        // â€”â€” æ•°æ®åŒæ­¥ç›‘å¬ â€”â€”
        function setupDataSync() {
            // ç›‘å¬ç®¡ç†å‘˜çš„æ•°æ®æ›´æ–°å¹¿æ’­
            if (syncEnabled && dataChannel) {
                try {
                    dataChannel.addEventListener('message', (event) => {
                        const { type, data, timestamp } = event.data;

                        switch (type) {
                            case 'POOL_UPDATE':
                                if (timestamp > lastPoolUpdate) {
                                    lastPoolUpdate = timestamp;
                                    renderPoolList(loadPool());
                                    showUpdateNotification('å¥–æ± é…ç½®å·²æ›´æ–°');
                                }
                                break;
                            case 'DRAW_LIMIT_UPDATE':
                                if (timestamp > lastLimitUpdate) {
                                    lastLimitUpdate = timestamp;
                                    updateDrawLimitDisplay();
                                    showUpdateNotification('æŠ½å¥–æ¬¡æ•°é™åˆ¶å·²æ›´æ–°');
                                }
                                break;
                            case 'USER_COUNT_RESET':
                                updateDrawLimitDisplay();
                                showUpdateNotification('æŠ½å¥–æ¬¡æ•°å·²é‡ç½®');
                                break;
                            case 'SYSTEM_RESET':
                                location.reload(); // ç³»ç»Ÿé‡ç½®æ—¶å®Œå…¨åˆ·æ–°é¡µé¢
                                break;
                        }
                    });
                } catch (error) {
                    console.error('è®¾ç½®æ¶ˆæ¯ç›‘å¬å¤±è´¥:', error);
                    syncEnabled = false;
                }
            }

            // ç›‘å¬localStorageå˜åŒ–ï¼ˆè·¨æ ‡ç­¾é¡µåŒæ­¥ï¼‰
            window.addEventListener('storage', (event) => {
                if (event.key === LS_KEYS.POOL) {
                    renderPoolList(loadPool());
                    showUpdateNotification('å¥–æ± é…ç½®å·²åŒæ­¥');
                } else if (event.key === LS_KEYS.DRAW_LIMIT || event.key === LS_KEYS.USER_DRAW_COUNT) {
                    updateDrawLimitDisplay();
                    showUpdateNotification('æŠ½å¥–é™åˆ¶å·²åŒæ­¥');
                }
            });

            // å®šæœŸæ£€æŸ¥æ•°æ®æ›´æ–°ï¼ˆå¤‡ç”¨æœºåˆ¶ï¼‰
            setInterval(() => {
                const pool = loadPool();
                renderPoolList(pool);
                updateDrawLimitDisplay();
            }, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
        }

        function showUpdateNotification(message) {
            // åˆ›å»ºä¸´æ—¶é€šçŸ¥
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 right-4 bg-[var(--labu)] text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm transition-all duration-300';
            notification.textContent = `ğŸ“¡ ${message}`;
            document.body.appendChild(notification);

            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        function init() {
            $('#year').textContent = new Date().getFullYear();
            refreshNow(); setInterval(refreshNow, 1000);
            const pool = loadPool();
            renderPoolList(pool);
            renderHistory();
            updateDrawLimitDisplay();
            setupDataSync(); // å¯åŠ¨æ•°æ®åŒæ­¥
        }

        // â€”â€” éŸ³ä¹æ’­æ”¾å™¨åŠŸèƒ½ â€”â€”
        let musicLibrary = [
            // é»˜è®¤éŸ³ä¹åº“ï¼Œå°†é€šè¿‡APIåŠ¨æ€åŠ è½½
        ];

        // Jamendo APIé…ç½®
        const JAMENDO_CLIENT_ID = '709fa152'; // å®˜æ–¹æµ‹è¯•ID
        const JAMENDO_API_BASE = 'https://api.jamendo.com/v3.0';

        // æ£€æµ‹å¾®ä¿¡ç¯å¢ƒ
        function isWeChatBrowser() {
            return /micromessenger/i.test(navigator.userAgent);
        }

        // è·å–æ¬§ç¾æµè¡ŒéŸ³ä¹ï¼ˆå¢åŠ å¾®ä¿¡å…¼å®¹æ€§ï¼‰
        async function loadMusicFromAPI() {
            // å¾®ä¿¡ç¯å¢ƒç›´æ¥ä½¿ç”¨å¤‡ç”¨éŸ³ä¹åº“
            if (isWeChatBrowser()) {
                console.log('ğŸµ æ£€æµ‹åˆ°å¾®ä¿¡ç¯å¢ƒï¼Œä½¿ç”¨å†…ç½®éŸ³ä¹åº“');
                musicLibrary = getWeChatMusicLibrary();
                return true;
            }

            try {
                // æ·»åŠ è¶…æ—¶æ§åˆ¶
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ç§’è¶…æ—¶

                // è·å–æµè¡ŒéŸ³ä¹å’Œç”µå­éŸ³ä¹
                const [popResponse, electroResponse, rockResponse] = await Promise.all([
                    fetch(`${JAMENDO_API_BASE}/tracks/?client_id=${JAMENDO_CLIENT_ID}&format=json&limit=5&tags=pop&include=musicinfo&audioformat=mp32`, {
                        signal: controller.signal,
                        mode: 'cors'
                    }),
                    fetch(`${JAMENDO_API_BASE}/tracks/?client_id=${JAMENDO_CLIENT_ID}&format=json&limit=3&tags=electronic&include=musicinfo&audioformat=mp32`, {
                        signal: controller.signal,
                        mode: 'cors'
                    }),
                    fetch(`${JAMENDO_API_BASE}/tracks/?client_id=${JAMENDO_CLIENT_ID}&format=json&limit=2&tags=rock&include=musicinfo&audioformat=mp32`, {
                        signal: controller.signal,
                        mode: 'cors'
                    })
                ]);

                clearTimeout(timeoutId);

                if (!popResponse.ok || !electroResponse.ok || !rockResponse.ok) {
                    throw new Error('APIè¯·æ±‚å¤±è´¥');
                }

                const popData = await popResponse.json();
                const electroData = await electroResponse.json();
                const rockData = await rockResponse.json();

                // åˆå¹¶æ‰€æœ‰éŸ³ä¹
                const allTracks = [
                    ...(popData.results || []),
                    ...(electroData.results || []),
                    ...(rockData.results || [])
                ];

                if (allTracks.length === 0) {
                    throw new Error('æœªè·å–åˆ°éŸ³ä¹æ•°æ®');
                }

                // è½¬æ¢ä¸ºæˆ‘ä»¬çš„éŸ³ä¹åº“æ ¼å¼
                musicLibrary = allTracks.map(track => ({
                    id: track.id,
                    title: track.name || 'Unknown Title',
                    artist: track.artist_name || 'Unknown Artist',
                    album: track.album_name || 'Unknown Album',
                    url: track.audio || track.audiodownload,
                    duration: formatDuration(track.duration),
                    image: track.album_image || track.image,
                    jamendoUrl: `https://www.jamendo.com/track/${track.id}`
                }));

                console.log('ğŸµ å·²åŠ è½½', musicLibrary.length, 'é¦–å…è´¹éŸ³ä¹');
                return true;
            } catch (error) {
                console.error('âŒ åŠ è½½éŸ³ä¹å¤±è´¥:', error);
                // ä½¿ç”¨å¤‡ç”¨éŸ³ä¹åº“
                musicLibrary = getWeChatMusicLibrary();
                return false;
            }
        }

        // å†…ç½®éŸ³ä¹åº“ï¼ˆåŒ…å«å…è´¹å¯æ’­æ”¾çš„éŸ³é¢‘ï¼‰
        function getWeChatMusicLibrary() {
            return [
                {
                    title: "ğŸµ Labubuå¹¸è¿ä¹‹æ­Œ",
                    artist: "åŸºé‡‘ä¼šéŸ³ä¹å›¢",
                    album: "èƒŒæ™¯éŸ³ä¹åˆé›†",
                    url: "https://archive.org/download/testmp3testfile/mpthreetest.mp3",
                    duration: "3:24",
                    image: "",
                    jamendoUrl: "#"
                },
                {
                    title: "ğŸ¶ æŠ½å¥–è¿›è¡Œæ›²",
                    artist: "ç³»ç»ŸéŸ³ä¹",
                    album: "ä¸“äº«éŸ³ä¹",
                    url: "https://file-examples.com/storage/fe86ad9c094c8217c95bc2c/2017/11/file_example_MP3_700KB.mp3",
                    duration: "4:12",
                    image: "",
                    jamendoUrl: "#"
                },
                {
                    title: "ğŸ† èƒœåˆ©åº†å…¸",
                    artist: "åº†ç¥éŸ³ä¹",
                    album: "è·å¥–éŸ³æ•ˆ",
                    url: "https://www.soundjay.com/misc/sounds-777.wav",
                    duration: "2:48",
                    image: "",
                    jamendoUrl: "#"
                },
                {
                    title: "ğŸŒ¸ æ¸©é¦¨èƒŒæ™¯",
                    artist: "ç¯å¢ƒéŸ³ä¹",
                    album: "æ°›å›´éŸ³ä¹",
                    url: "https://www.soundjay.com/misc/sounds-776.wav",
                    duration: "3:56",
                    image: "",
                    jamendoUrl: "#"
                },
                {
                    title: "ğŸ  æ¬¢ä¹æ—¶å…‰",
                    artist: "Labubuä¹å›¢",
                    album: "å¿«ä¹åˆé›†",
                    url: "https://www.w3schools.com/html/horse.mp3",
                    duration: "0:30",
                    image: "",
                    jamendoUrl: "#"
                },
                {
                    title: "ğŸš€ æ¢¦æƒ³èµ·èˆª",
                    artist: "åŠ±å¿—éŸ³ä¹",
                    album: "æ­£èƒ½é‡",
                    url: "https://www.learningcontainer.com/wp-content/uploads/2020/02/Kalimba.mp3",
                    duration: "5:30",
                    image: "",
                    jamendoUrl: "#"
                },
                {
                    title: "â˜€ï¸ åˆåé˜³å…‰",
                    artist: "è½»éŸ³ä¹",
                    album: "æ”¾æ¾æ—¶å…‰",
                    url: "https://samplelib.com/lib/preview/mp3/sample-6s.mp3",
                    duration: "0:06",
                    image: "",
                    jamendoUrl: "#"
                },
                {
                    title: "â­ æ˜Ÿç©ºä¸‹çš„æ¢¦",
                    artist: "å¤œæ›²ç²¾é€‰",
                    album: "å®‰é™æ—‹å¾‹",
                    url: "https://samplelib.com/lib/preview/mp3/sample-9s.mp3",
                    duration: "0:09",
                    image: "",
                    jamendoUrl: "#"
                },
                {
                    title: "ğŸ€ ç”œç¾æ—‹å¾‹",
                    artist: "å¯çˆ±éŸ³ä¹",
                    album: "Labubuä¸“å±",
                    url: "https://www.soundjay.com/misc/sounds-778.wav",
                    duration: "3:15",
                    image: "",
                    jamendoUrl: "#"
                },
                {
                    title: "ğŸ’« å¥‡å¹»ä¹‹æ—…",
                    artist: "é­”æ³•éŸ³ä¹",
                    album: "å¹»æƒ³ä¸–ç•Œ",
                    url: "https://www.soundjay.com/misc/sounds-779.wav",
                    duration: "4:20",
                    image: "",
                    jamendoUrl: "#"
                }
            ];
        }

        // æ—¶é•¿æ ¼å¼åŒ–
        function formatDuration(seconds) {
            if (!seconds) return "0:00";
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        let currentSongIndex = 0;
        let isPlaying = false;
        let currentAudio = null;
        let isPlayerMinimized = true; // é»˜è®¤æœ€å°åŒ–

        // ç®€å•çš„UIéŸ³æ•ˆç³»ç»Ÿ
        class UISoundManager {
            constructor() {
                this.enabled = localStorage.getItem('ui_sound_enabled') !== 'false';
                this.audioContext = null;
                this.initAudioContext();
            }

            initAudioContext() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('éŸ³æ•ˆä¸æ”¯æŒ');
                }
            }

            createBeep(frequency, duration, type = 'sine') {
                if (!this.audioContext || !this.enabled) return;

                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                oscillator.frequency.value = frequency;
                oscillator.type = type;

                gainNode.gain.setValueAtTime(0.05, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);

                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            }

            playDrawSound() {
                this.createBeep(440, 0.1);
                setTimeout(() => this.createBeep(554.37, 0.1), 100);
                setTimeout(() => this.createBeep(659.25, 0.2), 200);
            }

            playWinSound() {
                this.createBeep(523.25, 0.15);
                setTimeout(() => this.createBeep(659.25, 0.15), 150);
                setTimeout(() => this.createBeep(783.99, 0.3), 300);
            }

            playClickSound() {
                this.createBeep(800, 0.1, 'square');
            }

            playNotificationSound() {
                this.createBeep(880, 0.15);
            }

            toggle() {
                this.enabled = !this.enabled;
                localStorage.setItem('ui_sound_enabled', this.enabled.toString());
                return this.enabled;
            }
        }

        const uiSounds = new UISoundManager();

        // è‡ªåŠ¨æ’­æ”¾åŠŸèƒ½
        function startAutoPlay() {
            try {
                console.log('ğŸµ å°è¯•è‡ªåŠ¨æ’­æ”¾éŸ³ä¹...');

                // æ£€æŸ¥æ˜¯å¦æœ‰éŸ³é¢‘å¯¹è±¡
                if (currentAudio) {
                    // å…ˆè®¾ç½®è¾ƒä½çš„éŸ³é‡ï¼Œé¿å…çªç„¶çš„å¤§å£°éŸ³ä¹
                    currentAudio.volume = 0.3;

                    const playPromise = currentAudio.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            isPlaying = true;
                            updatePlayButtons();
                            showMusicNotification('ğŸµ æ¬¢è¿ï¼èƒŒæ™¯éŸ³ä¹å·²è‡ªåŠ¨å¼€å§‹', 'success');
                            console.log('ğŸµ è‡ªåŠ¨æ’­æ”¾æˆåŠŸ');
                        }).catch(error => {
                            console.log('ğŸµ è‡ªåŠ¨æ’­æ”¾è¢«æµè§ˆå™¨é˜»æ­¢ï¼Œéœ€è¦ç”¨æˆ·äº¤äº’åæ‰èƒ½æ’­æ”¾');

                            // å¦‚æœè‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢ï¼Œæ˜¾ç¤ºæç¤ºå¹¶å¯ç”¨ç”¨æˆ·ç‚¹å‡»æ’­æ”¾
                            showMusicNotification('ğŸµ ç‚¹å‡»ä»»æ„ä½ç½®å¯ç”¨éŸ³ä¹æ’­æ”¾', 'info');
                            enableUserInteractionPlay();
                        });
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰éŸ³é¢‘å¯¹è±¡ï¼Œå¯åŠ¨æ¨¡æ‹Ÿæ’­æ”¾
                    console.log('ğŸµ å¯åŠ¨æ¨¡æ‹Ÿæ’­æ”¾æ¨¡å¼');
                    isPlaying = true;
                    updatePlayButtons();
                    simulatePlayback();
                    showMusicNotification('ğŸµ éŸ³ä¹æ’­æ”¾å™¨å·²å¯åŠ¨ï¼ˆæ¨¡æ‹Ÿæ¨¡å¼ï¼‰', 'info');
                }
            } catch (error) {
                console.error('ğŸµ è‡ªåŠ¨æ’­æ”¾å¤±è´¥:', error);
                showMusicNotification('ğŸµ éŸ³ä¹æ’­æ”¾å™¨å¯åŠ¨å¤±è´¥', 'error');
            }
        }

        // å¯ç”¨ç”¨æˆ·äº¤äº’æ’­æ”¾ï¼ˆå½“è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢æ—¶ï¼‰
        function enableUserInteractionPlay() {
            const enableMusic = () => {
                if (!isPlaying && currentAudio) {
                    currentAudio.volume = 0.3;
                    const playPromise = currentAudio.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            isPlaying = true;
                            updatePlayButtons();
                            showMusicNotification('ğŸµ éŸ³ä¹æ’­æ”¾å·²å¯ç”¨', 'success');

                            // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
                            document.removeEventListener('click', enableMusic);
                            document.removeEventListener('touchstart', enableMusic);
                            document.removeEventListener('keydown', enableMusic);
                        }).catch(error => {
                            console.log('ğŸµ æ’­æ”¾å¤±è´¥:', error);
                        });
                    }
                }
            };

            // æ·»åŠ å¤šç§ç”¨æˆ·äº¤äº’äº‹ä»¶ç›‘å¬å™¨
            document.addEventListener('click', enableMusic, { once: true });
            document.addEventListener('touchstart', enableMusic, { once: true });
            document.addEventListener('keydown', enableMusic, { once: true });
        }

        async function initMusicPlayer() {
            try {
                // æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
                if (isWeChatBrowser()) {
                    showMusicNotification('ğŸµ å¾®ä¿¡ç¯å¢ƒå·²ä¼˜åŒ–ï¼ŒéŸ³ä¹åŠŸèƒ½æ­£å¸¸', 'success');
                }

                // å…ˆåŠ è½½éŸ³ä¹åº“
                const loadSuccess = await loadMusicFromAPI();
                if (loadSuccess) {
                    if (isWeChatBrowser()) {
                        console.log('ğŸµ å¾®ä¿¡ç¯å¢ƒä½¿ç”¨å†…ç½®éŸ³ä¹åº“');
                    } else {
                        console.log('ğŸµ æˆåŠŸåŠ è½½JamendoéŸ³ä¹åº“');
                    }
                } else {
                    console.log('ğŸµ ä½¿ç”¨å¤‡ç”¨éŸ³ä¹åº“');
                }

                renderPlaylist();
                if (musicLibrary.length > 0) {
                    loadSong(0);

                    // è‡ªåŠ¨æ’­æ”¾åŠŸèƒ½ - å»¶è¿Ÿ1ç§’ä»¥ç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
                    setTimeout(() => {
                        startAutoPlay();
                    }, 1000);
                }

                // ç¡®ä¿DOMå…ƒç´ å­˜åœ¨åå†åˆå§‹åŒ–
                const miniPlayer = $('#musicPlayerMini');
                const fullPlayer = $('#musicPlayerFull');
                const closeBtn = $('#closePlayer');

                if (miniPlayer && fullPlayer) {
                    // åˆå§‹åŒ–ä¸ºå°æŒ‰é’®çŠ¶æ€
                    miniPlayer.classList.remove('hidden');
                    fullPlayer.classList.add('hidden');
                } else {
                    console.warn('ğŸµ éŸ³ä¹æ’­æ”¾å™¨DOMå…ƒç´ æœªæ‰¾åˆ°');
                }

                // ç»‘å®šæ’­æ”¾å™¨æ§åˆ¶äº‹ä»¶
                const playPauseBtn = $('#playPauseBtn');
                const prevBtn = $('#prevBtn');
                const nextBtn = $('#nextBtn');
                const volumeSlider = $('#volumeSlider');
                const progressContainer = $('#progressContainer');

                // å°æŒ‰é’®å’Œå®Œæ•´æ’­æ”¾å™¨åˆ‡æ¢
                if (miniPlayer) miniPlayer.addEventListener('click', showFullPlayer);
                if (closeBtn) closeBtn.addEventListener('click', showMiniPlayer);

                // æ’­æ”¾æ§åˆ¶
                if (playPauseBtn) playPauseBtn.addEventListener('click', togglePlayPause);
                if (prevBtn) prevBtn.addEventListener('click', previousSong);
                if (nextBtn) nextBtn.addEventListener('click', nextSong);

                // éŸ³é‡æ§åˆ¶
                if (volumeSlider) volumeSlider.addEventListener('input', adjustVolume);

                // è¿›åº¦æ¡ç‚¹å‡»è·³è½¬
                if (progressContainer) progressContainer.addEventListener('click', seekToPosition);

                console.log('ğŸµ éŸ³ä¹æ’­æ”¾å™¨åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('ğŸµ éŸ³ä¹æ’­æ”¾å™¨åˆå§‹åŒ–å¤±è´¥:', error);
                showMusicNotification('éŸ³ä¹æ’­æ”¾å™¨åˆå§‹åŒ–å¤±è´¥', 'error');
            }
        }

        function renderPlaylist() {
            const playlist = $('#playlist');
            if (!playlist) return;

            playlist.innerHTML = '';

            if (musicLibrary.length === 0) {
                playlist.innerHTML = '<div class="text-xs text-slate-500 p-2">ğŸµ æ­£åœ¨åŠ è½½éŸ³ä¹...</div>';
                return;
            }

            musicLibrary.forEach((song, index) => {
                const songItem = document.createElement('div');
                songItem.className = `cursor-pointer p-2 rounded text-xs hover:bg-slate-100 transition-colors ${index === currentSongIndex ? 'bg-[var(--labu)] text-white' : ''}`;
                songItem.innerHTML = `
                    <div class="font-medium truncate">${song.title}</div>
                    <div class="text-xs opacity-75 truncate">${song.artist}</div>
                    <div class="text-xs opacity-60 truncate">${song.duration || ''}</div>
                `;
                songItem.addEventListener('click', () => loadSong(index));
                playlist.appendChild(songItem);
            });
        }

        function loadSong(index) {
            if (!musicLibrary || musicLibrary.length === 0) return;

            currentSongIndex = index;
            const song = musicLibrary[index];

            // åœæ­¢å½“å‰æ’­æ”¾
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }

            // æ›´æ–°UI
            const currentSongEl = $('#currentSong');
            const currentArtistEl = $('#currentArtist');
            const miniSongNameEl = $('#miniSongName');
            const totalTimeEl = $('#totalTime');

            if (currentSongEl) currentSongEl.textContent = song.title;
            if (currentArtistEl) currentArtistEl.textContent = song.artist;
            if (miniSongNameEl) miniSongNameEl.textContent = `${song.title} - ${song.artist}`;
            if (totalTimeEl) totalTimeEl.textContent = song.duration || "0:00";

            // åˆ›å»ºæ–°çš„éŸ³é¢‘å¯¹è±¡ï¼ˆå¾®ä¿¡ç¯å¢ƒä¸‹è·³è¿‡ï¼‰
            if (song.url && song.url !== '' && !isWeChatBrowser()) {
                try {
                    currentAudio = new Audio(song.url);
                    currentAudio.crossOrigin = "anonymous"; // å¤„ç†CORS

                    // éŸ³é¢‘åŠ è½½å®Œæˆ
                    currentAudio.addEventListener('loadeddata', () => {
                        console.log('ğŸµ éŸ³é¢‘å·²åŠ è½½:', song.title);
                        if (totalTimeEl) {
                            totalTimeEl.textContent = formatDuration(currentAudio.duration);
                        }
                    });

                    // æ’­æ”¾æ—¶æ›´æ–°è¿›åº¦
                    currentAudio.addEventListener('timeupdate', updateProgress);

                    // æ’­æ”¾ç»“æŸè‡ªåŠ¨ä¸‹ä¸€é¦–
                    currentAudio.addEventListener('ended', () => {
                        nextSong();
                    });

                    // é”™è¯¯å¤„ç†
                    currentAudio.addEventListener('error', (e) => {
                        console.warn('ğŸµ éŸ³é¢‘åŠ è½½å¤±è´¥:', song.title, e);
                        showMusicNotification('éŸ³é¢‘åŠ è½½å¤±è´¥ï¼Œå·²è·³åˆ°ä¸‹ä¸€é¦–', 'error');
                        nextSong();
                    });
                } catch (error) {
                    console.warn('ğŸµ éŸ³é¢‘åˆ›å»ºå¤±è´¥:', error);
                }
            } else if (isWeChatBrowser() && song.url && song.url !== '') {
                // å¾®ä¿¡ç¯å¢ƒä¸‹å°è¯•æ’­æ”¾éŸ³é¢‘ï¼ˆå¦‚æœæœ‰URLï¼‰
                try {
                    currentAudio = new Audio(song.url);
                    currentAudio.volume = 0.3; // é™ä½éŸ³é‡é¿å…çªç„¶æ’­æ”¾

                    currentAudio.addEventListener('loadeddata', () => {
                        console.log('ğŸµ å¾®ä¿¡éŸ³é¢‘å·²åŠ è½½:', song.title);
                        if (totalTimeEl) {
                            totalTimeEl.textContent = formatDuration(currentAudio.duration);
                        }
                    });

                    currentAudio.addEventListener('timeupdate', updateProgress);
                    currentAudio.addEventListener('ended', () => {
                        nextSong();
                    });

                    currentAudio.addEventListener('error', (e) => {
                        console.warn('ğŸµ å¾®ä¿¡éŸ³é¢‘åŠ è½½å¤±è´¥:', song.title, e);
                        nextSong();
                    });
                } catch (error) {
                    console.warn('ğŸµ å¾®ä¿¡éŸ³é¢‘åˆ›å»ºå¤±è´¥:', error);
                }
            } else {
                console.log('ğŸµ å½“å‰æ­Œæ›²æ— éŸ³é¢‘URL:', song.title);
            }

            renderPlaylist();
            isPlaying = false;
            updatePlayButtons();
        }

        // æ˜¾ç¤ºå®Œæ•´æ’­æ”¾å™¨
        function showFullPlayer() {
            const miniPlayer = $('#musicPlayerMini');
            const fullPlayer = $('#musicPlayerFull');

            if (miniPlayer && fullPlayer) {
                miniPlayer.classList.add('hidden');
                fullPlayer.classList.remove('hidden');
                console.log('ğŸµ æ˜¾ç¤ºå®Œæ•´æ’­æ”¾å™¨');
            }
        }

        // æ˜¾ç¤ºå°æŒ‰é’®æ’­æ”¾å™¨
        function showMiniPlayer() {
            const miniPlayer = $('#musicPlayerMini');
            const fullPlayer = $('#musicPlayerFull');

            if (miniPlayer && fullPlayer) {
                fullPlayer.classList.add('hidden');
                miniPlayer.classList.remove('hidden');
                console.log('ğŸµ æ˜¾ç¤ºå°æŒ‰é’®æ’­æ”¾å™¨');
            }
        }

        // éŸ³é‡æ§åˆ¶
        function adjustVolume(event) {
            const volume = event.target.value / 100;
            if (currentAudio) {
                currentAudio.volume = volume;
                console.log('ğŸµ éŸ³é‡è°ƒèŠ‚è‡³:', Math.round(volume * 100) + '%');
            }
        }

        // è¿›åº¦æ¡ç‚¹å‡»è·³è½¬
        function seekToPosition(event) {
            if (!currentAudio || !currentAudio.duration) return;

            const progressContainer = event.currentTarget;
            const rect = progressContainer.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const percentage = clickX / rect.width;
            const newTime = percentage * currentAudio.duration;

            currentAudio.currentTime = newTime;
            console.log('ğŸµ è·³è½¬åˆ°:', formatDuration(newTime));
        }

        function togglePlayPause() {
            if (!currentAudio) {
                // å¦‚æœæ²¡æœ‰éŸ³é¢‘ï¼Œå°è¯•é‡æ–°åŠ è½½å½“å‰æ­Œæ›²
                if (musicLibrary.length > 0) {
                    loadSong(currentSongIndex);
                    setTimeout(() => {
                        if (currentAudio) {
                            togglePlayPause();
                        } else {
                            showMusicNotification('ğŸµ æ¨¡æ‹Ÿæ’­æ”¾æ¨¡å¼', 'info');
                            isPlaying = !isPlaying;
                            updatePlayButtons();
                            if (isPlaying) {
                                simulatePlayback();
                            }
                        }
                    }, 500);
                } else {
                    showMusicNotification('ğŸµ æ¨¡æ‹Ÿæ’­æ”¾æ¨¡å¼', 'info');
                    isPlaying = !isPlaying;
                    updatePlayButtons();
                    if (isPlaying) {
                        simulatePlayback();
                    }
                }
                return;
            }

            if (isPlaying) {
                currentAudio.pause();
                isPlaying = false;
                showMusicNotification('â¸ï¸ æš‚åœæ’­æ”¾', 'info');
            } else {
                const playPromise = currentAudio.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        isPlaying = true;
                        showMusicNotification('â–¶ï¸ å¼€å§‹æ’­æ”¾', 'success');
                    }).catch(error => {
                        console.error('ğŸµ æ’­æ”¾å¤±è´¥:', error);
                        showMusicNotification('ğŸµ æ¨¡æ‹Ÿæ’­æ”¾æ¨¡å¼', 'info');
                        isPlaying = true;
                        simulatePlayback();
                    });
                }
            }

            updatePlayButtons();
        }

        // æ¨¡æ‹Ÿæ’­æ”¾åŠŸèƒ½ï¼ˆå½“æ²¡æœ‰çœŸå®éŸ³é¢‘æ—¶ï¼‰
        let simulationInterval;
        function simulatePlayback() {
            if (simulationInterval) clearInterval(simulationInterval);

            let simTime = 0;
            const maxTime = 180; // 3åˆ†é’Ÿ

            simulationInterval = setInterval(() => {
                if (!isPlaying) {
                    clearInterval(simulationInterval);
                    return;
                }

                simTime += 1;
                const progress = (simTime / maxTime) * 100;
                const progressBar = $('#progressBar');
                const currentTimeEl = $('#currentTime');

                if (progressBar) progressBar.style.width = Math.min(progress, 100) + '%';
                if (currentTimeEl) currentTimeEl.textContent = formatDuration(simTime);

                // æ¨¡æ‹Ÿæ’­æ”¾å®Œæˆ
                if (simTime >= maxTime) {
                    clearInterval(simulationInterval);
                    nextSong();
                }
            }, 1000);
        }

        function updatePlayButtons() {
            const playBtn = $('#playPauseBtn');
            const miniMusicIcon = $('#miniMusicIcon');

            if (playBtn) playBtn.textContent = isPlaying ? 'â¸ï¸' : 'â–¶ï¸';

            // æ›´æ–°å°æŒ‰é’®çš„çŠ¶æ€
            if (miniMusicIcon) {
                if (isPlaying) {
                    miniMusicIcon.textContent = 'ğŸµ';
                    miniMusicIcon.classList.add('animate-pulse');
                } else {
                    miniMusicIcon.textContent = 'â¸ï¸';
                    miniMusicIcon.classList.remove('animate-pulse');
                }
            }
        }

        function previousSong() {
            if (musicLibrary.length === 0) return;
            currentSongIndex = (currentSongIndex - 1 + musicLibrary.length) % musicLibrary.length;
            loadSong(currentSongIndex);
            if (isPlaying && currentAudio) {
                currentAudio.play().catch(console.error);
            }
        }

        function nextSong() {
            if (musicLibrary.length === 0) return;
            currentSongIndex = (currentSongIndex + 1) % musicLibrary.length;
            loadSong(currentSongIndex);
            if (isPlaying && currentAudio) {
                currentAudio.play().catch(console.error);
            }
        }

        // æ›´æ–°æ’­æ”¾è¿›åº¦ï¼ˆä½¿ç”¨çœŸå®éŸ³é¢‘ï¼‰
        function updateProgress() {
            if (!currentAudio) return;

            const currentTime = currentAudio.currentTime;
            const duration = currentAudio.duration;

            if (duration) {
                const progress = (currentTime / duration) * 100;
                const progressBar = $('#progressBar');
                const currentTimeEl = $('#currentTime');

                if (progressBar) progressBar.style.width = progress + '%';
                if (currentTimeEl) currentTimeEl.textContent = formatDuration(currentTime);
            }
        }

        // éŸ³ä¹é€šçŸ¥
        function showMusicNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' : 'bg-blue-500';

            notification.className = `fixed top-20 left-4 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm transition-all duration-300 transform -translate-x-full`;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);

            setTimeout(() => {
                notification.style.transform = 'translateX(-100%)';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        // â€”â€” ç•™è¨€ç³»ç»ŸåŠŸèƒ½ â€”â€”
        const COMMENTS_API_URL = 'https://api.jsonbin.io/v3/b/67565e7bad19ca34f8cd4c52';
        const API_KEY = '$2a$10$VjQj.Gc8Q7q8q4k4K4k4Ou'; // å…è´¹APIå¯†é’¥ç¤ºä¾‹

        let comments = [];
        let currentUser = '';

        function initCommentSystem() {
            loadComments();

            $('#submitComment').addEventListener('click', submitComment);
            $('#commentInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && e.ctrlKey) {
                    submitComment();
                }
            });

            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°ç•™è¨€
            setInterval(loadComments, 30000);
        }

        function submitComment() {
            const userName = $('#userName').value.trim() || 'åŒ¿åç”¨æˆ·';
            const content = $('#commentInput').value.trim();

            if (!content) {
                alert('è¯·è¾“å…¥ç•™è¨€å†…å®¹');
                return;
            }

            const comment = {
                id: Date.now().toString(),
                user: userName,
                content: content,
                timestamp: new Date().toLocaleString(),
                replies: []
            };

            comments.unshift(comment);
            saveComments();
            $('#commentInput').value = '';
            renderComments();
        }

        function replyToComment(commentId) {
            const replyContent = prompt('å›å¤å†…å®¹ï¼š');
            if (!replyContent) return;

            const userName = $('#userName').value.trim() || 'åŒ¿åç”¨æˆ·';
            const reply = {
                id: Date.now().toString(),
                user: userName,
                content: replyContent,
                timestamp: new Date().toLocaleString()
            };

            const comment = comments.find(c => c.id === commentId);
            if (comment) {
                comment.replies = comment.replies || [];
                comment.replies.push(reply);
                saveComments();
                renderComments();
            }
        }

        function deleteComment(commentId) {
            // åªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ é™¤ï¼ˆè¿™é‡Œç®€åŒ–æ£€æŸ¥ï¼‰
            if (!confirm('ç¡®è®¤åˆ é™¤æ­¤ç•™è¨€ï¼Ÿï¼ˆä»…ç®¡ç†å‘˜å¯æ“ä½œï¼‰')) return;

            comments = comments.filter(c => c.id !== commentId);
            saveComments();
            renderComments();
        }

        function renderComments() {
            const container = $('#commentsList');

            if (comments.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-slate-400 py-8">
                        <div class="text-4xl mb-2">ğŸ’­</div>
                        <div>æš‚æ— ç•™è¨€ï¼Œå¿«æ¥è¯´ç‚¹ä»€ä¹ˆå§ï¼</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            comments.forEach(comment => {
                const commentElement = document.createElement('div');
                commentElement.className = 'comment-bubble p-4 rounded-lg border border-slate-200';

                commentElement.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <span class="font-medium text-sm">${comment.user}</span>
                            <span class="text-xs text-slate-500">${comment.timestamp}</span>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="replyToComment('${comment.id}')" class="text-xs text-blue-600 hover:underline">å›å¤</button>
                            <button onclick="deleteComment('${comment.id}')" class="text-xs text-red-600 hover:underline">åˆ é™¤</button>
                        </div>
                    </div>
                    <div class="text-sm text-slate-700 mb-2">${comment.content}</div>
                    ${comment.replies && comment.replies.length > 0 ? `
                        <div class="space-y-2 mt-3">
                            ${comment.replies.map(reply => `
                                <div class="comment-reply p-2 rounded text-xs">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="font-medium">${reply.user}</span>
                                        <span class="text-slate-500">${reply.timestamp}</span>
                                    </div>
                                    <div class="text-slate-700">${reply.content}</div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                `;

                container.appendChild(commentElement);
            });

            $('#commentCount').textContent = comments.length;
        }

        function loadComments() {
            // æ¨¡æ‹Ÿä»APIåŠ è½½æ•°æ®ï¼ˆå®é™…é¡¹ç›®ä¸­éœ€è¦çœŸå®APIï¼‰
            const savedComments = localStorage.getItem('labubu_comments');
            if (savedComments) {
                comments = JSON.parse(savedComments);
                renderComments();
            }
        }

        function saveComments() {
            // æ¨¡æ‹Ÿä¿å­˜åˆ°APIï¼ˆå®é™…é¡¹ç›®ä¸­éœ€è¦çœŸå®APIï¼‰
            localStorage.setItem('labubu_comments', JSON.stringify(comments));
        }

        // æ›´æ–°å¯¼èˆªé“¾æ¥
        function updateNavigation() {
            const nav = $('nav');
            const commentsLink = document.createElement('a');
            commentsLink.href = '#comments';
            commentsLink.className = 'hover:underline flex items-center gap-1';
            commentsLink.innerHTML = 'ğŸ’¬ ç•™è¨€';
            nav.appendChild(commentsLink);
        }

        // éŸ³ä¹æ’­æ”¾å™¨å’Œç•™è¨€ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ
        // è¿™ä¸ªinitå‡½æ•°å·²ç»åˆå¹¶åˆ°ä¸‹é¢çš„ä¸»initå‡½æ•°ä¸­

        // â€”â€” è‡ªå®šä¹‰é¼ æ ‡å’Œäº¤äº’æ•ˆæœ â€”â€”
        let cursorInitialized = false; // é˜²æ­¢é‡å¤åˆå§‹åŒ–

        function initCustomCursor() {
            // å¦‚æœå·²ç»åˆå§‹åŒ–è¿‡ï¼Œç›´æ¥è¿”å›
            if (cursorInitialized) {
                console.log('ğŸ–±ï¸ è‡ªå®šä¹‰å…‰æ ‡å·²åˆå§‹åŒ–ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–');
                return;
            }

            const cursor = $('.custom-cursor');
            if (!cursor) {
                console.warn('ğŸ–±ï¸ è‡ªå®šä¹‰å…‰æ ‡å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }

            let mouseX = 0, mouseY = 0;

            // åˆå§‹åŒ–å…‰æ ‡ä½ç½®
            cursor.style.left = '0px';
            cursor.style.top = '0px';
            cursor.style.display = 'block';

            // é¼ æ ‡ç§»åŠ¨è·Ÿè¸ª
            document.addEventListener('mousemove', (e) => {
                mouseX = e.clientX;
                mouseY = e.clientY;
                cursor.style.left = mouseX + 'px';
                cursor.style.top = mouseY + 'px';

                // åˆ›å»ºå°¾éšå…‰æ•ˆ
                createCursorTrail(mouseX, mouseY);

                // ä¾§è¾¹äº’åŠ¨æ£€æµ‹
                if (mouseX < 100) {
                    createSideParticle('left', mouseY);
                } else if (mouseX > window.innerWidth - 100) {
                    createSideParticle('right', mouseY);
                }
            });

            // ç‚¹å‡»æ•ˆæœ
            document.addEventListener('mousedown', () => {
                cursor.classList.add('clicking');
                createMagicParticles(mouseX, mouseY);
            });

            document.addEventListener('mouseup', () => {
                cursor.classList.remove('clicking');
            });

            cursorInitialized = true;
            console.log('ğŸ–±ï¸ è‡ªå®šä¹‰å…‰æ ‡åˆå§‹åŒ–å®Œæˆ');

            // æ˜¾ç¤ºå…‰æ ‡çŠ¶æ€é€šçŸ¥
            setTimeout(() => {
                showMusicNotification('ğŸ–±ï¸ è‡ªå®šä¹‰å…‰æ ‡å·²å¯ç”¨', 'success');
            }, 500);
        }

        function createCursorTrail(x, y) {
            const trail = document.createElement('div');
            trail.className = 'cursor-trail';
            trail.style.left = (x - 4) + 'px';
            trail.style.top = (y - 4) + 'px';
            document.body.appendChild(trail);

            setTimeout(() => {
                if (document.body.contains(trail)) {
                    document.body.removeChild(trail);
                }
            }, 500);
        }

        function createSideParticle(side, y) {
            if (Math.random() > 0.95) { // 5% æ¦‚ç‡è§¦å‘
                const particle = document.createElement('div');
                particle.className = 'side-particle';
                particle.textContent = ['ğŸ§¸', 'âœ¨', 'ğŸ€', 'ğŸ’«', 'ğŸŒŸ', 'ğŸ'][Math.floor(Math.random() * 6)];
                particle.style.top = (y - 50 + Math.random() * 100) + 'px';

                if (side === 'left') {
                    particle.style.left = '20px';
                    $('.side-interactive.left').appendChild(particle);
                } else {
                    particle.style.right = '20px';
                    $('.side-interactive.right').appendChild(particle);
                }

                setTimeout(() => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                }, 3000);
            }
        }

        function createMagicParticles(x, y) {
            for (let i = 0; i < 8; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'magic-particle';
                    particle.style.left = (x + Math.random() * 40 - 20) + 'px';
                    particle.style.top = (y + Math.random() * 40 - 20) + 'px';
                    document.body.appendChild(particle);

                    setTimeout(() => {
                        if (document.body.contains(particle)) {
                            document.body.removeChild(particle);
                        }
                    }, 2000);
                }, i * 50);
            }
        }

        // â€”â€” æŒ‰é’®æ³¢çº¹æ•ˆæœ â€”â€”
        function initButtonEffects() {
            document.querySelectorAll('.enhanced-btn').forEach(button => {
                button.addEventListener('click', createRipple);
            });
        }

        function createRipple(event) {
            const button = event.currentTarget;
            const rect = button.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = event.clientX - rect.left - size / 2;
            const y = event.clientY - rect.top - size / 2;

            const ripple = document.createElement('div');
            ripple.className = 'btn-ripple';
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = x + 'px';
            ripple.style.top = y + 'px';

            button.appendChild(ripple);

            setTimeout(() => {
                if (button.contains(ripple)) {
                    button.removeChild(ripple);
                }
            }, 600);
        }

        // â€”â€” æ»šåŠ¨è§’è‰²åŠ¨ç”» â€”â€”
        function initScrollCharacters() {
            let lastScrollY = window.scrollY;
            let scrollDirection = 'down';

            window.addEventListener('scroll', () => {
                const currentScrollY = window.scrollY;
                scrollDirection = currentScrollY > lastScrollY ? 'down' : 'up';
                lastScrollY = currentScrollY;

                // éšæœºè§¦å‘è§’è‰²åŠ¨ç”»
                if (Math.random() > 0.98) { // 2% æ¦‚ç‡
                    createScrollCharacter(scrollDirection);
                }
            });
        }

        function createScrollCharacter(direction) {
            const characters = ['ğŸ­', 'ğŸ°', 'ğŸ¦„', 'ğŸ¯', 'ğŸ¦', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¸', 'ğŸ·'];
            const character = document.createElement('div');
            character.className = 'scroll-character';
            character.textContent = characters[Math.floor(Math.random() * characters.length)];

            const startY = Math.random() * (window.innerHeight - 100) + 50;
            character.style.top = startY + 'px';

            if (direction === 'down') {
                character.style.left = '-100px';
            } else {
                character.style.right = '-100px';
                character.style.transform = 'scaleX(-1)';
            }

            document.body.appendChild(character);

            setTimeout(() => {
                if (document.body.contains(character)) {
                    document.body.removeChild(character);
                }
            }, 4000);
        }

        // â€”â€” é¡µé¢åŠ è½½åŠ¨ç”»ä¼˜åŒ– â€”â€”
        function initPageAnimations() {
            // ä¸ºæ‰€æœ‰sectionæ·»åŠ è¿›å…¥åŠ¨ç”»
            const sections = document.querySelectorAll('section, main');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.animation = 'slideIn 0.6s ease-out forwards';
                    }
                });
            }, {
                threshold: 0.1,
                rootMargin: '50px'
            });

            sections.forEach(section => {
                observer.observe(section);
            });
        }

        // â€”â€” éŸ³ä¹æ’­æ”¾å™¨ä½ç½®ä¼˜åŒ– â€”â€”
        function optimizeMusicPlayer() {
            const player = $('#musicPlayer');
            if (player) {
                // æ£€æµ‹å±å¹•å°ºå¯¸ï¼Œç§»åŠ¨ç«¯æ—¶è°ƒæ•´ä½ç½®
                if (window.innerWidth < 768) {
                    player.style.width = '280px';
                    player.style.bottom = '20px';
                    player.style.right = '20px';
                }
            }
        }

        // å®‰å…¨åˆå§‹åŒ–å‡½æ•° (é˜²ç¯¡æ”¹)
        const _0x9f2e = function () {
            // VIPæƒé™éªŒè¯ - åªåœ¨é¦–æ¬¡è®¿é—®æ—¶éªŒè¯
            if (!window.checkVIPAccess || !window.checkVIPAccess()) {
                return false;
            }

            // æ˜¾ç¤ºVIPæ ‡è¯†ï¼ˆåªæ˜¾ç¤ºä¸€æ¬¡ï¼‰
            if (window.showVIPBadge) {
                window.showVIPBadge();
            }

            // åŸŸåéªŒè¯
            if (!window._secureConfig.validate()) {
                console.log('ğŸµ æ¬¢è¿è®¿é—®LabubuåŸºé‡‘ä¼šVIPç³»ç»Ÿ');
                return false;
            }

            return true;
        };

        function init() {
            // å®‰å…¨æ£€æŸ¥
            if (!_0x9f2e()) return;

            $('#year').textContent = new Date().getFullYear();
            renderHistory();
            updateDrawLimitDisplay();
            setupDataSync();

            // åˆå§‹åŒ–äº¤äº’æ•ˆæœ
            setTimeout(() => {
                initCustomCursor();
                initButtonEffects();
                initScrollCharacters();
                initPageAnimations();
                optimizeMusicPlayer();
            }, 100);
        }

        // â€”â€” ç§¯åˆ†å…‘æ¢ç³»ç»Ÿ â€”â€”
        const EXCHANGE_ITEMS = [
            {
                id: 1,
                name: "é™å®šLabubuä¸‡åœ£èŠ‚æŒ‚ä»¶",
                emoji: "ğŸƒ",
                image: "images/prizes/labubu/halloween-special.jpg",
                description: "è¶…ç¨€æœ‰ä¸‡åœ£èŠ‚é™å®šæŒ‚ä»¶",
                cost: 6000,
                rarity: 'mythic',
                available: 1,
                requirements: "éœ€è¦3åªä¼ è¯´çº§è§’è‰² + 1000ç§¯åˆ†"
            },
            {
                id: 2,
                name: "é™å®šCookie Annåœ£è¯æŒ‚ä»¶",
                emoji: "ğŸ„",
                image: "images/prizes/cookie-ann/christmas-special.jpg",
                description: "è¿ªå£«å°¼åœ£è¯é™å®šæŒ‚ä»¶",
                cost: 6000,
                rarity: 'mythic',
                available: 1,
                requirements: "éœ€è¦3åªä¼ è¯´çº§è§’è‰² + 1000ç§¯åˆ†"
            },
            {
                id: 3,
                name: "é™å®šMollyå¤æ—¥æµ·æ´‹æŒ‚ä»¶",
                emoji: "ğŸŒŠ",
                image: "images/prizes/popmart/molly-ocean-special.jpg",
                description: "2025å¤æ—¥æµ·æ´‹é™å®šæŒ‚ä»¶",
                cost: 8000,
                rarity: 'mythic',
                available: 1,
                requirements: "éœ€è¦4åªä¼ è¯´çº§è§’è‰² + 2000ç§¯åˆ†"
            },
            {
                id: 4,
                name: "ç™½é‡‘Labubuè‡³å°Šç‰ˆ",
                emoji: "ğŸ’",
                image: "images/prizes/labubu/platinum.jpg",
                description: "ç»ˆææ”¶è—ç‰ˆLabubu",
                cost: 4000,
                rarity: 'legendary',
                available: 3,
                requirements: "éœ€è¦4åªå²è¯—çº§è§’è‰²"
            },
            {
                id: 5,
                name: "Cookie Annå…¬ä¸»ç¤¼ç›’",
                emoji: "ğŸ‘¸",
                image: "images/prizes/cookie-ann/royal-set.jpg",
                description: "è¿ªå£«å°¼å…¬ä¸»ä¸»é¢˜é™å®šå¥—è£…",
                cost: 3500,
                rarity: 'legendary',
                available: 2,
                requirements: "éœ€è¦3åªå²è¯—çº§è§’è‰²"
            },
            {
                id: 6,
                name: "Pop Martè”åç¤¼åŒ…",
                emoji: "ğŸ",
                description: "åŒ…å«Molly+Dimooé™å®šå‘¨è¾¹",
                cost: 2000,
                rarity: 'epic',
                available: 5,
                requirements: "éœ€è¦3åªç¨€æœ‰çº§è§’è‰²"
            }
        ];

        let userInventory = JSON.parse(localStorage.getItem('labubu_inventory') || '[]');
        let userPoints = 0;

        // è®¡ç®—ç”¨æˆ·ç§¯åˆ†
        function calculateUserPoints() {
            const history = loadHistory();
            userPoints = 0;

            history.forEach(record => {
                const pool = loadPool();
                const prize = pool.find(p => p.name === record.prize);
                if (prize && prize.points) {
                    userPoints += prize.points;
                }
            });

            // æ›´æ–°æ˜¾ç¤º
            $('#userPoints').textContent = userPoints;
            updateExchangeableItems();
            return userPoints;
        }

        // æ›´æ–°å¯å…‘æ¢ç‰©å“æ•°é‡
        function updateExchangeableItems() {
            const canExchange = EXCHANGE_ITEMS.filter(item => userPoints >= item.cost).length;
            $('#exchangeableItems').textContent = canExchange;
        }

        // æ¸²æŸ“å…‘æ¢å•†å“
        function renderExchangeItems() {
            const container = $('#exchangeItems');

            container.innerHTML = EXCHANGE_ITEMS.map(item => {
                const canAfford = userPoints >= item.cost;
                const rarityConfig = getRarityConfig(item.rarity);

                return `
                    <div class="border border-slate-200 rounded-2xl p-4 ${canAfford ? 'bg-white' : 'bg-gray-50 opacity-60'}">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="text-3xl">${item.emoji}</div>
                            <div class="flex-1">
                                <h4 class="font-medium text-sm">${item.name}</h4>
                                <div class="text-xs" style="color: ${rarityConfig.color}">
                                    ${rarityConfig.emoji} ${rarityConfig.name}çº§
                                </div>
                            </div>
                        </div>
                        
                        <p class="text-xs text-slate-600 mb-3">${item.description}</p>
                        
                        <div class="text-xs text-slate-500 mb-3">
                            ${item.requirements}
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div class="text-sm">
                                <span class="font-bold text-[var(--labu)]">${item.cost}</span> ç§¯åˆ†
                            </div>
                            <button onclick="exchangeItem(${item.id})" 
                                    class="enhanced-btn px-3 py-1 text-xs rounded-lg ${canAfford ? 'bg-[var(--labu)] text-white' : 'bg-gray-200 text-gray-500'}"
                                    ${!canAfford ? 'disabled' : ''}>
                                ${canAfford ? 'ğŸ”„ å…‘æ¢' : 'âŒ ç§¯åˆ†ä¸è¶³'}
                            </button>
                        </div>
                        
                        <div class="text-xs text-slate-400 mt-2">
                            å‰©ä½™: ${item.available} ä»¶
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ¸²æŸ“æˆ‘çš„æ”¶è—
        function renderMyCollection() {
            const container = $('#myCollection');
            const history = loadHistory();
            const pool = loadPool();

            // ç»Ÿè®¡æ”¶è—
            const collection = {};
            history.forEach(record => {
                const prize = pool.find(p => p.name === record.prize);
                if (prize && prize.rarity && prize.rarity !== 'common') {
                    collection[record.prize] = (collection[record.prize] || 0) + 1;
                }
            });

            if (Object.keys(collection).length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-8 text-slate-400">
                        <div class="text-3xl mb-2">ğŸ§¸</div>
                        <div class="text-sm">æš‚æ— æ”¶è—ï¼Œå¿«å»æŠ½å¥–è·å¾—Labubuå§ï¼</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = Object.entries(collection).map(([name, count]) => {
                const prize = pool.find(p => p.name === name);
                const rarityConfig = getRarityConfig(prize.rarity);

                return `
                    <div class="bg-white border border-slate-200 rounded-xl p-3 text-center">
                        <div class="text-2xl mb-1">${getLabubuEmoji(name)}</div>
                        <div class="text-xs font-medium mb-1">${name}</div>
                        <div class="text-xs mb-2" style="color: ${rarityConfig.color}">
                            ${rarityConfig.emoji} ${rarityConfig.name}
                        </div>
                        <div class="text-xs font-bold">æ•°é‡: ${count}</div>
                        <div class="text-xs text-slate-500">ä»·å€¼: ${(prize.points || 0) * count}åˆ†</div>
                    </div>
                `;
            }).join('');
        }

        // è·å–Labubuè¡¨æƒ…
        function getLabubuEmoji(name) {
            const emojiMap = {
                'ç»å…¸Labubuå…¬ä»”': 'ğŸ§¸',
                'å½©è™¹Labubué™å®š': 'ğŸŒˆ',
                'åœ£è¯Labubuç‰¹åˆ«ç‰ˆ': 'ğŸ„',
                'é»„é‡‘Labubuæ”¶è—ç‰ˆ': 'ğŸ‘‘',
                '24ä¸Šè¿ªä¸‡åœ£èŠ‚é¥¼é¥¼æŒ‚ä»¶': 'ğŸƒ',
                '24ä¸Šè¿ªä¸‡åœ£èŠ‚éœ²éœ²æŒ‚ä»¶': 'ğŸ‘»',
                '25ä¸Šè¿ªå¤æ—¥æµ·æ´‹é¥¼é¥¼æŒ‚ä»¶': 'ğŸŒŠ'
            };
            return emojiMap[name] || 'ğŸ§¸';
        }

        // å…‘æ¢ç‰©å“
        function exchangeItem(itemId) {
            const item = EXCHANGE_ITEMS.find(i => i.id === itemId);
            if (!item || userPoints < item.cost || item.available <= 0) {
                alert('å…‘æ¢å¤±è´¥ï¼šç§¯åˆ†ä¸è¶³æˆ–åº“å­˜ä¸è¶³');
                return;
            }

            if (confirm(`ç¡®è®¤å…‘æ¢ ${item.name}ï¼Ÿ\næ¶ˆè€— ${item.cost} ç§¯åˆ†`)) {
                // æ‰£é™¤ç§¯åˆ†
                userPoints -= item.cost;
                item.available--;

                // æ·»åŠ åˆ°å†å²è®°å½•
                const history = loadHistory();
                const exchangeRecord = {
                    id: Date.now(),
                    prize: item.name,
                    code: generateCode(),
                    time: new Date().toLocaleString(),
                    type: 'exchange'
                };
                history.unshift(exchangeRecord);
                saveHistory(history);

                // æ›´æ–°æ˜¾ç¤º
                renderExchangeItems();
                renderMyCollection();
                renderHistory();
                $('#userPoints').textContent = userPoints;

                // æ˜¾ç¤ºå…‘æ¢æˆåŠŸ
                showExchangeSuccess(item.name, exchangeRecord.code);

                // åˆ›å»ºåº†ç¥æ•ˆæœ
                createCelebrationEffect();
            }
        }

        // æ˜¾ç¤ºå…‘æ¢æˆåŠŸ
        function showExchangeSuccess(itemName, code) {
            const popup = document.createElement('div');
            popup.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center';
            popup.innerHTML = `
                <div class="bg-white rounded-3xl p-8 mx-4 max-w-md w-full text-center">
                    <div class="text-6xl mb-4">ğŸ‰</div>
                    <h3 class="text-xl font-bold mb-2">å…‘æ¢æˆåŠŸï¼</h3>
                    <p class="text-slate-600 mb-4">æ­å–œè·å¾—ï¼š${itemName}</p>
                    <div class="bg-gray-100 rounded-lg p-3 mb-4">
                        <div class="text-xs text-slate-500 mb-1">å…‘æ¢ç </div>
                        <div class="font-mono text-lg font-bold">${code}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            class="enhanced-btn px-6 py-2 bg-[var(--labu)] text-white rounded-xl font-medium">
                        ç¡®å®š
                    </button>
                </div>
            `;
            document.body.appendChild(popup);
        }

        // åˆå§‹åŒ–ç§¯åˆ†å…‘æ¢ç³»ç»Ÿ
        function initExchangeSystem() {
            calculateUserPoints();
            renderExchangeItems();
            renderMyCollection();

            // ç»‘å®šäº‹ä»¶
            $('#calculatePointsBtn').addEventListener('click', () => {
                calculateUserPoints();
                showNotification('âœ… ç§¯åˆ†å·²é‡æ–°è®¡ç®—');
            });
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg z-50';
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 3000);
        }

        // åˆ›å»ºåº†ç¥æ•ˆæœ
        function createCelebrationEffect() {
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'magic-particle';
                    particle.style.left = (window.innerWidth / 2 + Math.random() * 200 - 100) + 'px';
                    particle.style.top = (window.innerHeight / 2 + Math.random() * 200 - 100) + 'px';
                    document.body.appendChild(particle);

                    setTimeout(() => {
                        if (document.body.contains(particle)) {
                            document.body.removeChild(particle);
                        }
                    }, 2000);
                }, i * 100);
            }
        }

        // æ£€æŸ¥æ¡æ¬¾åŒæ„çŠ¶æ€
        function checkTermsAgreement() {
            const agreed = localStorage.getItem('terms_agreed');
            if (!agreed) {
                window.location.href = 'welcome.html';
                return false;
            }

            const agreeTime = parseInt(agreed);
            const now = Date.now();
            const dayInMs = 24 * 60 * 60 * 1000;

            // æ¡æ¬¾åŒæ„æœ‰æ•ˆæœŸ7å¤©
            if (now - agreeTime > 7 * dayInMs) {
                localStorage.removeItem('terms_agreed');
                window.location.href = 'welcome.html';
                return false;
            }

            return true;
        }

        // æ›´æ–°ä¸»è¦çš„initå‡½æ•° 
        function init() {
            if (!_0x9f2e()) return;
            if (!checkTermsAgreement()) return;

            loadData();
            renderHistory();
            updateDrawLimitDisplay();
            setupDataSync();
            initExchangeSystem(); // åˆå§‹åŒ–å…‘æ¢ç³»ç»Ÿ

            // åˆå§‹åŒ–éŸ³ä¹æ’­æ”¾å™¨
            initMusicPlayer();
            initCommentSystem();
            updateNavigation();

            setTimeout(() => {
                // initCustomCursor(); // å·²åœ¨bind()å‡½æ•°ä¸­åˆå§‹åŒ–ï¼Œé¿å…é‡å¤
                initButtonEffects();
                initScrollCharacters();
                initPageAnimations();
                initPageTransitions(); // åˆå§‹åŒ–é¡µé¢è¿‡æ¸¡
                optimizeMusicPlayer();
            }, 100);
        }

        // ç»‘å®šæ–°åŠŸèƒ½
        window.replyToComment = replyToComment;
        window.deleteComment = deleteComment;
        window.exchangeItem = exchangeItem;

        bind();
        init();
    </script>
</body>

</html>