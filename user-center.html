<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººä¸­å¿ƒ - Labubu å¹¸è¿æŠ½å¥– ğŸ§¸</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ§¸</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <style>
        :root {
            --labu: #6b5b95;
            --labu2: #ffcc00;
        }

        .labu-gradient {
            background-image: linear-gradient(135deg, rgba(107, 91, 149, .15), rgba(255, 204, 0, .15));
        }

        .sparkle {
            animation: sparkle 2s ease-in-out infinite alternate;
        }

        @keyframes sparkle {
            0% {
                transform: scale(1) rotate(0deg);
            }

            100% {
                transform: scale(1.1) rotate(5deg);
            }
        }

        /* è‡ªå®šä¹‰é¼ æ ‡æ ·å¼ - å¢åŠ å¤‡ç”¨æ–¹æ¡ˆ */
        body.custom-cursor-enabled * {
            cursor: none !important;
        }

        /* é»˜è®¤ä¿ç•™ç³»ç»Ÿå…‰æ ‡ï¼Œç›´åˆ°è‡ªå®šä¹‰å…‰æ ‡æˆåŠŸåŠ è½½ */
        body:not(.custom-cursor-enabled) * {
            cursor: auto;
        }

        /* æ¢å¤æ–‡æœ¬è¾“å…¥å…ƒç´ çš„å…‰æ ‡ */
        input,
        textarea,
        [contenteditable="true"],
        .text-input {
            cursor: text !important;
        }

        /* æ¢å¤å¯ç‚¹å‡»å…ƒç´ çš„å…‰æ ‡ */
        button,
        a,
        [role="button"],
        .cursor-pointer,
        select {
            cursor: pointer !important;
        }

        /* å…‰æ ‡å›é€€é€‰é¡¹ */
        body.cursor-fallback * {
            cursor: auto !important;
        }

        body.cursor-fallback input,
        body.cursor-fallback textarea,
        body.cursor-fallback [contenteditable="true"] {
            cursor: text !important;
        }

        body.cursor-fallback button,
        body.cursor-fallback a,
        body.cursor-fallback [role="button"],
        body.cursor-fallback select {
            cursor: pointer !important;
        }

        .custom-cursor {
            position: fixed;
            width: 20px;
            height: 20px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ff69b4"><path d="M8 2C8 2 8.5 3 10.5 3C12.5 3 13 2 13 2C14 2 15 3 15 4C15 5 14 6 13 6C12 6 11 7 11 8C11 9 12 10 13 10C14 10 15 9 15 8C15 7 16 6 17 6C18 6 19 7 19 8C19 9 18 10 17 10C16 10 15 11 15 12C15 13 16 14 17 14C18 14 19 13 19 12C19 11 20 10 21 10C22 10 23 11 23 12C23 13 22 14 21 14C20 14 19 15 19 16C19 17 18 18 17 18C16 18 15 17 15 16C15 15 14 14 13 14C12 14 11 15 11 16C11 17 10 18 9 18C8 18 7 17 7 16C7 15 8 14 9 14C10 14 11 13 11 12C11 11 10 10 9 10C8 10 7 11 7 12C7 13 6 14 5 14C4 14 3 13 3 12C3 11 4 10 5 10C6 10 7 9 7 8C7 7 6 6 5 6C4 6 3 7 3 8C3 9 2 10 1 10C0 10 -1 9 -1 8C-1 7 0 6 1 6C2 6 3 5 3 4C3 3 4 2 5 2C6 2 7 3 7 4C7 5 8 6 9 6C10 6 11 5 11 4C11 3 10 2 9 2C8.5 2 8 2 8 2Z"/></svg>') no-repeat center;
            background-size: contain;
            pointer-events: none;
            z-index: 9999;
            transition: transform 0.1s ease;
            transform: translate(-50%, -50%);
        }

        .custom-cursor.clicking {
            transform: translate(-50%, -50%) scale(1.2);
        }

        .cursor-trail {
            position: fixed;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, rgba(255, 105, 180, 0.8) 0%, rgba(255, 105, 180, 0) 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9998;
            animation: cursorTrailFade 0.5s ease-out forwards;
        }

        @keyframes cursorTrailFade {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            100% {
                opacity: 0;
                transform: scale(0.3);
            }
        }

        /* ç­‰çº§è¿›åº¦æ¡ */
        .level-progress {
            background: linear-gradient(90deg, var(--labu) 0%, var(--labu2) 100%);
            height: 8px;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* æˆå°±å¾½ç«  */
        .achievement-badge {
            transition: all 0.3s ease;
        }

        .achievement-badge:hover {
            transform: scale(1.1) rotate(5deg);
        }

        .achievement-unlocked {
            background: linear-gradient(45deg, #ffd700, #ffed4a);
            color: #8b5a00;
        }

        .achievement-locked {
            background: #e2e8f0;
            color: #64748b;
        }

        /* ç»Ÿè®¡å¡ç‰‡åŠ¨ç”» */
        .stat-card {
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
        }

        /* ç­¾åˆ°æ—¥å† */
        .calendar-day {
            transition: all 0.3s ease;
        }

        .calendar-day.signed {
            background: linear-gradient(45deg, var(--labu), var(--labu2));
            color: white;
        }

        .calendar-day.today {
            border: 2px solid var(--labu);
            box-shadow: 0 0 10px rgba(107, 91, 149, 0.3);
        }

        /* æŒ‰é’®å¢å¼ºæ•ˆæœ */
        .enhanced-btn {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .enhanced-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .enhanced-btn:hover::before {
            left: 100%;
        }

        .enhanced-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(107, 91, 149, 0.3);
        }

        /* æ”¶è—å“å±•ç¤º */
        .collection-item {
            transition: all 0.3s ease;
            position: relative;
        }

        .collection-item:hover {
            transform: scale(1.05);
        }

        .collection-item.owned {
            opacity: 1;
        }

        .collection-item.not-owned {
            opacity: 0.3;
            filter: grayscale(100%);
        }

        /* é¡µé¢è¿‡æ¸¡åŠ¨ç”» */
        .page-transition-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(107, 91, 149, 0.9), rgba(255, 204, 0, 0.9));
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .page-transition-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .page-transition-content {
            text-align: center;
            color: white;
            transform: translateY(20px);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .page-transition-overlay.active .page-transition-content {
            transform: translateY(0);
        }

        .transition-loader {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* ç²’å­æ•ˆæœ */
        .magic-particle {
            position: fixed;
            width: 4px;
            height: 4px;
            background: radial-gradient(circle, #ffd700 0%, #ff69b4 50%, transparent 100%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9997;
            animation: magicParticle 2s ease-out forwards;
        }

        @keyframes magicParticle {
            0% {
                opacity: 1;
                transform: scale(0) rotate(0deg);
            }

            50% {
                opacity: 1;
                transform: scale(1) rotate(180deg);
            }

            100% {
                opacity: 0;
                transform: scale(0.2) rotate(360deg) translateY(-50px);
            }
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900">
    <!-- é¡µé¢è¿‡æ¸¡åŠ¨ç”»è¦†ç›–å±‚ -->
    <div id="pageTransitionOverlay" class="page-transition-overlay">
        <div class="page-transition-content">
            <div class="transition-loader"></div>
            <h3 class="text-2xl font-bold mb-2">ğŸ§¸ æ­£åœ¨è·³è½¬...</h3>
            <p class="text-lg opacity-90">è¯·ç¨å€™ï¼Œå³å°†ä¸ºæ‚¨åŠ è½½ç²¾å½©å†…å®¹</p>
        </div>
    </div>

    <!-- è‡ªå®šä¹‰é¼ æ ‡å…‰æ ‡ -->
    <div class="custom-cursor"></div>

    <!-- å…‰æ ‡åˆ‡æ¢æŒ‰é’® -->
    <button id="cursorToggle"
        class="fixed bottom-4 left-4 z-50 w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full shadow-lg flex items-center justify-center text-white text-lg hover:scale-110 transition-transform duration-200"
        title="åˆ‡æ¢å…‰æ ‡æ¨¡å¼" onclick="if(window.toggleCursorMode) window.toggleCursorMode()">
        ğŸ–±ï¸
    </button>

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="sticky top-0 z-30 backdrop-blur bg-white/90 border-b border-slate-200 shadow-sm">
        <div class="max-w-6xl mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 rounded-xl bg-[var(--labu)] grid place-content-center text-white text-xl sparkle">
                        ğŸ§¸</div>
                    <div>
                        <h1 class="font-bold text-lg">ä¸ªäººä¸­å¿ƒ</h1>
                        <p class="text-xs text-slate-500">Labubu æ”¶é›†å®¶ âœ¨</p>
                    </div>
                </div>
                <nav class="flex items-center gap-6">
                    <a href="index.html" class="text-slate-600 hover:text-[var(--labu)] transition-colors page-link">ğŸ¯
                        æŠ½å¥–</a>
                    <a href="shop.html" class="text-slate-600 hover:text-[var(--labu)] transition-colors page-link">ğŸ›’
                        å•†åŸ</a>
                    <a href="tasks.html" class="text-slate-600 hover:text-[var(--labu)] transition-colors page-link">ğŸ“‹
                        ä»»åŠ¡</a>
                    <a href="games.html" class="text-slate-600 hover:text-[var(--labu)] transition-colors page-link">ğŸ®
                        æ¸¸æˆ</a>
                    <a href="achievements.html"
                        class="text-slate-600 hover:text-[var(--labu)] transition-colors page-link">ğŸ† æˆå°±</a>
                </nav>
            </div>
        </div>
    </header>

    <div class="max-w-6xl mx-auto px-4 py-8">
        <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
        <section class="labu-gradient rounded-3xl p-8 mb-8">
            <div class="flex items-center gap-6">
                <div class="relative group cursor-pointer" id="avatarContainer">
                    <div class="w-24 h-24 rounded-2xl bg-white/80 grid place-content-center text-4xl sparkle overflow-hidden"
                        id="userAvatar">
                        ğŸ§¸
                    </div>
                    <div
                        class="absolute inset-0 bg-black/50 rounded-2xl flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                        <span class="text-white text-xs">ç‚¹å‡»ç¼–è¾‘</span>
                    </div>
                </div>
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                        <h2 class="text-2xl font-bold" id="userName">Labubuæ”¶é›†å®¶</h2>
                        <div class="px-3 py-1 bg-[var(--labu)] text-white rounded-full text-sm font-medium">
                            Lv.<span id="userLevel">5</span>
                        </div>
                    </div>
                    <p class="text-slate-600 mb-3">å·²åŠ å…¥ <span id="joinDays">127</span> å¤© | ä»Šæ—¥æ´»è·ƒåº¦ <span
                            class="text-[var(--labu)] font-semibold">85%</span></p>

                    <!-- ç­‰çº§è¿›åº¦æ¡ -->
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-1">
                            <span>è·ç¦»ä¸‹ä¸€çº§è¿˜éœ€</span>
                            <span id="expNeeded">350/1000 EXP</span>
                        </div>
                        <div class="w-full bg-white/50 rounded-full h-2">
                            <div class="level-progress w-1/3"></div>
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <button id="editProfileBtn" class="enhanced-btn px-4 py-2 bg-white/80 rounded-xl font-medium">âœï¸
                            ç¼–è¾‘èµ„æ–™</button>
                        <button id="dailyCheckinBtn"
                            class="enhanced-btn px-4 py-2 bg-[var(--labu)] text-white rounded-xl font-medium">ğŸ
                            æ¯æ—¥ç­¾åˆ°</button>
                        <button id="logoutBtn"
                            class="enhanced-btn px-4 py-2 bg-red-500 text-white rounded-xl font-medium hidden">ğŸšª
                            é€€å‡ºç™»å½•</button>
                    </div>

                    <!-- ç”¨æˆ·çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                    <div class="flex items-center gap-2 mt-2">
                        <div id="userStatus" class="w-3 h-3 bg-gray-400 rounded-full"></div>
                        <span id="userStatusText" class="text-sm text-gray-600">æœªç™»å½•</span>
                    </div>
                </div>

                <!-- ä»Šæ—¥è¿åŠ¿ -->
                <div class="text-center bg-white/80 rounded-2xl p-4">
                    <div class="text-3xl mb-2">ğŸ”®</div>
                    <div class="text-sm font-medium mb-1">ä»Šæ—¥è¿åŠ¿</div>
                    <div class="text-2xl font-bold text-[var(--labu)]" id="luckyRate">87%</div>
                    <div class="text-xs text-slate-600">æŠ½å¥–å¤§å‰ï¼</div>
                </div>
            </div>
        </section>

        <div class="grid md:grid-cols-3 gap-6">
            <!-- å·¦ä¾§ - ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="md:col-span-1 space-y-6">
                <!-- ä¸ªäººç»Ÿè®¡ -->
                <div class="bg-white rounded-3xl p-6 shadow-sm">
                    <h3 class="font-semibold mb-4 flex items-center gap-2">
                        ğŸ“Š ä¸ªäººç»Ÿè®¡
                    </h3>
                    <div class="space-y-4">
                        <div class="stat-card flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                            <div class="flex items-center gap-3">
                                <div class="text-2xl">ğŸ¯</div>
                                <div>
                                    <div class="text-sm text-slate-600">æ€»æŠ½å¥–æ¬¡æ•°</div>
                                    <div class="font-semibold" id="totalDraws">156</div>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                            <div class="flex items-center gap-3">
                                <div class="text-2xl">ğŸ†</div>
                                <div>
                                    <div class="text-sm text-slate-600">è·å¾—å¥–å“</div>
                                    <div class="font-semibold" id="totalPrizes">89</div>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                            <div class="flex items-center gap-3">
                                <div class="text-2xl">ğŸ’</div>
                                <div>
                                    <div class="text-sm text-slate-600">ç¨€æœ‰åº¦æ€»åˆ†</div>
                                    <div class="font-semibold" id="rarityScore">2,345</div>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                            <div class="flex items-center gap-3">
                                <div class="text-2xl">ğŸ”¥</div>
                                <div>
                                    <div class="text-sm text-slate-600">è¿ç»­ç­¾åˆ°</div>
                                    <div class="font-semibold" id="streakDays">23å¤©</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å¿«é€Ÿæ“ä½œ -->
                <div class="bg-white rounded-3xl p-6 shadow-sm">
                    <h3 class="font-semibold mb-4 flex items-center gap-2">
                        âš¡ å¿«é€Ÿæ“ä½œ
                    </h3>
                    <div class="space-y-3">
                        <button
                            class="enhanced-btn w-full p-3 bg-[var(--labu)] text-white rounded-xl flex items-center justify-center gap-2">
                            ğŸ¯ ç«‹å³æŠ½å¥–
                        </button>
                        <button
                            class="enhanced-btn w-full p-3 bg-slate-100 rounded-xl flex items-center justify-center gap-2">
                            ğŸ›’ å‰å¾€å•†åŸ
                        </button>
                        <button
                            class="enhanced-btn w-full p-3 bg-slate-100 rounded-xl flex items-center justify-center gap-2">
                            ğŸ“‹ æŸ¥çœ‹ä»»åŠ¡
                        </button>
                        <button
                            class="enhanced-btn w-full p-3 bg-slate-100 rounded-xl flex items-center justify-center gap-2">
                            ğŸ® å°æ¸¸æˆ
                        </button>
                    </div>
                </div>
            </div>

            <!-- ä¸­é—´ - ä¸»è¦å†…å®¹ -->
            <div class="md:col-span-2 space-y-6">
                <!-- æˆå°±ç³»ç»Ÿ -->
                <div class="bg-white rounded-3xl p-6 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold flex items-center gap-2">
                            ğŸ… æˆå°±å¾½ç« 
                        </h3>
                        <span class="text-sm text-slate-500" id="achievementCount">8/15 å·²è§£é”</span>
                    </div>

                    <div class="grid grid-cols-5 gap-4" id="achievementGrid">
                        <!-- æˆå°±å¾½ç« å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                    </div>
                </div>

                <!-- Labubuæ”¶è—å†Œ -->
                <div class="bg-white rounded-3xl p-6 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold flex items-center gap-2">
                            ğŸ“š Labubu æ”¶è—å†Œ
                        </h3>
                        <span class="text-sm text-slate-500" id="collectionCount">12/24 å·²æ”¶é›†</span>
                    </div>

                    <div class="grid grid-cols-6 gap-4" id="collectionGrid">
                        <!-- æ”¶è—å“å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                    </div>
                </div>

                <!-- æœ€è¿‘è·å¾— -->
                <div class="bg-white rounded-3xl p-6 shadow-sm">
                    <h3 class="font-semibold mb-4 flex items-center gap-2">
                        â­ æœ€è¿‘è·å¾—
                    </h3>

                    <div class="space-y-3" id="recentPrizes">
                        <!-- æœ€è¿‘å¥–å“å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                    </div>
                </div>

                <!-- æ¯æ—¥ç­¾åˆ°æ—¥å† -->
                <div class="bg-white rounded-3xl p-6 shadow-sm">
                    <h3 class="font-semibold mb-4 flex items-center gap-2">
                        ğŸ“… ç­¾åˆ°æ—¥å†
                        <span class="text-sm font-normal text-slate-500">æœ¬æœˆå·²ç­¾åˆ° <span id="monthlyCheckins">15</span>
                            å¤©</span>
                    </h3>

                    <div class="grid grid-cols-7 gap-2 text-center">
                        <div class="text-xs text-slate-500 p-2">æ—¥</div>
                        <div class="text-xs text-slate-500 p-2">ä¸€</div>
                        <div class="text-xs text-slate-500 p-2">äºŒ</div>
                        <div class="text-xs text-slate-500 p-2">ä¸‰</div>
                        <div class="text-xs text-slate-500 p-2">å››</div>
                        <div class="text-xs text-slate-500 p-2">äº”</div>
                        <div class="text-xs text-slate-500 p-2">å…­</div>

                        <div id="calendarGrid" class="col-span-7 grid grid-cols-7 gap-2">
                            <!-- æ—¥å†å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‰‹æœºå·ç™»å½•æ¨¡æ€æ¡† -->
    <div id="authModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-3xl p-8 mx-4 max-w-md w-full shadow-2xl">
            <!-- æ ‡é¢˜ -->
            <div class="text-center mb-6">
                <div class="text-4xl mb-2">ğŸ“±</div>
                <h2 class="text-xl font-bold text-slate-800">æ‰‹æœºéªŒè¯ç ç™»å½•</h2>
                <p class="text-sm text-slate-500 mt-2">éªŒè¯èº«ä»½ï¼ŒåŒæ­¥æ‚¨çš„æŠ½å¥–æ•°æ®åˆ°äº‘ç«¯</p>
                <button id="closeAuthModal"
                    class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 text-2xl">Ã—</button>
            </div>

            <!-- æ‰‹æœºå·è¾“å…¥ -->
            <div id="phoneInputStep" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">æ‰‹æœºå·ç </label>
                    <div class="flex">
                        <select id="countryCode"
                            class="px-3 py-2 border border-slate-300 rounded-l-lg text-sm focus:border-[var(--labu)] focus:outline-none">
                            <option value="+86">ğŸ‡¨ğŸ‡³ +86</option>
                            <option value="+1">ğŸ‡ºğŸ‡¸ +1</option>
                            <option value="+44">ğŸ‡¬ğŸ‡§ +44</option>
                            <option value="+81">ğŸ‡¯ğŸ‡µ +81</option>
                            <option value="+82">ğŸ‡°ğŸ‡· +82</option>
                        </select>
                        <input type="tel" id="phoneNumber" placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
                            class="flex-1 px-3 py-2 border border-l-0 border-slate-300 rounded-r-lg text-sm focus:border-[var(--labu)] focus:outline-none">
                    </div>
                    <div id="phoneError" class="text-red-500 text-xs mt-1 hidden"></div>
                </div>

                <!-- ç®€å•éªŒè¯ -->
                <div class="text-xs text-slate-500 bg-blue-50 p-2 rounded">
                    ğŸ’¡ ä¸ºäº†ç®€åŒ–æµç¨‹ï¼Œæˆ‘ä»¬ä½¿ç”¨æ¼”ç¤ºéªŒè¯ç ï¼š<strong>123456</strong>
                </div>

                <button id="sendCodeBtn"
                    class="w-full bg-[var(--labu)] text-white py-3 rounded-lg font-medium hover:bg-[var(--labu)]/90 transition-colors">
                    ğŸ“¤ å‘é€éªŒè¯ç 
                </button>
            </div>

            <!-- éªŒè¯ç è¾“å…¥ -->
            <div id="codeInputStep" class="space-y-4 hidden">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">éªŒè¯ç </label>
                    <input type="text" id="verificationCode" placeholder="è¯·è¾“å…¥6ä½éªŒè¯ç " maxlength="6"
                        class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm text-center font-mono text-lg tracking-wider focus:border-[var(--labu)] focus:outline-none">
                    <div id="codeError" class="text-red-500 text-xs mt-1 hidden"></div>
                </div>

                <div class="flex justify-between items-center text-sm">
                    <span class="text-slate-500">éªŒè¯ç å·²å‘é€è‡³ <span id="sentPhoneNumber"></span></span>
                    <button id="resendCodeBtn" class="text-[var(--labu)] hover:underline" disabled>
                        é‡æ–°å‘é€ (<span id="countdown">60</span>s)
                    </button>
                </div>

                <button id="verifyCodeBtn"
                    class="w-full bg-[var(--labu)] text-white py-3 rounded-lg font-medium hover:bg-[var(--labu)]/90 transition-colors">
                    âœ… éªŒè¯ç™»å½•
                </button>

                <button id="backToPhoneBtn"
                    class="w-full bg-slate-200 text-slate-700 py-2 rounded-lg font-medium hover:bg-slate-300 transition-colors">
                    â† è¿”å›ä¿®æ”¹æ‰‹æœºå·
                </button>
            </div>

            <!-- ç™»å½•åŠ è½½çŠ¶æ€ -->
            <div id="loginLoading" class="text-center text-slate-500 hidden">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[var(--labu)] mx-auto mb-2"></div>
                <p class="text-sm">æ­£åœ¨éªŒè¯...</p>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘èµ„æ–™æ¨¡æ€æ¡† -->
    <div id="editProfileModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-slate-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold text-slate-800">ç¼–è¾‘ä¸ªäººèµ„æ–™</h3>
                    <button id="closeProfileModal" class="text-slate-400 hover:text-slate-600 text-2xl">Ã—</button>
                </div>
            </div>

            <form id="profileForm" class="p-6 space-y-6">
                <!-- å¤´åƒä¸Šä¼  -->
                <div class="text-center">
                    <div class="relative inline-block">
                        <div id="avatarPreview"
                            class="w-24 h-24 rounded-2xl bg-slate-100 grid place-content-center text-4xl mx-auto mb-4 overflow-hidden cursor-pointer">
                            ğŸ§¸
                        </div>
                        <input type="file" id="avatarUpload" accept="image/*" class="hidden">
                        <button type="button" id="uploadAvatarBtn"
                            class="absolute -bottom-1 -right-1 w-8 h-8 bg-[var(--labu)] text-white rounded-full flex items-center justify-center text-sm">
                            ğŸ“·
                        </button>
                    </div>
                    <p class="text-xs text-slate-500">ç‚¹å‡»ä¸Šä¼ å¤´åƒï¼ˆæœ€å¤§2MBï¼‰</p>
                </div>

                <!-- åŸºæœ¬ä¿¡æ¯ -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">ç”¨æˆ·å</label>
                        <input type="text" id="profileName" required
                            class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:border-[var(--labu)] focus:outline-none transition-colors">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">ä¸ªäººç®€ä»‹</label>
                        <textarea id="profileBio" rows="3" placeholder="å†™ç‚¹ä»€ä¹ˆä»‹ç»ä¸€ä¸‹è‡ªå·±..."
                            class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:border-[var(--labu)] focus:outline-none transition-colors resize-none"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">ä¸ªæ€§ç­¾å</label>
                        <input type="text" id="profileSignature" placeholder="ä¾‹å¦‚ï¼šLabubuæ”¶é›†å®¶ ğŸ§¸"
                            class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:border-[var(--labu)] focus:outline-none transition-colors">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">ç”Ÿæ—¥</label>
                        <input type="date" id="profileBirthday"
                            class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:border-[var(--labu)] focus:outline-none transition-colors">
                    </div>
                </div>

                <!-- æŒ‰é’®ç»„ -->
                <div class="flex gap-3 pt-4">
                    <button type="button" id="cancelProfile"
                        class="flex-1 py-3 px-4 border border-slate-300 text-slate-700 rounded-xl hover:bg-slate-50 transition-colors">
                        å–æ¶ˆ
                    </button>
                    <button type="submit"
                        class="flex-1 py-3 px-4 bg-[var(--labu)] text-white rounded-xl hover:bg-opacity-90 transition-colors font-medium">
                        ä¿å­˜
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // å·¥å…·å‡½æ•°
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        // Firebaseé…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyAPUti6enwvI57jiOqE3kC9SMBG4GL2FfE",
            authDomain: "labubu-lottery.firebaseapp.com",
            projectId: "llabubu- lottery - b8cfd",
            storageBucket: "labubu-lottery.appspot.com",
            messagingSenderId: "1040839447881",
            appId: "1:1040839447881:web:a25f503a3182e9b020b698"
        };

        // åˆå§‹åŒ–Firebase
        let app, auth, db, storage;
        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            storage = firebase.storage();
        } catch (error) {
            console.warn('Firebaseåˆå§‹åŒ–å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼:', error);
        }

        // å½“å‰ç”¨æˆ·
        let currentUser = null;
        let isLoggedIn = false;
        let isAuthenticated = false;
        let pendingPhoneNumber = null;

        // é»˜è®¤ç”¨æˆ·æ•°æ®
        let userData = {
            uid: null,
            name: 'Labubuæ”¶é›†å®¶',
            avatar: null,
            bio: '',
            signature: 'Labubuæ”¶é›†å®¶ ğŸ§¸',
            birthday: null,
            level: 1,
            exp: 0,
            maxExp: 100,
            joinDays: 1,
            totalDraws: 0,
            totalPrizes: 0,
            rarityScore: 0,
            streakDays: 0,
            luckyRate: 50,
            points: 100, // ç§¯åˆ†
            createdAt: new Date(),
            updatedAt: new Date()
        };

        // JSONBin.ioæ•°æ®å­˜å‚¨é…ç½®
        const DATA_STORAGE_CONFIG = {
            jsonbin: {
                baseUrl: 'https://api.jsonbin.io/v3',
                apiKey: '$2a$10$VjQj.Gc8Q7q8q4k4K4k4Ou' // è¿™é‡Œä½¿ç”¨ä½ çš„å®é™…APIå¯†é’¥
            }
        };

        let userDataBinId = null; // ç”¨æˆ·æ•°æ®å­˜å‚¨çš„bin ID

        // æˆå°±æ•°æ®
        const achievements = [
            { id: 1, name: 'åˆå¿ƒè€…', icon: 'ğŸ”°', description: 'å®Œæˆç¬¬ä¸€æ¬¡æŠ½å¥–', unlocked: true },
            { id: 2, name: 'å¹¸è¿å„¿', icon: 'ğŸ€', description: 'è¿ç»­3æ¬¡æŠ½ä¸­å¥–å“', unlocked: true },
            { id: 3, name: 'æ”¶é›†å®¶', icon: 'ğŸ“¦', description: 'æ”¶é›†10ç§ä¸åŒå¥–å“', unlocked: true },
            { id: 4, name: 'åšæŒè€…', icon: 'ğŸ’ª', description: 'è¿ç»­ç­¾åˆ°7å¤©', unlocked: true },
            { id: 5, name: 'åœŸè±ª', icon: 'ğŸ’°', description: 'å•æ—¥æŠ½å¥–è¶…è¿‡20æ¬¡', unlocked: true },
            { id: 6, name: 'ä¼ è¯´', icon: 'ğŸŒŸ', description: 'æŠ½ä¸­ä¼ è¯´çº§å¥–å“', unlocked: true },
            { id: 7, name: 'ç¤¾äº¤è¾¾äºº', icon: 'ğŸ’¬', description: 'å‘è¡¨10æ¡ç•™è¨€', unlocked: true },
            { id: 8, name: 'è´­ç‰©ç‹‚', icon: 'ğŸ›’', description: 'å•†åŸè´­ä¹°æ»¡500å…ƒ', unlocked: true },
            { id: 9, name: 'å®Œç¾ä¸»ä¹‰', icon: 'ğŸ’', description: 'æ”¶é›†é½å…¨å¥—Labubu', unlocked: false },
            { id: 10, name: 'æœˆåº¦ä¹‹æ˜Ÿ', icon: 'ğŸŒ™', description: 'æœˆåº¦æŠ½å¥–æ¬¡æ•°ç¬¬ä¸€', unlocked: false },
            { id: 11, name: 'åˆ†äº«è¾¾äºº', icon: 'ğŸ“¤', description: 'åˆ†äº«ç»™10ä½å¥½å‹', unlocked: false },
            { id: 12, name: 'è¯„è®ºå®¶', icon: 'ğŸ“', description: 'ç»™å•†å“å†™50æ¡è¯„ä»·', unlocked: false },
            { id: 13, name: 'æ¸¸æˆé«˜æ‰‹', icon: 'ğŸ®', description: 'å°æ¸¸æˆè·å¾—æ»¡åˆ†', unlocked: false },
            { id: 14, name: 'æ…ˆå–„å®¶', icon: 'â¤ï¸', description: 'å‚ä¸æ…ˆå–„æŠ½å¥–æ´»åŠ¨', unlocked: false },
            { id: 15, name: 'Labubuä¹‹ç‹', icon: 'ğŸ‘‘', description: 'è¾¾æˆæ‰€æœ‰æˆå°±', unlocked: false }
        ];

        // æ”¶è—å“æ•°æ®
        const collections = [
            { id: 1, name: 'ç»å…¸æ¬¾', emoji: 'ğŸ§¸', owned: true, rarity: 'common' },
            { id: 2, name: 'ç²‰è‰²æ¢¦å¹»', emoji: 'ğŸ’–', owned: true, rarity: 'common' },
            { id: 3, name: 'è“è‰²æµ·æ´‹', emoji: 'ğŸŒŠ', owned: true, rarity: 'common' },
            { id: 4, name: 'ç»¿è‰²æ£®æ—', emoji: 'ğŸŒ²', owned: true, rarity: 'common' },
            { id: 5, name: 'å½©è™¹ç³»åˆ—', emoji: 'ğŸŒˆ', owned: true, rarity: 'rare' },
            { id: 6, name: 'å¤æ—¥æµ·æ»©', emoji: 'ğŸ–ï¸', owned: true, rarity: 'rare' },
            { id: 7, name: 'å®‡å®™æ˜Ÿç©º', emoji: 'ğŸŒŒ', owned: true, rarity: 'rare' },
            { id: 8, name: 'åœ£è¯ç‰¹åˆ«', emoji: 'ğŸ„', owned: true, rarity: 'epic' },
            { id: 9, name: 'ä¸‡åœ£èŠ‚', emoji: 'ğŸƒ', owned: true, rarity: 'epic' },
            { id: 10, name: 'å’–å•¡ä¸»é¢˜', emoji: 'â˜•', owned: true, rarity: 'epic' },
            { id: 11, name: 'é»„é‡‘é™å®š', emoji: 'ğŸ†', owned: true, rarity: 'legendary' },
            { id: 12, name: 'é’»çŸ³å…¸è—', emoji: 'ğŸ’', owned: true, rarity: 'legendary' },
            { id: 13, name: 'ç‹¬è§’å…½', emoji: 'ğŸ¦„', owned: false, rarity: 'rare' },
            { id: 14, name: 'é¾™å¹´ç‰¹åˆ«', emoji: 'ğŸ‰', owned: false, rarity: 'epic' },
            { id: 15, name: 'å¤ªç©ºæ¼«æ¸¸', emoji: 'ğŸš€', owned: false, rarity: 'epic' },
            { id: 16, name: 'é­”æ³•å¸ˆ', emoji: 'ğŸ§™', owned: false, rarity: 'rare' },
            { id: 17, name: 'æœºå™¨äºº', emoji: 'ğŸ¤–', owned: false, rarity: 'common' },
            { id: 18, name: 'è¶…çº§è‹±é›„', emoji: 'ğŸ¦¸', owned: false, rarity: 'epic' },
            { id: 19, name: 'å…¬ä¸»ç³»åˆ—', emoji: 'ğŸ‘¸', owned: false, rarity: 'rare' },
            { id: 20, name: 'æ­¦å£«é“', emoji: 'ğŸ¥·', owned: false, rarity: 'epic' },
            { id: 21, name: 'å¤©ä½¿ä¹‹ç¿¼', emoji: 'ğŸ‘¼', owned: false, rarity: 'legendary' },
            { id: 22, name: 'æ¶é­”ä¹‹è§’', emoji: 'ğŸ˜ˆ', owned: false, rarity: 'legendary' },
            { id: 23, name: 'æ—¶å…‰æ—…è€…', emoji: 'â°', owned: false, rarity: 'legendary' },
            { id: 24, name: 'ç»ˆæå½¢æ€', emoji: 'ğŸŒŸ', owned: false, rarity: 'mythic' }
        ];

        // æœ€è¿‘è·å¾—å¥–å“
        const recentPrizes = [
            { name: 'é’»çŸ³å…¸è— Labubu', emoji: 'ğŸ’', rarity: 'legendary', time: '2å°æ—¶å‰' },
            { name: 'å’–å•¡ä¸»é¢˜ Labubu', emoji: 'â˜•', rarity: 'epic', time: '1å¤©å‰' },
            { name: '3Uå¸', emoji: 'ğŸª™', rarity: 'common', time: '2å¤©å‰' },
            { name: 'å½©è™¹ç³»åˆ— Labubu', emoji: 'ğŸŒˆ', rarity: 'rare', time: '3å¤©å‰' },
            { name: 'çƒ¤è‚‰åˆ¸', emoji: 'ğŸ¥©', rarity: 'common', time: '4å¤©å‰' }
        ];

        // ç”¨æˆ·è®¤è¯å’Œæ•°æ®ç®¡ç†ç±»
        class UserManager {
            constructor() {
                this.authModal = $('#authModal');
                this.editProfileModal = $('#editProfileModal');
                this.isLoginMode = true;
                this.initAuthListeners();
                this.initProfileListeners();
                this.setupAuthStateListener();
            }

            // è®¾ç½®è®¤è¯çŠ¶æ€ç›‘å¬
            setupAuthStateListener() {
                // æ£€æŸ¥æœ¬åœ°ç™»å½•çŠ¶æ€
                this.checkLoginStatus();

                if (auth) {
                    auth.onAuthStateChanged((user) => {
                        if (user) {
                            // Firebaseç”¨æˆ·ç™»å½•ï¼ˆå¦‚æœä¹‹å‰æœ‰Firebaseè´¦æˆ·ï¼‰
                            currentUser = user;
                            isLoggedIn = true;
                            this.updateUIForAuthState(user);
                            this.loadUserData(user.uid);
                        }
                    });
                }
            }

            // æ›´æ–°UIä»¥åæ˜ è®¤è¯çŠ¶æ€
            updateUIForAuthState(user) {
                const statusIndicator = $('#userStatus');
                const statusText = $('#userStatusText');
                const logoutBtn = $('#logoutBtn');
                const editBtn = $('#editProfileBtn');

                if (user) {
                    statusIndicator.className = 'w-3 h-3 bg-green-400 rounded-full';

                    if (user.phoneNumber) {
                        // æ˜¾ç¤ºæ©ç æ‰‹æœºå·
                        const maskedPhone = user.phoneNumber.replace(/(\+\d{1,3})(\d{3})(\d{4})(\d{4})/, '$1 $2****$4');
                        statusText.textContent = `å·²ç™»å½• Â· ${maskedPhone}`;
                    } else {
                        statusText.textContent = 'å·²ç™»å½•';
                    }

                    logoutBtn.classList.remove('hidden');
                    editBtn.textContent = 'âœï¸ ç¼–è¾‘èµ„æ–™';
                } else {
                    statusIndicator.className = 'w-3 h-3 bg-gray-400 rounded-full';
                    statusText.textContent = 'æœªç™»å½•';
                    logoutBtn.classList.add('hidden');
                    editBtn.textContent = 'ğŸ“± æ‰‹æœºå·ç™»å½•';
                }
            }

            // æ˜¾ç¤ºè®¤è¯æ¨¡æ€æ¡†
            showAuthModal() {
                this.resetLoginForm();
                this.authModal.classList.remove('hidden');
            }

            // éšè—è®¤è¯æ¨¡æ€æ¡†
            hideAuthModal() {
                this.authModal.classList.add('hidden');
            }

            // è¿™äº›æ–¹æ³•ä¿ç•™å…¼å®¹æ€§ä½†ä¸å†ä½¿ç”¨
            switchToLogin() {
                // å·²æ”¹ä¸ºæ‰‹æœºå·ç™»å½•ï¼Œä¿ç•™æ–¹æ³•é¿å…æŠ¥é”™
            }

            switchToRegister() {
                // å·²æ”¹ä¸ºæ‰‹æœºå·ç™»å½•ï¼Œä¿ç•™æ–¹æ³•é¿å…æŠ¥é”™
            }

            // å‘é€éªŒè¯ç 
            async sendVerificationCode() {
                const phoneNumber = $('#phoneNumber').value.trim();
                const countryCode = $('#countryCode').value;
                const fullPhoneNumber = countryCode + phoneNumber;

                // éªŒè¯æ‰‹æœºå·æ ¼å¼
                if (!this.validatePhoneNumber(phoneNumber, countryCode)) {
                    return;
                }

                try {
                    $('#sendCodeBtn').disabled = true;
                    $('#sendCodeBtn').textContent = 'æ­£åœ¨å‘é€...';

                    // æ¨¡æ‹Ÿå‘é€éªŒè¯ç çš„è¿‡ç¨‹
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    // ä¿å­˜å¾…éªŒè¯çš„æ‰‹æœºå·
                    pendingPhoneNumber = fullPhoneNumber;

                    console.log('ğŸ“± æ¼”ç¤ºéªŒè¯ç å·²"å‘é€"è‡³:', fullPhoneNumber);
                    this.showSuccess('éªŒè¯ç å·²å‘é€ï¼è¯·è¾“å…¥ï¼š123456');

                    // åˆ‡æ¢åˆ°éªŒè¯ç è¾“å…¥ç•Œé¢
                    $('#phoneInputStep').classList.add('hidden');
                    $('#codeInputStep').classList.remove('hidden');
                    $('#sentPhoneNumber').textContent = fullPhoneNumber;

                    // å¼€å§‹å€’è®¡æ—¶
                    this.startCountdown();

                } catch (error) {
                    console.error('ğŸ“± å‘é€éªŒè¯ç å¤±è´¥:', error);
                    this.showError('å‘é€éªŒè¯ç å¤±è´¥ï¼Œè¯·é‡è¯•');
                    $('#sendCodeBtn').disabled = false;
                    $('#sendCodeBtn').textContent = 'ğŸ“¤ å‘é€éªŒè¯ç ';
                }
            }

            // éªŒè¯ç™»å½•ç 
            async verifyCode() {
                const code = $('#verificationCode').value.trim();

                if (!code) {
                    this.showCodeError('è¯·è¾“å…¥éªŒè¯ç ');
                    return;
                }

                if (code.length !== 6) {
                    this.showCodeError('éªŒè¯ç åº”ä¸º6ä½æ•°å­—');
                    return;
                }

                if (!pendingPhoneNumber) {
                    this.showCodeError('éªŒè¯ç å·²å¤±æ•ˆï¼Œè¯·é‡æ–°è·å–');
                    return;
                }

                try {
                    $('#verifyCodeBtn').disabled = true;
                    $('#verifyCodeBtn').textContent = 'æ­£åœ¨éªŒè¯...';
                    $('#loginLoading').classList.remove('hidden');

                    // æ¨¡æ‹ŸéªŒè¯è¿‡ç¨‹
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    // ç®€å•çš„éªŒè¯ç æ£€æŸ¥ï¼ˆæ¼”ç¤ºç”¨ï¼‰
                    if (code === '123456') {
                        // åˆ›å»ºç”¨æˆ·å¯¹è±¡
                        currentUser = {
                            phoneNumber: pendingPhoneNumber,
                            uid: 'user_' + Date.now(),
                            loginTime: new Date().toISOString()
                        };

                        isAuthenticated = true;
                        isLoggedIn = true;

                        // ä¿å­˜ç™»å½•çŠ¶æ€
                        localStorage.setItem('labubu_user_auth', JSON.stringify(currentUser));

                        console.log('âœ… ç™»å½•æˆåŠŸ:', currentUser.phoneNumber);
                        this.showSuccess('ç™»å½•æˆåŠŸï¼æ­£åœ¨åŒæ­¥æ•°æ®...');

                        // æ›´æ–°ç”¨æˆ·æ•°æ®
                        userData.uid = currentUser.uid;
                        userData.name = 'æ‰‹æœºç”¨æˆ·';

                        // æ›´æ–°ç”¨æˆ·çŠ¶æ€æ˜¾ç¤º
                        this.updateUIForAuthState(currentUser);

                        // å…³é—­ç™»å½•çª—å£
                        this.hideAuthModal();

                        // åŠ è½½ç”¨æˆ·æ•°æ®
                        this.loadUserData(currentUser.uid);

                    } else {
                        throw new Error('éªŒè¯ç é”™è¯¯');
                    }

                } catch (error) {
                    console.error('âŒ éªŒè¯å¤±è´¥:', error);
                    let errorMessage = 'éªŒè¯ç é”™è¯¯ï¼Œè¯·è¾“å…¥ï¼š123456';

                    this.showCodeError(errorMessage);
                    $('#verifyCodeBtn').disabled = false;
                    $('#verifyCodeBtn').textContent = 'âœ… éªŒè¯ç™»å½•';
                    $('#loginLoading').classList.add('hidden');
                }
            }

            // é€€å‡ºç™»å½•
            async logout() {
                try {
                    // æ¸…é™¤ç™»å½•çŠ¶æ€
                    currentUser = null;
                    isAuthenticated = false;
                    isLoggedIn = false;
                    pendingPhoneNumber = null;

                    // æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„ç™»å½•ä¿¡æ¯
                    localStorage.removeItem('labubu_user_auth');
                    localStorage.removeItem('labubu_user_bin_id');

                    // æ›´æ–°UIçŠ¶æ€
                    this.updateUIForAuthState(null);

                    this.showSuccess('å·²å®‰å…¨é€€å‡ºç™»å½•');
                    console.log('ğŸšª ç”¨æˆ·å·²é€€å‡ºç™»å½•');
                } catch (error) {
                    console.error('ğŸšª é€€å‡ºç™»å½•å¤±è´¥:', error);
                    this.showError('é€€å‡ºç™»å½•å¤±è´¥');
                }
            }

            // åˆ›å»ºç”¨æˆ·æ•°æ®
            async createUserData(uid, displayName) {
                if (!db) return;

                const newUserData = {
                    ...userData,
                    uid: uid,
                    name: displayName,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    await db.collection('users').doc(uid).set(newUserData);
                    userData = newUserData;
                } catch (error) {
                    console.error('åˆ›å»ºç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                }
            }

            // åŠ è½½ç”¨æˆ·æ•°æ®
            async loadUserData(uid) {
                try {
                    // é¦–å…ˆå°è¯•ä»äº‘ç«¯åŠ è½½æ•°æ®
                    const cloudData = await this.downloadUserData();

                    if (cloudData) {
                        // åˆå¹¶äº‘ç«¯æ•°æ®
                        userData = { ...userData, ...cloudData };
                        console.log('âœ… ä»äº‘ç«¯åŠ è½½ç”¨æˆ·æ•°æ®æˆåŠŸ');
                    } else {
                        // å¦‚æœäº‘ç«¯æ²¡æœ‰æ•°æ®ï¼Œä»æœ¬åœ°åŠ è½½å¹¶åŒæ­¥åˆ°äº‘ç«¯
                        this.loadLocalData();

                        // å»¶è¿ŸåŒæ­¥åˆ°äº‘ç«¯
                        setTimeout(() => {
                            this.saveUserData();
                        }, 2000);
                    }

                    renderUserData();
                } catch (error) {
                    console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                    this.loadLocalData();
                }
            }

            // åŠ è½½æœ¬åœ°æ•°æ®
            loadLocalData() {
                try {
                    // åŠ è½½ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
                    const savedData = localStorage.getItem('userData');
                    if (savedData) {
                        userData = { ...userData, ...JSON.parse(savedData) };
                    }

                    // åŠ è½½ç§¯åˆ†æ•°æ®
                    const points = localStorage.getItem('labubu_user_points');
                    if (points) {
                        userData.points = parseInt(points) || 100;
                    }

                    // åŠ è½½æŠ½å¥–ç»Ÿè®¡
                    const history = this.loadHistory();
                    userData.totalDraws = history.length;
                    userData.totalPrizes = history.filter(h => h.type !== 'empty').length;

                    // è®¡ç®—ç¨€æœ‰åº¦æ€»åˆ†
                    userData.rarityScore = history.reduce((score, h) => {
                        const rarityPoints = {
                            'common': 1,
                            'rare': 5,
                            'epic': 15,
                            'legendary': 50,
                            'mythic': 100
                        };
                        return score + (rarityPoints[h.rarity] || 0);
                    }, 0);

                    // åŠ è½½æŠ½å¥–æ¬¡æ•°
                    const drawCount = localStorage.getItem('labubu_user_draw_count');
                    if (drawCount) {
                        userData.totalDraws = parseInt(drawCount) || 0;
                    }

                    // åŠ è½½ç­¾åˆ°æ•°æ®
                    const checkinHistory = JSON.parse(localStorage.getItem('checkinHistory') || '{}');
                    userData.streakDays = Object.keys(checkinHistory).length;

                    // è·å–ç”¨æˆ·æ•°æ®å­˜å‚¨ID
                    userDataBinId = localStorage.getItem('labubu_user_bin_id');

                    console.log('ğŸ“ æœ¬åœ°æ•°æ®åŠ è½½å®Œæˆ:', userData);
                } catch (error) {
                    console.error('åŠ è½½æœ¬åœ°æ•°æ®å¤±è´¥:', error);
                }

                renderUserData();
            }

            // ä¿å­˜ç”¨æˆ·æ•°æ®
            async saveUserData() {
                userData.updatedAt = new Date();

                // ä¿å­˜åˆ°æœ¬åœ°
                localStorage.setItem('userData', JSON.stringify(userData));
                localStorage.setItem('labubu_user_points', userData.points.toString());

                // ä¿å­˜åˆ°äº‘ç«¯
                if (currentUser) {
                    try {
                        const success = await this.uploadToJsonBin(userData);
                        if (success) {
                            this.showSuccess('æ•°æ®åŒæ­¥åˆ°äº‘ç«¯æˆåŠŸï¼');
                        } else {
                            this.showSuccess('æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°');
                        }
                    } catch (error) {
                        console.error('ä¿å­˜åˆ°äº‘ç«¯å¤±è´¥:', error);
                        this.showSuccess('æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°');
                    }
                } else {
                    this.showSuccess('æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°');
                }
            }

            // æ”¶é›†å®Œæ•´ç”¨æˆ·æ•°æ®ï¼ˆä¸index.htmlä¿æŒä¸€è‡´ï¼‰
            collectAllUserData() {
                return {
                    // ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
                    user: {
                        phoneNumber: currentUser?.phoneNumber || null,
                        uid: currentUser?.uid || null,
                        loginTime: currentUser?.loginTime || null
                    },

                    // ç”¨æˆ·è¯¦ç»†æ•°æ®
                    userData: userData,

                    // æŠ½å¥–ç›¸å…³æ•°æ®
                    lottery: {
                        history: this.loadHistory(),
                        drawCount: parseInt(localStorage.getItem('labubu_user_draw_count') || '0'),
                        drawLimit: parseInt(localStorage.getItem('labubu_draw_limit') || '0'),
                        vipDraws: parseInt(localStorage.getItem('labubu_vip_draws') || '0')
                    },

                    // æ”¶è—å’Œå…‘æ¢æ•°æ®
                    collection: {
                        myCollection: JSON.parse(localStorage.getItem('labubu_my_collection') || '{}'),
                        exchanges: JSON.parse(localStorage.getItem('labubu_exchanges') || '[]'),
                        wishlist: JSON.parse(localStorage.getItem('labubu_wishlist') || '[]')
                    },

                    // ç­¾åˆ°æ•°æ®
                    checkin: {
                        history: JSON.parse(localStorage.getItem('checkinHistory') || '{}'),
                        lastCheckin: localStorage.getItem('lastCheckin') || null,
                        streakDays: userData.streakDays
                    },

                    // æˆå°±æ•°æ®
                    achievements: {
                        data: JSON.parse(localStorage.getItem('userData_achievements') || '{}'),
                        unlocked: JSON.parse(localStorage.getItem('labubu_achievements') || '{}'),
                        progress: JSON.parse(localStorage.getItem('labubu_achievement_progress') || '{}')
                    },

                    // ä»»åŠ¡æ•°æ®
                    tasks: {
                        daily: JSON.parse(localStorage.getItem('labubu_daily_tasks') || '{}'),
                        weekly: JSON.parse(localStorage.getItem('labubu_weekly_tasks') || '{}'),
                        special: JSON.parse(localStorage.getItem('labubu_special_tasks') || '{}'),
                        completed: JSON.parse(localStorage.getItem('labubu_completed_tasks') || '[]')
                    },

                    // æ¸¸æˆæ•°æ®
                    games: {
                        scores: JSON.parse(localStorage.getItem('labubu_game_scores') || '{}'),
                        stats: JSON.parse(localStorage.getItem('labubu_game_stats') || '{}'),
                        achievements: JSON.parse(localStorage.getItem('labubu_game_achievements') || '{}')
                    },

                    // å•†åŸæ•°æ®
                    shop: {
                        cart: JSON.parse(localStorage.getItem('labubu_shopping_cart') || '[]'),
                        orders: JSON.parse(localStorage.getItem('labubu_orders') || '[]'),
                        favorites: JSON.parse(localStorage.getItem('labubu_shop_favorites') || '[]')
                    },

                    // ç”¨æˆ·è®¾ç½®
                    settings: {
                        soundEnabled: localStorage.getItem('labubu_ui_sound_enabled') !== 'false',
                        musicVolume: localStorage.getItem('labubu_music_volume') || '50',
                        notifications: localStorage.getItem('labubu_notifications') !== 'false',
                        theme: localStorage.getItem('labubu_theme') || 'light',
                        language: localStorage.getItem('labubu_language') || 'zh-CN'
                    },

                    // ç¤¾äº¤æ•°æ®
                    social: {
                        friends: JSON.parse(localStorage.getItem('labubu_friends') || '[]'),
                        messages: JSON.parse(localStorage.getItem('labubu_messages') || '[]'),
                        likes: JSON.parse(localStorage.getItem('labubu_likes') || '{}')
                    },

                    // ç³»ç»Ÿæ•°æ®
                    system: {
                        lastSync: new Date().toISOString(),
                        version: '3.0',
                        clientInfo: {
                            userAgent: navigator.userAgent,
                            platform: navigator.platform,
                            language: navigator.language,
                            timestamp: Date.now()
                        }
                    }
                };
            }

            // ä¸Šä¼ æ•°æ®åˆ°JSONBin.io
            async uploadToJsonBin(data) {
                try {
                    const config = DATA_STORAGE_CONFIG.jsonbin;
                    let url = `${config.baseUrl}/b`;
                    let method = 'POST';

                    // å¦‚æœå·²æœ‰binIdï¼Œä½¿ç”¨PUTæ›´æ–°
                    if (userDataBinId) {
                        url = `${config.baseUrl}/b/${userDataBinId}`;
                        method = 'PUT';
                    }

                    // å¦‚æœdataæ˜¯ç”¨æˆ·è¯¦ç»†æ•°æ®ï¼Œåˆ™æ”¶é›†å®Œæ•´æ•°æ®
                    let uploadData;
                    if (data && typeof data === 'object' && !data.system) {
                        // ä¼ å…¥çš„æ˜¯userDataå¯¹è±¡ï¼Œéœ€è¦åŒ…è£…æˆå®Œæ•´æ•°æ®ç»“æ„
                        uploadData = this.collectAllUserData();
                        uploadData.userData = data; // æ›´æ–°ç”¨æˆ·è¯¦ç»†æ•°æ®
                    } else {
                        // ä¼ å…¥çš„å·²ç»æ˜¯å®Œæ•´æ•°æ®ç»“æ„
                        uploadData = data || this.collectAllUserData();
                    }

                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': config.apiKey,
                            'X-Bin-Name': `labubu_user_${currentUser.uid}`
                        },
                        body: JSON.stringify(uploadData)
                    });

                    if (response.ok) {
                        const result = await response.json();

                        // ä¿å­˜binIdä»¥ä¾¿åç»­æ›´æ–°
                        if (result.metadata && result.metadata.id) {
                            userDataBinId = result.metadata.id;
                            localStorage.setItem('labubu_user_bin_id', userDataBinId);
                        }

                        console.log('ğŸ“¤ å®Œæ•´æ•°æ®å·²ä¸Šä¼ åˆ°JSONBin:', result);
                        return true;
                    } else {
                        console.error('ğŸ“¤ ä¸Šä¼ å¤±è´¥:', response.status, response.statusText);
                        return false;
                    }

                } catch (error) {
                    console.error('ğŸ“¤ ä¸Šä¼ è¿‡ç¨‹å‡ºé”™:', error);
                    return false;
                }
            }

            // ä»äº‘ç«¯ä¸‹è½½ç”¨æˆ·æ•°æ®
            async downloadUserData() {
                if (!userDataBinId) {
                    userDataBinId = localStorage.getItem('labubu_user_bin_id');
                }

                if (!userDataBinId) {
                    console.log('ğŸ“¥ æ²¡æœ‰äº‘ç«¯æ•°æ®IDï¼Œè·³è¿‡ä¸‹è½½');
                    return null;
                }

                try {
                    const config = DATA_STORAGE_CONFIG.jsonbin;
                    const response = await fetch(`${config.baseUrl}/b/${userDataBinId}/latest`, {
                        method: 'GET',
                        headers: {
                            'X-Master-Key': config.apiKey
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const cloudData = result.record;

                        if (cloudData && cloudData.userData) {
                            // åŒæ­¥å…¶ä»–æ•°æ®åˆ°æœ¬åœ°
                            if (cloudData.history) {
                                localStorage.setItem('labubu_history', JSON.stringify(cloudData.history));
                            }
                            if (cloudData.collection) {
                                localStorage.setItem('labubu_my_collection', JSON.stringify(cloudData.collection));
                            }
                            if (cloudData.exchanges) {
                                localStorage.setItem('labubu_exchanges', JSON.stringify(cloudData.exchanges));
                            }
                            if (cloudData.checkinHistory) {
                                localStorage.setItem('checkinHistory', JSON.stringify(cloudData.checkinHistory));
                            }

                            console.log('ğŸ“¥ ä»äº‘ç«¯ä¸‹è½½æ•°æ®æˆåŠŸ');
                            return cloudData.userData;
                        }
                    } else {
                        console.error('ğŸ“¥ ä¸‹è½½å¤±è´¥:', response.status, response.statusText);
                    }
                } catch (error) {
                    console.error('ğŸ“¥ ä¸‹è½½è¿‡ç¨‹å‡ºé”™:', error);
                }

                return null;
            }

            // åŠ è½½æŠ½å¥–å†å²
            loadHistory() {
                try {
                    return JSON.parse(localStorage.getItem('labubu_history') || '[]');
                } catch (error) {
                    console.error('åŠ è½½æŠ½å¥–å†å²å¤±è´¥:', error);
                    return [];
                }
            }

            // ä¸Šä¼ å¤´åƒ
            async uploadAvatar(file) {
                if (!storage || !currentUser) {
                    // å¦‚æœæ²¡æœ‰Firebaseï¼Œä½¿ç”¨Base64å­˜å‚¨åˆ°æœ¬åœ°
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            userData.avatar = e.target.result;
                            resolve(e.target.result);
                        };
                        reader.readAsDataURL(file);
                    });
                }

                try {
                    const storageRef = storage.ref(`avatars/${currentUser.uid}`);
                    const snapshot = await storageRef.put(file);
                    const downloadURL = await snapshot.ref.getDownloadURL();

                    userData.avatar = downloadURL;
                    return downloadURL;
                } catch (error) {
                    console.error('å¤´åƒä¸Šä¼ å¤±è´¥:', error);
                    throw error;
                }
            }

            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showSuccess(message) {
                this.showNotification(message, 'success');
            }

            // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
            showError(message) {
                this.showNotification(message, 'error');
            }

            // æ˜¾ç¤ºé€šçŸ¥
            showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
                notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-xl z-50 transform translate-x-full transition-transform duration-300`;
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.transform = 'translateX(0)';
                }, 100);

                setTimeout(() => {
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (document.body.contains(notification)) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }

            // åˆå§‹åŒ–è®¤è¯äº‹ä»¶ç›‘å¬
            initAuthListeners() {
                // å…³é—­è®¤è¯æ¨¡æ€æ¡†
                $('#closeAuthModal').addEventListener('click', () => {
                    this.hideAuthModal();
                });

                // å‘é€éªŒè¯ç 
                $('#sendCodeBtn').addEventListener('click', async () => {
                    await this.sendVerificationCode();
                });

                // éªŒè¯ç ç™»å½•
                $('#verifyCodeBtn').addEventListener('click', async () => {
                    await this.verifyCode();
                });

                // è¿”å›æ‰‹æœºå·è¾“å…¥
                $('#backToPhoneBtn').addEventListener('click', () => {
                    this.backToPhoneInput();
                });

                // é‡æ–°å‘é€éªŒè¯ç 
                $('#resendCodeBtn').addEventListener('click', () => {
                    this.resendVerificationCode();
                });

                // é€€å‡ºç™»å½•
                $('#logoutBtn').addEventListener('click', () => {
                    if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                        this.logout();
                    }
                });
            }

            // åˆå§‹åŒ–ä¸ªäººèµ„æ–™äº‹ä»¶ç›‘å¬
            initProfileListeners() {
                // æ‰“å¼€ç¼–è¾‘èµ„æ–™æ¨¡æ€æ¡†
                $('#editProfileBtn').addEventListener('click', () => {
                    if (isLoggedIn) {
                        this.showEditProfileModal();
                    } else {
                        this.showAuthModal();
                    }
                });

                // å¤´åƒç‚¹å‡»ç¼–è¾‘
                $('#avatarContainer').addEventListener('click', () => {
                    if (isLoggedIn) {
                        this.showEditProfileModal();
                    } else {
                        this.showAuthModal();
                    }
                });

                // å…³é—­ç¼–è¾‘èµ„æ–™æ¨¡æ€æ¡†
                $('#closeProfileModal').addEventListener('click', () => {
                    this.hideEditProfileModal();
                });

                $('#cancelProfile').addEventListener('click', () => {
                    this.hideEditProfileModal();
                });

                // å¤´åƒä¸Šä¼ 
                $('#uploadAvatarBtn').addEventListener('click', () => {
                    $('#avatarUpload').click();
                });

                $('#avatarPreview').addEventListener('click', () => {
                    $('#avatarUpload').click();
                });

                $('#avatarUpload').addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        await this.handleAvatarUpload(file);
                    }
                });

                // ä¸ªäººèµ„æ–™è¡¨å•æäº¤
                $('#profileForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.handleProfileUpdate();
                });
            }

            // æ˜¾ç¤ºç¼–è¾‘èµ„æ–™æ¨¡æ€æ¡†
            showEditProfileModal() {
                // å¡«å……å½“å‰æ•°æ®
                $('#profileName').value = userData.name;
                $('#profileBio').value = userData.bio || '';
                $('#profileSignature').value = userData.signature || '';
                $('#profileBirthday').value = userData.birthday || '';

                // è®¾ç½®å¤´åƒé¢„è§ˆ
                this.updateAvatarPreview(userData.avatar);

                this.editProfileModal.classList.remove('hidden');
            }

            // éšè—ç¼–è¾‘èµ„æ–™æ¨¡æ€æ¡†
            hideEditProfileModal() {
                this.editProfileModal.classList.add('hidden');
            }

            // å¤„ç†å¤´åƒä¸Šä¼ 
            async handleAvatarUpload(file) {
                if (file.size > 2 * 1024 * 1024) {
                    this.showError('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡2MB');
                    return;
                }

                try {
                    const avatarUrl = await this.uploadAvatar(file);
                    this.updateAvatarPreview(avatarUrl);
                    this.showSuccess('å¤´åƒä¸Šä¼ æˆåŠŸï¼');
                } catch (error) {
                    this.showError('å¤´åƒä¸Šä¼ å¤±è´¥: ' + error.message);
                }
            }

            // æ›´æ–°å¤´åƒé¢„è§ˆ
            updateAvatarPreview(avatarUrl) {
                const preview = $('#avatarPreview');
                const userAvatar = $('#userAvatar');

                if (avatarUrl) {
                    const img = `<img src="${avatarUrl}" alt="å¤´åƒ" class="w-full h-full object-cover">`;
                    preview.innerHTML = img;
                    userAvatar.innerHTML = img;
                } else {
                    preview.innerHTML = 'ğŸ§¸';
                    userAvatar.innerHTML = 'ğŸ§¸';
                }
            }

            // å¤„ç†ä¸ªäººèµ„æ–™æ›´æ–°
            async handleProfileUpdate() {
                userData.name = $('#profileName').value;
                userData.bio = $('#profileBio').value;
                userData.signature = $('#profileSignature').value;
                userData.birthday = $('#profileBirthday').value;

                try {
                    await this.saveUserData();
                    renderUserData();
                    this.hideEditProfileModal();
                } catch (error) {
                    this.showError('ä¿å­˜å¤±è´¥: ' + error.message);
                }
            }

            // éªŒè¯æ‰‹æœºå·æ ¼å¼
            validatePhoneNumber(phoneNumber, countryCode) {
                $('#phoneError').classList.add('hidden');

                if (!phoneNumber) {
                    this.showPhoneError('è¯·è¾“å…¥æ‰‹æœºå·');
                    return false;
                }

                // åŸºæœ¬æ ¼å¼éªŒè¯
                const phoneRegex = /^[0-9]{7,15}$/;
                if (!phoneRegex.test(phoneNumber)) {
                    this.showPhoneError('æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®');
                    return false;
                }

                // é’ˆå¯¹ä¸åŒå›½å®¶çš„ç‰¹æ®ŠéªŒè¯
                if (countryCode === '+86') {
                    if (!/^1[3-9]\d{9}$/.test(phoneNumber)) {
                        this.showPhoneError('è¯·è¾“å…¥æ­£ç¡®çš„ä¸­å›½å¤§é™†æ‰‹æœºå·');
                        return false;
                    }
                }

                return true;
            }

            // æ˜¾ç¤ºæ‰‹æœºå·é”™è¯¯
            showPhoneError(message) {
                const errorEl = $('#phoneError');
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
            }

            // æ˜¾ç¤ºéªŒè¯ç é”™è¯¯
            showCodeError(message) {
                const errorEl = $('#codeError');
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
            }

            // å¼€å§‹å€’è®¡æ—¶
            startCountdown() {
                let countdown = 60;
                const btn = $('#resendCodeBtn');
                const countdownEl = $('#countdown');

                btn.disabled = true;

                const timer = setInterval(() => {
                    countdown--;
                    countdownEl.textContent = countdown;

                    if (countdown <= 0) {
                        clearInterval(timer);
                        btn.disabled = false;
                        btn.innerHTML = 'é‡æ–°å‘é€';
                    }
                }, 1000);
            }

            // è¿”å›æ‰‹æœºå·è¾“å…¥
            backToPhoneInput() {
                $('#codeInputStep').classList.add('hidden');
                $('#phoneInputStep').classList.remove('hidden');
                $('#sendCodeBtn').disabled = false;
                $('#sendCodeBtn').textContent = 'ğŸ“¤ å‘é€éªŒè¯ç ';
            }

            // é‡æ–°å‘é€éªŒè¯ç 
            resendVerificationCode() {
                this.backToPhoneInput();
            }

            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            checkLoginStatus() {
                try {
                    const savedAuth = localStorage.getItem('labubu_user_auth');
                    if (savedAuth) {
                        currentUser = JSON.parse(savedAuth);
                        isAuthenticated = true;
                        isLoggedIn = true;

                        console.log('ğŸ“± å‘ç°å·²ä¿å­˜çš„ç™»å½•çŠ¶æ€:', currentUser.phoneNumber);
                        this.updateUIForAuthState(currentUser);

                        // åŠ è½½ç”¨æˆ·æ•°æ®
                        this.loadUserData(currentUser.uid);
                    } else {
                        this.loadLocalData();
                    }
                } catch (error) {
                    console.error('ğŸ“± æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                    // æ¸…é™¤æŸåçš„æ•°æ®
                    localStorage.removeItem('labubu_user_auth');
                    localStorage.removeItem('labubu_user_bin_id');
                    this.loadLocalData();
                }
            }

            // é‡ç½®ç™»å½•è¡¨å•
            resetLoginForm() {
                // é‡ç½®åˆ°æ‰‹æœºå·è¾“å…¥æ­¥éª¤
                $('#phoneInputStep').classList.remove('hidden');
                $('#codeInputStep').classList.add('hidden');
                $('#loginLoading').classList.add('hidden');

                // æ¸…ç©ºè¾“å…¥
                $('#phoneNumber').value = '';
                $('#verificationCode').value = '';

                // æ¸…ç©ºé”™è¯¯ä¿¡æ¯
                $('#phoneError').classList.add('hidden');
                $('#codeError').classList.add('hidden');

                // é‡ç½®æŒ‰é’®çŠ¶æ€
                $('#sendCodeBtn').disabled = false;
                $('#verifyCodeBtn').disabled = false;
                $('#sendCodeBtn').textContent = 'ğŸ“¤ å‘é€éªŒè¯ç ';
                $('#verifyCodeBtn').textContent = 'âœ… éªŒè¯ç™»å½•';

                pendingPhoneNumber = null;
            }
        }

        // åˆ›å»ºç”¨æˆ·ç®¡ç†å®ä¾‹
        const userManager = new UserManager();

        // åˆå§‹åŒ–
        function init() {
            renderUserData();
            renderAchievements();
            renderCollection();
            renderRecentPrizes();
            renderCalendar();
            initEventListeners();
            initCustomCursor();
        }

        // æ¸²æŸ“ç”¨æˆ·æ•°æ®
        function renderUserData() {
            $('#userName').textContent = userData.name;
            $('#userLevel').textContent = userData.level;
            $('#joinDays').textContent = userData.joinDays;
            $('#totalDraws').textContent = userData.totalDraws;
            $('#totalPrizes').textContent = userData.totalPrizes;
            $('#rarityScore').textContent = userData.rarityScore.toLocaleString();
            $('#streakDays').textContent = userData.streakDays + 'å¤©';
            $('#luckyRate').textContent = userData.luckyRate + '%';
            $('#expNeeded').textContent = `${userData.exp}/${userData.maxExp} EXP`;

            // æ›´æ–°è¿›åº¦æ¡
            const progressBar = $('.level-progress');
            if (progressBar) {
                progressBar.style.width = (userData.exp / userData.maxExp * 100) + '%';
            }

            // æ›´æ–°å¤´åƒæ˜¾ç¤º
            userManager.updateAvatarPreview(userData.avatar);

            // æ›´æ–°ç§¯åˆ†æ˜¾ç¤ºï¼ˆå¦‚æœé¡µé¢ä¸­æœ‰ç§¯åˆ†å…ƒç´ ï¼‰
            const pointsElements = document.querySelectorAll('.user-points, #userPoints');
            pointsElements.forEach(el => {
                if (el) el.textContent = userData.points || 100;
            });

            console.log('ğŸ¯ ç”¨æˆ·æ•°æ®æ¸²æŸ“å®Œæˆ:', {
                level: userData.level,
                exp: userData.exp,
                totalDraws: userData.totalDraws,
                totalPrizes: userData.totalPrizes,
                points: userData.points,
                streakDays: userData.streakDays
            });
        }

        // æ¸²æŸ“æˆå°±
        function renderAchievements() {
            const grid = $('#achievementGrid');
            const unlockedCount = achievements.filter(a => a.unlocked).length;

            $('#achievementCount').textContent = `${unlockedCount}/${achievements.length} å·²è§£é”`;

            grid.innerHTML = achievements.map(achievement => `
                <div class="achievement-badge ${achievement.unlocked ? 'achievement-unlocked' : 'achievement-locked'} 
                           w-16 h-16 rounded-2xl flex flex-col items-center justify-center text-center p-2"
                     title="${achievement.name}: ${achievement.description}">
                    <div class="text-2xl">${achievement.icon}</div>
                    <div class="text-xs font-medium mt-1">${achievement.name}</div>
                </div>
            `).join('');
        }

        // æ¸²æŸ“æ”¶è—å†Œ
        function renderCollection() {
            const grid = $('#collectionGrid');
            const ownedCount = collections.filter(c => c.owned).length;

            $('#collectionCount').textContent = `${ownedCount}/${collections.length} å·²æ”¶é›†`;

            grid.innerHTML = collections.map(item => `
                <div class="collection-item ${item.owned ? 'owned' : 'not-owned'} 
                           bg-slate-50 rounded-xl p-3 text-center border ${getRarityBorder(item.rarity)}"
                     title="${item.name} - ${getRarityName(item.rarity)}">
                    <div class="text-3xl mb-1">${item.emoji}</div>
                    <div class="text-xs font-medium">${item.name}</div>
                    <div class="text-xs text-slate-500 mt-1">${getRarityName(item.rarity)}</div>
                </div>
            `).join('');
        }

        // è·å–ç¨€æœ‰åº¦åç§°
        function getRarityName(rarity) {
            const names = {
                'common': 'æ™®é€š',
                'rare': 'ç¨€æœ‰',
                'epic': 'å²è¯—',
                'legendary': 'ä¼ è¯´',
                'mythic': 'ç¥è¯'
            };
            return names[rarity] || 'æœªçŸ¥';
        }

        // è·å–ç¨€æœ‰åº¦è¾¹æ¡†
        function getRarityBorder(rarity) {
            const borders = {
                'common': 'border-slate-300',
                'rare': 'border-blue-400',
                'epic': 'border-purple-400',
                'legendary': 'border-yellow-400',
                'mythic': 'border-red-400'
            };
            return borders[rarity] || 'border-slate-300';
        }

        // æ¸²æŸ“æœ€è¿‘å¥–å“
        function renderRecentPrizes() {
            const container = $('#recentPrizes');

            container.innerHTML = recentPrizes.map(prize => `
                <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl">
                    <div class="text-2xl">${prize.emoji}</div>
                    <div class="flex-1">
                        <div class="font-medium">${prize.name}</div>
                        <div class="text-sm text-slate-500">${getRarityName(prize.rarity)} â€¢ ${prize.time}</div>
                    </div>
                </div>
            `).join('');
        }

        // æ¸²æŸ“ç­¾åˆ°æ—¥å†
        function renderCalendar() {
            const grid = $('#calendarGrid');
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();

            // è·å–ç­¾åˆ°è®°å½•
            const checkinHistory = JSON.parse(localStorage.getItem('checkinHistory') || '{}');
            const todayString = today.toDateString();
            const lastCheckin = localStorage.getItem('lastCheckin');

            let html = '';
            let signedCount = 0;

            // å¡«å……ç©ºç™½æ—¥æœŸ
            for (let i = 0; i < firstDay; i++) {
                html += '<div></div>';
            }

            // å¡«å……å®é™…æ—¥æœŸ
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateString = date.toDateString();
                const isToday = day === today.getDate();
                const isSigned = checkinHistory[dateString] || (dateString === lastCheckin);

                if (isSigned) signedCount++;

                html += `
                    <div class="calendar-day w-8 h-8 rounded-lg flex items-center justify-center text-sm font-medium
                               ${isToday ? 'today' : ''} ${isSigned ? 'signed' : 'bg-slate-100'}">
                        ${day}
                    </div>
                `;
            }

            grid.innerHTML = html;

            // æ›´æ–°ç­¾åˆ°ç»Ÿè®¡
            $('#monthlyCheckins').textContent = signedCount;
        }

        // é¡µé¢è¿‡æ¸¡åŠ¨ç”»åŠŸèƒ½
        function initPageTransitions() {
            $$('.page-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const href = link.getAttribute('href');
                    showPageTransition(() => {
                        window.location.href = href;
                    });
                });
            });
        }

        function showPageTransition(callback) {
            const overlay = $('#pageTransitionOverlay');
            overlay.classList.add('active');

            setTimeout(() => {
                if (callback) callback();
            }, 800);
        }

        function hidePageTransition() {
            const overlay = $('#pageTransitionOverlay');
            overlay.classList.remove('active');
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        function initEventListeners() {
            // æ¯æ—¥ç­¾åˆ°æŒ‰é’®
            $('#dailyCheckinBtn').addEventListener('click', () => {
                performDailyCheckin();
            });

            // å¿«é€Ÿæ“ä½œæŒ‰é’®
            $$('.enhanced-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.textContent.includes('ç«‹å³æŠ½å¥–')) {
                        showPageTransition(() => {
                            window.location.href = 'index.html#draw';
                        });
                    } else if (btn.textContent.includes('å‰å¾€å•†åŸ')) {
                        showPageTransition(() => {
                            window.location.href = 'shop.html';
                        });
                    } else if (btn.textContent.includes('æŸ¥çœ‹ä»»åŠ¡')) {
                        showPageTransition(() => {
                            window.location.href = 'tasks.html';
                        });
                    } else if (btn.textContent.includes('å°æ¸¸æˆ')) {
                        showPageTransition(() => {
                            window.location.href = 'games.html';
                        });
                    }
                });
            });

            // æˆå°±æ‚¬æµ®æ•ˆæœ
            $$('.achievement-badge').forEach(badge => {
                badge.addEventListener('mouseenter', () => {
                    createMagicParticles(badge.getBoundingClientRect().left + 32, badge.getBoundingClientRect().top + 32);
                });
            });
        }

        // æ‰§è¡Œæ¯æ—¥ç­¾åˆ°
        async function performDailyCheckin() {
            // æ£€æŸ¥ä»Šæ—¥æ˜¯å¦å·²ç­¾åˆ°
            const today = new Date().toDateString();
            const lastCheckin = localStorage.getItem('lastCheckin');

            if (lastCheckin === today) {
                userManager.showError('ä»Šæ—¥å·²ç­¾åˆ°ï¼Œè¯·æ˜å¤©å†æ¥ï¼');
                return;
            }

            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            if (!isLoggedIn || !currentUser) {
                userManager.showError('è¯·å…ˆç™»å½•åå†ç­¾åˆ°');
                userManager.showAuthModal();
                return;
            }

            // æ›´æ–°ç”¨æˆ·ç»éªŒå’Œç§¯åˆ†
            userData.exp += 10;
            userData.points += 5; // ç­¾åˆ°å¥–åŠ±5ç§¯åˆ†
            userData.streakDays += 1;

            let leveledUp = false;
            if (userData.exp >= userData.maxExp) {
                userData.level++;
                userData.exp = userData.exp - userData.maxExp;
                userData.maxExp = Math.floor(userData.maxExp * 1.2);
                leveledUp = true;
            }

            // ä¿å­˜ç­¾åˆ°è®°å½•
            localStorage.setItem('lastCheckin', today);

            // ä¿å­˜åˆ°ç­¾åˆ°å†å²
            const checkinHistory = JSON.parse(localStorage.getItem('checkinHistory') || '{}');
            checkinHistory[today] = true;
            localStorage.setItem('checkinHistory', JSON.stringify(checkinHistory));

            // æ›´æ–°æœ¬åœ°ç§¯åˆ†å­˜å‚¨
            localStorage.setItem('labubu_user_points', userData.points.toString());

            // ä¿å­˜ç”¨æˆ·æ•°æ®åˆ°äº‘ç«¯
            try {
                await userManager.saveUserData();
                console.log('âœ… ç­¾åˆ°æ•°æ®å·²åŒæ­¥åˆ°äº‘ç«¯');
            } catch (error) {
                console.error('ä¿å­˜ç­¾åˆ°æ•°æ®å¤±è´¥:', error);
            }

            // æ˜¾ç¤ºç­¾åˆ°æˆåŠŸæç¤º
            userManager.showSuccess('âœ… ç­¾åˆ°æˆåŠŸï¼è·å¾— 10 EXP + 5 ç§¯åˆ†');

            // å¦‚æœå‡çº§äº†ï¼Œæ˜¾ç¤ºå‡çº§æç¤º
            if (leveledUp) {
                setTimeout(() => {
                    const levelUp = document.createElement('div');
                    levelUp.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
                    levelUp.innerHTML = `
                        <div class="bg-white rounded-3xl p-8 text-center animate-bounce">
                            <div class="text-6xl mb-4">ğŸ‰</div>
                            <div class="text-2xl font-bold text-[var(--labu)] mb-2">æ­å–œå‡çº§ï¼</div>
                            <div class="text-lg">æ‚¨ç°åœ¨æ˜¯ Lv.${userData.level} äº†ï¼</div>
                            <div class="text-sm text-slate-500 mt-2">è·å¾—å‡çº§å¥–åŠ±ï¼š20 ç§¯åˆ†</div>
                        </div>
                    `;
                    document.body.appendChild(levelUp);

                    // å‡çº§å¥–åŠ±ç§¯åˆ†
                    userData.points += 20;
                    localStorage.setItem('labubu_user_points', userData.points.toString());

                    setTimeout(() => {
                        if (document.body.contains(levelUp)) {
                            document.body.removeChild(levelUp);
                        }
                    }, 3000);
                }, 1000);
            }

            renderUserData();
            renderCalendar(); // é‡æ–°æ¸²æŸ“æ—¥å†ä»¥æ˜¾ç¤ºä»Šæ—¥ç­¾åˆ°
        }

        // è‡ªå®šä¹‰é¼ æ ‡æ•ˆæœ
        function initCustomCursor() {
            const cursor = $('.custom-cursor');
            let mouseX = 0, mouseY = 0;

            document.addEventListener('mousemove', (e) => {
                mouseX = e.clientX;
                mouseY = e.clientY;
                cursor.style.left = mouseX + 'px';
                cursor.style.top = mouseY + 'px';

                createCursorTrail(mouseX, mouseY);
            });

            document.addEventListener('mousedown', () => {
                cursor.classList.add('clicking');
            });

            document.addEventListener('mouseup', () => {
                cursor.classList.remove('clicking');
            });
        }

        function createCursorTrail(x, y) {
            const trail = document.createElement('div');
            trail.className = 'cursor-trail';
            trail.style.left = (x - 4) + 'px';
            trail.style.top = (y - 4) + 'px';
            document.body.appendChild(trail);

            setTimeout(() => {
                if (document.body.contains(trail)) {
                    document.body.removeChild(trail);
                }
            }, 500);
        }

        function createMagicParticles(x, y) {
            for (let i = 0; i < 6; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'magic-particle';
                    particle.style.left = (x + Math.random() * 40 - 20) + 'px';
                    particle.style.top = (y + Math.random() * 40 - 20) + 'px';
                    document.body.appendChild(particle);

                    setTimeout(() => {
                        if (document.body.contains(particle)) {
                            document.body.removeChild(particle);
                        }
                    }, 2000);
                }, i * 50);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>

    <!-- é¡µé¢è¿‡æ¸¡åŠ¨ç”» -->
    <script src="page-transition-fix.js"></script>
</body>

</html>