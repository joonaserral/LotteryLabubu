<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人中心 - Labubu 幸运抽奖 🧸</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🧸</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <style>
        :root {
            --labu: #6b5b95;
            --labu2: #ffcc00;
        }

        .labu-gradient {
            background-image: linear-gradient(135deg, rgba(107, 91, 149, .15), rgba(255, 204, 0, .15));
        }

        .sparkle {
            animation: sparkle 2s ease-in-out infinite alternate;
        }

        @keyframes sparkle {
            0% {
                transform: scale(1) rotate(0deg);
            }

            100% {
                transform: scale(1.1) rotate(5deg);
            }
        }

        /* 自定义鼠标样式 - 增加备用方案 */
        body.custom-cursor-enabled * {
            cursor: none !important;
        }

        /* 默认保留系统光标，直到自定义光标成功加载 */
        body:not(.custom-cursor-enabled) * {
            cursor: auto;
        }

        /* 恢复文本输入元素的光标 */
        input,
        textarea,
        [contenteditable="true"],
        .text-input {
            cursor: text !important;
        }

        /* 恢复可点击元素的光标 */
        button,
        a,
        [role="button"],
        .cursor-pointer,
        select {
            cursor: pointer !important;
        }

        /* 光标回退选项 */
        body.cursor-fallback * {
            cursor: auto !important;
        }

        body.cursor-fallback input,
        body.cursor-fallback textarea,
        body.cursor-fallback [contenteditable="true"] {
            cursor: text !important;
        }

        body.cursor-fallback button,
        body.cursor-fallback a,
        body.cursor-fallback [role="button"],
        body.cursor-fallback select {
            cursor: pointer !important;
        }

        .custom-cursor {
            position: fixed;
            width: 20px;
            height: 20px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ff69b4"><path d="M8 2C8 2 8.5 3 10.5 3C12.5 3 13 2 13 2C14 2 15 3 15 4C15 5 14 6 13 6C12 6 11 7 11 8C11 9 12 10 13 10C14 10 15 9 15 8C15 7 16 6 17 6C18 6 19 7 19 8C19 9 18 10 17 10C16 10 15 11 15 12C15 13 16 14 17 14C18 14 19 13 19 12C19 11 20 10 21 10C22 10 23 11 23 12C23 13 22 14 21 14C20 14 19 15 19 16C19 17 18 18 17 18C16 18 15 17 15 16C15 15 14 14 13 14C12 14 11 15 11 16C11 17 10 18 9 18C8 18 7 17 7 16C7 15 8 14 9 14C10 14 11 13 11 12C11 11 10 10 9 10C8 10 7 11 7 12C7 13 6 14 5 14C4 14 3 13 3 12C3 11 4 10 5 10C6 10 7 9 7 8C7 7 6 6 5 6C4 6 3 7 3 8C3 9 2 10 1 10C0 10 -1 9 -1 8C-1 7 0 6 1 6C2 6 3 5 3 4C3 3 4 2 5 2C6 2 7 3 7 4C7 5 8 6 9 6C10 6 11 5 11 4C11 3 10 2 9 2C8.5 2 8 2 8 2Z"/></svg>') no-repeat center;
            background-size: contain;
            pointer-events: none;
            z-index: 9999;
            transition: transform 0.1s ease;
            transform: translate(-50%, -50%);
        }

        .custom-cursor.clicking {
            transform: translate(-50%, -50%) scale(1.2);
        }

        .cursor-trail {
            position: fixed;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, rgba(255, 105, 180, 0.8) 0%, rgba(255, 105, 180, 0) 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9998;
            animation: cursorTrailFade 0.5s ease-out forwards;
        }

        @keyframes cursorTrailFade {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            100% {
                opacity: 0;
                transform: scale(0.3);
            }
        }

        /* 等级进度条 */
        .level-progress {
            background: linear-gradient(90deg, var(--labu) 0%, var(--labu2) 100%);
            height: 8px;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* 成就徽章 */
        .achievement-badge {
            transition: all 0.3s ease;
        }

        .achievement-badge:hover {
            transform: scale(1.1) rotate(5deg);
        }

        .achievement-unlocked {
            background: linear-gradient(45deg, #ffd700, #ffed4a);
            color: #8b5a00;
        }

        .achievement-locked {
            background: #e2e8f0;
            color: #64748b;
        }

        /* 统计卡片动画 */
        .stat-card {
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
        }

        /* 签到日历 */
        .calendar-day {
            transition: all 0.3s ease;
        }

        .calendar-day.signed {
            background: linear-gradient(45deg, var(--labu), var(--labu2));
            color: white;
        }

        .calendar-day.today {
            border: 2px solid var(--labu);
            box-shadow: 0 0 10px rgba(107, 91, 149, 0.3);
        }

        /* 按钮增强效果 */
        .enhanced-btn {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .enhanced-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .enhanced-btn:hover::before {
            left: 100%;
        }

        .enhanced-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(107, 91, 149, 0.3);
        }

        /* 收藏品展示 */
        .collection-item {
            transition: all 0.3s ease;
            position: relative;
        }

        .collection-item:hover {
            transform: scale(1.05);
        }

        .collection-item.owned {
            opacity: 1;
        }

        .collection-item.not-owned {
            opacity: 0.3;
            filter: grayscale(100%);
        }

        /* 页面过渡动画 */
        .page-transition-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(107, 91, 149, 0.9), rgba(255, 204, 0, 0.9));
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .page-transition-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .page-transition-content {
            text-align: center;
            color: white;
            transform: translateY(20px);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .page-transition-overlay.active .page-transition-content {
            transform: translateY(0);
        }

        .transition-loader {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* 粒子效果 */
        .magic-particle {
            position: fixed;
            width: 4px;
            height: 4px;
            background: radial-gradient(circle, #ffd700 0%, #ff69b4 50%, transparent 100%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9997;
            animation: magicParticle 2s ease-out forwards;
        }

        @keyframes magicParticle {
            0% {
                opacity: 1;
                transform: scale(0) rotate(0deg);
            }

            50% {
                opacity: 1;
                transform: scale(1) rotate(180deg);
            }

            100% {
                opacity: 0;
                transform: scale(0.2) rotate(360deg) translateY(-50px);
            }
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900">
    <!-- 页面过渡动画覆盖层 -->
    <div id="pageTransitionOverlay" class="page-transition-overlay">
        <div class="page-transition-content">
            <div class="transition-loader"></div>
            <h3 class="text-2xl font-bold mb-2">🧸 正在跳转...</h3>
            <p class="text-lg opacity-90">请稍候，即将为您加载精彩内容</p>
        </div>
    </div>

    <!-- 自定义鼠标光标 -->
    <div class="custom-cursor"></div>

    <!-- 光标切换按钮 -->
    <button id="cursorToggle"
        class="fixed bottom-4 left-4 z-50 w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full shadow-lg flex items-center justify-center text-white text-lg hover:scale-110 transition-transform duration-200"
        title="切换光标模式" onclick="if(window.toggleCursorMode) window.toggleCursorMode()">
        🖱️
    </button>

    <!-- 顶部导航 -->
    <header class="sticky top-0 z-30 backdrop-blur bg-white/90 border-b border-slate-200 shadow-sm">
        <div class="max-w-6xl mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 rounded-xl bg-[var(--labu)] grid place-content-center text-white text-xl sparkle">
                        🧸</div>
                    <div>
                        <h1 class="font-bold text-lg">个人中心</h1>
                        <p class="text-xs text-slate-500">Labubu 收集家 ✨</p>
                    </div>
                </div>
                <nav class="flex items-center gap-6">
                    <a href="index.html" class="text-slate-600 hover:text-[var(--labu)] transition-colors page-link">🎯
                        抽奖</a>
                    <a href="shop.html" class="text-slate-600 hover:text-[var(--labu)] transition-colors page-link">🛒
                        商城</a>
                    <a href="tasks.html" class="text-slate-600 hover:text-[var(--labu)] transition-colors page-link">📋
                        任务</a>
                    <a href="games.html" class="text-slate-600 hover:text-[var(--labu)] transition-colors page-link">🎮
                        游戏</a>
                    <a href="achievements.html"
                        class="text-slate-600 hover:text-[var(--labu)] transition-colors page-link">🏆 成就</a>
                </nav>
            </div>
        </div>
    </header>

    <div class="max-w-6xl mx-auto px-4 py-8">
        <!-- 用户信息卡片 -->
        <section class="labu-gradient rounded-3xl p-8 mb-8">
            <div class="flex items-center gap-6">
                <div class="relative group cursor-pointer" id="avatarContainer">
                    <div class="w-24 h-24 rounded-2xl bg-white/80 grid place-content-center text-4xl sparkle overflow-hidden"
                        id="userAvatar">
                        🧸
                    </div>
                    <div
                        class="absolute inset-0 bg-black/50 rounded-2xl flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                        <span class="text-white text-xs">点击编辑</span>
                    </div>
                </div>
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                        <h2 class="text-2xl font-bold" id="userName">Labubu收集家</h2>
                        <div class="px-3 py-1 bg-[var(--labu)] text-white rounded-full text-sm font-medium">
                            Lv.<span id="userLevel">5</span>
                        </div>
                    </div>
                    <p class="text-slate-600 mb-3">已加入 <span id="joinDays">127</span> 天 | 今日活跃度 <span
                            class="text-[var(--labu)] font-semibold">85%</span></p>

                    <!-- 等级进度条 -->
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-1">
                            <span>距离下一级还需</span>
                            <span id="expNeeded">350/1000 EXP</span>
                        </div>
                        <div class="w-full bg-white/50 rounded-full h-2">
                            <div class="level-progress w-1/3"></div>
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <button id="editProfileBtn" class="enhanced-btn px-4 py-2 bg-white/80 rounded-xl font-medium">✏️
                            编辑资料</button>
                        <button id="dailyCheckinBtn"
                            class="enhanced-btn px-4 py-2 bg-[var(--labu)] text-white rounded-xl font-medium">🎁
                            每日签到</button>
                        <button id="logoutBtn"
                            class="enhanced-btn px-4 py-2 bg-red-500 text-white rounded-xl font-medium hidden">🚪
                            退出登录</button>
                    </div>

                    <!-- 用户状态指示器 -->
                    <div class="flex items-center gap-2 mt-2">
                        <div id="userStatus" class="w-3 h-3 bg-gray-400 rounded-full"></div>
                        <span id="userStatusText" class="text-sm text-gray-600">未登录</span>
                    </div>
                </div>

                <!-- 今日运势 -->
                <div class="text-center bg-white/80 rounded-2xl p-4">
                    <div class="text-3xl mb-2">🔮</div>
                    <div class="text-sm font-medium mb-1">今日运势</div>
                    <div class="text-2xl font-bold text-[var(--labu)]" id="luckyRate">87%</div>
                    <div class="text-xs text-slate-600">抽奖大吉！</div>
                </div>
            </div>
        </section>

        <div class="grid md:grid-cols-3 gap-6">
            <!-- 左侧 - 统计信息 -->
            <div class="md:col-span-1 space-y-6">
                <!-- 个人统计 -->
                <div class="bg-white rounded-3xl p-6 shadow-sm">
                    <h3 class="font-semibold mb-4 flex items-center gap-2">
                        📊 个人统计
                    </h3>
                    <div class="space-y-4">
                        <div class="stat-card flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                            <div class="flex items-center gap-3">
                                <div class="text-2xl">🎯</div>
                                <div>
                                    <div class="text-sm text-slate-600">总抽奖次数</div>
                                    <div class="font-semibold" id="totalDraws">156</div>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                            <div class="flex items-center gap-3">
                                <div class="text-2xl">🏆</div>
                                <div>
                                    <div class="text-sm text-slate-600">获得奖品</div>
                                    <div class="font-semibold" id="totalPrizes">89</div>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                            <div class="flex items-center gap-3">
                                <div class="text-2xl">💎</div>
                                <div>
                                    <div class="text-sm text-slate-600">稀有度总分</div>
                                    <div class="font-semibold" id="rarityScore">2,345</div>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                            <div class="flex items-center gap-3">
                                <div class="text-2xl">🔥</div>
                                <div>
                                    <div class="text-sm text-slate-600">连续签到</div>
                                    <div class="font-semibold" id="streakDays">23天</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 快速操作 -->
                <div class="bg-white rounded-3xl p-6 shadow-sm">
                    <h3 class="font-semibold mb-4 flex items-center gap-2">
                        ⚡ 快速操作
                    </h3>
                    <div class="space-y-3">
                        <button
                            class="enhanced-btn w-full p-3 bg-[var(--labu)] text-white rounded-xl flex items-center justify-center gap-2">
                            🎯 立即抽奖
                        </button>
                        <button
                            class="enhanced-btn w-full p-3 bg-slate-100 rounded-xl flex items-center justify-center gap-2">
                            🛒 前往商城
                        </button>
                        <button
                            class="enhanced-btn w-full p-3 bg-slate-100 rounded-xl flex items-center justify-center gap-2">
                            📋 查看任务
                        </button>
                        <button
                            class="enhanced-btn w-full p-3 bg-slate-100 rounded-xl flex items-center justify-center gap-2">
                            🎮 小游戏
                        </button>
                    </div>
                </div>
            </div>

            <!-- 中间 - 主要内容 -->
            <div class="md:col-span-2 space-y-6">
                <!-- 成就系统 -->
                <div class="bg-white rounded-3xl p-6 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold flex items-center gap-2">
                            🏅 成就徽章
                        </h3>
                        <span class="text-sm text-slate-500" id="achievementCount">8/15 已解锁</span>
                    </div>

                    <div class="grid grid-cols-5 gap-4" id="achievementGrid">
                        <!-- 成就徽章将通过JavaScript生成 -->
                    </div>
                </div>

                <!-- Labubu收藏册 -->
                <div class="bg-white rounded-3xl p-6 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold flex items-center gap-2">
                            📚 Labubu 收藏册
                        </h3>
                        <span class="text-sm text-slate-500" id="collectionCount">12/24 已收集</span>
                    </div>

                    <div class="grid grid-cols-6 gap-4" id="collectionGrid">
                        <!-- 收藏品将通过JavaScript生成 -->
                    </div>
                </div>

                <!-- 最近获得 -->
                <div class="bg-white rounded-3xl p-6 shadow-sm">
                    <h3 class="font-semibold mb-4 flex items-center gap-2">
                        ⭐ 最近获得
                    </h3>

                    <div class="space-y-3" id="recentPrizes">
                        <!-- 最近奖品将通过JavaScript生成 -->
                    </div>
                </div>

                <!-- 每日签到日历 -->
                <div class="bg-white rounded-3xl p-6 shadow-sm">
                    <h3 class="font-semibold mb-4 flex items-center gap-2">
                        📅 签到日历
                        <span class="text-sm font-normal text-slate-500">本月已签到 <span id="monthlyCheckins">15</span>
                            天</span>
                    </h3>

                    <div class="grid grid-cols-7 gap-2 text-center">
                        <div class="text-xs text-slate-500 p-2">日</div>
                        <div class="text-xs text-slate-500 p-2">一</div>
                        <div class="text-xs text-slate-500 p-2">二</div>
                        <div class="text-xs text-slate-500 p-2">三</div>
                        <div class="text-xs text-slate-500 p-2">四</div>
                        <div class="text-xs text-slate-500 p-2">五</div>
                        <div class="text-xs text-slate-500 p-2">六</div>

                        <div id="calendarGrid" class="col-span-7 grid grid-cols-7 gap-2">
                            <!-- 日历将通过JavaScript生成 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 手机号登录模态框 -->
    <div id="authModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-3xl p-8 mx-4 max-w-md w-full shadow-2xl">
            <!-- 标题 -->
            <div class="text-center mb-6">
                <div class="text-4xl mb-2">📱</div>
                <h2 class="text-xl font-bold text-slate-800">手机验证码登录</h2>
                <p class="text-sm text-slate-500 mt-2">验证身份，同步您的抽奖数据到云端</p>
                <button id="closeAuthModal"
                    class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 text-2xl">×</button>
            </div>

            <!-- 手机号输入 -->
            <div id="phoneInputStep" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">手机号码</label>
                    <div class="flex">
                        <select id="countryCode"
                            class="px-3 py-2 border border-slate-300 rounded-l-lg text-sm focus:border-[var(--labu)] focus:outline-none">
                            <option value="+86">🇨🇳 +86</option>
                            <option value="+1">🇺🇸 +1</option>
                            <option value="+44">🇬🇧 +44</option>
                            <option value="+81">🇯🇵 +81</option>
                            <option value="+82">🇰🇷 +82</option>
                        </select>
                        <input type="tel" id="phoneNumber" placeholder="请输入手机号"
                            class="flex-1 px-3 py-2 border border-l-0 border-slate-300 rounded-r-lg text-sm focus:border-[var(--labu)] focus:outline-none">
                    </div>
                    <div id="phoneError" class="text-red-500 text-xs mt-1 hidden"></div>
                </div>

                <!-- 简单验证 -->
                <div class="text-xs text-slate-500 bg-blue-50 p-2 rounded">
                    💡 为了简化流程，我们使用演示验证码：<strong>123456</strong>
                </div>

                <button id="sendCodeBtn"
                    class="w-full bg-[var(--labu)] text-white py-3 rounded-lg font-medium hover:bg-[var(--labu)]/90 transition-colors">
                    📤 发送验证码
                </button>
            </div>

            <!-- 验证码输入 -->
            <div id="codeInputStep" class="space-y-4 hidden">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">验证码</label>
                    <input type="text" id="verificationCode" placeholder="请输入6位验证码" maxlength="6"
                        class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm text-center font-mono text-lg tracking-wider focus:border-[var(--labu)] focus:outline-none">
                    <div id="codeError" class="text-red-500 text-xs mt-1 hidden"></div>
                </div>

                <div class="flex justify-between items-center text-sm">
                    <span class="text-slate-500">验证码已发送至 <span id="sentPhoneNumber"></span></span>
                    <button id="resendCodeBtn" class="text-[var(--labu)] hover:underline" disabled>
                        重新发送 (<span id="countdown">60</span>s)
                    </button>
                </div>

                <button id="verifyCodeBtn"
                    class="w-full bg-[var(--labu)] text-white py-3 rounded-lg font-medium hover:bg-[var(--labu)]/90 transition-colors">
                    ✅ 验证登录
                </button>

                <button id="backToPhoneBtn"
                    class="w-full bg-slate-200 text-slate-700 py-2 rounded-lg font-medium hover:bg-slate-300 transition-colors">
                    ← 返回修改手机号
                </button>
            </div>

            <!-- 登录加载状态 -->
            <div id="loginLoading" class="text-center text-slate-500 hidden">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[var(--labu)] mx-auto mb-2"></div>
                <p class="text-sm">正在验证...</p>
            </div>
        </div>
    </div>

    <!-- 编辑资料模态框 -->
    <div id="editProfileModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-slate-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold text-slate-800">编辑个人资料</h3>
                    <button id="closeProfileModal" class="text-slate-400 hover:text-slate-600 text-2xl">×</button>
                </div>
            </div>

            <form id="profileForm" class="p-6 space-y-6">
                <!-- 头像上传 -->
                <div class="text-center">
                    <div class="relative inline-block">
                        <div id="avatarPreview"
                            class="w-24 h-24 rounded-2xl bg-slate-100 grid place-content-center text-4xl mx-auto mb-4 overflow-hidden cursor-pointer">
                            🧸
                        </div>
                        <input type="file" id="avatarUpload" accept="image/*" class="hidden">
                        <button type="button" id="uploadAvatarBtn"
                            class="absolute -bottom-1 -right-1 w-8 h-8 bg-[var(--labu)] text-white rounded-full flex items-center justify-center text-sm">
                            📷
                        </button>
                    </div>
                    <p class="text-xs text-slate-500">点击上传头像（最大2MB）</p>
                </div>

                <!-- 基本信息 -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">用户名</label>
                        <input type="text" id="profileName" required
                            class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:border-[var(--labu)] focus:outline-none transition-colors">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">个人简介</label>
                        <textarea id="profileBio" rows="3" placeholder="写点什么介绍一下自己..."
                            class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:border-[var(--labu)] focus:outline-none transition-colors resize-none"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">个性签名</label>
                        <input type="text" id="profileSignature" placeholder="例如：Labubu收集家 🧸"
                            class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:border-[var(--labu)] focus:outline-none transition-colors">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">生日</label>
                        <input type="date" id="profileBirthday"
                            class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:border-[var(--labu)] focus:outline-none transition-colors">
                    </div>
                </div>

                <!-- 按钮组 -->
                <div class="flex gap-3 pt-4">
                    <button type="button" id="cancelProfile"
                        class="flex-1 py-3 px-4 border border-slate-300 text-slate-700 rounded-xl hover:bg-slate-50 transition-colors">
                        取消
                    </button>
                    <button type="submit"
                        class="flex-1 py-3 px-4 bg-[var(--labu)] text-white rounded-xl hover:bg-opacity-90 transition-colors font-medium">
                        保存
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 工具函数
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyAPUti6enwvI57jiOqE3kC9SMBG4GL2FfE",
            authDomain: "labubu-lottery.firebaseapp.com",
            projectId: "llabubu- lottery - b8cfd",
            storageBucket: "labubu-lottery.appspot.com",
            messagingSenderId: "1040839447881",
            appId: "1:1040839447881:web:a25f503a3182e9b020b698"
        };

        // 初始化Firebase
        let app, auth, db, storage;
        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            storage = firebase.storage();
        } catch (error) {
            console.warn('Firebase初始化失败，使用本地模式:', error);
        }

        // 当前用户
        let currentUser = null;
        let isLoggedIn = false;
        let isAuthenticated = false;
        let pendingPhoneNumber = null;

        // 默认用户数据
        let userData = {
            uid: null,
            name: 'Labubu收集家',
            avatar: null,
            bio: '',
            signature: 'Labubu收集家 🧸',
            birthday: null,
            level: 1,
            exp: 0,
            maxExp: 100,
            joinDays: 1,
            totalDraws: 0,
            totalPrizes: 0,
            rarityScore: 0,
            streakDays: 0,
            luckyRate: 50,
            points: 100, // 积分
            createdAt: new Date(),
            updatedAt: new Date()
        };

        // JSONBin.io数据存储配置
        const DATA_STORAGE_CONFIG = {
            jsonbin: {
                baseUrl: 'https://api.jsonbin.io/v3',
                apiKey: '$2a$10$VjQj.Gc8Q7q8q4k4K4k4Ou' // 这里使用你的实际API密钥
            }
        };

        let userDataBinId = null; // 用户数据存储的bin ID

        // 成就数据
        const achievements = [
            { id: 1, name: '初心者', icon: '🔰', description: '完成第一次抽奖', unlocked: true },
            { id: 2, name: '幸运儿', icon: '🍀', description: '连续3次抽中奖品', unlocked: true },
            { id: 3, name: '收集家', icon: '📦', description: '收集10种不同奖品', unlocked: true },
            { id: 4, name: '坚持者', icon: '💪', description: '连续签到7天', unlocked: true },
            { id: 5, name: '土豪', icon: '💰', description: '单日抽奖超过20次', unlocked: true },
            { id: 6, name: '传说', icon: '🌟', description: '抽中传说级奖品', unlocked: true },
            { id: 7, name: '社交达人', icon: '💬', description: '发表10条留言', unlocked: true },
            { id: 8, name: '购物狂', icon: '🛒', description: '商城购买满500元', unlocked: true },
            { id: 9, name: '完美主义', icon: '💎', description: '收集齐全套Labubu', unlocked: false },
            { id: 10, name: '月度之星', icon: '🌙', description: '月度抽奖次数第一', unlocked: false },
            { id: 11, name: '分享达人', icon: '📤', description: '分享给10位好友', unlocked: false },
            { id: 12, name: '评论家', icon: '📝', description: '给商品写50条评价', unlocked: false },
            { id: 13, name: '游戏高手', icon: '🎮', description: '小游戏获得满分', unlocked: false },
            { id: 14, name: '慈善家', icon: '❤️', description: '参与慈善抽奖活动', unlocked: false },
            { id: 15, name: 'Labubu之王', icon: '👑', description: '达成所有成就', unlocked: false }
        ];

        // 收藏品数据
        const collections = [
            { id: 1, name: '经典款', emoji: '🧸', owned: true, rarity: 'common' },
            { id: 2, name: '粉色梦幻', emoji: '💖', owned: true, rarity: 'common' },
            { id: 3, name: '蓝色海洋', emoji: '🌊', owned: true, rarity: 'common' },
            { id: 4, name: '绿色森林', emoji: '🌲', owned: true, rarity: 'common' },
            { id: 5, name: '彩虹系列', emoji: '🌈', owned: true, rarity: 'rare' },
            { id: 6, name: '夏日海滩', emoji: '🏖️', owned: true, rarity: 'rare' },
            { id: 7, name: '宇宙星空', emoji: '🌌', owned: true, rarity: 'rare' },
            { id: 8, name: '圣诞特别', emoji: '🎄', owned: true, rarity: 'epic' },
            { id: 9, name: '万圣节', emoji: '🎃', owned: true, rarity: 'epic' },
            { id: 10, name: '咖啡主题', emoji: '☕', owned: true, rarity: 'epic' },
            { id: 11, name: '黄金限定', emoji: '🏆', owned: true, rarity: 'legendary' },
            { id: 12, name: '钻石典藏', emoji: '💎', owned: true, rarity: 'legendary' },
            { id: 13, name: '独角兽', emoji: '🦄', owned: false, rarity: 'rare' },
            { id: 14, name: '龙年特别', emoji: '🐉', owned: false, rarity: 'epic' },
            { id: 15, name: '太空漫游', emoji: '🚀', owned: false, rarity: 'epic' },
            { id: 16, name: '魔法师', emoji: '🧙', owned: false, rarity: 'rare' },
            { id: 17, name: '机器人', emoji: '🤖', owned: false, rarity: 'common' },
            { id: 18, name: '超级英雄', emoji: '🦸', owned: false, rarity: 'epic' },
            { id: 19, name: '公主系列', emoji: '👸', owned: false, rarity: 'rare' },
            { id: 20, name: '武士道', emoji: '🥷', owned: false, rarity: 'epic' },
            { id: 21, name: '天使之翼', emoji: '👼', owned: false, rarity: 'legendary' },
            { id: 22, name: '恶魔之角', emoji: '😈', owned: false, rarity: 'legendary' },
            { id: 23, name: '时光旅者', emoji: '⏰', owned: false, rarity: 'legendary' },
            { id: 24, name: '终极形态', emoji: '🌟', owned: false, rarity: 'mythic' }
        ];

        // 最近获得奖品
        const recentPrizes = [
            { name: '钻石典藏 Labubu', emoji: '💎', rarity: 'legendary', time: '2小时前' },
            { name: '咖啡主题 Labubu', emoji: '☕', rarity: 'epic', time: '1天前' },
            { name: '3U币', emoji: '🪙', rarity: 'common', time: '2天前' },
            { name: '彩虹系列 Labubu', emoji: '🌈', rarity: 'rare', time: '3天前' },
            { name: '烤肉券', emoji: '🥩', rarity: 'common', time: '4天前' }
        ];

        // 用户认证和数据管理类
        class UserManager {
            constructor() {
                this.authModal = $('#authModal');
                this.editProfileModal = $('#editProfileModal');
                this.isLoginMode = true;
                this.initAuthListeners();
                this.initProfileListeners();
                this.setupAuthStateListener();
            }

            // 设置认证状态监听
            setupAuthStateListener() {
                // 检查本地登录状态
                this.checkLoginStatus();

                if (auth) {
                    auth.onAuthStateChanged((user) => {
                        if (user) {
                            // Firebase用户登录（如果之前有Firebase账户）
                            currentUser = user;
                            isLoggedIn = true;
                            this.updateUIForAuthState(user);
                            this.loadUserData(user.uid);
                        }
                    });
                }
            }

            // 更新UI以反映认证状态
            updateUIForAuthState(user) {
                const statusIndicator = $('#userStatus');
                const statusText = $('#userStatusText');
                const logoutBtn = $('#logoutBtn');
                const editBtn = $('#editProfileBtn');

                if (user) {
                    statusIndicator.className = 'w-3 h-3 bg-green-400 rounded-full';

                    if (user.phoneNumber) {
                        // 显示掩码手机号
                        const maskedPhone = user.phoneNumber.replace(/(\+\d{1,3})(\d{3})(\d{4})(\d{4})/, '$1 $2****$4');
                        statusText.textContent = `已登录 · ${maskedPhone}`;
                    } else {
                        statusText.textContent = '已登录';
                    }

                    logoutBtn.classList.remove('hidden');
                    editBtn.textContent = '✏️ 编辑资料';
                } else {
                    statusIndicator.className = 'w-3 h-3 bg-gray-400 rounded-full';
                    statusText.textContent = '未登录';
                    logoutBtn.classList.add('hidden');
                    editBtn.textContent = '📱 手机号登录';
                }
            }

            // 显示认证模态框
            showAuthModal() {
                this.resetLoginForm();
                this.authModal.classList.remove('hidden');
            }

            // 隐藏认证模态框
            hideAuthModal() {
                this.authModal.classList.add('hidden');
            }

            // 这些方法保留兼容性但不再使用
            switchToLogin() {
                // 已改为手机号登录，保留方法避免报错
            }

            switchToRegister() {
                // 已改为手机号登录，保留方法避免报错
            }

            // 发送验证码
            async sendVerificationCode() {
                const phoneNumber = $('#phoneNumber').value.trim();
                const countryCode = $('#countryCode').value;
                const fullPhoneNumber = countryCode + phoneNumber;

                // 验证手机号格式
                if (!this.validatePhoneNumber(phoneNumber, countryCode)) {
                    return;
                }

                try {
                    $('#sendCodeBtn').disabled = true;
                    $('#sendCodeBtn').textContent = '正在发送...';

                    // 模拟发送验证码的过程
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    // 保存待验证的手机号
                    pendingPhoneNumber = fullPhoneNumber;

                    console.log('📱 演示验证码已"发送"至:', fullPhoneNumber);
                    this.showSuccess('验证码已发送！请输入：123456');

                    // 切换到验证码输入界面
                    $('#phoneInputStep').classList.add('hidden');
                    $('#codeInputStep').classList.remove('hidden');
                    $('#sentPhoneNumber').textContent = fullPhoneNumber;

                    // 开始倒计时
                    this.startCountdown();

                } catch (error) {
                    console.error('📱 发送验证码失败:', error);
                    this.showError('发送验证码失败，请重试');
                    $('#sendCodeBtn').disabled = false;
                    $('#sendCodeBtn').textContent = '📤 发送验证码';
                }
            }

            // 验证登录码
            async verifyCode() {
                const code = $('#verificationCode').value.trim();

                if (!code) {
                    this.showCodeError('请输入验证码');
                    return;
                }

                if (code.length !== 6) {
                    this.showCodeError('验证码应为6位数字');
                    return;
                }

                if (!pendingPhoneNumber) {
                    this.showCodeError('验证码已失效，请重新获取');
                    return;
                }

                try {
                    $('#verifyCodeBtn').disabled = true;
                    $('#verifyCodeBtn').textContent = '正在验证...';
                    $('#loginLoading').classList.remove('hidden');

                    // 模拟验证过程
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    // 简单的验证码检查（演示用）
                    if (code === '123456') {
                        // 创建用户对象
                        currentUser = {
                            phoneNumber: pendingPhoneNumber,
                            uid: 'user_' + Date.now(),
                            loginTime: new Date().toISOString()
                        };

                        isAuthenticated = true;
                        isLoggedIn = true;

                        // 保存登录状态
                        localStorage.setItem('labubu_user_auth', JSON.stringify(currentUser));

                        console.log('✅ 登录成功:', currentUser.phoneNumber);
                        this.showSuccess('登录成功！正在同步数据...');

                        // 更新用户数据
                        userData.uid = currentUser.uid;
                        userData.name = '手机用户';

                        // 更新用户状态显示
                        this.updateUIForAuthState(currentUser);

                        // 关闭登录窗口
                        this.hideAuthModal();

                        // 加载用户数据
                        this.loadUserData(currentUser.uid);

                    } else {
                        throw new Error('验证码错误');
                    }

                } catch (error) {
                    console.error('❌ 验证失败:', error);
                    let errorMessage = '验证码错误，请输入：123456';

                    this.showCodeError(errorMessage);
                    $('#verifyCodeBtn').disabled = false;
                    $('#verifyCodeBtn').textContent = '✅ 验证登录';
                    $('#loginLoading').classList.add('hidden');
                }
            }

            // 退出登录
            async logout() {
                try {
                    // 清除登录状态
                    currentUser = null;
                    isAuthenticated = false;
                    isLoggedIn = false;
                    pendingPhoneNumber = null;

                    // 清除本地存储的登录信息
                    localStorage.removeItem('labubu_user_auth');
                    localStorage.removeItem('labubu_user_bin_id');

                    // 更新UI状态
                    this.updateUIForAuthState(null);

                    this.showSuccess('已安全退出登录');
                    console.log('🚪 用户已退出登录');
                } catch (error) {
                    console.error('🚪 退出登录失败:', error);
                    this.showError('退出登录失败');
                }
            }

            // 创建用户数据
            async createUserData(uid, displayName) {
                if (!db) return;

                const newUserData = {
                    ...userData,
                    uid: uid,
                    name: displayName,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    await db.collection('users').doc(uid).set(newUserData);
                    userData = newUserData;
                } catch (error) {
                    console.error('创建用户数据失败:', error);
                }
            }

            // 加载用户数据
            async loadUserData(uid) {
                try {
                    // 首先尝试从云端加载数据
                    const cloudData = await this.downloadUserData();

                    if (cloudData) {
                        // 合并云端数据
                        userData = { ...userData, ...cloudData };
                        console.log('✅ 从云端加载用户数据成功');
                    } else {
                        // 如果云端没有数据，从本地加载并同步到云端
                        this.loadLocalData();

                        // 延迟同步到云端
                        setTimeout(() => {
                            this.saveUserData();
                        }, 2000);
                    }

                    renderUserData();
                } catch (error) {
                    console.error('加载用户数据失败:', error);
                    this.loadLocalData();
                }
            }

            // 加载本地数据
            loadLocalData() {
                try {
                    // 加载用户基本信息
                    const savedData = localStorage.getItem('userData');
                    if (savedData) {
                        userData = { ...userData, ...JSON.parse(savedData) };
                    }

                    // 加载积分数据
                    const points = localStorage.getItem('labubu_user_points');
                    if (points) {
                        userData.points = parseInt(points) || 100;
                    }

                    // 加载抽奖统计
                    const history = this.loadHistory();
                    userData.totalDraws = history.length;
                    userData.totalPrizes = history.filter(h => h.type !== 'empty').length;

                    // 计算稀有度总分
                    userData.rarityScore = history.reduce((score, h) => {
                        const rarityPoints = {
                            'common': 1,
                            'rare': 5,
                            'epic': 15,
                            'legendary': 50,
                            'mythic': 100
                        };
                        return score + (rarityPoints[h.rarity] || 0);
                    }, 0);

                    // 加载抽奖次数
                    const drawCount = localStorage.getItem('labubu_user_draw_count');
                    if (drawCount) {
                        userData.totalDraws = parseInt(drawCount) || 0;
                    }

                    // 加载签到数据
                    const checkinHistory = JSON.parse(localStorage.getItem('checkinHistory') || '{}');
                    userData.streakDays = Object.keys(checkinHistory).length;

                    // 获取用户数据存储ID
                    userDataBinId = localStorage.getItem('labubu_user_bin_id');

                    console.log('📁 本地数据加载完成:', userData);
                } catch (error) {
                    console.error('加载本地数据失败:', error);
                }

                renderUserData();
            }

            // 保存用户数据
            async saveUserData() {
                userData.updatedAt = new Date();

                // 保存到本地
                localStorage.setItem('userData', JSON.stringify(userData));
                localStorage.setItem('labubu_user_points', userData.points.toString());

                // 保存到云端
                if (currentUser) {
                    try {
                        const success = await this.uploadToJsonBin(userData);
                        if (success) {
                            this.showSuccess('数据同步到云端成功！');
                        } else {
                            this.showSuccess('数据已保存到本地');
                        }
                    } catch (error) {
                        console.error('保存到云端失败:', error);
                        this.showSuccess('数据已保存到本地');
                    }
                } else {
                    this.showSuccess('数据已保存到本地');
                }
            }

            // 收集完整用户数据（与index.html保持一致）
            collectAllUserData() {
                return {
                    // 用户基本信息
                    user: {
                        phoneNumber: currentUser?.phoneNumber || null,
                        uid: currentUser?.uid || null,
                        loginTime: currentUser?.loginTime || null
                    },

                    // 用户详细数据
                    userData: userData,

                    // 抽奖相关数据
                    lottery: {
                        history: this.loadHistory(),
                        drawCount: parseInt(localStorage.getItem('labubu_user_draw_count') || '0'),
                        drawLimit: parseInt(localStorage.getItem('labubu_draw_limit') || '0'),
                        vipDraws: parseInt(localStorage.getItem('labubu_vip_draws') || '0')
                    },

                    // 收藏和兑换数据
                    collection: {
                        myCollection: JSON.parse(localStorage.getItem('labubu_my_collection') || '{}'),
                        exchanges: JSON.parse(localStorage.getItem('labubu_exchanges') || '[]'),
                        wishlist: JSON.parse(localStorage.getItem('labubu_wishlist') || '[]')
                    },

                    // 签到数据
                    checkin: {
                        history: JSON.parse(localStorage.getItem('checkinHistory') || '{}'),
                        lastCheckin: localStorage.getItem('lastCheckin') || null,
                        streakDays: userData.streakDays
                    },

                    // 成就数据
                    achievements: {
                        data: JSON.parse(localStorage.getItem('userData_achievements') || '{}'),
                        unlocked: JSON.parse(localStorage.getItem('labubu_achievements') || '{}'),
                        progress: JSON.parse(localStorage.getItem('labubu_achievement_progress') || '{}')
                    },

                    // 任务数据
                    tasks: {
                        daily: JSON.parse(localStorage.getItem('labubu_daily_tasks') || '{}'),
                        weekly: JSON.parse(localStorage.getItem('labubu_weekly_tasks') || '{}'),
                        special: JSON.parse(localStorage.getItem('labubu_special_tasks') || '{}'),
                        completed: JSON.parse(localStorage.getItem('labubu_completed_tasks') || '[]')
                    },

                    // 游戏数据
                    games: {
                        scores: JSON.parse(localStorage.getItem('labubu_game_scores') || '{}'),
                        stats: JSON.parse(localStorage.getItem('labubu_game_stats') || '{}'),
                        achievements: JSON.parse(localStorage.getItem('labubu_game_achievements') || '{}')
                    },

                    // 商城数据
                    shop: {
                        cart: JSON.parse(localStorage.getItem('labubu_shopping_cart') || '[]'),
                        orders: JSON.parse(localStorage.getItem('labubu_orders') || '[]'),
                        favorites: JSON.parse(localStorage.getItem('labubu_shop_favorites') || '[]')
                    },

                    // 用户设置
                    settings: {
                        soundEnabled: localStorage.getItem('labubu_ui_sound_enabled') !== 'false',
                        musicVolume: localStorage.getItem('labubu_music_volume') || '50',
                        notifications: localStorage.getItem('labubu_notifications') !== 'false',
                        theme: localStorage.getItem('labubu_theme') || 'light',
                        language: localStorage.getItem('labubu_language') || 'zh-CN'
                    },

                    // 社交数据
                    social: {
                        friends: JSON.parse(localStorage.getItem('labubu_friends') || '[]'),
                        messages: JSON.parse(localStorage.getItem('labubu_messages') || '[]'),
                        likes: JSON.parse(localStorage.getItem('labubu_likes') || '{}')
                    },

                    // 系统数据
                    system: {
                        lastSync: new Date().toISOString(),
                        version: '3.0',
                        clientInfo: {
                            userAgent: navigator.userAgent,
                            platform: navigator.platform,
                            language: navigator.language,
                            timestamp: Date.now()
                        }
                    }
                };
            }

            // 上传数据到JSONBin.io
            async uploadToJsonBin(data) {
                try {
                    const config = DATA_STORAGE_CONFIG.jsonbin;
                    let url = `${config.baseUrl}/b`;
                    let method = 'POST';

                    // 如果已有binId，使用PUT更新
                    if (userDataBinId) {
                        url = `${config.baseUrl}/b/${userDataBinId}`;
                        method = 'PUT';
                    }

                    // 如果data是用户详细数据，则收集完整数据
                    let uploadData;
                    if (data && typeof data === 'object' && !data.system) {
                        // 传入的是userData对象，需要包装成完整数据结构
                        uploadData = this.collectAllUserData();
                        uploadData.userData = data; // 更新用户详细数据
                    } else {
                        // 传入的已经是完整数据结构
                        uploadData = data || this.collectAllUserData();
                    }

                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': config.apiKey,
                            'X-Bin-Name': `labubu_user_${currentUser.uid}`
                        },
                        body: JSON.stringify(uploadData)
                    });

                    if (response.ok) {
                        const result = await response.json();

                        // 保存binId以便后续更新
                        if (result.metadata && result.metadata.id) {
                            userDataBinId = result.metadata.id;
                            localStorage.setItem('labubu_user_bin_id', userDataBinId);
                        }

                        console.log('📤 完整数据已上传到JSONBin:', result);
                        return true;
                    } else {
                        console.error('📤 上传失败:', response.status, response.statusText);
                        return false;
                    }

                } catch (error) {
                    console.error('📤 上传过程出错:', error);
                    return false;
                }
            }

            // 从云端下载用户数据
            async downloadUserData() {
                if (!userDataBinId) {
                    userDataBinId = localStorage.getItem('labubu_user_bin_id');
                }

                if (!userDataBinId) {
                    console.log('📥 没有云端数据ID，跳过下载');
                    return null;
                }

                try {
                    const config = DATA_STORAGE_CONFIG.jsonbin;
                    const response = await fetch(`${config.baseUrl}/b/${userDataBinId}/latest`, {
                        method: 'GET',
                        headers: {
                            'X-Master-Key': config.apiKey
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const cloudData = result.record;

                        if (cloudData && cloudData.userData) {
                            // 同步其他数据到本地
                            if (cloudData.history) {
                                localStorage.setItem('labubu_history', JSON.stringify(cloudData.history));
                            }
                            if (cloudData.collection) {
                                localStorage.setItem('labubu_my_collection', JSON.stringify(cloudData.collection));
                            }
                            if (cloudData.exchanges) {
                                localStorage.setItem('labubu_exchanges', JSON.stringify(cloudData.exchanges));
                            }
                            if (cloudData.checkinHistory) {
                                localStorage.setItem('checkinHistory', JSON.stringify(cloudData.checkinHistory));
                            }

                            console.log('📥 从云端下载数据成功');
                            return cloudData.userData;
                        }
                    } else {
                        console.error('📥 下载失败:', response.status, response.statusText);
                    }
                } catch (error) {
                    console.error('📥 下载过程出错:', error);
                }

                return null;
            }

            // 加载抽奖历史
            loadHistory() {
                try {
                    return JSON.parse(localStorage.getItem('labubu_history') || '[]');
                } catch (error) {
                    console.error('加载抽奖历史失败:', error);
                    return [];
                }
            }

            // 上传头像
            async uploadAvatar(file) {
                if (!storage || !currentUser) {
                    // 如果没有Firebase，使用Base64存储到本地
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            userData.avatar = e.target.result;
                            resolve(e.target.result);
                        };
                        reader.readAsDataURL(file);
                    });
                }

                try {
                    const storageRef = storage.ref(`avatars/${currentUser.uid}`);
                    const snapshot = await storageRef.put(file);
                    const downloadURL = await snapshot.ref.getDownloadURL();

                    userData.avatar = downloadURL;
                    return downloadURL;
                } catch (error) {
                    console.error('头像上传失败:', error);
                    throw error;
                }
            }

            // 显示成功消息
            showSuccess(message) {
                this.showNotification(message, 'success');
            }

            // 显示错误消息
            showError(message) {
                this.showNotification(message, 'error');
            }

            // 显示通知
            showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
                notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-xl z-50 transform translate-x-full transition-transform duration-300`;
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.transform = 'translateX(0)';
                }, 100);

                setTimeout(() => {
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (document.body.contains(notification)) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }

            // 初始化认证事件监听
            initAuthListeners() {
                // 关闭认证模态框
                $('#closeAuthModal').addEventListener('click', () => {
                    this.hideAuthModal();
                });

                // 发送验证码
                $('#sendCodeBtn').addEventListener('click', async () => {
                    await this.sendVerificationCode();
                });

                // 验证码登录
                $('#verifyCodeBtn').addEventListener('click', async () => {
                    await this.verifyCode();
                });

                // 返回手机号输入
                $('#backToPhoneBtn').addEventListener('click', () => {
                    this.backToPhoneInput();
                });

                // 重新发送验证码
                $('#resendCodeBtn').addEventListener('click', () => {
                    this.resendVerificationCode();
                });

                // 退出登录
                $('#logoutBtn').addEventListener('click', () => {
                    if (confirm('确定要退出登录吗？')) {
                        this.logout();
                    }
                });
            }

            // 初始化个人资料事件监听
            initProfileListeners() {
                // 打开编辑资料模态框
                $('#editProfileBtn').addEventListener('click', () => {
                    if (isLoggedIn) {
                        this.showEditProfileModal();
                    } else {
                        this.showAuthModal();
                    }
                });

                // 头像点击编辑
                $('#avatarContainer').addEventListener('click', () => {
                    if (isLoggedIn) {
                        this.showEditProfileModal();
                    } else {
                        this.showAuthModal();
                    }
                });

                // 关闭编辑资料模态框
                $('#closeProfileModal').addEventListener('click', () => {
                    this.hideEditProfileModal();
                });

                $('#cancelProfile').addEventListener('click', () => {
                    this.hideEditProfileModal();
                });

                // 头像上传
                $('#uploadAvatarBtn').addEventListener('click', () => {
                    $('#avatarUpload').click();
                });

                $('#avatarPreview').addEventListener('click', () => {
                    $('#avatarUpload').click();
                });

                $('#avatarUpload').addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        await this.handleAvatarUpload(file);
                    }
                });

                // 个人资料表单提交
                $('#profileForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.handleProfileUpdate();
                });
            }

            // 显示编辑资料模态框
            showEditProfileModal() {
                // 填充当前数据
                $('#profileName').value = userData.name;
                $('#profileBio').value = userData.bio || '';
                $('#profileSignature').value = userData.signature || '';
                $('#profileBirthday').value = userData.birthday || '';

                // 设置头像预览
                this.updateAvatarPreview(userData.avatar);

                this.editProfileModal.classList.remove('hidden');
            }

            // 隐藏编辑资料模态框
            hideEditProfileModal() {
                this.editProfileModal.classList.add('hidden');
            }

            // 处理头像上传
            async handleAvatarUpload(file) {
                if (file.size > 2 * 1024 * 1024) {
                    this.showError('图片大小不能超过2MB');
                    return;
                }

                try {
                    const avatarUrl = await this.uploadAvatar(file);
                    this.updateAvatarPreview(avatarUrl);
                    this.showSuccess('头像上传成功！');
                } catch (error) {
                    this.showError('头像上传失败: ' + error.message);
                }
            }

            // 更新头像预览
            updateAvatarPreview(avatarUrl) {
                const preview = $('#avatarPreview');
                const userAvatar = $('#userAvatar');

                if (avatarUrl) {
                    const img = `<img src="${avatarUrl}" alt="头像" class="w-full h-full object-cover">`;
                    preview.innerHTML = img;
                    userAvatar.innerHTML = img;
                } else {
                    preview.innerHTML = '🧸';
                    userAvatar.innerHTML = '🧸';
                }
            }

            // 处理个人资料更新
            async handleProfileUpdate() {
                userData.name = $('#profileName').value;
                userData.bio = $('#profileBio').value;
                userData.signature = $('#profileSignature').value;
                userData.birthday = $('#profileBirthday').value;

                try {
                    await this.saveUserData();
                    renderUserData();
                    this.hideEditProfileModal();
                } catch (error) {
                    this.showError('保存失败: ' + error.message);
                }
            }

            // 验证手机号格式
            validatePhoneNumber(phoneNumber, countryCode) {
                $('#phoneError').classList.add('hidden');

                if (!phoneNumber) {
                    this.showPhoneError('请输入手机号');
                    return false;
                }

                // 基本格式验证
                const phoneRegex = /^[0-9]{7,15}$/;
                if (!phoneRegex.test(phoneNumber)) {
                    this.showPhoneError('手机号格式不正确');
                    return false;
                }

                // 针对不同国家的特殊验证
                if (countryCode === '+86') {
                    if (!/^1[3-9]\d{9}$/.test(phoneNumber)) {
                        this.showPhoneError('请输入正确的中国大陆手机号');
                        return false;
                    }
                }

                return true;
            }

            // 显示手机号错误
            showPhoneError(message) {
                const errorEl = $('#phoneError');
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
            }

            // 显示验证码错误
            showCodeError(message) {
                const errorEl = $('#codeError');
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
            }

            // 开始倒计时
            startCountdown() {
                let countdown = 60;
                const btn = $('#resendCodeBtn');
                const countdownEl = $('#countdown');

                btn.disabled = true;

                const timer = setInterval(() => {
                    countdown--;
                    countdownEl.textContent = countdown;

                    if (countdown <= 0) {
                        clearInterval(timer);
                        btn.disabled = false;
                        btn.innerHTML = '重新发送';
                    }
                }, 1000);
            }

            // 返回手机号输入
            backToPhoneInput() {
                $('#codeInputStep').classList.add('hidden');
                $('#phoneInputStep').classList.remove('hidden');
                $('#sendCodeBtn').disabled = false;
                $('#sendCodeBtn').textContent = '📤 发送验证码';
            }

            // 重新发送验证码
            resendVerificationCode() {
                this.backToPhoneInput();
            }

            // 检查登录状态
            checkLoginStatus() {
                try {
                    const savedAuth = localStorage.getItem('labubu_user_auth');
                    if (savedAuth) {
                        currentUser = JSON.parse(savedAuth);
                        isAuthenticated = true;
                        isLoggedIn = true;

                        console.log('📱 发现已保存的登录状态:', currentUser.phoneNumber);
                        this.updateUIForAuthState(currentUser);

                        // 加载用户数据
                        this.loadUserData(currentUser.uid);
                    } else {
                        this.loadLocalData();
                    }
                } catch (error) {
                    console.error('📱 检查登录状态失败:', error);
                    // 清除损坏的数据
                    localStorage.removeItem('labubu_user_auth');
                    localStorage.removeItem('labubu_user_bin_id');
                    this.loadLocalData();
                }
            }

            // 重置登录表单
            resetLoginForm() {
                // 重置到手机号输入步骤
                $('#phoneInputStep').classList.remove('hidden');
                $('#codeInputStep').classList.add('hidden');
                $('#loginLoading').classList.add('hidden');

                // 清空输入
                $('#phoneNumber').value = '';
                $('#verificationCode').value = '';

                // 清空错误信息
                $('#phoneError').classList.add('hidden');
                $('#codeError').classList.add('hidden');

                // 重置按钮状态
                $('#sendCodeBtn').disabled = false;
                $('#verifyCodeBtn').disabled = false;
                $('#sendCodeBtn').textContent = '📤 发送验证码';
                $('#verifyCodeBtn').textContent = '✅ 验证登录';

                pendingPhoneNumber = null;
            }
        }

        // 创建用户管理实例
        const userManager = new UserManager();

        // 初始化
        function init() {
            renderUserData();
            renderAchievements();
            renderCollection();
            renderRecentPrizes();
            renderCalendar();
            initEventListeners();
            initCustomCursor();
        }

        // 渲染用户数据
        function renderUserData() {
            $('#userName').textContent = userData.name;
            $('#userLevel').textContent = userData.level;
            $('#joinDays').textContent = userData.joinDays;
            $('#totalDraws').textContent = userData.totalDraws;
            $('#totalPrizes').textContent = userData.totalPrizes;
            $('#rarityScore').textContent = userData.rarityScore.toLocaleString();
            $('#streakDays').textContent = userData.streakDays + '天';
            $('#luckyRate').textContent = userData.luckyRate + '%';
            $('#expNeeded').textContent = `${userData.exp}/${userData.maxExp} EXP`;

            // 更新进度条
            const progressBar = $('.level-progress');
            if (progressBar) {
                progressBar.style.width = (userData.exp / userData.maxExp * 100) + '%';
            }

            // 更新头像显示
            userManager.updateAvatarPreview(userData.avatar);

            // 更新积分显示（如果页面中有积分元素）
            const pointsElements = document.querySelectorAll('.user-points, #userPoints');
            pointsElements.forEach(el => {
                if (el) el.textContent = userData.points || 100;
            });

            console.log('🎯 用户数据渲染完成:', {
                level: userData.level,
                exp: userData.exp,
                totalDraws: userData.totalDraws,
                totalPrizes: userData.totalPrizes,
                points: userData.points,
                streakDays: userData.streakDays
            });
        }

        // 渲染成就
        function renderAchievements() {
            const grid = $('#achievementGrid');
            const unlockedCount = achievements.filter(a => a.unlocked).length;

            $('#achievementCount').textContent = `${unlockedCount}/${achievements.length} 已解锁`;

            grid.innerHTML = achievements.map(achievement => `
                <div class="achievement-badge ${achievement.unlocked ? 'achievement-unlocked' : 'achievement-locked'} 
                           w-16 h-16 rounded-2xl flex flex-col items-center justify-center text-center p-2"
                     title="${achievement.name}: ${achievement.description}">
                    <div class="text-2xl">${achievement.icon}</div>
                    <div class="text-xs font-medium mt-1">${achievement.name}</div>
                </div>
            `).join('');
        }

        // 渲染收藏册
        function renderCollection() {
            const grid = $('#collectionGrid');
            const ownedCount = collections.filter(c => c.owned).length;

            $('#collectionCount').textContent = `${ownedCount}/${collections.length} 已收集`;

            grid.innerHTML = collections.map(item => `
                <div class="collection-item ${item.owned ? 'owned' : 'not-owned'} 
                           bg-slate-50 rounded-xl p-3 text-center border ${getRarityBorder(item.rarity)}"
                     title="${item.name} - ${getRarityName(item.rarity)}">
                    <div class="text-3xl mb-1">${item.emoji}</div>
                    <div class="text-xs font-medium">${item.name}</div>
                    <div class="text-xs text-slate-500 mt-1">${getRarityName(item.rarity)}</div>
                </div>
            `).join('');
        }

        // 获取稀有度名称
        function getRarityName(rarity) {
            const names = {
                'common': '普通',
                'rare': '稀有',
                'epic': '史诗',
                'legendary': '传说',
                'mythic': '神话'
            };
            return names[rarity] || '未知';
        }

        // 获取稀有度边框
        function getRarityBorder(rarity) {
            const borders = {
                'common': 'border-slate-300',
                'rare': 'border-blue-400',
                'epic': 'border-purple-400',
                'legendary': 'border-yellow-400',
                'mythic': 'border-red-400'
            };
            return borders[rarity] || 'border-slate-300';
        }

        // 渲染最近奖品
        function renderRecentPrizes() {
            const container = $('#recentPrizes');

            container.innerHTML = recentPrizes.map(prize => `
                <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl">
                    <div class="text-2xl">${prize.emoji}</div>
                    <div class="flex-1">
                        <div class="font-medium">${prize.name}</div>
                        <div class="text-sm text-slate-500">${getRarityName(prize.rarity)} • ${prize.time}</div>
                    </div>
                </div>
            `).join('');
        }

        // 渲染签到日历
        function renderCalendar() {
            const grid = $('#calendarGrid');
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();

            // 获取签到记录
            const checkinHistory = JSON.parse(localStorage.getItem('checkinHistory') || '{}');
            const todayString = today.toDateString();
            const lastCheckin = localStorage.getItem('lastCheckin');

            let html = '';
            let signedCount = 0;

            // 填充空白日期
            for (let i = 0; i < firstDay; i++) {
                html += '<div></div>';
            }

            // 填充实际日期
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateString = date.toDateString();
                const isToday = day === today.getDate();
                const isSigned = checkinHistory[dateString] || (dateString === lastCheckin);

                if (isSigned) signedCount++;

                html += `
                    <div class="calendar-day w-8 h-8 rounded-lg flex items-center justify-center text-sm font-medium
                               ${isToday ? 'today' : ''} ${isSigned ? 'signed' : 'bg-slate-100'}">
                        ${day}
                    </div>
                `;
            }

            grid.innerHTML = html;

            // 更新签到统计
            $('#monthlyCheckins').textContent = signedCount;
        }

        // 页面过渡动画功能
        function initPageTransitions() {
            $$('.page-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const href = link.getAttribute('href');
                    showPageTransition(() => {
                        window.location.href = href;
                    });
                });
            });
        }

        function showPageTransition(callback) {
            const overlay = $('#pageTransitionOverlay');
            overlay.classList.add('active');

            setTimeout(() => {
                if (callback) callback();
            }, 800);
        }

        function hidePageTransition() {
            const overlay = $('#pageTransitionOverlay');
            overlay.classList.remove('active');
        }

        // 初始化事件监听
        function initEventListeners() {
            // 每日签到按钮
            $('#dailyCheckinBtn').addEventListener('click', () => {
                performDailyCheckin();
            });

            // 快速操作按钮
            $$('.enhanced-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.textContent.includes('立即抽奖')) {
                        showPageTransition(() => {
                            window.location.href = 'index.html#draw';
                        });
                    } else if (btn.textContent.includes('前往商城')) {
                        showPageTransition(() => {
                            window.location.href = 'shop.html';
                        });
                    } else if (btn.textContent.includes('查看任务')) {
                        showPageTransition(() => {
                            window.location.href = 'tasks.html';
                        });
                    } else if (btn.textContent.includes('小游戏')) {
                        showPageTransition(() => {
                            window.location.href = 'games.html';
                        });
                    }
                });
            });

            // 成就悬浮效果
            $$('.achievement-badge').forEach(badge => {
                badge.addEventListener('mouseenter', () => {
                    createMagicParticles(badge.getBoundingClientRect().left + 32, badge.getBoundingClientRect().top + 32);
                });
            });
        }

        // 执行每日签到
        async function performDailyCheckin() {
            // 检查今日是否已签到
            const today = new Date().toDateString();
            const lastCheckin = localStorage.getItem('lastCheckin');

            if (lastCheckin === today) {
                userManager.showError('今日已签到，请明天再来！');
                return;
            }

            // 检查登录状态
            if (!isLoggedIn || !currentUser) {
                userManager.showError('请先登录后再签到');
                userManager.showAuthModal();
                return;
            }

            // 更新用户经验和积分
            userData.exp += 10;
            userData.points += 5; // 签到奖励5积分
            userData.streakDays += 1;

            let leveledUp = false;
            if (userData.exp >= userData.maxExp) {
                userData.level++;
                userData.exp = userData.exp - userData.maxExp;
                userData.maxExp = Math.floor(userData.maxExp * 1.2);
                leveledUp = true;
            }

            // 保存签到记录
            localStorage.setItem('lastCheckin', today);

            // 保存到签到历史
            const checkinHistory = JSON.parse(localStorage.getItem('checkinHistory') || '{}');
            checkinHistory[today] = true;
            localStorage.setItem('checkinHistory', JSON.stringify(checkinHistory));

            // 更新本地积分存储
            localStorage.setItem('labubu_user_points', userData.points.toString());

            // 保存用户数据到云端
            try {
                await userManager.saveUserData();
                console.log('✅ 签到数据已同步到云端');
            } catch (error) {
                console.error('保存签到数据失败:', error);
            }

            // 显示签到成功提示
            userManager.showSuccess('✅ 签到成功！获得 10 EXP + 5 积分');

            // 如果升级了，显示升级提示
            if (leveledUp) {
                setTimeout(() => {
                    const levelUp = document.createElement('div');
                    levelUp.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
                    levelUp.innerHTML = `
                        <div class="bg-white rounded-3xl p-8 text-center animate-bounce">
                            <div class="text-6xl mb-4">🎉</div>
                            <div class="text-2xl font-bold text-[var(--labu)] mb-2">恭喜升级！</div>
                            <div class="text-lg">您现在是 Lv.${userData.level} 了！</div>
                            <div class="text-sm text-slate-500 mt-2">获得升级奖励：20 积分</div>
                        </div>
                    `;
                    document.body.appendChild(levelUp);

                    // 升级奖励积分
                    userData.points += 20;
                    localStorage.setItem('labubu_user_points', userData.points.toString());

                    setTimeout(() => {
                        if (document.body.contains(levelUp)) {
                            document.body.removeChild(levelUp);
                        }
                    }, 3000);
                }, 1000);
            }

            renderUserData();
            renderCalendar(); // 重新渲染日历以显示今日签到
        }

        // 自定义鼠标效果
        function initCustomCursor() {
            const cursor = $('.custom-cursor');
            let mouseX = 0, mouseY = 0;

            document.addEventListener('mousemove', (e) => {
                mouseX = e.clientX;
                mouseY = e.clientY;
                cursor.style.left = mouseX + 'px';
                cursor.style.top = mouseY + 'px';

                createCursorTrail(mouseX, mouseY);
            });

            document.addEventListener('mousedown', () => {
                cursor.classList.add('clicking');
            });

            document.addEventListener('mouseup', () => {
                cursor.classList.remove('clicking');
            });
        }

        function createCursorTrail(x, y) {
            const trail = document.createElement('div');
            trail.className = 'cursor-trail';
            trail.style.left = (x - 4) + 'px';
            trail.style.top = (y - 4) + 'px';
            document.body.appendChild(trail);

            setTimeout(() => {
                if (document.body.contains(trail)) {
                    document.body.removeChild(trail);
                }
            }, 500);
        }

        function createMagicParticles(x, y) {
            for (let i = 0; i < 6; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'magic-particle';
                    particle.style.left = (x + Math.random() * 40 - 20) + 'px';
                    particle.style.top = (y + Math.random() * 40 - 20) + 'px';
                    document.body.appendChild(particle);

                    setTimeout(() => {
                        if (document.body.contains(particle)) {
                            document.body.removeChild(particle);
                        }
                    }, 2000);
                }, i * 50);
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>

    <!-- 页面过渡动画 -->
    <script src="page-transition-fix.js"></script>
</body>

</html>