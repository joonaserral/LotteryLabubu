# 🏗️ 系统架构与技术说明

## 📋 技术栈概览

### 前端技术
- **HTML5**：语义化标记，提供良好的页面结构
- **CSS3**：现代CSS特性，包括Grid、Flexbox、动画等
- **JavaScript ES6+**：现代JavaScript特性，模块化开发
- **Tailwind CSS**：实用优先的CSS框架
- **Web APIs**：LocalStorage、BroadcastChannel、Audio API等

### 设计模式
- **模块化设计**：功能按模块组织，便于维护
- **事件驱动**：基于事件的交互模式
- **响应式设计**：适配各种设备尺寸
- **渐进增强**：基础功能优先，增强功能可选

## 🏛️ 系统架构

### 1. 整体架构

```
┌─────────────────────────────────────────┐
│              前端展示层                    │
├─────────────────────────────────────────┤
│ index.html    │ user-center.html │ ...   │
│ (主抽奖系统)   │ (用户中心)        │       │
├─────────────────────────────────────────┤
│              业务逻辑层                    │
├─────────────────────────────────────────┤
│ 抽奖算法 │ 用户管理 │ 音乐播放 │ 权限控制 │
├─────────────────────────────────────────┤
│              数据存储层                    │
├─────────────────────────────────────────┤
│ LocalStorage │ SessionStorage │ 内存缓存 │
├─────────────────────────────────────────┤
│              基础设施层                    │
├─────────────────────────────────────────┤
│ 浏览器API │ 网络请求 │ 文件系统 │ 安全机制 │
└─────────────────────────────────────────┘
```

### 2. 模块结构

#### 核心模块
- **抽奖引擎** (`LotteryEngine`)
- **用户管理** (`UserManager`)
- **音乐播放** (`MusicPlayer`)
- **数据同步** (`DataSync`)
- **权限验证** (`AuthValidator`)

#### 工具模块
- **工具函数** (`Utils`)
- **动画系统** (`AnimationSystem`)
- **通知系统** (`NotificationSystem`)
- **存储管理** (`StorageManager`)

## 🔧 核心技术实现

### 1. 抽奖算法

#### 权重随机算法
```javascript
class LotteryEngine {
    constructor(prizePool) {
        this.prizePool = prizePool;
        this.totalWeight = this.calculateTotalWeight();
    }
    
    calculateTotalWeight() {
        return this.prizePool.reduce((sum, prize) => {
            return sum + (prize.quantity > 0 ? prize.weight : 0);
        }, 0);
    }
    
    drawPrize() {
        const random = Math.random() * this.totalWeight;
        let currentWeight = 0;
        
        for (const prize of this.prizePool) {
            if (prize.quantity <= 0) continue;
            
            currentWeight += prize.weight;
            if (random <= currentWeight) {
                return this.processPrizeWin(prize);
            }
        }
        
        return null; // 理论上不会到达这里
    }
    
    processPrizeWin(prize) {
        // 减少库存
        prize.quantity--;
        
        // 记录历史
        this.recordHistory(prize);
        
        // 更新统计
        this.updateStatistics(prize);
        
        return prize;
    }
}
```

### 2. 数据管理

#### 本地存储封装
```javascript
class StorageManager {
    static set(key, value) {
        try {
            localStorage.setItem(key, JSON.stringify(value));
            this.notifyChange(key, value);
        } catch (error) {
            console.error('存储失败:', error);
        }
    }
    
    static get(key, defaultValue = null) {
        try {
            const value = localStorage.getItem(key);
            return value ? JSON.parse(value) : defaultValue;
        } catch (error) {
            console.error('读取失败:', error);
            return defaultValue;
        }
    }
    
    static notifyChange(key, value) {
        // 通知其他页面数据变化
        if (window.dataChannel) {
            window.dataChannel.postMessage({
                type: 'storage_change',
                key,
                value,
                timestamp: Date.now()
            });
        }
    }
}
```

#### 跨页面数据同步
```javascript
class DataSyncManager {
    constructor() {
        this.channel = null;
        this.lastUpdateTime = {};
        this.initChannel();
    }
    
    initChannel() {
        if ('BroadcastChannel' in window) {
            this.channel = new BroadcastChannel('labubu_data_sync');
            this.channel.addEventListener('message', this.handleMessage.bind(this));
        }
    }
    
    handleMessage(event) {
        const { type, key, value, timestamp } = event.data;
        
        // 防止重复更新
        if (this.lastUpdateTime[key] >= timestamp) return;
        
        this.lastUpdateTime[key] = timestamp;
        
        switch (type) {
            case 'storage_change':
                this.updateLocalData(key, value);
                break;
            case 'lottery_result':
                this.handleLotteryUpdate(value);
                break;
        }
    }
}
```

### 3. 音乐播放系统

#### 音频管理器
```javascript
class MusicManager {
    constructor() {
        this.currentAudio = null;
        this.playlist = [];
        this.currentIndex = 0;
        this.isPlaying = false;
        this.volume = 0.5;
    }
    
    async loadPlaylist(musicLibrary) {
        this.playlist = musicLibrary;
        if (this.playlist.length > 0) {
            await this.loadTrack(0);
        }
    }
    
    async loadTrack(index) {
        if (this.currentAudio) {
            this.currentAudio.pause();
            this.currentAudio = null;
        }
        
        const track = this.playlist[index];
        if (!track || !track.url) return;
        
        this.currentAudio = new Audio(track.url);
        this.currentAudio.volume = this.volume;
        this.currentIndex = index;
        
        // 绑定事件
        this.bindAudioEvents();
        
        return new Promise((resolve, reject) => {
            this.currentAudio.addEventListener('loadeddata', resolve);
            this.currentAudio.addEventListener('error', reject);
        });
    }
    
    bindAudioEvents() {
        this.currentAudio.addEventListener('ended', () => {
            this.next();
        });
        
        this.currentAudio.addEventListener('timeupdate', () => {
            this.updateProgress();
        });
        
        this.currentAudio.addEventListener('error', (error) => {
            console.error('音频播放错误:', error);
            this.next(); // 自动跳到下一首
        });
    }
}
```

### 4. 用户界面系统

#### 动画系统
```javascript
class AnimationSystem {
    static createParticleEffect(x, y, type = 'normal') {
        const particle = document.createElement('div');
        particle.className = `particle particle-${type}`;
        
        // 设置初始位置
        particle.style.left = x + 'px';
        particle.style.top = y + 'px';
        
        // 添加到DOM
        document.body.appendChild(particle);
        
        // 动画结束后清理
        particle.addEventListener('animationend', () => {
            if (document.body.contains(particle)) {
                document.body.removeChild(particle);
            }
        });
        
        return particle;
    }
    
    static createLotteryAnimation(prize) {
        const rarity = prize.rarity;
        const animations = {
            common: () => this.commonAnimation(prize),
            rare: () => this.rareAnimation(prize),
            epic: () => this.epicAnimation(prize),
            legendary: () => this.legendaryAnimation(prize),
            mythic: () => this.mythicAnimation(prize)
        };
        
        return animations[rarity] || animations.common;
    }
}
```

#### 响应式设计
```css
/* 移动端适配 */
@media (max-width: 768px) {
    .lottery-container {
        padding: 1rem;
        margin: 0.5rem;
    }
    
    .prize-card {
        width: 100%;
        max-width: 300px;
    }
    
    #musicPlayer {
        width: 280px;
        bottom: 20px;
        right: 20px;
    }
}

/* 平板适配 */
@media (min-width: 769px) and (max-width: 1024px) {
    .lottery-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

/* 桌面端适配 */
@media (min-width: 1025px) {
    .lottery-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}
```

## 🔐 安全机制

### 1. 权限验证

#### VIP权限检查
```javascript
class AuthValidator {
    static checkVIPAccess() {
        try {
            // 检查配置对象
            if (!window._secureConfig) return false;
            
            // 域名验证
            if (!this.validateDomain()) return false;
            
            // 时间戳验证
            if (!this.validateTimestamp()) return false;
            
            return true;
        } catch (error) {
            console.error('权限验证失败:', error);
            return false;
        }
    }
    
    static validateDomain() {
        const allowedDomains = [
            'localhost',
            '127.0.0.1',
            'labubu-lottery.com'
        ];
        
        return allowedDomains.some(domain => 
            window.location.hostname.includes(domain)
        );
    }
}
```

### 2. 数据保护

#### 配置加密
```javascript
// config.enc.js - 加密配置文件
(function() {
    const encryptedConfig = "加密后的配置数据";
    
    window._secureConfig = {
        validate() {
            return this.decrypt(encryptedConfig);
        },
        
        decrypt(data) {
            // 简单的解密逻辑
            try {
                const decoded = atob(data);
                const config = JSON.parse(decoded);
                return this.validateConfig(config);
            } catch {
                return false;
            }
        }
    };
})();
```

### 3. 防作弊措施

#### 操作限制
```javascript
class AntiCheatSystem {
    constructor() {
        this.operationHistory = [];
        this.lastOperationTime = 0;
        this.suspiciousCount = 0;
    }
    
    validateOperation(operation) {
        const now = Date.now();
        const timeDiff = now - this.lastOperationTime;
        
        // 检查操作频率
        if (timeDiff < 1000) { // 1秒内不能重复操作
            this.suspiciousCount++;
            if (this.suspiciousCount > 5) {
                this.blockUser();
                return false;
            }
        }
        
        // 记录操作
        this.recordOperation(operation, now);
        this.lastOperationTime = now;
        
        return true;
    }
    
    blockUser() {
        alert('检测到异常操作，请稍后再试');
        // 临时阻止操作
        setTimeout(() => {
            this.suspiciousCount = 0;
        }, 60000); // 1分钟后解除
    }
}
```

## 📊 性能优化

### 1. 资源优化

#### 图片懒加载
```javascript
class ImageLazyLoader {
    static init() {
        const images = document.querySelectorAll('img[data-src]');
        const imageObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.dataset.src;
                    img.removeAttribute('data-src');
                    imageObserver.unobserve(img);
                }
            });
        });
        
        images.forEach(img => imageObserver.observe(img));
    }
}
```

#### 代码分割
```javascript
// 按需加载功能模块
async function loadModule(moduleName) {
    const modules = {
        achievements: () => import('./modules/achievements.js'),
        games: () => import('./modules/games.js'),
        shop: () => import('./modules/shop.js')
    };
    
    if (modules[moduleName]) {
        const module = await modules[moduleName]();
        return module.default;
    }
    
    throw new Error(`Module ${moduleName} not found`);
}
```

### 2. 内存管理

#### 事件监听器清理
```javascript
class EventManager {
    constructor() {
        this.listeners = new Map();
    }
    
    addEventListener(element, event, handler) {
        const key = `${element}_${event}`;
        
        // 清理之前的监听器
        if (this.listeners.has(key)) {
            const oldHandler = this.listeners.get(key);
            element.removeEventListener(event, oldHandler);
        }
        
        // 添加新监听器
        element.addEventListener(event, handler);
        this.listeners.set(key, handler);
    }
    
    cleanup() {
        this.listeners.forEach((handler, key) => {
            const [element, event] = key.split('_');
            element.removeEventListener(event, handler);
        });
        this.listeners.clear();
    }
}
```

## 🔍 调试与监控

### 1. 日志系统

#### 统一日志管理
```javascript
class Logger {
    static levels = {
        DEBUG: 0,
        INFO: 1,
        WARN: 2,
        ERROR: 3
    };
    
    static currentLevel = this.levels.INFO;
    
    static log(level, message, data = null) {
        if (level < this.currentLevel) return;
        
        const timestamp = new Date().toISOString();
        const levelName = Object.keys(this.levels)[level];
        
        console.log(`[${timestamp}] ${levelName}: ${message}`, data);
        
        // 记录到本地存储（用于调试）
        this.saveToStorage(level, message, data);
    }
    
    static debug(message, data) {
        this.log(this.levels.DEBUG, message, data);
    }
    
    static info(message, data) {
        this.log(this.levels.INFO, message, data);
    }
    
    static warn(message, data) {
        this.log(this.levels.WARN, message, data);
    }
    
    static error(message, data) {
        this.log(this.levels.ERROR, message, data);
    }
}
```

### 2. 错误处理

#### 全局错误捕获
```javascript
// 全局错误处理
window.addEventListener('error', (event) => {
    Logger.error('全局错误', {
        message: event.message,
        filename: event.filename,
        lineno: event.lineno,
        colno: event.colno,
        error: event.error
    });
});

// Promise错误处理
window.addEventListener('unhandledrejection', (event) => {
    Logger.error('未处理的Promise拒绝', {
        reason: event.reason
    });
});
```

## 🚀 部署架构

### 1. 静态部署

#### 文件结构优化
```
build/
├── assets/
│   ├── css/
│   ├── js/
│   └── images/
├── pages/
│   ├── index.html
│   ├── user-center.html
│   └── ...
└── config/
    ├── app.config.js
    └── auth.config.js
```

#### CDN配置
```javascript
const CDN_CONFIG = {
    images: 'https://cdn.labubu.com/images/',
    audio: 'https://cdn.labubu.com/audio/',
    static: 'https://cdn.labubu.com/static/'
};
```

### 2. 环境配置

#### 多环境支持
```javascript
class EnvironmentConfig {
    static getConfig() {
        const hostname = window.location.hostname;
        
        const configs = {
            'localhost': this.developmentConfig,
            'staging.labubu.com': this.stagingConfig,
            'labubu.com': this.productionConfig
        };
        
        return configs[hostname] || this.developmentConfig;
    }
    
    static developmentConfig = {
        debug: true,
        apiUrl: 'http://localhost:3000',
        logLevel: 'DEBUG'
    };
    
    static productionConfig = {
        debug: false,
        apiUrl: 'https://api.labubu.com',
        logLevel: 'ERROR'
    };
}
```

## 🔮 技术规划

### 短期目标
- [ ] 引入TypeScript增强类型安全
- [ ] 实现PWA离线功能
- [ ] 添加单元测试覆盖
- [ ] 优化首屏加载速度

### 长期目标
- [ ] 迁移到现代框架（Vue/React）
- [ ] 实现服务端渲染（SSR）
- [ ] 添加实时通信功能
- [ ] 引入微前端架构

---

🏗️ 持续改进，追求卓越的技术品质！